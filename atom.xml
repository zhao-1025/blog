<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>一往无前虎山行,拨开云雾见光明</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2024-08-20T01:32:01.631Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>赵东兴</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>容器Docker-单机编排</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92/</id>
    <published>2024-08-20T01:32:01.000Z</published>
    <updated>2024-08-20T01:32:01.631Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-部署应用</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/</id>
    <published>2024-08-20T01:31:48.000Z</published>
    <updated>2024-08-20T01:31:48.673Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-镜像构建</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/</id>
    <published>2024-08-20T01:31:29.000Z</published>
    <updated>2024-08-20T01:31:29.865Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-网络存储</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8/</id>
    <published>2024-08-20T01:31:14.000Z</published>
    <updated>2024-08-20T01:31:14.082Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-安装部署</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</id>
    <published>2024-08-20T01:31:00.000Z</published>
    <updated>2024-08-20T01:31:00.798Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-原理概述</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0/</id>
    <published>2024-08-20T01:30:46.000Z</published>
    <updated>2024-08-20T01:30:46.474Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-授权管理</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86/</id>
    <published>2024-08-20T01:23:55.000Z</published>
    <updated>2024-08-20T01:24:08.995Z</updated>
    
    <content type="html"><![CDATA[<h1 id="systemctl管理数据库"><a href="#systemctl管理数据库" class="headerlink" title="systemctl管理数据库"></a>systemctl管理数据库</h1><blockquote><p>:warning:若有&#x2F;etc&#x2F;init.d&#x2F;中有mysql管理的脚本，再配置systemctl管理，会导致冲突</p></blockquote><h2 id="1-书写管理配置文件"><a href="#1-书写管理配置文件" class="headerlink" title="1.书写管理配置文件"></a>1.书写管理配置文件</h2><blockquote><p>进入&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;下，书写配置文件</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /usr/lib/systemd/system/mysqld</span><br><span class="line"><span class="comment">#服务注释及优先启动应用</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=mysql server by www.yuchaoit.cn</span><br><span class="line">Documentation=man:mysqld(8)</span><br><span class="line">Documentation=https://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">After=network.target</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line"><span class="comment">#linux运行模式，多用户文本模式</span></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务启动配置</span></span><br><span class="line">[Service]</span><br><span class="line"><span class="comment">#启动时进程所属主组</span></span><br><span class="line">User=mysql</span><br><span class="line">Group=mysql</span><br><span class="line"><span class="comment">#启动命令，调用mysqld指定mysql配置进行启动</span></span><br><span class="line">ExecStart=/app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">LimitNOFILE=5000</span><br></pre></td></tr></table></figure><h2 id="2-修改数据库配置文件"><a href="#2-修改数据库配置文件" class="headerlink" title="2.修改数据库配置文件"></a>2.修改数据库配置文件</h2><blockquote><p>mysql程序启动时会根据配置文件中参数信息进行运行</p><p>所有变量名都是mysql内置的，需要遵寻mysql变量名格式，不能自己胡乱定义</p><p>变量定义的文件路径注意是否有权限</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/my.cnf</span><br><span class="line"><span class="comment">#服务端</span></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#运行端口</span></span><br><span class="line">port=3306</span><br><span class="line"><span class="comment">#运行用户</span></span><br><span class="line">user=mysql</span><br><span class="line"><span class="comment">#应用安装目录</span></span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line"><span class="comment">#数据存放目录</span></span><br><span class="line">datadir=/app/data/3306</span><br><span class="line"><span class="comment">#进程套接字输出文件</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"><span class="comment">#错误日志输出文件</span></span><br><span class="line">log-error=/app/tools/mysql/3306_error.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端</span></span><br><span class="line">[mysql]</span><br><span class="line"><span class="comment">#自动调用服务端socket文件连接，无需命令-S指定</span></span><br><span class="line">socket=/tmp/mysql.sock  </span><br></pre></td></tr></table></figure><h2 id="3-systemctl进行管理"><a href="#3-systemctl进行管理" class="headerlink" title="3.systemctl进行管理"></a>3.systemctl进行管理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重新加载systemctl管理的配置文件</span></span><br><span class="line">[root@db-51 ~]#systemctl daemon-reload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#systemctl管理mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl start mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@db-51 ~]#ss -tunlp|grep mysql</span><br><span class="line">tcp    LISTEN     0      80     [::]:3306               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">124952</span>,fd=<span class="number">28</span>))</span><br><span class="line">[root@db-51 ~]#ps -ef|grep mysql</span><br><span class="line">mysql    124952      1  0 16:43 ?        00:00:01 /app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">root     125449 122725  0 16:51 pts/1    00:00:00 grep --color=auto mysql</span><br></pre></td></tr></table></figure><h2 id="4-数据库配置文件详解"><a href="#4-数据库配置文件详解" class="headerlink" title="4.数据库配置文件详解"></a>4.数据库配置文件详解</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]                    <span class="comment"># 服务端标签</span></span><br><span class="line">port=3306                   <span class="comment"># 端口</span></span><br><span class="line">server_id                   <span class="comment"># 主机编号，用于主从复制</span></span><br><span class="line">user=mysql                  <span class="comment"># 内置运行用户</span></span><br><span class="line">basedir=/opt/mysql          <span class="comment"># 软件目录</span></span><br><span class="line">datadir=/www.yuchaoit.cn/mysql_3306    <span class="comment"># 数据目录</span></span><br><span class="line">socket=/tmp/mysql.sock      <span class="comment"># 套接字文件路径</span></span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock      <span class="comment"># mysql客户端连接数据库，默认读取的socket文件路径</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置语法</span></span><br><span class="line">[server]                <span class="comment">#服务端读取的配置</span></span><br><span class="line">[mysqld]                <span class="comment">#mysqld进程读取的配置</span></span><br><span class="line">[mysqld_safe]       <span class="comment"># mysqld_safe脚本会加载的配置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端配置参数</span></span><br><span class="line">[mysql]        <span class="comment">#客户端命令读取的设置</span></span><br><span class="line">[client]    <span class="comment">#所有本地客户端读取的设置</span></span><br><span class="line">[mysqldump]    <span class="comment">#备份命令读取的设置</span></span><br></pre></td></tr></table></figure><h1 id="数据库远程管理"><a href="#数据库远程管理" class="headerlink" title="数据库远程管理"></a>数据库远程管理</h1><blockquote><p>授权登录mysql语法</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grant 授予什么权限 privileges on  授权库.授权表 to 授权用户@&#x27;授权网段限制&#x27; identified by &#x27;用户密码&#x27;;</span><br></pre></td></tr></table></figure><h2 id="1-本地连接"><a href="#1-本地连接" class="headerlink" title="1.本地连接"></a>1.本地连接</h2><h3 id="1-1-创建用户授权本地连接"><a href="#1-1-创建用户授权本地连接" class="headerlink" title="1.1 创建用户授权本地连接"></a>1.1 创建用户授权本地连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#登录root用户进入数据库</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户zhao，授予所有库表所有权限，密码1</span></span><br><span class="line">mysql&gt; grant all privileges on *.* to zhao@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看mysql用户表</span></span><br><span class="line"><span class="comment">#创建的用户都被保存到了，mysql库中的user表中，</span></span><br><span class="line"><span class="comment">#查看mysql库中user表中，user用户与host网段限制，字段信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host mysql.user;</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| zhao          | localhost |</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">+---------------+-----------+</span><br></pre></td></tr></table></figure><h3 id="1-2-查看某库中所有表"><a href="#1-2-查看某库中所有表" class="headerlink" title="1.2 查看某库中所有表"></a>1.2 查看某库中所有表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.直接查看mysql库中所有表</span></span><br><span class="line">mysql&gt; show tables from mysql;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.先进入mysql库，再查看所有表</span></span><br><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.查看当前在哪个库中</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> database();</span><br><span class="line">+------------+</span><br><span class="line">| database() |</span><br><span class="line">+------------+</span><br><span class="line">| mysql      |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure><h3 id="1-3-本地网络套接字登录"><a href="#1-3-本地网络套接字登录" class="headerlink" title="1.3 本地网络套接字登录"></a>1.3 本地网络套接字登录</h3><blockquote><p>使用创建的zhao用户基于网络套接字ip:port登录</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#密码交互式</span></span><br><span class="line">[root@db-51 ~]#mysql -uzhao -p -h127.0.0.1 -P3306 -e <span class="string">&quot;show databases;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#密码不交互</span></span><br><span class="line">[root@db-51 ~]#mysql -uzhao -p1 -h127.0.0.1 -P3306 -e <span class="string">&quot;show databases;&quot;</span></span><br></pre></td></tr></table></figure><h3 id="1-4-本地进程套接字登录"><a href="#1-4-本地进程套接字登录" class="headerlink" title="1.4 本地进程套接字登录"></a>1.4 本地进程套接字登录</h3><blockquote><p>:warning:注意使用本地套接字连接mysql服务端，权限限制的网段必须是localhost</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#mysql -uzhao -p1 -S/tmp/mysql.sock -e <span class="string">&quot;select user,host from mysql.user&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">| zhao          | localhost |</span><br><span class="line">+---------------+-----------+</span><br></pre></td></tr></table></figure><h2 id="2-远程连接"><a href="#2-远程连接" class="headerlink" title="2.远程连接"></a>2.远程连接</h2><h3 id="2-1-创建用户授权远程连接"><a href="#2-1-创建用户授权远程连接" class="headerlink" title="2.1 创建用户授权远程连接"></a>2.1 创建用户授权远程连接</h3><blockquote><p>只允许yuchao用户在 10.0.0.x 网段登录，有最大的权限</p><p>:warning:授权语句只能用root去操作</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用root创建zhao用户并授权，%代表0~255整个网段</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -e <span class="string">&quot;grant all privileges on *.* to zhao@&#x27;10.0.0.%&#x27; identified by &#x27;1&#x27;&quot;</span></span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure><h3 id="2-2-远程登录查看登录用户信息"><a href="#2-2-远程登录查看登录用户信息" class="headerlink" title="2.2 远程登录查看登录用户信息"></a>2.2 远程登录查看登录用户信息</h3><blockquote><p>使用10.0.0.1~10.0.0.254网段内机器进行远程连接db-51服务端</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用web-7机器</span></span><br><span class="line">[root@web-7 ~]#hostname -I</span><br><span class="line">10.0.0.7 172.16.1.7 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#远程登录，查看当前登录用户信息</span></span><br><span class="line">[root@web-7 ~]#mysql -uzhao -p1 -h10.0.0.51 -P3306 -e <span class="string">&quot;select user();&quot;</span></span><br><span class="line">+---------------+</span><br><span class="line">| user()        |</span><br><span class="line">+---------------+</span><br><span class="line">| zhao@10.0.0.7 |</span><br><span class="line">+---------------+</span><br></pre></td></tr></table></figure><h3 id="2-3-远程工具图形化连接"><a href="#2-3-远程工具图形化连接" class="headerlink" title="2.3 远程工具图形化连接"></a>2.3 远程工具图形化连接</h3><blockquote><p>可以图形化连接服务端数据库，鼠标点点点进行数据库表管理</p><p>sqlyog，navicat，收费</p><p>workbench（官方出品），dbeaver，免费</p></blockquote><p>workench</p><p>下载：<a href="https://dev.mysql.com/downloads/file/?id=525959">https://dev.mysql.com/downloads/file/?id=525959</a></p><p><img src="/image-20240529185845776.png" alt="image-20240529185845776"></p><h3 id="2-4-服务端查看tcp连接"><a href="#2-4-服务端查看tcp连接" class="headerlink" title="2.4 服务端查看tcp连接"></a>2.4 服务端查看tcp连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#web-7远程连接mysql服务端后，在服务端db-51查看tcp连接进程</span></span><br><span class="line"><span class="comment">#可以看到web-7与db-51建立了tcp连接，因为web-7基于ip:prot远程进行连接</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db-51 ~]#netstat -an|grep 10.0.0.7</span><br><span class="line">tcp6       0      0 10.0.0.51:3306          10.0.0.7:41058          ESTABLISHED</span><br></pre></td></tr></table></figure><h1 id="数据库用户管理"><a href="#数据库用户管理" class="headerlink" title="数据库用户管理"></a>数据库用户管理</h1><blockquote><p>mysql用户</p><ul><li>登录mysql服务端</li><li>基于用户权限管理mysql中库表数据</li></ul></blockquote><h2 id="1-用户白名单语法"><a href="#1-用户白名单语法" class="headerlink" title="1.用户白名单语法"></a>1.用户白名单语法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法</span></span><br><span class="line">grant all privileges on *.* to 用户@<span class="string">&#x27;白名单限制&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@&#x27;localhost&#x27;  可以在本地登录，并且可以通过socket登录</span></span><br><span class="line"><span class="string">@&#x27;10.0.0.10&#x27;  只能在10.0.0.10这个客户端登录</span></span><br><span class="line"><span class="string">@&#x27;10.0.0.%&#x27;   只能在10.0.0.xx/24网段登录</span></span><br><span class="line"><span class="string">@&#x27;10.0.0.5%&#x27;  只能在10.0.0.50~59 登录</span></span><br><span class="line"><span class="string">@&#x27;%&#x27;          可以在任意地址登录该mysql服务端（常用）</span></span><br><span class="line"><span class="string">@&#x27;db-51&#x27;      基于主机名的登录限制（了解）</span></span><br></pre></td></tr></table></figure><h2 id="2-查看数据库用户表数据"><a href="#2-查看数据库用户表数据" class="headerlink" title="2.查看数据库用户表数据"></a>2.查看数据库用户表数据</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select 查看表</span></span><br><span class="line"><span class="comment">#user,host,authentication_string 用户名,白名单,密码加密后密文</span></span><br><span class="line"><span class="comment">#from mysql.user 查看mysql库的user表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost |                                           |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| zhao          | 127.0.0.1 | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| zhao          | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| zhao          | 10.0.0.%  | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-创建用户密码"><a href="#3-创建用户密码" class="headerlink" title="3.创建用户密码"></a>3.创建用户密码</h2><blockquote><p>只创建用户不设置密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户，不创建密码</span></span><br><span class="line">mysql&gt; create user chaoge@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看user表字段信息，无密码加密后的密文</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| chaoge        | localhost |                                           |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br></pre></td></tr></table></figure><blockquote><p>创建用户并设置密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户设置密码</span></span><br><span class="line">mysql&gt; create user chaoge01@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看用户表中用户、白名单、密码加密字段信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span>  user,host,authentication_string  from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| chaoge        | localhost |                                           |</span><br><span class="line">| chaoge01      | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="4-root修改其他用户密码"><a href="#4-root修改其他用户密码" class="headerlink" title="4.root修改其他用户密码"></a>4.root修改其他用户密码</h2><blockquote><p>修改密码语法：</p><p>alter      user      用户@’白名单’     identified        by       ‘密码’；</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#字符串2加密后密文</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> password(<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;2&#x27;</span>)                             |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#给chaoge用户修改密码</span></span><br><span class="line">mysql&gt; alter user chaoge@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看用户修改后信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| chaoge        | localhost | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">| chaoge01      | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#set语句修改</span></span><br><span class="line"><span class="built_in">set</span> password <span class="keyword">for</span> chaoge@<span class="string">&#x27;localhost&#x27;</span>=password(<span class="string">&#x27;2&#x27;</span>);</span><br></pre></td></tr></table></figure><h2 id="5-普通用户修改自己密码"><a href="#5-普通用户修改自己密码" class="headerlink" title="5.普通用户修改自己密码"></a>5.普通用户修改自己密码</h2><blockquote><p>用户给自己修改密码，使用chaoge01用户登录密码修改为 2</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看字符串加密后密文</span></span><br><span class="line">[root@db-51 ~]#mysql -uchaoge01  -p2 -S /tmp/mysql.sock  -e <span class="string">&quot;select password(&#x27;2&#x27;)&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;2&#x27;</span>)                             |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改密码</span></span><br><span class="line">[root@db-51 ~]#mysql -uchaoge01  -p1 -S /tmp/mysql.sock  </span><br><span class="line">mysql&gt; <span class="built_in">set</span> password=password(<span class="string">&#x27;2&#x27;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>普通用户授予最大权限也无法查看用户表信息，只有root用户可以</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#root用户查看用户表信息</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;select user,host,authentication_string from mysql.user;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| chaoge        | localhost | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">| chaoge01      | localhost | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="6-查看密码加密对应的密文"><a href="#6-查看密码加密对应的密文" class="headerlink" title="6.查看密码加密对应的密文"></a>6.查看密码加密对应的密文</h2><blockquote><p>可以基于如下sql语句，查看某个字符串通过加密后，会生成什么密文</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#字符串1加密</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> password(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;1&#x27;</span>)                             |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#字符串123加密</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> password(<span class="string">&#x27;123&#x27;</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;123&#x27;</span>)                           |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *23AE809DDACAF96AF0FD78ED04B6A265E05AA257 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="7-root删除普通用户"><a href="#7-root删除普通用户" class="headerlink" title="7.root删除普通用户"></a>7.root删除普通用户</h2><blockquote><p>语法：</p><p>drop   user    用户名@’白名单’；</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前用户信息</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;select user,host from mysql.user;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| zhao          | 10.0.0.%  |</span><br><span class="line">| zhao          | 127.0.0.1 |</span><br><span class="line">| chaoge        | localhost |</span><br><span class="line">| chaoge01      | localhost |</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">| zhao          | localhost |</span><br><span class="line">+---------------+-----------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;dorp user zhao@&#x27;10.0.0.%&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;drop user zhao@&#x27;10.0.0.%&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;drop user zhao@&#x27;127.0.0.1&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;drop user chaoge@&#x27;localhost&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;drop user zhao@&#x27;localhost&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot  -p -S /tmp/mysql.sock  -e <span class="string">&quot;select user,host from mysql.user;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">+---------------+-----------+</span><br></pre></td></tr></table></figure><h2 id="8-root用户修改密码"><a href="#8-root用户修改密码" class="headerlink" title="8.root用户修改密码"></a>8.root用户修改密码</h2><ul><li>mysqladmin改密码</li></ul><blockquote><p>mysqladmin：主要用于修改root用户密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#交互</span></span><br><span class="line">[root@db-51 ~]#mysqladmin -uroot -p password </span><br><span class="line">password：旧密码</span><br><span class="line">newpassword：新密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#无交互</span></span><br><span class="line">[root@db-51 ~]#mysqladmin -uroot -p旧密码  password 新密码</span><br></pre></td></tr></table></figure><ul><li>set语句修改</li></ul><blockquote><p>root给其他人修改密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> password <span class="keyword">for</span> chaoge@localhost=password(<span class="string">&#x27;chaoge666&#x27;</span>);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure><ul><li>update语句修改</li></ul><blockquote><p>update：指定表中某个字段某行修改数据</p><p>:warning:注意使用update修改时，加上<strong>where</strong>匹配某行进行修改，若不加直接修改字段下所有信息了</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法： update  库.表（修改哪张表） set   字段（修改哪个字段下的数据）=修改后的数据  where  通过关键信息匹配某行</span></span><br><span class="line"></span><br><span class="line">mysql&gt; update mysql.user <span class="built_in">set</span> authentication_string=password(<span class="string">&quot;www.yuchaoit.cn&quot;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span> and host=<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">刷新后，权限表会更新</span><br></pre></td></tr></table></figure><ul><li>用户修改自己密码</li></ul><blockquote><p>不指定用户与白名单，set语句默认修改当前登录用户的密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> password=password(<span class="string">&#x27;yuchao666&#x27;</span>);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><h1 id="数据库授权管理"><a href="#数据库授权管理" class="headerlink" title="数据库授权管理"></a>数据库授权管理</h1><blockquote><p>授权，可限制mysql的用户，可以执行哪些SQL语句，可以在mysql中做哪些事</p></blockquote><h2 id="1-mysql支持的授权sql"><a href="#1-mysql支持的授权sql" class="headerlink" title="1.mysql支持的授权sql"></a>1.mysql支持的授权sql</h2><blockquote><p>查看权限表支持的授权规则sql语句</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;show privileges;&quot;</span></span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure><p><img src="/image-20240521201930666.png" alt="image-20240521201930666"></p><h2 id="2-权限表规则sql语句详解"><a href="#2-权限表规则sql语句详解" class="headerlink" title="2.权限表规则sql语句详解"></a>2.权限表规则sql语句详解</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">privileges权限表</span><br><span class="line"></span><br><span class="line">All/All Privileges权限代表全局或者全数据库对象级别的所有权限</span><br><span class="line"></span><br><span class="line">Alter权限代表允许修改表结构的权限，但必须要求有create和insert权限配合。如果是rename表名，则要求有alter和drop原表， create和insert新表的权限</span><br><span class="line"></span><br><span class="line">Alter routine权限代表允许修改或者删除存储过程、函数的权限</span><br><span class="line"></span><br><span class="line">Create权限代表允许创建新的数据库和表的权限</span><br><span class="line"></span><br><span class="line">Create routine权限代表允许创建存储过程、函数的权限</span><br><span class="line"></span><br><span class="line">Create tablespace权限代表允许创建、修改、删除表空间和日志组的权限</span><br><span class="line"></span><br><span class="line">Create temporary tables权限代表允许创建临时表的权限</span><br><span class="line"></span><br><span class="line">Create user权限代表允许创建、修改、删除、重命名user的权限</span><br><span class="line"></span><br><span class="line">Create view权限代表允许创建视图的权限</span><br><span class="line"></span><br><span class="line">Delete权限代表允许删除行数据的权限</span><br><span class="line"></span><br><span class="line">Drop权限代表允许删除数据库、表、视图的权限，包括<span class="built_in">truncate</span> table命令</span><br><span class="line"></span><br><span class="line">Event权限代表允许查询，创建，修改，删除MySQL事件</span><br><span class="line"></span><br><span class="line">Execute权限代表允许执行存储过程和函数的权限</span><br><span class="line"></span><br><span class="line">File权限代表允许在MySQL可以访问的目录进行读写磁盘文件操作，可使用的命令包括load data infile,<span class="keyword">select</span> … into outfile,load file()函数</span><br><span class="line"></span><br><span class="line">Grant option权限代表是否允许此用户授权或者收回给其他用户你给予的权限,重新付给管理员的时候需要加上这个权限</span><br><span class="line"></span><br><span class="line">Index权限代表是否允许创建和删除索引</span><br><span class="line"></span><br><span class="line">Insert权限代表是否允许在表里插入数据，同时在执行analyze table,optimize table,repair table语句的时候也需要insert权限</span><br><span class="line"></span><br><span class="line">Lock权限代表允许对拥有<span class="keyword">select</span>权限的表进行锁定，以防止其他链接对此表的读或写</span><br><span class="line"></span><br><span class="line">Process权限代表允许查看MySQL中的进程信息，比如执行show processlist, mysqladmin processlist, show engine等命令</span><br><span class="line"></span><br><span class="line">Reference权限是在5.7.6版本之后引入，代表是否允许创建外键</span><br><span class="line"></span><br><span class="line">Reload权限代表允许执行flush命令，指明重新加载权限表到系统内存中，refresh命令代表关闭和重新开启日志文件并刷新所有的表</span><br><span class="line"></span><br><span class="line">Replication client权限代表允许执行show master status,show slave status,show binary logs命令</span><br><span class="line"></span><br><span class="line">Replication slave权限代表允许slave主机通过此用户连接master以便建立主从复制关系</span><br><span class="line"></span><br><span class="line">Select权限代表允许从表中查看数据，某些不查询表数据的<span class="keyword">select</span>执行则不需要此权限，如Select 1+1， Select PI()+2；而且<span class="keyword">select</span>权限在执行update/delete语句中含有<span class="built_in">where</span>条件的情况下也是需要的</span><br><span class="line"></span><br><span class="line">Show databases权限代表通过执行show databases命令查看所有的数据库名</span><br><span class="line"></span><br><span class="line">Show view权限代表通过执行show create view命令查看视图创建的语句</span><br><span class="line"></span><br><span class="line">Shutdown权限代表允许关闭数据库实例，执行语句包括mysqladmin shutdown</span><br><span class="line"></span><br><span class="line">Super权限代表允许执行一系列数据库管理命令，包括<span class="built_in">kill</span>强制关闭某个连接命令， change master to创建复制关系命令，以及create/alter/drop server等命令</span><br><span class="line"></span><br><span class="line">Trigger权限代表允许创建，删除，执行，显示触发器的权限</span><br><span class="line"></span><br><span class="line">Update权限代表允许修改表中的数据的权限</span><br><span class="line"></span><br><span class="line">Usage权限是创建一个用户之后的默认权限，其本身代表连接登录权限</span><br></pre></td></tr></table></figure><h2 id="3-grant授权命令语法"><a href="#3-grant授权命令语法" class="headerlink" title="3.grant授权命令语法"></a>3.grant授权命令语法</h2><blockquote><p>grant语句对于未创建的用户，授权的同时可以直接创建用户设置密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助文档</span></span><br><span class="line">mysql&gt; <span class="built_in">help</span> grant;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#语法</span></span><br><span class="line">grant all privileges on *.* to <span class="string">&#x27;yuchaoit&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span> identified by <span class="string">&#x27;chaoge666&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="4-grant语句实践"><a href="#4-grant语句实践" class="headerlink" title="4.grant语句实践"></a>4.grant语句实践</h2><blockquote><p>创建chaoge用户，授予只对 linux库 增删改查权限，允许远程连接登录、</p></blockquote><ul><li><strong>root创建授权</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#root用户创建linux库</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock -e <span class="string">&quot;create database linux;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock -e <span class="string">&quot;show databases;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| linux              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#root用户创建并授权chaoge用户，对于linux库可以增删改查，并且可以远程连接</span></span><br><span class="line">grant <span class="keyword">select</span>,update,delete,insert on linux.* to chaoge@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#查看创建的chaoge用户权限</span></span><br><span class="line"><span class="string">mysql&gt; show grants for chaoge@&#x27;%&#x27;;</span></span><br><span class="line"><span class="string">+-------------------------------------------------------------------+</span></span><br><span class="line"><span class="string">| Grants for chaoge@%                                               |</span></span><br><span class="line"><span class="string">+-------------------------------------------------------------------+</span></span><br><span class="line"><span class="string">| GRANT USAGE ON *.* TO &#x27;chaoge&#x27;@&#x27;%&#x27;                                |</span></span><br><span class="line"><span class="string">| GRANT SELECT, INSERT, UPDATE, DELETE ON `linux`.* TO &#x27;chaoge&#x27;@&#x27;%&#x27; |</span></span><br><span class="line"><span class="string">+-------------------------------------------------------------------+</span></span><br><span class="line"><span class="string">2 rows in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><ul><li><strong>chaoge登录测试</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#只能查看到linux库和一个默认库，其他库并无显示</span></span><br><span class="line">[root@web-7 ~]#mysql -uchaoge -p1 -h10.0.0.51 -P3306</span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| linux              |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5-查看用户权限"><a href="#5-查看用户权限" class="headerlink" title="5.查看用户权限"></a>5.查看用户权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#远程连接，查看当前登录用户权限</span></span><br><span class="line">[root@web-7 ~]#mysql -uchaoge -p1 -h10.0.0.51 -P3306</span><br><span class="line">MySQL [(none)]&gt; show grants <span class="keyword">for</span> chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> chaoge@%                                               |</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                                |</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE, DELETE ON `linux`.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前登录的用户信息</span></span><br><span class="line">MySQL [(none)]&gt; <span class="keyword">select</span> user();</span><br><span class="line">+-----------------+</span><br><span class="line">| user()          |</span><br><span class="line">+-----------------+</span><br><span class="line">| chaoge@10.0.0.7 |</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure><h2 id="6-移除用户权限"><a href="#6-移除用户权限" class="headerlink" title="6.移除用户权限"></a>6.移除用户权限</h2><blockquote><p>使用root用户移除刚才创建的chaoge用户权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前用户权限</span></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> chaoge@%                                               |</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                                |</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE, DELETE ON `linux`.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></blockquote><ul><li>移除chaoge对linux库的删除权限</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#移除</span></span><br><span class="line">mysql&gt; revoke delete on linux.* from chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+-----------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> chaoge@%                                       |</span><br><span class="line">+-----------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                        |</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE ON `linux`.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+-----------------------------------------------------------+</span><br></pre></td></tr></table></figure><ul><li>移除chaoge用户对linux库所有权限</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#移除</span></span><br><span class="line">mysql&gt; revoke all on linux.* from chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> chaoge@%                |</span><br><span class="line">+------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#chaoge用户登录检查，看不到任何库</span></span><br><span class="line">[root@web-7 ~]#mysql -uchaoge -p1 -h10.0.0.51 -P3306 -e <span class="string">&quot;show databases;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure><h2 id="7-忘记root密码重置方法"><a href="#7-忘记root密码重置方法" class="headerlink" title="7.忘记root密码重置方法"></a>7.忘记root密码重置方法</h2><blockquote><p>:warning:注意该参数很危险，使用后需要立即关闭，开启后，任何人都可以免密登录到数据库</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">通过skip-grant-tables参数添加，运行mysql，即可跳过权限限制，免密登录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">两种方法：</span><br><span class="line">1.配置文件加入skip-grant-table参数，重启后免密登录进入数据库修改root密码。</span><br><span class="line">2.直接mysqld命令启动mysql，skip-grant-table参数加入到最后，免密登录进入数据库修改root密码。</span><br></pre></td></tr></table></figure><h3 id="1）配置文件添加参数"><a href="#1）配置文件添加参数" class="headerlink" title="1）配置文件添加参数"></a>1）配置文件添加参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#模拟root密码忘记</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p1</span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">ERROR 1045 (28000): Access denied <span class="keyword">for</span> user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (using password: YES)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件添加skip-grant-tables参数</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">######添加到mysqld标签下方</span></span><br><span class="line">skip-grant-tables</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log-error=/app/tools/mysql/3306_error.<span class="built_in">log</span></span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl restart mysqld</span><br><span class="line">[root@db-51 ~]#ss -tunlp|grep 3306</span><br><span class="line">tcp    LISTEN     0      80     [::]:3306               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">21322</span>,fd=<span class="number">28</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#免密登录mysql</span></span><br><span class="line">[root@db-51 ~]#mysql -S /tmp/mysql.sock </span><br><span class="line">mysql&gt; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改root密码，修改为1</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> password(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;1&#x27;</span>)                             |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#set语句不支持修改</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span> password=password(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">ERROR 1290 (HY000): The MySQL server is running with the --skip-grant-tables option so it cannot execute this statement</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#只能使用update语句修改密码，注意使用where语句定义修改行信息</span></span><br><span class="line">mysql&gt; update mysql.user <span class="built_in">set</span> authentication_string=password(<span class="string">&#x27;1&#x27;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span> and host=<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 1</span><br><span class="line">mysql&gt; mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| chaoge        | %         | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#必须删除配置文件跳过权限限制参数</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log-error=/app/tools/mysql/3306_error.<span class="built_in">log</span></span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line"><span class="comment">#并且必须重启</span></span><br><span class="line">[root@db-51 ~]#systemctl restart mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#新密码1，检查登录</span></span><br><span class="line"><span class="comment">##重置成功</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p1 -e <span class="string">&quot;select user,host,authentication_string from mysql.user;&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| chaoge        | %         | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2）命令启动添加参数"><a href="#2）命令启动添加参数" class="headerlink" title="2）命令启动添加参数"></a>2）命令启动添加参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先关闭当前mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl stop mysqld</span><br><span class="line">[root@db-51 ~]#ss -tunlp|grep mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysqld命令直接启动，最后方加上--skip-grant-tables</span></span><br><span class="line">[root@db-51 ~]#/app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf  --skip-grant-tables &amp;</span><br><span class="line">[1] 22477</span><br><span class="line">[root@db-51 ~]#ps -ef|grep mysql</span><br><span class="line">mysql     22477  16087  3 13:49 pts/0    00:00:00 /app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf --skip-grant-tables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#免密登录mysql，重置root密码为666</span></span><br><span class="line">[root@db-51 ~]#mysql -S /tmp/mysql.sock </span><br><span class="line">mysql&gt; update mysql.user <span class="built_in">set</span> authentication_string=password(<span class="string">&#x27;666&#x27;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span> and host=<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭mysql，重新启动</span></span><br><span class="line">mysql&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">exit</span>;</span><br><span class="line">Bye</span><br><span class="line">[1]+  Done                    /app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf --skip-grant-tables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新启动mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl start mysqld</span><br><span class="line">[root@db-51 ~]#ps -ef|grep mysql</span><br><span class="line">mysql     22845      1  3 13:55 ?        00:00:00 /app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">root      22887  16087  0 13:55 pts/0    00:00:00 grep --color=auto mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查，重置密码666登录</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p666 -e <span class="string">&quot;select password(&#x27;666&#x27;);&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;666&#x27;</span>)                           |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *007D50CA06F69776D307B1BEC71CD73D0EA0999C |</span><br><span class="line">+-------------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="8-授权小结练习"><a href="#8-授权小结练习" class="headerlink" title="8.授权小结练习"></a>8.授权小结练习</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#3306实例创建三个普通账号，授权练习</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. 运维账号给与最大权限，允许远程连接</span><br><span class="line">grant all priveleges on *.*  to zhao@<span class="string">&#x27;%&#x27;</span>  identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">show grants <span class="keyword">for</span> zhao@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.开发账号，只能对开发库有增删改查权限，只允许在10，172两个网段连接</span><br><span class="line">show database dev;</span><br><span class="line">grant  <span class="keyword">select</span>,update,delete,insert  on *dev* to zhao@<span class="string">&#x27;10.0.0.%&#x27;</span> identified  by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">grant  <span class="keyword">select</span>,update,delete,insert  on *dev* to zhao@<span class="string">&#x27;172.1.0.%&#x27;</span> identified  by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">show grants <span class="keyword">for</span> zhao@<span class="string">&#x27;172.1.0.%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.测试账号，只能对测试库增，改，查的权限，且只允许在172内网连接。</span><br><span class="line">grant <span class="keyword">select</span>,update,insert, on <span class="built_in">test</span>.* to zhao@<span class="string">&#x27;172.1.0.%&#x27;</span>  identified by <span class="string">&#x27;1&#x27;</span></span><br><span class="line">show grants <span class="keyword">for</span> zhao@<span class="string">&#x27;172.1.0.%&#x27;</span>;</span><br></pre></td></tr></table></figure><h1 id="阿里云部署数据库授权实战"><a href="#阿里云部署数据库授权实战" class="headerlink" title="阿里云部署数据库授权实战"></a>阿里云部署数据库授权实战</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.阿里云服务器上部署jpreee博客、mysql软件</span><br><span class="line">2.mysql创建jpress使用的库</span><br><span class="line">3.mysql创建授权jpress连接数据库用户密码及对jrepss库的所有权限</span><br><span class="line">4.mysql创建授权navicat工具远程连接用户及密码对jpress库所有权限</span><br><span class="line">5.mysql修改服务端口为23306</span><br><span class="line">5.阿里云防火墙开放jprees应用访问端口8080，开放远程连接端口23306</span><br><span class="line">6.本地windows访问web页面连接数据库初始化安装jpress</span><br><span class="line">7.使用nvicat工具远程连接管理数据库。</span><br></pre></td></tr></table></figure><h2 id="1-部署jpress博客"><a href="#1-部署jpress博客" class="headerlink" title="1. 部署jpress博客"></a>1. 部署jpress博客</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#环境准备</span><br><span class="line">#都选用旧版本，新版本会出现无法编译的bug</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.jpress源码使用5.0</span><br><span class="line">2.jdk环境使用java8版本</span><br><span class="line">3.maven工具使用3.6.x版本</span><br></pre></td></tr></table></figure><h3 id="1-1-云服务器实例准备"><a href="#1-1-云服务器实例准备" class="headerlink" title="1.1 云服务器实例准备"></a>1.1 云服务器实例准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@aliyun ~]# curl ifconfig.me</span><br><span class="line">39.104.200.160</span><br></pre></td></tr></table></figure><h3 id="1-2-jpress源码准备"><a href="#1-2-jpress源码准备" class="headerlink" title="1.2 jpress源码准备"></a>1.2 jpress源码准备</h3><p>官网地址:<a href="https://www.jpress.cn/download">https://www.jpress.cn/download</a></p><p>帮助文档:<a href="http://doc.jpress.cn/manual/linux-tomcat-deploy.html">http://doc.jpress.cn/manual/linux-tomcat-deploy.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装git工具</span></span><br><span class="line">[root@aliyun ~]# yum install git -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#通过gitee代码仓库下载jpress源码</span></span><br><span class="line">[root@aliyun ~]# git <span class="built_in">clone</span> https://gitee.com/JPressProjects/jpress.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#放入源码存放目录</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">mv</span> jpress /app/code</span><br><span class="line">[root@aliyun ~]# <span class="built_in">ls</span> /app/code/jpress/</span><br></pre></td></tr></table></figure><h3 id="1-3-jdk环境准备"><a href="#1-3-jdk环境准备" class="headerlink" title="1.3 jdk环境准备"></a>1.3 jdk环境准备</h3><blockquote><p>开源jdk： yum install java -y 直接安装</p><p>oracle企业jdk： <a href="https://www.oracle.com/cn/java/technologies/downloads/archive/%E5%AE%98%E7%BD%91%E6%89%BE%E5%AF%B9%E5%BA%94%E5%8C%85%E4%B8%8B%E8%BD%BD">https://www.oracle.com/cn/java/technologies/downloads/archive/官网找对应包下载</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这里选用的Java8二进制安装</span></span><br><span class="line"><span class="comment">#下载后，解压放入指定目录，软链接</span></span><br><span class="line">[root@aliyun /app/code/jpress]#ll /app/tools/</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 6 root root 4096 May 23 10:30 apache-maven-3.6.3</span><br><span class="line">drwxr-xr-x 8 root root 4096 May 23 10:13 jdk1.8.0_351</span><br><span class="line">lrwxrwxrwx 1 root root   24 May 23 10:14 jdk8 -&gt; /app/tools/jdk1.8.0_351/</span><br><span class="line">lrwxrwxrwx 1 root root   30 May 23 10:31 maven -&gt; /app/tools/apache-maven-3.6.3/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#加入path环境变量</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/app/tools/jdk8 </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/jre/bin:/app/tools/maven/bin/:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.<span class="variable">$CLASSPATH</span>:<span class="variable">$JAVA_HOME</span>/lib:<span class="variable">$JAVA_HOME</span>/jre/lib:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@aliyun /app/code/jpress]#java -version</span><br><span class="line">java version <span class="string">&quot;1.8.0_351&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_351-b10)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.351-b10, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="1-4-maven工具准备"><a href="#1-4-maven工具准备" class="headerlink" title="1.4 maven工具准备"></a>1.4 maven工具准备</h3><blockquote><p>maven官网下载：</p><p><a href="https://archive.apache.org/dist/maven/maven-3/">https://archive.apache.org/dist/maven/maven-3/</a> </p><p><a href="https://archive.apache.org/dist/maven/maven-4/">https://archive.apache.org/dist/maven/maven-4/</a></p><p>maven清华源下载:</p><p><a href="https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.8.8/binaries/">https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.8.8/binaries/</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这里选用的maven旧版本3.6.3</span></span><br><span class="line"><span class="comment">#下载解压软链接</span></span><br><span class="line">[root@aliyun /app/code/jpress]#ll /app/tools/</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 6 root root 4096 May 23 10:30 apache-maven-3.6.3</span><br><span class="line">drwxr-xr-x 8 root root 4096 May 23 10:13 jdk1.8.0_351</span><br><span class="line">lrwxrwxrwx 1 root root   24 May 23 10:14 jdk8 -&gt; /app/tools/jdk1.8.0_351/</span><br><span class="line">lrwxrwxrwx 1 root root   30 May 23 10:31 maven -&gt; /app/tools/apache-maven-3.6.3/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#maven二进制命令添加到PATH环境变量</span></span><br><span class="line">[root@aliyun /app/code/jpress]#<span class="built_in">tail</span> /etc/profile</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/jre/bin:/app/tools/maven/bin/:<span class="variable">$PATH</span></span><br><span class="line"><span class="comment">##刷新加载</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改maven下载源，默认国外下载，改为阿里云下载源</span></span><br><span class="line">[root@aliyun ~]# vim /app/tools/maven/conf/settings.xml</span><br><span class="line">146   &lt;mirrors&gt;</span><br><span class="line">159     &lt;mirror&gt;</span><br><span class="line">160       &lt;<span class="built_in">id</span>&gt;aliyunmaven&lt;/id&gt;</span><br><span class="line">161       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">162       &lt;name&gt;阿里云公共仓库&lt;/name&gt;</span><br><span class="line">163       &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;</span><br><span class="line">164     &lt;/mirror&gt;</span><br><span class="line">165   &lt;/mirrors&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查mvn命令与jdk环境是否正常</span></span><br><span class="line">[root@aliyun /app/code/jpress]#mvn -v</span><br><span class="line">Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)</span><br><span class="line">Maven home: /app/tools/maven</span><br><span class="line">Java version: 1.8.0_351, vendor: Oracle Corporation, runtime: /app/tools/jdk1.8.0_351/jre</span><br><span class="line">Default locale: en_US, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">&quot;linux&quot;</span>, version: <span class="string">&quot;3.10.0-1160.114.2.el7.x86_64&quot;</span>, <span class="built_in">arch</span>: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;unix&quot;</span></span><br></pre></td></tr></table></figure><h3 id="1-5-mvn编译源码"><a href="#1-5-mvn编译源码" class="headerlink" title="1.5 mvn编译源码"></a>1.5 mvn编译源码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编译并安装依赖，无报错即可</span></span><br><span class="line">mvn clean package</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#找到编译后用于程序启动的jar包</span></span><br><span class="line">[root@aliyun /app/code/jpress]#find ./  -<span class="built_in">type</span> f -name star*jar</span><br><span class="line">./starter-tomcat/target/starter-tomcat-5.0-classes.jar</span><br><span class="line">./starter/target/starter-5.0/lib/starter-5.0.jar</span><br><span class="line">./starter/target/starter-5.0.jar</span><br><span class="line">[root@aliyun /app/code/jpress]#<span class="built_in">ls</span> starter/target/starter-5.0.jar -dl</span><br><span class="line">-rw-r--r-- 1 root root 9170 May 23 10:39 starter/target/starter-5.0.jar</span><br></pre></td></tr></table></figure><p><img src="/image-20240523104819374.png" alt="image-20240523104819374"></p><h3 id="1-6-内置脚本配置启动"><a href="#1-6-内置脚本配置启动" class="headerlink" title="1.6 内置脚本配置启动"></a>1.6 内置脚本配置启动</h3><blockquote><p>该应用内置了管理启停脚本，直接启动，默认前台运行在127.0.0.1地址上，只能本地访问</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#./jpress.sh start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@aliyun ~]# ss -tunlp|grep 8080</span><br><span class="line">tcp    LISTEN     0      128      [::ffff:127.0.0.1]:8080               [::]:*                   <span class="built_in">users</span>:((&quot;java&quot;,pid=<span class="number">2304</span>,fd=<span class="number">245</span>))</span><br><span class="line">[root@aliyun ~]# </span><br><span class="line">[root@aliyun ~]# </span><br><span class="line">[root@aliyun ~]# </span><br><span class="line">[root@aliyun ~]# </span><br><span class="line">[root@aliyun ~]# ps -ef|grep java</span><br><span class="line">root      2304     1  0 11:23 pts/0    00:00:15 java -Djava.awt.headless=<span class="literal">true</span> -Xverify:none -<span class="built_in">cp</span> /app/code/jpress/starter/target/starter-5.0/config:/app/code/jpress/starter/target/starter-5.0/lib/* io.jpress.Starter</span><br></pre></td></tr></table></figure><blockquote><p>修改脚本配置，改为后台运行，并且运行在所有网卡上，可以外网访问</p><p>开启23行和39行配置</p></blockquote><p><img src="/image-20240523120327023.png" alt="image-20240523120327023"></p><blockquote><p>修改后重新启动</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动</span></span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#./jpress.sh start</span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#<span class="built_in">nohup</span>: redirecting stderr to stdout</span><br><span class="line">回车</span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#<span class="built_in">ls</span></span><br><span class="line">config  jpress.bat  jpress.sh  jpress-start.bat  jpress-stop.bat  lib  output.log  webapp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#netstat -tunlp|grep 8080</span><br><span class="line">tcp6       0      0 :::8080                 :::*                    LISTEN      13307/java          </span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#ps -ef|grep jav[a]</span><br><span class="line">root     13307     1 20 12:06 pts/1    00:00:04 java -Djava.awt.headless=<span class="literal">true</span> -Xverify:none -Dundertow.port=8080 -Dundertow.host=0.0.0.0 -Dundertow.devMode=<span class="literal">false</span> -<span class="built_in">cp</span> /app/code/jpress/starter/target/starter-5.0/config:/app/code/jpress/starter/target/starter-5.0/lib/* io.jpress.Starte</span><br></pre></td></tr></table></figure><blockquote><p>目前还不能访问，下方配置好阿里云安全组开放端口，配置好数据库，进行web初始化安装jpress</p></blockquote><h2 id="2-部署数据库"><a href="#2-部署数据库" class="headerlink" title="2. 部署数据库"></a>2. 部署数据库</h2><p>mysql官网-二进制包安装地址</p><p><a href="https://downloads.mysql.com/archives/community/">https://downloads.mysql.com/archives/community/</a></p><h3 id="2-1-mysql数据库准备"><a href="#2-1-mysql数据库准备" class="headerlink" title="2.1 mysql数据库准备"></a>2.1 mysql数据库准备</h3><ul><li>版本选择：5.7版二进制安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.下载</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">ls</span></span><br><span class="line">mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.解压</span></span><br><span class="line">[root@aliyun ~]# tar -xf mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz  -C /app/tools/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.软链接</span></span><br><span class="line">[root@aliyun tools]# <span class="built_in">ln</span> -s /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/ /app/tools/mysql</span><br><span class="line">[root@aliyun tools]# ll -d mysql*</span><br><span class="line">lrwxrwxrwx 1 root root   47 May 22 17:46 mysql -&gt; /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x 9 root root 4096 May 22 17:45 mysql-5.7.20-linux-glibc2.12-x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#4.加入path环境变量</span></span><br><span class="line">[root@aliyun tools]# vim /etc/profile</span><br><span class="line">[root@aliyun tools]# <span class="built_in">tail</span> -1 /etc/profile </span><br><span class="line">PATH=<span class="variable">$PATH</span>:/app/tools/maven/bin:/app/tools/mysql/bin</span><br><span class="line"><span class="comment">##刷新加载</span></span><br><span class="line">[root@aliyun tools]# <span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment">##检查</span></span><br><span class="line">[root@aliyun tools]# mysql -V</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.20, <span class="keyword">for</span> linux-glibc2.12 (x86_64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#5.拷贝mysql启停管理脚本到/usr/init.d/,可以使用systemctl与service通过脚本启停管理mysql</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">cp</span> /app/tools/mysql/support-files/mysql.server  /etc/init.d/mysqld.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#6.卸载mariadb依赖，安装mysql运行依赖，否则无法运行启动</span></span><br><span class="line">[root@aliyun ~]# rpm -qa|grep mariadb</span><br><span class="line">mariadb-libs-5.5.68-1.el7.x86_64</span><br><span class="line">[root@aliyun ~]# yum remove mariadb* -y</span><br><span class="line">[root@aliyun ~]#yum install libaio-devel -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#7.创建mysql运行用户，降低权限</span></span><br><span class="line">[root@db-51 ~]#useradd -s /sbin/nologin -M mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#8.创建mysql3306实例数据目录</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">mkdir</span> -p /app/data/3306</span><br><span class="line"><span class="comment">##数据目录授权</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">chown</span> -R mysql.mysql /app/data/</span><br><span class="line">[root@aliyun ~]# ll -d /app/data/3306 /app/data</span><br><span class="line">drwxr-xr-x 3 mysql mysql 4096 May 22 17:55 /app/data</span><br><span class="line">drwxr-xr-x 2 mysql mysql 4096 May 22 17:55 /app/data/3306</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#9.初始化mysql</span></span><br><span class="line">[root@aliyun ~]# mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3306</span><br><span class="line">[root@aliyun ~]# <span class="built_in">ls</span> /app/data/3306/ -l</span><br><span class="line">total 110620</span><br><span class="line">-rw-r----- 1 mysql mysql       56 May 22 18:00 auto.cnf</span><br><span class="line">-rw-r----- 1 mysql mysql      419 May 22 18:00 ib_buffer_pool</span><br><span class="line">-rw-r----- 1 mysql mysql 12582912 May 22 18:00 ibdata1</span><br><span class="line">-rw-r----- 1 mysql mysql 50331648 May 22 18:00 ib_logfile0</span><br><span class="line">-rw-r----- 1 mysql mysql 50331648 May 22 18:00 ib_logfile1</span><br><span class="line">drwxr-x--- 2 mysql mysql     4096 May 22 18:00 mysql</span><br><span class="line">drwxr-x--- 2 mysql mysql     4096 May 22 18:00 performance_schema</span><br><span class="line">drwxr-x--- 2 mysql mysql    12288 May 22 18:00 sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#10.修改mysql配置文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/my.cnf &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#11.启动mysql，先enable让系统识别程序脚本，才可以使用systemctl命令调用脚本管理mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl <span class="built_in">enable</span> mysql</span><br><span class="line">[root@db-51 ~]#systemctl start mysql</span><br><span class="line">[root@aliyun /app/tools/mysql]#ss -tunlp|grep 3306</span><br><span class="line">tcp    LISTEN     0      80     [::]:3306               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">19087</span>,fd=<span class="number">20</span>))</span><br></pre></td></tr></table></figure><h3 id="2-2-创建授权jpress库连接用户"><a href="#2-2-创建授权jpress库连接用户" class="headerlink" title="2.2 创建授权jpress库连接用户"></a>2.2 创建授权jpress库连接用户</h3><blockquote><p>1.创建jpress数据库</p><p>2.创建授权jpress远程连接数据库的用户与密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建库</span></span><br><span class="line">mysql&gt; create database jpress;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户授权，这里jpress与mysql都在一台机器，所以限制登录的白名单，为云服务器本地ip回环地址就可以</span></span><br><span class="line">mysql&gt; grant all on jpress.* to jpress@<span class="string">&#x27;127.0.0.1&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| jpress             |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> jpress@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> jpress@127.0.0.1                                |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;jpress&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span>                 |</span><br><span class="line">| GRANT ALL PRIVILEGES ON `jpress`.* TO <span class="string">&#x27;jpress&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span> |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="2-3-创建授权navicat远程连接用户"><a href="#2-3-创建授权navicat远程连接用户" class="headerlink" title="2.3 创建授权navicat远程连接用户"></a>2.3 创建授权navicat远程连接用户</h3><blockquote><p>创建一个允许远程连接的用户，授予对jpress库所有权限，密码为1</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户授权</span></span><br><span class="line">mysql&gt; grant all on jpress.* to navicat@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看user表字段</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost |                                           |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| jpress        | 127.0.0.1 | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| navicat       | %         | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看权限</span></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> navicat@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> navicat@%                                |</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;navicat&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                 |</span><br><span class="line">| GRANT ALL PRIVILEGES ON `jpress`.* TO <span class="string">&#x27;navicat&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+----------------------------</span><br></pre></td></tr></table></figure><h3 id="2-4-修改默认端口3306为23306"><a href="#2-4-修改默认端口3306为23306" class="headerlink" title="2.4 修改默认端口3306为23306"></a>2.4 修改默认端口3306为23306</h3><blockquote><p>加固服务安全，修改对外端口改为23306，防止黑客恶意扫描攻击</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改mysql配置文件</span></span><br><span class="line">[root@aliyun ~]#vim /etc/my.cnf </span><br><span class="line">[root@aliyun ~]#<span class="built_in">cat</span> /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">port=23306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重载服务管理脚本，重启mysql</span></span><br><span class="line">[root@aliyun ~]#systemctl daemon-reload</span><br><span class="line">[root@aliyun ~]#systemctl restart mysqld</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-初始化安装jpress"><a href="#3-初始化安装jpress" class="headerlink" title="3. 初始化安装jpress"></a>3. 初始化安装jpress</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jpress运行在了阿里云服务器上，端口为8000</span><br><span class="line">阿里云默认防火墙规则未开放8000端口</span><br><span class="line">需要在阿里云控制台中开启8000端口</span><br><span class="line">本地windows机器才可以访问web页面</span><br></pre></td></tr></table></figure><h3 id="3-1-阿里云开放8080端口"><a href="#3-1-阿里云开放8080端口" class="headerlink" title="3.1 阿里云开放8080端口"></a>3.1 阿里云开放8080端口</h3><blockquote><p>目前客户端还无法访问，阿里云默认8080端口未开放，控制台手动开放即可</p></blockquote><p><img src="/image-20240523121224268.png" alt="image-20240523121224268"></p><h3 id="3-2-初始化安装jpress"><a href="#3-2-初始化安装jpress" class="headerlink" title="3.2 初始化安装jpress"></a>3.2 初始化安装jpress</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">访问阿里云服务器公网ip+程序运行端口，自动跳转安装页面</span><br><span class="line">手动</span><br></pre></td></tr></table></figure><p><img src="/image-20240523122109298.png" alt="image-20240523122109298"></p><hr><p><img src="/image-20240523163723613.png" alt="image-20240523163723613"></p><hr><p><img src="/image-20240523163829039.png" alt="image-20240523163829039"></p><hr><p><img src="/image-20240523164150884.png" alt="image-20240523164150884"></p><h2 id="4-navicat远程连接数据库"><a href="#4-navicat远程连接数据库" class="headerlink" title="4.navicat远程连接数据库"></a>4.navicat远程连接数据库</h2><h3 id="4-1-阿里云开放23306端口"><a href="#4-1-阿里云开放23306端口" class="headerlink" title="4.1 阿里云开放23306端口"></a>4.1 阿里云开放23306端口</h3><blockquote><p>此时还无法连接云服务器上的mysql，安全组规则未打开数据库连接端口，手动开放即可</p></blockquote><p><img src="/image-20240523165405653.png" alt="image-20240523165405653"></p><h3 id="4-2-navicat工具远程连接"><a href="#4-2-navicat工具远程连接" class="headerlink" title="4.2 navicat工具远程连接"></a>4.2 navicat工具远程连接</h3><blockquote><p>使用navicat远程连接云服务器上的mysql数据库</p><p>IP:  阿里云服务器ip地址</p><p>端口：23306</p><p>用户：navicat</p><p>密码：1</p></blockquote><p><img src="/image-20240523165635337.png" alt="image-20240523165635337"></p><hr><blockquote><p>连接成功</p></blockquote><p><img src="/image-20240523165759129.png" alt="image-20240523165759129"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;systemctl管理数据库&quot;&gt;&lt;a href=&quot;#systemctl管理数据库&quot; class=&quot;headerlink&quot; title=&quot;systemctl管理数据库&quot;&gt;&lt;/a&gt;systemctl管理数据库&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;:warning:</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-SQL语句</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-SQL%E8%AF%AD%E5%8F%A5/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-SQL%E8%AF%AD%E5%8F%A5/</id>
    <published>2024-08-20T01:22:32.000Z</published>
    <updated>2024-08-20T01:25:25.572Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-数据库服务SQL语句分类"><a href="#1-数据库服务SQL语句分类" class="headerlink" title="1.数据库服务SQL语句分类"></a>1.数据库服务SQL语句分类</h1><h2 id="1-1-SQL语句是什么"><a href="#1-1-SQL语句是什么" class="headerlink" title="1.1 SQL语句是什么"></a>1.1 SQL语句是什么</h2><ul><li><p>SQL语句就是用于管理操作数据库的一种语言，可以对数据库的数据进行管理</p></li><li><p>对关系型数据库进行操作控制，<em>MySQL、Oracle、SQL Server、PostgreSQL、IBM DB2、Sybase、Microsoft Access、SQLite</em></p></li><li><p>不同的数据库，SQL语句写法会有一些小区别</p></li></ul><h2 id="1-2-SQL语句分类"><a href="#1-2-SQL语句分类" class="headerlink" title="1.2 SQL语句分类"></a>1.2 SQL语句分类</h2><p><strong>DLL数据定义语言</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">-</span> DDL Data Definition <span class="keyword">Language</span>（数据定义语言）</span><br><span class="line"></span><br><span class="line">#概念介绍</span><br><span class="line">负责管理数据库的基础数据（不会对表的内容修改），比如增删库、增删表、增删索引、增删用户等；</span><br><span class="line"></span><br><span class="line">#涉及语句</span><br><span class="line"><span class="keyword">CREATE</span>（创建）、<span class="keyword">ALTER</span>（修改）、<span class="keyword">DROP</span>（删除）等；</span><br><span class="line"></span><br><span class="line">#关注人群</span><br><span class="line">运维人员和开发人员都要熟悉。</span><br><span class="line"></span><br><span class="line">#相关具体的DDL负责的操作行为，可以执行以下命令进行查看：</span><br><span class="line">mysql<span class="operator">&gt;</span> ? Data Definition;</span><br><span class="line"><span class="comment">-- 查看获取DDL语言的操作行为</span></span><br></pre></td></tr></table></figure><p><strong>DCL数据控制语言</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="operator">-</span> DCL Data Control <span class="keyword">Language</span>（数据控制语言）</span><br><span class="line"></span><br><span class="line">#概念介绍</span><br><span class="line">主要用来定义访问权限和安全级别</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#涉及语句</span><br><span class="line"><span class="keyword">GRANT</span>（用户授权）、<span class="keyword">REVOKE</span>（权限回收）、<span class="keyword">COMMIT</span>（提交）、<span class="keyword">ROLLBACK</span>（回滚）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#关注人群</span><br><span class="line">运维人员需要熟练</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#相关具体的DCL负责的操作行为，可以执行以下命令进行查看：</span><br><span class="line">mysql<span class="operator">&gt;</span> ? Account Management</span><br><span class="line"><span class="comment">-- 查看获取DCL语言的操作行为</span></span><br></pre></td></tr></table></figure><p><strong>DML数据操作语言</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- DML Data Manipulation Language（数据操作语言）</span><br><span class="line"></span><br><span class="line"><span class="comment">#概念介绍</span></span><br><span class="line">主要针对数据库里的表里的数据进行操作，用来定义数据库记录（数据）；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#涉及语句</span></span><br><span class="line">SELECT（查）、INSERT（增）、DELETE（删）、UPDATE（改）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关注人群</span></span><br><span class="line">开发人员要熟练，运维人员熟悉即可</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#相关具体的DML负责的操作行为，可以执行以下命令进行查看：</span></span><br><span class="line">mysql&gt; ? Data Manipulation</span><br><span class="line">-- 查看获取DML语言的操作行为</span><br></pre></td></tr></table></figure><p> <strong>DQL数据查询语言</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-DQL Data Query Language（数据查询语言）</span><br><span class="line"></span><br><span class="line"><span class="comment">#概念介绍</span></span><br><span class="line">主要用来查询记录（数据）</span><br><span class="line"></span><br><span class="line"><span class="comment">#涉及语句</span></span><br><span class="line">SELECT（查）</span><br><span class="line">基本结构是由SELECT子句，FROM子句，WHERE子句组成的查询块</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关注人群</span></span><br><span class="line">运维人员和开发人员都要熟练</span><br></pre></td></tr></table></figure><h2 id="1-3-SQL文件导入方式"><a href="#1-3-SQL文件导入方式" class="headerlink" title="1.3 SQL文件导入方式"></a>1.3 SQL文件导入方式</h2><ul><li>SQL文件准备: <a href="https://github.com/datacharmer/test_db.git">https://github.com/datacharmer/test_db.git</a></li></ul><blockquote><p>SQL数据文件导入的本质,就是在这个sql文件中定义了大量sql语句，导入mysq中创建大量的库表数据等</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备sql文件用于测试</span></span><br><span class="line">[root@db-51 ~/test_db]#<span class="built_in">ls</span> /root</span><br><span class="line">employees.sql </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前库</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p1 -e <span class="string">&quot;show databases;&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| linux              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#sql文件导入，两种方式，一种是命令行直接导入，一种是登录mysql后在内部进行导入</span></span><br><span class="line">[root@db-51 ~/test_db]#mysql -uroot -p1 &lt;   /root/test_db/employees.sql </span><br><span class="line">[root@db-51 ~/test_db]#mysql -uroot -p1 -e <span class="string">&quot;source  /root/test_db/employees.sql;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看创建的employees库</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| employees          |</span><br><span class="line">| linux              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看导入sql文件，默认创建库时的sql语句</span></span><br><span class="line">mysql&gt; show create database employees;</span><br><span class="line">+-----------+----------------------------------------------------------------------+</span><br><span class="line">| Database  | Create Database                                                      |</span><br><span class="line">+-----------+----------------------------------------------------------------------+</span><br><span class="line">| employees | CREATE DATABASE `employees` /*!40100 DEFAULT CHARACTER SET latin1 */ |</span><br><span class="line">+-----------+----------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#字段解释</span></span><br><span class="line">/*!40100  <span class="comment">#自动生成的注释符，为了让各个版本更加兼容sql语句</span></span><br><span class="line">DEFAULT CHARACTER SET latin1  <span class="comment">#创建该库时，指定的编码表为latin1</span></span><br><span class="line">latin1    <span class="comment">#字符集的一种字符格式叫做latin，指定该字符为编码表的话有中文数据时mysql会无法识别，无法显示</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建某个库指定编码表为utf8支持中文读写，理解mysql内查询显示创建库的sql含义</span></span><br><span class="line">mysql&gt; create database chaoge default character <span class="built_in">set</span> utf8;</span><br><span class="line">mysql&gt; show create database chaoge;</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                 |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| chaoge   | CREATE DATABASE `chaoge` /*!40100 DEFAULT CHARACTER SET utf8 */ |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h1 id="2-数据库服务字符编码设置"><a href="#2-数据库服务字符编码设置" class="headerlink" title="2.数据库服务字符编码设置"></a>2.数据库服务字符编码设置</h1><h2 id="2-1-字符编码作用"><a href="#2-1-字符编码作用" class="headerlink" title="2.1 字符编码作用"></a>2.1 字符编码作用</h2><p>计算机只识别二进制语言0&#x2F;1，真正与计算机交互的也只能是二进制语言，</p><p>为了更方便与计算机实现交互，使用人类语言的字符与之交互最为合适，于是就有了字符编码表</p><p>通过字符编码表做一个转换，将字符通过编码表的形式转换为二进制语言存储在计算机上，</p><p>计算机展示时也可以通过编码表将二进制转换成字符形式，展现给人类</p><p><strong>（避免中文乱码）–为什么中文会乱码</strong></p><ul><li>服务端使用的不是支持中文字符转换二进制的编码表（utf8）</li></ul><p>当使用不支持的中文编码表在计算机上存储中文字符数据时，计算机无法通过编码表正确存储对应的二进制数据</p><p>而读取中文字符时，二进制数据无法通过编码表正确转换为中文字符，所以就会显示中文乱码</p><ul><li>客户端使用非utf8编码表时，也会导致中文乱码，如xshell终端设置一个不支持中文编码表时</li></ul><p>即使服务端正确转换了中文字符，而客户端不是中文编码表，显示的字符也无法转换，就会导致乱码</p><ul><li>服务端与客户端需要编码表统一</li></ul><h2 id="2-2-常用字符编码与区别"><a href="#2-2-常用字符编码与区别" class="headerlink" title="2.2 常用字符编码与区别"></a>2.2 常用字符编码与区别</h2><blockquote><p>下方两种编码表都是可以支持中文识别的编码表</p></blockquote><ul><li>utf8:    最多存储3字节的字符，不支持表情符号</li><li>utf8mb4: 最多存储4字节的的字符，支持表情符号</li></ul><p>计算机存储最小单位是bit位，bit位代表一个二进制0&#x2F;1，</p><p>1字节&#x3D;8bit，8个二进制，最大组合为11111111，转换为人类更好识别的十进制计算，2^8次方，就是0-255种存储的二进制组合方式</p><p>3字节&#x3D;24bit，24个二进制，最大组合为24个1，转换成十进制就是16777216种组合，可以存放0-1亿多字符</p><h2 id="2-3-如何设置字符编码"><a href="#2-3-如何设置字符编码" class="headerlink" title="2.3 如何设置字符编码"></a>2.3 如何设置字符编码</h2><ul><li><p>查看数据库系统种可以设置的字符编码有什么</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show charset;</span><br></pre></td></tr></table></figure></li><li><p>查看目前mysql系统字符编码设置</p><blockquote><p>下方配置参数，server参数编码为latin1，不支持中文字符，会导致中文乱码</p><blockquote><p>正确设置: 除了filesystem，全部统一为utf8或utf8mb4</p></blockquote></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                          |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                           |</span><br><span class="line">| character_set_connection | utf8                                                           |</span><br><span class="line">| character_set_database   | latin1                                                         |</span><br><span class="line">| character_set_filesystem | binary                                                         |</span><br><span class="line">| character_set_results    | utf8                                                           |</span><br><span class="line">| character_set_server     | latin1                                                         |</span><br><span class="line">| character_set_system     | utf8                                                           |</span><br><span class="line">| character_sets_dir       | /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>字符编码参数解释</p><table><thead><tr><th>序号</th><th>参数信息</th><th>解释说明</th></tr></thead><tbody><tr><td>01</td><td><code>character_set_client</code></td><td>用来设置客户端使用的字符集</td></tr><tr><td>02</td><td><code>character_set_connection</code></td><td>用来设置连接数据库时的字符集 如果程序中没有指明连接数据库使用的字符集类型则按照这个字符集设置。</td></tr><tr><td>03</td><td><code>character_set_database</code></td><td>用来设置默认创建数据库的编码格式 如果在创建数据库时没有设置编码格式，就按照这个格式设置。</td></tr><tr><td>04</td><td>character_set_filesystem</td><td>文件系统的编码格式，把操作系统上的文件名转化成此字符集 即把 character_set_client转换character_set_filesystem， 默认binary是不做任何转换</td></tr><tr><td>05</td><td><code>character_set_results</code></td><td>数据库给客户端返回时使用的编码格式，如果没有指明，使用服务器默认的编码格式。</td></tr><tr><td>06</td><td><code>character_set_server</code></td><td>服务器安装时指定的默认编码格式，这个变量建议由系统自己管理，不要人为定义。</td></tr><tr><td>07</td><td>character_set_system</td><td>数据库系统使用的编码格式，这个值一直是utf8 不需要设置，它是为存储系统元数据的编码格式。</td></tr><tr><td>08</td><td>character_sets_dir</td><td>这个变量是字符集安装的目录。</td></tr></tbody></table></li></ul><p><strong>1）全局调整字符编码</strong></p><ul><li>修改配置文件，添加指定服务端编码参数为utf8即可，database参数无需指定，server编码参数会关联到database</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#vim /etc/my.cnf</span><br><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">character-set-server=utf8  <span class="comment">#添加服务端指定编码表</span></span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log-error=/app/tools/mysql/3306_error.<span class="built_in">log</span></span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line"></span><br><span class="line">[root@db-51 ~]#systemctl restart mysqld</span><br></pre></td></tr></table></figure><ul><li>修改后，重启服务端，再次查看数据库编码配置，server参数与databse编码变成了utf8</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%char%&#x27;;</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                          |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                           |</span><br><span class="line">| character_set_connection | utf8                                                           |</span><br><span class="line">| character_set_database   | utf8                                                           |</span><br><span class="line">| character_set_filesystem | binary                                                         |</span><br><span class="line">| character_set_results    | utf8                                                           |</span><br><span class="line">| character_set_server     | utf8                                                           |</span><br><span class="line">| character_set_system     | utf8                                                           |</span><br><span class="line">| character_sets_dir       | /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p><strong>2）局部调整字符编码</strong></p><blockquote><p>局部调整就是，创建库与表时后面指定编码表，便不会受全局编码参数影响。</p></blockquote><ul><li>当前server与database编码参数为latin</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&quot;%char%&quot;</span>;</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                          |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                           |</span><br><span class="line">| character_set_connection | utf8                                                           |</span><br><span class="line">| character_set_database   | latin1                                                         |</span><br><span class="line">| character_set_filesystem | binary                                                         |</span><br><span class="line">| character_set_results    | utf8                                                           |</span><br><span class="line">| character_set_server     | latin1                                                         |</span><br><span class="line">| character_set_system     | utf8                                                           |</span><br><span class="line">| character_sets_dir       | /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br></pre></td></tr></table></figure><ul><li>创建数据库与数据表表时默认编码表都为latin</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建库</span></span><br><span class="line">mysql&gt; create database yuchao;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看创建库生成的sql语句，编码表为latin1</span></span><br><span class="line">mysql&gt; show create database yuchao;</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                   |</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">| yuchao   | CREATE DATABASE `yuchao` /*!40100 DEFAULT CHARACTER SET latin1 */ |</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建表，查看sql语句，编码表为latin1</span></span><br><span class="line">mysql&gt; create table t1(<span class="built_in">id</span> int);</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                           |</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>创建数据库库与数据表，局部设置字符编码</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建数据库和表，指定字符编码为utf8</span></span><br><span class="line">mysql&gt; create database yuchao1 charset utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use yuchao1</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table t2(<span class="built_in">id</span> int) charset utf8;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看创建的库与表，局部设置成功</span></span><br><span class="line">mysql&gt; show create database yuchao1;</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                  |</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">| yuchao1  | CREATE DATABASE `yuchao1` /*!40100 DEFAULT CHARACTER SET utf8 */ |</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t2;</span><br><span class="line">+-------+--------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                         |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------+</span><br><span class="line">| t2    | CREATE TABLE `t2` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="2-4-字符编码校验码-排序规则"><a href="#2-4-字符编码校验码-排序规则" class="headerlink" title="2.4 字符编码校验码(排序规则)"></a>2.4 字符编码校验码(排序规则)</h2><p>字符编码校对规则（排序规则）：</p><p>在进行字符编码设置时，还需要设置校对规则信息，校对规则是什么？      </p><p>排序规则，就是指字符比较时按照字符编码还是直接用二进制数据比较，以及是否区分大小写。</p><p><code>主要可以根据校对规则定义或设置的不同：在查询数据信息时，影响数据信息的查询输出和排序效果；</code></p><p>其中utf8mb4字符集中，常用的排序规则有utf8mb4_unicode_ci、utf8mb4_general_ci、utf8mb4_bin：</p><p>排序规则前缀是字符集编码，中间是排序规则名称，后缀有特殊意义如下（常用的）：</p><table><thead><tr><th>排序规则后缀</th><th>解释说明</th></tr></thead><tbody><tr><td>_ci</td><td>不区分大小写，Case-insensitive的缩写</td></tr><tr><td>_cs</td><td>区分大小写，Case-sensitive的缩写</td></tr><tr><td>_ai</td><td>不区分重音，Accent-insensitive的缩写</td></tr><tr><td>_as</td><td>区分重音，Accent-sensitive的缩写</td></tr><tr><td>_bin</td><td>采用二进制方式存储数据信息</td></tr></tbody></table><p>utf8mb4_unicode_ci是基于标准Unicode来排序和比较，能够在各种语言之间精确排序。且在特殊情况下，Unicode排序规则为了能够处理特殊字符的情况，实现了略微复杂的排序算法。但是在绝大多数情况下不会发生此类复杂比较。</p><p>utf8mb4_general_ci没有实现Unicode排序规则，在遇到某些特殊字符情况下，排序结果可能不一致。但是，在绝大多数情况下，这些特殊字符的顺序并不需要那么精确。</p><p>utf8mb4_bin将字符串的每个字符用二进制数据编译存储，区分大小写，而且可以存二进制的内容。</p><p>综合来说，utf8mb4_unicode_ci比较准确，utf8mb4_general_ci速度较快。utf8mb4_unicode_ci对于特殊字符的处理，在中文、英文应用中不会使用到，除非你的应用有德语、法语、俄语等，则需要使用utf8mb4_unicode_ci，否则一般选用utf8mb4_general_ci就可以了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据库服务中可用的校对规则信息</span></span><br><span class="line">mysql&gt; show collation;</span><br><span class="line">+----------------------------+------------+------+----------+-------------+-----------+------------------+</span><br><span class="line">| Collation                        | Charset   | Id    | Default | Compiled | Sortlen   | Pad_attribute |</span><br><span class="line">+----------------------------+------------+------+----------+-------------+-----------+------------------+</span><br><span class="line">| utf8mb4_0900_ai_ci     | utf8mb4  | 255 | Yes        | Yes            |            0   | NO PAD            |</span><br><span class="line">| utf8mb4_0900_bin        | utf8mb4  | 309 |              | Yes            |            1   | NO PAD            |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置数据库服务中可用的校对规则信息</span></span><br><span class="line">mysql&gt; create database xiaoA charset utf8 collate utf8_general_mysql500_ci;</span><br><span class="line">mysql&gt; show create database xiaoA;</span><br><span class="line">+----------+------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                                                                                    |</span><br><span class="line">+----------+------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| xiaoA    | CREATE DATABASE `xiaoA` /*!40100 DEFAULT CHARACTER SET utf8 COLLATE utf8_general_mysql500_ci */ /*!80016 DEFAULT ENCRYPTION=<span class="string">&#x27;N&#x27;</span> */ |</span><br><span class="line">+----------+------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">--- 数据库设置字符编码校对规则</span><br><span class="line"></span><br><span class="line">mysql&gt; use xiaoA;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table t1 (<span class="built_in">id</span> int) charset utf8 collate utf8_german2_ci;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_german2_ci |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">--- 数据表设置字符编码校对规则</span><br></pre></td></tr></table></figure><p>数据库校对规则设置应用实践：</p><p>创建三个数据表，并设置相同的字符集，以及不同的字符校对规则；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table t1(info char(3)) charset utf8mb4 collate utf8mb4_0900_ai_ci;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create table t2(info char(3)) charset utf8mb4 collate utf8mb4_0900_as_cs;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create table t3(info char(3)) charset utf8mb4 collate utf8mb4_bin;</span><br><span class="line">Query OK, 0 rows affected (0.12 sec)</span><br></pre></td></tr></table></figure><p>向两个表中插入相同的数据，并进行数据查询操作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"># 插入数据信息</span><br><span class="line">mysql&gt; insert into t1 values(&#x27;a&#x27;),(&#x27;A&#x27;),(&#x27;b&#x27;),(&#x27;B&#x27;),(&#x27;c&#x27;),(&#x27;C&#x27;);</span><br><span class="line">mysql&gt; insert into t2 values(&#x27;a&#x27;),(&#x27;A&#x27;),(&#x27;b&#x27;),(&#x27;B&#x27;),(&#x27;c&#x27;),(&#x27;C&#x27;);</span><br><span class="line">mysql&gt; insert into t3 values(&#x27;a&#x27;),(&#x27;A&#x27;),(&#x27;b&#x27;),(&#x27;B&#x27;),(&#x27;c&#x27;),(&#x27;C&#x27;);</span><br><span class="line"></span><br><span class="line"># 查询数据信息</span><br><span class="line">mysql&gt; select * from t1 where info=&#x27;a&#x27;;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">| A    |</span><br><span class="line">+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t2 where info=&#x27;a&#x27;;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t3 where info=&#x27;a&#x27;;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">-- 校对规则不同，查询的数据结果会区分大小写显示</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t1 order by info;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">| A    |</span><br><span class="line">| b    |</span><br><span class="line">| B    |</span><br><span class="line">| c    |</span><br><span class="line">| C    |</span><br><span class="line">+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t2 order by info;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">| A    |</span><br><span class="line">| b    |</span><br><span class="line">| B    |</span><br><span class="line">| c    |</span><br><span class="line">| C    |</span><br><span class="line">+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t3 order by info;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| A    |</span><br><span class="line">| B    |</span><br><span class="line">| C    |</span><br><span class="line">| a    |</span><br><span class="line">| b    |</span><br><span class="line">| c    |</span><br><span class="line">+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line">-- 校对规则不同，查询的数据结果会有不同的排序效果</span><br></pre></td></tr></table></figure><h1 id="3-数据库数据类型介绍"><a href="#3-数据库数据类型介绍" class="headerlink" title="3.数据库数据类型介绍"></a>3.数据库数据类型介绍</h1><h2 id="3-1-数据类型概述"><a href="#3-1-数据类型概述" class="headerlink" title="3.1 数据类型概述"></a>3.1 数据类型概述</h2><blockquote><p>主要用于限制用户输入的信息，必须是合理的，如电话输入数值，姓名输入字符串，不可胡乱写入</p></blockquote><p>数据类型从数据存储底层机制来看，主要和内存中如何存储数据信息有关；</p><p>在数据库服务中，每一个常量、变量和参数都有数据类型，数据类型用来指定数据的存储格式、约束和有效范围</p><p>详细数据类型说明地址:<a href="https://m.php.cn/article/460317.html">https://m.php.cn/article/460317.html</a></p><h2 id="3-2-常用数据类型"><a href="#3-2-常用数据类型" class="headerlink" title="3.2 常用数据类型"></a>3.2 常用数据类型</h2><p><strong>整数类型</strong></p><table><thead><tr><th>类别</th><th>数据类型细分</th><th>差异区别</th></tr></thead><tbody><tr><td>整数类型</td><td>tinyint</td><td>占用1字节 有符号取值 -128~127 无符号取值 0 ~ 255（最大3位数）</td></tr><tr><td></td><td>int</td><td>占用4字节 有符号取值 -2147483648 ~ 2147483647 无符号取值 0 ~ 4294967295（最大10位数）</td></tr><tr><td></td><td>BIGINT</td><td>占用8字节 …  0~2^64-1（最大20位数）</td></tr></tbody></table><p><strong>字符串类型</strong></p><table><thead><tr><th>类别</th><th>数据类型细分</th><th>差异区别</th></tr></thead><tbody><tr><td>字符类型</td><td>char(n)</td><td>表示定长的字符串类型，n表示可以存储字符的字节上限（n取值 0~255）</td></tr><tr><td></td><td>varchar(n)</td><td>表示变长的字符串类型，n表示可以存储字符的字节上限（n取值 0~65535）</td></tr></tbody></table><p><strong>浮点数类型</strong></p><table><thead><tr><th>类型</th><th>类型细化</th><th>说明</th></tr></thead><tbody><tr><td>浮点（数字&#x2F;小数）</td><td>float</td><td>单精度浮点数<br>一般使用方法为，float （4,1），4代表数字长度，1代表小数</td></tr><tr><td></td><td>double</td><td>双精度浮点数</td></tr><tr><td></td><td>decimal</td><td>定点数</td></tr></tbody></table><p><strong>时间类型</strong></p><table><thead><tr><th>类别</th><th>数据类型细分</th><th>差异区别</th></tr></thead><tbody><tr><td>时间类型</td><td>date</td><td>日期类型</td></tr><tr><td></td><td>time</td><td>时间类型</td></tr><tr><td></td><td>datetime</td><td>日期时间类型（1000~9999）占8字节</td></tr><tr><td></td><td>timestamp</td><td>时间戳类型（1970~2038）格林威治时间 占4字节</td></tr></tbody></table><p><strong>特殊数据类型</strong></p><table><thead><tr><th>名称</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>enum</td><td>枚举类型</td><td>类似于case语句判断。字段类型设置枚举类型后（初中，高中，小学），用户输入数据后类型判断是否是枚举中的某一个数据。如输入小学，判断是枚举中类型之一，允许写入。输入幼儿园，判断不是枚举中类型之一，不允许写入。</td></tr></tbody></table><h1 id="4-数据库属性约束设置"><a href="#4-数据库属性约束设置" class="headerlink" title="4.数据库属性约束设置"></a>4.数据库属性约束设置</h1><blockquote><p>约束用户输入的信息，做一个更大的限制，例如信息不可重复，信息必须写入等</p></blockquote><p>在数据库服务中进行数据存储时，类似于在一个execl表中存储数据一样，如果没有对表的字段进行约束和限制，是可以随意存储数据的；</p><p>但是，在数据表的某些字段上，是有特殊含义的，如果随意进行存储数据，会造成存储信息的混乱，因此引入了约束与属性概念；</p><p>通过数据类型设置的约束与属性，可以让数据库服务限制人类录入的数据信息，从而避免录入数据信息混乱的局面；</p><p>并且，通过数据类型的约束与属性设置，还可以避免数据信息输入的重复与输入数据信息不能为空；</p><h2 id="4-1-常用的约束定义"><a href="#4-1-常用的约束定义" class="headerlink" title="4.1 常用的约束定义"></a>4.1 常用的约束定义</h2><table><thead><tr><th>序号</th><th>约束方法</th><th>解释说明</th></tr></thead><tbody><tr><td>01</td><td>PK（primary key）</td><td>表示主键约束，非空且唯一（表中只能有一个主键），唯一标识</td></tr><tr><td>02</td><td>UK（unique key）</td><td>表示唯一约束，输入信息可以不写，写入的话不可重复，如电话号码，学号</td></tr><tr><td>03</td><td>NN（not null）</td><td>表示非空约束，输入信息可以重复，但不可以不写入，如名字</td></tr><tr><td>04</td><td>FK（foreign key）</td><td>表示外键约束，多表之间关联使用，约束能力可以通过程序代码逻辑替换</td></tr></tbody></table><h2 id="4-2-常用的属性定义"><a href="#4-2-常用的属性定义" class="headerlink" title="4.2 常用的属性定义"></a>4.2 常用的属性定义</h2><blockquote><p>辅助数据表信息的录入</p></blockquote><table><thead><tr><th>序号</th><th>属性信息</th><th>解释说明</th></tr></thead><tbody><tr><td>01</td><td>default</td><td>设定默认数据信息，可以实现自动填充<br />用户输入时某信息没有写入，但该字段下必须有信息写入，可通过默认属性可给予默认值，完善表内容</td></tr><tr><td>02</td><td>auto_increment</td><td>设定数值信息自增，可以实现数值编号自增填充（一般配合主键使用）<br />用于配合主键使用，主键字段下方信息都是非空且唯一，为了防止多用户输入信息时经常导致冲突，所有就根据用户在注册信息时，请求到达数据库时，根据请求对该字段进行一个自动填充，保证了添加主键的字段属性非空且唯一。</td></tr><tr><td>02</td><td>comment</td><td>设定数据注释信息<br />用于对表中字段注释说明，当数据表字段较多，无法识别某字段下方信息具体的含义，如name字段信息，是个人姓名还是网络昵称或是亲属名称。</td></tr><tr><td>03</td><td>unsigned</td><td>设定数值信息非负，可以实现数值信息列不能出现负数信息<br />用于做数值统计，例如做人口统计统计人数时，写入的信息不能非负数。</td></tr></tbody></table><h1 id="5-数据库DDL定义语句"><a href="#5-数据库DDL定义语句" class="headerlink" title="5.数据库DDL定义语句"></a>5.数据库DDL定义语句</h1><p>DDL数据库定义语句主要针对数据库内部对象，对库表，创建，修改，删除等操作</p><h2 id="5-1-定义数据库语句"><a href="#5-1-定义数据库语句" class="headerlink" title="5.1 定义数据库语句"></a>5.1 定义数据库语句</h2><blockquote><p>对库的创建，属性，增改查</p><p>库的属性： 库名，排序规则，字符编码</p></blockquote><h3 id="1）定义库规范"><a href="#1）定义库规范" class="headerlink" title="1）定义库规范"></a>1）定义库规范</h3><ol><li><p>库名不得以数字开头</p></li><li><p>库名和业务有关，见名知意</p></li><li><p>库名不得有大写字母，都是为了多系统平台的兼容性</p></li><li><p>创建数据库需要有指定的字符集，建议设定默认规则就是utf8mb4</p></li><li><p>生产环境下，禁用普通用户的drop database权限</p></li></ol><h3 id="2）查看数据库"><a href="#2）查看数据库" class="headerlink" title="2）查看数据库"></a>2）查看数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看所有数据库</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |    <span class="comment"># 系统自带库，存储数据库内置信息</span></span><br><span class="line">| mysql              |    <span class="comment"># 自带库，存储用户信息，授权等</span></span><br><span class="line">| performance_schema |    <span class="comment"># 存储和性能相关的数据</span></span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看show create帮助信息</span></span><br><span class="line"><span class="built_in">help</span> show create database</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看建库sql语句</span></span><br><span class="line">show create database 库名;</span><br><span class="line">show create database 库名;</span><br></pre></td></tr></table></figure><h3 id="4）创建数据库"><a href="#4）创建数据库" class="headerlink" title="4）创建数据库"></a>4）创建数据库</h3><ul><li><strong>直接创建数据库</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create database yu charset utf8;</span><br><span class="line">create database yu charset utf8mb4;</span><br></pre></td></tr></table></figure><ul><li><strong>判断同名数据库是否存在，不存在则创建</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database  <span class="keyword">if</span> not exists kings default charset utf8mb4 ;</span><br></pre></td></tr></table></figure><ul><li><strong>查询字符编码与排序规则相关信息</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0.查看当前数据库全局字符编码配置</span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.查看数据库所支持的字符编码有哪些</span><br><span class="line">mysql&gt; show character <span class="built_in">set</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.查看字符编码支持的排序规则</span><br><span class="line">mysql&gt; show collation;</span><br><span class="line">  排序规则名称              哪个字符编码支持     默认值跟随字符编码        所占字节</span><br><span class="line">+--------------------------+----------+-----+---------+----------+---------+</span><br><span class="line">| Collation                | Charset  | Id  | Default | Compiled | Sortlen |</span><br><span class="line">| utf8_general_ci          | utf8     |  33 | Yes     | Yes      |       1 |</span><br><span class="line">| utf8mb4_general_ci       | utf8mb4  |  45 | Yes     | Yes      |       1 |</span><br></pre></td></tr></table></figure><ul><li><strong>不指定具体字符编码与校验规则创建数据库</strong></li></ul><blockquote><p>不指定字符编码，会跟随全局字符编码设置</p><p>不指定校验规则，会根据字符编码的默认值设置</p><p>5.7版创建数据库后，查看创建库sql语句，不显示校验规则信息</p><p>5.8版创建数据库后，查看创建库sql语句，会显示校验规则信息</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0.当前系统全局字符编码配置</span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                          |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                           |</span><br><span class="line">| character_set_connection | utf8                                                           |</span><br><span class="line">| character_set_database   | utf8mb4                                                        |</span><br><span class="line">| character_set_filesystem | binary                                                         |</span><br><span class="line">| character_set_results    | utf8                                                           |</span><br><span class="line">| character_set_server     | utf8mb4                                                        |</span><br><span class="line">| character_set_system     | utf8                                                           |</span><br><span class="line">| character_sets_dir       | /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.创建数据库，不指定字符编码与校验码</span><br><span class="line">mysql&gt; create database yu;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.当前使用的时5.7版本，无法通过命令行查询排序规则，只能通过图形化查询排序规则</span><br></pre></td></tr></table></figure><p>不指定排序规则与字符集，会跟随数据库全局字符配置与默认排序规则设置</p><p><img src="/image-20240601180342632.png" alt="image-20240601180342632"></p><ul><li><strong>指定字符集与排序规则创建数据库</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0.指定字符编码与排序规则创建数据库</span><br><span class="line">mysql&gt; create database yu2 charset utf8mb4 collate utf8mb4_bin;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.查询库的新字符编码与排序规则</span><br></pre></td></tr></table></figure><p><img src="/image-20240601181257930.png" alt="image-20240601181257930"></p><h3 id="5）修改数据库"><a href="#5）修改数据库" class="headerlink" title="5）修改数据库"></a>5）修改数据库</h3><ul><li><strong>修改数据库字符编码与排序规则</strong></li></ul><blockquote><p>语法：<br>ALTER  DATABASE 库名  CHARSET 新的字符集</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前库字符集为utf8mb4</span></span><br><span class="line">show create database yu;</span><br><span class="line">mysql&gt; show create database yu;</span><br><span class="line">+----------+----------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                |</span><br><span class="line">+----------+----------------------------------------------------------------+</span><br><span class="line">| yu       | CREATE DATABASE `yu` /*!40100 DEFAULT CHARACTER SET utf8mb4 */ |</span><br><span class="line">+----------+----------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改字符集为utf8</span></span><br><span class="line">mysql&gt; alter database yu charset utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create database yu;</span><br><span class="line">+----------+-------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                             |</span><br><span class="line">+----------+-------------------------------------------------------------+</span><br><span class="line">| yu       | CREATE DATABASE `yu` /*!40100 DEFAULT CHARACTER SET utf8 */ |</span><br><span class="line">+----------+-------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li><strong>修改数据库名字</strong></li></ul><p>&#x3D;&#x3D;不支持直接修改，会影响数据库内数据，必须修改可以创建新库名，再将库中数据备份，导入新库即可&#x3D;&#x3D;</p><h2 id="5-2-定义数据表语句"><a href="#5-2-定义数据表语句" class="headerlink" title="5.2 定义数据表语句"></a>5.2 定义数据表语句</h2><blockquote><p>主要对数据表结构的增删改查</p><blockquote><p>数据表结构：数据表名，字段列属性(字段名，数据类型，约束属性设置), 数据表属性(引擎，字符编码，排序规则)</p></blockquote></blockquote><h3 id="1）定义表规范"><a href="#1）定义表规范" class="headerlink" title="1）定义表规范"></a>1）定义表规范</h3><ul><li>1.表名的规范<ul><li>不得数字开</li><li>见名知意，表和业务有关，参考wordpress等数据库命名规范</li><li>不得大写字母</li><li>别超过18个字符</li><li>别是mysql默认关键字</li></ul></li><li><ol start="2"><li>默认存储引擎是innodb</li></ol></li><li><ol start="3"><li>5.7之后，数据表字符集，默认utf8mb4</li></ol></li><li><ol start="4"><li>数据表的字段（列）也和业务有关，字符别超过18个</li></ol></li><li><ol start="5"><li>数据表的字段（列）要选择合适的、足够容量、省磁盘空间的数据类型</li></ol></li><li><ol start="6"><li>数据表的字段（列）建议都not null</li></ol></li><li><ol start="7"><li>数据表的字段（列）建议都要有注释</li></ol></li><li><ol start="8"><li>数据表的字段（列） 每张数据表都建议加主键</li></ol></li><li><ol start="9"><li>针对not null的列，一般给与默认值</li></ol></li><li><ol start="10"><li>给每张表添加注释</li></ol></li></ul><h3 id="2）修改表规范"><a href="#2）修改表规范" class="headerlink" title="2）修改表规范"></a>2）修改表规范</h3><ol><li>添加数据表的字段（列），建议用追加方式</li><li>修改列的属性，建议用modify语句</li><li>修改表的属性，建议在业务不繁忙的时候修改</li></ol><h3 id="3）创建数据表"><a href="#3）创建数据表" class="headerlink" title="3）创建数据表"></a>3）创建数据表</h3><blockquote><ul><li>图形化工具创建表</li><li>根据下方sql信息使用图形化创建表</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `students` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">  `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">  `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">  `address` enum(<span class="string">&#x27;北京&#x27;</span>,<span class="string">&#x27;深圳&#x27;</span>,<span class="string">&#x27;云南&#x27;</span>,<span class="string">&#x27;江苏&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;省份&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure><ul><li>图形化创建如下</li><li>创建之后，可以在图形化中，写入数据测试，验证字段的类型限制，约束限制，属性信息设置</li></ul><p><img src="/image-20240601200415554.png" alt="image-20240601200415554"></p><blockquote><p>手写sql语句创建数据表，并且插入数据查看</p><p>第一种语法：</p><p>create table  库.表(字段1  字段约束属性，字段2 字段约束属性);</p><p>第二种语法：</p><p>use  库;</p><p>create table  表(字段1  字段约束属性，字段2 字段约束属性);</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE `stu2` (</span><br><span class="line">    -&gt;   `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">    -&gt;   `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">    -&gt;   `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">    -&gt;   `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">    -&gt;   `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">    -&gt;   `intime` datetime NOT NULL DEFAULT now()   COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">    -&gt;   `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">    -&gt;   PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">    -&gt; ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据表结构信息</span></span><br><span class="line">mysql&gt; desc stu2;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#根据数据表结构插入数据</span></span><br><span class="line"><span class="comment">#完整的定义每个字段插入数据</span></span><br><span class="line">mysql&gt; insert into stu2(<span class="built_in">id</span>,name,age,gender,address,intime,phone) values(1,<span class="string">&#x27;赵东兴&#x27;</span>,23,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内蒙古包头市&#x27;</span>,now(),15598001352);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"><span class="comment">#查看数据表信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu2;</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address            | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古包头市       | 2024-06-01 20:20:26 | 15598001352 |</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#不定义id与intime字段写入数据，id不输入可通过主键实现自增，intime不输入可通过默认值时间变量实现自动添加</span></span><br><span class="line">mysql&gt; insert into stu2(name,age,gender,address,phone) values(<span class="string">&#x27;黄牛&#x27;</span>,21,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内蒙古包头市&#x27;</span>,16666666666);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"><span class="comment">#查看数据表信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu2;</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address            | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古包头市       | 2024-06-01 20:20:26 | 15598001352 |</span><br><span class="line">|  2 | 黄牛      |  21 | 男     | 内蒙古包头市       | 2024-06-01 20:28:47 | 16666666666 |</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br></pre></td></tr></table></figure><h3 id="4）复制数据表"><a href="#4）复制数据表" class="headerlink" title="4）复制数据表"></a>4）复制数据表</h3><blockquote><p>复制某数据表结构，生成另一张新数据表</p><blockquote><p>需求：复制上面的stu2表，生成stu3表，要求数据表结构相同</p></blockquote></blockquote><ul><li>方法一，拿到该表的建表sql语句，将数据表名修改即可</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1.查询stu2表的建表语句</span><br><span class="line">mysql&gt; show create table stu2;</span><br><span class="line">-----------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                 </span><br><span class="line">| stu2  | CREATE TABLE `stu2` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">  `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">  `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">  `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4                            |</span><br><span class="line"></span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.修改sql语句表名，直接创建即可</span><br><span class="line">mysql&gt; CREATE TABLE `stu3` (</span><br><span class="line">    -&gt;   `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">    -&gt;   `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">    -&gt;   `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">    -&gt;   `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">    -&gt;   `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">    -&gt;   `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">    -&gt;   `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">    -&gt;   PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">    -&gt; ) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4</span><br><span class="line">    -&gt; ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.查看stu3表结构</span><br><span class="line">mysql&gt; desc stu3;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br></pre></td></tr></table></figure><ul><li>方法二，使用特有的复制表sql语句生成新数据表，保留原表结构</li></ul><blockquote><p>语法： create table  要生成的数据表（新的）   like   要复制的数据表（旧的）</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1.特有的复制生成新表的sql语句</span><br><span class="line">mysql&gt; create table stu4 like stu2;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">2.查看表结构</span><br><span class="line">mysql&gt; desc stu4;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><h2 id="5-3-修改表结构语句"><a href="#5-3-修改表结构语句" class="headerlink" title="5.3 修改表结构语句"></a>5.3 修改表结构语句</h2><h3 id="1）语法概述"><a href="#1）语法概述" class="headerlink" title="1）语法概述"></a>1）语法概述</h3><ul><li><strong>语法</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表名  具体的动作 </span><br></pre></td></tr></table></figure><ul><li><strong>添加新字段</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表名  ADD</span><br></pre></td></tr></table></figure><ul><li><strong>指定在第一个列添加新字段</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER  TABLE  表  ADD COLUMN  字段名  数据类型  约束条件 注释  first;</span><br></pre></td></tr></table></figure><ul><li><strong>指定在某个字段后添加新字段</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表  ADD  COLUMN  字段 数据类型 约束 注释   AFTER  哪个字段后添加；</span><br></pre></td></tr></table></figure><ul><li><strong>修改字段结构</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表名  change</span><br><span class="line"></span><br><span class="line">ALTER TABLE  表名  modify</span><br></pre></td></tr></table></figure><ul><li><strong>删除字段</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表名  drop  字段名</span><br></pre></td></tr></table></figure><h3 id="2）添加字段属性"><a href="#2）添加字段属性" class="headerlink" title="2）添加字段属性"></a>2）添加字段属性</h3><blockquote><p>使用入如下stu1数据表结构练习</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;   show create table stu1;</span><br><span class="line">| Table | Create Table                                                                                 </span><br><span class="line">| stu1  | CREATE TABLE `stu1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">  `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">  `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">  `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><p><strong>指定第一列最前面添加字段</strong></p><blockquote><p>语法:</p><p>alter table 表名 add column 新字段名 字段类型  约束条件  字段属性默认值注释    first</p></blockquote><ul><li>添加身高字段，字段类型–不超过3位数只有一位小数</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############语法说明##################</span></span><br><span class="line"><span class="comment">#alter table stu1  #修改stu1表</span></span><br><span class="line"><span class="comment">#add column height #添加height字段</span></span><br><span class="line"><span class="comment">#float(4,1)        #字段类型，限制用户写入，浮点数float(4,1)，代表整数长度为4，小数长度为1</span></span><br><span class="line"><span class="comment">#default null      #字段属性，辅助信息写入，不写身高信息，默认就为空字符串</span></span><br><span class="line"><span class="comment">#comment           #字段属性，辅助信息写入，添加注释信息</span></span><br><span class="line"><span class="comment">#first             #指定第一列添加字段</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改添加height字段</span></span><br><span class="line">mysql&gt; alter table stu1 add column height <span class="built_in">float</span>(4,1) default null comment <span class="string">&#x27;学生身高&#x27;</span> first;</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看表结构字段信息</span></span><br><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| height  | <span class="built_in">float</span>(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################插入数据验证####################</span></span><br><span class="line"><span class="comment">#id与intime字段无需写入数据，默认会添加相关信息。指定height,name,age,gender,address,phone字段，插入数据。</span></span><br><span class="line">mysql&gt; insert into stu1(height,name,age,gender,address,phone) values(175,<span class="string">&#x27;赵&#x27;</span>,23,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内蒙古&#x27;</span>,15598001352);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据表数据</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| height | <span class="built_in">id</span> | name | age | gender | address   | intime              | phone       |</span><br><span class="line">+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  175.0 |  1  | 赵   |  23 | 男     | 内蒙古    | 2024-06-02 11:15:32 | 15598001352 |</span><br></pre></td></tr></table></figure><ul><li>添加–学校字段，字段约束条件–不能为空,字段属性添加默认值–猿来教育，字段属性添加注释–学校</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####################添加字段查看#####################</span></span><br><span class="line">mysql&gt; alter table stu1 add column school char(20) not null default <span class="string">&#x27;猿来教育&#x27;</span> comment <span class="string">&#x27;学校&#x27;</span> first; </span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu1;                                                                                       </span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| school  | char(20)       | NO   |     | 猿来教育          |                |</span><br><span class="line">| height  | <span class="built_in">float</span>(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">9 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">########################插入数据查看###################</span></span><br><span class="line"><span class="comment">#只插入，限制不能为空的字段数据，可以为空的都跟随默认值</span></span><br><span class="line">mysql&gt; insert into stu1(name,gender,address,phone) value(<span class="string">&#x27;王&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内蒙古&#x27;</span>,11011011011);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#school默认值猿来教育，height默认值空，id值自增，age默认值0，initinme值now()</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+--------------+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| school       | height | <span class="built_in">id</span> | name | age | gender | address   | intime              | phone       |</span><br><span class="line">+--------------+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| 猿来教育     |   NULL |  1 | 王   |   0 | 男     | 内蒙古    | 2024-06-02 11:33:22 | 11011011011 |</span><br><span class="line">+--------------+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>指定某字段后添加字段</strong></p><blockquote><p>语法:</p><p>alter table 表名 add column 新字段名 字段类型  约束条件  字段属性默认值注释    after  目标字段名（插入目标后）      </p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| school  | varchar(20)       | NO   |     | 猿来教育          |                |</span><br><span class="line">| height  | float(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| id      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(&#x27;男&#x27;,&#x27;女&#x27;)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br></pre></td></tr></table></figure><ul><li>address字段前添加爱好字段，字段类型–字符串限制20长度,字段约束–不能为空，字段属性–注释爱好</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###################添加字段查看#######################</span></span><br><span class="line">mysql&gt; alter table stu1 add column hobby char(20) not null comment <span class="string">&#x27;爱好&#x27;</span> after gender;</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| school  | varchar(20)       | NO   |     | 猿来教育          |                |</span><br><span class="line">| height  | <span class="built_in">float</span>(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| hobby   | char(20)          | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">10 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">####################插入数据查看#####################</span></span><br><span class="line">mysql&gt; insert into stu1(name,gender,hobby,address,phone) value(<span class="string">&#x27;黄牛&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;打游戏&#x27;</span>,<span class="string">&#x27;澳门&#x27;</span>,10010010011);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>这里id自增有个bug，和删除数据表有关系，没有清空id记录</p><p><img src="/image-20240602115703778.png" alt="image-20240602115703778"></p><h3 id="3）删除字段"><a href="#3）删除字段" class="headerlink" title="3）删除字段"></a>3）删除字段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| school  | varchar(20)       | NO   |     | 猿来教育          |                |</span><br><span class="line">| height  | <span class="built_in">float</span>(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| hobby   | char(20)          | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">10 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><ul><li>删除字段school，height，hobby</li></ul><blockquote><p>语法:</p><p>alter table 表名 drop 字段名;</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############删除查看#################</span></span><br><span class="line">mysql&gt; alter table stu1 drop school;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table stu1 drop hobby;</span><br><span class="line">Query OK, 0 rows affected (0.08 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table stu1 drop height;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4）修改字段属性"><a href="#4）修改字段属性" class="headerlink" title="4）修改字段属性"></a>4）修改字段属性</h3><blockquote><p>:warning:注意：由于不同类型的数据在机器中的存储方式及长度并不相同，修改数据类型可能会影响数据表中已有的数据记录，因此，当数据表中已经有数据时，不要轻易修改数据类型</p></blockquote><ul><li><p>两种语法</p><ul><li>change: 对某个字段重新定义，字段名，和数据类型约束条件及属性</li><li>modity: 对某个字段重新定义，数据类型约束条件及属性</li></ul></li><li><p>两者区别：change比modity多一个功能，可以重新定义字段名</p></li></ul><p><strong>change关键字使用</strong></p><blockquote><p>语法：</p><p>alter table 表名 change 原字段名 新字段名 新数据类型 （更改字段名并设置新数据类型与属性）</p><p>alter table 表名 change 原字段名 原字段名 新数据类型 （对原字段设置新数据类型与属性）</p><p>alter table 表名 change 原字段名 新字段名 原数据类型 （只对字段名做修改）</p></blockquote><ul><li><strong>使用如下stu数据表进行练习</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################字段属性####################</span></span><br><span class="line">mysql&gt; desc stu;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##################建表sql###################</span></span><br><span class="line">mysql&gt; show create table stu;</span><br><span class="line">| Table | Create Table                                                                                 </span><br><span class="line">| stu   | CREATE TABLE `stu` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">  `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">  `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">  `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4                            |</span><br><span class="line"></span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p>:one:<strong>更改字段名并对如下字段属性进行修改</strong></p><ul><li>name：字段名—name0，默认值—佚名 ， 数据类型—char（10），注释—不添加</li><li>age     ：字段名—age0， 约束—允许为空， 注释—不添加</li><li>gender  ：字段名—gender0,  默认值—男， 注释—不添加</li><li>新字段名后添加新字段属性即可</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########更改字段名及修改字段属性###########</span></span><br><span class="line">mysql&gt; alter table stu change name name0 char(15) not null default <span class="string">&#x27;佚名&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; alter table stu change age age0 tinyint(3) not null;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; alter table stu change gender gender0 enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) not null default <span class="string">&#x27;男&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><p>:two:<strong>对原字段属性进行修改</strong></p><ul><li>address ：约束—允许为空</li><li>保持字段名不变即可，后方添加新的字段属性</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########只修改字段属性###########</span></span><br><span class="line">mysql&gt; alter table stu change address address varchar(255) null default <span class="string">&#x27;内蒙古&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><p><strong>:three:只修改字段名</strong></p><ul><li>phone：字段名—phone0</li><li>只修改字段名，在新字段名后方，添加原字段的全部属性即可。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########只修改字段名###########</span></span><br><span class="line">mysql&gt; alter table stu change phone phone0 char(11) not null;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><p>:four:<strong>查看新数据表结构插入数据验证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新数据表字段及属性</span></span><br><span class="line">mysql&gt; desc stu;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name0   | char(15)          | NO   |     | 佚名              |                |</span><br><span class="line">| age0    | tinyint(3)        | NO   |     | NULL              |                |</span><br><span class="line">| gender0 | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | 男                |                |</span><br><span class="line">| address | varchar(255)      | YES  |     | 内蒙古           |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone0  | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#插入数据</span></span><br><span class="line">mysql&gt; insert into  student.stu(age0,phone0) value(18,15598001352);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu;</span><br><span class="line">+----+--------+------+---------+---------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name0  | age0 | gender0 | address | intime              | phone0      |</span><br><span class="line">+----+--------+------+---------+---------+---------------------+-------------+</span><br><span class="line">|  1 | 佚名   |   18 | 男      | 内蒙古   | 2024-06-02 16:09:18 | 15598001352 |</span><br><span class="line">+----+--------+------+---------+---------+---------------------+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>modify关键字使用</strong></p><blockquote><p>语法：</p><p>alter table 表名 modify 原字段名 新数据类型</p><p>motify只对字段修改属性，并不修改字段名</p></blockquote><ul><li>对如下stu数据表中address字段，约束条件yes null&#x3D;&#x3D;&#x3D;改为no null ， 并设置注释信息&#x3D;&#x3D;&#x3D;地址</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table stu;</span><br><span class="line">CREATE TABLE `stu` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name0` char(15) NOT NULL DEFAULT <span class="string">&#x27;佚名&#x27;</span>,</span><br><span class="line">  `age0` tinyint(3) NOT NULL,</span><br><span class="line">  `gender0` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL DEFAULT <span class="string">&#x27;男&#x27;</span>,</span><br><span class="line">  `address` varchar(255) DEFAULT <span class="string">&#x27;内蒙古&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone0` char(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4            |</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name0   | char(15)          | NO   |     | 佚名              |                |</span><br><span class="line">| age0    | tinyint(3)        | NO   |     | NULL              |                |</span><br><span class="line">| gender0 | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | 男                |                |</span><br><span class="line">| address | varchar(255)      | YES  |     | 内蒙古              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone0  | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><ul><li>进行修改adress字段属性，注意modify也是重新定义新属性，不仅是单独修改某个属性，所以在修改时添加上原有属性</li><li>下面有个测试的bug，一个字段为允许为空时，且下方有数据时，无法修改为不允许为空。解决方法，给该字段下添加数据，方可设置。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改address，允许为空约束，修改为不允许为空</span></span><br><span class="line">mysql&gt; alter table student.stu modify address varchar(255) not null default <span class="string">&#x27;内蒙古&#x27;</span> comment <span class="string">&#x27;地址&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据表结构</span></span><br><span class="line">mysql&gt; desc stu;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name0   | char(15)          | NO   |     | 佚名              |                |</span><br><span class="line">| age0    | tinyint(3)        | NO   |     | NULL              |                |</span><br><span class="line">| gender0 | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | 男                |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | 内蒙古            |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone0  | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5）修改表其它属性"><a href="#5）修改表其它属性" class="headerlink" title="5）修改表其它属性"></a>5）修改表其它属性</h3><p><strong>修改表名</strong></p><blockquote><p>语法：</p><p>alter table 旧表名 rename to 新表名</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改表名</span></span><br><span class="line">mysql&gt; alter table stu1 rename stu;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#数据还存在</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu;</span><br><span class="line">+----+--------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name   | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+--------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  3 | 王     |   0 | 男     | 内蒙古    | 2024-06-02 11:33:22 | 11011011011 |</span><br><span class="line">|  4 | 黄牛   |   0 | 女     | 澳门      | 2024-06-02 11:56:03 | 10010010011 |</span><br><span class="line">+----+--------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>修改数据库引擎</strong></p><blockquote><p>语法:</p><p>alter table 表名 engine&#x3D;新引擎</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############创建数据表############</span></span><br><span class="line">create table t1(<span class="built_in">id</span> int) engine=MYISAM;</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                            |</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############修改查看###############</span></span><br><span class="line">mysql&gt; alter table t1 engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                            |</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>修改字符编码</strong></p><blockquote><p>语法：</p><p>alter table 表名 charset&#x3D;新字符编码</p></blockquote><ul><li><p>如下修改有缺点，对一个已有数据的数据表来说，修改了字符编码后，只能对以后的新数据按照新字符编码存储数据</p><p>以前的数据还是之前的字符编码数据</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table t1 charset=utf8;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                           |</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8|</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>还有一种方法可以执行之前的数据表数据也修改为新字符编码的格式</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">·锁表逻辑导出数据（例如：mysqldump）</span><br><span class="line">·重新创建数据空表（设置目标字符集）</span><br><span class="line">·导入备份数据信息</span><br><span class="line">-- 严谨的方法，可以影响之后存储的数据，也会修改之前存储的数据</span><br><span class="line">-- 字符集转换是可以的，但是必须保证修改后的字符集是修改前的严格超集（包含）</span><br></pre></td></tr></table></figure><h1 id="6-数据库DML操作语言"><a href="#6-数据库DML操作语言" class="headerlink" title="6.数据库DML操作语言"></a>6.数据库DML操作语言</h1><ul><li><p>开发熟练，运维熟悉即可</p></li><li><p>主要对数据表内数据进行操作，增删改查</p></li></ul><h2 id="6-1-数据表增加数据"><a href="#6-1-数据表增加数据" class="headerlink" title="6.1 数据表增加数据"></a>6.1 数据表增加数据</h2><blockquote><p>insert语句语法：</p><p>insert into 数据表名(指定字段) value(字段所对应的数据); #按照指定字段对应位置插入数据</p><blockquote><p>:warning:注意中文数据需要用引号嵌套，否则无法识别</p></blockquote></blockquote><ul><li>对如下数据表进行操作</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><h3 id="1）完整字段插入"><a href="#1）完整字段插入" class="headerlink" title="1）完整字段插入"></a>1）完整字段插入</h3><ul><li>指定完整字段名，插入每个字段对应的数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into  student.stu1(<span class="built_in">id</span>,name,age,gender,address,intime,phone) value(1,<span class="string">&#x27;赵东兴&#x27;</span>,23,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内 蒙古&#x27;</span>,now(),15598001352);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="2）部分字段插入"><a href="#2）部分字段插入" class="headerlink" title="2）部分字段插入"></a>2）部分字段插入</h3><ul><li>指定部分字段名，插入对应字段的数据</li><li>某些字段，可通过属性设置辅助用户输入信息，不写入数据会跟随字段属性，写入设置好的默认值</li><li>如上方测试的stu1数据表中，id字段为主键自增，age设置了默认值属性，intime也设置了默认值时间变量，不对其字段插入数据也可以</li><li>但是某些不允许为空，无默认值属性的字段，必须在字段下写入对应数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into stu1(name,gender,address,phone) value(<span class="string">&#x27;王雨萌&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;未知&#x27;</span>,<span class="string">&#x27;未知&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 未知      | 2024-06-02 18:34:23 | 未知        |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3）不指定字段插入"><a href="#3）不指定字段插入" class="headerlink" title="3）不指定字段插入"></a>3）不指定字段插入</h3><ul><li>不指定字段名，也可以插入数据</li><li>但是必须得按照每个字段的顺序，写入完整的对应每个字段的数据。即使某字段有默认值也不行，必须写入全部字段对应的数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into stu1 value(3,<span class="string">&#x27;张岩&#x27;</span>,23,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;未知&#x27;</span>,now(),<span class="string">&#x27;未知&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 未知      | 2024-06-02 18:34:23 | 未知        |</span><br><span class="line">|  3 | 张岩      |  23 | 女     | 未知      | 2024-06-02 18:42:13 | 未知        |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4）插入多条数据"><a href="#4）插入多条数据" class="headerlink" title="4）插入多条数据"></a>4）插入多条数据</h3><ul><li>可以根据指定字段，value定义多个值，通过逗号分割，插入多条数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into stu1(name,gender,address,phone) value(<span class="string">&#x27;王彤&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;内蒙古&#x27;</span>,<span class="string">&#x27;未知&#x27;</span>),(<span class="string">&#x27;师璐&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;. Query OK, 3 rows affected (0.01 sec).&#x27;</span>);</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 未知      | 2024-06-02 18:34:23 | 未知        |</span><br><span class="line">|  3 | 张岩      |  23 | 女     | 未知      | 2024-06-02 18:42:13 | 未知        |</span><br><span class="line">|  4 | 王彤      |   0 | 女     | 内蒙古    | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">|  5 | 师璐      |   0 | 女     | 经纬      | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">|  6 | 曹可文    |   0 | 女     | 四中      | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="5）shell插入多条数据"><a href="#5）shell插入多条数据" class="headerlink" title="5）shell插入多条数据"></a>5）<em>shell</em>插入多条数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1.以班级学员信息，继续添加，试试SQL语句的insert</span><br><span class="line"></span><br><span class="line">2. 有没有快捷的办法，批量插入数据？（提示，基于学生名字插入数据即可）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提示修改phone设置默认值</span></span><br><span class="line">mysql -uroot -pwww.yuchaoit.cn -e <span class="string">&quot;alter table yuchao_linux.new_students modify phone char(11) not null default &#x27;0&#x27; &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试代码</span></span><br><span class="line"><span class="keyword">for</span> stu <span class="keyword">in</span> 叶金阳 杨松麟 陈亮亮 李文杰 郑佳强 罗兴林  冯靖涵 张少辉 程志伟 代杰豪 高若恒 张天鼎 张鑫 刘永飞 黄彦 王仁刚 赵阳阳 王秉诚 于超</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    mysql -uroot -p1 -e <span class="string">&quot;insert into student.stu1(name) values(&#x27;<span class="variable">$stu</span>&#x27;);&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql -uroot -p1 -e <span class="string">&quot;select * from yuchao_linux.new_students &quot;</span></span><br><span class="line">mysql -uroot -p1 -e <span class="string">&quot;desc yuchao_linux.new_students&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空表数据</span></span><br><span class="line">mysql -uroot -p1 -e <span class="string">&quot;truncate table yuchao_linux.new_students  &quot;</span></span><br></pre></td></tr></table></figure><ul><li>导入多个文件，提取信息，数据表插入数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">name_arr=(`<span class="built_in">cat</span> /root/stu_name.txt`)</span><br><span class="line">add_arr=(`<span class="built_in">cat</span> /root/address.txt`)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印俩数组变量看看</span></span><br><span class="line"><span class="comment"># 提取数组所有的值</span></span><br><span class="line"><span class="comment">#echo $&#123;name_arr[@]&#125;</span></span><br><span class="line"><span class="comment">#echo $&#123;add_arr[@]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取数组所有的索引</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#echo $&#123;!name_arr[@]&#125;</span></span><br><span class="line"><span class="comment">#echo $&#123;!add_arr[@]&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环处理数组，基于同一个索引，对应上每一行的数据，拼接出了具体的SQL</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;!stu_name[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> <span class="comment"># mysql -uroot -p1 -e &quot;insert into student.stu(name,address) values(&#x27;$&#123;stu_name[$i]&#125;&#x27;,&#x27;$&#123;add_name[$i]&#125;&#x27;)&quot;</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment"># 打印你想拼接的SQL，看看，对不对，然后再插入表</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># stu_name=([0]=&quot;松林&quot; [1]=&quot;超哥&quot; [2]=&quot;亮亮&quot; [3]=&quot;文杰&quot; [4]=&quot;加强&quot; [5]=&quot;新林&quot;)</span></span><br><span class="line"><span class="comment"># add_name=([0]=&quot;山西老板&quot; [1]=&quot;江苏小弟&quot; [2]=&quot;湖南大佬&quot; [3]=&quot;云南昆明&quot; [4]=&quot;山西大同&quot; [5]=&quot;贵州老板&quot;)</span></span><br></pre></td></tr></table></figure><h2 id="6-2-数据表修改数据"><a href="#6-2-数据表修改数据" class="headerlink" title="6.2 数据表修改数据"></a>6.2 数据表修改数据</h2><h3 id="1）帮助信息查看"><a href="#1）帮助信息查看" class="headerlink" title="1）帮助信息查看"></a>1）帮助信息查看</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ? Data Manipulation</span><br><span class="line">You asked for help about help category: &quot;Data Manipulation&quot;</span><br><span class="line">For more information, type &#x27;help &lt;item&gt;&#x27;, where &lt;item&gt; is one of the following</span><br><span class="line">topics:</span><br><span class="line">   CALL</span><br><span class="line">   DELETE</span><br><span class="line">   DO</span><br><span class="line">   DUAL</span><br><span class="line">   HANDLER</span><br><span class="line">   INSERT</span><br><span class="line">   INSERT DELAYED</span><br><span class="line">   INSERT SELECT</span><br><span class="line">   JOIN</span><br><span class="line">   LOAD DATA</span><br><span class="line">   LOAD XML</span><br><span class="line">   REPLACE</span><br><span class="line">   SELECT</span><br><span class="line">   UNION</span><br><span class="line">   UPDATE</span><br></pre></td></tr></table></figure><h3 id="2）语法说明"><a href="#2）语法说明" class="headerlink" title="2）语法说明"></a>2）语法说明</h3><p>update语句语法:</p><p>update table 表名  字段名&#x3D;新数据数据   where(指定条件对哪行修改)  id&#x3D;？ name&#x3D;？；</p><blockquote><blockquote><p>:warning:重要的事说三遍，切记update修改数据时，一定要加where匹配修改哪行， 否则会修改字段下的全部数据，误修改就凉凉了</p></blockquote></blockquote><h3 id="3）修改更新数据"><a href="#3）修改更新数据" class="headerlink" title="3）修改更新数据"></a>3）修改更新数据</h3><ul><li>针对如下数据表进行操作</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 未知      | 2024-06-02 18:34:23 | 未知        |</span><br><span class="line">|  3 | 张岩      |  23 | 女     | 未知      | 2024-06-02 18:42:13 | 未知        |</span><br><span class="line">|  4 | 王彤      |   0 | 女     | 内蒙古    | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">|  5 | 师璐      |   0 | 女     | 经纬      | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">|  6 | 曹可文    |   0 | 女     | 四中      | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>修改234记录的address字段数据，修改2-6记录的phone字段数据全部改为&#x3D;&#x3D;&#x3D;喜欢过</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#####################修改adress字段########################</span></span><br><span class="line">mysql&gt; update stu1 <span class="built_in">set</span> address=<span class="string">&#x27;大专&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=2 and  name=<span class="string">&#x27;王雨萌&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; update stu1 <span class="built_in">set</span> address=<span class="string">&#x27;经纬&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=3 and name=<span class="string">&#x27;张岩&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; update stu1 <span class="built_in">set</span> address=<span class="string">&#x27;一小&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=4;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">###################修改phone字段######################</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 2 3 4 5 6</span><br><span class="line"><span class="keyword">do</span>  mysql -uroot -p1 -e <span class="string">&quot;update student.stu1 set phone=&#x27;喜欢过祝你们幸福安康&#x27; where id=<span class="variable">$i</span>;&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###################查看数据表数据###############</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+--------------------------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone                          |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+--------------------------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352                    |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 大专      | 2024-06-02 18:34:23 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  3 | 张岩      |  23 | 女     | 经纬      | 2024-06-02 18:42:13 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  4 | 王彤      |   0 | 女     | 一小      | 2024-06-02 18:51:24 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  5 | 师璐      |   0 | 女     | 经纬      | 2024-06-02 18:51:24 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  6 | 曹可文    |   0 | 女     | 四中      | 2024-06-02 18:51:24 | 喜欢过祝你们幸福安康           |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+--------------------------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>修改1号记录的name，age，gender，address多个字段数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update stu1 <span class="built_in">set</span> name=<span class="string">&#x27;三年之后成功的男人&#x27;</span>,age=26,address=<span class="string">&#x27;北京&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br><span class="line">| <span class="built_in">id</span> | name                        | age | gender | address | intime              | phone                          |</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br><span class="line">|  1 | 三年之后成功的男人          |  26 | 男     | 北京    | 2024-06-02 18:26:12 | 15598001352    </span><br></pre></td></tr></table></figure><h2 id="6-3-数据表删除数据"><a href="#6-3-数据表删除数据" class="headerlink" title="6.3 数据表删除数据"></a>6.3 数据表删除数据</h2><h3 id="1）按行删除"><a href="#1）按行删除" class="headerlink" title="1）按行删除"></a>1）按行删除</h3><ul><li><p>delete语句，删除数据时会按行删除</p></li><li><p>只删除某行使用where匹配具体的行进行删除</p></li><li><p>删除全部数据，不指定where关键字即可，代表删除全部行数据，删除全部数据，也是基于一行一行进行删除</p></li><li><p>并且delete语句知识删除数据，不会删除主键自增记录，这里是个坑</p></li></ul><blockquote><p>delete语句语法：</p><p>delete  from  表名  where 匹配某行</p></blockquote><ul><li><strong>删除某行数</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#####################按行删除且查看检查####################</span></span><br><span class="line">mysql&gt; delete from stu1 <span class="built_in">where</span> <span class="built_in">id</span>=6;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from stu1 <span class="built_in">where</span> <span class="built_in">id</span>=5;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from stu1 <span class="built_in">where</span> <span class="built_in">id</span>=4;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br><span class="line">| <span class="built_in">id</span> | name                        | age | gender | address | intime              | phone                          |</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br><span class="line">|  1 | 三年之后成功的男人          |  26 | 男     | 北京    | 2024-06-02 18:26:12 | 15598001352                    |</span><br><span class="line">|  2 | 王雨萌                      |   0 | 女     | 大专    | 2024-06-02 18:34:23 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  3 | 张岩                        |  23 | 女     | 经纬    | 2024-06-02 18:42:13 | 喜欢过祝你们幸福安康           |</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br></pre></td></tr></table></figure><ul><li><strong>删除所有行数据</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from stu1;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="2）全面删除"><a href="#2）全面删除" class="headerlink" title="2）全面删除"></a>2）全面删除</h3><ul><li>truncate删除原理是，直接删除数据表，在基于该数据表创建一个新的数据表</li></ul><blockquote><p>语法：</p><p>truncate  表名</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######对该表删除#######</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+------+-----+--------+---------+---------------------+-------+</span><br><span class="line">| <span class="built_in">id</span> | name | age | gender | address | intime              | phone |</span><br><span class="line">+----+------+-----+--------+---------+---------------------+-------+</span><br><span class="line">|  1 | 赵   |  23 | 男     | 包头    | 2024-06-02 20:10:04 | 888   |</span><br><span class="line">+----+------+-----+--------+---------+---------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######删除检查######</span></span><br><span class="line">mysql&gt;<span class="built_in">truncate</span> stu1;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3）伪删除"><a href="#3）伪删除" class="headerlink" title="3）伪删除"></a>3）伪删除</h3><p>为了有效防止delete误删除数据，可以人为限定SQL的删除逻辑</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">添加表字段，删除状态字段，0 表示被删除，1表示数据存在</span><br><span class="line"></span><br><span class="line">可以用tinyint类型，省磁盘，从 0 到 255 的整型数据。存储大小为 1 字节</span><br></pre></td></tr></table></figure><p>增加状态列</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">alter table new_students add column field_status TINYINT not null default 1 comment &#x27;字段删除状态，0 表示被删除，1表示数据存在&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; desc new_students;</span><br><span class="line">+--------------+-------------------------------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field        | Type                                      | Null | Key | Default           | Extra          |</span><br><span class="line">+--------------+-------------------------------------------+------+-----+-------------------+----------------+</span><br><span class="line">| id           | int(11)                                   | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name         | varchar(64)                               | NO   |     | NULL              |                |</span><br><span class="line">| age          | tinyint(3)                                | NO   |     | 0                 |                |</span><br><span class="line">| gender       | enum(&#x27;男&#x27;,&#x27;女&#x27;)                           | NO   |     | NULL              |                |</span><br><span class="line">| height       | float(4,1)                                | YES  |     | NULL              |                |</span><br><span class="line">| address      | enum(&#x27;北京&#x27;,&#x27;深圳&#x27;,&#x27;云南&#x27;,&#x27;江苏&#x27;)         | NO   |     | NULL              |                |</span><br><span class="line">| intime       | datetime                                  | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone        | char(11)                                  | NO   |     | 0                 |                |</span><br><span class="line">| hobby        | char(20)                                  | NO   |     | 学习              |                |</span><br><span class="line">| field_status | tinyint(4)                                | NO   |     | 1                 |                |</span><br><span class="line">+--------------+-------------------------------------------+------+-----+-------------------+----------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>想删除数据用update，代替delete，取消delete的执行权限即可</p><p>兄弟，再次啰嗦，用update，务必小心，加上where条件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">删除于超数据</span><br><span class="line">mysql&gt; update new_students set field_status=0 where name=&#x27;于超&#x27;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure><p>后续的查询语句，修改为如下即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查询所有有效用户的数据</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from new_students where field_status=1;</span><br></pre></td></tr></table></figure><h1 id="7-数据库DQL查询语言"><a href="#7-数据库DQL查询语言" class="headerlink" title="7.数据库DQL查询语言"></a>7.数据库DQL查询语言</h1><h2 id="测试数据准备"><a href="#测试数据准备" class="headerlink" title="测试数据准备"></a>测试数据准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#mysql -uroot -p1 &lt; all_world.sql </span><br><span class="line"></span><br><span class="line">mysql&gt; show tables from world;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_world |</span><br><span class="line">+-----------------+</span><br><span class="line">| city            |</span><br><span class="line">| country         |</span><br><span class="line">| countrylanguage |</span><br><span class="line">+-----------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>内有大量的世界人口数据信息，基于city表进行练习</li><li>city表中，name字段：城市名，countrycode字段：国家代号，district字段：省份名，population字段：人口数量</li></ul><p><img src="/image-20240602204120564.png" alt="image-20240602204120564"></p><h2 id="7-2-内置变量查询"><a href="#7-2-内置变量查询" class="headerlink" title="7.2 内置变量查询"></a>7.2 内置变量查询</h2><h3 id="1）查询内置变量信息"><a href="#1）查询内置变量信息" class="headerlink" title="1）查询内置变量信息"></a>1）查询内置变量信息</h3><blockquote><p>语法：</p><p>show variables like %变量名%     #模糊查找，百分号匹配任意字符</p><p>用途：可根据关键字进行模糊查找，查看数据库内置变量名，与对应的变量值</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看全部变量</span></span><br><span class="line">mysql&gt; show variables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#模糊查找有关变量名及对应的变量值</span></span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%port%&#x27;</span>;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| innodb_support_xa        | ON    |</span><br><span class="line">| large_files_support      | ON    |</span><br><span class="line">| port                     | 3306  |</span><br><span class="line">| report_host              |       |</span><br><span class="line">| report_password          |       |</span><br><span class="line">| report_port              | 3306  |</span><br><span class="line">| report_user              |       |</span><br><span class="line">| require_secure_transport | OFF   |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><h3 id="2）精确查询变量值"><a href="#2）精确查询变量值" class="headerlink" title="2）精确查询变量值"></a>2）精确查询变量值</h3><blockquote><p>语法:</p><p>show variables like ‘%变量名%’   <code>#如果不知道变量名叫什么，可通过show模糊查找变量</code></p><p>select @@内置变量名               <code>#show查找确认后，再通过select精确提取变量值</code></p><blockquote><p>用途：查出数据库精确查找内置变量的值，运维通过变量观察数据库中各种数据</p></blockquote></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">1.查看数据库端口</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@port;</span><br><span class="line">+--------+</span><br><span class="line">| @@port |</span><br><span class="line">+--------+</span><br><span class="line">|   3306 |</span><br><span class="line">+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.查看数据库实例<span class="built_in">id</span>，主从复制使用</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@server_id;</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           0 |</span><br><span class="line">+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.查看数据库实例数据目录</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@datadir;</span><br><span class="line">+-----------------+</span><br><span class="line">| @@datadir       |</span><br><span class="line">+-----------------+</span><br><span class="line">| /app/data/3306/ |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.查看数据库程序安装目录</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@basedir;</span><br><span class="line">+-------------------------------------------------+</span><br><span class="line">| @@basedir                                       |</span><br><span class="line">+-------------------------------------------------+</span><br><span class="line">| /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/ |</span><br><span class="line">+-------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.查看数据库实例soket文件位置</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@socket;</span><br><span class="line">+-----------------+</span><br><span class="line">| @@socket        |</span><br><span class="line">+-----------------+</span><br><span class="line">| /tmp/mysql.sock |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6.查看数据库主键自增步长</span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;auto%&#x27;</span>;</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@auto_increment_increment;</span><br><span class="line">+----------------------------+</span><br><span class="line">| @@auto_increment_increment |</span><br><span class="line">+----------------------------+</span><br><span class="line">|                          1 |</span><br><span class="line">+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3）修改内置变量值"><a href="#3）修改内置变量值" class="headerlink" title="3）修改内置变量值"></a>3）修改内置变量值</h3><blockquote><p>语法： set  变量名&#x3D;变量值  </p><p>set @@变量名&#x3D;变量值</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############修改自增变量############</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span>  auto_increment_increment=2;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@auto_increment_increment;</span><br><span class="line">+----------------------------+</span><br><span class="line">| @@auto_increment_increment |</span><br><span class="line">+----------------------------+</span><br><span class="line">|                          2 |</span><br><span class="line">+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############再修改回来################</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span>  @@auto_increment_increment=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@auto_increment_increment;</span><br><span class="line">+----------------------------+</span><br><span class="line">| @@auto_increment_increment |</span><br><span class="line">+----------------------------+</span><br><span class="line">|                          1 |</span><br><span class="line">+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="7-3-内置函数查询"><a href="#7-3-内置函数查询" class="headerlink" title="7.3 内置函数查询"></a>7.3 内置函数查询</h2><p>函数举例：将查询的字母全部转变成小写和大写：select lower(username), upper(username) from 表名;</p><p>函数的功能：封装了特定的一些功能，我们直接拿过来使用，可以实现对应的功能。</p><p>函数的作用：为了实现select查询的效率和能力。</p><p>类似于shell脚本的函数，将某些代码封装到函数中，当调用函数时，就会执行这些代码，可以拿到代码执行的结果。</p><h3 id="1）函数使用帮助"><a href="#1）函数使用帮助" class="headerlink" title="1）函数使用帮助"></a>1）函数使用帮助</h3><blockquote><p>语法：</p><p>？   函数名   （精确查找某函数使用帮助信息）</p></blockquote><ul><li><strong>查看函数分类</strong></li></ul><p>可查看数据库支持哪些分类的函数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> ? functions;</span><br><span class="line">You asked <span class="keyword">for</span> help about help category: &quot;Functions&quot;</span><br><span class="line"><span class="keyword">For</span> more information, type <span class="string">&#x27;help &lt;item&gt;&#x27;</span>, <span class="keyword">where</span> <span class="operator">&lt;</span>item<span class="operator">&gt;</span> <span class="keyword">is</span> <span class="keyword">one</span> <span class="keyword">of</span> the following</span><br><span class="line">categories:</span><br><span class="line">   Bit Functions位函数</span><br><span class="line">   Comparison operators比较运算符</span><br><span class="line">   Control flow functions控制流函数</span><br><span class="line">   <span class="type">Date</span> <span class="keyword">and</span> <span class="type">Time</span> Functions日期和时间函数</span><br><span class="line">   Encryption Functions加密函数</span><br><span class="line">   Information Functions信息函数</span><br><span class="line">   Logical operators逻辑运算符</span><br><span class="line">   Miscellaneous Functions 其他函数</span><br><span class="line">   <span class="type">Numeric</span> Functions数字函数</span><br><span class="line">   String Functions字符串函数</span><br></pre></td></tr></table></figure><ul><li><strong>查看时间分类函数</strong></li></ul><p>查看具体分类函数内，支持内些相关函数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> ? <span class="type">Date</span> <span class="keyword">and</span> <span class="type">Time</span> Functions</span><br><span class="line">You asked <span class="keyword">for</span> help about help category: &quot;Date and Time Functions&quot;</span><br><span class="line"><span class="keyword">For</span> more information, type <span class="string">&#x27;help &lt;item&gt;&#x27;</span>, <span class="keyword">where</span> <span class="operator">&lt;</span>item<span class="operator">&gt;</span> <span class="keyword">is</span> <span class="keyword">one</span> <span class="keyword">of</span> the following</span><br><span class="line">topics:</span><br></pre></td></tr></table></figure><p><img src="/image-20240603164817674.png" alt="image-20240603164817674"></p><ul><li><strong>查看某函数帮助信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> ? now</span><br></pre></td></tr></table></figure><p><img src="/image-20240603165322643.png" alt="image-20240603165322643"></p><h3 id="2）常用函数使用"><a href="#2）常用函数使用" class="headerlink" title="2）常用函数使用"></a>2）常用函数使用</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#查看当前连接数据库的用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>();</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>()         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> root<span class="variable">@localhost</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前所在的库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> database();</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> database() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前的时间</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> now();</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> now()               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">06</span>:<span class="number">38</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="7-4-show查询"><a href="#7-4-show查询" class="headerlink" title="7.4 show查询"></a>7.4 <em>show</em>查询</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span>语句有许多形式，提供关于服务器的数据库、表、列或状态信息的信息。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span>语法格式：</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> 关键字 <span class="keyword">LIKE</span> <span class="string">&#x27;pattern&#x27;</span></span><br><span class="line"></span><br><span class="line">如果对于一个给定的说明语句的语法包括像<span class="string">&#x27;模式&#x27;</span>，<span class="string">&#x27;模式&#x27;</span>是一个字符串，可以包含“<span class="operator">%</span>”和“_“通配符。该模式是有用的限制语句输出匹配的值。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES – 显示当前所有数据库的名称</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> TABLES <span class="keyword">FROM</span> db_name – 显示数据库中的所有表</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> ENGINES – 显示MySQL当前支持哪些存储引擎和默认存储引擎</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> – 显示MySQL当前支持哪些字符集</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">COLLATION</span> – 显示MySQL支持字符集的排序规则</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> <span class="operator">|</span> MASTER – 显示二进制文件以及文件大小（需要开启二进制日志记录功能</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> BINLOG EVENTS – 显示二进制文件的执行过程</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> COLUMNS – 显示表的列信息（等同于<span class="keyword">DESC</span>，需要先创建表）</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> DATABASES – 显示已经创建的库，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> – 显示已经创建的表，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> FUNTCION  – 显示已经创建的函数，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> – 显示已经创建的存储过程，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> <span class="operator">-</span> 显示已经创建的触发器，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> – 显示已经创建的视图，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> EVENTS – 显示已经创建的事件，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> ENGINE – 显示存储引擎的详细信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> WARNINGS – 显示最后一个执行语句所产生的警告信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> ERRORS – 显示最后一个执行语句所产生的错误信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> EVENTS – 显示事件信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS – 显示一个用户所拥有的权限</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST – 显示系统中正在运行的所有进程，普通用户只能查看自己的进行信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> PRIVILEGES – 显示MySQL所支持的所有权限，及权限可操作的对象</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> PLUGINS – 显示MySQL插件信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS – 显示Master当前正在使用的二进制信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS – 显示表属性信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> INDEX – 显示表索引信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> STATUS – 显示存储过程信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FUNCTION</span> STATUS – 显示存储函数信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> TRIGGERS – 显示触发器信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> PROFILE <span class="keyword">and</span> <span class="keyword">SHOW</span> PROFILES – 显示执行语句的资源使用情况</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE HOSTS – 显示Master主机上已注册的复制主机列表</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS – 显示Slave主机状态信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="operator">|</span> SESSION STATUS – 显示MySQL状态变量信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="operator">|</span> SESSION VARIABLES – 显示MySQL系统变量信息</span><br></pre></td></tr></table></figure><ul><li>查看数据库所有库</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| employees          |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| stu                |</span><br><span class="line">| sys                |</span><br><span class="line">| world              |</span><br><span class="line">+--------------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>查看数据库创建库与数据表的sql语句</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database stu;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Create</span> Database                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> stu      <span class="operator">|</span> <span class="keyword">CREATE</span> DATABASE `stu` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 */</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">  `name` <span class="type">char</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>查看数据库内置变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;%port%&#x27;</span>;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| innodb_support_xa        | ON    |</span><br><span class="line">| large_files_support      | ON    |</span><br><span class="line">| port                     | 3306  |</span><br><span class="line">| report_host              |       |</span><br><span class="line">| report_password          |       |</span><br><span class="line">| report_port              | 3306  |</span><br><span class="line">| report_user              |       |</span><br><span class="line">| require_secure_transport | OFF   |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><ul><li>查看当前数据库实例使用的引擎</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%storage%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> default_storage_engine           <span class="operator">|</span> InnoDB <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> default_tmp_storage_engine       <span class="operator">|</span> InnoDB <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> disabled_storage_engines         <span class="operator">|</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> internal_tmp_disk_storage_engine <span class="operator">|</span> InnoDB <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+--------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="子查询语句顺序"><a href="#子查询语句顺序" class="headerlink" title="子查询语句顺序"></a>子查询语句顺序</h2><p><img src="/1659601941650.png" alt="1659601941650"></p><h2 id="7-4-select查询"><a href="#7-4-select查询" class="headerlink" title="7.4 select查询"></a>7.4 <em>select</em>查询</h2><ul><li>查看数据表数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>  stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> 赵   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>查看数据库内置函数值</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#查看当前所在的库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> database();</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> database() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#查看当前的时间</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> now();</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> now()               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">06</span>:<span class="number">38</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>查看数据库内置变量值</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> @@port;</span><br><span class="line">+--------+</span><br><span class="line">| @@port |</span><br><span class="line">+--------+</span><br><span class="line">|   3306 |</span><br><span class="line">+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="7-6-where子查询"><a href="#7-6-where子查询" class="headerlink" title="7.6 where子查询"></a>7.6 <em>where</em>子查询</h2><p>where子句可以限定一些条件，根据用户需求，在数据表中查找对应的数据</p><blockquote><p>语法：</p><p>select     字段名     from    表   where  字段&#x3D;关键字</p><p>select     字段名     from    表   where  字段  like  %关键字%</p><p>select     字段名     from    表   where  字段&#x3D;关键字 or 字段&#x3D;关键字</p><p>select     字段名     from    表   where  字段&#x3D;关键字 and 字段&#x3D;关键字</p></blockquote><blockquote><p>对world库中city数据表进行查询练习</p></blockquote><ul><li><strong>查询所有城市名，以及人口数</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select name,Population from world.city;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603183119185.png" alt="image-20240603183119185"></p><ul><li><strong>查询city表里，所有中国的城市信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240603183749556.png" alt="image-20240603183749556"></p><ul><li><strong>查询人口数小于500人城市信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> Population<span class="operator">&lt;</span><span class="number">500</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240603183903216.png" alt="image-20240603183903216"></p><ul><li><strong>查询中国,人口数超过500w的所有城市信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> Population <span class="operator">&gt;</span><span class="number">5000000</span> <span class="keyword">and</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240603184203794.png" alt="image-20240603184203794"></p><ul><li><strong>查询中国或者美国的城市信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#语法<span class="number">1</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span> <span class="keyword">or</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span></span><br><span class="line"></span><br><span class="line">#语法<span class="number">2</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode <span class="keyword">in</span> (<span class="string">&#x27;chn&#x27;</span>,<span class="string">&#x27;usa&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="/image-20240603184820655.png" alt="image-20240603184820655"></p><ul><li><strong>查询人口在200万到500万之间的城市所有信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#语法一</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> Population <span class="operator">&gt;</span><span class="number">2000000</span> <span class="keyword">and</span> Population <span class="operator">&lt;</span><span class="number">5000000</span></span><br><span class="line"></span><br><span class="line">#语法二</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> Population <span class="keyword">BETWEEN</span> <span class="number">2000000</span> <span class="keyword">and</span> <span class="number">5000000</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240603185046476.png" alt="image-20240603185046476"></p><ul><li><strong>查询中国或者美国，人口数大于500万的城市</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode <span class="keyword">IN</span> (<span class="string">&#x27;CHN&#x27;</span>,<span class="string">&#x27;USA&#x27;</span>) <span class="keyword">and</span> Population <span class="operator">&gt;</span> <span class="number">5000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> (CountryCode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span> <span class="keyword">or</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>) <span class="keyword">and</span> Population <span class="operator">&gt;</span><span class="number">5000000</span>;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603185949966.png" alt="image-20240603185949966"></p><ul><li><strong>查询城市名以qing开头的城市</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>  city  <span class="keyword">where</span>  name <span class="keyword">like</span>  <span class="string">&#x27;qing%&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603185709223.png" alt="image-20240603185709223"></p><ul><li><strong>查询淮安市的人口数量</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span>  name <span class="keyword">like</span> <span class="string">&#x27;huai%&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603191339550.png" alt="image-20240603191339550"></p><h2 id="7-7-Group-by聚合函数"><a href="#7-7-Group-by聚合函数" class="headerlink" title="7.7 Group_by聚合函数"></a>7.7 <em>Group_by</em>聚合函数</h2><p>聚合函数,是一类在数据库中用于对多个行进行计算并返回单个结果的函数。</p><p>它们能够对数据进行汇总、统计和计算，常用于提取有关数据集的摘要信息。</p><p>聚合函数在SQL查询中广泛应用，包括统计总数、平均值、最大值、最小V值等。</p><p>这些函数通常与 GROUP BY 子句一起使用，以便根据一个或多个列对数据进行分组，并将聚合函数应用于每个分组。</p><p><strong>常用聚合函</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">count() 统计数量 </span><br><span class="line">sum() 求和</span><br><span class="line">avg() 平均数</span><br><span class="line">max() 最大值</span><br><span class="line">min() 最小值</span><br><span class="line">group_concat() GROUP_CONCAT函数返回一个字符串结果，该结果由分组中的值连接组合而成。</span><br></pre></td></tr></table></figure><p><strong>group by 分组功能原理</strong></p><p>1.按分组条件进行排序，</p><p>2.进行分组列的去重，</p><p>3.聚合函数将其他列的结果聚合</p><p><strong>group by聚合函数练习题</strong></p><ul><li>统计city表有多少行数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">4079</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>统计中国城市的个数</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(name) <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">363</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>统计中国总人口数</li><li>where子句，先匹配countrycode字段为CHN的所有数据，再使用sum函数对population人口字段进行计算</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">sum</span>(Population) <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">sum</span>(Population) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">175953614</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>统计每个国家的城市个数</li><li>使用croup by分组子句，进行对countrycode字段国家分组，相同字段为一组，count最后对每组的name字段统计数量</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> CountryCode,<span class="built_in">count</span>(name) <span class="keyword">from</span> city <span class="keyword">GROUP</span> <span class="keyword">BY</span> CountryCode;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> CountryCode <span class="operator">|</span> <span class="built_in">count</span>(name) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> ABW         <span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AFG         <span class="operator">|</span>           <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AGO         <span class="operator">|</span>           <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AIA         <span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ALB         <span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">AND</span>         <span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ANT         <span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">ARE</span>         <span class="operator">|</span>           <span class="number">5</span> <span class="operator">|</span></span><br></pre></td></tr></table></figure><ul><li>统计USA美国的城市总数</li><li>指定字段匹配数据时，也可以不区分大小写，和排序规则有关，当前排序规则不区分大小写，都可以显示出来</li><li>as关键字，可以在数据输出显示时，上方字段名可临时通过as定义的字符显示</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> count(name) as <span class="string">&#x27;城市总数&#x27;</span>  from city <span class="built_in">where</span> countrycode=<span class="string">&#x27;usa&#x27;</span>;</span><br><span class="line">+--------------+</span><br><span class="line">| 城市总数     |</span><br><span class="line">+--------------+</span><br><span class="line">|          274 |</span><br><span class="line">+--------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>统计每个国家的总人口数</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span>  countrycode <span class="keyword">as</span> <span class="string">&#x27;国家&#x27;</span>,<span class="built_in">sum</span>(Population) <span class="keyword">as</span> <span class="string">&#x27;人口数量&#x27;</span> <span class="keyword">from</span> city <span class="keyword">group</span> <span class="keyword">by</span> countrycode;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 国家   <span class="operator">|</span> 人口数量     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="operator">|</span> ABW    <span class="operator">|</span>        <span class="number">29034</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AFG    <span class="operator">|</span>      <span class="number">2332100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AGO    <span class="operator">|</span>      <span class="number">2561600</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AIA    <span class="operator">|</span>         <span class="number">1556</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ALB    <span class="operator">|</span>       <span class="number">270000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">AND</span>    <span class="operator">|</span>        <span class="number">21189</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ANT    <span class="operator">|</span>         <span class="number">2345</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">ARE</span>    <span class="operator">|</span>      <span class="number">1728336</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ARG    <span class="operator">|</span>     <span class="number">19996563</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ARM    <span class="operator">|</span>      <span class="number">1633100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ASM    <span class="operator">|</span>         <span class="number">7523</span> <span class="operator">|</span></span><br><span class="line">#######太长省略##########</span><br></pre></td></tr></table></figure><ul><li>统计中国每个省的城市个数和城市名</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> district as <span class="string">&#x27;省&#x27;</span>,count(name) as <span class="string">&#x27;城市数&#x27;</span>,group_concat(name) as <span class="string">&#x27;城市名&#x27;</span> from city <span class="built_in">where</span> countrycode=<span class="string">&#x27;chn&#x27;</span> group by district;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603210948095.png" alt="image-20240603210948095">                                                      </p><h2 id="7-8-having聚合判断"><a href="#7-8-having聚合判断" class="headerlink" title="7.8 having聚合判断"></a>7.8 <em>having</em>聚合判断</h2><p>当group by 排序分组后，如果还要做条件判断提取数据，使用having子句用于对分组的过滤</p><p><strong>Having 练习题</strong></p><ul><li>统计每个国家的总人口数，只显示人口超过1亿的国家信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> countrycode as <span class="string">&#x27;国家&#x27;</span>,<span class="built_in">sum</span>(population) as <span class="string">&#x27;人口数&#x27;</span> from city group by countrycode having  <span class="built_in">sum</span>(population) &gt;100000000;</span><br><span class="line">+--------+-----------+</span><br><span class="line">| 国家   | 人口数    |</span><br><span class="line">+--------+-----------+</span><br><span class="line">| CHN    | 175953614 |</span><br><span class="line">| IND    | 123298526 |</span><br><span class="line">+--------+-----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><h2 id="7-9-Order-by聚合排序"><a href="#7-9-Order-by聚合排序" class="headerlink" title="7.9 Order_by聚合排序"></a>7.9 <em>Order_by</em>聚合排序</h2><ul><li>查询所有城市信息，按人口数字段排序输出，按数字顺序正序从小到大输出</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人口顺序&#x27;</span> <span class="keyword">from</span> city <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 城市                  <span class="operator">|</span> 人口顺序     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> Adamstown             <span class="operator">|</span>           <span class="number">42</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> West Island           <span class="operator">|</span>          <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Fakaofo               <span class="operator">|</span>          <span class="number">300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CittÃ  del Vaticano   <span class="operator">|</span>          <span class="number">455</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Bantam                <span class="operator">|</span>          <span class="number">503</span> <span class="operator">|</span></span><br><span class="line">########太长后面省略###########</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#逆序输出</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人口顺序&#x27;</span> <span class="keyword">from</span> city <span class="keyword">order</span> <span class="keyword">by</span> population <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><ul><li>查询中国所有城市信息，且按照人口数从大到小排序输出</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人口逆序&#x27;</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;chn&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> population <span class="keyword">desc</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 城市      <span class="operator">|</span> 人口逆序     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------------+</span></span><br><span class="line"><span class="operator">|</span> Shanghai  <span class="operator">|</span>      <span class="number">9696300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Peking    <span class="operator">|</span>      <span class="number">7472000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Chongqing <span class="operator">|</span>      <span class="number">6351600</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Tianjin   <span class="operator">|</span>      <span class="number">5286800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Wuhan     <span class="operator">|</span>      <span class="number">4344600</span> <span class="operator">|</span></span><br><span class="line">########太长后面省略###########</span><br></pre></td></tr></table></figure><ul><li>查看每个国家的总人口数，总人口超过5000w的信息,并按总人口数从大到小排序输出</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> countrycode <span class="keyword">as</span> <span class="string">&#x27;国家&#x27;</span>,<span class="built_in">sum</span>(population) <span class="keyword">as</span> <span class="string">&#x27;人口逆序&#x27;</span><span class="keyword">from</span> city <span class="keyword">group</span> <span class="keyword">by</span> countrycode <span class="keyword">having</span> <span class="built_in">sum</span>(population) <span class="operator">&gt;</span><span class="number">50000000</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">sum</span>(population) <span class="keyword">desc</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 国家   <span class="operator">|</span> 人口逆序     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="operator">|</span> CHN    <span class="operator">|</span>    <span class="number">175953614</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> IND    <span class="operator">|</span>    <span class="number">123298526</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BRA    <span class="operator">|</span>     <span class="number">85876862</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> USA    <span class="operator">|</span>     <span class="number">78625774</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> JPN    <span class="operator">|</span>     <span class="number">77965107</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> RUS    <span class="operator">|</span>     <span class="number">69150700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MEX    <span class="operator">|</span>     <span class="number">59752521</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="8-0-limit分页查询"><a href="#8-0-limit分页查询" class="headerlink" title="8.0 limit分页查询"></a>8.0 <em>limit</em>分页查询</h2><ul><li>查询中国所有城市信息，以人口数从大到小排序，只显示前十名。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人口前十&#x27;</span> <span class="keyword">from</span> city  <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;chn&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span>  population <span class="keyword">desc</span>  limit <span class="number">10</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 城市               <span class="operator">|</span> 人口前十     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> Shanghai           <span class="operator">|</span>      <span class="number">9696300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Peking             <span class="operator">|</span>      <span class="number">7472000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Chongqing          <span class="operator">|</span>      <span class="number">6351600</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Tianjin            <span class="operator">|</span>      <span class="number">5286800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Wuhan              <span class="operator">|</span>      <span class="number">4344600</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Harbin             <span class="operator">|</span>      <span class="number">4289800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Shenyang           <span class="operator">|</span>      <span class="number">4265200</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Kanton [Guangzhou] <span class="operator">|</span>      <span class="number">4256300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Chengdu            <span class="operator">|</span>      <span class="number">3361500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Nanking [Nanjing]  <span class="operator">|</span>      <span class="number">2870300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><ul><li>查询中国所有的城市信息，并按照人口数从大到小排序输出，只显示6-10名</li></ul><blockquote><p>语法</p><p>limit  起点,条数</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人数&#x27;</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;chn&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> population <span class="keyword">desc</span> limit <span class="number">5</span>,<span class="number">5</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> 城市               <span class="operator">|</span> 人数    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> Harbin             <span class="operator">|</span> <span class="number">4289800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Shenyang           <span class="operator">|</span> <span class="number">4265200</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Kanton [Guangzhou] <span class="operator">|</span> <span class="number">4256300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Chengdu            <span class="operator">|</span> <span class="number">3361500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Nanking [Nanjing]  <span class="operator">|</span> <span class="number">2870300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#写法<span class="number">2</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> Population <span class="keyword">desc</span> limit <span class="number">5</span> <span class="keyword">offset</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-数据库服务SQL语句分类&quot;&gt;&lt;a href=&quot;#1-数据库服务SQL语句分类&quot; class=&quot;headerlink&quot; title=&quot;1.数据库服务SQL语句分类&quot;&gt;&lt;/a&gt;1.数据库服务SQL语句分类&lt;/h1&gt;&lt;h2 id=&quot;1-1-SQL语句是什么&quot;&gt;&lt;a </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-安装部署</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</id>
    <published>2024-08-20T01:22:05.000Z</published>
    <updated>2024-08-20T01:26:20.067Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-数据库二进制安装"><a href="#1-数据库二进制安装" class="headerlink" title="1.数据库二进制安装"></a>1.数据库二进制安装</h1><ul><li><p>官网-二进制包安装地址</p><p> <a href="https://downloads.mysql.com/archives/community/">https://downloads.mysql.com/archives/community/</a></p></li></ul><h2 id="1-1-基础概念"><a href="#1-1-基础概念" class="headerlink" title="1.1 基础概念"></a>1.1 基础概念</h2><p><strong>什么是数据库初始化</strong></p><p>数据库初始化是指在使用MySQL数据库之前，对数据库系统进行的一系列准备工作，包括创建数据库实例、设置必要的参数和配置，以及准备数据库环境等操作。</p><p><strong>初始化的作用和意义</strong></p><p>数据库初始化的主要作用是确保数据库系统的正常运行，提供一个可用的数据库环境给用户进行数据存储、管理和操作。通过初始化，可以设定数据库系统的基本配置，保证数据安全性和完整性，提高系统性能，以及方便后续的数据库管理和维护工作。</p><p><strong>为什么需要初始化MySQL数据库</strong></p><p>在使用MySQL数据库之前，进行数据库初始化是非常重要的。通过初始化可以确保数据库系统的稳定性和安全性，防范数据丢失和系统故障的风险；同时，初始化还可以根据实际需求定制数据库配置，优化数据库性能，提升数据处理效率，确保数据库系统能够满足业务需求。</p><h2 id="1-2-安装部署"><a href="#1-2-安装部署" class="headerlink" title="1.2 安装部署"></a>1.2 安装部署</h2><ul><li>安装方式: mysql5.7二进制包安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">ls</span></span><br><span class="line">mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建mysql软件存放目录和mysql数据存放目录</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">mkdir</span> -p /app/&#123;tools,data&#125;</span><br><span class="line">[root@db-51 ~]#tree /app</span><br><span class="line">/app</span><br><span class="line">├── data</span><br><span class="line">└── tools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#解压放入指定目录</span></span><br><span class="line">[root@db-51 ~]#tar -xf mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz -C /app/tools/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建软链接，用于方便升级版本</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">ln</span> -s /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/ /app/tools/mysql</span><br><span class="line">[root@db-51 ~]#ll /app/tools/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx. 1 root root  47 May 20 11:26 mysql -&gt; /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x. 9 root root 129 May 20 11:25 mysql-5.7.20-linux-glibc2.12-x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql管理命令加入PATH环境变量，可绝对路径执行命令</span></span><br><span class="line"><span class="comment">##查看管理命令</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">ls</span> /app/tools/mysql/bin/</span><br><span class="line"><span class="comment">##加入全局环境变量</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">tail</span> -1 /etc/profile</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/app/tools/mysql/bin</span><br><span class="line"><span class="comment">##加载</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment">##检查</span></span><br><span class="line">[root@db-51 ~]#mysql -V</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.20, <span class="keyword">for</span> linux-glibc2.12 (x86_64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查是否有mariadb依赖，如果有删除，否则安装mysql时会报错</span></span><br><span class="line">[root@db-51 ~]#rpm -qa|grep mariadb</span><br><span class="line">mariadb-libs-5.5.68-1.el7.x86_64</span><br><span class="line">[root@db-51 ~]#yum remove mariadb-libs-5.5.68-1.el7.x86_64 -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装mysql特有依赖</span></span><br><span class="line">yum install libaio-devel -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建mysql运行用户，降低权限</span></span><br><span class="line">[root@db-51 ~]#useradd -s /sbin/nologin -M mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建mysql数据存放目录，并且授予权限</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">mkdir</span> /app/data/3306</span><br><span class="line">[root@db-51 ~]#<span class="built_in">chown</span> -R mysql.mysql /app/data</span><br><span class="line">[root@db-51 ~]#<span class="built_in">chown</span> -R mysql.mysql /app/tools/mysql*</span><br><span class="line"><span class="comment">##检查</span></span><br><span class="line">[root@db-51 ~]#ll -d /app/data/3306/ /app/tools/mysql*</span><br><span class="line">drwxr-xr-x. 2 mysql mysql   6 May 20 11:49 /app/data/3306/</span><br><span class="line">lrwxrwxrwx. 1 mysql mysql  47 May 20 11:26 /app/tools/mysql -&gt; /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x. 9 mysql mysql 129 May 20 11:25 /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化mysql，多次初始化同样配置信息会报错</span></span><br><span class="line">[root@db-51 ~]#mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3306/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件修改</span></span><br><span class="line"><span class="comment">##mysql基于如下配置进行启动</span></span><br><span class="line"><span class="comment">##[mysqld]：mysql服务端配置  soket: 本地进程套接字文件，可基于该socket文件进行连接服务端</span></span><br><span class="line"><span class="comment">##[mysql ]：mysql客户端配置  soket: 客户端指定服务端的soket文件位置，可连接到服务端</span></span><br><span class="line"><span class="comment">##basedir：mysql安装目录  datadir: mysql初始化后的数据存放目录</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/my.cnf &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#拷贝mysql管理脚本到/etc/init.d/下</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cp</span> /app/tools/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">[root@db-51 ~]#ll /etc/init.d/mysqld -d</span><br><span class="line">-rwxr-xr-x. 1 root root 10576 May 20 12:13 /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#systemctl启动mysql,记得加上enable这一步</span></span><br><span class="line"><span class="comment">#否则系统无法识别外部程序脚本，systemctl命令无法使用</span></span><br><span class="line">[root@db-51 ~]#systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line">[root@db-51 ~]#systemctl start mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@db-51 ~]#ss -tunlp|grep 3306</span><br><span class="line">tcp    LISTEN     0      70     [::]:33060              [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">30117</span>,fd=<span class="number">20</span>))</span><br><span class="line">tcp    LISTEN     0      128    [::]:3306               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">30117</span>,fd=<span class="number">22</span>))</span><br><span class="line">[root@db-51 ~]#ps -ef|grep mysql</span><br><span class="line">root      78817      1  1 12:26 ?        00:00:00 /bin/sh /app/tools/mysql/bin/mysqld_safe --datadir=/app/data/3306 --pid-file=/app/data/3306/db-51.pid</span><br><span class="line">mysql     78973  78817  4 12:26 ?        00:00:00 /app/tools/mysql/bin/mysqld --basedir=/app/tools/mysql --datadir=/app/data/3306 --plugin-dir=/app/tools/mysql/lib/plugin --user=mysql --log-error=db-51.err --pid-file=/app/data/3306/db-51.pid --socket=/tmp/mysql.sock --port=3306</span><br><span class="line">root      79019  72950  0 12:26 pts/0    00:00:00 grep --color=auto mysql</span><br></pre></td></tr></table></figure><h1 id="3-数据库多实例部署"><a href="#3-数据库多实例部署" class="headerlink" title="3.数据库多实例部署"></a>3.数据库多实例部署</h1><h2 id="3-1-基础概念"><a href="#3-1-基础概念" class="headerlink" title="3.1 基础概念"></a>3.1 基础概念</h2><p><strong>什么是多实例及多实例的优缺点</strong></p><p>就是在一台服务器上开启多个不同的服务端口，比如3306、3307、3308…，运行多个不同的MySQL服务。</p><p>这些MySQL多实例共用一套安装程序（<code>命令</code>），使用不同的配置文件、启动程序、数据文件；多实例对硬件资源的获取通过配置文件来指定。</p><p><strong>优点</strong></p><p>可以有效利用服务器资源。当单个服务器资源充足时，可以充分利用剩余资源；节约资源。需要独立的数据库服务，并且需要主从同步的情况下。</p><p><strong>缺点</strong></p><p>当某一个实例消耗大量的CPU、内存时会影响其它实例提供的服务质量。</p><p><strong>多实例应用场景</strong></p><p>需要数据库单独提供服务，并且需要进行主从同步，服务并发量不大，服务器的资源很充足。</p><h2 id="3-2-多实例部署"><a href="#3-2-多实例部署" class="headerlink" title="3.2 多实例部署"></a>3.2 多实例部署</h2><p><strong>目标:</strong> </p><p>基于本地mysql应用，生成3306.3307.3308三个实例</p><p>并且通过shell脚本启停管理3307与3308实例</p><h3 id="1）生成3307与3308实例"><a href="#1）生成3307与3308实例" class="headerlink" title="1）生成3307与3308实例"></a>1）生成3307与3308实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建多实例3307与3308数据目录</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">mkdir</span> /app/data/&#123;3307,3308&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#授予数据目录权限</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">chown</span> -R mysql.mysql /app/data/</span><br><span class="line">[root@db-51 ~]#ll -d /app/data/3307 /app/data/3308</span><br><span class="line">drwxr-xr-x. 2 mysql mysql 6 May 20 13:32 /app/data/3307</span><br><span class="line">drwxr-xr-x. 2 mysql mysql 6 May 20 13:32 /app/data/3308</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化3307与3308多实例</span></span><br><span class="line"><span class="comment">##--user:  指定初始时生成的数据文件所属权限</span></span><br><span class="line"><span class="comment">##--basedir：mysql应用程序安装目录</span></span><br><span class="line"><span class="comment">##--daradir：mysql管理的数据库目录</span></span><br><span class="line">[root@db-51 ~]#mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3307</span><br><span class="line">[root@db-51 ~]#mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3308</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建多实例3307与3308配置文件,修改socket与数据目录即可</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/mysql_3307.cnf  /etc/mysql_3308.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">port=3307</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/opt/mysql/</span><br><span class="line">datadir=/app/data/3307/</span><br><span class="line">socket=/app/data/3307/mysql.sock</span><br><span class="line">log_error=/app/data/3307/mysql.log</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">port=3308</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/opt/mysql/</span><br><span class="line">datadir=/app/data/3308/</span><br><span class="line">socket=/app/data/3308/mysql.sock</span><br><span class="line">log_error=/app/data/3308/mysql.log</span><br></pre></td></tr></table></figure><h3 id="2）多实例管理脚本"><a href="#2）多实例管理脚本" class="headerlink" title="2）多实例管理脚本"></a>2）多实例管理脚本</h3><blockquote><p>通过shell脚本管理多实例mysql的启动停止</p><p>每个实例修改脚本中定义变量端口即可使用</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[root@db-51 ~]#cat /app/data/3307/3307.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#实例端口</span></span><br><span class="line">port=<span class="string">&quot;3307&quot;</span></span><br><span class="line"><span class="comment">#实例运行用户</span></span><br><span class="line">mysql_user=<span class="string">&quot;mysql&quot;</span></span><br><span class="line"><span class="comment">#mysql应用目录</span></span><br><span class="line">Cmdpath=<span class="string">&quot;/app/tools/mysql/bin&quot;</span></span><br><span class="line"><span class="comment">#实例生成的sock存放文件</span></span><br><span class="line">mysql_sock=<span class="string">&quot;/app/data/<span class="variable">$&#123;port&#125;</span>/mysql_<span class="variable">$&#123;port&#125;</span>.sock&quot;</span></span><br><span class="line"><span class="comment">#实例生成的进程pid存放文件</span></span><br><span class="line">mysqld_pid_file_path=<span class="string">&quot;/app/data/<span class="variable">$&#123;port&#125;</span>/mysql_<span class="variable">$&#123;port&#125;</span>.pid&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动函数</span></span><br><span class="line"><span class="function"><span class="title">start</span></span>()&#123;</span><br><span class="line"><span class="comment">#判断实例的sock文件是否存在，不存在说明未启动，则进行启动</span></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$mysql_sock</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;Starting MySQL...\n&quot;</span></span><br><span class="line">    <span class="comment">#调用mysql自带脚本参数，调用上方变量，进行启动实例</span></span><br><span class="line">    /bin/sh <span class="variable">$&#123;Cmdpath&#125;</span>/mysqld_safe --defaults-file=/etc/mysql_<span class="variable">$&#123;port&#125;</span>.cnf --pid-file=<span class="variable">$mysqld_pid_file_path</span> 2&gt;&amp;1 &gt; /dev/null &amp;</span><br><span class="line">    <span class="built_in">sleep</span> 3</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">#如果存在就显示正在运行中</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;MySQL is running...\n&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭函数</span></span><br><span class="line"><span class="function"><span class="title">stop</span></span>()&#123;</span><br><span class="line"><span class="comment">#判断实例socket文件是否存在，不存在，显示关闭</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$mysql_sock</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;MySQL is stopped...\n&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="comment">#存在则查看实例的进程pid，kill结束进程</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;Stoping MySQL...\n&quot;</span></span><br><span class="line">        mysqld_pid=`<span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$mysqld_pid_file_path</span>&quot;</span>`</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">kill</span> -0 <span class="variable">$mysqld_pid</span> 2&gt;/dev/null)</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">kill</span> <span class="variable">$mysqld_pid</span></span><br><span class="line">        <span class="built_in">sleep</span> 2</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启函数</span></span><br><span class="line"><span class="comment">#调用关闭函数，再调用重启函数</span></span><br><span class="line"><span class="function"><span class="title">restart</span></span>()&#123;</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;Restarting MySQL...\n&quot;</span></span><br><span class="line">    stop</span><br><span class="line">    <span class="built_in">sleep</span> 2</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#位置变量传递参数判断，传递数字，进行调用函数</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    start</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">    stop</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">    restart</span><br><span class="line">;;</span><br><span class="line"><span class="comment">#都没匹配到打印错误提示</span></span><br><span class="line">*)</span><br><span class="line">   <span class="built_in">printf</span> <span class="string">&quot;Usage: /data/<span class="variable">$&#123;port&#125;</span>/mysql&#123;start|stop|restart&#125;\n&quot;</span></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><h3 id="3）启动多实例"><a href="#3）启动多实例" class="headerlink" title="3）启动多实例"></a>3）启动多实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#bash /app/data/3307/3307.sh start</span><br><span class="line">Starting MySQL...</span><br><span class="line">[root@db-51 ~]#bash /app/data/3308/3308.sh start</span><br><span class="line">Starting MySQL...</span><br></pre></td></tr></table></figure><h3 id="4）检查多实例"><a href="#4）检查多实例" class="headerlink" title="4）检查多实例"></a>4）检查多实例</h3><ul><li>检查端口进程</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#端口</span></span><br><span class="line">[root@db-51 ~]#ss -tunlp|egrep <span class="string">&#x27;3308|3307&#x27;</span></span><br><span class="line">tcp    LISTEN     0      80     [::]:3307               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">84469</span>,fd=<span class="number">28</span>))</span><br><span class="line">tcp    LISTEN     0      80     [::]:3308               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">84658</span>,fd=<span class="number">28</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#进程</span></span><br><span class="line">ps -ef|grep mysql</span><br></pre></td></tr></table></figure><ul><li>检查多实例pid文件与socket文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#两个实例的pid文件</span></span><br><span class="line">[root@db-51 ~]#find /app/data/ -<span class="built_in">type</span> f -name *.pid</span><br><span class="line">/app/data/3307/mysql_3307.pid</span><br><span class="line">/app/data/3308/mysql_3308.pid</span><br><span class="line">[root@db-51 ~]#find /app/data/ -<span class="built_in">type</span> f -name *.pid|xargs <span class="built_in">cat</span></span><br><span class="line">84469</span><br><span class="line">84658</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#两个实例的socket文件</span></span><br><span class="line"><span class="comment">##socket文件无法查看内容，是基于进程启动后生成的虚拟内容文件，只用于连接</span></span><br><span class="line">[root@db-51 ~]#find /app/data/  -name  mysql.sock</span><br><span class="line">/app/data/3307/mysql.sock</span><br><span class="line">/app/data/3308/mysql.sock</span><br><span class="line">[root@db-51 ~]#find /app/data/  -name  mysql.sock|xargs <span class="built_in">ls</span>  -dl</span><br><span class="line">srwxrwxrwx. 1 mysql mysql 0 May 20 14:25 /app/data/3307/mysql.sock</span><br><span class="line">srwxrwxrwx. 1 mysql mysql 0 May 20 14:25 /app/data/3308/mysql.sock</span><br></pre></td></tr></table></figure><h3 id="5）修改多实例密码"><a href="#5）修改多实例密码" class="headerlink" title="5）修改多实例密码"></a>5）修改多实例密码</h3><ul><li>基于socket文件修改</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改两个实例连接密码，明文修改密码会出现警告信息</span></span><br><span class="line">[root@db-51 ~]#mysqladmin -S /app/data/3307/mysql.sock password 1</span><br><span class="line">mysqladmin: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server <span class="keyword">in</span> plain text, use ssl connection to ensure password safety.</span><br><span class="line"></span><br><span class="line">[root@db-51 ~]#mysqladmin -S /app/data/3308/mysql.sock password 1</span><br><span class="line">mysqladmin: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server <span class="keyword">in</span> plain text, use ssl connection to ensure password safety.</span><br></pre></td></tr></table></figure><ul><li>检查登录，sql语句查看，连接服务端的端口</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#3307实例</span></span><br><span class="line">[root@db-51 ~]#mysql -S /app/data/3307/mysql.sock  -uroot -p1 -e <span class="string">&quot;show global variables like &#x27;port&#x27;&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| port          | 3307  |</span><br><span class="line">+---------------+-------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#3308实例</span></span><br><span class="line">[root@db-51 ~]#mysql -S /app/data/3308/mysql.sock  -uroot -p1 -e <span class="string">&quot;show global variables like &#x27;port&#x27;&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| port          | 3308  |</span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure><h1 id="4-脚本启动关闭方式"><a href="#4-脚本启动关闭方式" class="headerlink" title="4.脚本启动关闭方式"></a>4.脚本启动关闭方式</h1><h2 id="4-1-启动"><a href="#4-1-启动" class="headerlink" title="4.1 启动"></a>4.1 启动</h2><ul><li>mysql管理脚本放入&#x2F;etc&#x2F;init.d，启动形式，本质上都是调用mysql自带管理脚本</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#systemctl启动</span></span><br><span class="line">systemctl  start/stop/restart   mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment">#service启动</span></span><br><span class="line">service mysqld start</span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql自带管理脚本启动</span></span><br><span class="line">/etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db-51 /www.yuchaoit.cn]#<span class="built_in">ls</span> /opt/mysql/bin/mysqld* -l</span><br><span class="line">-rwxr-xr-x 1 mysql mysql 260613605 Sep 27  2019 /opt/mysql/bin/mysqld</span><br><span class="line">-rwxr-xr-x 1 mysql mysql 213374233 Sep 27  2019 /opt/mysql/bin/mysqld-debug</span><br><span class="line">-rwxr-xr-x 1 mysql mysql     27139 Sep 27  2019 /opt/mysql/bin/mysqld_multi</span><br><span class="line">-rwxr-xr-x 1 mysql mysql     28494 Sep 27  2019 /opt/mysql/bin/mysqld_safe</span><br><span class="line">-rwxr-xr-x 1 mysql mysql  15712383 Sep 27  2019 /opt/mysql/bin/mysqldump</span><br><span class="line">-rwxr-xr-x 1 mysql mysql      7865 Sep 27  2019 /opt/mysql/bin/mysqldumpslow</span><br></pre></td></tr></table></figure><h2 id="4-2-关闭"><a href="#4-2-关闭" class="headerlink" title="4.2 关闭"></a>4.2 关闭</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#脚本关闭</span></span><br><span class="line">systemctl stop mysqld</span><br><span class="line">service mysqld stop</span><br><span class="line">/etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#命令关闭</span></span><br><span class="line">mysql -uroot -pwww.yuchaoit.cn -e <span class="string">&#x27;shutdown;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#不建议用这个操作，除非特殊情况</span></span><br><span class="line"><span class="built_in">kill</span> pid</span><br><span class="line">pkill mysqld</span><br><span class="line">killall mysqld</span><br><span class="line"><span class="built_in">kill</span> -9 pid <span class="comment"># 极端情况下，才能用这个</span></span><br></pre></td></tr></table></figure><h1 id="5-程序进程运行原理"><a href="#5-程序进程运行原理" class="headerlink" title="5.程序进程运行原理"></a>5.程序进程运行原理</h1><ul><li><p><strong>mysqld_safe作用</strong></p><ul><li>mysql官方启动脚本，是以执行mysqld_safe为入口，其实mysqld_safe也是个shell脚本，调用了myqsld命令启动服务</li><li>mysqld_safe脚本设置运行环境，如以守护进程运行</li><li>mysqld_safe检测mysqld运行状态</li><li>mysqld_safe检测mysqld进程运行信息，写入 mysql实例目录下的hostname.err文件</li><li>以及mysqld_safe会读取my.cnf配置文件的[mysqld],[mysqld_safe]等配置</li></ul></li><li><p><strong>mysqld作用</strong></p><ul><li>mysqld是mysql的核心程序，用于管理mysql的数据库文件，以及用户执行的SQL请求</li><li>mysqld读取my.cnf中 [mysqld]配置</li></ul></li></ul><blockquote><p>不建议使用mysqld启动，以官方用法为主，用mysqld_safe调用mysqld启动mysql</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-数据库二进制安装&quot;&gt;&lt;a href=&quot;#1-数据库二进制安装&quot; class=&quot;headerlink&quot; title=&quot;1.数据库二进制安装&quot;&gt;&lt;/a&gt;1.数据库二进制安装&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;官网-二进制包安装地址&lt;/p&gt;
&lt;p&gt; &lt;a href=&quot;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>hexo博客搭建</title>
    <link href="http://example.com/2024/08/20/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/"/>
    <id>http://example.com/2024/08/20/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/</id>
    <published>2024-08-20T01:17:16.000Z</published>
    <updated>2024-08-20T01:18:39.917Z</updated>
    
    <content type="html"><![CDATA[<h1 id="hexo博客搭建"><a href="#hexo博客搭建" class="headerlink" title="hexo博客搭建"></a>hexo博客搭建</h1><h2 id="1-本地搭建博客"><a href="#1-本地搭建博客" class="headerlink" title="1.本地搭建博客"></a>1.本地搭建博客</h2><ul><li>先安装好nodejs运行环境与git工具</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1.检查安装</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ node -v</span><br><span class="line">v20.16.0</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ npm -v</span><br><span class="line">10.8.1</span><br><span class="line"></span><br><span class="line">2.安装hexo框架</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ npm install -g hexo-cli </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.初始化系统生成文件夹</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo init blog</span><br><span class="line">INFO  Cloning hexo-starter https://github.com/hexojs/hexo-starter.git</span><br><span class="line">INFO  Install dependencies</span><br><span class="line">INFO  Start blogging with Hexo!</span><br><span class="line"></span><br><span class="line">4.启动博客系统</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo s</span><br><span class="line">INFO  Validating config</span><br><span class="line">INFO  Start processing</span><br><span class="line">INFO  Hexo is running at http://localhost:4000/ . Press Ctrl+C to stop.</span><br><span class="line">INFO  Good <span class="built_in">bye</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240819220046162.png" alt="image-20240819220046162"></p><h2 id="2-修改博客主题"><a href="#2-修改博客主题" class="headerlink" title="2.修改博客主题"></a>2.修改博客主题</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1.主题地址</span><br><span class="line">https://hexo.io/themes/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.下载到本地</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ git <span class="built_in">clone</span> -b master https://github.com/jerryc127/hexo-theme-butterfly.git themes/butterfly</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">ls</span> themes/</span><br><span class="line">butterfly/</span><br><span class="line"></span><br><span class="line">3.修改配置文件改theme为新主题名</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ vim _config.yml</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ grep butt _config.yml</span><br><span class="line">theme: butterfly</span><br><span class="line"></span><br><span class="line">4.清除旧资源</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo cl</span><br><span class="line"></span><br><span class="line">5.加载新资源</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo g</span><br><span class="line"></span><br><span class="line">6.安装插件及渲染器否则无法使用主题打开博客页面</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$  npm install --save hexo-renderer-jade hexo-generator-feed hexo-generator-sitemap hexo-browsersync hexo-generator-archive</span><br><span class="line"></span><br><span class="line">7.启动博客系统</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo s</span><br></pre></td></tr></table></figure><p><img src="/image-20240819221832813.png" alt="image-20240819221832813"></p><h2 id="3-优化博客主题"><a href="#3-优化博客主题" class="headerlink" title="3.优化博客主题"></a>3.优化博客主题</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">1.拷贝主题目录配置文件到主目录中</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog/themes/butterfly (master)</span><br><span class="line">$ <span class="built_in">cp</span> _config.yml ../../</span><br><span class="line">.github/               _config.yml            package-lock.json      scaffolds/</span><br><span class="line">.gitignore             db.json                package.json           <span class="built_in">source</span>/</span><br><span class="line">_config.landscape.yml  node_modules/          public/                themes/</span><br><span class="line"></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog/themes/butterfly (master)</span><br><span class="line">$ <span class="built_in">cp</span> _config.yml ../../_config.butterfly.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.修改主题背景</span><br><span class="line"><span class="comment">#下载图片</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">ls</span> ~/Desktop/</span><br><span class="line">18092716058766.jpg </span><br><span class="line"><span class="comment">#传入主题目录中</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">mv</span> ~/Desktop/18092716058766.jpg themes/butterfly/source/img/linux.jpg</span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">ls</span> themes/butterfly/source/img/</span><br><span class="line">404.jpg  favicon.png  friend_404.gif  linux.jpg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.修改主题配置文件改背景图片路径</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ vim _config.butterfly.yml</span><br><span class="line"></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ grep <span class="string">&#x27;linux&#x27;</span> _config.butterfly.yml</span><br><span class="line">index_img: ./img/linux.jpg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.修改主题相关文字标题</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ vim _config.yml</span><br><span class="line"></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">head</span> _config.yml</span><br><span class="line"><span class="comment"># Hexo Configuration</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/configuration.html</span></span><br><span class="line"><span class="comment">## Source: https://github.com/hexojs/hexo/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Site</span></span><br><span class="line">title: linux笔记博客</span><br><span class="line">subtitle: <span class="string">&#x27;hexo博客&#x27;</span></span><br><span class="line">description: <span class="string">&#x27;个人技术笔记博客&#x27;</span></span><br><span class="line">keywords:</span><br><span class="line">author: 赵东兴</span><br></pre></td></tr></table></figure><p><img src="/image-20240819225316424.png" alt="image-20240819225316424"></p><h2 id="4-上传代码仓库"><a href="#4-上传代码仓库" class="headerlink" title="4.上传代码仓库"></a>4.上传代码仓库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1.修改主配置文件加上传输github仓库配置参数</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ vim _config.yml</span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">tail</span> _config.yml</span><br><span class="line">deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repo: https://github.com/zhao-1025/blog</span><br><span class="line">  branch: main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.安装连接github插件，否则无法通过上传数据到仓库</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ npm install hexo-deployer-git --save</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.上传博客系统到代码仓库github中</span><br><span class="line"><span class="comment">#上传时有很多坑，导致无法上传，注意梯子尽量关闭，走国内网络连接</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog (master)</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure><h2 id="6-一键部署公网"><a href="#6-一键部署公网" class="headerlink" title="6.一键部署公网"></a>6.一键部署公网</h2><ul><li>使用zeabur平台【<a href="https://dash.zeabur.com/%E3%80%91%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E4%BB%A3%E7%A0%81">https://dash.zeabur.com/】一键部署代码</a><ul><li>注册登录</li><li>连接github代码仓库进行授权</li><li>最终选择仓库代码一键部署服务，内部有免费域名提供使用</li></ul></li></ul><h2 id="7-公网访问验证"><a href="#7-公网访问验证" class="headerlink" title="7.公网访问验证"></a>7.公网访问验证</h2><p><a href="https://zhaodongxing.zeabur.app/">https://zhaodongxing.zeabur.app/</a></p><p>接下来就可以将typora笔记上传到hexo博客中了</p><p><img src="/image-20240820002553645.png" alt="image-20240820002553645"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;hexo博客搭建&quot;&gt;&lt;a href=&quot;#hexo博客搭建&quot; class=&quot;headerlink&quot; title=&quot;hexo博客搭建&quot;&gt;&lt;/a&gt;hexo博客搭建&lt;/h1&gt;&lt;h2 id=&quot;1-本地搭建博客&quot;&gt;&lt;a href=&quot;#1-本地搭建博客&quot; class=&quot;head</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-报错解决</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3/</id>
    <published>2024-08-20T00:56:06.000Z</published>
    <updated>2024-08-20T00:56:06.434Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-高可用性</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7/</id>
    <published>2024-08-20T00:55:47.000Z</published>
    <updated>2024-08-20T01:00:12.234Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、MHA高可用概述"><a href="#一、MHA高可用概述" class="headerlink" title="一、MHA高可用概述"></a>一、MHA高可用概述</h1><h2 id="1-什么是MHA"><a href="#1-什么是MHA" class="headerlink" title="1.什么是MHA"></a>1.什么是MHA</h2><p>MHA (Master High Availability Manager and tools for MySQL) 是一个用于MySQL数据库的高可用性解决方案。</p><p>它提供了自动故障检测、故障切换和故障恢复功能，以确保MySQL数据库集群的高可用性和可靠性。</p><p>MHA还可以监控主从复制状态、执行自动故障切换，并通知相关的应用程序或负载均衡器，以便数据库集群能够持续稳定地运行。</p><p>总的来说，MHA是一个强大的工具集，可帮助数据库管理员简化数据库集群的管理、提高业务连续性和可用性。</p><h2 id="2-MHA架构原理"><a href="#2-MHA架构原理" class="headerlink" title="2.MHA架构原理"></a>2.MHA架构原理</h2><ol><li>MHA由几个组件组成，包括mha4mysql-manager、mha4mysql-node和mha4mysql-kill等工具。其中，mha4mysql-manager是主要的管理器组件，负责监控数据库集群的状态、执行故障切换和恢复操作；mha4mysql-node用于监控数据库节点的状态，并发送状态更新给mha4mysql-manager；mha4mysql-kill用于终止问题节点上的MySQL进程。</li><li>MHA采用主从复制的架构，在数据库集群中主服务器负责处理写操作，从服务器则用于读取操作。MHA通过监控主从复制状态来确保数据库高可用性。</li><li>当主服务器出现故障或不可用时，mha4mysql-manager会自动检测到这种变化，并选择一个合适的从服务器升级为新的主服务器。它会确保新的主服务器能够接收写操作，并更新应用程序连接信息，以便应用程序能够正确地连接到新的主服务器。</li><li>一旦故障切换完成，mha4mysql-manager会持续监控新的主服务器和数据库集群的健康状态，以确保数据库集群能够恢复正常运行。</li></ol><blockquote><p>总的来说，MHA的架构原理是基于监控、自动故障切换和恢复的流程，以确保MySQL数据库集群的高可用性和可靠性。它提供了一个自动化的解决方案，使数据库管理员能够更轻松地管理和维护数据库集群，并确保业务连续性。</p></blockquote><h2 id="3-MHA工作原理"><a href="#3-MHA工作原理" class="headerlink" title="3.MHA工作原理"></a>3.MHA工作原理</h2><ol><li>监控主从复制状态：MHA通过定期检查MySQL数据库的主从复制状态，包括主服务器的健康状态、从服务器的延迟等情况。</li><li>发现主服务器故障：当MHA检测到主服务器出现故障或不可用时，它会自动触发故障切换过程。</li><li>执行故障切换：MHA会选择一个合适的从服务器作为新的主服务器，并修改数据库配置完成切换，同时通知应用程序更新连接信息。</li><li>进行故障恢复：一旦故障切换完成，MHA会监控新的主服务器的健康状态，确保数据库集群恢复正常运行。</li><li>避免脑裂问题：MHA能够避免脑裂问题（split-brain），即在多主复制环境下只有一个主服务器在提供服务。</li></ol><blockquote><p>总的来说，MHA通过监控主从复制状态，自动执行故障切换，并确保数据库高可用性，从而提供了一种简单而又可靠的MySQL高可用性解决方案。</p></blockquote><h2 id="4-MHA组件作用"><a href="#4-MHA组件作用" class="headerlink" title="4.MHA组件作用"></a>4.MHA组件作用</h2><p>MHA（MySQL高可用性）中的manager组件和node组件在功能和作用上有以下区别：</p><ol><li>Manager组件：</li></ol><ul><li>管理配置信息：负责管理MHA的配置信息，包括MySQL的主从关系、故障转移的参数设置、监控参数等。</li><li>故障检测和切换决策：监控MySQL的主从复制状态，一旦检测到Master节点故障，会触发故障转移流程，并根据事先设定的切换策略进行Master节点切换。</li><li>日志记录和报警：记录故障转移的过程和结果，并可以配合报警系统进行故障通知。</li></ul><ol><li>Node组件：</li></ol><ul><li>监视MySQL Master的状态：负责监视MySQL Master节点的运行状态，一旦Master节点发生故障，node组件会发现并触发故障转移过程。</li><li>自动故障转移：一旦Master节点发生故障，node组件会自动将Slave节点提升为新的Master节点，以确保数据库系统的高可用性。</li><li>管理复制拓扑：管理MySQL的复制拓扑，包括添加和删除从节点，监控复制延迟等。</li></ul><blockquote><p>总的来说，Manager组件主要负责配置管理、故障检测和切换决策，以及记录和报警，而Node组件则主要负责监视Master节点状态，自动故障转移和管理复制拓扑。两个组件共同协作，确保MySQL的高可用性。</p></blockquote><p><strong>Manager组件</strong></p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>masterha_check_ssh</td><td>检查MHA的SSH配置状况</td></tr><tr><td>masterha_check_repl</td><td>检查MySQL复制状况，配置信息</td></tr><tr><td>masterha_master_monitor</td><td>检测master是否宕机</td></tr><tr><td>masterha_manger</td><td>启动MHA</td></tr><tr><td>masterha_check_status</td><td>检测当前MHA运行状态</td></tr><tr><td>masterha_master_switch</td><td>控制故障转移(自动或者手动)</td></tr><tr><td>masterha_conf_host</td><td>添加或删除配置的server信息</td></tr></tbody></table><p><strong>node组件</strong></p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>save_binary_logs</td><td>保存和复制master的二进制日志</td></tr><tr><td>apply_diff_relay_logs</td><td>识别差异的中继日志事件，并将其差异的事件应用于其他的节点</td></tr><tr><td>purge_relay_logs</td><td>清除中继日志(不会阻塞SQL线程)</td></tr></tbody></table><h1 id="二、主从复制环境部署"><a href="#二、主从复制环境部署" class="headerlink" title="二、主从复制环境部署"></a>二、主从复制环境部署</h1><p><strong>机器环境准备：</strong></p><p>部署MHA高可用性，先得有主从复制集群环境，下方db-51、db-52、db-53三台机器做主从复制</p><p><strong>要求：</strong></p><blockquote><p>1.所有机器binlog全部开启，高可用主从切换时会以新master的binlog为基础，对slave数据进行同步</p><p>2.所有机器gtid全部开启，binlog中所有事务可根据gtid记录，主从复制根据gtid复制数据更加可靠与方便</p><p>3.所有机器设置server_id，不设置binlog无法开启</p><p>4.所有机器server_id不能设置相同值，防止数据无法完整复制到每个节点中</p></blockquote><h2 id="1-主库环境部署"><a href="#1-主库环境部署" class="headerlink" title="1.主库环境部署"></a>1.主库环境部署</h2><p><strong>db-51</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>下载安装mysql基础环境部署</span><br><span class="line">...........省略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>修改配置文件如下</span><br><span class="line">cat  <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">[mysqld]</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">-</span>server<span class="operator">=</span>utf8</span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>启动检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">ss <span class="operator">-</span>tunlp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>查看GTID是否开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-从库环境部署"><a href="#2-从库环境部署" class="headerlink" title="2.从库环境部署"></a>2.从库环境部署</h2><p><strong>db-52</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>mysql下载及基础环境部署</span><br><span class="line">..........省略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>初始化安装mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>配置文件修改</span><br><span class="line">cat  <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">[mysqld]</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">-</span>server<span class="operator">=</span>utf8</span><br><span class="line">server_id<span class="operator">=</span><span class="number">52</span></span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>启动检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">ss <span class="operator">-</span>tunlp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>查看GTID是否开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><p><strong>db-53</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>mysql下载及基础环境部署</span><br><span class="line">..........省略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>初始化安装mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>配置文件修改</span><br><span class="line">cat  <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">[mysqld]</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">-</span>server<span class="operator">=</span>utf8</span><br><span class="line">server_id<span class="operator">=</span><span class="number">53</span></span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>启动检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">ss <span class="operator">-</span>tunlp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>查看GTID是否开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="3-主从复制关系建立"><a href="#3-主从复制关系建立" class="headerlink" title="3.主从复制关系建立"></a>3.主从复制关系建立</h2><h3 id="3-1主库修改root密码"><a href="#3-1主库修改root密码" class="headerlink" title="3.1主库修改root密码"></a>3.1主库修改root密码</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#修改密码</span><br><span class="line">mysqladmin password <span class="number">1</span></span><br><span class="line"></span><br><span class="line">#登录检查</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1</span><br></pre></td></tr></table></figure><h3 id="3-2主库创建从库复制账号"><a href="#3-2主库创建从库复制账号" class="headerlink" title="3.2主库创建从库复制账号"></a>3.2主库创建从库复制账号</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#创建用户设置登录白名单并授予从库复制权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查用户权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> repl@<span class="string">&#x27;172.16.1.%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> repl<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.<span class="operator">%</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查登录白名单</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span> host       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="operator">|</span> repl          <span class="operator">|</span> <span class="number">172.16</span><span class="number">.1</span>.<span class="operator">%</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.session <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.sys     <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> root          <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="3-3从库配置连接开启复制"><a href="#3-3从库配置连接开启复制" class="headerlink" title="3.3从库配置连接开启复制"></a>3.3从库配置连接开启复制</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">参数说明</span><br><span class="line">change master <span class="keyword">to</span>   #主从复制连接主库参数修改 </span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,  #主库ip</span><br><span class="line">master_port<span class="operator">=</span><span class="number">3306</span>, #主库端口</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,#连接用户</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,#连接密码</span><br><span class="line">MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>,     #自动通过GTID值获取主库binlog事务信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#参数配置</span><br><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,master_port<span class="operator">=</span><span class="number">3306</span>,master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动从库复制功能</span><br><span class="line"><span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure><h3 id="3-4检查从库复制状态"><a href="#3-4检查从库复制状态" class="headerlink" title="3.4检查从库复制状态"></a>3.4检查从库复制状态</h3><p><strong>1）检查从库线程状态</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>检查从库复制状态</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G;</span><br><span class="line">#保证线程状态为yes</span><br><span class="line">Slave_IO_Running:  Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查从库线程详细状态信息</span><br><span class="line">mysql<span class="operator">&gt;</span><span class="keyword">show</span> processlist;</span><br><span class="line">#state状态信息</span><br><span class="line">IO线程：等待主库发送事件</span><br><span class="line"><span class="keyword">SQL</span>线程：读取中继日志等待日志更新</span><br></pre></td></tr></table></figure><p><img src="/image-20240621204751663.png" alt="image-20240621204751663"></p><p><strong>2）检查binlog同步情况</strong></p><ul><li>从库复制状态binlog同步截止点检查</li><li>检查从库复制的binlog截止点是否与主库的binlog一致</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#查看复制状态</span><br><span class="line"><span class="keyword">show</span> slave status\G;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查读取的主库binlog截止点</span><br><span class="line">Read_Master_Log_Pos: <span class="number">706</span></span><br><span class="line">Relay_Log_File: db<span class="number">-52</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查从库同步的binlog截止点</span><br><span class="line">Exec_Master_Log_Pos: <span class="number">706</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查读取与同步的binlog的GTID事务截止点</span><br><span class="line">Retrieved_Gtid_Set: <span class="number">44300</span>b99<span class="number">-2</span>ef4<span class="number">-11</span>ef<span class="number">-8541</span><span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-2</span></span><br><span class="line">Executed_Gtid_Set: <span class="number">44300</span>b99<span class="number">-2</span>ef4<span class="number">-11</span>ef<span class="number">-8541</span><span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-2</span></span><br></pre></td></tr></table></figure><ul><li>主库从库binlog信息检查</li></ul><p>&#x3D;&#x3D;检查从库的binlog信息是否与主库的binlog信息一致&#x3D;&#x3D;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#主库检查</span><br><span class="line"><span class="keyword">show</span> master status;</span><br><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000004&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#从库检查</span><br><span class="line"><span class="keyword">show</span> master status;</span><br><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000004&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#最终保持一致即可</span><br></pre></td></tr></table></figure><ul><li>从库数据同步检查</li></ul><p>&#x3D;&#x3D;主库创建了复制账号，修改了实例数据，检查从库是否同步了修改的数据&#x3D;&#x3D;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#检查同步无误</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host  <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span> host       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="operator">|</span> repl          <span class="operator">|</span> <span class="number">172.16</span><span class="number">.1</span>.<span class="operator">%</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.session <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.sys     <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> root          <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="4-检查主从复制效果"><a href="#4-检查主从复制效果" class="headerlink" title="4.检查主从复制效果"></a>4.检查主从复制效果</h2><blockquote><p>主库写入数据，从库检查复制效果即可</p></blockquote><p><strong>主库写入数据</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database checktest;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> checktest.t1(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.06</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> checktest.t1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.11</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> checktest.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p><strong>从库检查同步</strong></p><ul><li>db-51检查</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from checktest.t1;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>db-52检查</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from checktest.t1;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p><strong>binlog事务信息同步检查</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status;</span><br></pre></td></tr></table></figure><h2 id="5-从库节点设置全局读锁（未学）"><a href="#5-从库节点设置全局读锁（未学）" class="headerlink" title="5.从库节点设置全局读锁（未学）"></a>5.从库节点设置全局读锁（未学）</h2><p>确保了从库同步数据的一致性，防止从库节点有数据写入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;read_only%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> read_only     <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用root设置全局读锁</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> read_only<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;read_only%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> read_only     <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="三、MHA高可用搭建部署"><a href="#三、MHA高可用搭建部署" class="headerlink" title="三、MHA高可用搭建部署"></a>三、MHA高可用搭建部署</h1><h2 id="1-所有节点软链接设置"><a href="#1-所有节点软链接设置" class="headerlink" title="1.所有节点软链接设置"></a>1.所有节点软链接设置</h2><ul><li>所有节点设置mysql与mysqlbinlog命令软链接<ul><li>MHA应用会调用这两个命令实现主从切换故障转移数据同步等操作</li><li>命令在其他目录MHA无法识别调用，需要将这两个命令配置软链接放入&#x2F;usr&#x2F;bin&#x2F;下</li></ul></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>主库配置</span><br><span class="line">#db<span class="number">-51</span></span><br><span class="line">#检查当前命令所在路径</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#which mysql</span><br><span class="line"><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#which mysqlbinlog</span><br><span class="line"><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line"></span><br><span class="line">#配置软链接</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog  <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line"></span><br><span class="line">#检查软链接后路径</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#which mysql</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#which mysqlbinlog</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>从库配置</span><br><span class="line">#db<span class="number">-52</span></span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog  <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line">which mysql</span><br><span class="line">which mysqlbinlog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#db<span class="number">-53</span></span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog  <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line">which mysql</span><br><span class="line">which mysqlbinlog</span><br></pre></td></tr></table></figure><h2 id="2-所有节点免密连接设置"><a href="#2-所有节点免密连接设置" class="headerlink" title="2.所有节点免密连接设置"></a>2.所有节点免密连接设置</h2><blockquote><p>主从复制所有节点互相配置ssh免密登录</p></blockquote><p>配置互相免密主要是为了简化节点之间的通信和协作</p><p>在MHA集群中，各个节点需要频繁地进行状态同步，故障切换和数据同步等操作</p><p>如果每次都需要输入密码或者进行密钥验证，将会增加管理和操作的复杂度</p><p><strong>db-51</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>安装sshpass工具</span><br><span class="line">yum install sshpass <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>本地生成公私钥对</span><br><span class="line">#无交互操作，指定文件存放路径指定无密码</span><br><span class="line">ssh<span class="operator">-</span>keygen <span class="operator">-</span>f <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_rsa <span class="operator">-</span>N <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>通过sshpass工具实现无交互发送公钥到目标机器，包括自己本地机器也需要发送</span><br><span class="line">#sshpass <span class="operator">-</span>p 指定登录密码无需命令行交互输入</span><br><span class="line">#ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id 发送公钥指定目标机器ip</span><br><span class="line">#StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span> 不做指纹认证</span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 免密登录验证</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#<span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span>;do ssh root<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.$i &quot;hostname;echo &#x27;免密登录验证&#x27;&quot;;done</span><br><span class="line">db<span class="number">-51</span></span><br><span class="line">免密登录验证</span><br><span class="line">db<span class="number">-52</span></span><br><span class="line">免密登录验证</span><br><span class="line">db<span class="number">-53</span></span><br><span class="line">免密登录验证</span><br></pre></td></tr></table></figure><p><strong>db-52</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install sshpass <span class="operator">-</span>y</span><br><span class="line">ssh<span class="operator">-</span>keygen <span class="operator">-</span>f <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_rsa <span class="operator">-</span>N <span class="string">&#x27;&#x27;</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span>;do ssh root<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.$i &quot;hostname;echo &#x27;免密登录验证&#x27;&quot;;done</span><br></pre></td></tr></table></figure><p><strong>db-53</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install sshpass <span class="operator">-</span>y</span><br><span class="line">ssh<span class="operator">-</span>keygen <span class="operator">-</span>f <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_rsa <span class="operator">-</span>N <span class="string">&#x27;&#x27;</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span>;do ssh root<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.$i &quot;hostname;echo &#x27;免密登录验证&#x27;&quot;;done</span><br></pre></td></tr></table></figure><h2 id="3-所有节点mha用户创建"><a href="#3-所有节点mha用户创建" class="headerlink" title="3.所有节点mha用户创建"></a>3.所有节点mha用户创建</h2><p><strong>mha调用mha用户做什么：</strong></p><ol><li>进行管理和监控：MHA使用mha用户进行管理和监控MySQL主从复制集群的状态，包括监视主节点的健康状况、从节点是否与主节点同步等。这可以帮助MHA及时发现数据库集群中的故障和问题，并采取相应的措施进行处理。</li><li>进行故障转移和切换：当主节点出现故障或不可用时，MHA可以使用mha用户进行故障转移操作，自动将从节点提升为新的主节点，同时重新配置其他从节点以确保数据库集群的高可用性。</li><li>执行配置更改：MHA使用mha用户来执行配置更改，例如添加或删除从节点、更改复制拓扑、切换到不同的主节点等操作。</li></ol><p>通过使用专门的mha用户，MHA可以在MySQL主从复制环境中安全地进行故障检测、故障处理和配置更改，同时确保数据库集群的安全和稳定性。</p><p><strong>mha用户权限分配：</strong></p><p>在MHA环境中，通常会为mha用户授予<code>&#39;mha&#39;@&#39;%&#39;</code>的权限，即允许该用户从任何主机连接到MySQL数据库。这是因为MHA需要在主从复制环境中的各个节点之间进行管理和监控操作，而这些节点可能存在于不同的主机或服务器上。因此，为了确保mha用户能够在所有节点上执行必要的操作，通常会将其权限设置为可以从任何主机连接。</p><p>当然，在实际生产环境中，为了安全起见，可以根据具体需求和安全策略，限制mha用户的连接范围，例如只允许特定IP地址或主机名连接。这样可以提高数据库的安全性，防止未授权的访问。</p><p>总之，为了确保MHA能够有效地管理和监控MySQL主从复制环境，需要为mha用户分配适当的权限，确保其能够在必要的情况下连接到所有相关节点。</p><blockquote><p>&#x3D;&#x3D;所有节点创建mha用户&#x3D;&#x3D;，mha工具会调用指定用户登录连接数据库，进行一系列操作</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#主库db<span class="number">-51</span>创建即可，从库会自动同步</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> mha@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> mha@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#从库db<span class="number">-52</span>与db<span class="number">-53</span>检查同步情况</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> mha@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="4-所有节点node组件安装"><a href="#4-所有节点node组件安装" class="headerlink" title="4.所有节点node组件安装"></a>4.所有节点node组件安装</h2><blockquote><p>node组件需要在主从复制集群&#x3D;&#x3D;所有节点都安装&#x3D;&#x3D;，主要作用接收manager组件来的请求，执行相应的操作</p></blockquote><p><strong>db51、db52、db53</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#安装node组件连接数据库驱动</span><br><span class="line">yum install  <span class="operator">-</span>y perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下载好node组件上传到linux安装即可，暂未找到mha组件下载官网</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>opt]#ls</span><br><span class="line">mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">/</span>opt]#ls</span><br><span class="line">mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">/</span>opt]#ls</span><br><span class="line">mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#所有机器节点安装</span><br><span class="line">yum localinstall mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm  <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看node软件包安装后生成的脚本管理命令</span><br><span class="line">rpm <span class="operator">-</span>qa<span class="operator">|</span>grep <span class="string">&#x27;mha*&#x27;</span></span><br><span class="line">rpm <span class="operator">-</span>ql mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#node组件管理命令</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>apply_diff_relay_logs</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>filter_mysqlbinlog</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>purge_relay_logs</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>save_binary_logs</span><br></pre></td></tr></table></figure><h2 id="5-管理节点manager组件安装"><a href="#5-管理节点manager组件安装" class="headerlink" title="5.管理节点manager组件安装"></a>5.管理节点manager组件安装</h2><blockquote><p>manager组件在&#x3D;&#x3D;单个的节点安装&#x3D;&#x3D;，或者在&#x3D;&#x3D;从库节点安装&#x3D;&#x3D;，&#x3D;&#x3D;不能在主库节点安装&#x3D;&#x3D;防止主库宕机影响高可用的实现</p><p>主要作用相当于包工头，吩咐node组件工作的领导管理者</p></blockquote><ul><li><strong>下方选择在从库节点db-52安装manager管理组件</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#安装epel额外源，用于安装manager软件依赖</span><br><span class="line">yum install epel<span class="operator">-</span><span class="keyword">release</span> <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#安装manager组件运行环境及依赖</span><br><span class="line">yum install  <span class="operator">-</span>y perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL perl<span class="operator">-</span>Config<span class="operator">-</span>Tiny perl<span class="operator">-</span>Log<span class="operator">-</span>Dispatch perl<span class="operator">-</span>Parallel<span class="operator">-</span>ForkManager perl<span class="operator">-</span>ExtUtils<span class="operator">-</span>CBuilder perl<span class="operator">-</span>ExtUtils<span class="operator">-</span>MakeMaker perl<span class="operator">-</span>CPAN perl<span class="operator">-</span><span class="type">Time</span><span class="operator">-</span>HiRes </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下载manager组件到linux</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">/</span>opt]#ls</span><br><span class="line">mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#安装manager组件</span><br><span class="line">yum localinstall mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm  <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查manager包安装的管理命令</span><br><span class="line">rpm <span class="operator">-</span>qa<span class="operator">|</span>grep <span class="string">&#x27;mha*&#x27;</span></span><br><span class="line">rpm <span class="operator">-</span>ql mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#manager管理命令如下</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_check_repl</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_check_ssh</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_check_status</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_conf_host</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_manager</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_master_monitor</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_master_switch</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_secondary_check</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_stop</span><br></pre></td></tr></table></figure><h2 id="6-管理节点透明自愈脚本添加"><a href="#6-管理节点透明自愈脚本添加" class="headerlink" title="6.管理节点透明自愈脚本添加"></a>6.管理节点透明自愈脚本添加</h2><blockquote><p>manager所在机器添加，运行mha应用发生故障时，mha可以调用该脚本，实现vip漂移，保证数据库持续运行</p></blockquote><ol><li>实现自动故障转移：透明自愈脚本可以监控MySQL主从复制的状态和健康情况，当主服务器发生故障或不可用时，脚本可以自动触发主从切换，将VIP（虚拟IP）从原主服务器切换到备用从服务器上，从而确保数据库服务的高可用性。</li><li>减少手动干预：透明自愈脚本减少了管理员手动介入的需要，可以自动识别和处理主从复制故障情况，从而减少了故障处理时间和人工成本。</li><li>简化故障处理：脚本能够快速检测和诊断主从复制的问题，并采取必要的措施来恢复服务，如切换VIP、重新连接到备用服务器等，从而简化了故障处理的流程。</li><li>提高可靠性和可用性：通过透明自愈脚本的自动化处理，可以提高数据库服务的可靠性和可用性，减少了因为主从复制故障而导致的服务中断时间，同时提高了整个系统的稳定性。</li></ol><p>总的来说，透明自愈脚本是MHA工具的一个重要组成部分，它能够自动监控、诊断和处理MySQL主从复制的故障情况，从而确保数据库服务能够持续、稳定地运行。</p><p><strong>脚本内容：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover<span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">#<span class="operator">!</span><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>env perl</span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;all&#x27;</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#修改如下<span class="number">5</span>条信息即可</span><br><span class="line">#vip地址设置，根据下方网卡位置配置，定义vip运行在公网还是内网</span><br><span class="line">my $vip <span class="operator">=</span> <span class="string">&#x27;10.0.0.55/24&#x27;</span>;</span><br><span class="line">my $key <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">#vip绑定的网卡位置，修改网卡名即可更改vip运行网卡位置</span><br><span class="line">#ifconfig查看机器网卡名，注意网卡名要与机器上网卡名对应</span><br><span class="line">my $ssh_start_vip <span class="operator">=</span> &quot;/sbin/ifconfig eth0:$key $vip&quot;;</span><br><span class="line">my $ssh_stop_vip <span class="operator">=</span> &quot;/sbin/ifconfig eth0:$key down&quot;;</span><br><span class="line">my $ssh_Bcast_arp<span class="operator">=</span>&quot;/sbin/arping -I eth0 -c 3 -A 10.0.0.55&quot;;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">&#x27;command=s&#x27;</span>          <span class="operator">=</span><span class="operator">&gt;</span> \$command,</span><br><span class="line">    <span class="string">&#x27;ssh_user=s&#x27;</span>         <span class="operator">=</span><span class="operator">&gt;</span> \$ssh_user,</span><br><span class="line">    <span class="string">&#x27;orig_master_host=s&#x27;</span> <span class="operator">=</span><span class="operator">&gt;</span> \$orig_master_host,</span><br><span class="line">    <span class="string">&#x27;orig_master_ip=s&#x27;</span>   <span class="operator">=</span><span class="operator">&gt;</span> \$orig_master_ip,</span><br><span class="line">    <span class="string">&#x27;orig_master_port=i&#x27;</span> <span class="operator">=</span><span class="operator">&gt;</span> \$orig_master_port,</span><br><span class="line">    <span class="string">&#x27;new_master_host=s&#x27;</span>  <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_host,</span><br><span class="line">    <span class="string">&#x27;new_master_ip=s&#x27;</span>    <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_ip,</span><br><span class="line">    <span class="string">&#x27;new_master_port=i&#x27;</span>  <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">exit <span class="operator">&amp;</span>main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line"></span><br><span class="line">    print &quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;;</span><br><span class="line"></span><br><span class="line">    if ( $command eq &quot;stop&quot; <span class="operator">||</span> $command eq &quot;stopssh&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">        my $exit_code <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        eval &#123;</span><br><span class="line">            print &quot;Disabling the VIP on old master: $orig_master_host \n&quot;;</span><br><span class="line">            <span class="operator">&amp;</span>stop_vip();</span><br><span class="line">            $exit_code <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        if ($@) &#123;</span><br><span class="line">            warn &quot;Got Error: $@\n&quot;;</span><br><span class="line">            exit $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( $command eq &quot;start&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">        my $exit_code <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        eval &#123;</span><br><span class="line">            print &quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;;</span><br><span class="line">            <span class="operator">&amp;</span>start_vip();</span><br><span class="line">            $exit_code <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        if ($@) &#123;</span><br><span class="line">            warn $@;</span><br><span class="line">            exit $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( $command eq &quot;status&quot; ) &#123;</span><br><span class="line">        print &quot;Checking the Status of the script.. OK \n&quot;;</span><br><span class="line">        exit <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="operator">&amp;</span>usage();</span><br><span class="line">        exit <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sub start_vip() &#123;</span><br><span class="line">    `ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line">sub stop_vip() &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>  unless  ($ssh_user);</span><br><span class="line">    `ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">    print</span><br><span class="line">    &quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>脚本添加执行权限</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#chmod <span class="operator">+</span>x  <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover_script </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ll <span class="operator">-</span>d <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover_script </span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> root root <span class="number">2229</span> Jun <span class="number">22</span> <span class="number">18</span>:<span class="number">41</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover_script</span><br></pre></td></tr></table></figure><h2 id="7-管理节点mha配置文件创建"><a href="#7-管理节点mha配置文件创建" class="headerlink" title="7.管理节点mha配置文件创建"></a>7.管理节点mha配置文件创建</h2><blockquote><p>manager组件所在机器创建配置文件</p></blockquote><p><strong>创建mha配置文件与日志目录存放目录：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#创建配置文件存放目录</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>etc<span class="operator">/</span>mha </span><br><span class="line"></span><br><span class="line">#创建日志文件存放目录，可以针对多个业务创建命名日志目录</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1 </span><br><span class="line"></span><br><span class="line">#创建配置文件，mha可管理多个主从集群，可以针对多个业务命名配置文件</span><br><span class="line">vim  <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf         </span><br></pre></td></tr></table></figure><p><strong>mha-manager配置文件创建：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf <span class="operator">&lt;&lt;</span> &quot;EOF&quot;</span><br><span class="line">[server <span class="keyword">default</span>]</span><br><span class="line">manager_log<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1<span class="operator">/</span>manager.log</span><br><span class="line">manager_workdir<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1.log</span><br><span class="line">master_binlog_dir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span></span><br><span class="line">master_ip_failover_script<span class="operator">=</span><span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover</span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mha</span><br><span class="line">password<span class="operator">=</span><span class="number">1</span></span><br><span class="line">ping_interval<span class="operator">=</span><span class="number">2</span></span><br><span class="line">repl_user<span class="operator">=</span>repl</span><br><span class="line">repl_password<span class="operator">=</span><span class="number">1</span></span><br><span class="line">ssh_user<span class="operator">=</span>root</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line">[server3]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>参数解释：</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>[server default]</td><td>服务默认模块标签</td></tr><tr><td>manager_log&#x3D;</td><td>mha应用日志存放路径</td></tr><tr><td>manager_workdir&#x3D;</td><td>mha工作目录存放路径<br />存放运行时产生的临时文件，锁文件以及其他需要的临时数据</td></tr><tr><td>master_binlog_dir&#x3D;</td><td>主库binlog存放路径<br />发生故障时会对故障master保存其binlog</td></tr><tr><td>user&#x3D;</td><td>mha连接主从集群实例的用户</td></tr><tr><td>password&#x3D;</td><td>mha连接主从集群实例的密码</td></tr><tr><td>ping_interval&#x3D;2</td><td>mha监控主从集群实例的间隔时间</td></tr><tr><td>repl_user&#x3D;</td><td>slave连接master复制数据账号</td></tr><tr><td>repl_password</td><td>slave连接master复制账号密码</td></tr><tr><td>ssh_user=&#x3D;&#x3D;root&#x3D;&#x3D;</td><td>mha免密连接主从集群机器的用户</td></tr><tr><td>master_ip_failover_script&#x3D;</td><td>vip漂移脚本心跳检测实现vip漂移<br />时刻提供数据库服务对客户端无影响</td></tr><tr><td>[server1]</td><td>主从复制集群节点地址信息</td></tr><tr><td>[server2]</td><td>主从复制集群节点地址信息</td></tr><tr><td>[server3]</td><td>主从复制集群节点地址信息</td></tr></tbody></table><h2 id="8-master节点主库添加设置vip"><a href="#8-master节点主库添加设置vip" class="headerlink" title="8.master节点主库添加设置vip"></a>8.master节点主库添加设置vip</h2><blockquote><p>主库节点给网卡添加新ip地址，该地址需要与自愈脚本中设置的vip对应</p><p>当主库节点故障时，mha会根据自愈脚本实现主从切换，并且会将故障主库的vip地址删除，给新主库重新设置同一vip地址</p></blockquote><p><strong>db-51主库节点设置</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#添加vip</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ifconfig eth1:<span class="number">1</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span><span class="operator">/</span><span class="number">24</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查vip添加</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ifconfig eth1:<span class="number">1</span></span><br><span class="line">eth1:<span class="number">1</span>: flags<span class="operator">=</span><span class="number">4163</span><span class="operator">&lt;</span>UP,BROADCAST,<span class="keyword">RUNNING</span>,MULTICAST<span class="operator">&gt;</span>  mtu <span class="number">1500</span></span><br><span class="line">        inet <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span>  netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>  broadcast <span class="number">172.16</span><span class="number">.1</span><span class="number">.255</span></span><br><span class="line">        ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">39</span>:ad:b4  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 删除vip命令</span><br><span class="line">ifconfig eth1:<span class="number">1</span> del <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span></span><br><span class="line"># 停止vip命令</span><br><span class="line">ifconfig eth1:<span class="number">1</span> down</span><br></pre></td></tr></table></figure><h2 id="9-管理节点检查mha运行前状态"><a href="#9-管理节点检查mha运行前状态" class="headerlink" title="9.管理节点检查mha运行前状态"></a>9.管理节点检查mha运行前状态</h2><blockquote><p>&#x3D;&#x3D;manager组件所在机器检查&#x3D;&#x3D;</p><p>检查mha运行前环境状态是否正常，检查ssh免密连接是否正常，检查主从复制数据同步是否正常</p></blockquote><p><strong>db-52-manager管理节点</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#检查ssh免密登录是否正常</span><br><span class="line">masterha_check_ssh <span class="comment">--conf=/etc/mha/app1.cnf </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查主从复制同步是否正常</span><br><span class="line">masterha_check_repl <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-------------------------------------------------</span></span><br><span class="line">！最后保证两个检查日志都没有报错即可运行mha应用了</span><br></pre></td></tr></table></figure><h2 id="10-管理节点启动mha服务"><a href="#10-管理节点启动mha服务" class="headerlink" title="10.管理节点启动mha服务"></a>10.管理节点启动mha服务</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>启动mha服务</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf  --remove_dead_master_conf  --ignore_last_failover /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查进程状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#jobs <span class="operator">-</span>l</span><br><span class="line">[<span class="number">1</span>]<span class="operator">+</span> <span class="number">39313</span> <span class="keyword">Running</span>                 nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>检查mha服务运行状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">39313</span>) <span class="keyword">is</span> <span class="keyword">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------------</span></span><br><span class="line">#启动参数说明</span><br><span class="line"><span class="comment">--remove_dead_master_conf       该参数代表当发生主从切换后，老的主库的ip将会从配置文件中移除。</span></span><br><span class="line"><span class="comment">--manger_log                    日志存放位置</span></span><br><span class="line"><span class="comment">--ignore_last_failover          默认连续故障不会进行故障转移，忽略这个条件，只要有故障就进行故障转移</span></span><br><span class="line">#停止命令</span><br><span class="line">masterha_stop <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br></pre></td></tr></table></figure><h1 id="四、故障演练实现高可用"><a href="#四、故障演练实现高可用" class="headerlink" title="四、故障演练实现高可用"></a>四、故障演练实现高可用</h1><blockquote><ul><li>模拟主库节点故障，检查mha服务实现高可用效果，故障切换，主从关系重新建立，vip漂移，数据同步情况等</li></ul><ol><li>停止master主库</li><li>查看VIP是否漂移</li><li>查看是否有slave成为new_master</li><li>查看从库是否切换master —slave关系</li></ol></blockquote><h2 id="1-模拟故障关闭主库节点"><a href="#1-模拟故障关闭主库节点" class="headerlink" title="1.模拟故障关闭主库节点"></a>1.模拟故障关闭主库节点</h2><ul><li>主动模拟故障，停掉db-51机器运行的主库节点MySQL实例</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#查看线程信息，当前的db<span class="number">-51</span>机器为master主库</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show processlist&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#关闭mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl stop mysqld</span><br></pre></td></tr></table></figure><h2 id="2-检查故障后的新主库选举"><a href="#2-检查故障后的新主库选举" class="headerlink" title="2.检查故障后的新主库选举"></a>2.检查故障后的新主库选举</h2><ul><li>mha监控到master节点故障后，会进行的一个故障切换，选举主从集群中的日志最新的slave成为新的maste节点，并且将集群中的其他slave节点复制关系指向新的master节点上。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>manager节点，查看当前mha状态，master身份被切换到了<span class="number">52</span>机器</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">52878</span>) <span class="keyword">is</span> <span class="keyword">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>集群中的从库节点查看复制状态，db<span class="number">-52</span>与db<span class="number">-53</span>节点查看</span><br><span class="line"><span class="keyword">show</span> slave status\G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>db<span class="number">-52</span>查不到说明当前被切换成为了master身份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show slave status\G&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>db<span class="number">-53</span>查看复制状态，发现db<span class="number">-52</span>成为了新的master节点主库</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show slave status\G&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</span><br><span class="line">                  Master_Host: <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">1575</span></span><br><span class="line">               Relay_Log_File: db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">414</span></span><br><span class="line">        Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><h2 id="3-检查vip自动漂移"><a href="#3-检查vip自动漂移" class="headerlink" title="3.检查vip自动漂移"></a>3.检查vip自动漂移</h2><ul><li>mha监控到master节点挂掉后，会将挂掉的master上的vip地址删除，并将vip添加到新选举的master节点上，实现了数据库在与外部通信的过程中，一直是处于持续稳定的运行状态。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#检查之前的master节点db<span class="number">-51</span>，宕机挂掉后，vip便不存在了</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ifconfig<span class="operator">|</span>grep <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查新的master节点db<span class="number">-52</span>，切换成为了新主库节点，自动添加了vip</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ifconfig<span class="operator">|</span>grep <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span></span><br><span class="line">        inet <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span>  netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>  broadcast <span class="number">172.16</span><span class="number">.1</span><span class="number">.255</span></span><br></pre></td></tr></table></figure><h2 id="4-检查新主库与旧主库的数据一致性"><a href="#4-检查新主库与旧主库的数据一致性" class="headerlink" title="4.检查新主库与旧主库的数据一致性"></a>4.检查新主库与旧主库的数据一致性</h2><ul><li>mha监控到master节点故障后，会将故障的master节点上的数据第一时间保存，同步给选举的新master节点，保证数据的一致性</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#检查旧master节点的binlog最新位置</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog]#ll</span><br><span class="line">total <span class="number">20</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 18:51 mysql-bin.000001</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 18:57 mysql-bin.000002</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 19:00 mysql-bin.000003</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 1619 Jun 23 13:12 mysql-bin.000004</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  160 Jun 20 19:09 mysql-bin.index</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog]#mysqlbinlog <span class="operator">-</span>vv mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查新master节点的binlog位置</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog]#ll</span><br><span class="line">total <span class="number">20</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 18:51 mysql-bin.000001</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 18:57 mysql-bin.000002</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 19:00 mysql-bin.000003</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 1619 Jun 23 13:12 mysql-bin.000004</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  160 Jun 20 19:09 mysql-bin.index</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog]#mysqlbinlog <span class="operator">-</span>vv mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br></pre></td></tr></table></figure><ul><li>最后保证新master与故障master的binlog最新数据一致即可</li></ul><p><img src="/image-20240623141035216.png" alt="image-20240623141035216"></p><h2 id="5-检查新主从关系的复制效果"><a href="#5-检查新主从关系的复制效果" class="headerlink" title="5.检查新主从关系的复制效果"></a>5.检查新主从关系的复制效果</h2><ul><li>故障切换后，新的主从关系建立，slave节点复制数据指向了新的master节点，还要保证新主从复制效果是否正常</li><li>当前新master节点为db-52，slave节点为db-53，master写入数据，检查slave同步即可</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>先检查一下slave与新master建立复制关系后，之前的数据同步情况，确保数据的一致性</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show slave status\G&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>新master节点db<span class="number">-52</span>写入数据</span><br><span class="line">#增加数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from  checktest.t1&quot;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;insert into checktest.t1 values(333),(333),(333)&quot;</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from  checktest.t1&quot;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">#检查binlog，查看binlog最新事务GTID截止点</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show master status&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>检查slave节点db<span class="number">-53</span>复制数据</span><br><span class="line">#数据同步无误</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from checktest.t1&quot;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">#检查binlog，确保事务GTID一致即可</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show master status&quot;</span><br></pre></td></tr></table></figure><h2 id="6-mha故障切换后自动停止服务"><a href="#6-mha故障切换后自动停止服务" class="headerlink" title="6.mha故障切换后自动停止服务"></a>6.mha故障切换后自动停止服务</h2><p>当master节点挂掉，mha进行故障切换完成后，会自动停止服务，并且配置文件中移除故障master地址信息</p><p>需要手动进行故障节点恢复，以slave身份重新加入主从集群中，再将故障节点加入mha配置文件中</p><p>最后重新检查免密状态与复制状态，重启启动mha即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#处理故障结束后自动关闭服务</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 <span class="keyword">is</span> stopped(<span class="number">2</span>:NOT_RUNNING).</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置文件自动剔除故障节点地址信息</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#grep <span class="string">&#x27;server&#x27;</span> <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf </span><br><span class="line">[server <span class="keyword">default</span>]</span><br><span class="line">[server2]</span><br><span class="line">[server3]</span><br></pre></td></tr></table></figure><h1 id="五、故障恢复重新加入高可用"><a href="#五、故障恢复重新加入高可用" class="headerlink" title="五、故障恢复重新加入高可用"></a>五、故障恢复重新加入高可用</h1><p><strong>当前环境：</strong></p><p>db-51机器旧master节点故障宕机，db-52机器的slave节点被选举新master节点，db-53机器的slave节点与新master建立了新主从关系，并且新master节点内写入了新数据，db-53机器的slave节点已经同步新master的数据</p><p><strong>故障节点恢复流程：</strong></p><table><thead><tr><th>db-51机器故障master节点恢复步骤</th><th>说明</th></tr></thead><tbody><tr><td>1.恢复节点上的挂掉的mysl实例</td><td></td></tr><tr><td>2.重新加入主从集群中</td><td>故障切换时，故障节点已被剔除出主从集群</td></tr><tr><td>3.配置连接新master参数开启复制功能</td><td>故障切换时，重新选举了新master，只能以slave身份加入</td></tr><tr><td>4.检查数据增量同步情况</td><td>故障切换后，新master已有增量数据写入，加入集群后，会自动同步新master数据</td></tr><tr><td>5.地址信息重新加入mha高可用环境中</td><td>故障切换后，manager节点mha配置中自动剔除了故障节点的地址信息.</td></tr></tbody></table><h2 id="1-恢复故障节点"><a href="#1-恢复故障节点" class="headerlink" title="1.恢复故障节点"></a>1.恢复故障节点</h2><p>故障是自己模拟的重新启动即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">80</span>     [::]:<span class="number">3306</span>               [::]:<span class="operator">*</span>                   users:((&quot;mysqld&quot;,pid<span class="operator">=</span><span class="number">35181</span>,fd<span class="operator">=</span><span class="number">33</span>))</span><br></pre></td></tr></table></figure><h2 id="2-以slave身份重新加入主从集群"><a href="#2-以slave身份重新加入主从集群" class="headerlink" title="2.以slave身份重新加入主从集群"></a>2.以slave身份重新加入主从集群</h2><p>只能以slave身份加入，故障切换时，mha在集群中重新定义了主从关系已有新master节点了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#登录实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前binlog信息</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+----------------------------</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+----------------------------</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>      <span class="number">194</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span> <span class="number">44300</span>b99<span class="number">-2</span>ef4<span class="number">-11</span>ef<span class="number">-8541</span><span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+----------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置连接主库参数</span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.52&#x27;</span>,master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>, MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">2</span> warnings (<span class="number">0.09</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动复制功能</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="3-新slave节点检查复制状态与数据同步"><a href="#3-新slave节点检查复制状态与数据同步" class="headerlink" title="3.新slave节点检查复制状态与数据同步"></a>3.新slave节点检查复制状态与数据同步</h2><p>检查db-51恢复的slave节点复制状态是否正常，检查与新master数据同步是否正常</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>检查复制状态的线程信息</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G;</span><br><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> processlist;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查与master的binlog同步情况</span><br><span class="line">#检查读取到master的binlog截止点与同步的binlog截止点是否一致</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G;</span><br><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">Read_Master_Log_Pos: <span class="number">1839</span></span><br><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">Exec_Master_Log_Pos: <span class="number">1839</span></span><br><span class="line">Retrieved_Gtid_Set: <span class="number">3</span>b0e9ff9<span class="number">-2</span>ef5<span class="number">-11</span>ef<span class="operator">-</span>bb71<span class="number">-000</span>c29b82832:<span class="number">1</span></span><br><span class="line">Executed_Gtid_Set: <span class="number">3</span>b0e9ff9<span class="number">-2</span>ef5<span class="number">-11</span>ef<span class="operator">-</span>bb71<span class="number">-000</span>c29b82832:<span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">#检查master与本地slave的binlog状态，事务GTID为一致即可</span><br><span class="line"><span class="keyword">show</span> master status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>最后检查同步的数据，保证主从复制功能正常</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;select * from checktest.t1&quot;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240623154949471.png" alt="image-20240623154949471"></p><h2 id="4-恢复的节点地址重新加入mha中"><a href="#4-恢复的节点地址重新加入mha中" class="headerlink" title="4.恢复的节点地址重新加入mha中"></a>4.恢复的节点地址重新加入mha中</h2><p>&#x3D;&#x3D;manager管理节点上操作&#x3D;&#x3D;</p><p>故障切换时，mha自动将配置文件中的故障节点地址剔除，如今恢复了故障节点，并且以slave身份重新加入到了主从集群中</p><p>再将恢复的db-51节点，重新加入manager管理节点的mha配置文件中，加入mha高可用服务，重新运行mha即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>执行如下命令，或者修改配置文件</span><br><span class="line">#这条命令就是在配置文件中加入新节点的地址信息</span><br><span class="line">masterha_conf_host <span class="comment">--command=add --conf=/etc/mha/app1.cnf --hostname=172.16.1.51 --block=server1 --params=&quot;port=3306&quot;</span></span><br><span class="line">#或者修改配置文件写入新节点地址</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf </span><br><span class="line">[server1]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>重启mha</span><br><span class="line">#关闭mha</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_stop <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">#检查免密登录状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_ssh <span class="comment">--conf=/etc/mha/app1.cnf </span></span><br><span class="line">#检查主从复制状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_repl <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>确保mha运行前状态无误后，重新启动mha</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf  --remove_dead_master_conf  --ignore_last_failover /var/log/mha/app1/manager.log &amp;&gt;/var/log/mha/app1/manager.log  &amp;</span></span><br><span class="line">[<span class="number">1</span>] <span class="number">68119</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#jobs <span class="operator">-</span>l</span><br><span class="line">[<span class="number">1</span>]<span class="operator">+</span> <span class="number">68119</span> <span class="keyword">Running</span>                 nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/mha/app1/manager.log &amp;&gt;/var/log/mha/app1/manager.log &amp;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>检查mha运行状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">68119</span>) <span class="keyword">is</span> <span class="keyword">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br></pre></td></tr></table></figure><blockquote><p>至此，故障节点成功恢复，重新加入到了mha高可用集群中</p></blockquote><h1 id="六、故障再次演练mha日志监测进行原理分析"><a href="#六、故障再次演练mha日志监测进行原理分析" class="headerlink" title="六、故障再次演练mha日志监测进行原理分析"></a>六、故障再次演练mha日志监测进行原理分析</h1><blockquote><p>再次模拟故障，在manager管理节点上监测日志，基于mha的日志，分析mha实现高可用的原理</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#监测日志</span><br><span class="line">tail <span class="operator">-</span>f <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1<span class="operator">/</span>manager.log </span><br></pre></td></tr></table></figure></blockquote><h2 id="1-模拟故障"><a href="#1-模拟故障" class="headerlink" title="1.模拟故障"></a>1.模拟故障</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#当前master节点为<span class="number">52</span>机器</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">68119</span>) <span class="keyword">is</span> <span class="keyword">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br><span class="line"></span><br><span class="line">#模拟故障停掉<span class="number">52</span>机器mysql实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#systemctl stop mysqld</span><br></pre></td></tr></table></figure><h2 id="2-日志监测分析"><a href="#2-日志监测分析" class="headerlink" title="2.日志监测分析"></a>2.日志监测分析</h2><p>具体原理分析即可，需要必备英语水平，使用翻译软件也可以</p><p><img src="/image-20240623165740278.png" alt="image-20240623165740278"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;一、MHA高可用概述&quot;&gt;&lt;a href=&quot;#一、MHA高可用概述&quot; class=&quot;headerlink&quot; title=&quot;一、MHA高可用概述&quot;&gt;&lt;/a&gt;一、MHA高可用概述&lt;/h1&gt;&lt;h2 id=&quot;1-什么是MHA&quot;&gt;&lt;a href=&quot;#1-什么是MHA&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-主从复制</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</id>
    <published>2024-08-20T00:55:34.000Z</published>
    <updated>2024-08-20T01:03:15.786Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、主从复制架构概述"><a href="#一、主从复制架构概述" class="headerlink" title="一、主从复制架构概述"></a>一、主从复制架构概述</h1><ul><li><p>主从复制，以1台master主库机器，多台slave从库机器，通过服务自带功能，实现主从复制效果</p></li><li><p>搭建主从复制集群的基础，可以通过mha工具实现高可用，防止单节点数据库故障，影响正常业务</p></li><li><p>并且主库的数据同步在从库上，再次实现了备份对数据提供了一个保障</p></li></ul><h1 id="二、主从复制搭建部署pos值"><a href="#二、主从复制搭建部署pos值" class="headerlink" title="二、主从复制搭建部署pos值"></a>二、主从复制搭建部署pos值</h1><h2 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1.环境准备"></a>1.环境准备</h2><ul><li>目标：主库db-51更新数据，db-52与db-53两台从库机器自动同步新增数据</li><li>机器准备：db-51为master主库，内部有原本数据。db-52、db-53为slave从库，内部无数据。</li></ul><blockquote><p>注意事项:</p><p>1.主从复制时，从库需保证库中无其他数据，确保内部空间只留给主从复制同步数据</p><p>2.并且每个实例server_id需不同，否则会影响备份数据</p><p>3.binlog日志目录，需要与数据目录区分开，不能放到一起，否则也会影响备份数据</p><p>4.主库需开binlog日志，从库不可开启binlog记录</p></blockquote><h3 id="1-1-从库配置"><a href="#1-1-从库配置" class="headerlink" title="1.1 从库配置"></a>1.1 从库配置</h3><ul><li>从库配置一样，除了server_id不同</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.</span>检查selinux</span><br><span class="line">getenforce</span><br><span class="line">setenforce <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>创建数据存放目录并授权</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>&#123;tools,data&#125;</span><br><span class="line">mkdir <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>下载安装mysql</span><br><span class="line">tar <span class="operator">-</span>xf mysql5<span class="number">.7</span>.tgz  <span class="operator">-</span>C <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>创建软链接加入PATH变量</span><br><span class="line">#软链接</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql5<span class="number">.7</span><span class="number">.20</span> <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">#环境变量添加</span><br><span class="line">cat <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>profile <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">export PATH<span class="operator">=</span>$PATH:<span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin</span><br><span class="line">EOF</span><br><span class="line">source <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">#检查</span><br><span class="line">mysql <span class="comment">--version</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>卸载mariadb依赖安装mysql专用依赖</span><br><span class="line">yum remove mariadb<span class="operator">-</span>libs<span class="number">-5.5</span><span class="number">.68</span><span class="number">-1.</span>el7.x86_64 <span class="operator">-</span>y</span><br><span class="line">yum install libaio<span class="operator">-</span>devel <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>修改配置文件</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">53</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">[mysql] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">[client] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>创建mysql进程运行用户，初始化数据库</span><br><span class="line">useradd <span class="operator">-</span>M <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/data/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>拷贝mysql自带启停脚本，到系统管理服务脚本路径下</span><br><span class="line">cp <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">systemctl enable mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>启动mysql检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>检查从库环境，binlog不能开启</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show master status&quot;</span><br></pre></td></tr></table></figure><h3 id="1-2-主库配置"><a href="#1-2-主库配置" class="headerlink" title="1.2 主库配置"></a>1.2 主库配置</h3><ul><li>主库最好初始化环境，重新进行配置，否则部署主从复制时，会出现一些问题</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建数据存放目录与binlog存放目录,并且授权</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>&#123;tools,data,mysql_binlog&#125;</span><br><span class="line">mkdir <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>mysql_binlog</span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>下载安装mysql</span><br><span class="line">tar <span class="operator">-</span>xf mysql5<span class="number">.7</span>.tgz  <span class="operator">-</span>C <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>创建软链接加入PATH变量</span><br><span class="line">#软链接</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql5<span class="number">.7</span><span class="number">.20</span> <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">#环境变量添加</span><br><span class="line">cat <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>profile <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">export PATH<span class="operator">=</span>$PATH:<span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin</span><br><span class="line">EOF</span><br><span class="line">source <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">#检查</span><br><span class="line">mysql <span class="comment">--version</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>卸载mariadb依赖安装mysql专用依赖</span><br><span class="line">yum remove mariadb<span class="operator">-</span>libs<span class="number">-5.5</span><span class="number">.68</span><span class="number">-1.</span>el7.x86_64 <span class="operator">-</span>y</span><br><span class="line">yum install libaio<span class="operator">-</span>devel <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>修改配置文件</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">53</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">[mysql] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">[client] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>创建mysql进程运行用户，初始化数据库</span><br><span class="line">useradd <span class="operator">-</span>M <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/data/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>拷贝mysql自带启停脚本，到系统管理服务脚本路径下</span><br><span class="line">cp <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">systemctl enable mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>启动mysql检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span> </span><br></pre></td></tr></table></figure><h2 id="2-主库操作"><a href="#2-主库操作" class="headerlink" title="2.主库操作"></a>2.主库操作</h2><h3 id="2-1-创建从库连接账号"><a href="#2-1-创建从库连接账号" class="headerlink" title="2.1 创建从库连接账号"></a>2.1 创建从库连接账号</h3><ul><li>在主库中创建一个，用于从库连接主库同步数据的账号，同步数据前会需要该账号与主库建立连接关系</li></ul><blockquote><p>&#x3D;&#x3D;授予权限&#x3D;&#x3D;：</p><p>Replication slave       | Server Admin       | To read binary log events from the master  </p><p>复制  从库服务器             服务器管理              从主库服务器读取二进制日志事件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看可授予的权限</span><br><span class="line">mysql&gt; show privileges; </span><br></pre></td></tr></table></figure></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>主库root用户先需有一个密码</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,authentication_string  <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span> <span class="operator">|</span> authentication_string                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> root <span class="operator">|</span> <span class="operator">*</span>E6CC90B878B948C35E92B003C792C46C58C4AF40 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>创建repl用户(主从复制中的通用用户名)，授予权限，设置密码</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>查看授予的权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> repl@<span class="string">&#x27;172.16.1.%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> repl<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.<span class="operator">%</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>查看用户连接白名单</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host,plugin <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span> host       <span class="operator">|</span> plugin                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> root          <span class="operator">|</span> localhost  <span class="operator">|</span> mysql_native_password <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.session <span class="operator">|</span> localhost  <span class="operator">|</span> mysql_native_password <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.sys     <span class="operator">|</span> localhost  <span class="operator">|</span> mysql_native_password <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> repl          <span class="operator">|</span> <span class="number">172.16</span><span class="number">.1</span>.<span class="operator">%</span> <span class="operator">|</span> mysql_native_password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+-----------------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="2-2-备份主库原有数据"><a href="#2-2-备份主库原有数据" class="headerlink" title="2.2 备份主库原有数据"></a>2.2 备份主库原有数据</h3><blockquote><p>当前主库已变更新数据，修改了root密码与创建了repl用户，导致主库数据变化</p><p>所以需要先同步原有数据到从库</p></blockquote><p><strong>备份参数</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>–single-transaction</td><td>类似于锁表，但是不影响业务新数据写入,可以保证备份数据的一致性<br />只适用于事务存储引擎仅InnoDB</td></tr><tr><td>–master-data</td><td>该选项将binlog日志的事务截止点追加到输出文件中；<br />如果为1，将会输出CHANGE MASTER命令； <br />如果为2，输出的CHANGE MASTER命令前添加注释信息</td></tr><tr><td>–triggers</td><td>导出表关联的触发器,该选项默认启用，–skip-triggers禁用功能</td></tr><tr><td>–routines, -R</td><td>导出存储过程以及自定义函数</td></tr><tr><td>–flush-logs，-F</td><td>备份的同时进行切割binlog日志，生成新的binlog记录新增量事务</td></tr><tr><td>–events, -E</td><td>导出所有事务</td></tr><tr><td>–max_allowed_packet</td><td>数据包传输大小设置，优化功能</td></tr><tr><td>–set-gtid-purged&#x3D;OFF</td><td>导出事务时，每个事务的GTID不跟随导出；GTID在每个实例中是唯一的，<br />若sql文件需要导入 其它实例中，就需要加上该参数，否则会报错无法导入</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>备份所有数据转为<span class="keyword">sql</span>语句导入文件中</span><br><span class="line">mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p  <span class="operator">-</span>A <span class="comment">--master-data=2 --single-transaction -R -E --triggers --max_allowed_packet=64M &gt; /app/data/mysql_all_bak.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>将<span class="keyword">sql</span>文件发送给slave从库机器</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">52</span> <span class="number">53</span></span><br><span class="line">do</span><br><span class="line">scp <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span>mysql_all_bak.sql root<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.$&#123;i&#125;:<span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="3-从库操作"><a href="#3-从库操作" class="headerlink" title="3.从库操作"></a>3.从库操作</h2><h3 id="3-1-复制主库原有数据"><a href="#3-1-复制主库原有数据" class="headerlink" title="3.1 复制主库原有数据"></a>3.1 复制主库原有数据</h3><p><strong>db51、db52从库机器操作：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>导入主库备份的<span class="keyword">sql</span>文件</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">&lt;</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span>mysql_all_bak.sql </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查是否同步</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select user,host from mysql.user&quot;</span><br></pre></td></tr></table></figure><h3 id="3-2-配置连接主库参数"><a href="#3-2-配置连接主库参数" class="headerlink" title="3.2 配置连接主库参数"></a>3.2 配置连接主库参数</h3><blockquote><p>执行如下参数信息，配置与主库的连接信息，从而连接主库，方可进行复制数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>查看备份文件中注释信息，binlog截止点与文件名，用于复制主库时填入参数信息</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#grep  <span class="operator">-</span>i <span class="string">&#x27;\-- change master&#x27;</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span>mysql_all_bak.sql </span><br><span class="line"><span class="comment">-- CHANGE MASTER TO MASTER_LOG_FILE=&#x27;mysql-bin.000002&#x27;, MASTER_LOG_POS=600;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>数据库中执行如下参数</span><br><span class="line">change master <span class="keyword">to</span> </span><br><span class="line">#主库机器ip</span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">#主库实例端口</span><br><span class="line">master_port<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">#连接主库的账号</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">#连接主库的密码</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">#从主库binlog哪里开始复制数据，以<span class="keyword">sql</span>文件中binlog截止点为准</span><br><span class="line">master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000003&#x27;</span>,</span><br><span class="line">master_log_pos<span class="operator">=</span><span class="number">856</span>,</span><br><span class="line">#断开连接后<span class="number">10</span>s后自动连接</span><br><span class="line">master_connect_retry<span class="operator">=</span><span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>精简</span><br><span class="line">change master <span class="keyword">to</span> </span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_port<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">master_log_pos<span class="operator">=</span><span class="number">596</span>,</span><br><span class="line">master_connect_retry<span class="operator">=</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure><h3 id="3-3-从库开启复制功能"><a href="#3-3-从库开启复制功能" class="headerlink" title="3.3 从库开启复制功能"></a>3.3 从库开启复制功能</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="3-4-检查从库复制状态"><a href="#3-4-检查从库复制状态" class="headerlink" title="3.4 检查从库复制状态"></a>3.4 检查从库复制状态</h3><p>&#x3D;&#x3D;保证如下两线程状态为yes，复制功能才是正常开启&#x3D;&#x3D;</p><table><thead><tr><th>两个重要线程</th><th>线程解释</th></tr></thead><tbody><tr><td>Slave_IO_Running：</td><td>表示I&#x2F;O的线程状态，I&#x2F;O线程负责从主库中读取Binlog日志，并将Binlog日志写入从库的中继日志中，状态为Yes表示I&#x2F;O线程工作正常，否则异常。</td></tr><tr><td>Slave_SQL_Running：</td><td>表示SQL的线程状态，SQL线程负责读取中继日志（relay-log）中的数据并转换为SQL语句应用到从数据库中，状态为Yes表示I&#x2F;O线程工作正常，否则异常。</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show slave status\G&quot;<span class="operator">|</span>egrep <span class="operator">-</span>iw <span class="string">&#x27;(slave_io|slave_sql)_running&#x27;</span></span><br><span class="line">Enter password: </span><br><span class="line">            Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><h2 id="4-测试主从复制"><a href="#4-测试主从复制" class="headerlink" title="4.测试主从复制"></a>4.测试主从复制</h2><blockquote><p>当前已然配置好了主从复制功能，模拟主库写入新数据，从库数据是否会更新与主库同步</p></blockquote><h3 id="4-1-主库写入新的数据"><a href="#4-1-主库写入新的数据" class="headerlink" title="4.1 主库写入新的数据"></a>4.1 主库写入新的数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>主库实例id</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@server_id</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@server_id</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">51</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>写入测试数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test.t1(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> test.t1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h3 id="4-2-从库检查数据复制"><a href="#4-2-从库检查数据复制" class="headerlink" title="4.2 从库检查数据复制"></a>4.2 从库检查数据复制</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>从库实例id</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@server_id</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@server_id</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">53</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查复制情况，成功复制</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="三、主从复制涉及线程文件"><a href="#三、主从复制涉及线程文件" class="headerlink" title="三、主从复制涉及线程文件"></a>三、主从复制涉及线程文件</h1><h2 id="1-主库线程"><a href="#1-主库线程" class="headerlink" title="1.主库线程"></a>1.主库线程</h2><blockquote><p>&#x3D;&#x3D;Binglog Dump线程：&#x3D;&#x3D;接收从库的复制请求，当主库有新事件发生，将binlog新事件信息发送给从库线程</p></blockquote><p><img src="/image-20240619115107998.png" alt="image-20240619115107998"></p><h2 id="2-从库线程"><a href="#2-从库线程" class="headerlink" title="2.从库线程"></a>2.从库线程</h2><blockquote><p>&#x3D;&#x3D;Slave_IO线程:&#x3D;&#x3D;请求主库binlog新事件信息，接收后将信息保存到relay中继日志中</p><p>&#x3D;&#x3D;Slave_SQL线程:&#x3D;&#x3D;读取relay中继日志中事件信息，转为sql语句进行复制数据</p></blockquote><p><img src="/image-20240619120715179.png" alt="image-20240619120715179"></p><p><img src="/image-20240619120831592.png" alt="image-20240619120831592"></p><h2 id="3-主库文件"><a href="#3-主库文件" class="headerlink" title="3.主库文件"></a>3.主库文件</h2><blockquote><p>主从复制会涉及主库的binlog日志</p><p>搭建主从复制后，当主库有新数据写入后，新数据会成为新事务保存到binlog日志中，再将新binlog记录转发给从库</p></blockquote><p><strong>binlog日志文件</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#查看历史所有binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">1018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>     <span class="number">1018</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#变量查看binlog所在路径</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sql_log_bin                     <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.06</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog日志文件</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span></span><br><span class="line">total <span class="number">8</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 1018 Jun 19 11:21 mysql-bin.000001</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql   37 Jun 18 19:15 mysql-bin.index</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#解密查看binlog日志</span><br><span class="line">mysqlbinlog  mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br></pre></td></tr></table></figure><h2 id="4-从库文件"><a href="#4-从库文件" class="headerlink" title="4.从库文件"></a>4.从库文件</h2><blockquote><p>主从复制涉及从库中的中继日志</p><p>从库io线程收到主库新生成的binlog信息，会将新的binlog记录，转储到从库中的中继日志当中</p><p>从库sql线程再通过relay日志中的sql语句，进行复制数据，实现主从复制的效果</p></blockquote><p><strong>中继日志文件</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#变量查看中继日志相关信息，relay日志所在地</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%relay%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name             <span class="operator">|</span> <span class="keyword">Value</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> max_relay_log_size        <span class="operator">|</span> <span class="number">0</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log                 <span class="operator">|</span>                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_basename        <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_index           <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_info_file       <span class="operator">|</span> relay<span class="operator">-</span>log.info                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_info_repository <span class="operator">|</span> FILE                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_purge           <span class="operator">|</span> <span class="keyword">ON</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_recovery        <span class="operator">|</span> OFF                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_space_limit     <span class="operator">|</span> <span class="number">0</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sync_relay_log            <span class="operator">|</span> <span class="number">10000</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sync_relay_log_info       <span class="operator">|</span> <span class="number">10000</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看中继日志文件</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#ll  <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin.<span class="operator">*</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 207 Jun 18 19:21 db-53-relay-bin.000001</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 995 Jun 19 13:32 db-53-relay-bin.000002</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  50 Jun 18 19:21 db-53-relay-bin.index</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#可解密查看中继日志记录的数据，其实就是一堆<span class="keyword">sql</span>语句，与主库的binlog记录相同</span><br><span class="line">mysqlbinlog   db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br></pre></td></tr></table></figure><p><strong>relay-log.info</strong></p><p>中继日志的最新截止点，以及对应的binlog最新截止点</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#cat relay<span class="operator">-</span>log.info </span><br><span class="line"><span class="number">7</span></span><br><span class="line">.<span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line"><span class="number">995</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line"><span class="number">1271</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong>master.info</strong></p><p>连接主库的相关信息，以及上次复制主库binlog的截止点，用于下次复制主库的binlog信息</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#cat master.info</span><br><span class="line"><span class="number">25</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line"><span class="number">1271</span></span><br><span class="line"><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">repl</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3306</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure><h1 id="四、主从复制监控"><a href="#四、主从复制监控" class="headerlink" title="四、主从复制监控"></a>四、主从复制监控</h1><blockquote><p>用于排查主从复制故障问题</p></blockquote><h2 id="1-主库监控"><a href="#1-主库监控" class="headerlink" title="1.主库监控"></a>1.主库监控</h2><ul><li>查看主库转储线程状态</li></ul><p><img src="/image-20240619143157278.png" alt="image-20240619143157278"></p><ul><li>查看从库连接信息</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave hosts;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------+------+-----------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Server_id <span class="operator">|</span> Host <span class="operator">|</span> Port <span class="operator">|</span> Master_id <span class="operator">|</span> Slave_UUID                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------+------+-----------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">53</span> <span class="operator">|</span>      <span class="operator">|</span> <span class="number">3306</span> <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span> <span class="number">8</span>fb6a834<span class="number">-2</span>d64<span class="number">-11</span>ef<span class="number">-879e-000</span>c29f56446 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------+------+-----------+--------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-从库监控"><a href="#2-从库监控" class="headerlink" title="2.从库监控"></a>2.从库监控</h2><ul><li><p>查看从库的复制状态详细信息</p><p>复制状态参数详解：<a href="https://www.cnblogs.com/paul8339/p/7615310.html">https://www.cnblogs.com/paul8339/p/7615310.html</a></p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure><h2 id="3-日志监控"><a href="#3-日志监控" class="headerlink" title="3.日志监控"></a>3.日志监控</h2><ul><li>查看IO线程已获取的主库binlog的位置点</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">Read_Master_Log_Pos: <span class="number">485</span></span><br></pre></td></tr></table></figure><ul><li>SQL线程回放的relaylog的位置点（中继日志自身的截止点）</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Relay_Log_File: db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000005</span></span><br><span class="line">Relay_Log_Pos: <span class="number">698</span></span><br></pre></td></tr></table></figure><ul><li>SQL线程回放relaylog的位置点，对应的主库的binlog位置点</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">Exec_Master_Log_Pos: <span class="number">485</span></span><br></pre></td></tr></table></figure><h1 id="五-主从复制故障解决"><a href="#五-主从复制故障解决" class="headerlink" title="五.主从复制故障解决"></a>五.主从复制故障解决</h1><h2 id="1-从库复制状态值"><a href="#1-从库复制状态值" class="headerlink" title="1.从库复制状态值"></a>1.从库复制状态值</h2><blockquote><p>Slave_IO_Running:                     # IO线程工作状态，yes，no，connection三个状态<br>Slave_SQL_Running:                    # SQL工作状态，yes ，no<br>Last_IO_Error:                        # IO故障代码，2003，1045，1040,1593,1236<br>Last_SQL_Errno: 0                     # SQL线程故障代码，1008，1007</p></blockquote><h2 id="2-故障常见原因"><a href="#2-故障常见原因" class="headerlink" title="2.故障常见原因"></a>2.故障常见原因</h2><blockquote><p>1.网络波动<br>2.master 连接信息错误，如端口，用户，密码，授权规则错误，复制无权限<br>3.防火墙拒绝请求<br>4.主机连接数到达上限<br>5.master、slave版本不一，5.7 、8.0、 5.6</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#查看数据库连接限制数量</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@max_connections</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@max_connections</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span>               <span class="number">151</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br></pre></td></tr></table></figure><h2 id="3-解决思路"><a href="#3-解决思路" class="headerlink" title="3.解决思路"></a>3.解决思路</h2><blockquote><ol><li>网络是否通</li><li>确认复制的change master配置正确</li><li>主从的server_id是否正常</li><li>主从的server_uuid是否正常</li><li>一般情况下，最直接暴力的解决办法，重新搭建主从备份数据+重新构建主从关系，能最快解决问题。</li></ol></blockquote><h1 id="六、主从复制之过滤复制"><a href="#六、主从复制之过滤复制" class="headerlink" title="六、主从复制之过滤复制"></a>六、主从复制之过滤复制</h1><blockquote><p>过滤库表复制就是只针对某个库或者某个表，进行数据的同步复制</p></blockquote><h2 id="1-配置参数说明"><a href="#1-配置参数说明" class="headerlink" title="1.配置参数说明"></a>1.配置参数说明</h2><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>replicate_do_db：</td><td>数据库白名单列表，多个数据库用逗号分隔，该选项指定的数据库会执行主从复制操作</td></tr><tr><td>replicate_ignore_db：</td><td>数据库黑名单列表，该选项指定的数据库将不会被复制</td></tr><tr><td>replicate_do_table：</td><td>表级别的白名单</td></tr><tr><td>replicate_ignore_table：</td><td>表级别的黑名单</td></tr><tr><td>replicate_wild_do_table：</td><td>可以使用通配符进行指定表，如%代表所有</td></tr><tr><td>replicate_wild_ignore_table：</td><td>可以使用通配符进行指定表，如%代表所有</td></tr></tbody></table><h2 id="2-过滤复制实践"><a href="#2-过滤复制实践" class="headerlink" title="2.过滤复制实践"></a>2.过滤复制实践</h2><h3 id="2-1-需求环境准备"><a href="#2-1-需求环境准备" class="headerlink" title="2.1 需求环境准备"></a>2.1 需求环境准备</h3><blockquote><p>从库进行白名单配置，只对主库的test库进行数据复制。主库其他数据变动一律不进行同步复制。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#主库准备</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="2-2-从库修改配置"><a href="#2-2-从库修改配置" class="headerlink" title="2.2 从库修改配置"></a>2.2 从库修改配置</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#修改配置文件</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">replicate_do_db<span class="operator">=</span>test  #对test库设置了白名单</span><br><span class="line">server_id<span class="operator">=</span><span class="number">53</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">[mysql] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">[client] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重启检查端口</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#systemctl restart mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">80</span>     [::]:<span class="number">3306</span>               [::]:<span class="operator">*</span>                   users:((&quot;mysqld&quot;,pid<span class="operator">=</span><span class="number">25016</span>,fd<span class="operator">=</span><span class="number">26</span>))</span><br></pre></td></tr></table></figure><h3 id="2-3-过滤复制测试"><a href="#2-3-过滤复制测试" class="headerlink" title="2.3 过滤复制测试"></a>2.3 过滤复制测试</h3><ul><li><strong>主库白名单之外新增数据，查看从库复制情况</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#主库模拟写入数据，创建<span class="keyword">new</span>库</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;create database new&quot;</span><br><span class="line">Enter password: </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#从库检查复制情况，白名单之外的数据不会复制，没有复制<span class="keyword">new</span>库</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure><ul><li><strong>主库白名单之内新增数据，查看从库复制情况</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#主库模拟写入数据，在test库新加入数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;insert into test.t1 values(55)&quot;</span><br><span class="line">Enter password: </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from test.t1&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">55</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#从库检查复制情况，对白名单test库进行数据复制，复制了主库新加的数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from test.t1 &quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">55</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br></pre></td></tr></table></figure><h1 id="七、主从复制搭建部署GTID"><a href="#七、主从复制搭建部署GTID" class="headerlink" title="七、主从复制搭建部署GTID"></a>七、主从复制搭建部署GTID</h1><h2 id="1-环境准备-1"><a href="#1-环境准备-1" class="headerlink" title="1.环境准备"></a>1.环境准备</h2><blockquote><p>基于GTID实现主从复制，主库与从库需要都得开启GTID功能</p><p>并且不能有一方使用pos值，一方使用GTID，会导致无法建立连接关系</p><p>主库开gtid，从库就得用gtid配置连接。主库不开gtid能用pos值配置连接。</p></blockquote><p><strong>db-51主库</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建数据存放目录与binlog存放目录,并且授权</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>&#123;tools,data,mysql_binlog&#125;</span><br><span class="line">mkdir <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>mysql_binlog</span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>下载安装mysql</span><br><span class="line">tar <span class="operator">-</span>xf mysql5<span class="number">.7</span>.tgz  <span class="operator">-</span>C <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>创建软链接加入PATH变量</span><br><span class="line">#软链接</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql5<span class="number">.7</span><span class="number">.20</span> <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">#环境变量添加</span><br><span class="line">cat <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>profile <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">export PATH<span class="operator">=</span>$PATH:<span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin</span><br><span class="line">EOF</span><br><span class="line">source <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">#检查</span><br><span class="line">mysql <span class="comment">--version</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>卸载mariadb依赖安装mysql专用依赖</span><br><span class="line">yum remove mariadb<span class="operator">-</span>libs<span class="number">-5.5</span><span class="number">.68</span><span class="number">-1.</span>el7.x86_64 <span class="operator">-</span>y</span><br><span class="line">yum install libaio<span class="operator">-</span>devel <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>修改配置文件，加入开启GTID参数</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span> </span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">character_set_server<span class="operator">=</span>utf8mb4 </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">log<span class="operator">-</span>error<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>error_3306.log</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>创建mysql进程运行用户，初始化数据库</span><br><span class="line">useradd <span class="operator">-</span>M <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/data/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>拷贝mysql自带启停脚本，到系统管理服务脚本路径下</span><br><span class="line">cp <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">systemctl enable mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>启动mysql检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">9.</span>检查GTID是否开启</span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> master status;</span><br></pre></td></tr></table></figure><p><strong>db-52、db-53从库</strong></p><p>:warning:从库server_id参数不能一样</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建数据存放目录并授权</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>&#123;tools,data&#125;</span><br><span class="line">mkdir <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>下载安装mysql</span><br><span class="line">tar <span class="operator">-</span>xf mysql5<span class="number">.7</span>.tgz  <span class="operator">-</span>C <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>创建软链接加入PATH变量</span><br><span class="line">#软链接</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql5<span class="number">.7</span><span class="number">.20</span> <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">#环境变量添加</span><br><span class="line">cat <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>profile <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">export PATH<span class="operator">=</span>$PATH:<span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin</span><br><span class="line">EOF</span><br><span class="line">source <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">#检查</span><br><span class="line">mysql <span class="comment">--version</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>卸载mariadb依赖安装mysql专用依赖</span><br><span class="line">yum remove mariadb<span class="operator">-</span>libs<span class="number">-5.5</span><span class="number">.68</span><span class="number">-1.</span>el7.x86_64 <span class="operator">-</span>y</span><br><span class="line">yum install libaio<span class="operator">-</span>devel <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>修改配置文件</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span> </span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">server_id<span class="operator">=</span><span class="number">52</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">[mysql] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">[client] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>创建mysql进程运行用户，初始化数据库</span><br><span class="line">useradd <span class="operator">-</span>M <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/data/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>拷贝mysql自带启停脚本，到系统管理服务脚本路径下</span><br><span class="line">cp <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">systemctl enable mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>启动mysql检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>检查GTID功能是否开启</span><br><span class="line">mysql <span class="operator">-</span>e &quot;show variables like &#x27;%gtid%&#x27;;&quot;</span><br></pre></td></tr></table></figure><h2 id="2-主库操作-1"><a href="#2-主库操作-1" class="headerlink" title="2.主库操作"></a>2.主库操作</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>修改root密码</span><br><span class="line">mysqladmin password <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>创建从库连接用户</span><br><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>,host  <span class="keyword">from</span>  mysql.user;</span><br></pre></td></tr></table></figure><h2 id="3-从库操作-1"><a href="#3-从库操作-1" class="headerlink" title="3.从库操作"></a>3.从库操作</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>配置主从复制参数</span><br><span class="line">#MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span> 该参数表示自动基于事务GTID进行复制，无需指定pos值与binlog文件名</span><br><span class="line">change master <span class="keyword">to</span> </span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_port<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>,</span><br><span class="line">master_connect_retry<span class="operator">=</span><span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>开启slave复制</span><br><span class="line"><span class="keyword">start</span> slave；</span><br></pre></td></tr></table></figure><h2 id="4-检查复制状态"><a href="#4-检查复制状态" class="headerlink" title="4.检查复制状态"></a>4.检查复制状态</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>检查slave复制状态</span><br><span class="line"><span class="keyword">show</span> slave status\G;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查slave线程</span><br><span class="line"><span class="keyword">show</span> processlist;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>检查master线程</span><br><span class="line"><span class="keyword">show</span> processlist;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>检查slave的relay截止点，与master的binlog截止点</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#cat <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>master.info </span><br><span class="line"><span class="number">25</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000003</span></span><br><span class="line"><span class="number">706</span></span><br><span class="line"><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">repl</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3306</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#cat <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>relay<span class="operator">-</span>log.info </span><br><span class="line"><span class="number">7</span></span><br><span class="line">.<span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line"><span class="number">919</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000003</span></span><br><span class="line"><span class="number">706</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="5-检查主从复制"><a href="#5-检查主从复制" class="headerlink" title="5.检查主从复制"></a>5.检查主从复制</h2><blockquote><p>主库新增数据，从库检查复制结果</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>主库db<span class="number">-51</span>新增数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@server_id</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@server_id</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">51</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database <span class="keyword">new</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>从库db<span class="number">-52</span>，db<span class="number">-53</span>检查复制结果</span><br><span class="line">#db<span class="number">-51</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">#db<span class="number">-52</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure><blockquote><p>至此，基于GTID的一主两从的主从复制就搭建好了</p></blockquote><h1 id="八、主从复制原理及图解"><a href="#八、主从复制原理及图解" class="headerlink" title="八、主从复制原理及图解"></a>八、主从复制原理及图解</h1><p>MySQL的主从复制是一个异步的复制过程（虽然一般情况下感觉是实时的），数据将从一个MySQL数据库（我们称之为Master）复制到另一个MySQL数据库（我们称之为Slave），在Master与Slave之间实现整个主从复制的过程是由<code>三个线程</code>参与完成的。</p><p>其中有两个线程（SQL线程和IO线程）在Slave端，另外一个线程（binlog dump线程）在Master端（MySQL 5及以前是3个线程完成复制，从MySQL 6起SQL线程可以是多个）。</p><blockquote><p>要实现MySQL的主从复制功能，首先必须打开Master端的binlog日志功能。</p></blockquote><p>因为整个复制过程实际上就是Slave从Master端获取binlog日志，然后再在Slave上以相同的顺序执行获取的binlog日志中所记录的各种SQL操作，从而实现主从数据一致的功能。</p><p><a href="http://book.bikongge.com/sre/2024-linux/image-20220727202229527.png">http://book.bikongge.com/sre/2024-linux/image-20220727202229527.png</a></p><p><img src="/image-20240619180310136.png" alt="image-20240619180310136"></p><ul><li>slave机器<code>start slave</code>，开启主从复制</li><li>slave机器的I&#x2F;O线程会通过在master上已授权的复制用户，连接master服务器<ul><li>通过该用户再从指定的binlog日志文件的指定位置，发送binlog日志的内容</li><li>（binglog文件名，pos值，都通过change master命令指定了）</li></ul></li><li>Master服务器接收到slave的I&#x2F;O线程请求之后，负责复制的binlog dump线程会根据slave服务器的I&#x2F;O线程的请求信息，进行读取binlog，以及pos值之后的日志信息<ul><li>然后返回给slave的I&#x2F;O线程</li><li>返回的信息除了binlog日志内容以外，以及master服务端新的binlog文件，以及POS值</li></ul></li><li>slave此时的I&#x2F;O线程接收到master发来的日志信息后，将binlog日志内容，写入到slave本身的relay-log中继日志中，如mysql-relay-bin.xxxxxx的末端<ul><li>并且记录新的binlog文件信息，名字、pos值，写入master-info文件中，用于下一次读取binlog数据时，可以明确知道数据读取的起点</li></ul></li><li>slave服务器的SQL线程会实时监测本地的Relay Log新增的日志内容，然后将Reloy Log文件中的内容，解析为SQL语句，且在自身slave按顺序执行这些SQL。</li></ul><p>经过这些，就可以确保，master和slave执行了同样的SQL。</p><p>在<code>复制状态正常</code>的情况下，master和slave的数据是完全一样的。</p><h2 id="主从复制原理小结"><a href="#主从复制原理小结" class="headerlink" title="主从复制原理小结"></a>主从复制原理小结</h2><ul><li>主从复制是异步的进行SQL语句的复制</li><li>复制时，主库有一个<code>binlog dump 线程</code>，从库有2个线程<code>I/O线程</code>、<code>SQL线程</code></li><li>在MySQL5.6之后，slave的SQL线程有多个</li><li>实现主从复制的必要条件、主库开启binlog，基于binlog复制</li><li>用于复制的所有mysql节点，server-id不能相同</li><li>binlog文件只记录数据库有<code>更改</code>的SQL，（主数据库有变化），对<code>select、show</code>以及未修改数据库的语句不会记录</li></ul><h2 id="主从复制起到的作用"><a href="#主从复制起到的作用" class="headerlink" title="主从复制起到的作用"></a>主从复制起到的作用</h2><ul><li>数据二次备份，数据安全</li><li>降低主库压力，后端程序书写代码，进行请求的转发进行读写分离，主库读，从库写</li><li>可以基于主从复制架构，通过高可用技术MHA等，实现数据库高可用性，故障自动切换</li></ul><h2 id="从库不开binlog原因"><a href="#从库不开binlog原因" class="headerlink" title="从库不开binlog原因"></a>从库不开binlog原因</h2><p>主从同步时slave为啥不能开binlog            </p><p>在MySQL数据库的主从同步架构中，通常只在主服务器（master）上开启binlog（二进制日志），而在从服务器（slave）上则不开启binlog。这一设计选择背后有几个关键原因：</p><h3 id="1-性能和资源考虑"><a href="#1-性能和资源考虑" class="headerlink" title="1. 性能和资源考虑"></a>1. 性能和资源考虑</h3><ul><li><strong>减少资源消耗</strong>：开启binlog会消耗额外的CPU和磁盘I&#x2F;O资源，因为MySQL需要记录所有的数据变更操作到binlog文件中。在从服务器上，这些资源应该优先用于处理查询和复制主服务器上的数据变更，而不是记录自己的binlog。</li><li><strong>避免不必要的日志生成</strong>：从服务器的角色是接收并应用主服务器上的binlog变更，以保持数据的一致性。它不需要再生成自己的binlog，因为这会增加系统的复杂性和资源消耗。</li></ul><h3 id="2-数据一致性和复制流程"><a href="#2-数据一致性和复制流程" class="headerlink" title="2. 数据一致性和复制流程"></a>2. 数据一致性和复制流程</h3><ul><li><strong>保持数据一致性</strong>：主从同步的核心是确保从服务器上的数据与主服务器保持一致。这通过从服务器读取并应用主服务器上的binlog来实现。如果在从服务器上开启binlog，那么这些日志将包含从服务器应用主服务器binlog变更后的结果，而不是原始的数据变更。这可能会引入数据不一致的风险。</li><li><strong>简化复制流程</strong>：在主从同步的架构中，复制流程是单向的，即从主服务器到从服务器。开启从服务器的binlog会打破这一单向性，使得复制流程变得更加复杂和难以管理。</li></ul><h3 id="3-实际应用场景"><a href="#3-实际应用场景" class="headerlink" title="3. 实际应用场景"></a>3. 实际应用场景</h3><ul><li><strong>读写分离</strong>：在主从同步的架构中，通常会将读操作分散到多个从服务器上，以减轻主服务器的压力。这些从服务器只需要接收并应用主服务器上的数据变更，而不需要记录自己的binlog。</li><li><strong>数据备份和恢复</strong>：如果需要备份从服务器上的数据，可以通过定期的全量备份和从主服务器同步的binlog来实现增量备份。这样，即使从服务器上没有开启binlog，也可以保证数据的完整性和可恢复性。</li></ul><h3 id="4-结论"><a href="#4-结论" class="headerlink" title="4. 结论"></a>4. 结论</h3><p>综上所述，从服务器在MySQL的主从同步架构中通常不开启binlog，这是出于性能和资源考虑、数据一致性和复制流程简化的需要。在实际应用中，这种设计选择有助于确保主从同步的稳定性和可靠性。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;一、主从复制架构概述&quot;&gt;&lt;a href=&quot;#一、主从复制架构概述&quot; class=&quot;headerlink&quot; title=&quot;一、主从复制架构概述&quot;&gt;&lt;/a&gt;一、主从复制架构概述&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;主从复制，以1台master主库机器，多台slave从库机</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-恢复数据</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE/</id>
    <published>2024-08-20T00:55:22.000Z</published>
    <updated>2024-08-20T00:58:44.602Z</updated>
    
    <content type="html"><![CDATA[<h1 id="全量逻辑备份与增量恢复"><a href="#全量逻辑备份与增量恢复" class="headerlink" title="全量逻辑备份与增量恢复"></a>全量逻辑备份与增量恢复</h1><h2 id="1-数据准备"><a href="#1-数据准备" class="headerlink" title="1.数据准备"></a>1.数据准备</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#创建库表数据</span><br><span class="line"><span class="keyword">create</span> database stu charset utf8mb4;</span><br><span class="line">use stu;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog记录</span><br><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000001&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="/image-20240609150656146.png" alt="image-20240609150656146"></p><h2 id="2-全量备份"><a href="#2-全量备份" class="headerlink" title="2.全量备份"></a>2.全量备份</h2><h3 id="2-1备份参数详解"><a href="#2-1备份参数详解" class="headerlink" title="2.1备份参数详解"></a>2.1备份参数详解</h3><p><a href="https://blog.csdn.net/weixin_39974140/article/details/114286173">https://blog.csdn.net/weixin_39974140/article/details/114286173</a></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>–single-transaction</td><td>该选项在导出数据之前提交一个BEGIN SQL语句，BEGIN 不会阻塞任何应用程序且能保证导出时<br>数据库的一致性状态,它只适用于事务存储引擎仅InnoDB</td></tr><tr><td>–master-data</td><td>该选项将binlog的位置和文件名追加到输出文件中；如果为1，将会输出CHANGE MASTER命令；<br>如果为2，输出的CHANGE MASTER命令前添加注释信息。</td></tr><tr><td>–triggers</td><td>导出表关联的触发器,该选项默认启用，–skip-triggers禁用功能</td></tr><tr><td>–routines, -R</td><td>导出存储过程以及自定义函数</td></tr><tr><td>–flush-logs，-F</td><td>备份的同时进行切割binlog日志，生成新的binlog记录新增量事务</td></tr><tr><td>–events, -E</td><td>导出所有事务</td></tr><tr><td>–max_allowed_packet</td><td>数据包传输大小设置，优化功能</td></tr><tr><td>–set-gtid-purged&#x3D;OFF</td><td>导出事务时，每个事务的GTID不跟随导出；GTID在每个实例中是唯一的，若sql文件需要导入<br />其它实例中，就需要加上该参数，否则会报错无法导入</td></tr></tbody></table><h3 id="2-2定时任务写入"><a href="#2-2定时任务写入" class="headerlink" title="2.2定时任务写入"></a>2.2定时任务写入</h3><blockquote><p>每周一晚上00.00全量备份数据库数据，并且切割刷新binlog日志，用于记录增量数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建存放备份数据目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mkdir <span class="operator">/</span>mysql_data_backup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>编写全量备份脚本，绝对路径执行mysqldump命令，否则放入定时任务无法备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#vim <span class="operator">/</span>mysql_data_backup<span class="operator">/</span>full_backup_all_mysql.sh</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cat <span class="operator">/</span>mysql_data_backup<span class="operator">/</span>full_backup_all_mysql.sh </span><br><span class="line">#<span class="operator">!</span><span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line"><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>F <span class="operator">-</span>R <span class="operator">-</span>E <span class="operator">-</span>A  <span class="comment">--master-data=2 --single-transaction  --max_allowed_packet=64M |gzip &gt;/mysql_data_backup/full_backup_all_`date +%F`.sql.gz</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>检查脚本是否可以进行成功备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#bash full_backup_all_mysql.sh  <span class="operator">&amp;</span><span class="operator">&gt;</span> backup.log</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#ls</span><br><span class="line">backup.log  full_backup_all_2024<span class="number">-06</span><span class="number">-09.</span>sql.gz  full_backup_all_mysql.sh</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#zcat full_backup_all2024<span class="number">-06</span><span class="number">-09.</span>sql.gz </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>降低数据库备份目录权限</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#chmod <span class="operator">-</span>R <span class="number">600</span> <span class="operator">/</span>mysql_data_backup<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls  <span class="operator">/</span>mysql_data_backup  <span class="operator">/</span>mysql_data_backup<span class="comment">/* -ld</span></span><br><span class="line"><span class="comment">drw-------. 2 root root  38 Jun  9 17:13 /mysql_data_backup</span></span><br><span class="line"><span class="comment">-rw-------. 1 root root 160 Jun  9 17:07 /mysql_data_backup/full_backup_all_mysql.sh</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">5.编写定时任务</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#vim  /var/spool/cron/root </span></span><br><span class="line"><span class="comment">[root@db-51 ~]#cat  /var/spool/cron/root </span></span><br><span class="line"><span class="comment">#1.Time synchronization</span></span><br><span class="line"><span class="comment">* * * * *       /usr/sbin/ntpdate time1.aliyun.com &gt; /dev/null 2&gt;&amp;1</span></span><br><span class="line"><span class="comment">#2.Mysql all data full backup</span></span><br><span class="line"><span class="comment">00 00 * * 1     /usr/bin/bash  /mysql_data_backup/full_backup_all_mysql.sh &amp;&gt;/dev/null</span></span><br></pre></td></tr></table></figure><ul><li><strong>修改时间，模拟全量备份完成</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#修改时间</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#<span class="type">date</span> <span class="operator">-</span>s <span class="number">20240610</span></span><br><span class="line">Mon Jun <span class="number">10</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">2024</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#<span class="type">date</span></span><br><span class="line">Mon Jun <span class="number">10</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">11</span> CST <span class="number">2024</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#<span class="type">date</span> <span class="operator">+</span><span class="operator">%</span>w</span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line">#检查备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#ll</span><br><span class="line">total <span class="number">12</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  20 Jun 10 00:00 full_backup_all_2024-06-10.sql.gz</span></span><br><span class="line"><span class="operator">-</span>rw<span class="comment">-------. 1 root root 169 Jun  9 17:40 full_backup_all_mysql.sh</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#zcat full_backup_all_2024<span class="number">-06</span><span class="number">-10.</span>sql.gz </span><br></pre></td></tr></table></figure><h2 id="3-增量写入"><a href="#3-增量写入" class="headerlink" title="3.增量写入"></a>3.增量写入</h2><ul><li><strong>查看当前binlog日志，已经进行刷新</strong></li></ul><p><img src="/image-20240609185801391.png" alt="image-20240609185801391"></p><ul><li><strong>模拟第二天在新的binlog中记录增量写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#增量写入</span><br><span class="line">mysql<span class="operator">&gt;</span> use stu;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t2(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t2 <span class="keyword">values</span>(<span class="number">66</span>),(<span class="number">77</span>),(<span class="number">88</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240609190302473.png" alt="image-20240609190302473"></p><h2 id="4-模拟误删"><a href="#4-模拟误删" class="headerlink" title="4.模拟误删"></a>4.模拟误删</h2><ul><li><strong>模拟删除stu库</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database stu;</span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查不到数据了</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span>  stu;</span><br><span class="line">ERROR <span class="number">1049</span> (<span class="number">42000</span>): <span class="literal">Unknown</span> database <span class="string">&#x27;stu&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240609190417594.png" alt="image-20240609190417594"></p><h2 id="5-恢复数据"><a href="#5-恢复数据" class="headerlink" title="5.恢复数据"></a>5.恢复数据</h2><blockquote><blockquote><p>当前发现stu库被删除，但是目前binlog中只记录了，针对stu库写入的增量数据，只能恢复部分数据</p><p>可以与全量备份结合恢复，全量备份数据后，再次对事务的提交称之为增量备份，全量+增量即可恢复全部</p></blockquote><p>&#x3D;&#x3D;恢复思路：&#x3D;&#x3D;</p><p>&#x3D;&#x3D;1.&#x3D;&#x3D;关闭binlog记录</p><p>&#x3D;&#x3D;2.&#x3D;&#x3D;使用全量备份的数据进行恢复，可以恢复重置增量前的所有数据</p><p>&#x3D;&#x3D;3.&#x3D;&#x3D;再通过增量的事务GTID，截取删除事务相关的所有增量写入</p><p>&#x3D;&#x3D;4.&#x3D;&#x3D;开启binlog记录</p></blockquote><h3 id="5-1临时关闭binlog"><a href="#5-1临时关闭binlog" class="headerlink" title="5.1临时关闭binlog"></a>5.1临时关闭binlog</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set sql_log_bin=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select @@sql_log_bin;</span><br><span class="line">+---------------+</span><br><span class="line">| @@sql_log_bin |</span><br><span class="line">+---------------+</span><br><span class="line">|             0 |</span><br><span class="line">+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="5-2全量数据恢复"><a href="#5-2全量数据恢复" class="headerlink" title="5.2全量数据恢复"></a>5.2全量数据恢复</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>备份数据如下</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#ll</span><br><span class="line">total <span class="number">212</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 211310 Jun 10 00:00 full_backup_all_2024-06-10.sql.gz</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>解压缩</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#gzip <span class="operator">-</span>d full_backup_all_2024<span class="number">-06</span><span class="number">-10.</span>sql.gz </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#ll</span><br><span class="line">total <span class="number">772</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 782412 Jun 10 00:00 full_backup_all_2024-06-10.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>导入数据库恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>mysql_data_backup<span class="operator">/</span>full_backup_all_2024<span class="number">-06</span><span class="number">-10.</span><span class="keyword">sql</span></span><br></pre></td></tr></table></figure><h3 id="5-3增量日志截取恢复"><a href="#5-3增量日志截取恢复" class="headerlink" title="5.3增量日志截取恢复"></a>5.3增量日志截取恢复</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#截取增量binlog日志</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;f695ab86-2303-11ef-bf61-000c2939adaa:4-5&#x27; mysql-bin.000002 &gt; /root/increase.sql</span></span><br><span class="line"></span><br><span class="line">#导出的日志检查是否是要恢复的数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#cat <span class="operator">/</span>root<span class="operator">/</span>increase.sql </span><br></pre></td></tr></table></figure><p><img src="/image-20240609193724194.png" alt="image-20240609193724194"></p><ul><li><strong>导出的增量数据日志文件，导入到数据库中进行恢复</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll</span><br><span class="line">total <span class="number">4</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 2061 Jun 10 01:02 increase.sql</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>increase.sql</span><br></pre></td></tr></table></figure><h3 id="5-4检查数据恢复"><a href="#5-4检查数据恢复" class="headerlink" title="5.4检查数据恢复"></a>5.4检查数据恢复</h3><blockquote><p>恢复数据成功</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">66</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">88</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="5-5开启binlog记录"><a href="#5-5开启binlog记录" class="headerlink" title="5.5开启binlog记录"></a>5.5开启binlog记录</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@sql_log_bin</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@sql_log_bin</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span>             <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="xtra全量物理备份与恢复"><a href="#xtra全量物理备份与恢复" class="headerlink" title="xtra全量物理备份与恢复"></a>xtra全量物理备份与恢复</h1><blockquote><p>逻辑备份在数据较大的情况下备份速度较慢，而物理备份主要用于数据较大的场景进行备份</p><p>原理上就是对实例数据目录下方的数据文件进行备份；拷贝文件压缩，恢复时将数据文件导入实例数据目录下即可</p><p>通过xtrabackup这个备份工具实现全量物理备份</p></blockquote><h2 id="1-xtrabackup概述"><a href="#1-xtrabackup概述" class="headerlink" title="1.xtrabackup概述"></a>1.xtrabackup概述</h2><p>Percona-xtrabackup是 Percona公司开发的一个用于MySQL数据库物理热备的备份工具，支持MySQL、Percona server和MariaDB，开源免费，是目前较为受欢迎的主流备份工具。</p><p>&#x3D;&#x3D;xtrabackup只能备份innoDB和xtraDB两种数据引擎的表，而不能备份MyISAM数据表。&#x3D;&#x3D;</p><ul><li><strong>xtrabackup特点：</strong><ul><li>物理备份工具，拷贝数据文件</li><li>备份和恢复数据的速度非常快，安全可靠</li><li>在备份期间执行的事务不会间断，备份<code>innodb</code>数据不影响业务</li><li>备份期间不增加太多数据库的性能压力</li><li>支持对备份的数据自动校验</li><li>运行全量，增量，压缩备份及流备份</li><li>支持在线迁移表以及快速创建新的从库</li><li>运行几乎所有版本的<code>mysql</code>和<code>maridb</code></li></ul></li></ul><h3 id="1-1安装工具"><a href="#1-1安装工具" class="headerlink" title="1.1安装工具"></a>1.1安装工具</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#安装程序运行环境（perl语言解释器，连接mysql的驱动等）</span><br><span class="line">yum install perl perl<span class="operator">-</span>devel libaio libaio<span class="operator">-</span>devel perl<span class="operator">-</span><span class="type">Time</span><span class="operator">-</span>HiRes perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下载xtrabackup<span class="operator">-</span>rpm包</span><br><span class="line">wget https:<span class="operator">/</span><span class="operator">/</span>www.percona.com<span class="operator">/</span>downloads<span class="operator">/</span>XtraBackup<span class="operator">/</span>Percona<span class="operator">-</span>XtraBackup<span class="number">-2.4</span><span class="number">.9</span><span class="operator">/</span><span class="type">binary</span><span class="operator">/</span>redhat<span class="operator">/</span><span class="number">7</span><span class="operator">/</span>x86_64<span class="operator">/</span>percona<span class="operator">-</span>xtrabackup<span class="number">-24</span><span class="number">-2.4</span><span class="number">.9</span><span class="number">-1.</span>el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#安装xtrabackup</span><br><span class="line">yum localinstall percona<span class="operator">-</span>xtrabackup<span class="number">-24</span><span class="number">-2.4</span><span class="number">.9</span><span class="number">-1.</span>el7.x86_64.rpm <span class="operator">-</span>y</span><br></pre></td></tr></table></figure><h3 id="1-2命令参数"><a href="#1-2命令参数" class="headerlink" title="1.2命令参数"></a>1.2命令参数</h3><p><strong>Xtrabackup中主要包含两个命令工具：</strong></p><p> &#x3D;&#x3D;1.xtrabackup：&#x3D;&#x3D;</p><p> Xtrabackup命令是专门用于对InnoDB和XtraDB等事务引擎的数据库热备份的工具，不能用于备份MyISAM等其他类型的引擎数据，</p><p> 其主要特点是备份数据时完全不用锁表。</p><p> &#x3D;&#x3D;2.innobackupex（DBA用的最多的是Innobackupex命令备份恢复）：&#x3D;&#x3D;</p><p> Innobackupex命令是将上述Xtrabackup命令使用perl脚本进行二次封装的工具，除了可以用于InnoDB和XtraDB等引擎之外，</p><p> 还可以备份MyISAM及多种引擎混合使用的场景，主要特点是备份事务引擎数据而不用锁表，可以备份非事务引擎数据，但要锁表。</p><p>&#x3D;&#x3D;常用参数：&#x3D;&#x3D;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>备份所用参数</span><br><span class="line"><span class="comment">--host     指定主机</span></span><br><span class="line"><span class="comment">--user     指定用户名</span></span><br><span class="line"><span class="comment">--password    指定密码</span></span><br><span class="line"><span class="comment">--port     指定端口</span></span><br><span class="line"><span class="comment">--databases     指定数据库</span></span><br><span class="line"><span class="comment">--incremental    创建增量备份</span></span><br><span class="line"><span class="comment">--incremental-basedir   指定包含完全备份的目录</span></span><br><span class="line"><span class="comment">--incremental-dir      指定包含增量备份的目录   </span></span><br><span class="line"><span class="comment">--apply-log        对备份进行预处理操作   </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="number">2.</span>恢复所用参数</span><br><span class="line"><span class="comment">--redo-only      回滚未提交事务</span></span><br><span class="line">#参数详解</span><br><span class="line">#https:<span class="operator">/</span><span class="operator">/</span>blog<span class="number">.51</span>cto.com<span class="operator">/</span>u_15080021<span class="operator">/</span><span class="number">2642159</span></span><br><span class="line">#<span class="operator">-</span> 备份完成后数据尚且不能用于恢复操作</span><br><span class="line">#<span class="operator">-</span> 因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务</span><br><span class="line">#<span class="operator">-</span> 因此此时数据文件仍处理不一致状态</span><br><span class="line">#<span class="operator">-</span> 该参数作用是通过回滚未提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--copy-back      恢复备份目录</span></span><br><span class="line"><span class="comment">--use-memory=32M        使用32M内存进行恢复，对内存限制，防止占用过多机器资源</span></span><br></pre></td></tr></table></figure><p>- </p><p><img src="/image-20240609202957221.png" alt="image-20240609202957221"></p><h2 id="2-全量备份与恢复"><a href="#2-全量备份与恢复" class="headerlink" title="2.全量备份与恢复"></a>2.全量备份与恢复</h2><h3 id="2-1全量备份数据"><a href="#2-1全量备份数据" class="headerlink" title="2.1全量备份数据"></a>2.1全量备份数据</h3><blockquote><p>语法：<br>innobackupex  连接实例参数    备份数据存放目录（若不存在自动创建，并创建时间戳子目录）</p></blockquote><ul><li>1.保证GTID模式开启</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span>  <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%GTID%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>备份数据库实例所有数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#备份数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--user=root  --password=1  -S /tmp/mysql.sock  /xtrabackup_data/ </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#自动以时间戳创建存放数据的目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>xtrabackup_data<span class="operator">/</span></span><br><span class="line"><span class="number">2024</span><span class="number">-06</span><span class="number">-10</span>_02<span class="number">-33</span><span class="number">-45</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#除了备份的数据外还生成了许多备份相关文件</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>xtrabackup_data<span class="operator">/</span><span class="number">2024</span><span class="number">-06</span><span class="number">-10</span>_02<span class="number">-33</span><span class="number">-45</span><span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">13644</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      425 Jun 10 02:33 backup-my.cnf</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      474 Jun 10 02:33 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 12582912 Jun 10 02:33 ibdata1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     4096 Jun 10 02:33 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 02:33 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root       76 Jun 10 02:33 stu</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 02:33 sys</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root       62 Jun 10 02:33 xtrabackup_binlog_info</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      113 Jun 10 02:33 xtrabackup_checkpoints</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      560 Jun 10 02:33 xtrabackup_info</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root  1338880 Jun 10 02:33 xtrabackup_logfile</span></span><br></pre></td></tr></table></figure><h3 id="2-2备份生成的文件"><a href="#2-2备份生成的文件" class="headerlink" title="2.2备份生成的文件"></a>2.2备份生成的文件</h3><table><thead><tr><th>生成的文件</th><th>说明</th></tr></thead><tbody><tr><td>xtrabackup_checkpoints文件</td><td>备份的类型全量备份还是增量备份，lns号记录数据不一致时分析</td></tr><tr><td>xtrabackup_info文件</td><td>备份的具体详细信息，时间、版本、命令、binlog截止点等</td></tr><tr><td>xtrabackup_binlog_info文件</td><td>备份的最后一个事务的binlog信息与位置</td></tr><tr><td>backup-my.cnf文件</td><td>备份时根据该配置文件进行相应的备份动作</td></tr><tr><td>xtrabackup_logfile</td><td>备份数据过程的日志信息，加密的二进制文件</td></tr></tbody></table><h3 id="2-3自定义备份数据存放目录"><a href="#2-3自定义备份数据存放目录" class="headerlink" title="2.3自定义备份数据存放目录"></a>2.3自定义备份数据存放目录</h3><p>&#x3D;&#x3D;备份数据后，默认会生成一个时间戳目录存放备份的数据&#x3D;&#x3D;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 /xtrabackup_data/2024-06-10_02-33-45]#ls /xtrabackup_data/</span><br><span class="line">2024-06-10_02-33-45</span><br></pre></td></tr></table></figure><p>&#x3D;&#x3D;指定备份数据存放的目录，不生成时间戳命名的目录&#x3D;&#x3D;</p><blockquote><p>语法：</p><p>innobackupex  –no-timestamp（关闭时间戳）   连接实例参数     自定义备份路径</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#备份参数</span><br><span class="line">innobackupex <span class="comment">--no-timestamp --user=root --password=1 -S /tmp/mysql.sock /xtrabackup_data/full_backup_`date +%F_%T`/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看备份数据存放目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 234 Jun 10 10:45 full_backup_2024-06-10_10:45:36</span></span><br></pre></td></tr></table></figure><h3 id="2-4全量恢复数据"><a href="#2-4全量恢复数据" class="headerlink" title="2.4全量恢复数据"></a>2.4全量恢复数据</h3><p><strong>模拟删除数据</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span></span><br><span class="line">auto.cnf   ib_buffer_pool  ib_logfile0  ibtmp1  mysql               stu</span><br><span class="line">db<span class="number">-51.</span>pid  ibdata1         ib_logfile1  logs    performance_schema  sys</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mkdir <span class="operator">/</span>tmp<span class="operator">/</span><span class="number">3306</span>_data</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mv <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="comment">/*  /tmp/3306_data/</span></span><br></pre></td></tr></table></figure><p><strong>全量恢复数据</strong></p><ul><li>确保备份数据一致性，回滚未提交事务的一条命令</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innobackupex <span class="comment">--apply-log  /xtrabackup_data/full_backup_2024-06-10_10\:45\:36/</span></span><br></pre></td></tr></table></figure><ul><li>进行恢复</li></ul><blockquote><p>语法：</p><p>&#x3D;&#x3D;innobackupex&#x3D;&#x3D; &#x3D;&#x3D;–defaults-file&#x3D;&#x2F;etc&#x2F;my.conf&#x3D;&#x3D;(会调用配置文件中数据目录路径进行恢复)  &#x3D;&#x3D;–copy-back&#x3D;&#x3D;</p><p>&#x3D;&#x3D;–rsync&#x3D;&#x3D;（内置了rsync工具，进行拷贝数据）       &#x3D;&#x3D;备份数据的路径&#x3D;&#x3D;</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#恢复数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--defaults-file=/etc/my.cnf --copy-back --rsync /xtrabackup_data/full_backup_2024-06-10_10\:45\:36/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#恢复后数据授权mysql用户，否则无法调用某些数据进行启动</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span></span><br><span class="line">total <span class="number">122920</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      474 Jun 10 11:32 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 Jun 10 11:32 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun 10 11:32 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun 10 11:32 ib_logfile1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 Jun 10 11:32 ibtmp1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 Jun 10 11:32 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun 10 11:32 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql       76 Jun 10 11:32 stu</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun 10 11:32 sys</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql       21 Jun 10 11:32 xtrabackup_binlog_pos_innodb</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      607 Jun 10 11:32 xtrabackup_info</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重启检查端口</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl restart  mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">80</span>     [::]:<span class="number">3306</span>               [::]:<span class="operator">*</span>                   users:((&quot;mysqld&quot;,pid<span class="operator">=</span><span class="number">9329</span>,fd<span class="operator">=</span><span class="number">32</span>))</span><br></pre></td></tr></table></figure><h3 id="2-5检查数据恢复"><a href="#2-5检查数据恢复" class="headerlink" title="2.5检查数据恢复"></a>2.5检查数据恢复</h3><blockquote><p>数据恢复成功</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">66</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">88</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="xtra全量增量备份与恢复"><a href="#xtra全量增量备份与恢复" class="headerlink" title="xtra全量增量备份与恢复"></a>xtra全量增量备份与恢复</h1><blockquote><p>全量备份是对全部的数据进行备份，如果放入定时任务每天使用全量备份，会导致占用大量服务器资源磁盘空间</p><p>增量备份是对全量备份后，新生成的数据进行一个备份，最后可以将增量备份的数据合并到全量备份中，就是一个完整的数据</p></blockquote><h2 id="1-全量与增量备份数据"><a href="#1-全量与增量备份数据" class="headerlink" title="1.全量与增量备份数据"></a>1.全量与增量备份数据</h2><h3 id="1-1备份前数据准备"><a href="#1-1备份前数据准备" class="headerlink" title="1.1备份前数据准备"></a>1.1备份前数据准备</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stu                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">66</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">88</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="1-2第一天全量备份"><a href="#1-2第一天全量备份" class="headerlink" title="1.2第一天全量备份"></a>1.2第一天全量备份</h3><blockquote><p>增量备份前，必须得有一个全量备份的数据，才可以进行增量备份</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#全量备份命令</span><br><span class="line">innobackupex <span class="comment">--no-timestamp  --user=root -S /tmp/mysql.sock --password=1 /xtrabackup_data/full_1_`date +%F</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#存放全量数据的目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span></span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 234 Jun 10 15:57 full_1_2024-06-10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#备份的数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>full_1_2024<span class="number">-06</span><span class="number">-10</span><span class="operator">/</span></span><br><span class="line">total <span class="number">12340</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      425 Jun 10 15:57 backup-my.cnf</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      834 Jun 10 15:57 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 12582912 Jun 10 15:57 ibdata1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     4096 Jun 10 15:57 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 15:57 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root       76 Jun 10 15:57 stu</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 15:57 sys</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root       62 Jun 10 15:57 xtrabackup_binlog_info</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      113 Jun 10 15:57 xtrabackup_checkpoints</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      592 Jun 10 15:57 xtrabackup_info</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root     2560 Jun 10 15:57 xtrabackup_logfile</span></span><br></pre></td></tr></table></figure><h3 id="1-3第二天增量备份"><a href="#1-3第二天增量备份" class="headerlink" title="1.3第二天增量备份"></a>1.3第二天增量备份</h3><ul><li><strong>模拟全量备份后第二天新数据写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> stu.t1 <span class="keyword">values</span>(<span class="number">4</span>),(<span class="number">5</span>),(<span class="number">6</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240610160237672.png" alt="image-20240610160237672"></p><ul><li><strong>增量备份新数据</strong></li></ul><blockquote><p>语法：</p><p>&#x3D;&#x3D;innobackupex&#x3D;&#x3D; &#x3D;&#x3D;–defaults-file&#x3D;&#x3D;&#x3D;（实例配置文件）  &#x3D;&#x3D;连接实例参数&#x3D;&#x3D; &#x3D;&#x3D;–no-timestamp&#x3D;&#x3D;（取消生成时间戳目录）</p><p>&#x3D;&#x3D;–increamental-basedor&#x3D;&#x3D;&#x3D;（指定上一次备份的数据） &#x3D;&#x3D;–incaremental&#x3D;&#x3D;（增量备份功能）&#x3D;&#x3D;备份存放的路径&#x3D;&#x3D;</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#增量数据备份命令</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--defaults-file=/etc/my.cnf --user=root --password=1 --socket=/tmp/mysql.sock --no-timestamp --incremental-basedir=/xtrabackup_data/full_1_2024-06-10/   --incremental  /xtrabackup_data/inc1_`date +%F`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数据存放目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>inc1_2024<span class="number">-06</span><span class="number">-10</span><span class="operator">/</span> <span class="operator">-</span>d</span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:16 /xtrabackup_data/inc1_2024-06-11</span></span><br></pre></td></tr></table></figure><h3 id="1-4第三天增量备份"><a href="#1-4第三天增量备份" class="headerlink" title="1.4第三天增量备份"></a>1.4第三天增量备份</h3><ul><li><strong>模拟第二天增量备份后，第三天新数据写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t3(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t3 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t3;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p><img src="/image-20240610162155986.png" alt="image-20240610162155986"></p><ul><li><strong>增量数据备份</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注意<span class="comment">--incremental-basedir=上一次的备份数据目录，也就是第一次增量备份数据目录</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--defaults-file=/etc/my.cnf --user=root --password=1 --socket=/tmp/mysql.sock --no-timestamp --incremental-basedir=/xtrabackup_data/inc1_2024-06-10/   --incremental  /xtrabackup_data/inc2_`date +%F`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第二次备份的数据存放目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll  <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>inc2_2024<span class="number">-06</span><span class="number">-10</span><span class="operator">/</span> <span class="operator">-</span>d</span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:23 /xtrabackup_data/inc2_2024-06-12/</span></span><br></pre></td></tr></table></figure><h3 id="1-5第四天增量备份"><a href="#1-5第四天增量备份" class="headerlink" title="1.5第四天增量备份"></a>1.5第四天增量备份</h3><ul><li><strong>模拟上次增量备份后，第四天写入的新数据</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t4(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t4 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t4;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>第四天0.00再次增量备份</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--defaults-file=/etc/my.cnf --user=root --password=1 --socket=/tmp/mysql.sock --no-timestamp --incremental-basedir=/xtrabackup_data/inc2_2024-06-10/   --incremental  /xtrabackup_data/inc3_`date +%F`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>inc3_2024<span class="number">-06</span><span class="number">-10</span> <span class="operator">-</span>d</span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:29 /xtrabackup_data/inc3_2024-06-13</span></span><br></pre></td></tr></table></figure><h3 id="1-6第五天还未备份误删除数据"><a href="#1-6第五天还未备份误删除数据" class="headerlink" title="1.6第五天还未备份误删除数据"></a>1.6第五天还未备份误删除数据</h3><ul><li><strong>模拟第四天00.00增量备份后，第五天新数据写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#创建的新库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database no_backup;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> no_backup          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stu                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#新表</span><br><span class="line">mysql<span class="operator">&gt;</span> use no_backup;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> no_backup_of_delete(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">#新数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> no_backup_of_delete <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">#数据查看</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> no_backup_of_delete;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>模拟还未开始第五日00.00的增量备份，数据被误删除了</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl stop mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mkdir <span class="operator">/</span>tmp<span class="operator">/</span><span class="number">3306</span>_data</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mv <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="comment">/* /tmp/3306_data/</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#ll /app/data/3306/</span></span><br><span class="line"><span class="comment">total 0</span></span><br></pre></td></tr></table></figure><h2 id="2-全量增量备份结合binlog恢复"><a href="#2-全量增量备份结合binlog恢复" class="headerlink" title="2.全量增量备份结合binlog恢复"></a>2.全量增量备份结合binlog恢复</h2><blockquote><p>查看当前已备份的数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>xtrabackup_data<span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 234 Jun 10 15:57 full_1_2024-06-10</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:16 inc1_2024-06-11</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:23 inc2_2024-06-12</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:29 inc3_2024-06-13</span></span><br></pre></td></tr></table></figure><h3 id="1-全量数据一致性处理"><a href="#1-全量数据一致性处理" class="headerlink" title="1.全量数据一致性处理"></a>1.全量数据一致性处理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innobackupex <span class="comment">--apply-log   --redo-only /xtrabackup_data/full_1_2024-06-10/</span></span><br></pre></td></tr></table></figure><h3 id="2-合并inc-1到full"><a href="#2-合并inc-1到full" class="headerlink" title="2.合并inc_1到full"></a>2.合并inc_1到full</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>xtrabackup_data<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--apply-log   --redo-only --incremental-dir=inc1_2024-06-11  full_1_2024-06-10/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">合并完毕后，检查结果</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#grep <span class="string">&#x27;to_lsn&#x27;&#x27;full_1_2024-06-10/xtrabackup_checkpoints&#x27;</span></span><br><span class="line">to_lsn <span class="operator">=</span> <span class="number">5466750</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#grep <span class="string">&#x27;to_lsn&#x27;</span> <span class="string">&#x27;inc1_2024-06-11/xtrabackup_checkpoints&#x27;</span></span><br><span class="line">to_lsn <span class="operator">=</span> <span class="number">5466750</span></span><br></pre></td></tr></table></figure><h3 id="3-合并inc-2到full"><a href="#3-合并inc-2到full" class="headerlink" title="3.合并inc_2到full"></a>3.合并inc_2到full</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--apply-log   --redo-only --incremental-dir=inc2_2024-06-12  full_1_2024-06-10/</span></span><br></pre></td></tr></table></figure><h3 id="4-合并inc-3到full"><a href="#4-合并inc-3到full" class="headerlink" title="4.合并inc_3到full"></a>4.合并inc_3到full</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--apply-log   --redo-only --incremental-dir=inc3_2024-06-13  full_1_2024-06-10/</span></span><br></pre></td></tr></table></figure><h3 id="5-最终数据一致性校验检查"><a href="#5-最终数据一致性校验检查" class="headerlink" title="5.最终数据一致性校验检查"></a>5.最终数据一致性校验检查</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--apply-log    full_1_2024-06-10/</span></span><br></pre></td></tr></table></figure><p>整个流程，都得看到结尾的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InnoDB: Starting shutdown...</span><br><span class="line">InnoDB: Shutdown completed; log sequence number <span class="number">5479479</span></span><br><span class="line"><span class="number">240610</span> <span class="number">17</span>:<span class="number">41</span>:<span class="number">13</span> completed OK<span class="operator">!</span></span><br></pre></td></tr></table></figure><h3 id="6-全量增量备份数据恢复"><a href="#6-全量增量备份数据恢复" class="headerlink" title="6.全量增量备份数据恢复"></a>6.全量增量备份数据恢复</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#恢复数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--copy-back full_1_2024-06-10/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#ls <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">122920</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      834 Jun 10 17:43 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 12582912 Jun 10 17:43 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 50331648 Jun 10 17:43 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 50331648 Jun 10 17:43 ib_logfile1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 12582912 Jun 10 17:43 ibtmp1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     4096 Jun 10 17:43 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 17:43 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root      132 Jun 10 17:43 stu</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 17:43 sys</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root       22 Jun 10 17:43 xtrabackup_binlog_pos_innodb</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      743 Jun 10 17:43 xtrabackup_info</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数据目录授权</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="comment">/*</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#ll /app/data/3306/</span></span><br><span class="line"><span class="comment">total 122920</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql      834 Jun 10 17:43 ib_buffer_pool</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql 12582912 Jun 10 17:43 ibdata1</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql 50331648 Jun 10 17:43 ib_logfile0</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql 50331648 Jun 10 17:43 ib_logfile1</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql 12582912 Jun 10 17:43 ibtmp1</span></span><br><span class="line"><span class="comment">drwxr-x---. 2 mysql mysql     4096 Jun 10 17:43 mysql</span></span><br><span class="line"><span class="comment">drwxr-x---. 2 mysql mysql     8192 Jun 10 17:43 performance_schema</span></span><br><span class="line"><span class="comment">drwxr-x---. 2 mysql mysql      132 Jun 10 17:43 stu</span></span><br><span class="line"><span class="comment">drwxr-x---. 2 mysql mysql     8192 Jun 10 17:43 sys</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql       22 Jun 10 17:43 xtrabackup_binlog_pos_innodb</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql      743 Jun 10 17:43 xtrabackup_info</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line"><span class="comment">[[root@db-51 ~]#systemctl restart mysqld</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#ss -tunlp|grep 3306</span></span><br><span class="line"><span class="comment">tcp    LISTEN     0      80     [::]:3306               [::]:*                   users:((&quot;mysqld&quot;,pid=10353,fd=31))</span></span><br></pre></td></tr></table></figure><h3 id="7-检查备份数据的恢复"><a href="#7-检查备份数据的恢复" class="headerlink" title="7.检查备份数据的恢复"></a>7.检查备份数据的恢复</h3><blockquote><p>目前只还原了全量+inc_1 + inc_2 + inc_3 的数据，第五天新增的no_backup库与数据并没有恢复</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stu                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="8-binlog恢复未备份数据"><a href="#8-binlog恢复未备份数据" class="headerlink" title="8.binlog恢复未备份数据"></a>8.binlog恢复未备份数据</h3><blockquote><p>前提是，你在删库前的binlog还存在，如果说binlog和数据目录在一起，都被删除的话，binlog丢失了，也无法恢复数据了！！！</p></blockquote><ul><li>查找最后增量备份数据的binlog截止点</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>inc3_2024<span class="number">-06</span><span class="number">-10</span>]#cat xtrabackup_binlog_info </span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000003</span><span class="number">1294</span><span class="number">253</span>b757e<span class="number">-26</span>db<span class="number">-11</span>ef<span class="operator">-</span>a5a9<span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-5</span>,</span><br><span class="line">f695ab86<span class="number">-2303</span><span class="number">-11</span>ef<span class="operator">-</span>bf61<span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-6</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240610180336201.png" alt="image-20240610180336201"></p><ul><li>提取binlog中未备份的事务gtid，通过gitd区间截取事务日志</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#进入binlog日志存放目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#截取未备份的所有事务日志</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;253b757e-26db-11ef-a5a9-000c2939adaa:6-8&#x27; mysql-bin.000004 &gt; /root/increase.sql</span></span><br></pre></td></tr></table></figure><ul><li>sql文件导入数据库进行恢复</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; source /root/increase.sql</span><br></pre></td></tr></table></figure><ul><li>检查数据恢复情况，成功恢复</li></ul><p><img src="/image-20240610182130770.png" alt="image-20240610182130770"></p><h3 id="9-清空binlog再次全量备份"><a href="#9-清空binlog再次全量备份" class="headerlink" title="9.清空binlog再次全量备份"></a>9.清空binlog再次全量备份</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 清空所有日志</span><br><span class="line">mysql<span class="operator">&gt;</span> reset master;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>立即全量备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--no-timestamp  --user=root -S /tmp/mysql.sock  --password=1  /xtrabackup_data/full_all_bak_`date +%F`</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>xtrabackup_data<span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">4</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 4096 Jun 10 17:41 full_1_2024-06-10</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 7 root root  251 Jun 10 18:25 full_all_bak_2024-06-14</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root  260 Jun 10 17:36 inc1_2024-06-11</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root  260 Jun 10 17:39 inc2_2024-06-12</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root  260 Jun 10 17:39 inc3_2024-06-13</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;全量逻辑备份与增量恢复&quot;&gt;&lt;a href=&quot;#全量逻辑备份与增量恢复&quot; class=&quot;headerlink&quot; title=&quot;全量逻辑备份与增量恢复&quot;&gt;&lt;/a&gt;全量逻辑备份与增量恢复&lt;/h1&gt;&lt;h2 id=&quot;1-数据准备&quot;&gt;&lt;a href=&quot;#1-数据准备&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-备份数据</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE/</id>
    <published>2024-08-20T00:51:40.000Z</published>
    <updated>2024-08-20T00:54:23.080Z</updated>
    
    <content type="html"><![CDATA[<h1 id="数据库数据备份恢复概述"><a href="#数据库数据备份恢复概述" class="headerlink" title="数据库数据备份恢复概述"></a>数据库数据备份恢复概述</h1><p>一个互联网业务，最核心的就是数据。数据库中更是存放着用户相关的数据，更加重要。</p><p>数据丢失后会造成极大的损失，所以为了避免数据丢失，就需要对数据库中数据进行备份。</p><h2 id="1-运维职责"><a href="#1-运维职责" class="headerlink" title="1.运维职责"></a>1.运维职责</h2><ul><li>备份恢复策略   （备份周期，备份工具，备份方式，数据恢复方式）</li><li>备份检查       （事务binglog日志备份，数据备份，是否备份成功）</li><li>定期恢复数据演练 （备份数据是否有问题）</li><li>数据丢失恢复     （利用现有资源，快速恢复数据）</li><li>数据迁移数据库升级</li></ul><h2 id="2-备份方案"><a href="#2-备份方案" class="headerlink" title="2.备份方案"></a>2.备份方案</h2><p><img src="/image-20240604164320125.png" alt="image-20240604164320125"></p><p><strong>逻辑备份</strong></p><p>用于备份小量数据，备份原理是将数据库中所有东西，转化为sql语句导入文件，进行备份。恢复数据时可通过sql语句进行，建库建表插入数据等动作达到恢复数据的效果。</p><p>常用工具：<em>mysqldump</em> （<em>mysql</em>内置的一个程序）</p><p><strong>物理备份</strong></p><p><a href="https://www.percona.com/software/mysql-database/percona-xtrabackup">https://www.percona.com/software/mysql-database/percona-xtrabackup</a></p><p><strong>如何选择</strong></p><p>100G数据以下，逻辑备份没问题，服务器配置要求高</p><p>100G数据以上，建议物理备份</p><h1 id="mysqldump备份恢复"><a href="#mysqldump备份恢复" class="headerlink" title="mysqldump备份恢复"></a><em>mysqldump</em>备份恢复</h1><h2 id="0-连接参数"><a href="#0-连接参数" class="headerlink" title="0.连接参数"></a>0.连接参数</h2><blockquote><p>-u 用户名<br>-p 用户密码<br>-S 本地socket文件<br>-h 指定主机地址<br>-P 指定端口</p></blockquote><h2 id="1-全量与恢复"><a href="#1-全量与恢复" class="headerlink" title="1.全量与恢复"></a>1.全量与恢复</h2><blockquote><p>语法： </p><p><em>mysqldump</em>  连接数据库参数  -all–databases&#x2F;A       &gt;    数据导入文件</p></blockquote><ul><li>备份数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>A <span class="operator">&gt;</span> all_mysql.sql</span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure><ul><li>清空数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#先关闭数据库程序否则直接清空会导致一些报错</span><br><span class="line">systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#清空数据库<span class="number">3306</span>实例的所有数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#rm <span class="operator">-</span>rf <span class="operator">*</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#ll</span><br><span class="line">total <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重新初始化<span class="number">3306</span>实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/tools/mysql  --datadir=/app/data/3306</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">total <span class="number">110628</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql       56 Jun  4 17:28 auto.cnf</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      419 Jun  4 17:28 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 Jun  4 17:28 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun  4 17:28 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun  4 17:28 ib_logfile1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 Jun  4 17:28 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun  4 17:28 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun  4 17:28 sys</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动检查端口</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br></pre></td></tr></table></figure><ul><li>恢复数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">sql</span>文件导入</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">&lt;</span> all_3306_bak.sql </span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student.stu limit <span class="number">5</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+--------+---------+---------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> age <span class="operator">|</span> gender <span class="operator">|</span> address <span class="operator">|</span> intime              <span class="operator">|</span> phone <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+--------+---------+---------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 赵东兴    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">12</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 黄牛      <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">43</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 叶金阳    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">27</span>:<span class="number">21</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> 杨松麟    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">27</span>:<span class="number">22</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> 陈亮亮    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">27</span>:<span class="number">23</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+--------+---------+---------------------+-------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-备份指定库"><a href="#2-备份指定库" class="headerlink" title="2.备份指定库"></a>2.备份指定库</h2><blockquote><p>语法：</p><p>mysqldump   连接数据库参数   –database&#x2F;-B   库名1 库名2 库名3 ….    &gt; 输出文件</p></blockquote><ul><li>备份zhao1.zhao2.zhao3，三个库</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>B zhao1 zhao2 zhao3 <span class="operator">&gt;</span>all_zhao.sql</span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure><ul><li>模拟删除</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zhao1;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zhao2;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zhao3;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><ul><li>恢复检查</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">&lt;</span> all_zhao.sql </span><br><span class="line">Enter password: </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure><h2 id="3-备份指定表"><a href="#3-备份指定表" class="headerlink" title="3.备份指定表"></a>3.备份指定表</h2><blockquote><p>备份单个表：mysqldump   连接数据库参数    库名   指定表   表    &gt; 输出文件</p><p>备份多个表：mysqldump   连接数据库参数    库名   指定表   表1  表2 表3 ….    &gt; 输出文件</p></blockquote><ul><li>环境准备</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> zhao1.t1(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> zhao1.t2(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> zhao1.t3(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> zhao1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_zhao1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> t1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>备份zhao1库下的t1.t2.t3表，模拟删除并恢复检查</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 zhao1 t1 t2 t3 <span class="operator">&gt;</span> all_t123.sql</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll all_t123.sql </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 2720 Jun  4 20:23 all_t123.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模拟删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> zhao1.t1;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> zhao1.t2;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> zhao1.t3;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> zhao1;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> use zhao1;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>all_t123.sql</span><br><span class="line"></span><br><span class="line">#查看</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show tables from zhao1&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_zhao1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> t1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br></pre></td></tr></table></figure><h2 id="4-备份表结构"><a href="#4-备份表结构" class="headerlink" title="4.备份表结构"></a>4.备份表结构</h2><blockquote><p>语法： mysqldump  连接数据库    –no-data&#x2F;-d   库    &gt; 输出文件  （备份某库下所有表结构）</p><p>   mysqldump  连接数据库    –no-data&#x2F;-d   库  表1 表2   &gt; 输出文件  （备份某库下指定的表结构）</p></blockquote><ul><li>环境准备</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看wrold库下city表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> world.city</span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                 </span><br><span class="line"><span class="operator">|</span> city  <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `city` (</span><br><span class="line">  `ID` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `Name` <span class="type">char</span>(<span class="number">35</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `CountryCode` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `District` <span class="type">char</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Population` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`),</span><br><span class="line">  KEY `CountryCode` (`CountryCode`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `city_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`CountryCode`) <span class="keyword">REFERENCES</span> `country` (`Code`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4080</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>latin1 <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>备份world库下city表结构，并且进行恢复重新创建表</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>d  world city <span class="operator">&gt;</span> city.sql </span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建新库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database zhao1;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> use zhao1;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#恢复</span><br><span class="line">#写法<span class="number">2</span>：mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 zhao1 <span class="operator">&lt;</span> city.sql </span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>city.sql</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type     <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> ID          <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Name        <span class="operator">|</span> <span class="type">char</span>(<span class="number">35</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CountryCode <span class="operator">|</span> <span class="type">char</span>(<span class="number">3</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> District    <span class="operator">|</span> <span class="type">char</span>(<span class="number">20</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Population  <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>备份world库下所有表结构，模拟创建新库进行恢复重新创建表</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>d world  <span class="operator">&gt;</span> all_world_table.sql</span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模拟创建新库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> database();</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> database() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> zhao1      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#恢复备份的表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>all_world_table.sql;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">-------后面太长省略</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查恢复的表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_zhao1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type     <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> ID          <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Name        <span class="operator">|</span> <span class="type">char</span>(<span class="number">35</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CountryCode <span class="operator">|</span> <span class="type">char</span>(<span class="number">3</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> District    <span class="operator">|</span> <span class="type">char</span>(<span class="number">20</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Population  <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="4-备份表数据"><a href="#4-备份表数据" class="headerlink" title="4.备份表数据"></a>4.备份表数据</h2><blockquote><p>语法：</p><p>mysqldump  连接数据库参数  –no-create-info&#x2F;-t  库   表名（只备份数据）     &gt;输出文件</p><p>恢复：需要提前准备好数据对应的表结构（结构约束属性等），方可进行恢复导入数据</p></blockquote><ul><li>数据准备</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> zhao2.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> 赵    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 黄    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhang <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>备份zhao2库下的t1表数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>t zhao2 t1 <span class="operator">&gt;</span> t1_data.sql</span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure</span><br></pre></td></tr></table></figure><ul><li>提前准备t1表数据对应的表结构，进行数据恢复</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#查看t1表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">  `name` <span class="type">char</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建备份数据对应的表结构，用于数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `name` <span class="type">char</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span>  t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field <span class="operator">|</span> Type     <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> <span class="type">char</span>(<span class="number">11</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数据恢复导入，检查恢复结果</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 zhao3 <span class="operator">&lt;</span> t1_data.sql </span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;select * from zhao3.t1&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> 赵    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 黄    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhang <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5-备份且压缩"><a href="#5-备份且压缩" class="headerlink" title="5.备份且压缩"></a>5.备份且压缩</h2><p>备份数据库大量数据时，防止数据过大占用磁盘空间，备份压缩为压缩文件</p><blockquote><p>语法： mysqldump  连接参数   备份对象(全量或是某库表)   |  gzip &gt;数据文件</p></blockquote><ul><li>备份压缩数据库全部数据，模拟删除数据，并恢复数据检查</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#备份且压缩数据库数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>A <span class="operator">|</span>gzip <span class="operator">&gt;</span> all_mysql.sql.gz</span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls</span><br><span class="line">all_mysql.sql.gz</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#file all_mysql.sql.gz </span><br><span class="line">all_mysql.sql.gz: gzip compressed data, <span class="keyword">from</span> Unix, <span class="keyword">last</span> modified: Wed Jun  <span class="number">5</span> <span class="number">14</span>:<span class="number">19</span>:<span class="number">42</span> <span class="number">2024</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除数据，初始化实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl stop mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#rm <span class="operator">-</span>rf <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="comment">/*</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql  --datadir=/app/data/3306</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#恢复数据</span></span><br><span class="line"><span class="comment">##方法一，先解压缩后，用普通sql文件进行导入恢复</span></span><br><span class="line"><span class="comment">gzip all_mysql.sql.gz</span></span><br><span class="line"><span class="comment">mysql -uroot -p &lt; all_mysql.sql</span></span><br><span class="line"><span class="comment">##方法二，使用zcat命令输出zip压缩包内容，导入恢复</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#zcat all_mysql.sql.gz |mysql -uroot -p</span></span><br><span class="line"><span class="comment">Enter password: </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#检查数据恢复</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#mysql -uroot -p -e &quot;show databases&quot;</span></span><br><span class="line"><span class="comment">Enter password: </span></span><br><span class="line"><span class="comment">+--------------------+</span></span><br><span class="line"><span class="comment">| Database           |</span></span><br><span class="line"><span class="comment">+--------------------+</span></span><br><span class="line"><span class="comment">| information_schema |</span></span><br><span class="line"><span class="comment">| mysql              |</span></span><br><span class="line"><span class="comment">| performance_schema |</span></span><br><span class="line"><span class="comment">| student            |</span></span><br><span class="line"><span class="comment">| sys                |</span></span><br><span class="line"><span class="comment">+--------------------+</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#mysql -uroot -p -e &quot;select * from student.stu1&quot;</span></span><br><span class="line"><span class="comment">Enter password: </span></span><br><span class="line"><span class="comment">+----+-----------+-----+--------------+-------+</span></span><br><span class="line"><span class="comment">| id | name      | age | address      | phone |</span></span><br><span class="line"><span class="comment">+----+-----------+-----+--------------+-------+</span></span><br><span class="line"><span class="comment">|  1 | 赵东兴    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  2 | 叶金阳    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  3 | 杨松麟    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  4 | 陈亮亮    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  5 | 李文杰    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  6 | 郑佳强    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  7 | 罗兴林    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  8 | 冯靖涵    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure><h1 id="binlog二进制日志"><a href="#binlog二进制日志" class="headerlink" title="binlog二进制日志"></a><em>binlog</em>二进制日志</h1><p><strong><em>binling</em>日志是什么</strong></p><ul><li>数据库程序中的一种日志，日志中对信息保存的方式是二进制数据类型，所以叫做二进制日志</li></ul><p><strong><em>binlog</em>日志记录着什么?</strong> </p><ul><li><p>记录着对数据库数据，每一条修改的操作语句动作，也叫对事务的记录</p></li><li><p>如DML语句对数据表数据插入修改删除，DDL语句对表库创建删除修改，DCL语句通过user表授权移除权限，都会造成数据库中数据变动</p></li></ul><p><strong><em>binlong</em>日志作用？</strong> </p><ul><li>可以通过日志记录，针对每一个事务进行恢复数据，可以通过<em>postion</em>开始与结束值恢复，也可以通过<em>GTID</em>号进行恢复 </li><li>对数据库数据维护一种手段，弥补数据备份的缺陷，数据备份通常为每日定时任务，而在定时任务没执行时，当日的数据就处在一个危险的状态，此时若数据丢失，就无法通过手段进行恢复了，而有了<em>binglog</em>日志可以对数据更加安全的维护。</li></ul><h2 id="1-开启日志功能"><a href="#1-开启日志功能" class="headerlink" title="1.开启日志功能"></a>1.开启日志功能</h2><ul><li>通过内置变量可查看<em>binlog</em>日志是否开启，默认是关闭状态</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%log_bin%&#x27;;</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| log_bin                         | OFF   |</span><br><span class="line">| log_bin_basename                |       |</span><br><span class="line">| log_bin_index                   |       |</span><br><span class="line">| log_bin_trust_function_creators | OFF   |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF   |</span><br><span class="line">| sql_log_bin                     | ON    |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li><em>mysql</em>配置文件添加日志参数</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>参数解释</span><br><span class="line">server_id  #主机id，必须要区别于其他机器</span><br><span class="line">log_bin    #参数指定binglog日志输出路径，日志文件最终生成格式如 mysql<span class="operator">-</span>bin<span class="number">.000001</span>   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>创建日志目录并授予程序权限，日志目录与实例数据目录分开</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>配置文件如下</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">character_set_server<span class="operator">=</span>utf8mb4 </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">log<span class="operator">-</span>error<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span><span class="number">3306</span>_error.log</span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>重启检查日志功能开启</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl restart mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep mysqld</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">80</span>     [::]:<span class="number">3306</span>               [::]:<span class="operator">*</span>                   users:((&quot;mysqld&quot;,pid<span class="operator">=</span><span class="number">17483</span> </span><br></pre></td></tr></table></figure><ul><li>登录进入检查变量binlog日志功能是否开启</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sql_log_bin                     <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-日志记录格式"><a href="#2-日志记录格式" class="headerlink" title="2.日志记录格式"></a>2.日志记录格式</h2><p><em>binlog</em>日志文件内记录了什么，是以什么格式进行记录</p><p>日志记录的形式是以每个事件进行记录，每条sql语句导致数据的变化，就为一个事件，会对每一个事件进行详细的记录到日志中</p><p><strong>日志中某个事件记录格式如下</strong></p><blockquote><p>主要关注，start_pos，end_pos，事件内容</p></blockquote><p>1.事件描述</p><ul><li><p>时间戳</p></li><li><p>程序标识 （server_id，用于主从复制）</p></li><li><p>加密方式 （日志会对inserter语句，进行base-64算法加密）</p></li><li><p>事件开始位置 （start_pos，事件开始的一个随机数）</p></li><li><p>事件结束位置 （end_pos，事件结束后的一个随机数）</p></li></ul><p>2.事件内容</p><ul><li>修改类语句操作，会多记录事件内容信息（插入了什么数据并且是加密的）</li></ul><p><img src="/image-20240605180028560.png" alt="image-20240605180028560"></p><h2 id="3-查看日志文件"><a href="#3-查看日志文件" class="headerlink" title="3.查看日志文件"></a>3.查看日志文件</h2><ul><li><strong>查看所有binlog日志文件，当前都有多少二进制日志</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">154</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#方法二</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000001</span>  mysql<span class="operator">-</span>bin.index</span><br></pre></td></tr></table></figure><ul><li><strong>查看当前日志记录的binglog日志文件，当前使用的日志会记录在哪个二进制文件</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="4-刷新日志文件"><a href="#4-刷新日志文件" class="headerlink" title="4.刷新日志文件"></a>4.刷新日志文件</h2><ul><li>执行刷新日志动作时，会再次创建一个新的日志文件，之后的事务会记录到新日志文件中</li><li>使用场景：做好全量备份数据后，每日的新增事务单独保存为日志文件中，方便对事务的查找</li></ul><ul><li>了解即可，不能随便执行该操作</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#刷新日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#新增了三个新的binglog文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>       <span class="number">154</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前使用的日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="5-主动生成事务"><a href="#5-主动生成事务" class="headerlink" title="5.主动生成事务"></a>5.主动生成事务</h2><ul><li><p>执行对数据影响的sql语句，就为一个事务，当执行每一个事务时，日志会记录事务的信息</p></li><li><p>日志中postion值，记录了每个事务的开始位置，这个位置会被显示为一个随机数，当下个事务发生，随机数会增加成为下个事务开始位置</p></li><li><p>主动执行sql语句，生成事务，查看日志文件pos值变化</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#最初的日志事务pos值记录，<span class="number">154</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第一次增加事务，查看pos值，pos154<span class="operator">-</span> 创建库事务 <span class="number">-313</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">313</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第二次增加事务，pos154<span class="comment">----创建库----313----创建表----482 </span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test.t1(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">482</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第三次增加事务查看，pos154（创建库）pos313（创建表）pos482（插入数据）pos761 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test.t1 <span class="keyword">value</span>(<span class="string">&#x27;赵东兴&#x27;</span>),(<span class="string">&#x27;乐佳杰&#x27;</span>),(<span class="string">&#x27;好一名&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">761</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="6-查看事件记录"><a href="#6-查看事件记录" class="headerlink" title="6.查看事件记录"></a>6.查看事件记录</h2><blockquote><p>语法：show binlog events in  ‘日志文件名’;</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#先查看当前使用的哪个日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>     <span class="number">1012</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#指定日志文件查看事件的一个信息</span><br></pre></td></tr></table></figure><p><img src="/image-20240605174125575.png" alt="image-20240605174125575"></p><h2 id="7-日志解密查看"><a href="#7-日志解密查看" class="headerlink" title="7.日志解密查看"></a>7.日志解密查看</h2><p>查看<em>binlog</em>日志文件内存储了什么信息，<em>binlog</em>日志文件记录事务后都是以二进制的数据类型存储</p><p>通过<em>mysqlbinlog</em>命令对二进制数据进行转化为人类可识别的字符，查看日志内容是如何记录事务信息</p><blockquote><p>语法： <em>mysqlbinlog</em>   日志文件路径</p></blockquote><ul><li><strong>查看使用的日志文件</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>     <span class="number">1012</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>转换可读格式，数据导入文件，编辑器查看</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">&gt;</span> bin.log</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#sz bin.log </span><br></pre></td></tr></table></figure><ul><li><strong>编辑器查看日志内容</strong></li></ul><p><img src="/image-20240605180021552.png" alt="image-20240605180021552"></p><ul><li><strong>解密查看日志内加密的内容</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--base64-output=decode-rows -vv /app/logs/mysql_log/mysql-bin.000004 &gt; bin.log</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240605181339331.png" alt="image-20240605181339331"></p><h1 id="binlog日志截取恢复（数据表数据误删）"><a href="#binlog日志截取恢复（数据表数据误删）" class="headerlink" title="binlog日志截取恢复（数据表数据误删）"></a><em>binlog</em>日志截取恢复（数据表数据误删）</h1><ul><li>当数据库数据，还没有进行对数据备份时，数据丢失，就得需要binlog日志进行恢复数据。</li><li>binglog日志中记录了每个事务的信息，postion值记录了每个事务的起点与终点的随机数。</li><li>通过事务开始的postion值与结束的pos值可以实现对数据的恢复</li></ul><blockquote><p>语法：</p></blockquote><h2 id="1-开启binlog"><a href="#1-开启binlog" class="headerlink" title="1.开启binlog"></a>1.开启binlog</h2><ul><li>保证binlog日志开启，记录事务的信息，方可根据pos值进行恢复数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sql_log_bin                     <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-模拟删除数据"><a href="#2-模拟删除数据" class="headerlink" title="2.模拟删除数据"></a>2.模拟删除数据</h2><ul><li>环境准备，test库下t1表，内有4行数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 赵东兴    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 乐佳杰    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 好一名    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>模拟误删除，运维老大东子的手下，不小心删除了t1表的一条数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> test.t1 <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;王&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 赵东兴    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 乐佳杰    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 好一名    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="3-binlog日志分析"><a href="#3-binlog日志分析" class="headerlink" title="3.binlog日志分析"></a>3.binlog日志分析</h2><h3 id="3-1-binlog记录查找删除事件pos值"><a href="#3-1-binlog记录查找删除事件pos值" class="headerlink" title="3.1 binlog记录查找删除事件pos值"></a>3.1 binlog记录查找删除事件pos值</h3><blockquote><p>查看binlog日志的事件记录，查找删除事件的记录，查找事件开始与结束的pos值</p><p>修改类事件信息格式： set修改标识—-begin开始—–修改数据动作—-commit提交事件</p></blockquote><p>1.事件类型查找delete类型事件</p><p>2.通过修改类事件的记录格式，分析查找整个事件开始的pos值与结束的pos值</p><p>3.最后查找到删除事件，<code>开始的pos值-----1012，  结束pos值------1267</code></p><p><img src="/image-20240605191520961.png" alt="image-20240605191520961"></p><h3 id="3-2-解密binlog定位丢失的具体数据"><a href="#3-2-解密binlog定位丢失的具体数据" class="headerlink" title="3.2 解密binlog定位丢失的具体数据"></a>3.2 解密binlog定位丢失的具体数据</h3><blockquote><p>语法： mysqlbinlog –base64-output&#x3D;decode-rows -vv   binlog日志文件  &gt; 导入文件</p><p>导出binglog日志文件，根据删除事件的pos值，查看具体删除了什么数据</p></blockquote><ul><li><strong>解密日志导入文件，转发桌面编辑器查看</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--base64-output=decode-rows -vv /app/logs/mysql_log/mysql-bin.000004 &gt; bin.log</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#sz bin.log </span><br></pre></td></tr></table></figure><ul><li><strong>日志分析得知，删除了t1表的，name&#x3D;王，这条数据</strong></li></ul><p><img src="/image-20240605194758148.png" alt="image-20240605194758148"></p><h3 id="3-3-查找丢失数据创建时的事件pos值"><a href="#3-3-查找丢失数据创建时的事件pos值" class="headerlink" title="3.3 查找丢失数据创建时的事件pos值"></a>3.3 查找丢失数据创建时的事件pos值</h3><blockquote><p>现在已经找到了，删除的内容为t1表下的<code>（name=王）</code>这条数据，创建的pos值761–1012</p><p>下一步根据创建事件的pos值，从binlog日志截取出，创建事件的日志，通过日志中sql语句进行恢复数据</p></blockquote><ul><li><strong>解密日志文件中查看，查找丢失数据在创建时，事务开时pos值与结束pos值</strong></li></ul><p><img src="/image-20240605200945330.png" alt="image-20240605200945330"></p><h2 id="4-截取日志恢复数据"><a href="#4-截取日志恢复数据" class="headerlink" title="4.截取日志恢复数据"></a>4.截取日志恢复数据</h2><h3 id="4-1-日志恢复原理"><a href="#4-1-日志恢复原理" class="headerlink" title="4.1 日志恢复原理"></a>4.1 日志恢复原理</h3><p>原理就是这个数据被删除，会在binlog生成事件，找到这个事件的pos值，日志解密后查找具体删除了什么数据</p><p>找到这个被删除的数据，那么这个数据在创建时也会生成一个创建事件，查找创建事件的开始pos值与结束pos值</p><p>通过创建事件的pos值，将创建事件的sql语句导出来，再通过这些创建数据sql语句进行导入数据库，实现数据恢复</p><h3 id="4-2-事件日志截取"><a href="#4-2-事件日志截取" class="headerlink" title="4.2 事件日志截取"></a>4.2 事件日志截取</h3><blockquote><p>截取某个事件日志语法： </p><p>mysqlbinlog   –start-position&#x3D;（事件开始pos值） –stop-position&#x3D;（结束pos值）  binlog日志   &gt;  导出文件</p></blockquote><ul><li><strong>导出要恢复的事件日志，开始pos值为761，结束pos值为1012</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--start-position=761 --stop-position=1012 /app/logs/mysql_log/mysql-bin.000004 &gt; recover.sql</span></span><br></pre></td></tr></table></figure><h3 id="4-3-关闭日志记录"><a href="#4-3-关闭日志记录" class="headerlink" title="4.3 关闭日志记录"></a>4.3 关闭日志记录</h3><blockquote><p>临时关闭binlog日志的记录，否则恢复数据时会添加新的事件记录，恢复数据后再打开日志记录</p></blockquote><ul><li>修改内置变量，临时关闭日志记录</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br></pre></td></tr></table></figure><h3 id="4-3-丢失数据恢复"><a href="#4-3-丢失数据恢复" class="headerlink" title="4.3 丢失数据恢复"></a>4.3 丢失数据恢复</h3><ul><li>导入恢复数据的sql语句</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.sql;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>取消临时关闭日志</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><ul><li>检查（name&#x3D;王数据）是否恢复</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#########数据恢复成功##########</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 赵东兴    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 乐佳杰    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 好一名    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="binlog多个日志截取恢复（数据库误删）"><a href="#binlog多个日志截取恢复（数据库误删）" class="headerlink" title="binlog多个日志截取恢复（数据库误删）"></a><em>binlog</em>多个日志截取恢复（数据库误删）</h1><blockquote><p>进行全量备份时，每日会会binlog进行刷新创建，将每日事务分别记录到不同的binlog中</p><p>当事件分散存储在不同的binlog日志文件，发生数据丢失如何进行恢复数据 ？</p></blockquote><h2 id="1-场景模拟"><a href="#1-场景模拟" class="headerlink" title="1.场景模拟"></a>1.场景模拟</h2><blockquote><p>创建测试数据生成多个事务，主动flush.logs刷新binlog日志，将事务保存到不同的binlog</p><p>最后基于binlog日志分析截取丢失数据pos值，实现数据恢复。</p></blockquote><h3 id="1-1-日志1，mysql-bin-000001"><a href="#1-1-日志1，mysql-bin-000001" class="headerlink" title="1.1 日志1，mysql-bin.000001"></a>1.1 日志1，mysql-bin.000001</h3><ul><li>当前使用mysql-bin.000001日志，进行创建数据事务提交</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#创建数据库数据表生成事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database lol;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.tanke(name <span class="type">char</span>(<span class="number">10</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> lol;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_lol <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> tanke         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前使用的binlog与事务记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">481</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line">##生成的事件记录</span><br><span class="line">mysql<span class="operator">&gt;</span> mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000001&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">310</span> <span class="operator">|</span> <span class="keyword">create</span> database lol                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">310</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">375</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">375</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">481</span> <span class="operator">|</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.tanke(name <span class="type">char</span>(<span class="number">10</span>)) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#主动刷新生成新的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="1-2-日志2，mysql-bin-000002"><a href="#1-2-日志2，mysql-bin-000002" class="headerlink" title="1.2 日志2，mysql-bin.000002"></a>1.2 日志2，mysql-bin.000002</h3><ul><li>已刷新生成新的mysql-bin.000002日志，之后新增事务保存到binlog-02日志中</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#当前使用的新日志<span class="number">02</span>binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#写入数据，再次生成新事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lol.tanke <span class="keyword">value</span>(<span class="string">&#x27;盖伦&#x27;</span>),(<span class="string">&#x27;慎&#x27;</span>),(<span class="string">&#x27;石头人&#x27;</span>),(<span class="string">&#x27;日女&#x27;</span>),(<span class="string">&#x27;龙龟&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lol.tanke;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 盖伦      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 慎        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 石头人    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 日女      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 龙龟      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看<span class="number">02</span>日志事务提交记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000002&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">287</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">287</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">336</span> <span class="operator">|</span> table_id: <span class="number">223</span> (lol.tanke)             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">336</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">411</span> <span class="operator">|</span> table_id: <span class="number">223</span> flags: STMT_END_F       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">411</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">442</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=169 */</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#再次主动刷新创建新binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="1-3-日志3，mysql-bin-000003"><a href="#1-3-日志3，mysql-bin-000003" class="headerlink" title="1.3 日志3，mysql-bin.000003"></a>1.3 日志3，mysql-bin.000003</h3><ul><li>已刷新生成新的mysql-bin.000003日志，之后新增事务保存到binlog-03日志中</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">#当前使用的binlog日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#主动生成新事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.fashi(name <span class="type">char</span>(<span class="number">10</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lol.fashi <span class="keyword">value</span>(<span class="string">&#x27;光辉&#x27;</span>),(<span class="string">&#x27;阿卡丽&#x27;</span>),(<span class="string">&#x27;火男&#x27;</span>),(<span class="string">&#x27;小鱼人&#x27;</span>),(<span class="string">&#x27;卡牌&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前binlog日志pos值变化</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">619</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog新增事务记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000003&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">325</span> <span class="operator">|</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.fashi(name <span class="type">char</span>(<span class="number">10</span>)) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">325</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">390</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">390</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">458</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">458</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">507</span> <span class="operator">|</span> table_id: <span class="number">224</span> (lol.fashi)             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">507</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">588</span> <span class="operator">|</span> table_id: <span class="number">224</span> flags: STMT_END_F       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">588</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">619</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=178 */</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#再次刷新binlog，生成新日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="1-4-日志4，模拟误删除数据库lol"><a href="#1-4-日志4，模拟误删除数据库lol" class="headerlink" title="1.4 日志4，模拟误删除数据库lol"></a>1.4 日志4，模拟误删除数据库lol</h3><ul><li>已刷新生成了新mysql-bin.000004日志文件，再次写数据事务提交新日志中，并且模拟删除数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#写数据生成事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lol.fashi <span class="keyword">values</span>(<span class="string">&#x27;发条&#x27;</span>),(<span class="string">&#x27;吸血鬼&#x27;</span>),(<span class="string">&#x27;莫甘娜&#x27;</span>),(<span class="string">&#x27;大发明家&#x27;</span>),(<span class="string">&#x27;火女&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line">#查看事务新增</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">454</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog事务记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000004&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">287</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">287</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">336</span> <span class="operator">|</span> table_id: <span class="number">224</span> (lol.fashi)             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">336</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">423</span> <span class="operator">|</span> table_id: <span class="number">224</span> flags: STMT_END_F       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">423</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">454</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=183 */</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>模拟一不小心把lol库删除了</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#误删lol库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database lol;</span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除事务被记录到了binlog04日志中</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">608</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-恢复实战"><a href="#2-恢复实战" class="headerlink" title="2.恢复实战"></a>2.恢复实战</h2><p>方案1：分段截取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--start-position</span><br><span class="line"></span><br><span class="line">--stop-position</span><br></pre></td></tr></table></figure><p>方案2：时间戳截取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1. 找创建lol库的时间戳</span><br></pre></td></tr></table></figure><h3 id="2-1-恢复思路图解"><a href="#2-1-恢复思路图解" class="headerlink" title="2.1 恢复思路图解"></a>2.1 恢复思路图解</h3><p><img src="/image-20240605210920147.png" alt="image-20240605210920147"></p><h3 id="2-2-恢复数据步骤"><a href="#2-2-恢复数据步骤" class="headerlink" title="2.2 恢复数据步骤"></a>2.2 恢复数据步骤</h3><p>思路：找到关于你要恢复的这个lol数据库，从创建该库，到删除lol之间的记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 基于开始的日志，找pos起点位置</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000003&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">1860</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>        <span class="number">1951</span> <span class="operator">|</span> <span class="keyword">create</span> database lol                                                                                                                                                                                                             <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>基于事件，寻找删库的事件pos位置</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000006&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000006</span> <span class="operator">|</span> <span class="number">499</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">588</span> <span class="operator">|</span> <span class="keyword">drop</span> database lol  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 或者基于mysqlbinlog命令，分析二进制日志的 建库lol的时间，到删库之间所有的日志</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>]#mysqlbinlog <span class="comment">--start-position=1860 --stop-position=499 mysql-bin.000003 mysql-bin.000004 mysql-bin.000005 mysql-bin.000006 &gt; /tmp/restore-lol.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>可以解密查看如上截取的日志，能找到最后的插入数据结果即可</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>]#mysqlbinlog <span class="comment">--base64-output=decode-rows -vv   --start-position=1860 --stop-position=499 mysql-bin.000003 mysql-bin.000004 mysql-bin.000005 mysql-bin.000006 &gt; restore-lol.log</span></span><br></pre></td></tr></table></figure><h3 id="2-3-查找删除事件"><a href="#2-3-查找删除事件" class="headerlink" title="2.3 查找删除事件"></a>2.3 查找删除事件</h3><ul><li>先判断误删操作到底删除了什么，再基于被删数据的创建事件，进行恢复</li><li>图中得出，删除了lol这个库的数据</li></ul><p><img src="/image-20240607105145555.png" alt="image-20240607105145555"></p><h3 id="2-4-解密导出所有binlog"><a href="#2-4-解密导出所有binlog" class="headerlink" title="2.4 解密导出所有binlog"></a>2.4 解密导出所有binlog</h3><p>因为被删的这个库，在创建时到被删前，中间提交的事务被分散保存到了多个binlog日志，所以需要导出全部binlog</p><p>导出后解密binlog，进行事务分析，被删数据在创建后，到被删之前，提交了哪些事务</p><p>最后根据lol库在创建时的开始pos值，与删除lol库的开始pos值，截取创建到删除前的日志，导出sql语句进行恢复数据</p><blockquote><p>解密导出所有binlog，编辑器分析查看</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前所有的binlog日志</span></span><br><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |       528 |</span><br><span class="line">| mysql-bin.000002 |       489 |</span><br><span class="line">| mysql-bin.000003 |       666 |</span><br><span class="line">| mysql-bin.000004 |       608 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入binlog存放目录，解密导出所有binlog</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cd</span> /app/logs/mysql_log/</span><br><span class="line">[root@db-51 /app/logs/mysql_log]#mysqlbinlog --base64-output=decode-rows -vv  mysql-bin.000001 mysql-bin.000002 mysql-bin.000003 mysql-bin.000004 &gt; recover.log</span><br></pre></td></tr></table></figure><ul><li>lol库删除的开始pos值，也是上次事件结束pos值</li></ul><p><img src="/image-20240607113426280.png" alt="image-20240607113426280"></p><ul><li>lol库创建时的开始pos值</li></ul><p><img src="/image-20240607113800342.png" alt="image-20240607113800342"></p><h3 id="2-5-截取恢复数据binglog"><a href="#2-5-截取恢复数据binglog" class="headerlink" title="2.5 截取恢复数据binglog"></a>2.5 截取恢复数据binglog</h3><blockquote><p>语法：</p><p>mysqlbinlog  –start-position&#x3D;（事件开始pos值）  –stop-position&#x3D;（事件结束pos值）  binlog文件（如果截取多个binlog就写多个binlog文件即可）    &gt;  导出文件</p></blockquote><ul><li>截取（lol库创建开始pos值，到lol库删除开始pos值）之间的所有binlog日志，导出日志内容到文件</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--start-position=219 --stop-position=454 mysql-bin.000001 mysql-bin.000002 mysql-bin.000003 mysql-bin.000004 &gt; /root/recover.sql</span></span><br></pre></td></tr></table></figure><h3 id="2-5-恢复数据并检查"><a href="#2-5-恢复数据并检查" class="headerlink" title="2.5 恢复数据并检查"></a>2.5 恢复数据并检查</h3><ul><li>导入sql文件，并且检查数据是否恢复</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#将刚才截取的日志文件导入数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.sql</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">##########后面省略#######</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> lol;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_lol <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> fashi         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tanke         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lol.fashi;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="operator">|</span> name         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="operator">|</span> 光辉         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 阿卡丽       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 火男         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 小鱼人       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 卡牌         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 发条         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 吸血鬼       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 莫甘娜       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 大发明家     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 火女         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lol.tanke;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 盖伦      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 慎        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 石头人    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 日女      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 龙龟      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="GTID与binglog应用"><a href="#GTID与binglog应用" class="headerlink" title="GTID与binglog应用"></a><em>GTID</em>与<em>binglog</em>应用</h1><blockquote><p>gitd是什么？ <em>全局事务标示符</em></p><p>就是给每个事务添加了一个实例唯一标识与事务的id值，可以根据事务对应的gtid恢复数据，无需再用肉眼判断事务的pos值去进行恢复。</p><p>可以用在主从复制架构中，主库数据基于binglog每个事务gtid，复制数据到从库上，减少了使用pos值复制时的容错率。</p></blockquote><p><strong>概述</strong></p><ul><li><p>从 MySQL 5.6.5 开始新增了一种基于 GTID 的复制方式</p></li><li><p>通过 GTID 保证了每个在主库上提交的事务在集群中有一个唯一的ID</p></li><li><p>这种方式强化了数据库的主备一致性，故障恢复以及容错能力</p></li><li><p>在原来基于二进制日志的复制中，从库需要告知主库要从哪个偏移量pos值进行增量同步，</p><p>如果指定<code>错误会造成数据的遗漏，从而造成数据的不一致。</code></p></li><li><p>借助GTID，在发生主备切换的情况下，MySQL的其它从库可以自动在新主库上找到正确的复制位置，</p><p><code>这大大简化了复杂复制拓扑下集群的维护</code>，也减少了人为设置复制位置发生误操作的风险。</p></li><li><p>另外，基于GTID的复制可以忽略已经执行过的事务，减少了数据发生不一致的风险。</p><p>​</p></li></ul><h2 id="1-GTID开启与使用"><a href="#1-GTID开启与使用" class="headerlink" title="1. GTID开启与使用"></a>1. GTID开启与使用</h2><blockquote><p>GTID默认是未开启状态，查询binlog事件记录，都是GTID_NEXT&#x3D; ‘ANONYMOUS（无名）’</p><p>当开启后，每个事件记录都会有，GTID的标识&#x3D;uuid+事件id（事件数量）</p></blockquote><p><img src="/image-20240607145137038.png" alt="image-20240607145137038"></p><ul><li><strong>开启GTID，配置文件添加如下参数</strong></li></ul><p><img src="/image-20240607145638708.png" alt="image-20240607145638708"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#具体配置如下</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line"></span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">character_set_server<span class="operator">=</span>utf8mb4 </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">log<span class="operator">-</span>error<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>error_3306.log</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"></span><br><span class="line">#重启mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl restart mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep mysql</span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">3306</span>                 :::<span class="operator">*</span>                    LISTEN      <span class="number">51134</span><span class="operator">/</span>mysqld   </span><br></pre></td></tr></table></figure><ul><li><strong>检查GTID是否开启</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%GTID%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span> #开启gtid</span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span> #生成的事务都自动加上GTID</span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#开启后自动刷新binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>新增数据生成新的事务</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">##################新增的事务#####################</span><br><span class="line">#当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">#创建数据库‘未来’</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database future;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#‘未来’库中创建数据表‘预知’添加字段‘发生的事’</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> future.foresee(发生的事 <span class="type">char</span>(<span class="number">15</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line">#‘未来’库中‘预知’数据表‘发生的事’字段下，插入未来在你身上发生的<span class="number">6</span>件事情</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> future.foresee <span class="keyword">value</span>(<span class="string">&#x27;未来你的父母身体健康后半辈子会一直享福&#x27;</span>),(<span class="string">&#x27;你的母亲在你30岁之前病好了不再吃药&#x27;</span>),(<span class="string">&#x27;你在30岁实现了自己的目标工资月入3w+&#x27;</span>),(<span class="string">&#x27;你会交到一个很爱你很完美的女朋 友在你30岁结婚了&#x27;</span>),(<span class="string">&#x27;你的未来会很幸福你的家庭父母爱人孩子&#x27;</span>),(<span class="string">&#x27;孩子也快乐平安长大&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">6</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">6</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">#查看未来预知在你身上发生的事</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋友在你<span class="number">30</span>岁结婚了                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福你的家庭父母爱人孩子                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>查看binlog事件记录查看事务提交的gtid</strong></li></ul><p><img src="/image-20240607161221091.png" alt="image-20240607161221091"></p><p><img src="/image-20240607161440264.png" alt="image-20240607161440264"></p><h2 id="2-GTID截取binlog与恢复"><a href="#2-GTID截取binlog与恢复" class="headerlink" title="2. GTID截取binlog与恢复"></a>2. GTID截取binlog与恢复</h2><blockquote><p>语法：</p><p>mysqlbinlog –skip-gtids  –include-gtids&#x3D;’uuid:事务id’   binlog文件   &gt; 输出文件</p><p>–skip-gtids：</p><p>导出日志信息时，事件生成新的GTID，不加该参数导出的事件会保留原gtid，到时候恢复数据时会和binlog中原有的gtid导致冲突</p></blockquote><h3 id="2-1-模拟删除恢复数据（单事件）"><a href="#2-1-模拟删除恢复数据（单事件）" class="headerlink" title="2.1 模拟删除恢复数据（单事件）"></a>2.1 模拟删除恢复数据（单事件）</h3><ul><li><strong>模拟删除数据，删除foresee表内所有信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#原数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋 友在你<span class="number">30</span>岁结婚了                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福你的家庭父母爱人孩子                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模拟误删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">truncate</span> future.foresee;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line">#数据没了</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>查找被删数据在创建时的事件gtid，通过gtid截取binlog</strong></li></ul><p><img src="/image-20240607165258107.png" alt="image-20240607165258107"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#进入binlog日志目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#指定丢失数据的事件gtid，与binlog日志文件，进行日志截取导出</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;f695ab86-2303-11ef-bf61-000c2939adaa:3&#x27; mysql-bin.000001 &gt; /root/recover.sql</span></span><br></pre></td></tr></table></figure><ul><li><strong>临时关闭binlog记录，防止恢复记录写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>通过截取出的日志，导入数据库恢复数据</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#恢复数据</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.log;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">############恢复过程省略############</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋 友在你<span class="number">30</span>岁结婚了                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福你的家庭父母爱人孩子                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>恢复数据后开启binlog记录写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="2-2-模拟删除恢复数据（多个事件）"><a href="#2-2-模拟删除恢复数据（多个事件）" class="headerlink" title="2.2 模拟删除恢复数据（多个事件）"></a>2.2 模拟删除恢复数据（多个事件）</h3><blockquote><p>删除整个库，通过gtid截取多条日志，恢复数据</p></blockquote><ul><li><strong>模拟删除数据库</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database future;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line">ERROR <span class="number">1146</span> (<span class="number">42</span>S02): <span class="keyword">Table</span> <span class="string">&#x27;future.foresee&#x27;</span> doesn<span class="string">&#x27;t exist</span></span><br></pre></td></tr></table></figure><ul><li><strong>binlog日志查找，被删的数据库，在创建时到删除前的所有事件</strong></li></ul><p><img src="/image-20240607171514159.png" alt="image-20240607171514159"></p><ul><li><strong>临时关闭binlog</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>通过库在删除前所有事件gtid，进行截取binlog</strong></li></ul><blockquote><p>695ab86-2303-11ef-bf61-000c2939adaa:1-3（事件id范围指定即可）</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;f695ab86-2303-11ef-bf61-000c2939adaa:1-3&#x27; mysql-bin.000001 &gt; /root/recover.log</span></span><br></pre></td></tr></table></figure><ul><li><strong>截取的binlog，导入数据库恢复数据</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.log;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>检查恢复数据</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋友在你<span class="number">30</span>岁时候，你们结婚了                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福，你的父母爱人孩子也都很幸福                                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;数据库数据备份恢复概述&quot;&gt;&lt;a href=&quot;#数据库数据备份恢复概述&quot; class=&quot;headerlink&quot; title=&quot;数据库数据备份恢复概述&quot;&gt;&lt;/a&gt;数据库数据备份恢复概述&lt;/h1&gt;&lt;p&gt;一个互联网业务，最核心的就是数据。数据库中更是存放着用户相关的数据，</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://example.com/2024/08/19/hello-world/"/>
    <id>http://example.com/2024/08/19/hello-world/</id>
    <published>2024-08-19T13:52:23.813Z</published>
    <updated>2024-08-19T13:52:23.813Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot;&gt;documentation&lt;/a&gt; for</summary>
      
    
    
    
    
  </entry>
  
</feed>
