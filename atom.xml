<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>一往无前虎山行,拨开云雾见光明</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2024-08-20T03:18:08.852Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>赵东兴</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>容器Docker-单机编排</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92/</id>
    <published>2024-08-20T01:32:01.000Z</published>
    <updated>2024-08-20T03:18:08.852Z</updated>
    
    <content type="html"><![CDATA[<h1 id="docker-compose原理"><a href="#docker-compose原理" class="headerlink" title="docker-compose原理"></a>docker-compose原理</h1><h2 id="compose应用场景"><a href="#compose应用场景" class="headerlink" title="compose应用场景"></a>compose应用场景</h2><blockquote><p>普通运行容器时，需要手动命令定义大量的参数，而运行一组多个容器时会很麻烦</p><p>当使用compose工具，可以通过yam脚本来定义运行参数，更清晰简单的运行单机下的一组容器应用</p></blockquote><p>学习 <code>docker-compose</code> 对于解决用户在使用 Linux 操作系统时遇到的任何问题，尤其是与容器化应用部署、管理和维护相关的问题，具有显著的优势和必要性。以下是几个主要原因：</p><ol><li><strong>简化复杂应用的部署</strong>： 在 Linux 系统中部署复杂的应用时，经常需要配置多个容器，并确保它们之间的依赖关系正确无误。<code>docker-compose</code> 通过允许你定义一个 YAML 格式的 <code>docker-compose.yml</code> 文件来定义多个容器的配置，简化了这一流程。这个文件包含了所有需要运行的容器信息，包括它们之间的依赖关系、网络配置、环境变量等。使用 <code>docker-compose up</code> 命令，你可以轻松启动所有服务，无需手动逐个启动容器。</li><li><strong>提高可移植性和可重复性</strong>： 使用 <code>docker-compose</code>，你可以将应用的部署配置保存在版本控制系统中，这意味着不同的开发者和运维人员可以轻松地复现相同的环境。这对于确保开发、测试和生产环境之间的一致性至关重要。此外，<code>docker-compose</code> 配置文件也便于在不同的机器或云平台上部署应用。</li><li><strong>便于环境管理</strong>： 在开发过程中，可能需要频繁地切换不同的开发环境或配置。<code>docker-compose</code> 允许你通过简单地修改 <code>docker-compose.yml</code> 文件并重新运行 <code>docker-compose up</code> 命令来快速切换环境。此外，使用 <code>docker-compose down</code> 可以轻松停止并移除所有容器，便于清理和重置环境。</li><li><strong>增强可扩展性</strong>： 随着应用的增长，可能需要增加更多的服务或资源。<code>docker-compose</code> 提供了扩展服务的机制，允许你轻松增加服务的副本数量，以满足更高的负载需求。这种可扩展性对于确保应用的高可用性和性能至关重要。</li><li><strong>促进团队协作</strong>： 在团队开发环境中，每个成员可能需要在自己的本地机器上运行相同的服务集。使用 <code>docker-compose</code>，团队成员可以共享相同的 <code>docker-compose.yml</code> 文件，从而确保他们都在相同的环境中工作。这有助于减少因环境差异导致的问题，并提高团队协作的效率。</li></ol><p>综上所述，学习 <code>docker-compose</code> 对于解决 Linux 操作系统中与容器化应用相关的任何问题都至关重要。它不仅简化了复杂应用的部署和管理，还提高了应用的可移植性、可重复性、可扩展性和团队协作效率。</p><h2 id="compose定义概述"><a href="#compose定义概述" class="headerlink" title="compose定义概述"></a>compose定义概述</h2><blockquote><p>是一个用于编排多个容器如何运行的一个工具</p></blockquote><p><strong>定义</strong>：</p><p><code>docker-compose</code>是基于Docker的开源项目，托管于GitHub上，由Python实现。它调用Docker服务的API，负责实现对Docker容器集群的快速编排。简单来说，<code>docker-compose</code>允许用户通过一个单独的YAML文件（通常命名为<code>docker-compose.yml</code>）来定义一组相关的容器，这些容器共同为一个项目服务。</p><p><strong>核心功能</strong>：</p><ol><li><strong>定义和运行多容器应用</strong>：用户可以在<code>docker-compose.yml</code>文件中定义多个服务（即容器），并通过简单的命令（如<code>docker-compose up</code>）来启动这些服务。</li><li><strong>依赖管理</strong>：<code>docker-compose</code>能够处理容器之间的依赖关系，确保它们按照正确的顺序启动。</li><li><strong>服务扩展</strong>：通过简单的命令（如<code>docker-compose scale</code>），用户可以轻松地扩展某个服务的容器数量。</li><li><strong>环境隔离</strong>：<code>docker-compose</code>支持通过项目名称来隔离环境，允许用户在同一台计算机上运行同一环境的多个副本，而不会相互干扰。</li></ol><p><strong>使用步骤</strong>：</p><ol><li><strong>编写Dockerfile</strong>：首先，需要为应用程序的每个组件编写Dockerfile，以定义其运行环境。</li><li><strong>定义docker-compose.yml</strong>：然后，在<code>docker-compose.yml</code>文件中定义所有服务（容器）及其之间的调用关系。</li><li><strong>启动应用</strong>：最后，使用<code>docker-compose up</code>命令来启动并运行整个应用程序。</li></ol><p><strong>常用命令</strong>：</p><ul><li><code>docker-compose up</code>：启动所有服务。</li><li><code>docker-compose up -d</code>：启动所有服务并在后台运行。</li><li><code>docker-compose down</code>：停止并删除容器、网络、卷、镜像（可选）。</li><li><code>docker-compose exec</code>：进入某个服务的容器实例内部。</li><li><code>docker-compose ps</code>：展示当前所有容器的状态。</li><li><code>docker-compose logs</code>：查看容器的输出日志。</li></ul><p><strong>为什么需要docker-compose</strong></p><p>随着微服务架构的普及，一个应用程序可能由多个微服务组成，每个微服务又可能部署多个实例。如果每个微服务都要手动启停，那么效率将非常低，维护量也会非常大。<code>docker-compose</code>通过提供一个统一的配置文件和简单的命令行接口，极大地简化了这一过程，使得用户可以更轻松地部署、管理和扩展复杂的应用程序。</p><p>综上所述，<code>docker-compose</code>是解决Linux操作系统中与Docker容器相关的部署、管理和编排问题的一个强大工具。</p><h2 id="compose版本说明"><a href="#compose版本说明" class="headerlink" title="compose版本说明"></a>compose版本说明</h2><p>以下是 Docker Compose 版本和 version 字段对应关系的数据：</p><table><thead><tr><th>Docker Compose 版本</th><th>version 字段</th></tr></thead><tbody><tr><td>1.0.x</td><td>‘1’</td></tr><tr><td>1.1.x</td><td>‘2’</td></tr><tr><td>1.2.x</td><td>‘2.1’</td></tr><tr><td>1.3.x</td><td>‘2.1’</td></tr><tr><td>1.4.x</td><td>‘2.1’</td></tr><tr><td>1.5.x</td><td>‘2.1’</td></tr><tr><td>1.6.x</td><td>‘2.1’</td></tr><tr><td>1.7.x</td><td>‘2.1’</td></tr><tr><td>1.8.x - 1.10.x</td><td>‘2.1’</td></tr><tr><td>1.11.x</td><td>‘2.1’ 或 ‘2.2’（取决于特性使用）</td></tr><tr><td>1.12.x - 1.13.x</td><td>‘2.1’ 或 ‘2.2’（取决于特性使用）</td></tr><tr><td>1.14.x</td><td>‘2.1’ 或 ‘2.3’（取决于特性使用）</td></tr><tr><td>1.15.x</td><td>‘2.1’ 或 ‘2.3’（取决于特性使用）</td></tr><tr><td>1.16.x - 1.17.x</td><td>‘2.1’ 或 ‘2.3’（取决于特性使用）</td></tr><tr><td>1.18.x</td><td>‘2.1’ 或 ‘2.4’（取决于特性使用）</td></tr><tr><td>1.19.x</td><td>‘3.0’</td></tr><tr><td>1.20.x</td><td>‘3.0’</td></tr><tr><td>1.21.x</td><td>‘3.0’</td></tr><tr><td>1.22.x</td><td>‘3.0’</td></tr><tr><td>1.23.x</td><td>‘3.0’</td></tr><tr><td>1.24.x - 1.27.x</td><td>‘3.0’</td></tr><tr><td>1.28.x</td><td>‘3.7’ 或 ‘3.8’（取决于特性使用）</td></tr><tr><td>1.29.x</td><td>‘3.7’ 或 ‘3.8’（取决于特性使用）</td></tr></tbody></table><p>链接：<a href="https://juejin.cn/post/7223965203255607355">https://juejin.cn/post/7223965203255607355</a></p><h1 id="docker-compose语法"><a href="#docker-compose语法" class="headerlink" title="docker-compose语法"></a>docker-compose语法</h1><blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#官方文档</span><br><span class="line">https:<span class="operator">/</span><span class="operator">/</span>github.com<span class="operator">/</span>compose<span class="operator">-</span>spec<span class="operator">/</span>compose<span class="operator">-</span>spec<span class="operator">/</span><span class="type">blob</span><span class="operator">/</span>master<span class="operator">/</span>spec.md</span><br><span class="line"></span><br><span class="line">#菜鸟的文档</span><br><span class="line">https:<span class="operator">/</span><span class="operator">/</span>www.runoob.com<span class="operator">/</span>docker<span class="operator">/</span>docker<span class="operator">-</span>compose.html</span><br><span class="line"></span><br><span class="line">#不错的教程，建议每一个参数，不认识来这里查作用</span><br><span class="line">https:<span class="operator">/</span><span class="operator">/</span>yeasy.gitbook.io<span class="operator">/</span>docker_practice<span class="operator">/</span>compose<span class="operator">/</span>compose_file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#参考yaml模板</span><br><span class="line"></span><br><span class="line">version: <span class="string">&#x27;版本号&#x27;</span></span><br><span class="line">services:</span><br><span class="line">服务名<span class="number">1</span>：</span><br><span class="line"> images: 镜像名</span><br><span class="line"> container_name: 容器名</span><br><span class="line"> environment:</span><br><span class="line">      <span class="operator">-</span> var1<span class="operator">=</span>value1</span><br><span class="line">      <span class="operator">-</span> var2<span class="operator">=</span>value2</span><br><span class="line">    volumes:</span><br><span class="line">      <span class="operator">-</span> 存储驱动<span class="number">1</span>:容器内数据目录</span><br><span class="line">      <span class="operator">-</span> 宿主机目录:容器内数据目录</span><br><span class="line">    ports:</span><br><span class="line">      <span class="operator">-</span> 宿主机端口:容器端口</span><br><span class="line">    networks:</span><br><span class="line">      <span class="operator">-</span> 自定义网络名</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">external</span>: <span class="literal">true</span></span><br><span class="line">    name: 自定义网络名</span><br></pre></td></tr></table></figure></blockquote><p><strong>官网使用学习</strong></p><p><a href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></p><p><img src="/image-20240804152606983.png" alt="image-20240804152606983"></p><p>版本说明</p><p><img src="/image-20240804152703852.png" alt="image-20240804152703852"></p><h2 id="compose工具安装"><a href="#compose工具安装" class="headerlink" title="compose工具安装"></a>compose工具安装</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#安装新版本支持新语法</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d]#curl <span class="operator">-</span>L https:<span class="operator">/</span><span class="operator">/</span>github.com<span class="operator">/</span>docker<span class="operator">/</span>compose<span class="operator">/</span>releases<span class="operator">/</span>download<span class="operator">/</span><span class="number">1.29</span><span class="number">.2</span><span class="operator">/</span>docker<span class="operator">-</span>compose<span class="operator">-</span>`uname <span class="operator">-</span>s`<span class="operator">-</span>`uname <span class="operator">-</span>m` <span class="operator">&gt;</span> <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>docker<span class="operator">-</span>compose</span><br><span class="line">  <span class="operator">%</span> Total    <span class="operator">%</span> Received <span class="operator">%</span> Xferd  Average Speed   <span class="type">Time</span>    <span class="type">Time</span>     <span class="type">Time</span>  <span class="keyword">Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    <span class="keyword">Left</span>  Speed</span><br><span class="line">  <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>      <span class="number">0</span>      <span class="number">0</span> <span class="comment">--:--:--  0:00:01 --:--:--     0</span></span><br><span class="line"> <span class="number">27</span> <span class="number">12.1</span>M   <span class="number">27</span> <span class="number">3468</span>k    <span class="number">0</span>     <span class="number">0</span>   <span class="number">149</span>k      <span class="number">0</span>  <span class="number">0</span>:<span class="number">01</span>:<span class="number">23</span>  <span class="number">0</span>:<span class="number">00</span>:<span class="number">23</span>  <span class="number">0</span>:<span class="number">01</span>:<span class="number">00</span>  <span class="number">121</span>k</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#查看版本</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d]#docker<span class="operator">-</span>compose version</span><br><span class="line">docker<span class="operator">-</span>compose version <span class="number">1.29</span><span class="number">.2</span>, build <span class="number">5</span>becea4c</span><br><span class="line">docker<span class="operator">-</span>py version: <span class="number">5.0</span><span class="number">.0</span></span><br><span class="line">CPython version: <span class="number">3.7</span><span class="number">.10</span></span><br><span class="line">OpenSSL version: OpenSSL <span class="number">1.1</span><span class="number">.0</span>l  <span class="number">10</span> Sep <span class="number">2019</span></span><br></pre></td></tr></table></figure><h2 id="compose命令说明"><a href="#compose命令说明" class="headerlink" title="compose命令说明"></a>compose命令说明</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># 默认使用docker<span class="operator">-</span>compose.yml构建镜像</span><br><span class="line">$ docker<span class="operator">-</span>compose build</span><br><span class="line">$ docker<span class="operator">-</span>compose build <span class="comment">--no-cache # 不带缓存的构建</span></span><br><span class="line"></span><br><span class="line"># 指定不同yml文件模板用于构建镜像</span><br><span class="line">$ docker<span class="operator">-</span>compose build <span class="operator">-</span>f docker<span class="operator">-</span>compose1.yml</span><br><span class="line"></span><br><span class="line"># 列出Compose文件构建的镜像</span><br><span class="line">$ docker<span class="operator">-</span>compose images                          </span><br><span class="line"></span><br><span class="line"># 启动所有编排容器服务</span><br><span class="line">$ docker<span class="operator">-</span>compose up <span class="operator">-</span>d</span><br><span class="line"></span><br><span class="line"># 查看正在运行中的容器</span><br><span class="line">$ docker<span class="operator">-</span>compose ps </span><br><span class="line"></span><br><span class="line"># 查看所有编排容器，包括已停止的容器</span><br><span class="line">$ docker<span class="operator">-</span>compose ps <span class="operator">-</span>a</span><br><span class="line"></span><br><span class="line"># 进入指定容器执行命令</span><br><span class="line">$ docker<span class="operator">-</span>compose <span class="keyword">exec</span> nginx bash </span><br><span class="line">$ docker<span class="operator">-</span>compose <span class="keyword">exec</span> web python manage.py migrate <span class="comment">--noinput</span></span><br><span class="line"></span><br><span class="line"># 查看web容器的实时日志</span><br><span class="line">$ docker<span class="operator">-</span>compose logs <span class="operator">-</span>f web</span><br><span class="line"></span><br><span class="line"># 停止所有up命令启动的容器</span><br><span class="line">$ docker<span class="operator">-</span>compose down </span><br><span class="line"></span><br><span class="line"># 停止所有up命令启动的容器,并移除数据卷</span><br><span class="line">$ docker<span class="operator">-</span>compose down <span class="operator">-</span>v</span><br><span class="line"></span><br><span class="line"># 重新启动停止服务的容器</span><br><span class="line">$ docker<span class="operator">-</span>compose restart web</span><br><span class="line"></span><br><span class="line"># 暂停web容器</span><br><span class="line">$ docker<span class="operator">-</span>compose pause web</span><br><span class="line"></span><br><span class="line"># 恢复web容器</span><br><span class="line">$ docker<span class="operator">-</span>compose unpause web</span><br><span class="line"></span><br><span class="line"># 删除web容器，删除前必需停止stop web容器服务</span><br><span class="line">$ docker<span class="operator">-</span>compose rm web  </span><br><span class="line"></span><br><span class="line"># 查看各个服务容器内运行的进程 </span><br><span class="line">$ docker<span class="operator">-</span>compose top     </span><br><span class="line"></span><br><span class="line"># 合集命令</span><br><span class="line">build</span><br><span class="line">config <span class="operator">-</span>q</span><br><span class="line"><span class="keyword">create</span></span><br><span class="line">down</span><br><span class="line">events</span><br><span class="line"><span class="keyword">exec</span></span><br><span class="line">help</span><br><span class="line">images</span><br><span class="line">kill</span><br><span class="line">logs</span><br><span class="line">pause</span><br><span class="line">restart</span><br><span class="line">rm</span><br><span class="line">run</span><br><span class="line">scale</span><br><span class="line"><span class="keyword">start</span></span><br><span class="line">stop</span><br><span class="line">top</span><br><span class="line">unpause</span><br><span class="line">up</span><br></pre></td></tr></table></figure><h2 id="compose元素图解"><a href="#compose元素图解" class="headerlink" title="compose元素图解"></a>compose元素图解</h2><p>不可能上来就从头写yaml，shell脚本</p><ol><li>多看</li><li>多模仿</li><li>熟练看懂较多脚本之后，理解大部分的字段，是什么作用，缩进关系，以及改写什么参数，以及遇见不认识的参数，去哪找资料，</li><li>模仿改造为你自己的脚本，【如智能汽车运行系统】，【wordpres运行系统】</li></ol><blockquote><p>docker-compose  v3 三代版本，能用最新的字段，docker-compose.yml</p></blockquote><p><img src="/image-20240804155530778.png" alt="image-20240804155530778"></p><h1 id="docker-compose实战"><a href="#docker-compose实战" class="headerlink" title="docker-compose实战"></a>docker-compose实战</h1><h2 id="1-部署flask应用"><a href="#1-部署flask应用" class="headerlink" title="1.部署flask应用"></a>1.部署flask应用</h2><blockquote><p>该应用程序使用Flask框架，在Redis中设有一个点击计数器，提供了Docker Compose如何应用于Web开发场景的实际示例</p><p>官网教程：<a href="https://docs.docker.com/compose/gettingstarted/">https://docs.docker.com/compose/gettingstarted/</a></p></blockquote><h3 id="1-0-镜像文件准备"><a href="#1-0-镜像文件准备" class="headerlink" title="1.0 镜像文件准备"></a>1.0 镜像文件准备</h3><p><strong>准备flask代码镜像</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>存放目录准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#mkdir <span class="operator">-</span>p <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#cd <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>镜像物料准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis]#vim web<span class="operator">-</span>counter.py</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis]#cat web<span class="operator">-</span>counter.py </span><br><span class="line"><span class="keyword">from</span> flask import Flask</span><br><span class="line"><span class="keyword">from</span> redis import Redis</span><br><span class="line"></span><br><span class="line">app <span class="operator">=</span> Flask(__name__)</span><br><span class="line">redis <span class="operator">=</span> Redis(host<span class="operator">=</span><span class="string">&#x27;redis&#x27;</span>, port<span class="operator">=</span><span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def hello():</span><br><span class="line">    count <span class="operator">=</span> redis.incr(<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;学习 docker-compose中，运行flask程序 , 这个页面被点击了 &#123;&#125; 次\n&#x27;</span>.format(count)</span><br><span class="line"></span><br><span class="line">if __name__ <span class="operator">=</span><span class="operator">=</span> &quot;__main__&quot;:</span><br><span class="line">    app.run(host<span class="operator">=</span>&quot;0.0.0.0&quot;, debug<span class="operator">=</span><span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>依赖文件准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis]#cat requirements.txt </span><br><span class="line">flask</span><br><span class="line">redis</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>dockerfile准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis]#vim Dockerfile</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis]#cat Dockerfile </span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span><span class="number">.7</span></span><br><span class="line">MAINTAINER chad</span><br><span class="line"><span class="keyword">COPY</span> web<span class="operator">-</span>counter.py <span class="operator">/</span>app<span class="operator">/</span>code<span class="operator">/</span></span><br><span class="line"><span class="keyword">COPY</span> requirements.txt <span class="operator">/</span>app<span class="operator">/</span>code<span class="operator">/</span></span><br><span class="line">WORKDIR <span class="operator">/</span>app<span class="operator">/</span>code<span class="operator">/</span></span><br><span class="line">RUN pip3 install <span class="comment">--upgrade pip -i https://mirrors.aliyun.com/pypi/simple</span></span><br><span class="line">RUN pip3 install <span class="operator">-</span>r requirements.txt <span class="operator">-</span>i https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>pypi<span class="operator">/</span>simple</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>构建flask镜像</span><br><span class="line">#构建</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis]#docker build <span class="operator">-</span>t flask<span class="operator">-</span>count<span class="operator">-</span>redis .</span><br><span class="line">#检查</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis]#docker images</span><br><span class="line">REPOSITORY          TAG       IMAGE ID       CREATED          SIZE                                                                               </span><br><span class="line">flask<span class="operator">-</span>count<span class="operator">-</span>redis   latest    <span class="number">8</span>f901e86006e   <span class="number">26</span> seconds ago   <span class="number">933</span>MB</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis]#</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>flask<span class="operator">-</span>count<span class="operator">-</span>redis]#docker history flask<span class="operator">-</span>count<span class="operator">-</span>redis:latest </span><br></pre></td></tr></table></figure><p><strong>准备redis服务镜像</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>compose<span class="operator">/</span>web<span class="operator">-</span>count_flask]#docker pull redis</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>compose<span class="operator">/</span>web<span class="operator">-</span>count_flask]#docker images</span><br><span class="line">REPOSITORY          TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">flask<span class="operator">-</span>count<span class="operator">-</span>redis   latest    <span class="number">8</span>f901e86006e   <span class="number">10</span> minutes ago   <span class="number">933</span>MB</span><br><span class="line">redis               latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago      <span class="number">113</span>MB</span><br></pre></td></tr></table></figure><h3 id="1-1-创建存放目录"><a href="#1-1-创建存放目录" class="headerlink" title="1.1 创建存放目录"></a>1.1 创建存放目录</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#mkdir <span class="operator">/</span>compose<span class="operator">/</span>web<span class="operator">-</span>count_flask</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#cd <span class="operator">/</span>compose<span class="operator">/</span>web<span class="operator">-</span>count_flask<span class="operator">/</span></span><br></pre></td></tr></table></figure><h3 id="1-2-comepose文件"><a href="#1-2-comepose文件" class="headerlink" title="1.2 comepose文件"></a>1.2 comepose文件</h3><blockquote><p>我下方这个networks元素配置，是相当于自建网络驱动，会已compose文件所在的目录，命名</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span> <span class="comment">#comepose版本</span></span><br><span class="line"><span class="attr">services:</span>    <span class="comment">#顶级元素下方定义服务</span></span><br><span class="line">  <span class="attr">flask:</span>     <span class="comment">#comepose中的服务名用于文件中互相链接</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">flask-connect-redis</span>     <span class="comment">#镜像名，可以是本地有的，也可以是没有的会去仓库下载</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">count-web_flask</span> <span class="comment">#容器运行后的名字</span></span><br><span class="line">    <span class="attr">ports:</span>                          <span class="comment">#端口映射</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5000</span><span class="string">:5000</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;/app/code/web-counter.py&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span>                       <span class="comment">#运行时使用的网络驱动名</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">network</span></span><br><span class="line">    <span class="attr">depends_on:</span>                     <span class="comment">#运行时容器的服务依赖关系先启动redis容器并且链接</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">count_web-redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">network:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">network:</span>  </span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><h3 id="1-3-运行容器服务"><a href="#1-3-运行容器服务" class="headerlink" title="1.3 运行容器服务"></a>1.3 运行容器服务</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#检查脚本语法</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>compose<span class="operator">/</span>web<span class="operator">-</span>count_flask]#docker<span class="operator">-</span>compose config <span class="operator">-</span>q</span><br><span class="line"></span><br><span class="line">#后台启动</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>compose<span class="operator">/</span>web<span class="operator">-</span>count_flask]#docker<span class="operator">-</span>compose up <span class="operator">-</span>d</span><br><span class="line">Creating count_web<span class="operator">-</span>redis ... done</span><br><span class="line">Creating count<span class="operator">-</span>web_flask ... done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查启动</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>compose<span class="operator">/</span>web<span class="operator">-</span>count_flask]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE               COMMAND                  CREATED              STATUS         PORTS                                       NAMES</span><br><span class="line"><span class="number">0</span>c67341f0844   flask<span class="operator">-</span>count<span class="operator">-</span>redis   &quot;python3 /app/code/w…&quot;   About a <span class="keyword">minute</span> ago   Up <span class="number">2</span> seconds   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">5000</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">5000</span><span class="operator">/</span>tcp, :::<span class="number">5000</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">5000</span><span class="operator">/</span>tcp   count<span class="operator">-</span>web_flask</span><br><span class="line"><span class="number">5</span>ceb1992f39d   redis               &quot;docker-entrypoint.s…&quot;   About a <span class="keyword">minute</span> ago   Up <span class="number">4</span> seconds   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp, :::<span class="number">6379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp   count_web<span class="operator">-</span>redis</span><br></pre></td></tr></table></figure><p><strong>检查容器使用的自定义网络驱动</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>compose<span class="operator">/</span>web<span class="operator">-</span>count_flask]#docker network ls</span><br><span class="line">NETWORK ID     NAME                                DRIVER    <span class="keyword">SCOPE</span></span><br><span class="line"><span class="number">7e24</span>b79354f1   bridge                              bridge    <span class="keyword">local</span></span><br><span class="line">b94c97661cea   host                                host      <span class="keyword">local</span></span><br><span class="line">ca0aba9bf23f   <span class="keyword">none</span>                                <span class="keyword">null</span>      <span class="keyword">local</span></span><br><span class="line"><span class="number">1</span>acd6fee0191   web<span class="operator">-</span>count_flask<span class="operator">-</span>network   bridge    <span class="keyword">local</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>compose<span class="operator">/</span>web<span class="operator">-</span>count_flask]#docker inspect web<span class="operator">-</span>count_flask_web<span class="operator">-</span>flask<span class="operator">-</span>network <span class="operator">-</span></span><br><span class="line">        &quot;ConfigOnly&quot;: <span class="literal">false</span>,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;0c67341f0844fbe87ffa2055f43cec973acbd72a5d38bd6f009856d622820496&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;count-web_flask&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;00197a80f51501edcd129037f46506cf4a5e04c8f8eaa03cbb001602194ae635&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:13:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.19.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;5ceb1992f39dc24c05971972b3eff64e2a36f9c4f6ab40ea2e57eb72969e90fb&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;count_web-redis&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;f0d74d45a71abcdfe59575c53b48b16be170c10ad1d9c19c447d4e47bb7a2437&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:13:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.19.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br></pre></td></tr></table></figure><p><strong>访问映射宿主机ip地址与port</strong></p><p><img src="/image-20240804191609904.png" alt="image-20240804191609904"></p><h3 id="1-4-关于网络元素"><a href="#1-4-关于网络元素" class="headerlink" title="1.4 关于网络元素"></a>1.4 关于网络元素</h3><p>以下是使用 Docker Compose Networks 的基本步骤：</p><p><strong>1、使用已有网络</strong></p><p>1）创建网络：在开始使用现有网络之前，需要先创建一个 Docker 网络。可以使用以下命令来创建一个网络：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create &lt;network-name&gt;</span><br></pre></td></tr></table></figure><p>2）编写 Docker Compose 文件：接下来，需要编写一个 Docker Compose 文件，来定义服务和网络。在 Compose 文件中，可以定义一个或多个服务，每个服务都可以连接到同一个网络。以下是一个示例的 docker-compose.yml 文件：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-network</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-network</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">my-network:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="string">在上述示例中，定义了两个服务，web</span> <span class="string">和</span> <span class="string">db。这两个服务都使用同一个网络</span> <span class="string">my-network。请注意，在</span> <span class="string">networks</span> <span class="string">部分，使用了</span> <span class="attr">external:</span> <span class="literal">true</span><span class="string">，表示使用的是现有的外部网络。</span></span><br></pre></td></tr></table></figure><p><strong>2、自动创建网络</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">不指定external:</span> <span class="literal">true</span><span class="string">，在容器启动的时候，会自动创建网络</span> <span class="string">“&lt;project_name&gt;_my-network”</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span>  </span><br><span class="line"><span class="attr">services:</span>  </span><br><span class="line">  <span class="attr">web:</span>  </span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span>  </span><br><span class="line">    <span class="attr">ports:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span>  </span><br><span class="line">    <span class="attr">networks:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-network</span>  </span><br><span class="line">  <span class="attr">db:</span>  </span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:latest</span>  </span><br><span class="line">    <span class="attr">ports:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span>  </span><br><span class="line">    <span class="attr">networks:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-network</span>  </span><br><span class="line"><span class="attr">networks:</span>  </span><br><span class="line">  <span class="attr">my-network:</span>  </span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"></span><br><span class="line"><span class="string">在上面的示例中，创建了一个名为my-network的自定义网络，并将web和db服务连接到该网络。使用driver参数可以指定网络的驱动程序，默认为bridge。</span></span><br></pre></td></tr></table></figure><h2 id="2-部署zabbix应用"><a href="#2-部署zabbix应用" class="headerlink" title="2.部署zabbix应用"></a>2.部署zabbix应用</h2><p>暂未记录</p><h2 id="3-部署wordpess应用"><a href="#3-部署wordpess应用" class="headerlink" title="3.部署wordpess应用"></a>3.部署wordpess应用</h2><p>暂未记录</p><h2 id="4-部署cicd组合应用"><a href="#4-部署cicd组合应用" class="headerlink" title="4.部署cicd组合应用"></a>4.部署cicd组合应用</h2><p>暂未记录</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;docker-compose原理&quot;&gt;&lt;a href=&quot;#docker-compose原理&quot; class=&quot;headerlink&quot; title=&quot;docker-compose原理&quot;&gt;&lt;/a&gt;docker-compose原理&lt;/h1&gt;&lt;h2 id=&quot;compose应用</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-部署应用</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/</id>
    <published>2024-08-20T01:31:48.000Z</published>
    <updated>2024-08-20T03:14:00.797Z</updated>
    
    <content type="html"><![CDATA[<h1 id="容器启动link链接作用"><a href="#容器启动link链接作用" class="headerlink" title="容器启动link链接作用"></a>容器启动link链接作用</h1><p><code>docker run</code> 命令是 Docker 中用于创建并运行新容器的核心命令之一。<code>--link</code> 参数在 Docker 的早期版本中非常常见，用于容器间的网络连接，使得一个容器可以通过别名（alias）访问另一个容器的 IP 地址、端口等信息，而无需暴露这些容器到宿主机的网络或配置复杂的网络桥接。</p><p>然而，需要注意的是，随着 Docker 网络功能的不断完善和 Docker Compose 等工具的兴起，<code>--link</code> 参数的使用已经逐渐被更现代、更灵活的网络解决方案所取代。Docker 官方文档也推荐使用自定义网络（如 bridge、overlay 等）来实现容器间的通信，因为这种方法更加灵活且易于管理。</p><h2 id="1-–link-参数的作用"><a href="#1-–link-参数的作用" class="headerlink" title="1.–link 参数的作用"></a>1.–link 参数的作用</h2><p>当使用 <code>--link</code> 参数时，Docker 会自动执行以下操作：</p><ol><li><strong>更新环境变量</strong>：Docker 会在目标容器（即 <code>docker run</code> 命令中未使用 <code>--link</code> 的那个容器）中设置一些环境变量，这些环境变量包含了源容器（即 <code>--link</code> 后指定的容器）的网络信息，如 IP 地址、端口号等。环境变量的命名格式为 <code>&lt;别名&gt;_PORT_&lt;端口号&gt;_&lt;协议&gt;</code>，例如 <code>webdb_PORT_3306_TCP</code>。</li><li><strong>添加 <code>/etc/hosts</code> 条目</strong>：Docker 还会在目标容器的 <code>/etc/hosts</code> 文件中添加一个条目，使得目标容器可以通过源容器的别名来解析其 IP 地址。</li></ol><h2 id="2-不推荐使用-–link"><a href="#2-不推荐使用-–link" class="headerlink" title="2.不推荐使用 –link&#x3D;"></a>2.不推荐使用 –link&#x3D;</h2><p>尽管 <code>--link</code> 提供了一种简单的容器间通信方式，但它有几个缺点：</p><ol><li><strong>不够灵活</strong>：<code>--link</code> 依赖于硬编码的容器名称和端口，这限制了容器的可移植性和可扩展性。</li><li><strong>环境变量污染</strong>：自动设置的环境变量可能会与容器内部已有的环境变量冲突。</li><li><strong>不再被推荐</strong>：Docker 官方文档建议使用自定义网络来实现容器间的通信，这种方法更加灵活、安全且易于管理。</li></ol><h2 id="3-推荐使用自定义网络进行容器间通信"><a href="#3-推荐使用自定义网络进行容器间通信" class="headerlink" title="3.推荐使用自定义网络进行容器间通信"></a>3.推荐使用自定义网络进行容器间通信</h2><p>Docker 提供了多种网络模式，包括 bridge、host、overlay 等。其中，bridge 网络是 Docker 默认的网络类型，适用于单个 Docker 主机上的容器间通信。你可以通过 <code>docker network create</code> 命令创建一个自定义的 bridge 网络，并在运行容器时使用 <code>--network</code> 参数将其连接到该网络。这样，同一网络下的容器就可以通过容器名相互访问了。</p><p>​                                                                                                          </p><h1 id="容器化部署迁移"><a href="#容器化部署迁移" class="headerlink" title="容器化部署迁移"></a>容器化部署迁移</h1><h2 id="1-容器化迁移好处"><a href="#1-容器化迁移好处" class="headerlink" title="1.容器化迁移好处"></a>1.容器化迁移好处</h2><ol><li><strong>提高资源利用率</strong>：<ul><li>容器化技术基于宿主机内核运行，没有额外的操作系统开销，使得在相同硬件资源上能够运行更多的容器，从而提高了资源利用率。</li></ul></li><li><strong>快速部署与迁移</strong>：<ul><li>容器化技术提供了应用的打包和迁移能力，使得企业可以方便地将应用部署到不同环境，包括开发、测试和生产环境，极大地提高了应用的灵活性。</li></ul></li><li><strong>环境一致性</strong>：<ul><li>容器化技术通过将应用程序及其依赖项封装在一个轻量级的容器中，确保了应用在不同环境中运行的一致性，减少了因环境差异导致的问题。</li></ul></li><li><strong>隔离性</strong>：<ul><li>容器化技术实现了应用之间的隔离，确保应用运行过程中不会互相干扰，提高了系统的安全性和稳定性。</li></ul></li><li><strong>细粒度弹性与可扩展性</strong>：<ul><li>容器化技术允许独立部署高可用组件，消除单点故障，并通过细粒度动态扩展来最大化组件&#x2F;资源密度，以充分利用基础设施资源。</li></ul></li><li><strong>操作一致性</strong>：<ul><li>容器化技术简化了异构组件的同构管理，减少了操作环境所需的技能范围，降低了管理复杂度。</li></ul></li><li><strong>组件可移植性</strong>：<ul><li>容器化技术使得应用能够跨节点、跨环境、跨云进行移植，确保了在不同平台上的选择性和灵活性。</li></ul></li><li><strong>自动化与持续集成&#x2F;持续部署（CI&#x2F;CD）</strong>：<ul><li>容器化技术与自动化工具（如Jenkins）结合，可以实现持续集成和持续部署，极大地提高了开发效率，并简化了版本更新和回滚流程。</li></ul></li><li><strong>标准化迁移方式</strong>：<ul><li>容器化迁移基于镜像和容器统一发布，确保了在不同物理服务器上的运行环境无差异，降低了迁移成本。</li></ul></li><li><strong>打通开发与运维桥梁</strong>：<ul><li>容器化技术有助于打通开发工程师与运维工程师之间的消息传递桥梁，促进了团队协作和效率提升。</li></ul></li></ol><h2 id="2-为什么要容器化迁移"><a href="#2-为什么要容器化迁移" class="headerlink" title="2.为什么要容器化迁移"></a>2.为什么要容器化迁移</h2><ol><li><strong>满足快速迭代的市场需求</strong>：<ul><li>随着移动互联网行业的快速发展，产品需求快速迭代，容器化迁移能够帮助企业快速响应市场变化，提高产品更新频率。</li></ul></li><li><strong>提升开发效率</strong>：<ul><li>容器化迁移简化了应用的部署和迁移流程，减少了开发和测试过程中的环境配置问题，提高了开发效率。</li></ul></li><li><strong>增强系统稳定性与安全性</strong>：<ul><li>容器化技术的隔离性和细粒度管理特性有助于提升系统的稳定性和安全性，降低故障风险。</li></ul></li><li><strong>降低成本</strong>：<ul><li>容器化迁移通过提高资源利用率和简化管理复杂度，有助于降低企业的IT运营成本。</li></ul></li></ol><p>综上所述，容器化迁移是现代企业提升应用部署效率、增强系统稳定性和安全性、降低运营成本的重要手段之一。随着技术的不断发展，容器化迁移将在更多领域发挥重要作用。</p><p>​            </p><h1 id="容器化部署wordpress"><a href="#容器化部署wordpress" class="headerlink" title="容器化部署wordpress"></a>容器化部署wordpress</h1><h2 id="1-任务目标最终架构"><a href="#1-任务目标最终架构" class="headerlink" title="1.任务目标最终架构"></a>1.任务目标最终架构</h2><p>容器化部署架构下，宿主机的namespace安装 nginx提供LB功能，以及iptables实现数据包转发，以及提供服务器防护；</p><p>nginx的LB也就是网关的功能，所有的服务需要经过nginx允许后，才能进入后续的容器；</p><p>nginx需要配置反向代理，以及对http信息的校验，也会加入https的安全通信。</p><p>以此架构实现一个安全的容器化应用环境。</p><blockquote><p>nginx提供网关功能，针对client请求信息，进行七层lb负载均衡流量转发</p></blockquote><p><img src="/image-20240731113009477.png" alt="image-20240731113009477">                                      </p><h2 id="2-数据库容器部署"><a href="#2-数据库容器部署" class="headerlink" title="2.数据库容器部署"></a>2.数据库容器部署</h2><p><strong>准备容器内mysql挂载的宿主机数据卷存放目录</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /web-wordpress-container/mysql/&#123;conf,data,files&#125;</span><br></pre></td></tr></table></figure><p><strong>数据卷内映射的mysql配置文件</strong></p><p>字符集与字符排序设置是为了wordpress应用导入中文数据按中文编码存储</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>web<span class="operator">-</span>wordpress<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>conf]#vim my.conf </span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>web<span class="operator">-</span>wordpress<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>conf]#cat my.conf </span><br><span class="line">[mysqld]</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="keyword">default</span><span class="operator">-</span><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">=</span>utf8mb4</span><br><span class="line"><span class="keyword">default</span><span class="operator">-</span><span class="keyword">collation</span><span class="operator">-</span>server<span class="operator">=</span>utf8mb4_general_ci</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="keyword">default</span><span class="operator">-</span><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">=</span>utf8mb4</span><br><span class="line"><span class="keyword">default</span><span class="operator">-</span><span class="keyword">collation</span><span class="operator">-</span>server<span class="operator">=</span>utf8mb4_general_ci</span><br></pre></td></tr></table></figure><p><strong>运行mysql容器</strong></p><p>这里有个关于<code>mysql-files</code>报错坑，必须配置给挂载一个数据卷目录，要不就一直无法启动</p><p><img src="/image-20240731142108738.png" alt="image-20240731142108738"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#运行mysql容器，<span class="comment">--restart=always容器中断后自动重启</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run  \</span><br><span class="line"><span class="comment">--name wordpress-mysql --restart=always \</span></span><br><span class="line"><span class="operator">-</span>v <span class="operator">/</span>web<span class="operator">-</span>wordpress<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>:<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span> \</span><br><span class="line"><span class="operator">-</span>v <span class="operator">/</span>web<span class="operator">-</span>wordpress<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>conf<span class="operator">/</span>:<span class="operator">/</span>etc<span class="operator">/</span>mysql<span class="operator">/</span> \</span><br><span class="line"><span class="operator">-</span>v <span class="operator">/</span>web<span class="operator">-</span>wordpress<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>files<span class="operator">/</span>:<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">-</span>files \</span><br><span class="line"><span class="operator">-</span>e MYSQL_ROOT_PASSWORD<span class="operator">=</span>&quot;1&quot;  \</span><br><span class="line"><span class="operator">-</span>e MYSQL_USER<span class="operator">=</span><span class="string">&#x27;wordpress&#x27;</span> \</span><br><span class="line"><span class="operator">-</span>e MYSQL_PASSWORD<span class="operator">=</span><span class="string">&#x27;1&#x27;</span> \</span><br><span class="line"><span class="operator">-</span>e MYSQL_DATABASE<span class="operator">=</span><span class="string">&#x27;wordpress&#x27;</span> \</span><br><span class="line"><span class="operator">-</span>d mysql:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#可选参数</span><br><span class="line">#可以基于变量传入创建库用户及密码</span><br><span class="line">MYSQL_USER<span class="operator">=</span><span class="string">&#x27;wordpress&#x27;</span></span><br><span class="line">MYSQL_PASSWORD<span class="operator">=</span><span class="string">&#x27;1&#x27;</span></span><br><span class="line">MYSQL_DATABASE<span class="operator">=</span><span class="string">&#x27;wordpress&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>检查，容器内mysql服务是否正常运行，可接收外部请求</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#容器进程运行正常</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                 NAMES</span><br><span class="line"><span class="number">6770158</span>eb0f7   mysql:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">12</span> minutes ago   Up <span class="number">17</span> seconds   <span class="number">3306</span><span class="operator">/</span>tcp, <span class="number">33060</span><span class="operator">/</span>tcp   wordpress<span class="operator">-</span>mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#容器的网络空间ip地址</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> ]#docker inspect <span class="number">677</span><span class="operator">|</span>grep <span class="operator">-</span>i ipaddress</span><br><span class="line">            &quot;SecondaryIPAddresses&quot;: <span class="keyword">null</span>,</span><br><span class="line">            &quot;IPAddress&quot;: &quot;172.17.0.3&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.17.0.3&quot;,</span><br><span class="line">                    </span><br><span class="line">                    </span><br><span class="line">#mysql服务请求接收正常</span><br><span class="line">root<span class="variable">@6770158eb0f7</span>:<span class="operator">/</span># mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>h <span class="number">172.17</span><span class="number">.0</span><span class="number">.3</span> <span class="operator">-</span>P3306</span><br><span class="line">Enter password: </span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure><h2 id="3-管理工具容器部署"><a href="#3-管理工具容器部署" class="headerlink" title="3.管理工具容器部署"></a>3.管理工具容器部署</h2><p>仓库基于该工具的使用说明：<a href="https://hub.docker.com/_/phpmyadmin">https://hub.docker.com/_/phpmyadmin</a></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#仓库下载phpmyadmin镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">search</span> phpmyadmin</span><br><span class="line">NAME                              DESCRIPTION                                     STARS     OFFICIAL</span><br><span class="line">phpmyadmin                        phpMyAdmin <span class="operator">-</span> A web interface <span class="keyword">for</span> MySQL <span class="keyword">and</span> M…   <span class="number">1011</span>      [OK]                                    <span class="number">0</span>         </span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull phpmyadmin</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG        IMAGE ID       CREATED       SIZE</span><br><span class="line">phpmyadmin   latest     e0c502901f60   <span class="number">2</span> years ago   <span class="number">529</span>MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#运行容器，运行phpmyadmin时需要指定mysql的主机名或者ip地址</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run  <span class="comment">--restart=always  --link wordpress-mysql --name wordpress-phpadmin -d -e PMA_HOST=wordpress-mysql phpmyadmin</span></span><br><span class="line">d412f806a02d22fa3f1a5639ebdb0f98735f8bca667954a87a7bb8927b7c82f6</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                 NAMES</span><br><span class="line">d412f806a02d   phpmyadmin     &quot;/docker-entrypoint.…&quot;   <span class="number">4</span> seconds ago    Up <span class="number">2</span> seconds    <span class="number">80</span><span class="operator">/</span>tcp                wordpress<span class="operator">-</span>phpadmin</span><br><span class="line"><span class="number">6770158</span>eb0f7   mysql:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">43</span> minutes ago   Up <span class="number">31</span> minutes   <span class="number">3306</span><span class="operator">/</span>tcp, <span class="number">33060</span><span class="operator">/</span>tcp   wordpress<span class="operator">-</span>mysql</span><br></pre></td></tr></table></figure><h2 id="4-博客应用容器部署"><a href="#4-博客应用容器部署" class="headerlink" title="4.博客应用容器部署"></a>4.博客应用容器部署</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#下载镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">search</span> wordpress</span><br><span class="line">NAME                                      DESCRIPTION                                     STARS     OFFICIAL</span><br><span class="line">wordpress                                 The WordPress rich content management <span class="keyword">system</span>…   <span class="number">5620</span>      [OK]</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull wordpress</span><br><span class="line"><span class="keyword">Using</span> <span class="keyword">default</span> tag: latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建宿主机数据卷挂载目录</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>web<span class="operator">-</span>wordpress<span class="operator">-</span>container<span class="operator">/</span>wordpress]#pwd</span><br><span class="line"><span class="operator">/</span>web<span class="operator">-</span>wordpress<span class="operator">-</span>container<span class="operator">/</span>wordpress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#运行容器，数据卷挂载到容器中的代码资源目录，链接数据库容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d <span class="comment">--restart=always --name web-wordpress -v /web-wordpress-container/wordpress/:/var/www/html/ --link=wordpress-mysql wordpress</span></span><br><span class="line">f15e9fa70d0700289674494302c87ee5f156a170dac810471d2d7a9ba63a0043</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED             STATUS             PORTS                 NAMES</span><br><span class="line">f15e9fa70d07   wordpress      &quot;docker-entrypoint.s…&quot;   <span class="number">6</span> seconds ago       Up <span class="number">4</span> seconds       <span class="number">80</span><span class="operator">/</span>tcp                web<span class="operator">-</span>wordpress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查数据卷挂载情况</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>web<span class="operator">-</span>wordpress<span class="operator">-</span>container<span class="operator">/</span>wordpress]#ls</span><br><span class="line">index.php    wp<span class="operator">-</span>activate.php     wp<span class="operator">-</span>comments<span class="operator">-</span>post.php  wp<span class="operator">-</span>content   wp<span class="operator">-</span>links<span class="operator">-</span>opml.php  wp<span class="operator">-</span>mail.php      wp<span class="operator">-</span>trackback.php</span><br><span class="line">license.txt  wp<span class="operator">-</span>admin            wp<span class="operator">-</span>config<span class="operator">-</span>docker.php  wp<span class="operator">-</span>cron.php  wp<span class="operator">-</span>load.php        wp<span class="operator">-</span>settings.php  xmlrpc.php</span><br><span class="line">readme.html  wp<span class="operator">-</span>blog<span class="operator">-</span>header.php  wp<span class="operator">-</span>config<span class="operator">-</span>sample.php  wp<span class="operator">-</span>includes  wp<span class="operator">-</span>login.php       wp<span class="operator">-</span>signup.php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#容器内服务进程，运行了apache也是web服务器，内置了php模块直接处理了代码，所以不显示php进程</span><br><span class="line">root<span class="variable">@f15e9fa70d07</span>:<span class="operator">/</span>etc<span class="operator">/</span>apache2# ps <span class="operator">-</span>ef</span><br><span class="line">UID         PID   PPID  C STIME TTY          <span class="type">TIME</span> CMD</span><br><span class="line">root          <span class="number">1</span>      <span class="number">0</span>  <span class="number">0</span> <span class="number">07</span>:<span class="number">26</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> apache2 <span class="operator">-</span>DFOREGROUND</span><br><span class="line">www<span class="operator">-</span>data     <span class="number">25</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">07</span>:<span class="number">26</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> apache2 <span class="operator">-</span>DFOREGROUND</span><br><span class="line">www<span class="operator">-</span>data     <span class="number">26</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">07</span>:<span class="number">26</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> apache2 <span class="operator">-</span>DFOREGROUND</span><br><span class="line">www<span class="operator">-</span>data     <span class="number">27</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">07</span>:<span class="number">26</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> apache2 <span class="operator">-</span>DFOREGROUND</span><br><span class="line">www<span class="operator">-</span>data     <span class="number">28</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">07</span>:<span class="number">26</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> apache2 <span class="operator">-</span>DFOREGROUND</span><br><span class="line">www<span class="operator">-</span>data     <span class="number">29</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">07</span>:<span class="number">26</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> apache2 <span class="operator">-</span>DFOREGROUND</span><br><span class="line">root         <span class="number">30</span>      <span class="number">0</span>  <span class="number">0</span> <span class="number">07</span>:<span class="number">27</span> pts<span class="operator">/</span><span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line">root         <span class="number">39</span>     <span class="number">30</span>  <span class="number">0</span> <span class="number">07</span>:<span class="number">30</span> pts<span class="operator">/</span><span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> ps <span class="operator">-</span>ef</span><br></pre></td></tr></table></figure><p>docker run -d –restart&#x3D;always –name web-wordpress -v &#x2F;web-wordpress-container&#x2F;wordpress&#x2F;code&#x2F;:&#x2F;var&#x2F;www&#x2F;html&#x2F;  wordpress</p><h2 id="5-提取所有容器地址"><a href="#5-提取所有容器地址" class="headerlink" title="5.提取所有容器地址"></a>5.提取所有容器地址</h2><p><code>docker inspect</code> 命令是 Docker 提供的一个非常有用的工具，用于获取 Docker 容器的详细信息，包括配置、环境变量、网络设置等。通过 <code>--format</code> 参数，用户可以自定义 <code>docker inspect</code> 命令的输出格式，以便只获取他们感兴趣的特定信息。</p><p><code>--format</code> 参数后面跟的是一个 Go 模板字符串，Docker 使用这个模板来格式化输出。这意味着用户可以根据需要，构造复杂的查询来提取容器或镜像的特定信息</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#查看所有容器的主机名与ip地址</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect <span class="comment">--format=&#x27;&#123;&#123;.Name&#125;&#125;   &#123;&#123;.NetworkSettings.Networks.bridge.IPAddress&#125;&#125;&#x27;  `docker ps -aq`</span></span><br><span class="line"><span class="operator">/</span>web<span class="operator">-</span>wordpress   <span class="number">172.17</span><span class="number">.0</span><span class="number">.4</span></span><br><span class="line"><span class="operator">/</span>wordpress<span class="operator">-</span>phpadmin   <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line"><span class="operator">/</span>wordpress<span class="operator">-</span>mysql   <span class="number">172.17</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看所有端口，wordpress端口<span class="number">80</span>，phpmyadmin端口<span class="number">80</span>，mysql端口<span class="number">3306</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS             PORTS                 NAMES</span><br><span class="line">f15e9fa70d07   wordpress      &quot;docker-entrypoint.s…&quot;   <span class="number">15</span> minutes ago   Up <span class="number">15</span> minutes      <span class="number">80</span><span class="operator">/</span>tcp                web<span class="operator">-</span>wordpress</span><br><span class="line">d412f806a02d   phpmyadmin     &quot;/docker-entrypoint.…&quot;   <span class="number">49</span> minutes ago   Up <span class="number">49</span> minutes      <span class="number">80</span><span class="operator">/</span>tcp                wordpress<span class="operator">-</span>phpadmin</span><br><span class="line"><span class="number">6770158</span>eb0f7   mysql:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">2</span> hours ago      Up About an <span class="keyword">hour</span>   <span class="number">3306</span><span class="operator">/</span>tcp, <span class="number">33060</span><span class="operator">/</span>tcp   wordpress<span class="operator">-</span>mysql</span><br></pre></td></tr></table></figure><h2 id="6-宿主机部署web服务器"><a href="#6-宿主机部署web服务器" class="headerlink" title="6.宿主机部署web服务器"></a>6.宿主机部署web服务器</h2><blockquote><p>宿主机运行nginx服务，基于反向代理功能，转发请求到容器内服务</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#安装nginx服务</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#yum install nginx <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#编辑配置文件，设置url请求转发</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>etc<span class="operator">/</span>nginx<span class="operator">/</span>conf.d]#vim wordpress.conf</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>etc<span class="operator">/</span>nginx<span class="operator">/</span>conf.d]#cat wordpress.conf </span><br><span class="line">#wordpress配置</span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  dongxing.wordpress.com;</span><br><span class="line">    location <span class="operator">/</span></span><br><span class="line">    &#123;</span><br><span class="line">        proxy_pass http:<span class="operator">/</span><span class="operator">/</span><span class="number">172.17</span><span class="number">.0</span><span class="number">.4</span>:<span class="number">80</span><span class="operator">/</span>;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header X<span class="operator">-</span>Forwarded<span class="operator">-</span><span class="keyword">For</span> $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_connect_timeout <span class="number">30</span>;</span><br><span class="line">        proxy_send_timeout <span class="number">60</span>;</span><br><span class="line">        proxy_read_timeout <span class="number">60</span>;</span><br><span class="line">        proxy_buffering <span class="keyword">on</span>;</span><br><span class="line">        proxy_buffer_size <span class="number">32</span>k;</span><br><span class="line">        proxy_buffers <span class="number">4</span> <span class="number">128</span>k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#phpadmin配置</span><br><span class="line">    server &#123;</span><br><span class="line">    listen       <span class="number">81</span>;</span><br><span class="line">    server_name  phpmyadmin.wordpress.com;</span><br><span class="line">    location <span class="operator">/</span> &#123;</span><br><span class="line">            proxy_pass http:<span class="operator">/</span><span class="operator">/</span><span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span>:<span class="number">80</span><span class="operator">/</span>;</span><br><span class="line">            proxy_set_header Host $http_host;</span><br><span class="line">            proxy_set_header X<span class="operator">-</span>Forwarded<span class="operator">-</span><span class="keyword">For</span> $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_connect_timeout <span class="number">30</span>;</span><br><span class="line">            proxy_send_timeout <span class="number">60</span>;</span><br><span class="line">            proxy_read_timeout <span class="number">60</span>;</span><br><span class="line">            proxy_buffering <span class="keyword">on</span>;</span><br><span class="line">            proxy_buffer_size <span class="number">32</span>k;</span><br><span class="line">            proxy_buffers <span class="number">4</span> <span class="number">128</span>k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#检查配置文件</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>etc<span class="operator">/</span>nginx<span class="operator">/</span>conf.d]#nginx <span class="operator">-</span>t</span><br><span class="line">nginx: the configuration file <span class="operator">/</span>etc<span class="operator">/</span>nginx<span class="operator">/</span>nginx.conf syntax <span class="keyword">is</span> ok</span><br><span class="line">nginx: configuration file <span class="operator">/</span>etc<span class="operator">/</span>nginx<span class="operator">/</span>nginx.conf test <span class="keyword">is</span> successful</span><br><span class="line">#重启nginx</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>etc<span class="operator">/</span>nginx<span class="operator">/</span>conf.d]#systemctl restart nginx</span><br></pre></td></tr></table></figure><h2 id="7-访问web应用"><a href="#7-访问web应用" class="headerlink" title="7.访问web应用"></a>7.访问web应用</h2><p><strong>配置本地hosts解析</strong></p><blockquote><p>10.0.0.107 dongxing.wordpress.com phpmyadmin.wordpress.com</p></blockquote><p><strong>访问dongxing.wordpress.com初始化安装wordpress,在mysql容器上创建数据库与链接用户</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#创建授权</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;wordpress&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> wordpress.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;wordpress&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database wordpress;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看创建数据库时使用的<span class="keyword">sql</span>语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database wordpress;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+-------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Database  <span class="operator">|</span> <span class="keyword">Create</span> Database                                                                                                                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+-------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> wordpress <span class="operator">|</span> <span class="keyword">CREATE</span> DATABASE `wordpress` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */</span> <span class="comment">/*!80016 DEFAULT ENCRYPTION=&#x27;N&#x27; */</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+-------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">#查看登录白名单</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="keyword">user</span>,host <span class="keyword">FROM</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>             <span class="operator">|</span> host      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> root             <span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> wordpress        <span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.infoschema <span class="operator">|</span> localhost <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.session    <span class="operator">|</span> localhost <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.sys        <span class="operator">|</span> localhost <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> root             <span class="operator">|</span> localhost <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看用户权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> wordpress@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> wordpress@<span class="operator">%</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> `wordpress`@`<span class="operator">%</span>`                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> `wordpress`.<span class="operator">*</span> <span class="keyword">TO</span> `wordpress`@`<span class="operator">%</span>` <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p><strong>初始化安装好后，登录发表一篇文章</strong></p><p><img src="/image-20240731165424911.png" alt="image-20240731165424911"></p><h2 id="8-访问web管理工具"><a href="#8-访问web管理工具" class="headerlink" title="8.访问web管理工具"></a>8.访问web管理工具</h2><p>跳过</p><h1 id="容器化部署zabbix"><a href="#容器化部署zabbix" class="headerlink" title="容器化部署zabbix"></a>容器化部署zabbix</h1><p>!<img src="/image-20240801155348671.png" alt="image-20240801155348671"></p><h2 id="1-数据库容器部署"><a href="#1-数据库容器部署" class="headerlink" title="1.数据库容器部署"></a>1.数据库容器部署</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#准备镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images<span class="operator">|</span>grep mysql</span><br><span class="line">mysql        latest     <span class="number">3218</span>b38490ce   <span class="number">2</span> years ago   <span class="number">516</span>MB</span><br><span class="line"></span><br><span class="line">#准备宿主机数据卷映射目录</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#mkdir <span class="operator">-</span>p <span class="operator">/</span>zabbix<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>&#123;conf,data,files&#125;</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#cd <span class="operator">/</span>zabbix<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>zabbix<span class="operator">-</span>container<span class="operator">/</span>mysql]#ls</span><br><span class="line">conf  data  files</span><br><span class="line"></span><br><span class="line">#准备映射容器内的MYSQL配置</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>zabbix<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>conf<span class="operator">/</span>my.conf <span class="operator">&lt;&lt;</span><span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[mysqld]</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">=</span>utf8mb4</span><br><span class="line"><span class="keyword">collation</span><span class="operator">-</span>server<span class="operator">=</span>utf8mb4_general_ci</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#启动容器，数据卷映射，并传入变量创建zabbix用户</span><br><span class="line">docker run  \</span><br><span class="line"><span class="comment">--name zabbix-mysql --restart=always \</span></span><br><span class="line"><span class="operator">-</span>v <span class="operator">/</span>zabbix<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>:<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span> \</span><br><span class="line"><span class="operator">-</span>v <span class="operator">/</span>zabbix<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>conf<span class="operator">/</span>:<span class="operator">/</span>etc<span class="operator">/</span>mysql<span class="operator">/</span> \</span><br><span class="line"><span class="operator">-</span>v <span class="operator">/</span>zabbix<span class="operator">-</span>container<span class="operator">/</span>mysql<span class="operator">/</span>files<span class="operator">/</span>:<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">-</span>files \</span><br><span class="line"><span class="operator">-</span>e MYSQL_ROOT_PASSWORD<span class="operator">=</span>&quot;1&quot;  \</span><br><span class="line"><span class="operator">-</span>e MYSQL_USER<span class="operator">=</span><span class="string">&#x27;zabbix&#x27;</span> \</span><br><span class="line"><span class="operator">-</span>e MYSQL_PASSWORD<span class="operator">=</span><span class="string">&#x27;1&#x27;</span> \</span><br><span class="line"><span class="operator">-</span>d mysql:latest</span><br><span class="line"></span><br><span class="line">#检查容器进程</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                 NAMES</span><br><span class="line"><span class="number">5328</span>b4d6a897   mysql:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">4</span> seconds ago   Up <span class="number">2</span> seconds   <span class="number">3306</span><span class="operator">/</span>tcp, <span class="number">33060</span><span class="operator">/</span>tcp   zabbix<span class="operator">-</span>my</span><br><span class="line"></span><br><span class="line">#检查容器运行地址</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect zabbix<span class="operator">-</span>mysql <span class="comment">--format=&#x27;&#123;&#123;.Name&#125;&#125;   &#123;&#123;.NetworkSettings.Networks.bridge.IPAddress&#125;&#125;&#x27;</span></span><br><span class="line"><span class="operator">/</span>zabbix<span class="operator">-</span>mysql   <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line"></span><br><span class="line">#进入容器检查数据库运行状态与库创建用户权限信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">exec</span> <span class="operator">-</span>it zabbix<span class="operator">-</span>mysql  bash</span><br><span class="line">root<span class="variable">@5328b4d6a897</span>:<span class="operator">/</span># mysql <span class="operator">-</span>uzabbix <span class="operator">-</span>p <span class="operator">-</span>h172<span class="number">.17</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">Enter password: </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zabbix             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> zabbix ;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> zabbix@<span class="operator">%</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> `zabbix`@`<span class="operator">%</span>`                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> `zabbix`.<span class="operator">*</span> <span class="keyword">TO</span> `zabbix`@`<span class="operator">%</span>` <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-服务端容器部署"><a href="#2-服务端容器部署" class="headerlink" title="2.服务端容器部署"></a>2.服务端容器部署</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#镜像准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">search</span> zabbix<span class="operator">|</span>grep zabbix  </span><br><span class="line">zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>agent                       Zabbix agent <span class="keyword">with</span> TLS encryption support        <span class="number">230</span>       </span><br><span class="line">zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>web<span class="operator">-</span>nginx<span class="operator">-</span>mysql             Zabbix frontend based <span class="keyword">on</span> Nginx web<span class="operator">-</span>server wi…   <span class="number">256</span>       </span><br><span class="line">zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>server<span class="operator">-</span>mysql                Zabbix Server <span class="keyword">with</span> MySQL database support       <span class="number">413</span>      </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#镜像下载</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>web<span class="operator">-</span>nginx<span class="operator">-</span>mysql</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>server<span class="operator">-</span>mysql</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images<span class="operator">|</span>grep zabbix</span><br><span class="line">zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>web<span class="operator">-</span>nginx<span class="operator">-</span>mysql   latest     <span class="number">7</span>ce5ac13bc18   <span class="number">2</span> years ago   <span class="number">179</span>MB</span><br><span class="line">zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>server<span class="operator">-</span>mysql      latest     cdd7911de13a   <span class="number">2</span> years ago   <span class="number">67.7</span>MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#容器启动</span><br><span class="line">docker run  \</span><br><span class="line"><span class="comment">--name zabbix-server-mysql \</span></span><br><span class="line"><span class="comment">--link zabbix-mysql \</span></span><br><span class="line"><span class="operator">-</span>e DB_SERVER_HOST<span class="operator">=</span>&quot;zabbix-mysql&quot; \</span><br><span class="line"><span class="operator">-</span>e MYSQL_USER<span class="operator">=</span>&quot;zabbix&quot; \</span><br><span class="line"><span class="operator">-</span>e MYSQL_PASSWORD<span class="operator">=</span>&quot;1&quot; \</span><br><span class="line"><span class="operator">-</span>p <span class="number">10051</span>:<span class="number">10051</span> \</span><br><span class="line"><span class="operator">-</span>d zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>server<span class="operator">-</span>mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查容器进程</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE                        COMMAND                  CREATED          STATUS          PORTS                                           NAMES</span><br><span class="line"><span class="number">22</span>b382ed5fd6   zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>server<span class="operator">-</span>mysql   &quot;/sbin/tini -- /usr/…&quot;   <span class="number">25</span> seconds ago   Up <span class="number">24</span> seconds   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">10051</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">10051</span><span class="operator">/</span>tcp, :::<span class="number">10051</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">10051</span><span class="operator">/</span>tcp   zabbix<span class="operator">-</span>server<span class="operator">-</span>mysql</span><br><span class="line"><span class="number">4759083</span>a4d6e   mysql:latest                 &quot;docker-entrypoint.s…&quot;   <span class="number">8</span> minutes ago    Up <span class="number">8</span> minutes    <span class="number">3306</span><span class="operator">/</span>tcp, <span class="number">33060</span><span class="operator">/</span>tcp                             zabbix<span class="operator">-</span>mysql</span><br></pre></td></tr></table></figure><h3 id="2-1-服务端为什么要映射外部端口"><a href="#2-1-服务端为什么要映射外部端口" class="headerlink" title="2.1 服务端为什么要映射外部端口"></a>2.1 服务端为什么要映射外部端口</h3><p>在您的Docker容器配置中，您确实在<code>zabbix-server-mysql</code>容器上使用了<code>-p 10051:10051</code>来映射宿主机端口。这个端口的映射主要用于Zabbix服务器的几个可能的原因，尽管从传统的Web访问角度来看，它可能不是直接必需的，但在Zabbix的架构和操作中，这个端口可能扮演着重要角色。</p><h3 id="2-2-Zabbix-Server端口的作用"><a href="#2-2-Zabbix-Server端口的作用" class="headerlink" title="2.2 Zabbix Server端口的作用"></a>2.2 Zabbix Server端口的作用</h3><ol><li><strong>Zabbix Server的API和监控接口</strong>：<ul><li>Zabbix Server不仅处理与数据库的交互来存储监控数据，还提供了API接口供Zabbix前端（Web界面）、Zabbix Agent以及其他可能的服务使用。端口10051通常是Zabbix Server用于监听这些API请求的标准端口。</li><li>尽管Web前端（zabbix-web-nginx-mysql）是用户交互的主要界面，但它依赖于与Zabbix Server的通信来获取数据和发送命令。</li></ul></li><li><strong>直接访问和调试</strong>：<ul><li>在某些情况下，直接访问Zabbix Server的端口可以用于调试、监控或直接从命令行工具与Zabbix Server进行交互。</li><li>端口映射允许您从宿主机上直接访问这些服务，而无需通过Docker网络进行路由。</li></ul></li><li><strong>分布式部署</strong>：<ul><li>在更复杂的Zabbix部署中，可能涉及多个Zabbix Server或代理服务器。端口映射使得这些服务器之间的通信更加灵活和直接。</li></ul></li></ol><h3 id="2-3-为什么需要映射端口"><a href="#2-3-为什么需要映射端口" class="headerlink" title="2.3 为什么需要映射端口"></a>2.3 为什么需要映射端口</h3><ul><li><strong>网络隔离和安全性</strong>：虽然您可能不需要从外部直接访问Zabbix Server的端口，但在某些安全配置或网络隔离策略下，确保服务在预期的网络边界内是可访问的可能是必要的。</li><li><strong>灵活性</strong>：端口映射提供了额外的灵活性，允许您在需要时轻松调整访问控制或测试配置。</li></ul><h3 id="2-4-结论"><a href="#2-4-结论" class="headerlink" title="2.4 结论"></a>2.4 结论</h3><p>尽管从纯Web访问的角度来看，<code>zabbix-server-mysql</code>容器的端口映射可能不是必需的，但它对于Zabbix的整体运行和可能的未来扩展是有益的。它确保了Zabbix  Server的API和监控接口在需要时是可访问的，并提供了额外的配置和调试选项。如果您的环境不需要这些功能，并且您确信所有必要的通信都可以通过其他方式（如Docker网络）进行，则可以选择不映射该端口。然而，在大多数情况下，保留这些端口映射是更安全和更灵活的选择。</p><h2 id="3-web端部署访问"><a href="#3-web端部署访问" class="headerlink" title="3.web端部署访问"></a>3.web端部署访问</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#镜像准备</span><br><span class="line">##zabbix<span class="operator">-</span>ui组件是通过web服务器<span class="operator">+</span>php代码通过服务端及数据库的接口，最终实现web的展示与使用</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images;</span><br><span class="line">REPOSITORY                      TAG        IMAGE ID       CREATED       SIZE</span><br><span class="line">zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>web<span class="operator">-</span>nginx<span class="operator">-</span>mysql   latest     <span class="number">7</span>ce5ac13bc18   <span class="number">2</span> years ago   <span class="number">179</span>MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动容器</span><br><span class="line">docker run \</span><br><span class="line"><span class="comment">--name zabbix-web-nginx-mysql \</span></span><br><span class="line"><span class="comment">--link zabbix-mysql \</span></span><br><span class="line"><span class="comment">--link zabbix-server-mysql \</span></span><br><span class="line"><span class="operator">-</span>e DB_SERVER_HOST<span class="operator">=</span>&quot;zabbix-mysql&quot; \</span><br><span class="line"><span class="operator">-</span>e MYSQL_USER<span class="operator">=</span>&quot;zabbix&quot; \</span><br><span class="line"><span class="operator">-</span>e MYSQL_PASSWORD<span class="operator">=</span>&quot;1&quot; \</span><br><span class="line"><span class="operator">-</span>e ZBX_SERVER_HOST<span class="operator">=</span>&quot;zabbix-server-mysql&quot; \</span><br><span class="line"><span class="operator">-</span>e PHP_TZ<span class="operator">=</span>&quot;Asia/Shanghai&quot; \</span><br><span class="line"><span class="operator">-</span>p <span class="number">80</span>:<span class="number">8080</span> \</span><br><span class="line"><span class="operator">-</span>d zabbix<span class="operator">/</span>zabbix<span class="operator">-</span>web<span class="operator">-</span>nginx<span class="operator">-</span>mysql</span><br></pre></td></tr></table></figure><p><strong>测试访问web</strong></p><p>默认账户Admin，密码zabbix</p><p><img src="/image-20240801180341099.png" alt="image-20240801180341099"></p><p><strong>语言转换为中文</strong></p><p>转换成中文，就可以下载客户端agent组件进行监控主机了</p><p><img src="/image-20240801180824553.png" alt="image-20240801180824553"></p><h2 id="4-容器部署zabbix报错"><a href="#4-容器部署zabbix报错" class="headerlink" title="4.容器部署zabbix报错"></a>4.容器部署zabbix报错</h2><p><strong>cannot use database “zabbix”: its “users” table is empty (is this the Zabbix proxy database?)中文：无法使用数据库“zabbix”：其“用户”表为空（这是 Zabbix 代理数据库吗？）</strong></p><p><img src="/image-20240801173521988.png" alt="image-20240801173521988"></p><p><strong>报错原因：</strong></p><blockquote><p>数据库中已有zabbix这个库，创建MYSQL容器时指定变量创建了zabbix库</p><p>到了zabbix服务端连接数据库时，会创建库并且导入相关数据表，发现无法创建，就报错了</p></blockquote><p><strong>解决方法：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#进入MYSQL容器删除zabbix库即可</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">exec</span> <span class="operator">-</span>it zabbix<span class="operator">-</span>mysql bash</span><br><span class="line">root<span class="variable">@4759083a4d6e</span>:<span class="operator">/</span># mysql <span class="operator">-</span>uzabbix <span class="operator">-</span>p</span><br><span class="line">Enter password: </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zabbix             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zabbix ;</span><br><span class="line">Query OK, <span class="number">14</span> <span class="keyword">rows</span> affected (<span class="number">0.14</span> sec)</span><br></pre></td></tr></table></figure><h1 id="容器化部署jenkins"><a href="#容器化部署jenkins" class="headerlink" title="容器化部署jenkins"></a>容器化部署jenkins</h1><h2 id="1-部署运行容器"><a href="#1-部署运行容器" class="headerlink" title="1.部署运行容器"></a>1.部署运行容器</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#镜像准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">search</span> jenkins</span><br><span class="line">NAME                                  DESCRIPTION                                     STARS     OFFICIAL</span><br><span class="line">jenkins                               DEPRECATED; use &quot;jenkins/jenkins:lts&quot; instead   <span class="number">5694</span>      [OK]</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull jenkins </span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images<span class="operator">|</span>grep jenkins</span><br><span class="line">jenkins                         latest     cd14cecfdb3a   <span class="number">6</span> years ago   <span class="number">696</span>MB</span><br><span class="line"></span><br><span class="line">#宿主机数据卷授权，容器内系统登录的是虚拟用户，所以需要授权</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#useradd <span class="operator">-</span>M <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin jenkins</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#id jenkins</span><br><span class="line">uid<span class="operator">=</span><span class="number">1000</span>(jenkins) gid<span class="operator">=</span><span class="number">1000</span>(jenkins) <span class="keyword">groups</span><span class="operator">=</span><span class="number">1000</span>(jenkins)</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#mkdir <span class="operator">-</span>p <span class="operator">/</span>jenkins<span class="operator">-</span>container<span class="operator">/</span>jenkins_home</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#chown <span class="operator">-</span>R jenkins.jenkins <span class="operator">/</span>jenkins<span class="operator">-</span>container<span class="operator">/</span>jenkins_home<span class="operator">/</span></span><br><span class="line"></span><br><span class="line">#启动容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="comment">--name jenkins -p 80:8080 -v /jenkins-container/jenkins_home/:/var/jenkins_home/ -d jenkins</span></span><br><span class="line">bd4007e541a52180478f9d1ecb5bf8d60e560f5dd5f8c178adf65cb0725cae89</span><br><span class="line"></span><br><span class="line">#检查容器进程</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS        PORTS                                              NAMES</span><br><span class="line">bd4007e541a5   jenkins   &quot;/bin/tini -- /usr/l…&quot;   <span class="number">2</span> seconds ago   Up <span class="number">1</span> <span class="keyword">second</span>   <span class="number">50000</span><span class="operator">/</span>tcp, <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">8080</span><span class="operator">/</span>tcp, :::<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">8080</span><span class="operator">/</span>tcp   jenkins</span><br></pre></td></tr></table></figure><h2 id="2-提权运行容器"><a href="#2-提权运行容器" class="headerlink" title="2.提权运行容器"></a>2.提权运行容器</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line"><span class="comment">--name jenkins \</span></span><br><span class="line"><span class="operator">-</span>p <span class="number">8080</span>:<span class="number">8080</span> <span class="operator">-</span>p <span class="number">50000</span>:<span class="number">50000</span> \</span><br><span class="line"><span class="comment">--privileged=true \</span></span><br><span class="line"><span class="comment">--user root \</span></span><br><span class="line"><span class="operator">-</span>v  <span class="operator">/</span>jenkins_home<span class="operator">/</span>:<span class="operator">/</span>var<span class="operator">/</span>jenkins_home<span class="operator">/</span> \</span><br><span class="line"><span class="operator">-</span>d  jenkin</span><br></pre></td></tr></table></figure><blockquote><p>Jenkins作为一个持续集成和持续部署（CI&#x2F;CD）工具，本身并不直接涉及操作系统层面的提权需求。然而，在特定场景下，Jenkins可能会因为执行特定任务或脚本而需要提升权限，这通常是为了能够访问或修改系统上的资源，这些资源可能受到操作系统的权限控制。</p></blockquote><p>Jenkins需要提权的原因可能包括但不限于以下几点：</p><ol><li><strong>访问受保护的资源</strong>：Jenkins在构建、测试或部署应用程序时，可能需要访问系统上的敏感文件或目录，如系统配置文件、日志文件等。这些资源可能只有超级用户（root）或具有特定权限的用户才能访问。因此，Jenkins可能需要提升权限以执行这些操作。</li><li><strong>执行系统命令</strong>：在某些情况下，Jenkins需要执行系统命令来完成构建或部署过程。如果这些命令需要更高的权限才能执行（例如，安装软件包、修改网络配置等），那么Jenkins就需要相应的权限。</li><li><strong>安全性考虑</strong>：虽然提升权限可以带来便利，但也增加了安全风险。如果Jenkins的权限过高，一旦Jenkins系统被攻击或配置不当，攻击者就可能利用这些权限对系统进行更严重的破坏。因此，在提升Jenkins权限时，需要仔细考虑安全性和必要性。</li><li><strong>自动化需求</strong>：在自动化构建和部署流程中，Jenkins经常需要执行一系列复杂的任务。这些任务可能涉及多个步骤和多个系统组件的交互。为了确保流程的顺畅进行，Jenkins可能需要提升权限以克服各种权限限制和障碍。</li><li><strong>特定场景下的需求</strong>：在某些特定场景下，如部署到生产环境时，Jenkins可能需要执行一些特殊的操作（如重启服务、修改数据库配置等），这些操作通常需要较高的权限。</li></ol><p>需要注意的是，虽然Jenkins在某些情况下需要提升权限，但并不意味着它应该始终以最高权限运行。相反，为了降低安全风险，建议采用最小权限原则来配置Jenkins的运行权限。同时，也可以通过使用sudo等工具来限制Jenkins在特定命令或脚本上的权限提升行为。</p><p>此外，对于Jenkins的提权问题，还需要注意以下几点：</p><ul><li>确保Jenkins的配置文件（如jenkins.xml）和插件等组件的安全性，避免被恶意修改或利用。</li><li>定期检查Jenkins的日志文件和系统日志，以发现潜在的安全问题或异常行为。</li><li>对Jenkins的访问权限进行严格控制，避免未经授权的访问和操作。</li><li>定期对Jenkins进行更新和维护，以确保其安全性和稳定性。</li></ul><h2 id="3-调用宿主机命令"><a href="#3-调用宿主机命令" class="headerlink" title="3.调用宿主机命令"></a>3.调用宿主机命令</h2><p><strong>如何在容器化的jenkins里，再执行docker命令？</strong></p><p>我们毕竟要基于jenkins去实现对容器的管理，那么jenkins所处的运行环境，也得安装docker命令，或者走http的管理接口更为方便</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line"><span class="comment">--name jenkins \</span></span><br><span class="line"><span class="operator">-</span>p <span class="number">8080</span>:<span class="number">8080</span> <span class="operator">-</span>p <span class="number">50000</span>:<span class="number">50000</span> \</span><br><span class="line"><span class="comment">--privileged=true \</span></span><br><span class="line"><span class="comment">--user root \</span></span><br><span class="line"><span class="operator">-</span>v <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>docker:<span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>docker \</span><br><span class="line"><span class="operator">-</span>v <span class="operator">/</span>var<span class="operator">/</span>run<span class="operator">/</span>docker.sock:<span class="operator">/</span>var<span class="operator">/</span>run<span class="operator">/</span>docker.sock \</span><br><span class="line"><span class="operator">-</span>v <span class="operator">/</span>jenkins_home<span class="operator">/</span>:<span class="operator">/</span>var<span class="operator">/</span>jenkins_home \</span><br><span class="line"><span class="operator">-</span>d jenkins<span class="operator">/</span>jenkins</span><br></pre></td></tr></table></figure><p><img src="/image-20240801192307475.png" alt="image-20240801192307475"></p><h2 id="4-疑惑解决"><a href="#4-疑惑解决" class="headerlink" title="4.疑惑解决"></a>4.疑惑解决</h2><h3 id="4-1-容器暴露50000端口原因"><a href="#4-1-容器暴露50000端口原因" class="headerlink" title="4.1 容器暴露50000端口原因"></a>4.1 容器暴露50000端口原因</h3><p>在Docker中运行Jenkins时，通常会暴露两个端口：8080和50000。这两个端口都有特定的用途，对于Jenkins的正常运行至关重要。</p><ol><li><strong>端口8080</strong>：<ul><li>端口8080是Jenkins的Web界面和REST API的默认端口。用户通过浏览器访问这个端口来访问Jenkins的仪表板、管理界面、查看构建历史、触发新的构建等。简而言之，这是用户与Jenkins进行交互的主要方式。</li></ul></li><li><strong>端口50000</strong>：<ul><li>端口50000用于Jenkins的分布式构建功能，特别是当Jenkins master需要与Jenkins agent（也称为slave或node）进行通信时。Jenkins的分布式构建允许你在多个机器上并行运行构建任务，以加快构建过程。</li><li>当Jenkins master分配一个构建任务给agent时，它们之间会建立一个TCP连接，用于传输构建任务所需的文件、执行构建命令，并收集构建结果。默认情况下，这个连接是通过端口50000建立的。</li><li>如果你的Jenkins部署不需要分布式构建功能，理论上你可以不暴露这个端口。然而，保留这个端口对于未来可能需要的扩展性是有好处的。</li></ul></li></ol><h3 id="4-2-宿主机创建虚拟用户原因"><a href="#4-2-宿主机创建虚拟用户原因" class="headerlink" title="4.2 宿主机创建虚拟用户原因"></a>4.2 宿主机创建虚拟用户原因</h3><blockquote><p>关于用户</p></blockquote><p><strong>容器内用户</strong>：在Docker容器中，通常会创建一个或多个用户来运行应用服务，这是出于安全考虑。例如，Jenkins容器内部可能有一个<code>jenkins</code>用户来运行Jenkins服务。这个用户是容器内部的用户，与宿主机上的用户没有直接关系。</p><p><strong>宿主机用户与容器内用户的关系</strong>：虽然宿主机和容器内的用户不是同一个实体，但你可以通过调整宿主机上文件或目录的权限和所有权，来允许容器内的用户访问这些资源。这是因为Docker容器在宿主机上运行时，会模拟一个文件系统，并通过虚拟层来访问宿主机的实际文件系统。</p><blockquote><p>关于数据卷和权限</p></blockquote><p><strong>数据卷</strong>：Docker数据卷是一种特殊的存储机制，允许你将容器内的文件系统路径与宿主机上的文件系统路径进行映射。这样，容器就可以访问和操作宿主机上的文件了。</p><p><strong>权限设置</strong>：为了确保容器内的进程（如Jenkins服务）能够正确访问宿主机上的数据卷，你需要在宿主机上调整数据卷目录的权限和所有权。这通常涉及到使用<code>chown</code>和<code>chmod</code>命令来设置正确的用户和组权限。</p><p>例如，如果你希望Jenkins容器内的<code>jenkins</code>用户能够访问宿主机上的<code>/www.yuchaoit.cn_data/jenkins/</code>目录，你需要确保这个目录在宿主机上的所有权和权限被设置为允许<code>jenkins</code>用户（或对应的UID和GID）进行读写操作。但是，请注意，这里的<code>jenkins</code>用户并不是宿主机上的实际用户，而是指容器内部使用的用户ID（UID）和组ID（GID）。</p><p><strong>UID和GID的映射</strong>：在某些情况下，你可能需要确保容器内的UID和GID与宿主机上的某个用户或组相对应。这通常涉及到Docker的高级配置，如使用<code>--userns</code>选项来配置用户命名空间，但这通常不是必需的，除非你有特定的安全或兼容性需求。</p><p>总结来说，虽然你不会在宿主机上直接创建与容器内同名的用户，但你需要通过调整宿主机上文件或目录的权限和所有权来确保容器内的进程能够正确访问这些资源。这是Docker容器化应用时管理权限和文件访问的一种常见做法。</p><h1 id="多容器运行工具compose"><a href="#多容器运行工具compose" class="headerlink" title="多容器运行工具compose"></a>多容器运行工具compose</h1><h2 id="1-Docker-Compose概述"><a href="#1-Docker-Compose概述" class="headerlink" title="1.Docker Compose概述"></a>1.Docker Compose概述</h2><p>Docker Compose是一个命令行工具，它用于定义和运行多容器Docker应用程序。通过Compose，开发者可以使用YAML文件（通常是<code>docker-compose.yml</code>）来配置应用程序需要的所有服务。这些服务会作为容器在Docker中运行，并且可以通过Compose命令来管理这些容器的生命周期，如启动、停止和重启。</p><h2 id="1-Docker-Compose的主要功能"><a href="#1-Docker-Compose的主要功能" class="headerlink" title="1.Docker Compose的主要功能"></a>1.Docker Compose的主要功能</h2><ol><li><strong>服务定义</strong>：通过<code>docker-compose.yml</code>文件，用户可以定义应用程序所需的所有服务（容器），包括它们的配置、网络设置和依赖关系。</li><li><strong>一键部署</strong>：使用<code>docker-compose up</code>命令，用户可以一键启动并运行所有在<code>docker-compose.yml</code>文件中定义的服务。</li><li><strong>环境隔离</strong>：Compose为每个项目创建一个默认的网络，服务之间可以通过容器名称相互访问，从而实现环境隔离。</li><li><strong>依赖管理</strong>：Compose会自动处理容器之间的依赖关系，确保服务按照正确的顺序启动。</li><li><strong>配置管理</strong>：用户可以在<code>docker-compose.yml</code>文件中指定环境变量、卷和端口映射等配置，以便在不同环境中轻松部署应用程序。</li></ol><h2 id="2-语法使用"><a href="#2-语法使用" class="headerlink" title="2.语法使用"></a>2.语法使用</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    image: <span class="string">&#x27;jenkins/jenkins:latest&#x27;</span></span><br><span class="line">    container_name: jenkins </span><br><span class="line">    restart: always</span><br><span class="line">    privileged: <span class="literal">true</span></span><br><span class="line">    <span class="keyword">user</span>: root</span><br><span class="line">    ports:</span><br><span class="line">      <span class="operator">-</span> <span class="string">&#x27;8080:8080&#x27;</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">&#x27;50000:50000&#x27;</span></span><br><span class="line">    volumes:</span><br><span class="line">      <span class="operator">-</span> <span class="string">&#x27;/data/jenkins:/var/jenkins_home&#x27;</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">&#x27;/var/run/docker.sock:/var/run/docker.sock&#x27;</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">&#x27;/usr/bin/docker:/usr/bin/docker&#x27;</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">&#x27;/root/.ssh:/root/.ssh&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="私有仓库harbor搭建"><a href="#私有仓库harbor搭建" class="headerlink" title="私有仓库harbor搭建"></a>私有仓库harbor搭建</h1><h2 id="1-仓库概述"><a href="#1-仓库概述" class="headerlink" title="1.仓库概述"></a>1.仓库概述</h2><p>Docker Registry有两种形式</p><ul><li>公开，开放给所有用户，提供给所有用户搜索，拉取，提交，更新镜像，还免费保管用户镜像数据。<ul><li>此类服务受限于网络限制，无法及时立即获取所需镜像，简单说就是需要用什么得现下载，得看网速</li><li>优点是可以获取绝大部分公开的镜像，方便使用</li></ul></li><li>私有范围的Registry服务，用在学校，企业内网的研发环境<ul><li>局域网环境，保证了镜像拉取速度</li><li>保证核心镜像数据安全</li><li>存在镜像不丰富问题</li></ul></li></ul><h2 id="2-公开服务仓库"><a href="#2-公开服务仓库" class="headerlink" title="2.公开服务仓库"></a>2.公开服务仓库</h2><p>最常见的Registry是Docker Hub，也是docker默认允许用户管理镜像的Registry服务，拥有大量高质量的官方镜像。</p><p>由于网络地域原因，公开服务在国内访问较慢，也就出现了针对镜像服务的加速器。</p><ul><li><a href="http://book.bikongge.com/sre/10-%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/docker-all/www.yuchaoit.cn">阿里云加速器</a></li><li>DaoCloud加速器</li><li>灵雀云加速器</li><li>等等</li></ul><p>使用加速器，可以从国内的地址获取Docker Hub的镜像，速度会快很多。</p><h2 id="3-私有服务仓库"><a href="#3-私有服务仓库" class="headerlink" title="3.私有服务仓库"></a>3.私有服务仓库</h2><p>除了私用公开服务外，还可以在自己本地搭建私有Docker Registry。</p><p>开源的Docker Registry镜像只提供了Docker Registry API的功能，没有图形化功能。</p><h2 id="4-仓库搭建"><a href="#4-仓库搭建" class="headerlink" title="4.仓库搭建"></a>4.仓库搭建</h2><p>暂未记录</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;容器启动link链接作用&quot;&gt;&lt;a href=&quot;#容器启动link链接作用&quot; class=&quot;headerlink&quot; title=&quot;容器启动link链接作用&quot;&gt;&lt;/a&gt;容器启动link链接作用&lt;/h1&gt;&lt;p&gt;&lt;code&gt;docker run&lt;/code&gt; 命令是 Do</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-镜像构建</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/</id>
    <published>2024-08-20T01:31:29.000Z</published>
    <updated>2024-08-20T03:05:20.574Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、dockerfile原理"><a href="#一、dockerfile原理" class="headerlink" title="一、dockerfile原理"></a>一、dockerfile原理</h1><h2 id="1-镜像构建与提交的区别"><a href="#1-镜像构建与提交的区别" class="headerlink" title="1.镜像构建与提交的区别"></a>1.镜像构建与提交的区别</h2><blockquote><p>dockerfile和commit区别</p></blockquote><h3 id="1-1-可重复性"><a href="#1-1-可重复性" class="headerlink" title="1.1 可重复性"></a>1.1 可重复性</h3><ul><li><p><strong>场景：</strong>假设您有一个Web应用程序，它依赖于特定的软件版本和配置。如果您使用Dockerfile来构建镜像，那么每次运行<code>docker build</code>时，都会根据Dockerfile中的指令精确地安装这些依赖项和配置，确保每次构建的镜像都是相同的。</p></li><li><p><strong>对比：</strong>如果您直接操作一个运行中的容器并安装所需的软件，然后提交为镜像，那么下一次在不同的环境或时间点上重复这个过程时，可能会因为环境差异（如不同的包管理器版本、网络状态等）导致安装的软件版本或配置有所不同。</p></li></ul><h3 id="1-2-版本控制"><a href="#1-2-版本控制" class="headerlink" title="1.2 版本控制"></a>1.2 版本控制</h3><ul><li><strong>场景</strong>：在开发过程中，您可能需要频繁地更改镜像的构建步骤或依赖项。使用Dockerfile，您可以轻松地将其提交到Git等版本控制系统，这样团队成员就可以查看每次更改的历史，并理解为什么进行这些更改。</li><li><strong>对比</strong>：如果您直接提交容器为镜像，并且没有记录这些更改的文档或日志，那么追踪和理解这些更改将变得非常困难。</li></ul><h3 id="1-3-可透明性"><a href="#1-3-可透明性" class="headerlink" title="1.3 可透明性"></a>1.3 可透明性</h3><ul><li><strong>场景</strong>：当您需要将镜像部署到生产环境时，运维团队需要了解镜像中包含了哪些软件和配置。通过查看Dockerfile，他们可以清楚地看到所有构建步骤和依赖项。</li><li><strong>对比</strong>：直接提交的镜像则像是一个“黑盒”，除非通过容器内部查看或使用特定工具进行分析，否则很难了解镜像的具体内容。</li></ul><h3 id="1-4-利于理解与维护"><a href="#1-4-利于理解与维护" class="headerlink" title="1.4 利于理解与维护"></a>1.4 利于理解与维护</h3><ul><li><strong>场景</strong>：随着时间的推移，您的应用程序可能需要更新或修复依赖项。使用Dockerfile，您可以轻松地更新构建步骤，并重新构建镜像。</li><li><strong>对比</strong>：对于直接提交的镜像，更新或修复可能需要重新执行一系列复杂的操作，而这些操作可能不容易被团队成员理解和记忆。</li></ul><h3 id="1-5-自动化"><a href="#1-5-自动化" class="headerlink" title="1.5 自动化"></a>1.5 自动化</h3><ul><li><strong>场景</strong>：在CI&#x2F;CD流程中，您可能希望在每次代码提交时自动构建和测试Docker镜像。使用Dockerfile，您可以轻松地将构建步骤集成到自动化工具中。</li><li><strong>对比</strong>：直接提交的镜像可能难以与自动化工具集成，因为它们的构建过程通常更加复杂和不可预测。</li></ul><h3 id="1-6-总结"><a href="#1-6-总结" class="headerlink" title="1.6 总结"></a>1.6 总结</h3><p><strong>Dockerfile</strong>更适合用于生产环境和长期开发，因为它提供了更高的透明度、可维护性和一致性。通过Dockerfile构建的镜像具有可重复性、可追溯性和资源优化的特点。</p><p><strong>Docker commit</strong>更适合临时性地捕获容器状态作为新的镜像。然而，在需要长期维护和更新的场景下，使用Dockerfile是更推荐的做法。</p><p>在实际应用中，建议优先考虑使用Dockerfile来构建和管理Docker镜像，以充分利用其提供的自动化、可重复性和可追溯性等优势。</p><p>Dockerfile提供了一种结构化和可预测的方式来构建Docker镜像，从而提高了构建过程的可重复性、透明性、易于理解和维护性。它还支持 <code>版本控制</code> 和 <code>自动化流程</code> ，这些特性对于在开发、测试和生产环境中管理Docker镜像至关重要。相比之下，直接提交Docker镜像虽然可能在某些情况下更快捷，但长期来看会带来一系列的问题和限制。</p><h2 id="2-docker镜像构建缓存机制"><a href="#2-docker镜像构建缓存机制" class="headerlink" title="2.docker镜像构建缓存机制"></a>2.docker镜像构建缓存机制</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune #清理缓存</span><br></pre></td></tr></table></figure><p>在Docker镜像构建的上下文中，缓存机制的工作原理如下：</p><ol><li><strong>依赖检查</strong>：当Docker开始构建一个镜像时，它会首先读取Dockerfile中的指令。Dockerfile是一个文本文件，包含了一系列用于定义如何构建Docker镜像的命令。Docker会按顺序执行这些指令。</li><li><strong>缓存查找</strong>：对于Dockerfile中的每一条指令，Docker都会检查是否已经有一个之前的构建步骤（使用相同的指令和参数）生成的缓存层。这是通过比较当前指令及其依赖（如之前的指令的输出）与缓存中的层来实现的。</li><li><strong>使用缓存</strong>：如果Docker找到匹配的缓存层，它将直接使用这个缓存层，而不是执行当前指令并生成一个新的层。这意味着如果Dockerfile中的大部分指令都没有变化，只有少数几个指令被修改或添加，那么Docker将能够重用大部分缓存层，从而显著减少构建时间。</li><li><strong>缓存失效</strong>：如果Dockerfile中的任何指令或其依赖（如一个被COPY或ADD指令引入的文件）发生了变化，那么Docker将认为之前的缓存层不再有效，并会从头开始执行该指令及其后续指令，同时生成新的缓存层。</li></ol><p>缓存机制在Docker镜像构建中非常有用，因为它可以大幅减少构建时间，特别是在基础镜像较大或Dockerfile包含多个复杂步骤时。然而，它也引入了潜在的复杂性，因为开发者需要了解如何有效地利用缓存来优化他们的构建过程。</p><p>总结来说，缓存是Docker镜像构建过程中的一个重要特性，它通过存储和重用之前构建步骤的结果来加速构建过程。</p><h2 id="3-dockerfile二次指定jdk变量"><a href="#3-dockerfile二次指定jdk变量" class="headerlink" title="3.dockerfile二次指定jdk变量"></a>3.dockerfile二次指定jdk变量</h2><p><strong>dockerfile中拷贝的profile已经定义了java环境变量为啥构建时还要用ENV指令再指定一次环境变量</strong></p><p>在你的Dockerfile中，你确实已经通过<code>COPY</code>指令将包含Java环境变量配置的<code>profile</code>文件复制到了容器的<code>/etc/profile</code>位置。这个文件通常会在容器启动时由shell（如bash）读取，并设置相应的环境变量。然而，这种做法有几个潜在的问题和考虑点，这解释了为什么Dockerfile中还会使用<code>ENV</code>指令来定义环境变量：</p><ol><li><strong>环境变量加载时机</strong>：<ul><li><code>COPY profile /etc/profile</code>：这个操作是将文件复制到容器内，但并不意味着这些环境变量会立即被设置。它们会在用户登录或启动一个新的shell进程时（通常是bash或sh），通过读取<code>/etc/profile</code>（或其他如<code>.bashrc</code>、<code>.bash_profile</code>等文件）来设置。</li><li><code>ENV</code>指令：在Dockerfile中使用<code>ENV</code>指令设置的环境变量，会在构建镜像的每一步中都可用，并且这些变量会被直接注入到运行容器时创建的环境变量中，不需要通过shell启动脚本来加载。</li></ul></li><li><strong>容器运行时的环境</strong>：<ul><li>当容器以非交互式模式运行时（如直接运行Java应用程序），可能不会启动shell来读取<code>/etc/profile</code>，因此通过<code>profile</code>设置的环境变量可能不会被应用。</li><li>使用<code>ENV</code>指令定义的环境变量，无论容器如何启动，都会生效。</li></ul></li><li><strong>Docker镜像的最佳实践</strong>：<ul><li>使用<code>ENV</code>指令来设置环境变量是Docker镜像构建中的常见做法，因为它清晰、直接，且确保了环境变量在所有情况下都能被正确设置。</li></ul></li><li><strong>避免重复和混淆</strong>：<ul><li>虽然你的<code>profile</code>文件中也定义了环境变量，但使用<code>ENV</code>指令再次定义可以确保这些变量在任何情况下都被正确设置，减少了因配置不一致或遗漏导致的潜在问题。</li></ul></li></ol><p>综上所述，虽然你在<code>profile</code>中定义了Java环境变量，但在Dockerfile中使用<code>ENV</code>指令再次定义这些变量并不是多余的，而是为了确保这些变量在容器中以最可靠和一致的方式被设置。这有助于提高Docker镜像的健壮性和可移植性。</p><h1 id="二、dockerfile指令"><a href="#二、dockerfile指令" class="headerlink" title="二、dockerfile指令"></a>二、dockerfile指令</h1><h2 id="1-run指令"><a href="#1-run指令" class="headerlink" title="1.run指令"></a>1.run指令</h2><p>在Dockerfile中，<code>RUN</code> 指令用于在镜像构建过程中执行命令。理解为什么有时在<code>RUN</code>指令中使用<code>&amp;&amp;</code>以及何时不使用它，有助于更有效地编写Dockerfiles并优化镜像构建过程。</p><h3 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h3><p><code>RUN</code> 指令后面跟随的是要在镜像中执行的命令。每次<code>RUN</code>执行后，Docker都会创建一个新的镜像层，并将结果提交为镜像的一部分。这意味着，如果多个<code>RUN</code>指令修改了同一个文件或目录，那么每个修改都会作为单独的一层存储在镜像中。</p><h3 id="1-2-为什么使用"><a href="#1-2-为什么使用" class="headerlink" title="1.2 为什么使用 &amp;&amp;"></a>1.2 为什么使用 &amp;&amp;</h3><blockquote><p>在<code>RUN</code>指令中使用<code>&amp;&amp;</code>主要是为了链式执行多个命令，并在单个<code>RUN</code>步骤中完成。这样做的优点包括：</p></blockquote><p><strong>1.减少镜像层数：</strong></p><p>通过将多个命令合并为一个<code>RUN</code>指令，可以减少镜像中的层数。因为每个<code>RUN</code>指令都会创建一个新的层，减少层数有助于减小镜像大   小，并可能提高构建速度。</p><p><strong>2.依赖关系：</strong></p><p>当命令之间存在依赖关系时（即后一个命令需要前一个命令的输出或状态），使用<code>&amp;&amp;</code>可以确保这些命令按顺序正确执行。</p><p><strong>3.简化Dockerfile：</strong></p><p>通过减少<code>RUN</code>指令的数量，可以使Dockerfile更加简洁易读。</p><p><strong>示例</strong></p><p>不使用<code>&amp;&amp;</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DockerfileRUN apt-get updateRUN apt-get install -y nginx </span><br></pre></td></tr></table></figure><p>在这个例子中，有两个<code>RUN</code>指令，分别更新了apt包索引并安装了nginx。这会导致镜像中有两个层，每个层都包含了上一步的输出。</p><p>使用<code>&amp;&amp;</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DockerfileRUN apt-get update &amp;&amp; apt-get install -y nginx </span><br></pre></td></tr></table></figure><p>这里，<code>apt-get update</code>和<code>apt-get install -y nginx</code>被合并为一个<code>RUN</code>指令，使用<code>&amp;&amp;</code>确保<code>apt-get update</code>成功执行后才执行<code>apt-get install -y nginx</code>。这样，所有的更改都被包含在同一个层中。</p><h3 id="1-3-何时不使用"><a href="#1-3-何时不使用" class="headerlink" title="1.3 何时不使用 &amp;&amp;"></a>1.3 何时不使用 &amp;&amp;</h3><p>虽然使用<code>&amp;&amp;</code>通常是一个好习惯，但在某些情况下，你可能希望将命令分开到不同的<code>RUN</code>指令中：</p><ul><li><strong>提高可读性</strong>：如果命令链非常长或复杂，将其拆分为多个<code>RUN</code>指令可以提高Dockerfile的可读性。</li><li><strong>缓存优化</strong>：Docker会缓存<code>RUN</code>指令的输出。如果某个<code>RUN</code>指令中的命令很多，但其中只有一小部分经常变化，将它们分开到不同的<code>RUN</code>指令中可能有助于更有效地利用缓存。</li></ul><p>总的来说，是否使用<code>&amp;&amp;</code>取决于你的具体需求，包括你对镜像大小的关注、对构建时间的考虑，以及你希望如何组织Dockerfile中的命令。</p><h2 id="2-cmd指令"><a href="#2-cmd指令" class="headerlink" title="2.cmd指令"></a>2.cmd指令</h2><h2 id="3-volume指令"><a href="#3-volume指令" class="headerlink" title="3.volume指令"></a>3.volume指令</h2><p>在Docker的上下文中，<code>Dockerfile</code>中的<code>VOLUME</code>指令和<code>docker run -v</code>命令虽然都用于处理卷（volumes），但它们的使用场景和目的有所不同。理解这些差异有助于你更好地决定在何时使用哪种方法。</p><h3 id="3-1-Dockerfile的VOLUME指令"><a href="#3-1-Dockerfile的VOLUME指令" class="headerlink" title="3.1 Dockerfile的VOLUME指令"></a>3.1 Dockerfile的VOLUME指令</h3><p>在<code>Dockerfile</code>中使用<code>VOLUME</code>指令时，你实际上是在声明容器运行时应该有哪些挂载点（mount points）被保留为卷。这意味着，当你基于这个<code>Dockerfile</code>构建并运行容器时，Docker会自动为这些指定的目录创建卷（如果它们还不存在的话），并且这些卷独立于容器的生命周期。即使容器被删除，卷中的数据也会保留下来，除非显式地删除卷。</p><p>使用<code>VOLUME</code>指令的主要好处包括：</p><p><strong>数据持久化</strong>：确保即使容器被删除，重要数据也能被保留。</p><p><strong>数据共享</strong>：允许多个容器之间共享数据。</p><p><strong>分离容器与数据</strong>：增强容器的可移植性和重用性，因为你可以轻松地将数据卷挂载到不同的容器上。</p><p>然而，<code>VOLUME</code>指令也有其局限性：</p><ul><li>它不能指定宿主机上的具体路径，只能指定容器内的路径。实际的挂载点（宿主机上的路径）是在容器运行时由Docker自动管理的。</li><li>灵活性较低，因为所有基于该<code>Dockerfile</code>构建的容器都将具有相同的卷配置。</li></ul><h3 id="3-2-docker-run-v命令"><a href="#3-2-docker-run-v命令" class="headerlink" title="3.2 docker run -v命令"></a>3.2 docker run -v命令</h3><p>相比之下，<code>docker run -v</code>（或其等价命令<code>docker run --mount type=volume,...</code>）在容器运行时动态地挂载卷。这使得你能够指定宿主机上的具体路径以及容器内的挂载点。这种方法提供了更高的灵活性，允许你为每个容器定制不同的卷配置。</p><p>使用<code>docker run -v</code>的主要好处包括：</p><ol><li><strong>灵活性</strong>：能够针对每个容器单独指定卷配置。</li><li><strong>明确性</strong>：可以清楚地知道宿主机和容器之间的映射关系。</li></ol><p>然而，它也有其缺点，比如：</p><ul><li>每次运行容器时都需要手动指定卷配置，这可能会增加管理的复杂性。</li><li>如果不在<code>docker run</code>命令中指定卷，则不会自动创建和挂载卷（除非在<code>Dockerfile</code>中定义了<code>VOLUME</code>）。</li></ul><h3 id="3-3-结论"><a href="#3-3-结论" class="headerlink" title="3.3 结论"></a>3.3 结论</h3><p>因此，是否在<code>Dockerfile</code>中定义<code>VOLUME</code>或在<code>docker run</code>时指定<code>-v</code>，取决于你的具体需求。如果你希望所有基于该<code>Dockerfile</code>构建的容器都具有相同的卷配置，那么在<code>Dockerfile</code>中定义<code>VOLUME</code>是一个不错的选择。如果你需要为不同的容器定制不同的卷配置，或者想要在运行时动态地挂载卷，那么使用<code>docker run -v</code>会更合适。在实际应用中，通常会根据具体情况灵活选择使用这两种方法.</p><h2 id="4-workdir指令"><a href="#4-workdir指令" class="headerlink" title="4.workdir指令"></a>4.workdir指令</h2><p><code>Dockerfile</code> 中的 <code>WORKDIR</code> 指令用于为后续的 <code>RUN</code>、<code>CMD</code>、<code>ENTRYPOINT</code>、<code>COPY</code> 和 <code>ADD</code> 指令设置工作目录（working directory）。这一指令的工作原理以及为什么选择使用相对路径而非绝对路径，可以从以下几个方面来理解：</p><p><strong>1.灵活性和可移植性</strong></p><p>使用 <code>WORKDIR</code> 指令时，你设置的是一个相对当前镜像层或基础镜像的目录作为工作目录。这种方式提供了更高的灵活性和可移植性。因为当你基于不同的基础镜像构建时，这些基础镜像的根目录结构可能有所不同。通过使用 <code>WORKDIR</code> 设定一个相对路径，你的 <code>Dockerfile</code> 就能更容易地适应不同的基础镜像，而无需修改硬编码的绝对路径。</p><p><strong>2. 镜像层优化</strong></p><p>Docker 镜像的构建是通过在基础镜像上叠加新的层来实现的。<code>WORKDIR</code> 指令确保了后续的指令（如 <code>RUN</code>、<code>CMD</code> 等）都在这个工作目录下执行。如果 <code>WORKDIR</code> 指向的目录在镜像中不存在，Docker 会自动创建它。这有助于减少镜像层的数量，因为所有在该工作目录下执行的命令都将共享同一个镜像层，而不是每个命令都创建一个新的层。</p><p><strong>3. 简化构建过程</strong></p><p>在 <code>Dockerfile</code> 中使用 <code>WORKDIR</code> 可以减少在每个需要执行命令的地方都指定完整路径的需要。这不仅可以使 <code>Dockerfile</code> 看起来更简洁，而且减少了出错的可能性，因为你不需要记住每个命令的完整路径。</p><p><strong>4. 为什么不直接使用绝对路径？</strong></p><p>尽管技术上你可以在 <code>Dockerfile</code> 中使用绝对路径（例如 <code>/usr/src/app</code>），但这通常不是最佳实践。使用绝对路径可能会使你的 <code>Dockerfile</code> 依赖于特定的基础镜像结构，这可能会降低其可移植性和灵活性。此外，如果基础镜像的目录结构发生变化，使用绝对路径的 <code>Dockerfile</code> 可能会突然无法工作，因为它们无法找到预期的目录。</p><p><strong>结论</strong></p><p>综上所述，<code>WORKDIR</code> 指令通过提供灵活性和可移植性，以及优化镜像层的构建，是 <code>Dockerfile</code> 中一个非常重要的指令。通过使用相对路径而不是绝对路径，你可以编写出更加健壮、易于维护和可移植的 <code>Dockerfile</code>。</p><h2 id="5-entrypoint指令"><a href="#5-entrypoint指令" class="headerlink" title="5.entrypoint指令"></a>5.entrypoint指令</h2><h1 id="三、dockerfile镜像构建"><a href="#三、dockerfile镜像构建" class="headerlink" title="三、dockerfile镜像构建"></a>三、dockerfile镜像构建</h1><blockquote><p>构建镜像时，物料需在与Dockerfile文件同层目录，构建书写文件名时必须是vim &#x3D;&#x3D;D(大写)&#x3D;&#x3D;ockerfile</p></blockquote><h2 id="1-centos-nginx镜像构建-run-v创建卷"><a href="#1-centos-nginx镜像构建-run-v创建卷" class="headerlink" title="1.centos+nginx镜像构建(run-v创建卷)"></a>1.centos+nginx镜像构建(run-v创建卷)</h2><h3 id="书写dockerfile构建镜像"><a href="#书写dockerfile构建镜像" class="headerlink" title="书写dockerfile构建镜像"></a>书写dockerfile构建镜像</h3><p><strong>dockerfile存放目录与所需物料准备</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#存放dockerfile目录</span></span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#<span class="built_in">pwd</span></span><br><span class="line">/dockerfile/centos-nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备了一个163的yum源给镜像提供</span></span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#curl -o  ./CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 root root 2523 Jul 28 11:25 CentOS-Base.repo</span><br></pre></td></tr></table></figure><p><strong>dockerfile书写</strong></p><blockquote><p>注意cmd指令后方加上 <code>分号</code>，否则无法启动容器</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/dockerfile/centos-nginx/Dockerfile &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#基于 CentOS 7.9.2009 镜像</span></span><br><span class="line">FROM centos:7.9.2009</span><br><span class="line"></span><br><span class="line"><span class="comment">#清理原有的 yum 仓库配置</span></span><br><span class="line">RUN <span class="built_in">rm</span> -f /etc/yum.repos.d/*</span><br><span class="line"></span><br><span class="line"><span class="comment">#复制自定义的 yum 仓库配置</span></span><br><span class="line">COPY *.repo /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装 EPEL 仓库和 Nginx</span></span><br><span class="line">RUN yum install epel-release -y \</span><br><span class="line">    &amp;&amp; yum install nginx -y \</span><br><span class="line">    &amp;&amp; yum clean all</span><br><span class="line"></span><br><span class="line"><span class="comment">#暴露 80 端口</span></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置容器启动时运行 Nginx</span></span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>构建镜像并且查看构建结果</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#命令构建</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx]#docker build <span class="operator">-</span>t centos<span class="operator">-</span>nginx<span class="operator">-</span>v1 .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">centos<span class="operator">-</span>nginx<span class="operator">-</span>v1   latest    c8d1b7edda3d   About a <span class="keyword">minute</span> ago   <span class="number">262</span>MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看构建步骤</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history c8d</span><br><span class="line">IMAGE          CREATED              CREATED <span class="keyword">BY</span>                                      SIZE      COMMENT</span><br><span class="line">c8d1b7edda3d   About a <span class="keyword">minute</span> ago   CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon off&quot;]                 <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      About a <span class="keyword">minute</span> ago   EXPOSE map[<span class="number">80</span><span class="operator">/</span>tcp:&#123;&#125;]                           <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      About a <span class="keyword">minute</span> ago   RUN <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c yum install epel<span class="operator">-</span><span class="keyword">release</span> <span class="operator">-</span>y <span class="operator">&amp;</span>…   <span class="number">57.9</span>MB    buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">4</span> minutes ago        <span class="keyword">COPY</span> <span class="operator">*</span>.repo <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="operator">/</span> # buildkit        <span class="number">2.52</span>kB    buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">12</span> minutes ago       RUN <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c rm <span class="operator">-</span>f <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="comment">/* # bu…   0B        buildkit.dockerfile.v0</span></span><br><span class="line"><span class="comment">&lt;missing&gt;      2 years ago          /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span></span><br><span class="line"><span class="comment">&lt;missing&gt;      2 years ago          /bin/sh -c #(nop)  LABEL org.label-schema.sc…   0B        </span></span><br><span class="line"><span class="comment">&lt;missing&gt;      2 years ago          /bin/sh -c #(nop) ADD file:b3ebbe8bd304723d4…   204MB   </span></span><br></pre></td></tr></table></figure><h3 id="运行容器不-v挂载查看卷信息"><a href="#运行容器不-v挂载查看卷信息" class="headerlink" title="运行容器不-v挂载查看卷信息"></a>运行容器不-v挂载查看卷信息</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#基于镜像运行容器</span><br><span class="line">docker run <span class="operator">-</span>d <span class="comment">--name test-nginx --rm -P e37d636bffd4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看容器的详细信息中的卷mounts信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect <span class="number">1637</span><span class="operator">|</span>jq</span><br><span class="line">    &quot;Mounts&quot;: [],</span><br><span class="line">    &quot;Config&quot;: &#123;</span><br><span class="line">      &quot;Hostname&quot;: &quot;1637a689a2ea&quot;,</span><br><span class="line">      &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">      &quot;User&quot;: &quot;&quot;,</span><br><span class="line">      &quot;AttachStdin&quot;: <span class="literal">false</span>,</span><br><span class="line">      &quot;AttachStdout&quot;: <span class="literal">false</span>,</span><br><span class="line">      &quot;AttachStderr&quot;: <span class="literal">false</span>,</span><br><span class="line">      &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">        &quot;80/tcp&quot;: &#123;&#125;</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure><h3 id="运行容器-v挂载查看卷信息"><a href="#运行容器-v挂载查看卷信息" class="headerlink" title="运行容器-v挂载查看卷信息"></a>运行容器-v挂载查看卷信息</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#手动运行容器时进行<span class="operator">-</span>v卷的挂载</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d <span class="comment">--name test-ngin-v1  --rm -P  -v /containel-volume/centos-nginx/logs:/var/log/nginx/ e37d636bffd4</span></span><br><span class="line"><span class="number">4</span>f0ab520970cf0a206f5d92857e642baafc4fcf14e460558b958556fe601bf5b</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ls <span class="operator">/</span>containel<span class="operator">-</span>volume<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">/</span>logs<span class="operator">/</span></span><br><span class="line">access.log  error.log</span><br><span class="line"></span><br><span class="line">#查看容器进程信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                     NAMES</span><br><span class="line"><span class="number">4</span>f0ab520970c   e37d636bffd4   &quot;nginx -g &#x27;daemon of…&quot;   <span class="number">6</span> minutes ago    Up <span class="number">6</span> minutes    <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">32773</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">32773</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp   test<span class="operator">-</span>ngin<span class="operator">-</span>v1</span><br><span class="line"><span class="number">1637</span>a689a2ea   e37d636bffd4   &quot;nginx -g &#x27;daemon of…&quot;   <span class="number">13</span> minutes ago   Up <span class="number">13</span> minutes   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">32771</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">32771</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp   test<span class="operator">-</span>nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看容器详细信息，卷挂载后可以在inspect信息中查看到挂载的信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect <span class="number">4</span>f0<span class="operator">|</span>jq</span><br><span class="line">   &quot;Mounts&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;bind&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/containel-volume/centos-nginx/logs&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;/var/log/nginx&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: <span class="literal">true</span>,</span><br><span class="line">        &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure><h2 id="2-centos-nginx镜像构建-volume指令创建卷"><a href="#2-centos-nginx镜像构建-volume指令创建卷" class="headerlink" title="2.centos+nginx镜像构建(volume指令创建卷)"></a>2.centos+nginx镜像构建(volume指令创建卷)</h2><h3 id="书写dockerfile构建镜像–使用volume指令"><a href="#书写dockerfile构建镜像–使用volume指令" class="headerlink" title="书写dockerfile构建镜像–使用volume指令"></a>书写dockerfile构建镜像–使用volume指令</h3><p><strong>物料yum源</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 /dockerfile]#<span class="built_in">cd</span> centos-nginx/</span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#<span class="built_in">ls</span></span><br><span class="line">CentOS-Base.repo </span><br></pre></td></tr></table></figure><p><strong>书写dockerfile</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 /dockerfile/centos-nginx]#vim Dockerfile </span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#<span class="built_in">cat</span> Dockerfile </span><br><span class="line">From centos:7.9.2009</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">rm</span> -f /etc/yum.repos.d/*</span><br><span class="line"></span><br><span class="line">COPY *.repo /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">RUN yum install epel-release -y \</span><br><span class="line">&amp;&amp;  yum install nginx -y \</span><br><span class="line">&amp;&amp;  yum clean all</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用volume指令指定卷挂载点</span></span><br><span class="line">VOLUME /var/log/nginx/ </span><br><span class="line">VOLUME /etc/nginx/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>,<span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>]</span><br></pre></td></tr></table></figure><p><strong>dokcerfile构建运行容器</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#构建镜像</span></span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#docker build -t centos-nginx-v1 .</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看镜像</span></span><br><span class="line">[root@docker-01 ~]#docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">centos-nginx-v1   latest    de9b64cc3b5d   39 minutes ago   262MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看构建步骤</span></span><br><span class="line">[root@docker-01 ~]#docker <span class="built_in">history</span> de9</span><br><span class="line">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span><br><span class="line">de9b64cc3b5d   40 minutes ago   CMD [<span class="string">&quot;nginx&quot;</span> <span class="string">&quot;-g&quot;</span> <span class="string">&quot;daemon off;&quot;</span>]                0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      40 minutes ago   EXPOSE map[80/tcp:&#123;&#125;]                           0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      40 minutes ago   VOLUME [/etc/nginx/]                            0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      40 minutes ago   VOLUME [/var/log/nginx/]                        0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      40 minutes ago   RUN /bin/sh -c yum install epel-release -y &amp;…   57.9MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      42 minutes ago   COPY *.repo /etc/yum.repos.d/ <span class="comment"># buildkit        2.52kB    buildkit.dockerfile.v0</span></span><br><span class="line">&lt;missing&gt;      50 minutes ago   RUN /bin/sh -c <span class="built_in">rm</span> -f /etc/yum.repos.d/* <span class="comment"># bu…   0B        buildkit.dockerfile.v0</span></span><br><span class="line">&lt;missing&gt;      2 years ago      /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span></span><br><span class="line">&lt;missing&gt;      2 years ago      /bin/sh -c <span class="comment">#(nop)  LABEL org.label-schema.sc…   0B        </span></span><br><span class="line">&lt;missing&gt;      2 years ago      /bin/sh -c <span class="comment">#(nop) ADD file:b3ebbe8bd304723d4…   204MB  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于镜像运行容器</span></span><br><span class="line">[root@docker-01 ~]#docker run --name test-nginx-v2 -P -d de9b64cc3b5d</span><br><span class="line">bcb7e9899fa4466d9268bb575531593c3c571dc753bc483d4287fc5bee048ff0</span><br><span class="line">[root@docker-01 ~]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                     NAMES</span><br><span class="line">bcb7e9899fa4   de9b64cc3b5d   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   4 seconds ago    Up 3 seconds    0.0.0.0:32774-&gt;80/tcp, :::32774-&gt;80/tcp   test-nginx-v2</span><br></pre></td></tr></table></figure><h3 id="检查运行容器自动挂载数据卷"><a href="#检查运行容器自动挂载数据卷" class="headerlink" title="检查运行容器自动挂载数据卷"></a>检查运行容器自动挂载数据卷</h3><p><strong>查看容器详细信息找mounts挂载部分信息</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect bcb7e9899fa4<span class="operator">|</span>jq</span><br><span class="line"> </span><br><span class="line"> &quot;Mounts&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;6a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/6a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;/etc/nginx&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: <span class="literal">true</span>,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;/var/log/nginx&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: <span class="literal">true</span>,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>查看当前机器上的卷信息</strong></p><blockquote><p>使用volume指令构建的镜像运行容器后，会在本地自建一个卷信息挂载，并且可以基于volume ls查看列出卷</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="keyword">local</span>     <span class="number">6</span>a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5</span><br><span class="line"><span class="keyword">local</span>     d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8</span><br></pre></td></tr></table></figure><p><strong>查看具体被保存到了何处</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#默认都会保存放入<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volume<span class="operator">/</span>目录下方</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ls <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span></span><br><span class="line"><span class="number">6</span>a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5  d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8</span><br><span class="line">backingFsBlockDev                                                 metadata.db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#树形查看结构，成功映射保存了容器内的挂载点数据</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#tree <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span></span><br><span class="line"><span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span></span><br><span class="line">├── <span class="number">6</span>a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5</span><br><span class="line">│   └── _data</span><br><span class="line">│       ├── conf.d</span><br><span class="line">│       ├── default.d</span><br><span class="line">│       ├── fastcgi.conf</span><br><span class="line">│       ├── fastcgi.conf.default</span><br><span class="line">│       ├── fastcgi_params</span><br><span class="line">│       ├── fastcgi_params.default</span><br><span class="line">│       ├── koi<span class="operator">-</span>utf</span><br><span class="line">│       ├── koi<span class="operator">-</span>win</span><br><span class="line">│       ├── mime.types</span><br><span class="line">│       ├── mime.types.default</span><br><span class="line">│       ├── nginx.conf</span><br><span class="line">│       ├── nginx.conf.default</span><br><span class="line">│       ├── scgi_params</span><br><span class="line">│       ├── scgi_params.default</span><br><span class="line">│       ├── uwsgi_params</span><br><span class="line">│       ├── uwsgi_params.default</span><br><span class="line">│       └── win<span class="operator">-</span>utf</span><br><span class="line">├── backingFsBlockDev</span><br><span class="line">├── d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8</span><br><span class="line">│   └── _data</span><br><span class="line">│       ├── access.log</span><br><span class="line">│       └── error.log</span><br><span class="line">└── metadata.db</span><br><span class="line"></span><br><span class="line"><span class="number">6</span> directories, <span class="number">19</span> files</span><br></pre></td></tr></table></figure><h2 id="3-centos-python3-flask镜像构建-代码连接redis"><a href="#3-centos-python3-flask镜像构建-代码连接redis" class="headerlink" title="3.centos+python3+flask镜像构建(代码连接redis)"></a>3.centos+python3+flask镜像构建(代码连接redis)</h2><h3 id="redis容器准备"><a href="#redis容器准备" class="headerlink" title="redis容器准备"></a>redis容器准备</h3><blockquote><p>准备redis容器提供服务端，让python3环境的容器中flask代码可以连接redis</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#仓库搜索</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">search</span> redis</span><br><span class="line">NAME                                    DESCRIPTION                                     STARS     OFFICIAL</span><br><span class="line">redis                                   Redis <span class="keyword">is</span> the world’s fastest data platform f…   <span class="number">12924</span>     [OK]</span><br><span class="line"></span><br><span class="line">#下载官网出品redis</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull redis</span><br><span class="line"></span><br><span class="line">#查看镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY     TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">centos<span class="operator">-</span>nginx   latest    de9b64cc3b5d   <span class="number">2</span> hours ago   <span class="number">262</span>MB</span><br><span class="line">redis          latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago   <span class="number">113</span>MB</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history redis</span><br><span class="line"></span><br><span class="line">#运行redis容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="comment">--name test-redis -d  7614ae9453d1</span></span><br><span class="line">ba80130fdc92bede50f96edfcba94b11956f47edb8dbe08b656212b041b76e7d</span><br><span class="line"></span><br><span class="line">#检查容器进程</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps </span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS      NAMES</span><br><span class="line">ba80130fdc92   <span class="number">7614</span>ae9453d1   &quot;docker-entrypoint.s…&quot;   <span class="number">6</span> seconds ago   Up <span class="number">5</span> seconds   <span class="number">6379</span><span class="operator">/</span>tcp   test<span class="operator">-</span>redis</span><br></pre></td></tr></table></figure><h3 id="flask代码准备"><a href="#flask代码准备" class="headerlink" title="flask代码准备"></a>flask代码准备</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf<span class="number">-8</span></span><br><span class="line"><span class="keyword">from</span> flask import Flask</span><br><span class="line"><span class="keyword">from</span> redis import Redis</span><br><span class="line"></span><br><span class="line">app <span class="operator">=</span> Flask(__name__)</span><br><span class="line">redis <span class="operator">=</span> Redis(host<span class="operator">=</span><span class="string">&#x27;test-redis&#x27;</span>, port<span class="operator">=</span><span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def hello():</span><br><span class="line">    count <span class="operator">=</span> redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;A day of study dockerfile , this page has been visited &#123;&#125; times\n&#x27;</span>.format(count)</span><br><span class="line"></span><br><span class="line">if __name__ <span class="operator">=</span><span class="operator">=</span> &quot;__main__&quot;:</span><br><span class="line">    app.run(host<span class="operator">=</span>&quot;0.0.0.0&quot;,port<span class="operator">=</span><span class="number">8000</span>, debug<span class="operator">=</span><span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p><strong>flask代码解释</strong></p><p>上方Flask应用程序中，已经展示了如何连接到Redis数据库。这是通过<code>redis = Redis(host=&#39;redis&#39;, port=6379)</code>这行代码实现的。这里，<code>Redis</code>类是从<code>redis</code>模块导入的，用于创建一个Redis客户端实例，该实例可以与Redis服务器进行通信。</p><p>以下是一些关于如何连接Redis的详细步骤和注意事项：</p><ol><li><strong>确保Redis服务器正在运行</strong>： 在尝试从Flask应用程序连接到Redis之前，请确保Redis服务器已经启动并正在运行。您可以使用Redis的命令行工具（<code>redis-cli</code>）来测试Redis服务器是否正在响应。</li><li><strong>配置Redis连接</strong>： 在Flask应用程序中，您通过<code>Redis(host=&#39;redis&#39;, port=6379)</code>来配置Redis连接。这里的<code>host</code>和<code>port</code>参数分别指定了Redis服务器的地址和端口。在这个例子中，假设Redis服务器位于名为<code>redis</code>的主机上，并且运行在默认的Redis端口6379上。<ul><li>如果Redis服务器和Flask应用程序部署在同一台机器上，并且您使用的是Redis的默认配置（即，Redis监听在<code>localhost</code>的6379端口上），则您可以将<code>host</code>参数更改为<code>&#39;localhost&#39;</code>。</li><li>如果Redis服务器需要密码才能访问，您还可以添加<code>password=&#39;yourpassword&#39;</code>参数到<code>Redis</code>构造函数中。</li></ul></li><li><strong>测试连接</strong>： 在Flask应用程序中，您可以通过尝试执行一个Redis命令（如<code>redis.ping()</code>）来测试Redis连接是否成功。如果Redis服务器可用且连接成功，<code>redis.ping()</code>将返回<code>True</code>。</li><li><strong>处理连接问题</strong>： 如果连接失败，可能是由于多种原因造成的，包括Redis服务器未运行、网络问题、错误的配置（如错误的<code>host</code>、<code>port</code>或<code>password</code>）等。检查Redis服务器的状态、网络连接和Flask应用程序中的配置设置，以帮助诊断和解决连接问题。</li><li><strong>部署注意事项</strong>： 当您将Flask应用程序和Redis部署到生产环境时，请确保它们之间的网络连接是安全的，并且Redis服务器的配置（如密码保护、防火墙规则等）符合您的安全要求。</li><li><strong>使用连接池</strong>： 对于生产环境中的高负载应用，您可能希望使用Redis连接池来管理Redis连接。Flask-Redis（一个Flask扩展，用于简化Redis的集成）提供了这样的功能，但您也可以使用<code>redis-py</code>库的连接池功能。</li><li><strong>异常处理</strong>： 在您的Flask应用程序中，添加适当的异常处理逻辑，以便在Redis连接失败或Redis命令执行失败时能够优雅地处理这些情况。这可以通过try-except块来实现。</li></ol><h3 id="dockerfile物料准备"><a href="#dockerfile物料准备" class="headerlink" title="dockerfile物料准备"></a>dockerfile物料准备</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#flask代码</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#cat <span class="operator">&gt;</span>web<span class="operator">-</span>flask.py <span class="operator">&lt;&lt;</span><span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> #coding:utf<span class="number">-8</span></span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">from</span> flask import Flask</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">from</span> redis import Redis</span><br><span class="line"><span class="operator">&gt;</span> </span><br><span class="line"><span class="operator">&gt;</span> app <span class="operator">=</span> Flask(__name__)</span><br><span class="line"><span class="operator">&gt;</span> redis <span class="operator">=</span> Redis(host<span class="operator">=</span><span class="string">&#x27;test-redis&#x27;</span>, port<span class="operator">=</span><span class="number">6379</span>)</span><br><span class="line"><span class="operator">&gt;</span> </span><br><span class="line"><span class="operator">&gt;</span> <span class="variable">@app</span>.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"><span class="operator">&gt;</span> def hello():</span><br><span class="line"><span class="operator">&gt;</span>     count <span class="operator">=</span> redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line"><span class="operator">&gt;</span>     <span class="keyword">return</span> <span class="string">&#x27;A day of study dockerfile , this page has been visited &#123;&#125; times\n&#x27;</span>.format(count)</span><br><span class="line"><span class="operator">&gt;</span> </span><br><span class="line"><span class="operator">&gt;</span> if __name__ <span class="operator">=</span><span class="operator">=</span> &quot;__main__&quot;:</span><br><span class="line"><span class="operator">&gt;</span>     app.run(host<span class="operator">=</span>&quot;0.0.0.0&quot;,port<span class="operator">=</span><span class="number">8000</span>, debug<span class="operator">=</span><span class="literal">True</span>)</span><br><span class="line"><span class="operator">&gt;</span> EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#镜像yum源</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#wget <span class="operator">-</span>O .<span class="operator">/</span>epel.repo https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>repo<span class="operator">/</span>epel<span class="number">-7.</span>repo</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#curl <span class="operator">-</span>so .<span class="operator">/</span>CentOS<span class="operator">-</span>Base.repo https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>repo<span class="operator">/</span>Centos<span class="number">-7.</span>repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#python代码依赖文件准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#cat requirements.txt </span><br><span class="line">flask</span><br><span class="line">redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#最终所有物料</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#ls</span><br><span class="line">CentOS<span class="operator">-</span>Base.repo  epel.repo  requirements.txt  web<span class="operator">-</span>flask.py</span><br></pre></td></tr></table></figure><h3 id="dockerfile构建镜像"><a href="#dockerfile构建镜像" class="headerlink" title="dockerfile构建镜像"></a>dockerfile构建镜像</h3><p><strong>书写dockerfile</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#vim Dockerfile</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#cat Dockerfile </span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span><span class="number">.2009</span></span><br><span class="line"></span><br><span class="line">#复制仓库配置和应用程序文件</span><br><span class="line"><span class="keyword">COPY</span> CentOS<span class="operator">-</span>Base.repo epel.repo <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="operator">/</span></span><br><span class="line"><span class="keyword">COPY</span> requirements.txt web<span class="operator">-</span>flask.py <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span></span><br><span class="line"></span><br><span class="line">#设置工作目录</span><br><span class="line">WORKDIR <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span></span><br><span class="line"></span><br><span class="line">#安装依赖</span><br><span class="line">RUN yum makecache fast \</span><br><span class="line"><span class="operator">&amp;&amp;</span>  yum install python3 python3<span class="operator">-</span>devel python3<span class="operator">-</span>pip <span class="operator">-</span>y \</span><br><span class="line"><span class="operator">&amp;&amp;</span>  python3 <span class="operator">-</span>m pip install <span class="operator">-</span>i https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>pypi<span class="operator">/</span>simple <span class="comment">--upgrade pip \</span></span><br><span class="line"><span class="operator">&amp;&amp;</span>  pip3 install <span class="operator">-</span>i https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>pypi<span class="operator">/</span>simple <span class="operator">-</span>r  .<span class="operator">/</span>requirements.txt \</span><br><span class="line"><span class="operator">&amp;&amp;</span>  yum clean <span class="keyword">all</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#暴露端口</span><br><span class="line">EXPOSE <span class="number">8000</span></span><br><span class="line"></span><br><span class="line">#启动应用程序</span><br><span class="line">CMD [&quot;python3&quot;, &quot;web-flask.py&quot;]</span><br></pre></td></tr></table></figure><p><strong>构建image</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#构建</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#docker build <span class="operator">-</span>t flask<span class="operator">-</span>redis<span class="operator">-</span>v1 .</span><br><span class="line"></span><br><span class="line">#查看镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images                                                 </span><br><span class="line">REPOSITORY       TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">flask<span class="operator">-</span>redis<span class="operator">-</span>v1   latest    <span class="number">44</span>b643b97874   <span class="number">8</span> seconds ago   <span class="number">336</span>MB</span><br><span class="line">centos<span class="operator">-</span>nginx     latest    de9b64cc3b5d   <span class="number">4</span> hours ago     <span class="number">262</span>MB</span><br><span class="line">redis            latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago     <span class="number">113</span>MB</span><br><span class="line"></span><br><span class="line">#查看构建步骤</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history  flask<span class="operator">-</span>redis<span class="operator">-</span>v1:latest </span><br><span class="line">IMAGE          CREATED          CREATED <span class="keyword">BY</span>                                      SIZE      COMMENT</span><br><span class="line"><span class="number">44</span>b643b97874   <span class="number">25</span> seconds ago   CMD [&quot;python3&quot; &quot;web-flask.py&quot;]                  <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">25</span> seconds ago   EXPOSE map[<span class="number">8000</span><span class="operator">/</span>tcp:&#123;&#125;]                         <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">25</span> seconds ago   RUN <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c yum makecache fast <span class="operator">&amp;&amp;</span>  yum <span class="keyword">in</span>…   <span class="number">132</span>MB     buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">3</span> minutes ago    WORKDIR <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>                         <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">3</span> minutes ago    <span class="keyword">COPY</span> web<span class="operator">-</span>flask.py requirements.txt <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>…   <span class="number">373</span>B      buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">3</span> minutes ago    <span class="keyword">COPY</span> <span class="operator">*</span>.repo <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="operator">/</span> # buildkit        <span class="number">3.19</span>kB    buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago      <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  CMD [&quot;/bin/bash&quot;]            <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago      <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  LABEL org.label<span class="operator">-</span>schema.sc…   <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago      <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop) <span class="keyword">ADD</span> file:b3ebbe8bd304723d4…   <span class="number">204</span>MB   </span><br></pre></td></tr></table></figure><h3 id="flask容器连接redis运行"><a href="#flask容器连接redis运行" class="headerlink" title="flask容器连接redis运行"></a>flask容器连接redis运行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#运行flask容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>p <span class="number">8000</span>:<span class="number">8000</span> <span class="comment">--name test-flask-redis flask-redis-v1</span></span><br></pre></td></tr></table></figure><p><strong>windows访问发现报错，无法连接redis容器</strong></p><p><img src="/image-20240728151056718.png" alt="image-20240728151056718"></p><h3 id="flask无法连接redis解决报错"><a href="#flask无法连接redis解决报错" class="headerlink" title="flask无法连接redis解决报错"></a>flask无法连接redis解决报错</h3><p><strong>方法1，进入flask容器，修改flask代码，将host指定的主机名修改为redis容器的ip地址</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看redis容器运行的ip地址</span></span><br><span class="line">[root@docker-01 ~]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE            COMMAND                  CREATED             STATUS             PORTS                                       NAMES</span><br><span class="line">e73aca26a802   flask-redis-v1   <span class="string">&quot;python3 web-flask.py&quot;</span>   3 minutes ago       Up 3 minutes       0.0.0.0:8000-&gt;8000/tcp, :::8000-&gt;8000/tcp   test-flask-redis</span><br><span class="line">ba80130fdc92   7614ae9453d1     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   About an hour ago   Up About an hour   6379/tcp                                    test-redis</span><br><span class="line">[root@docker-01 ~]#docker inspect ba80130fdc92|grep -i <span class="string">&#x27;ipaddress&#x27;</span></span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入flask容器内部修改代码中host改为redis容器的ip地址</span></span><br><span class="line">[root@docker-01 ~]#docker <span class="built_in">exec</span> -it e73aca26a802  /bin/bash</span><br><span class="line">[root@e73aca26a802 web-flask]# <span class="built_in">ls</span></span><br><span class="line">requirements.txt  web-flask.py</span><br><span class="line">[root@e73aca26a802 web-flask]# vi web-flask.py </span><br><span class="line">[root@e73aca26a802 web-flask]# <span class="built_in">cat</span> web-flask.py </span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">from flask import Flask</span><br><span class="line">from redis import Redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=<span class="string">&#x27;172.17.0.2&#x27;</span>, port=6379)</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def hello():</span><br><span class="line">    count = redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="built_in">return</span> <span class="string">&#x27;A day of study dockerfile , this page has been visited &#123;&#125; times\n&#x27;</span>.format(count)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port=8000, debug=True)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#最后访问检查</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240728151815866.png" alt="image-20240728151815866"></p><p><strong>方法二，启动时使用–link参数，连接容器，自然就可以根据代码中主机名，连接到对应得容器名了</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看镜像</span></span><br><span class="line">[root@docker-01 ~]#docker images</span><br><span class="line">REPOSITORY       TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">flask-redis-v1   latest    44b643b97874   18 minutes ago   336MB</span><br><span class="line">centos-nginx     latest    de9b64cc3b5d   4 hours ago      262MB</span><br><span class="line">redis            latest    7614ae9453d1   2 years ago      113MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看容器进程</span></span><br><span class="line">[root@docker-01 ~]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE            COMMAND                  CREATED          STATUS          PORTS                                       NAMES</span><br><span class="line">e73aca26a802   flask-redis-v1   <span class="string">&quot;python3 web-flask.py&quot;</span>   10 minutes ago   Up 10 minutes   0.0.0.0:8000-&gt;8000/tcp, :::8000-&gt;8000/tcp   test-flask-redis</span><br><span class="line">ba80130fdc92   7614ae9453d1     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   2 hours ago      Up 2 hours      6379/tcp                                    test-redis</span><br><span class="line"></span><br><span class="line"><span class="comment">#链接redis容器名运行falsk容器</span></span><br><span class="line">[root@docker-01 ~]#docker run --name flask-redis-v2 -d -p 8001:8000 --<span class="built_in">link</span>=test-redis  44b643b97874</span><br><span class="line">ffcd5be4489f34f55f6ce9281feca3c9aa8657d08c063262b056f9cb66ad907b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#最后访问宿主机映射地址即可</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240728152613708.png" alt="image-20240728152613708"></p><h1 id="四、supervisor容器内服务进程管理工具"><a href="#四、supervisor容器内服务进程管理工具" class="headerlink" title="四、supervisor容器内服务进程管理工具"></a>四、supervisor容器内服务进程管理工具</h1><blockquote><p>supervisor是一个容器内管理服务进程的一个工具</p><p>通过supervisor配置启动的容器，如果服务进程意外终端，此工具可以自动对容器内服务进行一个重新启动</p></blockquote><ul><li>注意：supervisor默认启动是后台运行，但是docker的特性要求容器内进程必须前台运行，需要修改supervisor配置文件</li></ul><h2 id="1-supervisor概述"><a href="#1-supervisor概述" class="headerlink" title="1.supervisor概述"></a>1.supervisor概述</h2><p>Supervisor 是一个在Linux系统上广泛使用的进程管理工具，它主要用于管理和监控在Linux系统上运行的进程。以下是Supervisor的概述以及它如何帮助解决用户在Linux操作系统中遇到的常见问题：</p><p><strong>Supervisor概述</strong></p><ol><li><strong>进程管理</strong>：<ul><li>Supervisor可以管理多个进程，包括应用程序、服务或其他需要在后台运行的进程。</li><li>它能启动、停止、重启和监控这些进程，并在它们异常退出时自动重新启动。</li></ul></li><li><strong>进程监控</strong>：<ul><li>Supervisor能监控进程的状态，包括是否正在运行、已经退出或者出现异常。</li><li>它可以定期检查进程的状态，并在进程异常退出时进行相应的处理。</li></ul></li><li><strong>自动重启</strong>：<ul><li>如果进程异常退出，Supervisor可以根据配置文件中的设置自动重启进程。</li></ul></li><li><strong>日志管理</strong>：<ul><li>Supervisor可以收集和管理进程的日志信息，将进程的输出重定向到指定的文件中，并支持日志的轮转和归档。</li></ul></li><li><strong>进程组管理</strong>：<ul><li>可以将多个相关联的进程组绑定在一起，方便同时管理和操作。</li></ul></li><li><strong>Web界面</strong>：<ul><li>Supervisor提供了一个简单的Web界面，用户可以通过浏览器进行监控和管理进程。</li></ul></li><li><strong>配置文件</strong>：<ul><li>Supervisor通过配置文件来定义要管理的进程，配置文件中包括进程名称、启动命令、日志输出等信息。</li></ul></li></ol><p><strong>解决Linux操作系统中的常见问题</strong></p><p>虽然Supervisor本身不直接解决所有Linux系统问题，但它通过优化进程管理，可以帮助解决或减轻以下常见问题：</p><ol><li><strong>系统启动失败</strong>：<ul><li>如果某些服务或应用程序在系统启动时无法自动启动，Supervisor可以确保这些进程在系统启动后自动启动。</li></ul></li><li><strong>文件权限问题</strong>：<ul><li>虽然Supervisor不直接解决文件权限问题，但它可以确保以正确的用户和组身份启动进程，从而避免权限相关的错误。</li></ul></li><li><strong>软件安装与卸载问题</strong>：<ul><li>Supervisor不直接涉及软件的安装与卸载，但它可以确保安装的服务或应用程序在系统更新或重启后能够正确运行。</li></ul></li><li><strong>网络连接问题</strong>：<ul><li>如果网络连接问题是由后台进程异常引起的，Supervisor通过自动重启这些进程，可以帮助恢复网络连接。</li></ul></li></ol><p><strong>安装与配置Supervisor</strong></p><p>Supervisor的安装通常通过Linux的包管理器（如apt、yum）进行，或者从源码编译安装。安装完成后，需要创建配置文件来定义要管理的进程。配置完成后，通过执行<code>supervisord</code>命令启动Supervisor，并使用<code>supervisorctl</code>命令来管理进程。</p><p>综上所述，Supervisor是一个强大的进程管理工具，通过优化进程管理和监控，它可以帮助解决Linux操作系统中的一些问题，提高系统的稳定性和可靠性。</p><h2 id="2-flask运行环境升级构建镜像"><a href="#2-flask运行环境升级构建镜像" class="headerlink" title="2.flask运行环境升级构建镜像"></a>2.flask运行环境升级构建镜像</h2><blockquote><p>上方flask运行环境升级创建dockerfile构建镜像</p><p>最终环境：centos+nginx+flask+supervisor+链接redis</p></blockquote><h3 id="redis容器运行"><a href="#redis容器运行" class="headerlink" title="redis容器运行"></a>redis容器运行</h3><p>后端链接数据库时，先要保证数据库运行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED       STATUS       PORTS      NAMES</span><br><span class="line">ba80130fdc92   <span class="number">7614</span>ae9453d1   &quot;docker-entrypoint.s…&quot;   <span class="number">3</span> hours ago   Up <span class="number">3</span> hours   <span class="number">6379</span><span class="operator">/</span>tcp   test<span class="operator">-</span>redis</span><br></pre></td></tr></table></figure><h3 id="dockrfile物料准备"><a href="#dockrfile物料准备" class="headerlink" title="dockrfile物料准备"></a>dockrfile物料准备</h3><p><strong>nginx配置文件物料准备</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#物料目录准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#pwd</span><br><span class="line"><span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#nginx配置文件物料准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#cat <span class="operator">&gt;</span>test<span class="operator">-</span>web<span class="operator">-</span>nginx.conf<span class="operator">&lt;&lt;</span><span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> cat <span class="operator">&gt;</span> nginx_flask.conf <span class="operator">&lt;&lt;</span><span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> server&#123;</span><br><span class="line"><span class="operator">&gt;</span>     listen <span class="number">80</span>;</span><br><span class="line"><span class="operator">&gt;</span>     server_name _;</span><br><span class="line"><span class="operator">&gt;</span>     location <span class="operator">/</span> &#123;</span><br><span class="line"><span class="operator">&gt;</span>         proxy_pass http:<span class="operator">/</span><span class="operator">/</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>;    </span><br><span class="line"><span class="operator">&gt;</span>     &#125;</span><br><span class="line"><span class="operator">&gt;</span> &#125;</span><br><span class="line"><span class="operator">&gt;</span> EOF</span><br></pre></td></tr></table></figure><p><strong>python代码物料</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#vim web<span class="operator">-</span>flask.py</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#cat web<span class="operator">-</span>flask.py </span><br><span class="line">#coding:utf<span class="number">-8</span></span><br><span class="line"><span class="keyword">from</span> flask import Flask</span><br><span class="line"><span class="keyword">from</span> redis import Redis</span><br><span class="line"></span><br><span class="line">app <span class="operator">=</span> Flask(__name__)</span><br><span class="line">redis <span class="operator">=</span> Redis(host<span class="operator">=</span><span class="string">&#x27;test-redis&#x27;</span>, port<span class="operator">=</span><span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def hello():</span><br><span class="line">    count <span class="operator">=</span> redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;A day of study dockerfile , this page has been visited &#123;&#125; times\n&#x27;</span>.format(count)</span><br><span class="line"></span><br><span class="line">if __name__ <span class="operator">=</span><span class="operator">=</span> &quot;__main__&quot;:</span><br><span class="line">    app.run(host<span class="operator">=</span>&quot;0.0.0.0&quot;,port<span class="operator">=</span><span class="number">8000</span>, debug<span class="operator">=</span><span class="literal">True</span>)</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>supervisor配置文件物料</strong></p><blockquote><p>该配置尾戳必须是 <code>.ini</code>结尾</p><p>核心原理就是通过配置中定义的服务启动命令，去启动你的服务进程</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 /dockerfile/centos-nginx-flask-supervison]#<span class="built_in">cat</span> &gt; nginx_flask.ini &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&gt; [program:my-nginx]</span><br><span class="line">&gt; <span class="built_in">command</span>=nginx -g <span class="string">&#x27;daemon off;&#x27;</span></span><br><span class="line">&gt; autostart=<span class="literal">true</span></span><br><span class="line">&gt; autorestart=<span class="literal">true</span></span><br><span class="line">&gt; startsecs=5</span><br><span class="line">&gt; redirect_stderr=<span class="literal">true</span></span><br><span class="line">&gt; stdout_logfile_maxbytes=20MB</span><br><span class="line">&gt; stdout_logfile_backups=20</span><br><span class="line">&gt; stdout_logfile=/var/log/supervisor/nginx.log</span><br><span class="line">&gt; </span><br><span class="line">&gt; [program:my-flask]</span><br><span class="line">&gt; <span class="built_in">command</span>=python3  /app/web-flask/web-flask.py</span><br><span class="line">&gt; autostart=<span class="literal">true</span></span><br><span class="line">&gt; autorestart=<span class="literal">true</span></span><br><span class="line">&gt; startsecs=5</span><br><span class="line">&gt; redirect_stderr=<span class="literal">true</span></span><br><span class="line">&gt; stdout_logfile_maxbytes=20MB</span><br><span class="line">&gt; stdout_logfile_backups=20</span><br><span class="line">&gt; stdout_logfile=/var/log/supervisor/flask.log</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure><p><strong>python代码模块依赖文件</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#cat requirements.txt </span><br><span class="line">flask</span><br><span class="line">redis</span><br></pre></td></tr></table></figure><p><strong>yum仓库源配置文件</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#curl <span class="operator">-</span>o .<span class="operator">/</span>CentOS<span class="operator">-</span>Base.repo https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>repo<span class="operator">/</span>Centos<span class="number">-7.</span>repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#curl <span class="operator">-</span>o .<span class="operator">/</span>epel.repo http:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>repo<span class="operator">/</span>epel<span class="number">-7.</span>repo</span><br></pre></td></tr></table></figure><p><strong>所有物料检查</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#ll</span><br><span class="line">total <span class="number">24</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 2523 Jul 28 16:32 CentOS-Base.repo</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  664 Jul 28 16:32 epel.repo</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  445 Jul 28 16:25 nginx_flask.ini</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root   12 Jul 28 16:26 requirements.txt</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  144 Jul 28 16:14 test-web-nginx.conf</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  365 Jul 28 16:28 web-flask.py</span></span><br></pre></td></tr></table></figure><h3 id="dockerfile构建镜像-1"><a href="#dockerfile构建镜像-1" class="headerlink" title="dockerfile构建镜像"></a>dockerfile构建镜像</h3><p><strong>书写dockerfile</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; Dockerfile &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">FROM centos:7.9.2009</span><br><span class="line"></span><br><span class="line">RUN  <span class="built_in">rm</span> -f /etc/yum.repos.d/*</span><br><span class="line">COPY *.repo /etc/yum.repos.d/</span><br><span class="line">COPY requirements.txt web-flask.py /app/web-flask/</span><br><span class="line"></span><br><span class="line">WORKDIR /app/web-flask</span><br><span class="line">RUN yum makecache fast \</span><br><span class="line">&amp;&amp; yum install python3 python3-devel python3-pip -y \</span><br><span class="line">&amp;&amp; python3 -m pip install -i https://mirrors.aliyun.com/pypi/simple --upgrade pip \</span><br><span class="line">&amp;&amp; pip3 install -i https://mirrors.aliyun.com/pypi/simple -r requirements.txt \</span><br><span class="line">&amp;&amp; yum install supervisor nginx -y \</span><br><span class="line">&amp;&amp; yum clean all</span><br><span class="line"></span><br><span class="line">COPY test-web-nginx.conf /etc/nginx/conf.d/</span><br><span class="line">COPY nginx_flask.ini /etc/supervisord.d/</span><br><span class="line">RUN sed -i <span class="string">&#x27;s/nodaemon=false/nodaemon=true/g&#x27;</span> /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line">EXPOSE 8000</span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">VOLUME /var/log/supervisor/</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;/usr/bin/supervisord&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;/etc/supervisord.conf&quot;</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>构建镜像</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#构建</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#docker build <span class="operator">-</span>t centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervisor .</span><br><span class="line"></span><br><span class="line">#检查镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervisor   latest    <span class="number">65441</span>eaf22f9   <span class="number">9</span> seconds ago   <span class="number">373</span>MB</span><br><span class="line">flask<span class="operator">-</span>redis<span class="operator">-</span>v1                  latest    <span class="number">44</span>b643b97874   <span class="number">2</span> hours ago     <span class="number">336</span>MB</span><br><span class="line">centos<span class="operator">-</span>nginx                    latest    de9b64cc3b5d   <span class="number">5</span> hours ago     <span class="number">262</span>MB</span><br><span class="line">redis                           latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago     <span class="number">113</span>MB</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervisor:latest </span><br></pre></td></tr></table></figure><h3 id="flask链接redis容器运行并检查"><a href="#flask链接redis容器运行并检查" class="headerlink" title="flask链接redis容器运行并检查"></a>flask链接redis容器运行并检查</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervisor   latest    <span class="number">65441</span>eaf22f9   <span class="number">8</span> minutes ago   <span class="number">373</span>MB</span><br><span class="line"></span><br><span class="line">#redis容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED       STATUS       PORTS      NAMES</span><br><span class="line">ba80130fdc92   <span class="number">7614</span>ae9453d1   &quot;docker-entrypoint.s…&quot;   <span class="number">3</span> hours ago   Up <span class="number">3</span> hours   <span class="number">6379</span><span class="operator">/</span>tcp   test<span class="operator">-</span>redis</span><br><span class="line"></span><br><span class="line">#运行flask容器，映射内部代理转发nginx端口，连接redis</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d <span class="operator">-</span>p <span class="number">80</span>:<span class="number">80</span> <span class="comment">--name nginx-flask_redis-supervisor --link=ba80130fdc92 65441eaf22f9</span></span><br><span class="line">d6206468fdc5e82e6099d400dd58695ecc3a961a57ac71b3e63d7be227fa75d4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#flask容器运行检查</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED              STATUS              PORTS                                         NAMES</span><br><span class="line">d6206468fdc5   <span class="number">65441</span>eaf22f9   &quot;/usr/bin/supervisor…&quot;   About a <span class="keyword">minute</span> ago   Up About a <span class="keyword">minute</span>   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, <span class="number">8000</span><span class="operator">/</span>tcp   nginx<span class="operator">-</span>flask_redis<span class="operator">-</span>supervisor</span><br><span class="line">ba80130fdc92   <span class="number">7614</span>ae9453d1   &quot;docker-entrypoint.s…&quot;   <span class="number">3</span> hours ago          Up <span class="number">3</span> hours          <span class="number">6379</span><span class="operator">/</span>tcp                                      test<span class="operator">-</span>redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#flask容器内服务进程运行检查，supervisor、nginx、redis都正常启动了</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker top d62</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 <span class="type">TIME</span>                CMD</span><br><span class="line">root                <span class="number">26252</span>               <span class="number">26231</span>               <span class="number">0</span>                   <span class="number">16</span>:<span class="number">58</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>python <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>supervisord <span class="operator">-</span>c <span class="operator">/</span>etc<span class="operator">/</span>supervisord.conf</span><br><span class="line">root                <span class="number">26273</span>               <span class="number">26252</span>               <span class="number">0</span>                   <span class="number">16</span>:<span class="number">58</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            python3 <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>web<span class="operator">-</span>flask.py</span><br><span class="line">root                <span class="number">26278</span>               <span class="number">26273</span>               <span class="number">0</span>                   <span class="number">16</span>:<span class="number">58</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span>            <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>python3 <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>web<span class="operator">-</span>flask.py</span><br><span class="line">root                <span class="number">26400</span>               <span class="number">26231</span>               <span class="number">0</span>                   <span class="number">17</span>:<span class="number">03</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line">root                <span class="number">26441</span>               <span class="number">26252</span>               <span class="number">0</span>                   <span class="number">17</span>:<span class="number">05</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line">polkitd             <span class="number">26442</span>               <span class="number">26441</span>               <span class="number">0</span>                   <span class="number">17</span>:<span class="number">05</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            nginx: worker process</span><br><span class="line">polkitd             <span class="number">26443</span>               <span class="number">26441</span>               <span class="number">0</span>                   <span class="number">17</span>:<span class="number">05</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            nginx: worker process</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="检查supervisor管理服务进程与日志"><a href="#检查supervisor管理服务进程与日志" class="headerlink" title="检查supervisor管理服务进程与日志"></a>检查supervisor管理服务进程与日志</h3><p><strong>检查进程，nginx与flask父进程都是supervisord服务，证明了是通过该工具进行运行</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@d6206468fdc5</span> conf.d]# ps <span class="operator">-</span>ef</span><br><span class="line">UID         PID   PPID  C STIME TTY          <span class="type">TIME</span> CMD</span><br><span class="line">root          <span class="number">1</span>      <span class="number">0</span>  <span class="number">0</span> <span class="number">08</span>:<span class="number">58</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>python <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>supervisord <span class="operator">-</span>c <span class="operator">/</span>etc<span class="operator">/</span>supervisord.conf</span><br><span class="line">root          <span class="number">9</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">08</span>:<span class="number">58</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> python3 <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>web<span class="operator">-</span>flask.py</span><br><span class="line">root         <span class="number">14</span>      <span class="number">9</span>  <span class="number">0</span> <span class="number">08</span>:<span class="number">58</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">04</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>python3 <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>web<span class="operator">-</span>flask.py</span><br><span class="line">root         <span class="number">22</span>      <span class="number">0</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">03</span> pts<span class="operator">/</span><span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line">root         <span class="number">43</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">05</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line">nginx        <span class="number">44</span>     <span class="number">43</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">05</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">nginx        <span class="number">45</span>     <span class="number">43</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">05</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">root         <span class="number">47</span>     <span class="number">22</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">07</span> pts<span class="operator">/</span><span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> ps <span class="operator">-</span>ef</span><br></pre></td></tr></table></figure><p><strong>检查管理服务运行的日志目录</strong></p><p>管理的服务运行时的日志都存放到了配置文件中指定的存放路径下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@d6206468fdc5</span> conf.d]# ls <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>supervisor<span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">12</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  468 Jul 28 08:58 flask.log</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  393 Jul 28 09:05 nginx.log</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 1588 Jul 28 09:05 supervisord.log</span></span><br></pre></td></tr></table></figure><h2 id="3-supervisor管理进程命令用法"><a href="#3-supervisor管理进程命令用法" class="headerlink" title="3.supervisor管理进程命令用法"></a>3.supervisor管理进程命令用法</h2><blockquote><p>两种形式：1种是交互式，1种是非交互直接执行</p></blockquote><p><strong>进入容器</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">exec</span> <span class="operator">-</span>it d6206468fdc5 <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br></pre></td></tr></table></figure><p><strong>交互式管理</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">exec</span> <span class="operator">-</span>it d6206468fdc5 <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line">[root<span class="variable">@d6206468fdc5</span> web<span class="operator">-</span>flask]# supervisorctl <span class="operator">-</span>c <span class="operator">/</span>etc<span class="operator">/</span>supervisord.conf   </span><br><span class="line">my<span class="operator">-</span>flask                         <span class="keyword">RUNNING</span>   pid <span class="number">9</span>, uptime <span class="number">0</span>:<span class="number">21</span>:<span class="number">34</span></span><br><span class="line">my<span class="operator">-</span>nginx                         <span class="keyword">RUNNING</span>   pid <span class="number">43</span>, uptime <span class="number">0</span>:<span class="number">14</span>:<span class="number">54</span></span><br><span class="line">supervisor<span class="operator">&gt;</span> status</span><br><span class="line">my<span class="operator">-</span>flask                         <span class="keyword">RUNNING</span>   pid <span class="number">9</span>, uptime <span class="number">0</span>:<span class="number">21</span>:<span class="number">39</span></span><br><span class="line">my<span class="operator">-</span>nginx                         <span class="keyword">RUNNING</span>   pid <span class="number">43</span>, uptime <span class="number">0</span>:<span class="number">14</span>:<span class="number">59</span></span><br></pre></td></tr></table></figure><p><strong>非交互式</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看所有被管理的进程</span></span><br><span class="line">[root@d6206468fdc5 web-flask]# supervisorctl -c /etc/supervisord.conf   status</span><br><span class="line">my-flask                         RUNNING   pid 9, <span class="built_in">uptime</span> 0:22:57</span><br><span class="line">my-nginx                         RUNNING   pid 43, <span class="built_in">uptime</span> 0:16:17</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看某个被管理的进程</span></span><br><span class="line">[root@d6206468fdc5 web-flask]# supervisorctl -c /etc/supervisord.conf   status  my-flask</span><br><span class="line">my-flask                         RUNNING   pid 9, <span class="built_in">uptime</span> 0:23:06</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启所有被管理的进程</span></span><br><span class="line">[root@d6206468fdc5 web-flask]# supervisorctl -c /etc/supervisord.conf  restart all      </span><br><span class="line">my-flask: stopped</span><br><span class="line">my-nginx: stopped</span><br><span class="line">my-flask: started   关闭后自动开启了这就是这个工具的机制</span><br><span class="line">my-nginx: started</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启某个被管理的进程</span></span><br><span class="line">[root@d6206468fdc5 web-flask]# supervisorctl -c /etc/supervisord.conf  restart my-flask</span><br><span class="line">my-flask: stopped</span><br><span class="line">my-flask: started</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭所有被管理的进程</span></span><br><span class="line">supervisorctl -c /etc/supervisord.conf  stop all</span><br></pre></td></tr></table></figure><h2 id="4-最终验证容器内进程意外中断supervisor自动重启"><a href="#4-最终验证容器内进程意外中断supervisor自动重启" class="headerlink" title="4.最终验证容器内进程意外中断supervisor自动重启"></a>4.最终验证容器内进程意外中断supervisor自动重启</h2><p><strong>容器内运行的进程</strong></p><p><img src="/image-20240728172922783.png" alt="image-20240728172922783"></p><p><strong>模拟nginx服务运行意外中断,检查supervisor是否可以重启启动内部进程</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep nginx</span><br><span class="line">root      <span class="number">26606</span>  <span class="number">26252</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">21</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line">polkitd   <span class="number">26607</span>  <span class="number">26606</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">21</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">polkitd   <span class="number">26608</span>  <span class="number">26606</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">21</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">root      <span class="number">26667</span>  <span class="number">16187</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">25</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto nginx</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#pkill nginx</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#pkill nginx</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#pkill nginx</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep nginx</span><br><span class="line">root      <span class="number">26724</span>  <span class="number">16187</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto nginx</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep nginx</span><br><span class="line">root      <span class="number">26725</span>  <span class="number">26252</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line">polkitd   <span class="number">26726</span>  <span class="number">26725</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">polkitd   <span class="number">26727</span>  <span class="number">26725</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">root      <span class="number">26729</span>  <span class="number">16187</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto nginx</span></span><br></pre></td></tr></table></figure><p><strong>windos访问测试</strong></p><p>略过了</p><h1 id="五、dockerfile镜像多阶段构建"><a href="#五、dockerfile镜像多阶段构建" class="headerlink" title="五、dockerfile镜像多阶段构建"></a>五、dockerfile镜像多阶段构建</h1><blockquote><p>啥是多阶段镜像构建？</p><p>就是镜像构建时使用FROM指令调用其他镜像的运行环境，最终结合构建出的一个镜像</p><p>好处：省宿主机磁盘资源以及构建速度快</p></blockquote><h2 id="1-多阶段构建概述"><a href="#1-多阶段构建概述" class="headerlink" title="1.多阶段构建概述"></a>1.多阶段构建概述</h2><p>Dockerfile多阶段构建是Docker镜像构建中的一种高级技术，它允许在同一个Dockerfile文件中定义多个构建阶段，每个阶段都从一个基础镜像开始，并且可以包含一系列指令来构建和修改镜像。多阶段构建的主要目的是优化最终镜像的大小、构建速度和安全性，通过只在最终镜像中包含必要的文件和元数据，而排除所有不必要的工具和中间产物。</p><h3 id="1-1-多阶段构建的主要特点"><a href="#1-1-多阶段构建的主要特点" class="headerlink" title="1.1 多阶段构建的主要特点"></a>1.1 多阶段构建的主要特点</h3><ol><li><strong>优化镜像大小</strong>：通过只将每个阶段必需的最终产物复制到下一个阶段，可以显著减少最终镜像的大小。例如，在构建Java应用时，可能首先需要一个包含JDK的镜像来编译应用，但最终的运行时镜像只需要包含编译后的应用和其依赖，而不需要JDK。</li><li><strong>提高构建速度</strong>：由于每个阶段都可以独立构建，因此可以并行处理多个阶段的构建，从而加快整体构建速度。此外，通过减少最终镜像中不必要的层，也可以提高构建速度。</li><li><strong>增强安全性</strong>：通过分离构建和运行环境，可以减少潜在的安全风险。例如，构建阶段可能包含敏感信息（如源代码、构建脚本等），但在最终镜像中只包含编译后的二进制文件，从而减少了敏感信息的暴露。</li></ol><h3 id="1-2-多阶段构建的基本语法"><a href="#1-2-多阶段构建的基本语法" class="headerlink" title="1.2 多阶段构建的基本语法"></a>1.2 多阶段构建的基本语法</h3><p>在Dockerfile中，多阶段构建通过多个<code>FROM</code>指令来定义，每个<code>FROM</code>指令都标志着一个新阶段的开始。可以通过<code>AS</code>关键字为每个阶段指定一个别名，以便在后续阶段中引用。在复制文件时，可以使用<code>COPY --from=&lt;阶段别名&gt;</code>语法来从另一个阶段复制文件。</p><p><strong>示例：</strong></p><p>以下是一个Dockerfile多阶段构建的示例，该示例展示了如何构建一个包含静态网站的Nginx镜像：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Dockerfile</span><br><span class="line"># 第一阶段：构建静态网站FROM node:14 AS buildWORKDIR /appCOPY ./src/ /app/RUN npm install &amp;&amp; npm run build</span><br><span class="line"># 第二阶段：构建Nginx镜像并复制静态网站文件FROM nginx:alpineCOPY --from=build /app/dist/ /usr/share/nginx/htmlEXPOSE 80CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;] </span><br></pre></td></tr></table></figure><p>在这个示例中，第一个阶段使用<code>node:14</code>镜像来构建静态网站，将源代码复制到<code>/app</code>目录，并运行npm命令来安装依赖和构建网站。构建完成后，将生成的静态文件（位于<code>/app/dist/</code>目录）复制到第二个阶段的Nginx镜像中，Nginx镜像用于提供静态文件的Web服务。最终，构建了一个只包含Nginx和静态文件的精简镜像。</p><h2 id="2-多阶段构建镜像tomcat"><a href="#2-多阶段构建镜像tomcat" class="headerlink" title="2.多阶段构建镜像tomcat"></a>2.多阶段构建镜像tomcat</h2><blockquote><p>1.先通过dockerfile构建centos镜像</p><p>2.再构建centos-jdk镜像，构建时直接调用上次构建的centos环境</p><p>3.最后构建tomacat镜像时，调用jdk+centos环境即可，无需再定义jdk与centos环境了</p></blockquote><h3 id="2-1-centos镜像"><a href="#2-1-centos镜像" class="headerlink" title="2.1  centos镜像"></a>2.1  centos镜像</h3><blockquote><p>作为基础镜像提供多阶段构建，在dockerfile构建时加上一些常用的软件包，以供其他镜像更好的使用</p></blockquote><h4 id="存放目录"><a href="#存放目录" class="headerlink" title="存放目录"></a>存放目录</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /dockerfile/centos7.9</span><br></pre></td></tr></table></figure><h4 id="dockerfile"><a href="#dockerfile" class="headerlink" title="dockerfile"></a>dockerfile</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 /dockerfile/centos7.9]#vim Dockerfile                                    </span><br><span class="line">[root@docker-01 /dockerfile/centos7.9]#<span class="built_in">cat</span> Dockerfile </span><br><span class="line"><span class="comment">#使用 CentOS 7.9.2009 镜像作为基础镜像</span></span><br><span class="line">FROM centos:7.9.2009</span><br><span class="line"></span><br><span class="line"><span class="comment">#替换默认的 CentOS 仓库为阿里云镜像，以加速 yum 安装过程</span></span><br><span class="line">RUN <span class="built_in">rm</span> -f /etc/yum.rpeos.d/* \</span><br><span class="line">&amp;&amp; curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo \</span><br><span class="line">&amp;&amp; curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装必要的软件包</span></span><br><span class="line">RUN yum install -y net-tools bash-completion supervisor vim \</span><br><span class="line">&amp;&amp; yum clean all \</span><br><span class="line">&amp;&amp; <span class="built_in">rm</span> -rf /var/cache/yum/*  </span><br><span class="line"></span><br><span class="line"><span class="comment">#设置时区为中国上海</span></span><br><span class="line">RUN <span class="built_in">rm</span> -rf /etc/localtime \</span><br><span class="line">&amp;&amp; <span class="built_in">ln</span> -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure><h4 id="构建镜像与检查"><a href="#构建镜像与检查" class="headerlink" title="构建镜像与检查"></a>构建镜像与检查</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#构建镜像</span></span><br><span class="line">[root@docker-01 /dockerfile/centos7.9]#docker build -t centos:7.9 .</span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像检查</span></span><br><span class="line">[root@docker-01 ~]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">centos       7.9       4e3332805815   3 minutes ago   289MB</span><br><span class="line">[root@docker-01 ~]#docker <span class="built_in">history</span> centos:7.9 </span><br></pre></td></tr></table></figure><h3 id="2-2-centos-jdk镜像"><a href="#2-2-centos-jdk镜像" class="headerlink" title="2.2 centos+jdk镜像"></a>2.2 centos+jdk镜像</h3><h4 id="存放目录-1"><a href="#存放目录-1" class="headerlink" title="存放目录"></a>存放目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 ~]#<span class="built_in">mkdir</span> /dockerfile/JDK-8u202</span><br><span class="line">[root@docker-01 ~]#<span class="built_in">cd</span> /dockerfile/JDK-8u202/</span><br></pre></td></tr></table></figure><h4 id="物料准备"><a href="#物料准备" class="headerlink" title="物料准备"></a>物料准备</h4><blockquote><p>这里配置Java环境变量是因为运行java程序时会通过变量调用jdk环境的一些依赖库与二进制命令</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>jdk编译好二进制压缩包</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#ls</span><br><span class="line">jdk<span class="number">-8</span>u202<span class="operator">-</span>linux<span class="operator">-</span>x64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>环境变量配置文件</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#cp <span class="operator">/</span>etc<span class="operator">/</span>profile .</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#vim profile </span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#tail profile </span><br><span class="line">#<span class="keyword">set</span> java enviroment</span><br><span class="line">JAVA_HOME<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>jdk  #注意这里的路径要与jdk压缩包解压后软链接的路径相同</span><br><span class="line">CLASSPATH<span class="operator">=</span>.:$JAVA_HOME<span class="operator">/</span>lib.tools.jar</span><br><span class="line">PATH<span class="operator">=</span>$JAVA_HOME<span class="operator">/</span>bin:$PATH</span><br><span class="line">export JAVA_HOME CLASSPATH PATH</span><br></pre></td></tr></table></figure><h4 id="dockerfile-1"><a href="#dockerfile-1" class="headerlink" title="dockerfile"></a>dockerfile</h4><blockquote><p>下方要注意的是：</p><p>1.FROM指定本地已有的centos镜像</p><p>2.ADD指令解压路径要与profile中定义的JAVA_HOAME路径相同</p><p>3.软链接的名要与JAVA_HOAME的目录名相同</p><p>4.ENV二次定义是为了直接运行java程序就可以调用jdk，profile中的变量需要开启bash环境</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#vim Dockerfile</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#cat Dockerfile </span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span> </span><br><span class="line"><span class="keyword">ADD</span> jdk<span class="number">-8</span>u221<span class="operator">-</span>linux<span class="operator">-</span>x64.tar.gz <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span> </span><br><span class="line"><span class="keyword">COPY</span> profile <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">RUN ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>jdk1<span class="number">.8</span><span class="number">.0</span>_202 <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>jdk</span><br><span class="line">ENV JAVA_HOME <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>jdk</span><br><span class="line">ENV JRE_HOME $JAVA_HOME<span class="operator">/</span>jre</span><br><span class="line">ENV CLASSPATH $JAVA_HOME<span class="operator">/</span>lib:$JRE_HOME<span class="operator">/</span>lib</span><br><span class="line">ENV PATH $PATH:$JAVA_HOME<span class="operator">/</span>bin</span><br></pre></td></tr></table></figure><h4 id="构建jdk镜像与检查"><a href="#构建jdk镜像与检查" class="headerlink" title="构建jdk镜像与检查"></a>构建jdk镜像与检查</h4><blockquote><p>速度超快，调用了本地构建的centos镜像，无需去仓库中下载发行版了</p></blockquote><p><img src="/image-20240728191934650.png" alt="image-20240728191934650"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看镜像</span></span><br><span class="line">[root@docker-01 ~]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED             SIZE</span><br><span class="line">jdk          8u202     ffc46acfe2d5   2 minutes ago       691MB</span><br><span class="line">centos       7.9       4e3332805815   About an hour ago   289MB</span><br><span class="line">[root@docker-01 ~]#docker <span class="built_in">history</span> jdk</span><br></pre></td></tr></table></figure><p><strong>最终运行容器传入命令验证jdk环境</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#jdk环境镜像构建成功</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>it <span class="comment">--rm ffc46acfe2d5 java -version</span></span><br><span class="line">java version &quot;1.8.0_202&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span><span class="number">.0</span>_202<span class="operator">-</span>b08)</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span><span class="operator">-</span>Bit Server VM (build <span class="number">25.202</span><span class="operator">-</span>b08, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="2-3-centos-jdk-tomcat-supervisor镜像"><a href="#2-3-centos-jdk-tomcat-supervisor镜像" class="headerlink" title="2.3 centos+jdk+tomcat+supervisor镜像"></a>2.3 centos+jdk+tomcat+supervisor镜像</h3><blockquote><p>tomcat官网下载：<a href="https://archive.apache.org/dist/tomcat/">https://archive.apache.org/dist/tomcat/</a></p></blockquote><h4 id="物料准备-1"><a href="#物料准备-1" class="headerlink" title="物料准备"></a>物料准备</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>tomacat软件包</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#rz <span class="operator">-</span>E</span><br><span class="line">rz waiting <span class="keyword">to</span> receive.</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#ls</span><br><span class="line">apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>supervisor配置文件</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#vim tomcat.ini</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#cat tomcat.ini </span><br><span class="line">[program:tomcat]</span><br><span class="line">command<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span>tomcat<span class="operator">/</span>bin<span class="operator">/</span>catalina.sh run #注意下这需要与tomcat解压路径一样</span><br><span class="line">autostart<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">autorestart<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">startsecs<span class="operator">=</span><span class="number">5</span></span><br><span class="line">redirect_stderr<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">stdout_logfile_maxbytes<span class="operator">=</span><span class="number">20</span>MB</span><br><span class="line">stdout_logfile_backups<span class="operator">=</span><span class="number">20</span></span><br><span class="line">stdout_logfile<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>supervisor<span class="operator">/</span>tomcat.log</span><br></pre></td></tr></table></figure><h4 id="dockerfile-2"><a href="#dockerfile-2" class="headerlink" title="dockerfile"></a>dockerfile</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#vim Dockerfile </span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#cat Dockerfile </span><br><span class="line"><span class="keyword">FROM</span> jdk:<span class="number">8</span>u202</span><br><span class="line">VOLUME <span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span></span><br><span class="line">VOLUME <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>supervisor<span class="operator">/</span></span><br><span class="line"><span class="keyword">ADD</span> apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>.tar.gz <span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span></span><br><span class="line">RUN ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span>apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span> <span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span>tomcat </span><br><span class="line"><span class="keyword">COPY</span> tomcat.ini <span class="operator">/</span>etc<span class="operator">/</span>supervisord.d<span class="operator">/</span></span><br><span class="line">RUN sed <span class="operator">-</span>i <span class="string">&#x27;s/nodaemon=false/nodaemon=true/g&#x27;</span> <span class="operator">/</span>etc<span class="operator">/</span>supervisord.conf</span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line">CMD [&quot;supervisord&quot;, &quot;-c&quot;, &quot;/etc/supervisord.conf&quot;]</span><br></pre></td></tr></table></figure><h4 id="构建运行镜像"><a href="#构建运行镜像" class="headerlink" title="构建运行镜像"></a>构建运行镜像</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#构建</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#ls</span><br><span class="line">apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>.tar.gz  Dockerfile  tomcat.ini</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#docker build <span class="operator">-</span>t tomcat:<span class="number">9.0</span><span class="number">.65</span> .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">tomcat       <span class="number">9.0</span><span class="number">.65</span>    <span class="number">135</span>c6db659a6   About a <span class="keyword">minute</span> ago   <span class="number">708</span>MB</span><br><span class="line">jdk          <span class="number">8</span>u202     ffc46acfe2d5   <span class="number">45</span> minutes ago       <span class="number">691</span>MB</span><br><span class="line">centos       <span class="number">7.9</span>       <span class="number">4e3332805815</span>   <span class="number">2</span> hours ago          <span class="number">289</span>MB</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker  history tomcat:<span class="number">9.0</span><span class="number">.65</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#运行tomcat容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run  <span class="operator">-</span>p <span class="number">80</span>:<span class="number">8080</span> <span class="comment">--rm --name tomcat-serve tomcat:9.0.65</span></span><br></pre></td></tr></table></figure><ul><li>测试构建速度超快</li></ul><p><img src="/image-20240728200301850.png" alt="image-20240728200301850"></p><h4 id="检查tomcat容器运行"><a href="#检查tomcat容器运行" class="headerlink" title="检查tomcat容器运行"></a>检查tomcat容器运行</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">docker top 容器id</span><br><span class="line">docker port 容器id</span><br></pre></td></tr></table></figure><p><img src="/image-20240728202451944.png" alt="image-20240728202451944"></p><h3 id="2-4-访问tomcat映射地址"><a href="#2-4-访问tomcat映射地址" class="headerlink" title="2.4 访问tomcat映射地址"></a>2.4 访问tomcat映射地址</h3><ul><li>至此，centos+jdk+tomcat+supervisor镜像构建完毕，基于镜像运行的容器检查运行环境也无误</li></ul><p><img src="/image-20240728202945053.png" alt="image-20240728202945053"></p><h1 id="六、容器化部署java项目-jpress博客"><a href="#六、容器化部署java项目-jpress博客" class="headerlink" title="六、容器化部署java项目-jpress博客"></a>六、容器化部署java项目-jpress博客</h1><blockquote><p>jpress这个web应用程序，需要数据库的支持方可部署上线</p></blockquote><h2 id="1-MSYQL数据库准备"><a href="#1-MSYQL数据库准备" class="headerlink" title="1.MSYQL数据库准备"></a>1.MSYQL数据库准备</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#镜像准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">mysql        latest    <span class="number">3218</span>b38490ce   <span class="number">2</span> years ago      <span class="number">516</span>MB</span><br><span class="line"></span><br><span class="line">#运行mysql容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run  <span class="comment">--name web-mysql --rm -e MYSQL_ROOT_PASSWORD=1 -d  mysql:latest </span></span><br><span class="line"><span class="number">76617</span>f5e89bbea548a901707b90efc7f214b34558fd7bd85a62067fe1b39e96b</span><br><span class="line"></span><br><span class="line">#检查容器运行</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps <span class="operator">-</span>a</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                 NAMES</span><br></pre></td></tr></table></figure><p><strong>检查容器内mysql服务运行</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#可以连接</span><br><span class="line">root<span class="variable">@76617f5e89bb</span>:<span class="operator">~</span># mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>h172<span class="number">.17</span><span class="number">.0</span><span class="number">.2</span> <span class="operator">-</span>P3306</span><br><span class="line">Enter password: #密码<span class="number">1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-启动tomcat容器"><a href="#2-启动tomcat容器" class="headerlink" title="2.启动tomcat容器"></a>2.启动tomcat容器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动tomcat容器，链接mysql容器，映射宿主机端口</span></span><br><span class="line">[root@docker-01 ~]#[root@docker-01 ~]#docker run -d --name web-tomcat --<span class="built_in">link</span>=web-mysql -p 80:8080  tomcat:9.0.65 </span><br><span class="line">969301c120bb64ffc6ab868078428bcabb235f0622d7216a826981f2ecb0b9dd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查容器进程</span></span><br><span class="line">[root@docker-01 ~]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS          PORTS                                   NAMES</span><br><span class="line">a8a998b4fd84   tomcat:9.0.65   <span class="string">&quot;supervisord -c /etc…&quot;</span>   5 seconds ago    Up 3 seconds    0.0.0.0:80-&gt;8080/tcp, :::80-&gt;8080/tcp   web-tomcat-mysql</span><br><span class="line">76617f5e89bb   mysql:latest    <span class="string">&quot;docker-entrypoint.s…&quot;</span>   26 minutes ago   Up 26 minutes   3306/tcp, 33060/tcp                     web-mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查数据卷挂载情况</span></span><br><span class="line">    <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/app/software&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;68fb26170825e1910f9c51c0a347bf7f508ec58a33c5472f76f2676ef30f4abe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/68fb26170825e1910f9c51c0a347bf7f508ec58a33c5472f76f2676ef30f4abe/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/var/log/supervisor&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p><strong>查看宿主机&#x2F;app&#x2F;software挂载的数据卷，进入解压的tomcat目录中</strong></p><blockquote><p>tomcat的运行环境自动挂载了宿主机的数据卷，是因为Dockerfile中定义了volume指令</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入docker数据卷存放目录中</span></span><br><span class="line">[root@docker-01 ~]#<span class="built_in">cd</span> /var/lib/docker/volumes/</span><br><span class="line">[root@docker-01 /var/lib/docker/volumes]#<span class="built_in">ls</span></span><br><span class="line">0bac6c68271101074d16f4a25a495df3d52965b22206858e9dc1958364741d34  backingFsBlockDev</span><br><span class="line">2cd4628653fa5fe699ee21c2ab94ed340e046a0ccc04505f95a6b0e7c07c7196  cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20</span><br><span class="line">5ae8c31da1cf8d5cd131a1087a4cffce81b502966ca22abd144b2797682b0aef  d1d3d1c4c7b29e2122496ee37bfb766c74d61ed112fada1f2f25e47306f775c4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入tomcat容器挂载的数据卷目录</span></span><br><span class="line">[root@docker-01 /var/lib/docker/volumes]#<span class="built_in">cd</span> cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20/_data</span><br><span class="line">[root@docker-01 /var/lib/docker/volumes/cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20/_data]#<span class="built_in">ls</span></span><br><span class="line">apache-tomcat-9.0.65  tomcat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#解压后的tomcat数据目录下的目录结构</span></span><br><span class="line">[root@docker-01 /var/lib/docker/volumes/cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20/_data/apache-tomcat-9.0.65]#<span class="built_in">ls</span></span><br><span class="line">bin  BUILDING.txt  conf  CONTRIBUTING.md  lib  LICENSE  logs  NOTICE  README.md  RELEASE-NOTES  RUNNING.txt  temp  webapps  work</span><br></pre></td></tr></table></figure><h2 id="3-Jpress应用部署"><a href="#3-Jpress应用部署" class="headerlink" title="3.Jpress应用部署"></a>3.Jpress应用部署</h2><blockquote><p>至此准备好了tomcat与mysql容器环境，可以部署jpress应用了</p><p>准备好jpress代码war包，放入宿主机的数据卷映射的&#x2F;app&#x2F;software&#x2F;tomcat&#x2F;webapps即可</p></blockquote><p><strong>数据卷所在目录</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE           COMMAND                  CREATED         STATUS         PORTS                                   NAMES</span><br><span class="line"><span class="number">969301</span>c120bb   tomcat:<span class="number">9.0</span><span class="number">.65</span>   &quot;supervisord -c /etc…&quot;   <span class="number">5</span> minutes ago   Up <span class="number">5</span> minutes   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">8080</span><span class="operator">/</span>tcp, :::<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">8080</span><span class="operator">/</span>tcp   web<span class="operator">-</span>tomcat</span><br><span class="line"><span class="number">76617</span>f5e89bb   mysql:latest    &quot;docker-entrypoint.s…&quot;   <span class="number">2</span> days ago      Up <span class="number">2</span> days      <span class="number">3306</span><span class="operator">/</span>tcp, <span class="number">33060</span><span class="operator">/</span>tcp                     web<span class="operator">-</span>mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect <span class="number">969</span></span><br><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">            &quot;Name&quot;: &quot;20b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b&quot;,</span><br><span class="line">            &quot;Source&quot;: &quot;/var/lib/docker/volumes/20b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b/_data&quot;,</span><br><span class="line">            &quot;Destination&quot;: &quot;/app/software&quot;,</span><br><span class="line">            &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">            &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;RW&quot;: <span class="literal">true</span>,</span><br><span class="line">            &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure><p><strong>进入对应数据卷的tomcat数据目录中的子目录webapps，将代码放入该目录</strong></p><blockquote><p>这个代码得找个压缩好的war包，官网下载的只有源码无法maven编译成jar包或war包</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#进入webapps目录</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span><span class="number">20</span>b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b<span class="operator">/</span>_data<span class="operator">/</span>apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span><span class="operator">/</span>webapps]#ll</span><br><span class="line">total <span class="number">4</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 15 root root 4096 Jul 31 11:00 docs</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---.  7 root root   99 Jul 31 11:00 examples</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---.  6 root root   79 Jul 31 11:00 host-manager</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---.  6 root root  114 Jul 31 11:00 manager</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---.  3 root root  223 Jul 31 11:00 ROOT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#放入代码</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span><span class="number">20</span>b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b<span class="operator">/</span>_data<span class="operator">/</span>apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span><span class="operator">/</span>webapps]#rz <span class="operator">-</span>E</span><br><span class="line">rz waiting <span class="keyword">to</span> receive.</span><br><span class="line">#自动解压缩加载java程序运行</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span><span class="number">20</span>b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b<span class="operator">/</span>_data<span class="operator">/</span>apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span><span class="operator">/</span>webapps]#ls</span><br><span class="line">docs  examples  host<span class="operator">-</span>manager  jpress  jpress.war  manager  ROOT</span><br></pre></td></tr></table></figure><h2 id="4-访问web测试结果"><a href="#4-访问web测试结果" class="headerlink" title="4.访问web测试结果"></a>4.访问web测试结果</h2><p>访问10.0.0.107&#x2F;jpress初始化安装即可</p><p><img src="/image-20240731111224126.png" alt="image-20240731111224126"></p><p>初始化后发布一篇文章</p><p><img src="/image-20240731111852378.png" alt="image-20240731111852378"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;一、dockerfile原理&quot;&gt;&lt;a href=&quot;#一、dockerfile原理&quot; class=&quot;headerlink&quot; title=&quot;一、dockerfile原理&quot;&gt;&lt;/a&gt;一、dockerfile原理&lt;/h1&gt;&lt;h2 id=&quot;1-镜像构建与提交的区别&quot;&gt;&lt;a </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-网络存储</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8/</id>
    <published>2024-08-20T01:31:14.000Z</published>
    <updated>2024-08-20T02:53:34.758Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker网络管理"><a href="#Docker网络管理" class="headerlink" title="Docker网络管理"></a>Docker网络管理</h1><blockquote><p>桥接模式：提供个网桥，可以让容器与宿主机实现通信，网桥会创建个网段，网关在宿主机，容器会分配个网段内的ip与外部通信</p><p>主机模式：容器用宿主机的网络配置，容器没有自己单独的网络空间，ip地址网卡都用宿主机的</p><p>容器模式：容器用其他容器的网络配置，也没有自己的网络空间</p><p>没有模式：容器没有网络空间，谁的网络空间也不用</p></blockquote><h2 id="1-网络概述"><a href="#1-网络概述" class="headerlink" title="1.网络概述"></a>1.网络概述</h2><ul><li><p>在Linux操作系统中，Docker的网络功能是一个复杂但关键的部分，它主要解决容器与容器、容器与外部网络、外部网络与容器之间的通信问题。以下是Docker网络功能的详细概述：</p><h3 id="一、Docker网络的基本概念"><a href="#一、Docker网络的基本概念" class="headerlink" title="一、Docker网络的基本概念"></a>一、Docker网络的基本概念</h3><p>Docker的网络功能基于Network Namespace提供隔离的网络环境，使得每个容器都拥有独立的网络栈。这种隔离性有助于保障容器的安全性和稳定性。</p><h3 id="二、Docker的网络模式"><a href="#二、Docker的网络模式" class="headerlink" title="二、Docker的网络模式"></a>二、Docker的网络模式</h3><p>Docker提供了多种网络模式，以适应不同的应用场景和需求。主要包括以下几种：</p><ol><li><strong>Bridge模式（桥接模式）</strong>：<ul><li><strong>默认模式</strong>：Docker容器默认使用Bridge模式。</li><li><strong>工作原理</strong>：Docker会创建一个名为docker0的虚拟网桥，类似于物理交换机，连接所有容器。每个容器都会被分配一个唯一的IP地址，并通过这个网桥进行通信。容器之间以及容器与宿主机之间的通信都通过这个网桥实现。</li><li><strong>端口映射</strong>：通过-p参数，可以将容器内部的端口映射到宿主机的端口上，从而允许外部网络访问容器中的服务。</li></ul></li><li><strong>Host模式</strong>：<ul><li><strong>特点</strong>：容器直接使用宿主机的网络堆栈，不配置虚拟网卡，共享宿主机的IP和端口。</li><li><strong>适用场景</strong>：对网络性能要求极高或需要直接与宿主机网络服务交互的应用。</li></ul></li><li><strong>Container模式</strong>：<ul><li><strong>特点</strong>：新容器不创建自己的网络配置，而是与指定容器共享IP和端口。</li><li><strong>适用场景</strong>：需要高度网络隔离但又需要共享网络环境的场景。</li></ul></li><li><strong>None模式</strong>：<ul><li><strong>特点</strong>：关闭容器的网络功能，不与其他容器或宿主机连通。</li><li><strong>适用场景</strong>：一些特定的应用场景，如仅需执行一次性任务且不需要网络通信的容器。</li></ul></li><li><strong>Overlay模式</strong>：<ul><li><strong>特点</strong>：用于在多个Docker主机之间创建一个虚拟网络，允许容器跨主机进行通信。</li><li><strong>适用场景</strong>：分布式系统或微服务架构中，需要实现容器跨主机通信的场景。</li></ul></li></ol><h3 id="三、Docker网络配置和管理"><a href="#三、Docker网络配置和管理" class="headerlink" title="三、Docker网络配置和管理"></a>三、Docker网络配置和管理</h3><ol><li><strong>查看网络列表</strong>：使用<code>docker network ls</code>命令可以列出Docker中所有的网络。</li><li><strong>检查网络详情</strong>：通过<code>docker network inspect [网络名]</code>命令可以查看指定网络的详细信息。</li><li><strong>创建自定义网络</strong>：使用<code>docker network create</code>命令可以创建自定义网络，并指定网络模式和选项。</li><li><strong>容器网络设置</strong>：在创建容器时，可以通过<code>--net</code>参数指定容器的网络模式。例如，<code>docker run --net=bridge ubuntu bash</code>会创建一个使用Bridge模式的容器。</li></ol><h3 id="四、Docker网络的优势"><a href="#四、Docker网络的优势" class="headerlink" title="四、Docker网络的优势"></a>四、Docker网络的优势</h3><ol><li><strong>隔离性</strong>：每个容器都有独立的网络栈，保证了容器之间的网络隔离。</li><li><strong>灵活性</strong>：提供了多种网络模式，以适应不同的应用场景和需求。</li><li><strong>高效性</strong>：通过虚拟网桥和端口映射等机制，实现了高效的容器间通信和容器与外部网络通信。</li></ol><p>综上所述，Docker的网络功能是其关键技术之一，它提供了强大的网络隔离性、灵活性和高效性，为容器化应用的部署和运维提供了有力的支持。</p></li></ul><h2 id="2-内核参数开启"><a href="#2-内核参数开启" class="headerlink" title="2.内核参数开启"></a>2.内核参数开启</h2><p>容器要想访问外部网络，需要本地系统的转发支持。在Linux 系统中，检查转发是否打开。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sysctl net.ipv4.ip_forward</span><br><span class="line"></span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure><p>如果为 0，说明没有开启转发，则需要手动打开。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sysctl -w net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure><p>如果在启动 Docker 服务的时候设定 <code>--ip-forward=true</code>, Docker 就会自动设定系统的 <code>ip_forward</code> 参数为 1。</p><h2 id="3-自定义默认网桥网段"><a href="#3-自定义默认网桥网段" class="headerlink" title="3.自定义默认网桥网段"></a>3.自定义默认网桥网段</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#修改docker配置文件</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>docker<span class="operator">/</span>daemon.json</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>docker<span class="operator">/</span>daemon.json</span><br><span class="line">&#123; </span><br><span class="line"> &quot;bip&quot;: &quot;192.168.0.1/24&quot;,</span><br><span class="line"> &quot;registry-mirrors&quot;: [&quot;https://504gl88z.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#systemctl restart  docker</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep docker</span><br><span class="line">root       <span class="number">3595</span>      <span class="number">1</span>  <span class="number">2</span> <span class="number">15</span>:<span class="number">19</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>dockerd <span class="operator">-</span>H fd:<span class="operator">/</span><span class="operator">/</span> <span class="comment">--containerd=/run/containerd/containerd.sock</span></span><br><span class="line">root       <span class="number">3807</span>    <span class="number">843</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">19</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto docker</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#运行容器检查网路信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps <span class="operator">-</span>a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                       PORTS     NAMES</span><br><span class="line"><span class="number">60537</span>f0578d7   busybox   &quot;sh&quot;                     <span class="number">47</span> minutes ago   Exited (<span class="number">137</span>) <span class="number">4</span> minutes </span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">start</span> <span class="number">60537</span>f0578d7 </span><br><span class="line"><span class="number">60537</span>f0578d7</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS         PORTS     NAMES</span><br><span class="line"><span class="number">60537</span>f0578d7   busybox   &quot;sh&quot;      <span class="number">48</span> minutes ago   Up <span class="number">3</span> seconds             goofy_einstein</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">exec</span> <span class="operator">-</span>it <span class="number">60537</span>f0578d7 sh</span><br><span class="line"><span class="operator">/</span> # ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr <span class="number">02</span>:<span class="number">42</span>:C0:A8:<span class="number">00</span>:<span class="number">02</span>  </span><br><span class="line">          inet addr:<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span>  Bcast:<span class="number">192.168</span><span class="number">.0</span><span class="number">.255</span>  Mask:<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line">          UP BROADCAST <span class="keyword">RUNNING</span> MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">8</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">0</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">0</span> </span><br><span class="line">          RX bytes:<span class="number">656</span> (<span class="number">656.0</span> B)  TX bytes:<span class="number">0</span> (<span class="number">0.0</span> B)</span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">#检查宿主机的网桥网关地址</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ifconfig </span><br><span class="line">docker0: flags<span class="operator">=</span><span class="number">4163</span><span class="operator">&lt;</span>UP,BROADCAST,<span class="keyword">RUNNING</span>,MULTICAST<span class="operator">&gt;</span>  mtu <span class="number">1500</span></span><br><span class="line">        inet <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>  netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>  broadcast <span class="number">192.168</span><span class="number">.0</span><span class="number">.255</span></span><br><span class="line">        inet6 fe80::<span class="number">42</span>:<span class="number">52</span>ff:fe1c:<span class="number">1746</span>  prefixlen <span class="number">64</span>  scopeid <span class="number">0x20</span><span class="operator">&lt;</span>link<span class="operator">&gt;</span></span><br><span class="line">        ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">52</span>:<span class="number">1</span>c:<span class="number">17</span>:<span class="number">46</span>  txqueuelen <span class="number">0</span>  (Ethernet)</span><br><span class="line">        RX packets <span class="number">134508</span>  bytes <span class="number">20264153</span> (<span class="number">19.3</span> MiB)</span><br><span class="line">        RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        TX packets <span class="number">160805</span>  bytes <span class="number">776283840</span> (<span class="number">740.3</span> MiB)</span><br><span class="line">        TX errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br></pre></td></tr></table></figure><h1 id="Docker数据卷存储"><a href="#Docker数据卷存储" class="headerlink" title="Docker数据卷存储"></a>Docker数据卷存储</h1><h2 id="1-数据卷作用"><a href="#1-数据卷作用" class="headerlink" title="1.数据卷作用"></a>1.数据卷作用</h2><p><strong>为什么使用docker数据卷</strong></p><p>Docker 数据卷（Volumes）是一种持久化和管理 Docker  容器数据的机制。它们在容器重启或重新创建时保持数据不变，并可以用于数据的共享和备份。理解 Docker  数据卷的好处可以帮助你更有效地管理容器化应用的数据。以下是使用 Docker 数据卷的主要原因：</p><p><strong>1. 数据持久化</strong></p><p>容器是临时的，默认情况下，容器内的数据在容器删除后会丢失。数据卷允许将数据存储在宿主机的文件系统中，确保数据在容器重启、删除或重新创建后仍然存在。例如，如果你有一个数据库容器，你希望其数据在容器重启后仍然保持不变，你可以使用数据卷来存储数据库的数据文件。</p><p><strong>2. 数据共享</strong></p><p>数据卷可以在多个容器之间共享数据。这样，你可以让多个容器访问同一个数据卷，进行读写操作。这对于需要多个服务共同处理相同数据的场景非常有用。例如，多个容器可以同时访问同一个卷来读取配置文件或日志文件。</p><p><strong>3. 数据备份和恢复</strong></p><p>通过数据卷，你可以轻松备份和恢复数据。可以将数据卷的内容导出到宿主机的目录中，进行备份，也可以从备份中恢复数据。这样可以减少数据丢失的风险，并简化数据恢复过程。</p><p><strong>4. 简化容器管理</strong></p><p>使用数据卷可以简化容器的管理。例如，当你更新应用或重新创建容器时，不需要担心数据丢失。只需重新挂载数据卷即可继续使用之前的数据。这种方法还可以帮助你更轻松地升级应用或迁移应用到新的环境。</p><p><strong>5. 性能优化</strong></p><p>数据卷通常比容器内的文件系统更高效，特别是在容器需要频繁读写数据时。使用数据卷可以提高 I&#x2F;O 性能，因为数据卷通常位于宿主机的文件系统中，而不是容器的临时文件系统中。</p><h2 id="2-使用数据卷"><a href="#2-使用数据卷" class="headerlink" title="2.使用数据卷"></a>2.使用数据卷</h2><p><strong>1.启动时指定</strong></p><blockquote><p>启动容器时主动-v参数指定宿主机数据卷路径与容器内挂载点路径 docker run -v 宿主机路径:容器内路径</p></blockquote><p><strong>2.镜像中指定</strong></p><blockquote><p>镜像中使用volume指令指定容器内要创建卷的路径，数据卷默认路径在宿主机&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volume&#x2F;下方</p></blockquote><h2 id="3-删除数据卷"><a href="#3-删除数据卷" class="headerlink" title="3.删除数据卷"></a>3.删除数据卷</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#查看卷的信息</span><br><span class="line">docker volume ls</span><br><span class="line">docker volume ls <span class="operator">-</span>q</span><br><span class="line">ls <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volume<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#清理某个卷</span><br><span class="line">docker volume rm 卷id</span><br><span class="line">#清除未挂载的卷</span><br><span class="line">docker volume prune </span><br><span class="line">#清理全部卷，包括挂载的卷，危险命令</span><br><span class="line">docker volume rm `docker volume ls <span class="operator">-</span>q`</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Docker网络管理&quot;&gt;&lt;a href=&quot;#Docker网络管理&quot; class=&quot;headerlink&quot; title=&quot;Docker网络管理&quot;&gt;&lt;/a&gt;Docker网络管理&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;桥接模式：提供个网桥，可以让容器与宿主机实现通信，</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-安装部署</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</id>
    <published>2024-08-20T01:31:00.000Z</published>
    <updated>2024-08-20T02:52:42.491Z</updated>
    
    <content type="html"><![CDATA[<h1 id="docker安装部署"><a href="#docker安装部署" class="headerlink" title="docker安装部署"></a>docker安装部署</h1><h2 id="1-开启流量转发"><a href="#1-开启流量转发" class="headerlink" title="1.开启流量转发"></a>1.开启流量转发</h2><blockquote><p>创建docker容器，会进行网络空间隔离，就是给容器分配不同的ip地址，会通过桥接的技术给容器分配不同网段地址，所以容器想要实现网络通信数据传输，就得通过流量转发给宿主机，</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#开启内核参数让宿主机与网桥下的容器可以进行数据包交互</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>sysctl.d<span class="operator">/</span>docker.conf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">net.bridge.bridge<span class="operator">-</span>nf<span class="operator">-</span><span class="keyword">call</span><span class="operator">-</span>ip6tables <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">net.bridge.bridge<span class="operator">-</span>nf<span class="operator">-</span><span class="keyword">call</span><span class="operator">-</span>iptables <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">net.ipv4.ip_forward<span class="operator">=</span><span class="number">1</span></span><br><span class="line">EOF</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>sysctl.d<span class="operator">/</span>docker.conf </span><br><span class="line">net.bridge.bridge<span class="operator">-</span>nf<span class="operator">-</span><span class="keyword">call</span><span class="operator">-</span>ip6tables <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">net.bridge.bridge<span class="operator">-</span>nf<span class="operator">-</span><span class="keyword">call</span><span class="operator">-</span>iptables <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">net.ipv4.ip_forward<span class="operator">=</span><span class="number">1</span></span><br><span class="line"></span><br><span class="line">#开启内核提供的桥接功能</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl <span class="operator">-</span>p <span class="operator">/</span>etc<span class="operator">/</span>sysctl.d<span class="operator">/</span>docker.conf</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#modprobe br_netfilter</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#sysctl <span class="operator">-</span>p <span class="operator">/</span>etc<span class="operator">/</span>sysctl.d<span class="operator">/</span>docker.conf</span><br><span class="line">net.bridge.bridge<span class="operator">-</span>nf<span class="operator">-</span><span class="keyword">call</span><span class="operator">-</span>ip6tables <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">net.bridge.bridge<span class="operator">-</span>nf<span class="operator">-</span><span class="keyword">call</span><span class="operator">-</span>iptables <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">net.ipv4.ip_forward <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong>参数解释：</strong></p><p>将指定的内核参数配置写入到<code>/etc/sysctl.d/docker.conf</code>文件中。让我们来解释一下每个参数的作用：</p><ol><li><code>net.bridge.bridge-nf-call-ip6tables = 1</code>：允许桥接设备调用IP6tables进行IPv6数据包的过滤。</li><li><code>net.bridge.bridge-nf-call-iptables = 1</code>：允许桥接设备调用iptables进行IPv4数据包的过滤。</li><li><code>net.ipv4.ip_forward=1</code>：允许Linux系统进行IPv4数据包的转发，这对于路由和网络共享非常重要。</li></ol><p>这些参数通常用于配置Docker守护进程的网络设置。在Docker中，宿主机的网络功能需要一些特定的内核参数来进行配置，以确保Docker容器能够正确地访问网络和进行IP转发等操作。</p><p>通过将这些参数写入到<code>/etc/sysctl.d/docker.conf</code>文件中，系统会在下一次启动时读取这些配置，并且应用到内核中，以确保Docker容器能够正常工作并正确地访问网络。</p><hr><p><code>modprobe</code>命令用于加载指定的内核模块。在这种情况下，<code>br_netfilter</code>是一个内核模块，它用于提供Linux桥接网络的一些额外功能。</p><p>具体来说，<code>br_netfilter</code>模块提供了对桥接设备网络包的过滤和处理功能，可以让桥接设备调用内核的网络过滤机制（如iptables）进行数据包的过滤和转发。</p><p>通过运行<code>modprobe br_netfilter</code>命令，可以加载<code>br_netfilter</code>模块，使得系统可以使用桥接设备的网络过滤功能。这对于一些网络配置和容器化平台（比如Docker）等场景可能是必要的。</p><h2 id="2-安装docker-ce"><a href="#2-安装docker-ce" class="headerlink" title="2.安装docker-ce"></a>2.安装docker-ce</h2><p><strong>介绍</strong></p><p>‌[Docker CE](<a href="https://www.baidu.com/s?wd=Docker">https://www.baidu.com/s?wd=Docker</a> CE&amp;usm&#x3D;1&amp;ie&#x3D;utf-8&amp;rsv_pq&#x3D;aba271a1006aead5&amp;oq&#x3D;Docker CE是什么&amp;rsv_t&#x3D;b074SUMkhDNmEpfOEf9kHMTT8ESZSBZqamN5NT6mvHeSxOp%2BhCkV68m%2B%2FYk&amp;sa&#x3D;re_dqa_zy)是Docker Community Edition的简称，即Docker社区版。它是Docker的一个免费版本，主要面向小企业和小的IT团队，旨在让用户免费使用并尝试基于容器的应用程序部署。Docker CE提供了构建、交付和运行应用程序所需的基本功能，适合那些希望从Docker开始学习和使用容器技术的用户。与Docker  EE（企业版）相比，CE版本虽然功能上可能有所限制，但仍然是一个功能完整的版本，能够满足大多数用户的基本需求。Docker  CE的stable版本每三个月发布一次，维护期为四个月，此外还有一个edge版本，每月发布一次，以满足不同用户的需求和测试需求。‌</p><p>Docker CE（社区版）可以被视为一个整套的Docker软件包，其中包括了Docker  Engine以及其他相关的工具和组件，这些工具和组件共同构成了一个完整的容器化平台。在Docker CE中，用户可以使用Docker  Engine创建、运行和管理容器，同时还可以利用其他工具如Docker Compose和Docker  Swarm来进行容器编排和集群管理。因此，Docker  CE可以被看作是一个完备的容器化套件，为用户提供了构建、发布和管理容器化应用程序的一揽子解决方案。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#清理docker原环境</span><br><span class="line">yum remove docker docker<span class="operator">-</span>common docker<span class="operator">-</span>selinux docker<span class="operator">-</span>engine</span><br><span class="line">#安装docker依赖包</span><br><span class="line">yum install yum<span class="operator">-</span>utils device<span class="operator">-</span>mapper<span class="operator">-</span>persistent<span class="operator">-</span>data lvm2</span><br><span class="line">#提供下载docker<span class="operator">-</span>re的yum仓库配置</span><br><span class="line">yum<span class="operator">-</span>config<span class="operator">-</span>manager <span class="comment">--add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line">#修改下载地址为阿里docker源</span><br><span class="line">sed <span class="operator">-</span>i <span class="string">&#x27;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#x27;</span> <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="operator">/</span>docker<span class="operator">-</span>ce.repo<span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="operator">/</span>docker<span class="operator">-</span>ce.repo</span><br><span class="line">#加载最新yum缓存</span><br><span class="line">yum makecache fast</span><br><span class="line">#安装docker<span class="operator">-</span>ce软件包</span><br><span class="line">yum install docker<span class="operator">-</span>ce <span class="operator">-</span>y</span><br><span class="line">#启动docker守护进行</span><br><span class="line">systemctl <span class="keyword">start</span> docker</span><br><span class="line">#查看docker服务端进程运行</span><br><span class="line">ps <span class="operator">-</span>ef<span class="operator">|</span>grep docker </span><br><span class="line">#检查docker组件版本</span><br><span class="line">docker version</span><br><span class="line">#配置docker镜像仓库阿里加速器</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>etc<span class="operator">/</span>docker</span><br><span class="line">tee <span class="operator">/</span>etc<span class="operator">/</span>docker<span class="operator">/</span>daemon.json <span class="operator">&lt;&lt;</span><span class="operator">-</span><span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://504gl88z.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">#重载重启</span><br><span class="line">sudo systemctl daemon<span class="operator">-</span>reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="3-启动第一个容器"><a href="#3-启动第一个容器" class="headerlink" title="3.启动第一个容器"></a>3.启动第一个容器</h2><blockquote><p>下载一个NGINX镜像，调用镜像创建运行容器，最后windows访问测试</p></blockquote><p><strong>远程仓库搜索镜像</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#下载点赞最多的是官方版本最安全，不指定nginx版本，默认搜索最新版</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">search</span> nginx</span><br><span class="line">NAME                               DESCRIPTION                                     STARS     OFFICIAL</span><br><span class="line">nginx                              Official build <span class="keyword">of</span> Nginx.                        <span class="number">19996</span>     [OK]</span><br><span class="line">unit                               Official build <span class="keyword">of</span> NGINX Unit: Universal Web …   <span class="number">32</span>        [OK]</span><br><span class="line">nginx<span class="operator">/</span>nginx<span class="operator">-</span>ingress                NGINX <span class="keyword">and</span>  NGINX Plus Ingress Controllers fo…   <span class="number">92</span>       、 </span><br></pre></td></tr></table></figure><p><strong>从仓库下载镜像</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#下载nginx镜像，不指定版本默认下载最新版</span><br><span class="line">#镜像是通过分层存储技术进行构建，所以会一层层下载（原理篇讲解了）</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull nginx</span><br><span class="line"><span class="keyword">Using</span> <span class="keyword">default</span> tag: latest</span><br><span class="line">latest: Pulling <span class="keyword">from</span> library<span class="operator">/</span>nginx</span><br><span class="line">a2abf6c4d29d: Pull complete </span><br><span class="line">a9edb18cadd1: Pull complete </span><br><span class="line"><span class="number">589</span>b7251471a: Pull complete </span><br><span class="line"><span class="number">186</span>b1aaa4aa6: Pull complete </span><br><span class="line">b4df32aa5a72: Pull complete </span><br><span class="line">a0bcbecc962e: Pull complete </span><br><span class="line">Digest: sha256:<span class="number">0</span>d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> nginx:latest</span><br><span class="line">docker.io<span class="operator">/</span>library<span class="operator">/</span>nginx:latest</span><br></pre></td></tr></table></figure><p><strong>调用镜像创建运行容器</strong></p><blockquote><p>至此成功地基于nginx镜像创建并启动了一个新的容器，该容器的 80 端口被映射到主机的 28877 端口</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#运行nginx容器，将容器内部的<span class="number">80</span>端口映射到主机的<span class="number">28877</span>端口上</span><br><span class="line">#运行容器后会生成容器id，容器唯一标识，通过id可管理容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d   <span class="operator">-</span>p <span class="number">28877</span>:<span class="number">80</span>      nginx</span><br><span class="line">f7bffe1c1854ec3c6c3c1d64a22d97a69414e07b5774bf44da494c219e231085</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure><p><strong>查看正在运行的容器</strong></p><blockquote><p>容器 “romantic_grothendieck” 使用的是 “nginx” 镜像，容器的 ID 是 “1cef8c73c320”。容器已经运行了 7 分钟，状态为 “Up”，这表明容器正在运行中。此容器的 80 端口已映射到主机的 28877 端口上。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                                     NAMES</span><br><span class="line"><span class="number">1</span>cef8c73c320   nginx     &quot;/docker-entrypoint.…&quot;   <span class="number">5</span> minutes ago   Up <span class="number">5</span> minutes   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">28877</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">28877</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp   romantic_grothendieck</span><br></pre></td></tr></table></figure><p><img src="/1661829890048-1721225329561-1.png" alt="1661829890048"></p><p><strong>访问容器nginx服务</strong></p><p><img src="/image-20240717221428786.png" alt="image-20240717221428786"></p><p><strong>图解容器的网络通信原理</strong></p><p>容器可以和公网通信是因为 Docker  在默认情况下会创建一个网络桥接接口，容器会被连接到这个网络中。通常来说，Docker 会使用 NAT （Network Address  Translation）技术，将容器内部的 IP 地址映射为宿主机的 IP 地址，这样容器就可以和宿主机以及外部网络通信了。</p><p>在你的示例中，容器的端口 80 已经映射到主机的端口 28877，这意味着外部的请求可以通过主机的 28877 端口访问到容器内的服务。</p><p>当然，Docker 也提供了更多的网络配置选项，你可以自定义容器的网络设置，包括端口映射、网络模式等等。</p><p><img src="/image-20240717221510680.png" alt="image-20240717221510680"></p><p><strong>分析容器进程信息</strong></p><blockquote><p>得出结论</p><p>1.容器运行的服务或应用，都会在一个单独的命名空间中运行，与宿主机环境隔离</p><p>2.容器停止后，通过容器运行的服务，也会随着停止</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>查看运行的容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                                     NAMES</span><br><span class="line">f7bffe1c1854   nginx     &quot;/docker-entrypoint.…&quot;   <span class="number">20</span> minutes ago   Up <span class="number">20</span> minutes   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">28877</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">28877</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp   keen_kirch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>查看运行的nginx进程</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep nginx</span><br><span class="line">root      <span class="number">19476</span>  <span class="number">19457</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">14</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line"><span class="number">101</span>       <span class="number">19522</span>  <span class="number">19476</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">14</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line"><span class="number">101</span>       <span class="number">19523</span>  <span class="number">19476</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">14</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">root      <span class="number">19921</span>  <span class="number">19889</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">06</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto nginx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>查看运行nginx父进程信息</span><br><span class="line">#docker创建了一个命名空间【moby】，nginx是在这个独立空间中运行，实现了与宿主机的环境隔离</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep <span class="number">19457</span></span><br><span class="line">root      <span class="number">19457</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">14</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>containerd<span class="operator">-</span>shim<span class="operator">-</span>runc<span class="operator">-</span>v2 <span class="operator">-</span>namespace moby <span class="operator">-</span>id <span class="number">1</span>cef8c73c320bb493b348ebf687793eb96e4ea996ec422009a1b0b4454ae93e3 <span class="operator">-</span>address <span class="operator">/</span>run<span class="operator">/</span>containerd<span class="operator">/</span>containerd.sock</span><br><span class="line">root      <span class="number">19476</span>  <span class="number">19457</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">14</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line">root      <span class="number">19923</span>  <span class="number">19889</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">06</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto 19457</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>停止docker运行的容器，查看nginx服务是否还在运行</span><br><span class="line">#查看容器信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED        STATUS        PORTS                                     NAMES</span><br><span class="line"><span class="number">1</span>cef8c73c320   nginx     &quot;/docker-entrypoint.…&quot;   <span class="number">13</span> hours ago   Up <span class="number">13</span> hours   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">28877</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">28877</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp   romantic_grothendieck</span><br><span class="line">#停止容器，基于容器id前<span class="number">3</span>位<span class="operator">~</span>全部位，基于容器名也可以</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker stop <span class="number">1</span>ce</span><br><span class="line"><span class="number">1</span>ce</span><br><span class="line">#再次查看停止成功</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>容器挂掉后，容器内所运行的nginx也停止了</span><br><span class="line">#查看全部容器信息，包括运行的挂掉的容器相关信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps <span class="operator">-</span>a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED        STATUS                     PORTS     NAMES</span><br><span class="line"><span class="number">1</span>cef8c73c320   nginx     &quot;/docker-entrypoint.…&quot;   <span class="number">13</span> hours ago   Exited (<span class="number">0</span>) <span class="number">5</span> minutes ago             romantic_grothendieck</span><br><span class="line">#nginx也挂了</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep nignx</span><br><span class="line">root      <span class="number">20277</span>  <span class="number">19889</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">48</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto nignx</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240718104923119.png" alt="image-20240718104923119"></p><h1 id="初体验docker用法"><a href="#初体验docker用法" class="headerlink" title="初体验docker用法"></a>初体验docker用法</h1><h2 id="1-官方API文档"><a href="#1-官方API文档" class="headerlink" title="1.官方API文档"></a>1.官方API文档</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="operator">/</span><span class="operator">/</span>docs.docker.com<span class="operator">/</span>registry<span class="operator">/</span>spec<span class="operator">/</span>api<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"># 获取tags版本</span><br><span class="line">https:<span class="operator">/</span><span class="operator">/</span>hub.docker.com<span class="operator">/</span>v2<span class="operator">/</span>repositories<span class="operator">/</span>library<span class="operator">/</span>nginx<span class="operator">/</span>tags</span><br></pre></td></tr></table></figure><p><img src="/1661999781352.png" alt="1661999781352"></p><h2 id="2-搜索下载镜像"><a href="#2-搜索下载镜像" class="headerlink" title="2.搜索下载镜像"></a>2.搜索下载镜像</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>镜像仓库搜索镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">search</span> redis</span><br><span class="line">NAME                                    DESCRIPTION                                     STARS     OFFICIAL</span><br><span class="line">redis                                   Redis <span class="keyword">is</span> the world’s fastest data platform f…   <span class="number">12898</span>     [OK]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>下载官网认证镜像</span><br><span class="line">#不指定版本下载最新版</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull redis</span><br><span class="line"><span class="keyword">Using</span> <span class="keyword">default</span> tag: latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>下载完成</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull redis</span><br><span class="line"><span class="keyword">Using</span> <span class="keyword">default</span> tag: latest</span><br><span class="line">latest: Pulling <span class="keyword">from</span> library<span class="operator">/</span>redis</span><br><span class="line">a2abf6c4d29d: Already <span class="keyword">exists</span> </span><br><span class="line">c7a4e4382001: Pull complete </span><br><span class="line"><span class="number">4044</span>b9ba67c9: Pull complete </span><br><span class="line">c8388a79482f: Pull complete </span><br><span class="line"><span class="number">413</span>c8bb60be2: Pull complete </span><br><span class="line"><span class="number">1</span>abfd3011519: Pull complete </span><br><span class="line">Digest: sha256:db485f2e245b5b3329fdc7eff4eb00f913e09d8feb9ca720788059fdc2ed8339</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> redis:latest</span><br><span class="line">docker.io<span class="operator">/</span>library<span class="operator">/</span>redis:latest</span><br></pre></td></tr></table></figure><p><strong>解释：a2abf6c4d29d: Already exists （已经存在）</strong></p><blockquote><p>Docker镜像是通过分层存储技术来构建的，每一层都包含特定的文件和配置。当您下载一个镜像时，Docker将会下载每个镜像层并组合在一起形成完整的镜像。</p><p>因此，当您下载一个新的镜像时，Docker会检查本地是否已经有相同的镜像层。如果发现本地已经存在相同的镜像层，Docker就不需要再次从镜像仓库下载该层，而是直接使用本地的镜像层。这种机制可以显著减少重复下载和节省网络带宽。</p><p>在启动容器时，Docker会根据构建镜像时的各个层来组合出容器的文件系统。因为镜像层已经存在本地，Docker只需引用这些本地的层，而不需要重新下载或提取镜像的层。这样可以节省时间和资源，并提高容器的启动速度。</p></blockquote><p>当Docker提示 “a2abf6c4d29d: Already exists” 时，它意味着在下载镜像时，Docker已经在本地找到了具有相同标识符的镜像层，所以它不需要再次从远程仓库下载这一层</p><p>Docker执行这样的优化行为主要是为了提高效率和节省带宽。当您在多台机器或者多次部署同一个镜像时，Docker会在本地缓存已经下载的镜像层。如果在后续的拉取过程中发现本地已经存在相同标识符的镜像层，Docker就不需要再次下载，而是直接使用本地的镜像层，从而节省时间和网络带宽。</p><p>这种优化有助于加速镜像的拉取，并减少对网络资源的消耗。特别是在大规模部署或者团队协作的情况下，这种优化可以显著降低镜像拉取的时间成本，提高整体的开发和部署效率。</p><p><img src="/1661832566515.png" alt="1661832566515"></p><h2 id="3-查看镜像列表"><a href="#3-查看镜像列表" class="headerlink" title="3.查看镜像列表"></a>3.查看镜像列表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#查看当前机器下载的所有镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">nginx        latest    <span class="number">605</span>c77e624dd   <span class="number">2</span> years ago   <span class="number">141</span>MB</span><br><span class="line">redis        latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago   <span class="number">113</span>MB</span><br><span class="line">#查看指定名字的镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images nginx</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">nginx        latest    <span class="number">605</span>c77e624dd   <span class="number">2</span> years ago   <span class="number">141</span>MB</span><br></pre></td></tr></table></figure><ul><li>NGINX镜像：<ul><li>仓库名称（Repository）: nginx</li><li>标签（Tag）: latest</li><li>镜像ID（Image ID）: 605c77e624dd</li><li>创建时间（Created）: 2年前</li><li>大小（Size）: 141MB</li></ul></li><li>Redis镜像：<ul><li>仓库名称（Repository）: redis</li><li>标签（Tag）: latest</li><li>镜像ID（Image ID）: 7614ae9453d1</li><li>创建时间（Created）: 2年前</li><li>大小（Size）: 113MB</li></ul></li></ul><p><img src="/1661832733692.png" alt="1661832733692"></p><h2 id="4-查看镜像构建记录"><a href="#4-查看镜像构建记录" class="headerlink" title="4.查看镜像构建记录"></a>4.查看镜像构建记录</h2><blockquote><p><code>docker history</code> 命令用于显示指定镜像的构建历史，包括每一层的创建方式、大小、以及所用的命令等信息。这个命令可以帮助用户了解镜像是如何构建的，以及每一层的变化和影响</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#查看redis镜像构建记录</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history redis</span><br><span class="line">IMAGE          CREATED       CREATED <span class="keyword">BY</span>                                      SIZE      COMMENT</span><br><span class="line"><span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  CMD [&quot;redis-server&quot;]         <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  EXPOSE <span class="number">6379</span>                  <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  ENTRYPOINT [&quot;docker-entry…   0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop) COPY file:df205a0ef6e6df89…   374B      </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop) WORKDIR /data                 0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  VOLUME [/data]               0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c mkdir /data &amp;&amp; chown redis:redis …   0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c set -eux;   savedAptMark=&quot;$(apt<span class="operator">-</span>m…   <span class="number">27.8</span>MB    </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  ENV REDIS_DOWNLOAD_SHA<span class="operator">=</span><span class="number">5</span>b…   <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  ENV REDIS_DOWNLOAD_URL<span class="operator">=</span>ht…   <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  ENV REDIS_VERSION<span class="operator">=</span><span class="number">6.2</span><span class="number">.6</span>      <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c <span class="keyword">set</span> <span class="operator">-</span>eux;  savedAptMark<span class="operator">=</span>&quot;$(apt-ma…   4.24MB    </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  ENV GOSU_VERSION=1.12        0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c groupadd -r -g 999 redis &amp;&amp; usera…   329kB     </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop) ADD file:09675d11695f65c55…   80.4MB    </span><br><span class="line"></span><br><span class="line">#查看nginx镜像构建记录</span><br><span class="line">[root@docker-01 ~]#docker history nginx</span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">605c77e624dd   2 years ago   /bin/sh -c #(nop)  CMD [&quot;nginx&quot; &quot;<span class="operator">-</span>g&quot; &quot;daemon…   <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  STOPSIGNAL SIGQUIT           <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  EXPOSE <span class="number">80</span>                    <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  ENTRYPOINT [&quot;/docker-entr…   0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop) COPY file:09a214a3e07c919a…   4.61kB    </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7…   1.04kB    </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop) COPY file:0b866ff3fc1ef5b0…   1.96kB    </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop) COPY file:65504f71f5855ca0…   1.2kB     </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c set -x     &amp;&amp; addgroup --system -…   61.1MB    </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  ENV PKG_RELEASE=1~bullseye   0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  ENV NJS_VERSION=0.7.1        0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  ENV NGINX_VERSION=1.21.5     0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  LABEL maintainer=NGINX Do…   0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop) ADD file:09675d11695f65c55…   80.4MB    </span><br></pre></td></tr></table></figure><blockquote><p>&#x3D;&#x3D;镜像就是指定了服务或应用程序的运行依赖环境以及执行命令，最终目的就是让程序运行&#x3D;&#x3D;</p><p>【静态文件指的是在服务器上存储的固定内容，不会根据用户的请求或其他因素而改变。例如，HTML页面、图片、CSS样式表和JavaScript文件通常被视为静态文】</p></blockquote><p>Docker 镜像是由一系列的层（Layers）组成的。每一层代表了一个文件系统的改变，这些改变可以是添加、修改或删除文件。当你构建一个 Docker 镜像时，每一层都对应着你在 Dockerfile 中的一条指令，比如添加文件、运行命令等。</p><p>每一层所做的事情可以包括：</p><ol><li>添加文件：比如复制文件到镜像中</li><li>运行命令：比如在基础镜像上运行一个命令，使得该层包含了命令执行后的文件系统改变</li><li>安装软件包：比如使用包管理工具安装软件包</li><li>设置环境变量：配置镜像中的环境变量</li><li>其他文件系统改变：比如修改文件权限、添加链接等</li></ol><p>作用：每一层的作用是将上一层的改变叠加在一起，最终形成一个完整的 Docker 镜像。这种分层的设计使得镜像构建更加高效、灵活，并且可以更好地管理和复用镜像的组件</p><p><img src="/1661833148292.png" alt="1661833148292"></p><h2 id="5-获取镜像可用版本"><a href="#5-获取镜像可用版本" class="headerlink" title="5.获取镜像可用版本"></a>5.获取镜像可用版本</h2><blockquote><p>镜像仓库每个镜像都有很多版本，默认是下载的最新版的，如何查看可提供的镜像的版本都有哪些</p><p>需要梯子，从Docker Hub的API中获取镜像的标签版本信息，并使用jq命令来格式化和处理JSON数据，友好显示</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#查询centos镜像版本</span><br><span class="line">curl <span class="operator">-</span>s https:<span class="operator">/</span><span class="operator">/</span>registry.hub.docker.com<span class="operator">/</span>v1<span class="operator">/</span>repositories<span class="operator">/</span>centos<span class="operator">/</span>tags  <span class="operator">|</span>   jq</span><br><span class="line">#查询mysql镜像版本</span><br><span class="line">curl <span class="operator">-</span>s https:<span class="operator">/</span><span class="operator">/</span>registry.hub.docker.com<span class="operator">/</span>v1<span class="operator">/</span>repositories<span class="operator">/</span>mysql<span class="operator">/</span>tags  <span class="operator">|</span>   jq</span><br></pre></td></tr></table></figure><h2 id="6-下载指定版本镜像"><a href="#6-下载指定版本镜像" class="headerlink" title="6.下载指定版本镜像"></a>6.下载指定版本镜像</h2><blockquote><p>针对所需的版本去下载镜像，就可以根据指定版本运行容器了</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#下载MSYQL5<span class="number">.7</span><span class="number">.25</span>与<span class="number">5.7</span><span class="number">.7</span>两个镜像【镜像就是对某个服务应用，运行<span class="operator">+</span>运行环境的一个封装】</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-200</span> <span class="operator">/</span>opt]#docker pull mysql:<span class="number">5.7</span><span class="number">.25</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-200</span> <span class="operator">/</span>opt]#docker pull mysql:<span class="number">5.7</span><span class="number">.7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看下载的镜像，latest是最新版</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">nginx        latest    <span class="number">605</span>c77e624dd   <span class="number">2</span> years ago   <span class="number">141</span>MB</span><br><span class="line">redis        latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago   <span class="number">113</span>MB</span><br><span class="line">mysql        <span class="number">5.7</span><span class="number">.25</span>    <span class="number">98455</span>b9624a9   <span class="number">5</span> years ago   <span class="number">372</span>MB</span><br></pre></td></tr></table></figure><h2 id="7-指定版本运行容器"><a href="#7-指定版本运行容器" class="headerlink" title="7.指定版本运行容器"></a>7.指定版本运行容器</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>下载指定版本镜像NGINX1<span class="number">.19</span><span class="number">.7</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull  nginx:<span class="number">1.19</span><span class="number">.7</span></span><br><span class="line"><span class="number">1.19</span><span class="number">.7</span>: Pulling <span class="keyword">from</span> library<span class="operator">/</span>nginx</span><br><span class="line"><span class="number">45</span>b42c59be33: Pull complete </span><br><span class="line"><span class="number">8</span>acc495f1d91: Pull complete </span><br><span class="line">ec3bd7de90d7: Pull complete </span><br><span class="line"><span class="number">19e2441</span>aeeab: Pull complete </span><br><span class="line">f5a38c5f8d4e: Pull complete </span><br><span class="line"><span class="number">83500</span>d851118: Pull complete </span><br><span class="line">Digest: sha256:f3693fe50d5b1df1ecd315d54813a77afd56b0245a404055a946574deb6b34fc</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> nginx:<span class="number">1.19</span><span class="number">.7</span></span><br><span class="line">docker.io<span class="operator">/</span>library<span class="operator">/</span>nginx:<span class="number">1.19</span><span class="number">.7</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>查看已下载镜像列表</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">nginx        latest    <span class="number">605</span>c77e624dd   <span class="number">2</span> years ago   <span class="number">141</span>MB</span><br><span class="line">redis        latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago   <span class="number">113</span>MB</span><br><span class="line">nginx        <span class="number">1.19</span><span class="number">.7</span>    <span class="number">35</span>c43ace9216   <span class="number">3</span> years ago   <span class="number">133</span>MB</span><br><span class="line">mysql        <span class="number">5.7</span><span class="number">.25</span>    <span class="number">98455</span>b9624a9   <span class="number">5</span> years ago   <span class="number">372</span>MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>本地运行容器测试访问</span><br><span class="line">#前台运行容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run nginx:<span class="number">1.19</span><span class="number">.74</span></span><br><span class="line">#后台运行容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d nginx:<span class="number">1.19</span><span class="number">.74</span></span><br><span class="line">#查询容器详细信息，过滤容器网络信息ip地址</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect <span class="number">405</span><span class="operator">|</span>grep <span class="operator">-</span>i address</span><br><span class="line">            &quot;LinkLocalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;SecondaryIPAddresses&quot;: <span class="keyword">null</span>,</span><br><span class="line">            &quot;SecondaryIPv6Addresses&quot;: <span class="keyword">null</span>,</span><br><span class="line">            &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;IPAddress&quot;: &quot;172.17.0.6&quot;,</span><br><span class="line">#当前只有本地可以访问，因为没有做端口映射</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#curl <span class="operator">-</span>I <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">HTTP<span class="operator">/</span><span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Server: nginx<span class="operator">/</span><span class="number">1.19</span><span class="number">.7</span></span><br><span class="line"><span class="type">Date</span>: Thu, <span class="number">18</span> Jul <span class="number">2024</span> <span class="number">05</span>:<span class="number">34</span>:<span class="number">32</span> GMT</span><br><span class="line">Content<span class="operator">-</span>Type: text<span class="operator">/</span>html</span><br><span class="line">Content<span class="operator">-</span>Length: <span class="number">612</span></span><br><span class="line"><span class="keyword">Last</span><span class="operator">-</span>Modified: Tue, <span class="number">16</span> Feb <span class="number">2021</span> <span class="number">15</span>:<span class="number">57</span>:<span class="number">18</span> GMT</span><br><span class="line">Connection: keep<span class="operator">-</span>alive</span><br><span class="line">ETag: &quot;602beb5e-264&quot;</span><br><span class="line">Accept<span class="operator">-</span>Ranges: bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>端口映射宿主机运行容器，可以提供与外部网络的通信</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d <span class="operator">-</span>p8080:<span class="number">80</span> nginx:<span class="number">1.19</span><span class="number">.7</span> </span><br><span class="line">bfff8ff41c7a013e61dbbba24ecca1e389a1f556b9f90fbfbe71455a904c7bea</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">8080</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8080</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="operator">*</span>               LISTEN      <span class="number">21814</span><span class="operator">/</span>docker<span class="operator">-</span>proxy  </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">8080</span>                 :::<span class="operator">*</span>                    LISTEN      <span class="number">21820</span><span class="operator">/</span>docker<span class="operator">-</span>proxy </span><br><span class="line">#此时就可以通过宿主机连通外网了</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#curl <span class="operator">-</span>I <span class="number">10.0</span><span class="number">.0</span><span class="number">.107</span>:<span class="number">8080</span></span><br><span class="line">HTTP<span class="operator">/</span><span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Server: nginx<span class="operator">/</span><span class="number">1.19</span><span class="number">.7</span></span><br><span class="line"><span class="type">Date</span>: Thu, <span class="number">18</span> Jul <span class="number">2024</span> <span class="number">05</span>:<span class="number">50</span>:<span class="number">53</span> GMT</span><br><span class="line">Content<span class="operator">-</span>Type: text<span class="operator">/</span>html</span><br><span class="line">Content<span class="operator">-</span>Length: <span class="number">612</span></span><br><span class="line"><span class="keyword">Last</span><span class="operator">-</span>Modified: Tue, <span class="number">16</span> Feb <span class="number">2021</span> <span class="number">15</span>:<span class="number">57</span>:<span class="number">18</span> GMT</span><br><span class="line">Connection: keep<span class="operator">-</span>alive</span><br><span class="line">ETag: &quot;602beb5e-264&quot;</span><br><span class="line">Accept<span class="operator">-</span>Ranges: bytes</span><br></pre></td></tr></table></figure><p><img src="/1661833955076.png" alt="1661833955076"></p><h1 id="管理容器常用命令"><a href="#管理容器常用命令" class="headerlink" title="管理容器常用命令"></a>管理容器常用命令</h1><h2 id="1-前台创建容器"><a href="#1-前台创建容器" class="headerlink" title="1.前台创建容器"></a>1.前台创建容器</h2><blockquote><p>创建新的容器并且运行容器</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#查看本地镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">redis        latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago   <span class="number">113</span>MB</span><br><span class="line"></span><br><span class="line">#指定镜像版本运行容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run redis:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#指定镜像id运行容器【不建议用id启动容器，ps查容器信息不知道运行的啥服务】</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="number">761</span></span><br></pre></td></tr></table></figure><h2 id="2-后台创建容器"><a href="#2-后台创建容器" class="headerlink" title="2.后台创建容器"></a>2.后台创建容器</h2><blockquote><p> 创建新的容器并且运行容器</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#查看进程</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">redis        latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago   <span class="number">113</span>MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#指定版本运行容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d redis:latest</span><br><span class="line"><span class="number">4</span>c24ca837a3e25a740f0f9a3e92b50eacf80572d1c86725caa3241acaf606e9e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#指定镜像id运行容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d  <span class="number">761</span></span><br><span class="line"><span class="number">5e719774</span>d9975d664b7105976fe0dbbdacba0247dd41fda283dcd2dab73cfb3d</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure><h2 id="3-端口映射创建"><a href="#3-端口映射创建" class="headerlink" title="3.端口映射创建"></a>3.端口映射创建</h2><blockquote><p>创建新的容器并且运行容器</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#后台运行端口容器<span class="number">6379</span>映射宿主机<span class="number">26379</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d <span class="operator">-</span>p <span class="number">26379</span>:<span class="number">6379</span> redis:latest</span><br><span class="line"><span class="number">2100</span>f9afab720aabcf6a5071ab0e13eea256e1be39ebc56b1705759aff376a6d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看运行的容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED              STATUS              PORTS                                         NAMES</span><br><span class="line"><span class="number">2100</span>f9afab72   redis:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">3</span> seconds ago        Up <span class="number">2</span> seconds        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">26379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp, :::<span class="number">26379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp   agitated_shaw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看映射的端口</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep redis</span><br><span class="line">tcp   LISTEN     <span class="number">0</span>      <span class="number">128</span>                                           [::]:<span class="number">26379</span>                                                     [::]:<span class="operator">*</span>                   users:((&quot;docker-proxy&quot;,pid<span class="operator">=</span><span class="number">26702</span>,fd<span class="operator">=</span><span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看运行容器后跑的服务进程</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep redis</span><br><span class="line">polkitd   <span class="number">26551</span>  <span class="number">26531</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">02</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> redis<span class="operator">-</span>server <span class="operator">*</span>:<span class="number">6379</span></span><br><span class="line">polkitd   <span class="number">26735</span>  <span class="number">26715</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">04</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> redis<span class="operator">-</span>server <span class="operator">*</span>:<span class="number">6379</span></span><br><span class="line">root      <span class="number">26777</span>  <span class="number">19889</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">04</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto redis</span></span><br></pre></td></tr></table></figure><h2 id="4-查看容器信息"><a href="#4-查看容器信息" class="headerlink" title="4.查看容器信息"></a>4.查看容器信息</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#查看运行的容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line"><span class="number">207</span>d1c076699   nginx:<span class="number">1.19</span><span class="number">.7</span>   &quot;/docker-entrypoint.…&quot;   <span class="number">18</span> seconds ago   Up <span class="number">16</span> seconds   <span class="number">80</span><span class="operator">/</span>tcp    hardcore_matsumoto</span><br><span class="line">dfe6d6d768ea   nginx:<span class="number">1.19</span><span class="number">.7</span>   &quot;/docker-entrypoint.…&quot;   <span class="number">19</span> seconds ago   Up <span class="number">18</span> seconds   <span class="number">80</span><span class="operator">/</span>tcp    competent_mccarthy</span><br><span class="line">d9a61935cb5f   nginx:<span class="number">1.19</span><span class="number">.7</span>   &quot;/docker-entrypoint.…&quot;   <span class="number">21</span> seconds ago   Up <span class="number">20</span> seconds   <span class="number">80</span><span class="operator">/</span>tcp    nervous_yonath</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看所有容器运行的与没运行的都显示</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps <span class="operator">-</span>a</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS                     PORTS     NAMES</span><br><span class="line"><span class="number">207</span>d1c076699   nginx:<span class="number">1.19</span><span class="number">.7</span>   &quot;/docker-entrypoint.…&quot;   <span class="number">2</span> minutes ago   Up <span class="number">2</span> minutes               <span class="number">80</span><span class="operator">/</span>tcp    hardcore_matsumoto</span><br><span class="line">dfe6d6d768ea   nginx:<span class="number">1.19</span><span class="number">.7</span>   &quot;/docker-entrypoint.…&quot;   <span class="number">2</span> minutes ago   Exited (<span class="number">0</span>) <span class="number">2</span> seconds ago             competent_mccarthy</span><br><span class="line">d9a61935cb5f   nginx:<span class="number">1.19</span><span class="number">.7</span>   &quot;/docker-entrypoint.…&quot;   <span class="number">2</span> minutes ago   Up <span class="number">2</span> minutes               <span class="number">80</span><span class="operator">/</span>tcp    nervous_yonath</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看所有容器只看容器id号</span><br><span class="line">#<span class="operator">-</span>a 显示id   <span class="operator">-</span>q 显示所有记录</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps <span class="operator">-</span>aq</span><br><span class="line"><span class="number">207</span>d1c076699</span><br><span class="line">dfe6d6d768ea</span><br><span class="line">d9a61935cb5f</span><br></pre></td></tr></table></figure><h2 id="5-监控容器性能【资源利用】"><a href="#5-监控容器性能【资源利用】" class="headerlink" title="5.监控容器性能【资源利用】"></a>5.监控容器性能【资源利用】</h2><blockquote><p><code>docker stats</code>命令用于&#x3D;&#x3D;实时显示&#x3D;&#x3D;运行中的 Docker 容器的&#x3D;&#x3D;资源利用情况&#x3D;&#x3D;，包括 CPU 使用率、内存占用、网络 I&#x2F;O 和磁盘 I&#x2F;O 等指标。使用该命令可以方便地监控容器的性能</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker stats <span class="number">0</span>aa</span><br><span class="line">CONTAINER ID   NAME                      CPU <span class="operator">%</span>     MEM USAGE <span class="operator">/</span> LIMIT    MEM <span class="operator">%</span>     NET I<span class="operator">/</span>O     BLOCK I<span class="operator">/</span>O    PIDS</span><br><span class="line"><span class="number">0</span>aa56e969b52   dxnb888.cn_nginx_latest   <span class="number">0.00</span><span class="operator">%</span>     <span class="number">1.973</span>MiB <span class="operator">/</span> <span class="number">3.84</span>GiB   <span class="number">0.05</span><span class="operator">%</span>     <span class="number">656</span>B <span class="operator">/</span> <span class="number">0</span>B   <span class="number">0</span>B <span class="operator">/</span> <span class="number">8.7</span>kB   <span class="number">3</span></span><br></pre></td></tr></table></figure><p><strong>参数解释</strong></p><p>这是<code>docker stats</code>命令的输出结果，它提供了有关正在运行的容器的资源利用信息。下面是对输出中各列的解释：</p><ul><li><code>CONTAINER ID</code>：容器的唯一标识符。</li><li><code>NAME</code>：容器的名称。</li><li><code>CPU %</code>：CPU 使用率，以百分比表示。</li><li><code>MEM USAGE / LIMIT</code>：内存使用量和限制。内存使用量显示容器当前使用的内存量，限制显示容器被允许使用的内存量。</li><li><code>MEM %</code>：内存利用率，以百分比表示。</li><li><code>NET I/O</code>：网络输入&#x2F;输出，显示了容器的网络流量情况。</li><li><code>BLOCK I/O</code>：块输入&#x2F;输出，显示了容器的磁盘 I&#x2F;O 情况。</li><li><code>PIDS</code>：进程 ID 的数量。</li></ul><p>在您提供的输出中，它显示了一个名为<code>dxnb888.cn_nginx_latest</code>的容器的资源利用情况。该容器的 CPU 使用率为0.00%，内存使用量为1.973MiB，占其允许的内存量的0.05%，网络 I&#x2F;O 为656字节，块 I&#x2F;O 为0字节，PIDS 为3。这些信息可以帮助您监视容器的性能，并且可以用来诊断和解决性能问题</p><h2 id="6-查看容器日志【故障排查】"><a href="#6-查看容器日志【故障排查】" class="headerlink" title="6.查看容器日志【故障排查】"></a>6.查看容器日志【故障排查】</h2><blockquote><p><code>docker logs</code>命令用于查看容器的日志输出。通过这个命令，您可以查看容器在运行时输出的日志信息，比如应用程序的输出、错误消息等。这对于故障排除和监视应用程序的运行状态非常有用</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker logs <span class="number">0</span>aa56</span><br><span class="line"><span class="operator">/</span>docker<span class="operator">-</span>entrypoint.sh: <span class="operator">/</span>docker<span class="operator">-</span>entrypoint.d<span class="operator">/</span> 不为空，将尝试执行配置</span><br><span class="line"><span class="operator">/</span>docker<span class="operator">-</span>entrypoint.sh: 在 <span class="operator">/</span>docker<span class="operator">-</span>entrypoint.d<span class="operator">/</span> 中查找 shell 脚本</span><br><span class="line"><span class="operator">/</span>docker<span class="operator">-</span>entrypoint.sh: 启动 <span class="operator">/</span>docker<span class="operator">-</span>entrypoint.d<span class="operator">/</span><span class="number">10</span><span class="operator">-</span>listen<span class="operator">-</span><span class="keyword">on</span><span class="operator">-</span>ipv6<span class="operator">-</span><span class="keyword">by</span><span class="operator">-</span>default.sh</span><br><span class="line"><span class="number">10</span><span class="operator">-</span>listen<span class="operator">-</span><span class="keyword">on</span><span class="operator">-</span>ipv6<span class="operator">-</span><span class="keyword">by</span><span class="operator">-</span>default.sh: info: 获取 <span class="operator">/</span>etc<span class="operator">/</span>nginx<span class="operator">/</span>conf.d<span class="operator">/</span>default.conf 的校验和</span><br><span class="line"><span class="number">10</span><span class="operator">-</span>listen<span class="operator">-</span><span class="keyword">on</span><span class="operator">-</span>ipv6<span class="operator">-</span><span class="keyword">by</span><span class="operator">-</span>default.sh: info: 已启用 IPv6 监听<span class="operator">/</span>etc<span class="operator">/</span>nginx<span class="operator">/</span>conf.d<span class="operator">/</span>default.conf</span><br><span class="line"><span class="operator">/</span>docker<span class="operator">-</span>entrypoint.sh：启动<span class="operator">/</span>docker<span class="operator">-</span>entrypoint.d<span class="operator">/</span><span class="number">20</span><span class="operator">-</span>envsubst<span class="operator">-</span><span class="keyword">on</span><span class="operator">-</span>templates.sh</span><br><span class="line"><span class="operator">/</span>docker<span class="operator">-</span>entrypoint.sh：启动<span class="operator">/</span>docker<span class="operator">-</span>entrypoint.d<span class="operator">/</span><span class="number">30</span><span class="operator">-</span>tune<span class="operator">-</span>worker<span class="operator">-</span>processes.sh</span><br><span class="line"><span class="operator">/</span>docker<span class="operator">-</span>entrypoint.sh：配置完成；准备启动</span><br><span class="line"><span class="number">2024</span><span class="operator">/</span><span class="number">07</span><span class="operator">/</span><span class="number">18</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">09</span> [通知] <span class="number">1</span>#<span class="number">1</span>：使用“epoll”事件方法</span><br><span class="line"><span class="number">2024</span><span class="operator">/</span><span class="number">07</span><span class="operator">/</span><span class="number">18</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">09</span> [通知] <span class="number">1</span>#<span class="number">1</span>：nginx<span class="operator">/</span><span class="number">1.21</span><span class="number">.5</span></span><br><span class="line"><span class="number">2024</span><span class="operator">/</span><span class="number">07</span><span class="operator">/</span><span class="number">18</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">09</span> [通知] <span class="number">1</span>#<span class="number">1</span>：由 gcc <span class="number">10.2</span><span class="number">.1</span> <span class="number">20210110</span>（Debian <span class="number">10.2</span><span class="number">.1</span><span class="number">-6</span>）构建</span><br><span class="line"><span class="number">2024</span><span class="operator">/</span><span class="number">07</span><span class="operator">/</span><span class="number">18</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">09</span> [通知] <span class="number">1</span>#<span class="number">1</span>：操作系统：Linux <span class="number">3.10</span><span class="number">.0</span><span class="number">-1160.</span>el7.x86_64</span><br><span class="line"><span class="number">2024</span><span class="operator">/</span><span class="number">07</span><span class="operator">/</span><span class="number">18</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">09</span> [通知] <span class="number">1</span>#<span class="number">1</span>：getrlimit（RLIMIT_NOFILE）：<span class="number">1048576</span>：<span class="number">1048576</span></span><br><span class="line"><span class="number">2024</span><span class="operator">/</span><span class="number">07</span><span class="operator">/</span><span class="number">18</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">09</span> [通知] <span class="number">1</span>#<span class="number">1</span>：启动工作进程</span><br><span class="line"><span class="number">2024</span><span class="operator">/</span><span class="number">07</span><span class="operator">/</span><span class="number">18</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">09</span> [通知] <span class="number">1</span>#<span class="number">1</span>：启动工作进程 <span class="number">31</span></span><br><span class="line"><span class="number">2024</span><span class="operator">/</span><span class="number">07</span><span class="operator">/</span><span class="number">18</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">09</span> [通知] <span class="number">1</span>#<span class="number">1</span>：启动工作进程 <span class="number">32</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240718202242573.png" alt="image-20240718202242573"></p><h2 id="7-关闭重启容器"><a href="#7-关闭重启容器" class="headerlink" title="7.关闭重启容器"></a>7.关闭重启容器</h2><blockquote><p>基于容器进程的id号或者name名管理容器【镜像名无效】</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>关闭运行的容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                         NAMES</span><br><span class="line"><span class="number">2100</span>f9afab72   redis:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">8</span> minutes ago    Up <span class="number">8</span> minutes    <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">26379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp, :::<span class="number">26379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp   agitated_shaw</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker stop <span class="number">2100</span></span><br><span class="line"><span class="number">2100</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps <span class="operator">-</span>a</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS                        PORTS      NAMES</span><br><span class="line"><span class="number">2100</span>f9afab72   redis:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">8</span> minutes ago    Exited (<span class="number">0</span>) <span class="number">4</span> seconds ago                 agitated_shaw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>启动挂掉的容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">start</span> agitated_shaw</span><br><span class="line">agitated_shaw</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS              PORTS                                         NAMES</span><br><span class="line"><span class="number">2100</span>f9afab72   redis:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">13</span> minutes ago   Up About a <span class="keyword">minute</span>   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">26379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp, :::<span class="number">26379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp   agitated_shaw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>重启运行的容器【重启容器会造成容器内运行的服务重启】</span><br><span class="line">#原容器进程pid</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep redis</span><br><span class="line">polkitd   <span class="number">26551</span>  <span class="number">26531</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">02</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span> redis<span class="operator">-</span>server <span class="operator">*</span>:<span class="number">6379</span></span><br><span class="line">polkitd   <span class="number">27141</span>  <span class="number">27120</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">19</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> redis<span class="operator">-</span>server <span class="operator">*</span>:<span class="number">6379</span></span><br><span class="line">#重启容器进程</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker restart <span class="number">2100</span></span><br><span class="line"><span class="number">2100</span></span><br><span class="line">#新容器进程pid</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep redis</span><br><span class="line">polkitd   <span class="number">26551</span>  <span class="number">26531</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">02</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span> redis<span class="operator">-</span>server <span class="operator">*</span>:<span class="number">6379</span></span><br><span class="line">polkitd   <span class="number">27277</span>  <span class="number">27256</span>  <span class="number">3</span> <span class="number">19</span>:<span class="number">19</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> redis<span class="operator">-</span>server <span class="operator">*</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure><h2 id="8-删除停止容器"><a href="#8-删除停止容器" class="headerlink" title="8.删除停止容器"></a>8.删除停止容器</h2><blockquote><p>这是一个用于删除 Docker 容器的命令，请注意，删除容器将导致容器内的&#x3D;&#x3D;所有数据和文件被永久删除&#x3D;&#x3D;</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#查看运行的容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps </span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS         PORTS                                         NAMES</span><br><span class="line"><span class="number">2100</span>f9afab72   redis:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">23</span> minutes ago   Up <span class="number">8</span> minutes   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">26379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp, :::<span class="number">26379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp   agitated_shaw</span><br><span class="line"></span><br><span class="line">#停止运行的容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker stop <span class="number">2100</span></span><br><span class="line"><span class="number">2100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看所有容器停止的容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps <span class="operator">-</span>a</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS                        PORTS     NAMES</span><br><span class="line"><span class="number">2100</span>f9afab72   redis:latest   &quot;docker-entrypoint.s…&quot;   <span class="number">24</span> minutes ago   Exited (<span class="number">0</span>) <span class="number">8</span> seconds ago                agitated_shaw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除容器【彻底删除了】</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker rm <span class="number">2100</span></span><br><span class="line"><span class="number">2100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看所有容器都没有了</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps <span class="operator">-</span>a</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS                        PORTS     NAMES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#一次性删除所有容器记录</span><br><span class="line">docker rm `docker ps <span class="operator">-</span>qa`</span><br></pre></td></tr></table></figure><h2 id="9-进入运行容器内部"><a href="#9-进入运行容器内部" class="headerlink" title="9.进入运行容器内部"></a>9.进入运行容器内部</h2><blockquote><p><strong>为什么能进入容器开启终端</strong></p><p>容器是基于镜像文件创建的，而镜像文件包含了一个完整的文件系统，其中包括操作系统、库文件、应用程序和其他相关文件。宿主机的内核会在容器内运行，但容器与宿主机共享内核。</p><p>当您在容器内开启终端时，实际上是在容器的文件系统上启动了一个进程，这个进程是在宿主机的内核下运行的。这样，容器内的终端会与宿主机的内核进行交互，并且可以通过 Docker 守护进程进行管理。</p><p>因此，虽然容器利用宿主机的内核运行，但由于容器内有自己的文件系统和应用程序，因此可以在容器内运行终端和其他命令行工具</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#运行一个容器实例</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d <span class="operator">-</span>p <span class="number">36379</span>:<span class="number">6379</span>  redis </span><br><span class="line">ce5a5f654f68d89416c94d7734effc5b91d25ff9f2d8989e063e7d1c6d419e6e</span><br><span class="line"></span><br><span class="line">#查看容器信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED              STATUS              PORTS                                         NAMES</span><br><span class="line">ce5a5f654f68   redis     &quot;docker-entrypoint.s…&quot;   <span class="number">4</span> seconds ago        Up <span class="number">3</span> seconds        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">36379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp, :::<span class="number">36379</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">6379</span><span class="operator">/</span>tcp   confident_saha</span><br><span class="line"></span><br><span class="line">#进入容器开启了终端</span><br><span class="line">#docker <span class="keyword">exec</span>进入容器命令</span><br><span class="line">#<span class="operator">-</span>i开启标准准入 <span class="operator">-</span>t分配终端  <span class="operator">-</span>it允许与终端交互</span><br><span class="line">#<span class="operator">/</span>bin<span class="operator">/</span>bash 进入容器执行的命令</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">exec</span> <span class="operator">-</span>it  ce5  <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line">root<span class="variable">@ce5a5f654f68</span>:<span class="operator">~</span># </span><br><span class="line">root<span class="variable">@ce5a5f654f68</span>:<span class="operator">~</span># </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动容器时就进入容器开启终端</span><br><span class="line">docker run <span class="operator">-</span>it alpine <span class="operator">/</span>bin<span class="operator">/</span>sh</span><br></pre></td></tr></table></figure><h2 id="10-指定容器名运行"><a href="#10-指定容器名运行" class="headerlink" title="10.指定容器名运行"></a>10.指定容器名运行</h2><blockquote><p>在 Docker 中，<code>docker run</code> 命令用于创建和运行一个新的容器。<code>--name</code> 标志允许您为容器指定一个自定义的名称。这对于在容器化应用程序时非常有用，因为它可以让您使用易于识别和管理的名称来标识容器</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#指定容器名称运行容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="comment">--name dxnb888.cn_nginx_test -d -p 880:80  nginx:latest</span></span><br><span class="line"><span class="number">0</span>aa56e969b52b436c86e78e2bf30c0d383571530d4b0a681b621c0ff9d7b72d2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看运行容器信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                                 NAMES</span><br><span class="line"><span class="number">0</span>aa56e969b52   nginx:latest   &quot;/docker-entrypoint.…&quot;   <span class="number">6</span> seconds ago   Up <span class="number">4</span> seconds   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">880</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">880</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp   dxnb888.cn_nginx_latest</span><br></pre></td></tr></table></figure><h2 id="11-查看容器详细信息"><a href="#11-查看容器详细信息" class="headerlink" title="11.查看容器详细信息"></a>11.查看容器详细信息</h2><blockquote><p><code>docker inspect</code>命令用于获取有关 Docker 容器、镜像、网络或卷的详细信息。该命令可用于检索有关特定 Docker 对象的元数据，如配置、网络设置、挂载的卷等等</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#查看容器详细信息</span><br><span class="line">docker inspect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#提取了容器运行的ip地址，通过参数语法提取了json格式字段值</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect <span class="number">0</span>aa  <span class="comment">--format &quot;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&quot;</span></span><br><span class="line"><span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure><h2 id="12-基础镜像运行时必须有前台进程"><a href="#12-基础镜像运行时必须有前台进程" class="headerlink" title="12.基础镜像运行时必须有前台进程"></a>12.基础镜像运行时必须有前台进程</h2><blockquote><p>容器内的进程必须处于前台运行状态，否则容器就会直接退出</p></blockquote><p>在 Docker 中，容器的生命周期是由容器内运行的主进程（也称为前台进程）的生命周期来决定的。当主进程退出时，容器也会随之退出。这是由于 Docker 引擎的设计如此，为了确保容器的稳定和一致性。</p><p>如果没有一个长期运行的主进程，容器就会立即退出，因为 Docker 认为容器的任务已经完成。这就是为什么在容器中运行一个长期运行的命令或进程，如 <code>tail -f /dev/null</code>，可以保持容器处于运行状态而不退出。这个命令会持续运行并占据着容器的进程空间，使得容器保持活跃状态。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#测试只基于发行版镜像运行容器，不加任何容器内执行命令</span><br><span class="line">docker run <span class="operator">-</span>d centos</span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#基础镜像运行容器时加上容器内执行命令</span><br><span class="line">docker run <span class="operator">-</span>d centos tail <span class="operator">-</span>f</span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure><h1 id="docker镜像文件详解"><a href="#docker镜像文件详解" class="headerlink" title="docker镜像文件详解"></a>docker镜像文件详解</h1><blockquote><p>一个完整的Docker镜像可以支撑容器的运行，镜像提供文件系统</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#下载centos系统镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull centos</span><br><span class="line"><span class="keyword">Using</span> <span class="keyword">default</span> tag: latest</span><br><span class="line">latest: Pulling <span class="keyword">from</span> library<span class="operator">/</span>ubuntu</span><br><span class="line"><span class="number">7</span>b1a6ab2e44d: Pull complete </span><br><span class="line">Digest: sha256:<span class="number">626</span>ffe58f6e7566e00254b638eb7e0f3b11d4da9675088f4781a50ae288f3322</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> ubuntu:latest</span><br><span class="line">docker.io<span class="operator">/</span>library<span class="operator">/</span>ubuntu:latest</span><br></pre></td></tr></table></figure><h2 id="1-内核与发行版"><a href="#1-内核与发行版" class="headerlink" title="1.内核与发行版"></a>1.内核与发行版</h2><blockquote><p>传统的虚拟机安装操作系统所提供的系统镜像，包含两部分，内核+发行版</p></blockquote><p><strong>Linux内核部分</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#uname <span class="operator">-</span>r</span><br><span class="line"><span class="number">3.10</span><span class="number">.0</span><span class="number">-862.</span>el7.x86_64</span><br></pre></td></tr></table></figure><p><strong>系统发行版部分</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>os<span class="operator">-</span><span class="keyword">release</span> </span><br><span class="line">NAME<span class="operator">=</span>&quot;CentOS Linux&quot;</span><br><span class="line">VERSION<span class="operator">=</span>&quot;7 (Core)&quot;</span><br><span class="line">ID<span class="operator">=</span>&quot;centos&quot;</span><br><span class="line">ID_LIKE<span class="operator">=</span>&quot;rhel fedora&quot;</span><br><span class="line">VERSION_ID<span class="operator">=</span>&quot;7&quot;</span><br><span class="line">PRETTY_NAME<span class="operator">=</span>&quot;CentOS Linux 7 (Core)&quot;</span><br><span class="line">ANSI_COLOR<span class="operator">=</span>&quot;0;31&quot;</span><br><span class="line">CPE_NAME<span class="operator">=</span>&quot;cpe:/o:centos:centos:7&quot;</span><br><span class="line">HOME_URL<span class="operator">=</span>&quot;https://www.centos.org/&quot;</span><br><span class="line">BUG_REPORT_URL<span class="operator">=</span>&quot;https://bugs.centos.org/&quot;</span><br><span class="line"></span><br><span class="line">CENTOS_MANTISBT_PROJECT<span class="operator">=</span>&quot;CentOS-7&quot;</span><br><span class="line">CENTOS_MANTISBT_PROJECT_VERSION<span class="operator">=</span>&quot;7&quot;</span><br><span class="line">REDHAT_SUPPORT_PRODUCT<span class="operator">=</span>&quot;centos&quot;</span><br><span class="line">REDHAT_SUPPORT_PRODUCT_VERSION<span class="operator">=</span>&quot;7&quot;</span><br></pre></td></tr></table></figure><p><strong>docker镜像是不包含内核的，只是下载了某个发行版部分</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>查看刚才运行的容器实例</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                   NAMES</span><br><span class="line">bfff8ff41c7a   nginx:<span class="number">1.19</span><span class="number">.7</span>   &quot;/docker-entrypoint.…&quot;   <span class="number">26</span> minutes ago   Up <span class="number">26</span> minutes   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8080</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">8080</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp   infallible_hellman</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>查看容器发行版与宿主机发行版，发行版不同</span><br><span class="line">#容器发行版是debian10</span><br><span class="line">#docker <span class="keyword">exec</span>（与运行中的容器执行交互式的命令），<span class="operator">-</span>it（打开了一个交互式的 Bash 终端）</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">exec</span> <span class="operator">-</span>it bff bash</span><br><span class="line">root<span class="variable">@bfff8ff41c7a</span>:<span class="operator">/</span># cat <span class="operator">/</span>etc<span class="operator">/</span>os<span class="operator">-</span><span class="keyword">release</span> </span><br><span class="line">PRETTY_NAME<span class="operator">=</span>&quot;Debian GNU/Linux 10 (buster)&quot;</span><br><span class="line">NAME<span class="operator">=</span>&quot;Debian GNU/Linux&quot;</span><br><span class="line">VERSION_ID<span class="operator">=</span>&quot;10&quot;</span><br><span class="line">VERSION<span class="operator">=</span>&quot;10 (buster)&quot;</span><br><span class="line">VERSION_CODENAME<span class="operator">=</span>buster</span><br><span class="line">ID<span class="operator">=</span>debian</span><br><span class="line">#宿主机发行版是centos7</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>os<span class="operator">-</span><span class="keyword">release</span> </span><br><span class="line">NAME<span class="operator">=</span>&quot;CentOS Linux&quot;</span><br><span class="line">VERSION<span class="operator">=</span>&quot;7 (Core)&quot;</span><br><span class="line">ID<span class="operator">=</span>&quot;centos&quot;</span><br><span class="line">ID_LIKE<span class="operator">=</span>&quot;rhel fedora&quot;</span><br><span class="line">VERSION_ID<span class="operator">=</span>&quot;7&quot;</span><br><span class="line">PRETTY_NAME<span class="operator">=</span>&quot;CentOS Linux 7 (Core)&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>查看容器的内核信息，对比宿主机内核信息，相同的内核信息，容器调用了宿主机的内核</span><br><span class="line">#容器</span><br><span class="line">root<span class="variable">@132aa58824a6</span>:<span class="operator">/</span># cat <span class="operator">/</span>proc<span class="operator">/</span>version </span><br><span class="line">Linux version <span class="number">3.10</span><span class="number">.0</span><span class="number">-862.</span>el7.x86_64 (builder<span class="variable">@kbuilder</span>.dev.centos.org) (gcc version <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-28</span>) (GCC) ) #<span class="number">1</span> SMP Fri Apr <span class="number">20</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">24</span> UTC <span class="number">2018</span></span><br><span class="line">root<span class="variable">@132aa58824a6</span>:<span class="operator">/</span># </span><br><span class="line">root<span class="variable">@132aa58824a6</span>:<span class="operator">/</span># exit</span><br><span class="line">exit</span><br><span class="line">#宿主机</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#cat <span class="operator">/</span>proc<span class="operator">/</span>version </span><br><span class="line">Linux version <span class="number">3.10</span><span class="number">.0</span><span class="number">-862.</span>el7.x86_64 (builder<span class="variable">@kbuilder</span>.dev.centos.org) (gcc version <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-28</span>) (GCC) ) #<span class="number">1</span> SMP Fri Apr <span class="number">20</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">24</span> UTC <span class="number">2018</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure><blockquote><p>小结：容器中的服务运行，是基于下载的发行版+宿主机本身内核+运行环境【依赖，文件，配置】</p></blockquote><p>&#x2F;proc文件系统，它不是普通的文件系统，而是系统内核的映像，也就是说，该目录中的文件是存放在系统内存之中的，它以文件系统的方式为访问系统内核数据的操作提供接口。而我们使用命令“uname -a”的信息就是从该文件获取的，当然用方法二的命令直接查看它的内容也可以达到同等效果.另外，加上参数”a”是获得详细信息，如果不加参数为查看系统名称。</p><h2 id="2-容器镜像定义"><a href="#2-容器镜像定义" class="headerlink" title="2.容器镜像定义"></a>2.容器镜像定义</h2><blockquote><p>在Docker中，镜像是通过一层一层的添加来构建的，每一层都是对前一层的修改和增量。这种层级结构使得镜像可以高效地共享和重复使用已有的层，从而节省存储空间和加快镜像的构建和传输速度。</p><ul><li>获取基础镜像：选择一个适合的发行版平台，比如Ubuntu或CentOS，在这个基础上构建MySQL 5.6镜像。</li><li>在CentOS镜像中安装MySQL 5.6软件：通过Dockerfile文件或者交互式命令行方式，在CentOS基础镜像中安装MySQL 5.6及其所需的依赖库和配置。</li><li>导出镜像：将构建完成的MySQL 5.6镜像导出为镜像文件，并可以根据需要命名为mysql:5.6镜像。</li></ul><p>这样构建的MySQL 5.6镜像中，CentOS镜像层就是父镜像，MySQL 5.6镜像层则是基于CentOS镜像层构建而成的子镜像层。这种镜像的层级结构使得我们可以更加灵活地管理和共享镜像，同时也能更高效地利用镜像的存储空间。</p></blockquote><p><img src="/image-20240718143237488.png" alt="image-20240718143237488"></p><h2 id="3-镜像文件概述"><a href="#3-镜像文件概述" class="headerlink" title="3.镜像文件概述"></a>3.镜像文件概述</h2><blockquote><p>其实就是将业务代码运行的环境，整体打包为单个的文件【虽然Docker镜像可以看作是一个文件，但实际上它是一个可以被Docker引擎操作和管理的软件包（包含了应用程序运行所需的所有内容）】，就是docker镜像</p></blockquote><p>Docker镜像是用于构建和运行容器的轻量级、可移植的&#x3D;&#x3D;软件包&#x3D;&#x3D;。它&#x3D;&#x3D;包含了运行应用程序所需的所有内容&#x3D;&#x3D;：&#x3D;&#x3D;程序代码&#x3D;&#x3D;、运行时（指的是应用程序在运行时所需的环境和支持）、系统工具、系统库以及设置。Docker镜像可以被快速地部署和复制到各种环境中，而无需担心环境差异性导致的问题。</p><p>Docker镜像是以分层的方式构建的，每一层都包含了文件系统的一部分，使得镜像可以高效地共享和重复使用。当运行一个容器时，Docker引擎会基于这些层级关系来创建一个可写的容器层，该层包含了应用程序运行时所需的文件和设置。</p><hr><p>每一层Docker镜像都包含了文件系统的一部分，这是指在构建Docker镜像时，每一层都会包含一组文件和目录。当构建一个新的镜像时，Docker引擎会根据构建指令将这些文件和目录添加到镜像中，形成一层新的文件系统。这些文件和目录可以包括应用程序的代码、运行时文件、系统库、配置文件等。</p><p>由于每一层都是基于前一层进行构建的，因此每一层都只包含了修改和增量的内容。这种分层的设计使得Docker镜像可以高效地共享和重复使用，因为多个镜像可以共享相同的基础层，从而节省存储空间，并且可以更加灵活地管理镜像的构建和更新。</p><h2 id="4-创建镜像文件"><a href="#4-创建镜像文件" class="headerlink" title="4.创建镜像文件"></a>4.创建镜像文件</h2><ol><li>创建一个Dockerfile：Dockerfile是一个文本文件，其中包含了一系列指令，用于描述如何构建Docker镜像。在Dockerfile中，你可以指定基础镜像、安装软件包、复制文件等操作。</li><li>编写Dockerfile：编写Dockerfile时，你需要定义基于哪个基础镜像构建，以及在镜像中需要安装哪些软件、设置哪些环境变量、复制哪些文件等。</li><li>构建Docker镜像：在Dockerfile所在的目录中，使用<code>docker build</code>命令来构建Docker镜像，命令格式为<code>docker build -t &lt;镜像名&gt;:&lt;标签&gt; .</code>，其中<code>-t</code>用于指定镜像名和标签，<code>.</code>表示Dockerfile所在的当前目录。</li><li>运行容器：构建完成后，你可以使用<code>docker run</code>命令来基于新创建的镜像运行容器，命令格式为<code>docker run -d &lt;镜像名&gt;</code>。</li></ol><blockquote><p>现在docker官方共有仓库里面有大量的镜像，所以最基础的镜像，我们可以在公有仓库直接拉取，因为这些镜像都是原厂维护，可以得到即使的更新和修护</p></blockquote><p><strong>dockerfile</strong></p><p>Dockerfile是一种文本文件，它包含了一系列的指令和配置，用来定义如何构建一个Docker镜像。通过编写Dockerfile，你可以明确地描述镜像中应该包含哪些文件、环境变量、依赖项和其他配置。这个文件允许你自动化地构建镜像，确保在不同环境和不同机器上复制相同的软件运行环境。</p><p>一个基本的Dockerfile通常包括以下内容：</p><ol><li>基础镜像：指定用作基础的镜像，比如Ubuntu、CentOS等。</li><li>维护者信息：可选项，用来指定Dockerfile的作者和联系方式。</li><li>指令：包括诸如<code>RUN</code>、<code>COPY</code>、<code>ADD</code>等用来构建镜像的指令。</li><li>环境变量：设置容器运行时的环境变量。</li><li>暴露端口：指定容器运行时需要暴露的端口。</li><li>其他配置：如工作目录、入口点等。</li></ol><p>通过编写Dockerfile，你可以轻松地重复和分享你的应用程序的构建和运行环境。一旦Dockerfile定义好了，你可以使用<code>docker build</code>命令来构建镜像，然后将其部署到Docker容器中运行。这种方式相比手动构建和配置镜像来说更加高效、可靠，并且便于版本控制和团队协作</p><p><img src="/image-20240718161506993.png" alt="image-20240718161506993"></p><p><strong>docker_commit</strong></p><p>当<code>docker commit</code>命令用于将正在运行的容器保存为新的镜像。通过这个命令，你可以在容器运行的基础上进行修改，然后将修改后的容器保存为一个新的镜像。这在一些特定的场景下可能会有用，比如你需要快速创建一个临时镜像来进行测试或调试。</p><p>使用<code>docker commit</code>命令时，你需要指定要提交的容器的ID或名称，以及新镜像的名称和标签。需要注意的是，使用<code>docker commit</code>命令创建的镜像通常不是最佳实践，因为它可能会丢失一些Dockerfile中定义的元数据和历史记录。因此，建议优先使用Dockerfile来构建镜像。</p><p>总的来说，<code>docker commit</code>命令可以用作临时的快速创建镜像的工具，但在生产环境中，最好还是通过Dockerfile来定义和构建镜像。。</p><h2 id="4-镜像分层结构"><a href="#4-镜像分层结构" class="headerlink" title="4.镜像分层结构"></a>4.镜像分层结构</h2><blockquote><p><code>docker history</code>命令用于显示指定镜像的历史记录，即显示创建该镜像时所执行的每个步骤和指令。这包括了镜像的层级结构、每一层的大小、创建时间、以及对应的Dockerfile中的指令。</p><p>通过运行<code>docker history</code>命令，你可以了解一个镜像是如何构建的，每一步都做了什么修改，以及每个修改对镜像大小的影响。这对于优化镜像大小、理解镜像的构建过程以及排查问题都非常有帮助</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history nginx:<span class="number">1.17</span><span class="number">.9</span> </span><br><span class="line">IMAGE          CREATED       CREATED <span class="keyword">BY</span>                                      SIZE      COMMENT</span><br><span class="line"><span class="number">5</span>a8dfb2ca731   <span class="number">2</span> years ago   <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon…   0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  STOPSIGNAL SIGTERM           0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  EXPOSE 80                    0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c ln -sf /dev/stdout /var/log/nginx…   22B       </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c set -x     &amp;&amp; addgroup --system -…   57.6MB    </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  ENV NJS_VERSION=0.3.9        0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  ENV NGINX_VERSION=1.17.9     0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  LABEL maintainer=NGINX Do…   0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B        </span><br><span class="line">&lt;missing&gt;      2 years ago   /bin/sh -c #(nop) ADD file:865f9041e12eb341f…   69.2MB</span><br></pre></td></tr></table></figure><p><strong>命令查看镜像的分层关系</strong></p><p><img src="/image-20240718161718849.png" alt="image-20240718161718849"></p><hr><p><img src="/image-20240718162322427.png" alt="image-20240718162322427"></p><p><strong>Base基础镜像</strong></p><blockquote><p>常见的基础镜像包括Ubuntu、Alpine、CentOS等发行版的基础镜像</p></blockquote><p>在Dockerfile中，”base镜像”通常指的是作为构建镜像的起点的基础镜像。基础镜像是构建其他镜像的起点，它包含了操作系统和基本的软件包，供其他镜像进行扩展和定制。当你构建一个新的镜像时，你可以选择一个现有的基础镜像作为起点，然后在其上添加、修改或定制你需要的软件和配置。</p><p><strong>aline发行版</strong></p><blockquote><p>轻量级的linux发行版，体积小几mb，更适合构建dockerfile</p></blockquote><p>Alpine Linux是一个轻量级的Linux发行版，专注于提供简单、高效和安全的操作系统环境。它采用了musl libc和BusyBox（轻量级的软件集合），并且使用了apk包管理工具。Alpine Linux通常被广泛用于构建容器化应用程序、嵌入式系统和虚拟机环境。</p><p>Alpine Linux的一个显著特点是其非常小巧的镜像大小，这使其在容器化环境中具有很高的受欢迎度。其安全性也备受赞誉，因为它的开发人员积极地关注和修复潜在的安全漏洞</p><p><strong>musl libc</strong></p><p>musl libc是一个轻量级的C标准库，专为嵌入式系统和轻量级Linux发行版而设计。与传统的glibc（GNU C库）相比，musl libc的特点是更小、更快、更简洁，同时也更注重代码的清晰性和可移植性。</p><p>musl libc采用了一种替代的设计方法，以使其尽可能地遵循POSIX标准，并且在代码的安全性和可靠性方面进行了优化。它的小巧和高效性使得它在嵌入式系统和一些对资源消耗要求较高的环境中非常受欢迎。</p><p>许多轻量级的Linux发行版，如Alpine Linux等，都采用了musl libc作为其标准C库。这些发行版通常以小巧、高效和安全著称，而musl libc是它们能够实现这些特点的重要组成部分之一。</p><p><strong>busybox</strong></p><p>BusyBox是一个轻量级的软件集合，它封装了许多常见的Unix工具和命令，如sh、ls、grep等，这些工具和命令通常用于在Linux系统上进行命令行操作。BusyBox的设计目标是将许多常见的Unix工具打包到一个单一的可执行文件中，以节省空间和资源，并且可以在嵌入式系统和资源受限的环境中使用。BusyBox通常被用于嵌入式系统、嵌入式设备、路由器、手机等资源受限的环境中，以提供基本的命令行工具和功能。</p><p>在容器领域，BusyBox也常被用作基础镜像，用于构建轻量级的容器。由于BusyBox的小巧和高效，它可以帮助减小镜像的体积，并且提供了一些基本的Unix命令和工具，使得容器可以在精简的环境中运行。因此，BusyBox在容器化应用中具有一定的地位和作用。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#搜索alpine镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">search</span>  alpine</span><br><span class="line">NAME                                    DESCRIPTION                                     STARS     OFFICIAL</span><br><span class="line">alpine                                  A minimal Docker image based <span class="keyword">on</span> Alpine Linux…   <span class="number">10922</span>     [OK]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下载最新版</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull alpine</span><br><span class="line"><span class="keyword">Using</span> <span class="keyword">default</span> tag: latest</span><br><span class="line">latest: Pulling <span class="keyword">from</span> library<span class="operator">/</span>alpine</span><br><span class="line"><span class="number">59</span>bf1c3509f3: Pull complete </span><br><span class="line">Digest: sha256:<span class="number">21</span>a3deaa0d32a8057914f36584b5288d2e5ecc984380bc0118285c70fa8c9300</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> alpine:latest</span><br><span class="line">docker.io<span class="operator">/</span>library<span class="operator">/</span>alpine:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看镜像文件体积证明alpine体积很小</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">nginx        latest    <span class="number">605</span>c77e624dd   <span class="number">2</span> years ago   <span class="number">141</span>MB</span><br><span class="line">redis        latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago   <span class="number">113</span>MB</span><br><span class="line">alpine       latest    c059bfaa849c   <span class="number">2</span> years ago   <span class="number">5.59</span>MB</span><br><span class="line">nginx        <span class="number">1.19</span><span class="number">.7</span>    <span class="number">35</span>c43ace9216   <span class="number">3</span> years ago   <span class="number">133</span>MB</span><br><span class="line">mysql        <span class="number">5.7</span><span class="number">.25</span>    <span class="number">98455</span>b9624a9   <span class="number">5</span> years ago   <span class="number">372</span>MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#运行apline发行版镜像容器，进入容器查看操作系统信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>it alpine <span class="operator">/</span>bin<span class="operator">/</span>sh</span><br><span class="line"><span class="operator">/</span> # cat <span class="operator">/</span>etc<span class="operator">/</span>os<span class="operator">-</span><span class="keyword">release</span> </span><br><span class="line">NAME<span class="operator">=</span>&quot;Alpine Linux&quot;</span><br><span class="line">ID<span class="operator">=</span>alpine</span><br><span class="line">VERSION_ID<span class="operator">=</span><span class="number">3.15</span><span class="number">.0</span></span><br><span class="line">PRETTY_NAME<span class="operator">=</span>&quot;Alpine Linux v3.15&quot;</span><br><span class="line">HOME_URL<span class="operator">=</span>&quot;https://alpinelinux.org/&quot;</span><br><span class="line">BUG_REPORT_URL<span class="operator">=</span>&quot;https://bugs.alpinelinux.org/&quot;</span><br></pre></td></tr></table></figure><p><strong>docker run -it alpine &#x2F;bin&#x2F;sh命令解释</strong></p><p>这条命令的意思是在 Docker 中运行一个名为 Alpine 的基础镜像，并且使用交互模式（interactive mode）启动一个 shell 终端。</p><p>在这个命令中：</p><ul><li><code>docker run</code> 是用来启动一个容器的命令。</li><li><code>-it</code> 参数结合了两个标记，<code>-i</code> 表示交互式操作，<code>-t</code> 表示分配一个终端（tty）。</li><li><code>alpine</code> 是要运行的容器的名称，这里指定了使用 Alpine Linux 这个基础镜像。</li><li><code>/bin/sh</code> 指定了要在容器中运行的命令，这里是启动一个 shell 终端。</li></ul><p>运行这个命令后，你将进入一个交互式的 shell 终端，里面你可以在 Alpine 容器中执行命令。当你退出这个容器的终端时，容器也会停止运行。</p><p><strong>镜像分层的作用</strong></p><p>镜像分层的作用主要体现在以下几个方面：</p><ol><li>节省存储空间：镜像分层结构中的每个层都是只读的，并且可以被多个镜像共享和重用。这意味着相同的文件只需要存储一次，可以被多个镜像引用，从而减少了存储空间的占用。</li><li>增量更新：当对镜像进行修改或更新时，只需要新增或修改相应的层，而不需要重新构建整个镜像。这种增量更新的方式可以提高镜像的构建速度和效率。</li><li>快速部署：由于镜像分层结构的特性，当启动一个容器时，Docker 只需要将各层联合挂载在一起，而不需要复制整个文件系统。这样可以快速启动容器，并且节省了存储和网络带宽。</li><li>版本控制：镜像分层结构使得镜像的不同版本之间可以共享相同的层，只需要新增或修改相关的层即可。这样可以更方便地管理和维护不同版本的镜像。</li></ol><p>总的来说，镜像分层的作用在于提高了镜像的效率、灵活性和可维护性，同时也有利于节省存储空间和加快容器的部署速度。这些特性使得容器技术在开发、测试和部署过程中更加高效和便捷</p><blockquote><p>即使多个容器共享一个base镜像，某个容器修改了base镜像的内容，例如修改&#x2F;etc&#x2F;下配置文件，其他容器的&#x2F;etc&#x2F;下内容是不会被修改的，修改动作只限制在单个容器内，这就是容器的写入时复制特性（Copy-on-write）。</p></blockquote><p><img src="/image-20240718170243456.png" alt="image-20240718170243456"></p><p><strong>联合文件系统</strong></p><p>在容器技术中，镜像多层是通过联合文件系统（Union File System）技术来实现的。联合文件系统是一种将多个文件系统合并为单个文件系统的方法，它允许将不同层的文件系统叠加在一起，形成一个统一的视图。</p><p>常见的联合文件系统包括 OverlayFS、AUFS（Another Union File System）、btrfs 等。这些联合文件系统技术允许将不同层的文件系统以只读方式叠加在一起，同时使得文件系统的修改操作能够在只读层之上创建新的可写层。</p><p>当容器启动时，这些层会被联合挂载在一起，形成一个完整的文件系统视图，从而实现了镜像多层的效果。这种技术使得镜像的构建和管理变得更加灵活和高效。</p><p><img src="/image-20240718170742104.png" alt="image-20240718170742104"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#下载镜像是会一层层下载</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull mysql:<span class="number">5.7</span></span><br><span class="line"><span class="number">5.7</span>: Pulling <span class="keyword">from</span> library<span class="operator">/</span>mysql</span><br><span class="line"><span class="number">72</span>a69066d2fe: Pull complete </span><br><span class="line"><span class="number">93619</span>dbc5b36: Pull complete </span><br><span class="line"><span class="number">99</span>da31dd6142: Pull complete </span><br><span class="line"><span class="number">626033</span>c43d70: Pull complete </span><br><span class="line"><span class="number">37</span>d5d7efb64e: Pull complete </span><br><span class="line">ac563158d721: Pull complete </span><br><span class="line">d2ba16033dad: Pull complete </span><br><span class="line"><span class="number">0</span>ceb82207cd7: Pull complete </span><br><span class="line"><span class="number">37</span>f2405cae96: Pull complete </span><br><span class="line">e2482e017e53: Pull complete </span><br><span class="line"><span class="number">70</span>deed891d42: Pull complete </span><br><span class="line">Digest: sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> mysql:<span class="number">5.7</span></span><br><span class="line">docker.io<span class="operator">/</span>library<span class="operator">/</span>mysql:<span class="number">5.7</span></span><br></pre></td></tr></table></figure><h2 id="5-镜像与容器工作原理"><a href="#5-镜像与容器工作原理" class="headerlink" title="5.镜像与容器工作原理"></a>5.镜像与容器工作原理</h2><p>镜像和容器是现代应用部署和管理中的核心概念，特别是在使用 Docker 等容器化平台时。它们各自有不同的作用和工作原理，但又紧密相关。以下是它们的详细解释：</p><blockquote><p><strong>镜像（Image）</strong></p></blockquote><p><strong>定义</strong></p><ul><li>镜像是一个轻量级、可执行的独立软件包，包含运行某个应用程序所需的所有代码、运行时环境、库、环境变量和配置文件。它是容器的蓝图。</li></ul><p><strong>工作原理</strong></p><ol><li><strong>创建</strong>：<ul><li>镜像通常通过编写一个 <code>Dockerfile</code> 文件来创建。<code>Dockerfile</code> 是一个文本文件，定义了如何从基础镜像（如 <code>ubuntu</code>、<code>alpine</code> 等）构建新的镜像，包括添加文件、安装软件、设置环境变量等步骤。</li></ul></li><li><strong>构建</strong>：<ul><li>通过 Docker CLI（如 <code>docker build</code> 命令）根据 <code>Dockerfile</code> 构建镜像。Docker 引擎根据 <code>Dockerfile</code> 中的指令逐步构建镜像。</li></ul></li><li><strong>存储</strong>：<ul><li>镜像被存储在 Docker 镜像仓库中（如 Docker Hub 或私有仓库）。这些仓库可以是公共的或私有的，用于分发和共享镜像。</li></ul></li><li><strong>分层结构</strong>：<ul><li>镜像采用分层结构，每一层都是对上一层的增量修改。这样的设计使得镜像可以复用和共享，减少存储空间的占用。</li></ul></li></ol><blockquote><p><strong>容器（Container）</strong></p></blockquote><p><strong>定义</strong></p><ul><li>容器是一个运行中的镜像实例，它包含镜像中的应用程序和运行环境。容器是轻量级的、隔离的，可以在不同的环境中运行而不会影响主机系统。</li></ul><p><strong>工作原理</strong></p><ol><li><strong>运行</strong>：<ul><li>当你运行一个镜像时，Docker 引擎会创建一个容器实例。容器在启动时会使用镜像中的文件系统，并将镜像中的内容与容器内的文件系统进行组合。</li></ul></li><li><strong>隔离</strong>：<ul><li>容器提供进程隔离，使用操作系统级别的虚拟化技术，如 Linux 的命名空间（namespace）和控制组（cgroup），确保容器中的进程和资源与其他容器和主机系统隔离。</li></ul></li><li><strong>可写层</strong>：<ul><li>在容器中运行时，所有对文件系统的修改都发生在一个可写层上，而镜像的原始内容保持不变。这个可写层允许容器在运行时对数据进行读写操作。</li></ul></li><li><strong>启动和停止</strong>：<ul><li>启动一个容器时，Docker 引擎从镜像中提取文件系统的内容，并在该文件系统上运行应用程序。容器可以随时启动和停止，并在停止后保留其状态，以便以后可以恢复或删除。</li></ul></li><li><strong>资源管理</strong>：<ul><li>容器使用操作系统的资源管理功能（如 CPU、内存、存储）来限制和分配资源，确保不同容器之间的资源使用不会相互干扰。</li></ul></li></ol><blockquote><p><strong>镜像与容器的关系</strong></p></blockquote><ul><li><strong>镜像是容器的模板</strong>：<ul><li>镜像定义了容器的初始状态和环境，而容器则是镜像的运行实例。镜像是静态的，只读的；容器是动态的、可写的。</li></ul></li><li><strong>容器从镜像创建</strong>：<ul><li>每次运行一个容器时，Docker 引擎都会从指定的镜像创建一个新的容器实例。容器将使用镜像中的文件系统，并在此基础上进行操作。</li></ul></li><li><strong>镜像的层级结构</strong>：<ul><li>镜像的分层结构允许多个容器共享相同的基础镜像层，从而减少存储和网络带宽的消耗。</li></ul></li></ul><blockquote><p><strong>总结</strong></p></blockquote><ul><li><strong>镜像</strong> 是一个包含应用程序及其依赖的只读模板。</li><li><strong>容器</strong> 是镜像的可执行实例，提供隔离和轻量级的环境来运行应用程序。</li></ul><p>这种分离和封装的方式使得开发、测试和生产环境中的应用程序更加一致和可靠，也提高了资源利用率和管理效率。如果你有任何特定的疑问或需要进一步深入了解，请告诉我</p><p><img src="/1662000896363-1721478481890-1.png" alt="1662000896363"></p><h1 id="docker数据目录结构"><a href="#docker数据目录结构" class="headerlink" title="docker数据目录结构"></a>docker数据目录结构</h1><h2 id="1-数据根目录"><a href="#1-数据根目录" class="headerlink" title="1.数据根目录"></a>1.数据根目录</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#查看docker数据根目录存储位置</span><br><span class="line">root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker info <span class="operator">|</span>grep <span class="operator">-</span>i <span class="string">&#x27;root dir&#x27;</span></span><br><span class="line"> Docker Root Dir: <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#根目录下存储结构</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ll <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker</span><br><span class="line">total <span class="number">16</span></span><br><span class="line">drwx<span class="comment">--x--x.  4 root root  138 Jul 17 21:07 buildkit</span></span><br><span class="line">drwx<span class="comment">--x---. 11 root root 4096 Jul 18 16:37 containers</span></span><br><span class="line"><span class="operator">-</span>rw<span class="comment">-------.  1 root root   36 Jul 17 21:07 engine-id</span></span><br><span class="line">drwx<span class="comment">------.  3 root root   22 Jul 17 21:07 image</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---.  3 root root   19 Jul 17 21:07 network</span></span><br><span class="line">drwx<span class="comment">--x---. 50 root root 4096 Jul 18 16:37 overlay2</span></span><br><span class="line">drwx<span class="comment">------.  4 root root   32 Jul 17 21:07 plugins</span></span><br><span class="line">drwx<span class="comment">------.  2 root root    6 Jul 17 21:17 runtimes</span></span><br><span class="line">drwx<span class="comment">------.  2 root root    6 Jul 17 21:07 swarm</span></span><br><span class="line">drwx<span class="comment">------.  2 root root    6 Jul 18 16:31 tmp</span></span><br><span class="line">drwx<span class="comment">-----x.  2 root root   50 Jul 17 21:17 volumes</span></span><br></pre></td></tr></table></figure><p><strong>docker数据根目录下的存储结构</strong></p><p>buildkit：用于存储Docker BuildKit的相关数据，包括构建过程中使用的缓存和临时文件。</p><p>containers：存储Docker容器的相关信息，每个容器在该目录下都有对应的子目录，包括它们的运行时状态、日志等。</p><p>engine-id：包含了Docker引擎的唯一标识符，用于唯一标识当前Docker引擎实例。</p><p>image：存储Docker镜像的地方，每个镜像在该目录下都有对应的子目录。</p><p>network：包含了Docker网络的相关数据，包括网络配置和状态等。</p><p>overlay2：是Docker默认的存储驱动程序，用于存储镜像和容器的文件系统。</p><p>plugins：存储Docker插件的位置，用于扩展Docker功能或提供额外的功能。</p><p>runtimes：存储Docker运行时的相关数据，包括容器运行时等。</p><p>swarm：如果使用Docker Swarm进行容器编排，该目录存储了Swarm的相关数据。</p><p>tmp：用于存储临时文件的目录。</p><p>volumes：包含Docker卷的相关信息，每个卷在该目录下都有对应的子目录。</p><p>总的来说，这些目录包含了Docker守护进程运行时所需的各种数据，包括容器、镜像、网络、插件等。</p><h2 id="2-存储引擎目录"><a href="#2-存储引擎目录" class="headerlink" title="2.存储引擎目录"></a>2.存储引擎目录</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#查看存储引擎目录路径</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker info <span class="operator">|</span>grep <span class="operator">-</span>i <span class="string">&#x27;storage&#x27;</span></span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#查看目录磁盘使用情况</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#du <span class="operator">-</span>sh <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>overlay2<span class="operator">/</span></span><br><span class="line"><span class="number">1.4</span>G<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>overlay2<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看存储目录下的图层目录</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ls  <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>overlay2<span class="operator">/</span></span><br><span class="line"><span class="number">0022</span>eb0cb78189d791e3b3edb9d397be5e64028a357c065a6b9cb4d6bc6b2a25</span><br><span class="line"><span class="number">08</span>f00f956552f8fad00ca19c86fdb043cae096fb3a04b05692baeb93853dc3ea</span><br><span class="line"><span class="number">08</span>f00f956552f8fad00ca19c86fdb043cae096fb3a04b05692baeb93853dc3ea<span class="operator">-</span>init</span><br><span class="line"><span class="number">0</span>b0c2b4e8bd9af265d7d3b967be7f754dd24028f913c0a02f4ab0056cfd2998e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#图层目录下的子目录</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ls  <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>overlay2<span class="operator">/</span><span class="number">55</span>f7b125d3e65b19611b467399b03d555bf5cb15666dbb8e3cee053bee7b68e</span><br><span class="line">committed  diff  link  lower  work</span><br></pre></td></tr></table></figure><p><strong>图层目录是什么</strong></p><p>在Docker中，图层目录是指由镜像的多个层(layer)组成的结构，每个层都包含了文件系统的一部分。当你构建一个新的镜像时，Docker会使用这些层来创建一个新的文件系统。每个层都代表了对文件系统的一系列修改，比如添加、删除或修改文件。</p><p>这些层以一种类似于链表的方式连接在一起，形成了一个图层结构。当你启动一个容器时，Docker会将这些层叠加在一起，形成一个完整的文件系统视图，从而创建了一个可运行的容器。</p><p>图层目录的概念使得Docker镜像的构建和管理变得非常高效，因为它们可以共享相同的基础层，减少了重复的存储和提高了镜像的复用性。</p><p><strong>图层目录下子目录结构</strong></p><p>committed：该子目录包含已经提交（committed）的更改，也就是已经被保存为新的镜像的更改。</p><p>diff：这个目录包含了当前的更改，也就是容器的当前状态。</p><p>link：这个目录包含了链接信息。</p><p>lower：这个目录包含了底层的只读文件系统。</p><p>work：这个目录包含了正在进行的更改。</p><p>每个子目录都是overlay2图层文件系统的一部分，它们一起构成了一个完整的文件系统。这种分层的方式使得Docker可以高效地管理镜像和容器的文件系统，并且可以节省存储空间。</p><h1 id="docker镜像实践操作"><a href="#docker镜像实践操作" class="headerlink" title="docker镜像实践操作"></a>docker镜像实践操作</h1><h2 id="1-下载获取镜像"><a href="#1-下载获取镜像" class="headerlink" title="1.下载获取镜像"></a>1.下载获取镜像</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>下载</span><br><span class="line">[root<span class="variable">@docker01</span> <span class="operator">~</span>]# docker pull centos            #默认标签tag是centos:latest</span><br><span class="line">[root<span class="variable">@docker01</span> <span class="operator">~</span>]# docker pull  centos:<span class="number">7.2</span><span class="number">.1511</span>  #指定版本下载</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>查看本地下载的所有镜像</span><br><span class="line">[root<span class="variable">@docker01</span> <span class="operator">~</span>]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">nginx               latest              <span class="number">4</span>bb46517cac3        <span class="number">3</span> weeks ago         <span class="number">133</span>MB</span><br><span class="line">centos              latest              <span class="number">0</span>d120b6ccaa8        <span class="number">3</span> weeks ago         <span class="number">215</span>MB</span><br><span class="line">centos              <span class="number">7.2</span><span class="number">.1511</span>            <span class="number">9</span>aec5c5fe4ba        <span class="number">17</span> months ago       <span class="number">195</span>MB</span><br></pre></td></tr></table></figure><h2 id="2-运行基础镜像"><a href="#2-运行基础镜像" class="headerlink" title="2.运行基础镜像"></a>2.运行基础镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以基础镜像运行一个容器，运行后执行命令，执行bash运行解释器</span></span><br><span class="line"><span class="comment">#-it 可以与终端进行交互参数</span></span><br><span class="line"><span class="comment">#--name 指定镜像名运行</span></span><br><span class="line">[root@docker-01 ~]#docker run -it --name  centos:7.9.2009 bash</span><br><span class="line">[root@8a6490e3d5a2 /]# </span><br><span class="line">[root@8a6490e3d5a2 /]# <span class="built_in">cat</span> /etc/redhat-release </span><br><span class="line">CentOS Linux release 7.9.2009 (Core)</span><br><span class="line"></span><br><span class="line">[root@8a6490e3d5a2 /]# ps -ef</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root          1      0  0 18:41 pts/0    00:00:00 bash</span><br><span class="line">root         17      1  0 18:42 pts/0    00:00:00 ps -ef</span><br></pre></td></tr></table></figure><p><strong>docker镜像文件存储目录结构</strong></p><ul><li><code>committed</code>：这个目录包含已提交的内容，即镜像层的内容。</li><li><code>diff</code>：这里包含了容器层的内容，即容器的文件系统的更改。</li><li><code>link</code>：这个目录包含了链接文件。</li><li><code>lower</code>：这个目录包含了底层的只读层的内容。</li><li><code>work</code>：这个目录是 overlay 文件系统的内部使用目录。</li></ul><h2 id="3-查看本地镜像"><a href="#3-查看本地镜像" class="headerlink" title="3.查看本地镜像"></a>3.查看本地镜像</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>根据名字列出镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images  cent<span class="operator">*</span></span><br><span class="line">REPOSITORY   TAG        IMAGE ID       CREATED         SIZE</span><br><span class="line">centos       <span class="number">7.9</span><span class="number">.2009</span>   eeb6ee3f44bd   <span class="number">11</span> months ago   <span class="number">204</span>MB</span><br><span class="line">centos       latest     <span class="number">5</span>d0da3dc9764   <span class="number">11</span> months ago   <span class="number">231</span>MB</span><br><span class="line">centos       <span class="number">7.7</span><span class="number">.1908</span>   <span class="number">08</span>d05d1d5859   <span class="number">2</span> years ago     <span class="number">204</span>MB</span><br><span class="line">centos       <span class="number">7.6</span><span class="number">.1810</span>   f1cb7c7d58b7   <span class="number">3</span> years ago     <span class="number">202</span>MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>查看指定镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images nginx</span><br><span class="line">nginx         nginx:<span class="number">1.17</span><span class="number">.9</span>  </span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images nginx:<span class="number">1.17</span><span class="number">.9</span> </span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">nginx        <span class="number">1.17</span><span class="number">.9</span>    <span class="number">5</span>a8dfb2ca731   <span class="number">2</span> years ago   <span class="number">127</span>MB</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>只查看镜像id，id就代表该镜像了</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images <span class="operator">-</span>q</span><br><span class="line">c20987f18b13</span><br><span class="line">c059bfaa849c</span><br><span class="line">ba6acccedd29</span><br><span class="line">eeb6ee3f44bd</span><br><span class="line"><span class="number">5</span>d0da3dc9764</span><br><span class="line"><span class="number">5</span>a8dfb2ca731</span><br><span class="line"><span class="number">08</span>d05d1d5859</span><br><span class="line">f1cb7c7d58b7</span><br><span class="line"><span class="number">758</span>ec7f3a1ee</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>格式化输出docker信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images <span class="comment">--format &quot;&#123;&#123;.ID&#125;&#125;:&#123;&#123;.Repository&#125;&#125;&quot;</span></span><br><span class="line">c20987f18b13:mysql</span><br><span class="line">c059bfaa849c:alpine</span><br><span class="line">ba6acccedd29:ubuntu</span><br><span class="line">eeb6ee3f44bd:centos</span><br><span class="line"><span class="number">5</span>d0da3dc9764:centos</span><br><span class="line"><span class="number">5</span>a8dfb2ca731:nginx</span><br><span class="line"><span class="number">08</span>d05d1d5859:centos</span><br><span class="line">f1cb7c7d58b7:centos</span><br><span class="line"><span class="number">758</span>ec7f3a1ee:busybox</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>更丰富的格式化</span><br><span class="line">#同效果docker images <span class="comment">--format &quot;table &#123;&#123;.ID&#125;&#125; &#123;&#123;.Repository&#125;&#125; &#123;&#123;.Tag&#125;&#125;&quot; | column -t</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images <span class="comment">--format &quot;table &#123;&#123;.ID&#125;&#125; &#123;&#123;.Repository&#125;&#125; &#123;&#123;.Tag&#125;&#125;&quot;</span></span><br><span class="line">IMAGE ID       REPOSITORY   TAG</span><br><span class="line">c20987f18b13   mysql        <span class="number">5.7</span></span><br><span class="line">c059bfaa849c   alpine       latest</span><br><span class="line">ba6acccedd29   ubuntu       latest</span><br><span class="line">eeb6ee3f44bd   centos       <span class="number">7.9</span><span class="number">.2009</span></span><br><span class="line"><span class="number">5</span>d0da3dc9764   centos       latest</span><br><span class="line"><span class="number">5</span>a8dfb2ca731   nginx        <span class="number">1.17</span><span class="number">.9</span></span><br><span class="line"><span class="number">08</span>d05d1d5859   centos       <span class="number">7.7</span><span class="number">.1908</span></span><br><span class="line">f1cb7c7d58b7   centos       <span class="number">7.6</span><span class="number">.1810</span></span><br><span class="line"><span class="number">758</span>ec7f3a1ee   busybox      <span class="number">1.29</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>格式化是docker信息提取的高级语法，需要学习下go的template语法</span><br><span class="line"># 基于<span class="comment">--format=&quot;&#123;&#123;json .&#125;&#125;&quot; 拿到详细字段，即可格式化</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images <span class="comment">--format=&quot;&#123;&#123;json .&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images <span class="comment">--format=&quot;&#123;&#123;.CreatedAt&#125;&#125; &#123;&#123;.ID&#125;&#125;  &#123;&#123;.Repository&#125;&#125; &#123;&#123;.Size&#125;&#125; &#123;&#123;.Tag&#125;&#125;&quot; |column -t</span></span><br><span class="line"><span class="number">2021</span><span class="number">-12</span><span class="number">-21</span>  <span class="number">10</span>:<span class="number">56</span>:<span class="number">51</span>  <span class="operator">+</span><span class="number">0800</span>  CST  c20987f18b13  mysql    <span class="number">448</span>MB   <span class="number">5.7</span></span><br><span class="line"><span class="number">2021</span><span class="number">-11</span><span class="number">-25</span>  <span class="number">04</span>:<span class="number">19</span>:<span class="number">40</span>  <span class="operator">+</span><span class="number">0800</span>  CST  c059bfaa849c  alpine   <span class="number">5.59</span>MB  latest</span><br><span class="line"><span class="number">2021</span><span class="number">-10</span><span class="number">-16</span>  <span class="number">08</span>:<span class="number">37</span>:<span class="number">47</span>  <span class="operator">+</span><span class="number">0800</span>  CST  ba6acccedd29  ubuntu   <span class="number">72.8</span>MB  latest</span><br><span class="line"><span class="number">2021</span><span class="number">-09</span><span class="number">-16</span>  <span class="number">02</span>:<span class="number">20</span>:<span class="number">23</span>  <span class="operator">+</span><span class="number">0800</span>  CST  eeb6ee3f44bd  centos   <span class="number">204</span>MB   <span class="number">7.9</span><span class="number">.2009</span></span><br><span class="line"><span class="number">2021</span><span class="number">-09</span><span class="number">-16</span>  <span class="number">02</span>:<span class="number">20</span>:<span class="number">05</span>  <span class="operator">+</span><span class="number">0800</span>  CST  <span class="number">5</span>d0da3dc9764  centos   <span class="number">231</span>MB   latest</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-16</span>  <span class="number">18</span>:<span class="number">09</span>:<span class="number">38</span>  <span class="operator">+</span><span class="number">0800</span>  CST  <span class="number">5</span>a8dfb2ca731  nginx    <span class="number">127</span>MB   <span class="number">1.17</span><span class="number">.9</span></span><br><span class="line"><span class="number">2019</span><span class="number">-11</span><span class="number">-12</span>  <span class="number">08</span>:<span class="number">21</span>:<span class="number">02</span>  <span class="operator">+</span><span class="number">0800</span>  CST  <span class="number">08</span>d05d1d5859  centos   <span class="number">204</span>MB   <span class="number">7.7</span><span class="number">.1908</span></span><br><span class="line"><span class="number">2019</span><span class="number">-03</span><span class="number">-15</span>  <span class="number">05</span>:<span class="number">20</span>:<span class="number">29</span>  <span class="operator">+</span><span class="number">0800</span>  CST  f1cb7c7d58b7  centos   <span class="number">202</span>MB   <span class="number">7.6</span><span class="number">.1810</span></span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-26</span>  <span class="number">16</span>:<span class="number">20</span>:<span class="number">42</span>  <span class="operator">+</span><span class="number">0800</span>  CST  <span class="number">758</span>ec7f3a1ee  busybox  <span class="number">1.15</span>MB  <span class="number">1.29</span></span><br></pre></td></tr></table></figure><h2 id="4-删除本地镜像"><a href="#4-删除本地镜像" class="headerlink" title="4.删除本地镜像"></a>4.删除本地镜像</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.删除正在运行的容器的镜像</span><br><span class="line"><span class="comment">#先停止该镜像运行的容器，再删除容器记录</span></span><br><span class="line">docker ps</span><br><span class="line">docker stop &lt;容器id&gt;</span><br><span class="line">docker rm   &lt;容器id&gt;</span><br><span class="line"><span class="comment">#最后就可以删除镜像文件了</span></span><br><span class="line">docker images</span><br><span class="line">docker rmi 【镜像名/镜像id】:镜像版本/不指定删除latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.删除本地镜像文件</span><br><span class="line"><span class="comment">#不指定版本默认删除最新版bash:latest</span></span><br><span class="line">[root<span class="variable">@docker</span>-<span class="number">01</span> ~]<span class="comment">#docker rmi bash</span></span><br><span class="line">Untagged: bash:latest</span><br><span class="line">Untagged: bash<span class="variable">@sha256</span>:876600f8a1ce04df27722f482ebfe6696aa4fec6a61a7ea2cf6d5045a63c5d9a</span><br><span class="line">Deleted: sha256:6a03c8e7e2be03e010d21a78c56090566e418e6957a97e5b8906b0c8df7d4e5b</span><br><span class="line">Deleted: sha256:1e8b878eec0b51c7b2f0013848423799162ab25976dc2994caeeb810ca67b4ac</span><br><span class="line">Deleted: sha256:3bd00f48fdafd060b224766edd1f5566823f41f7b66ab09a34f0262e6c8971de</span><br><span class="line">Deleted: sha256:1a058d5342cc722ad5439cacae4b2b4eedde51d8fe8800fcf28444302355c16d</span><br><span class="line">[root<span class="variable">@docker</span>-<span class="number">01</span> ~]<span class="comment">#docker images</span></span><br><span class="line"><span class="comment">#指定版本删除</span></span><br><span class="line">[root<span class="variable">@docker</span>-<span class="number">01</span> ~]<span class="comment">#docker rmi mysql:5.7.25</span></span><br><span class="line">Untagged: mysql:<span class="number">5.7</span><span class="number">.25</span></span><br><span class="line">Untagged: mysql<span class="variable">@sha256</span>:dba5fed182e64064b688ccd22b2f9cad4ee88608c82f8cff21e17bab8da72b81</span><br><span class="line">Deleted: sha256:98455b9624a96e32b353297bb312913b6bbd62ac195cea2c7dd477209ba572d6</span><br><span class="line">Deleted: sha256:30864c1ff360a3d6f677a58fe78a89116f589c4dd7f32ff7b48e2b45786083d8</span><br><span class="line">Deleted: sha256:731b36653b532066f7a3ae9e75faae04f12bf8ecfcbc797e363b01e43a831b5f</span><br><span class="line">[root<span class="variable">@docker</span>-<span class="number">01</span> ~]<span class="comment">#docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除所有镜像文件</span></span><br><span class="line">docker rmi <span class="string">`docker images -aq`</span></span><br></pre></td></tr></table></figure><h2 id="5-镜像存档与导出"><a href="#5-镜像存档与导出" class="headerlink" title="5.镜像存档与导出"></a>5.镜像存档与导出</h2><blockquote><p>常用于公司的离线环境使用镜像，默认导出的是tar归档文件</p></blockquote><p><code>docker save</code> 命令用于将 Docker 镜像保存为一个或多个 tar 归档文件。这些归档文件包含了 Docker 镜像的所有层和元数据，可以通过 <code>docker load</code> 命令恢复为 Docker 镜像。</p><p>这个命令通常在以下情况下使用：</p><ol><li>在不同的环境中传输 Docker 镜像，例如从开发环境传输到生产环境。</li><li>备份 Docker 镜像，以便在需要时能够快速还原。</li><li>在没有直接访问 Docker 仓库的情况下，将 Docker 镜像传输到另一台主机。</li></ol><hr><p><code>docker load</code> 是 Docker 命令行工具中的一个命令，用于从存档文件中加载 Docker 镜像。这个命令的作用是将由 <code>docker save</code> 命令创建的 Docker 镜像存档文件加载到 Docker 环境中</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#导出本地镜像文件到指定目录</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker save <span class="number">605</span>c77 <span class="operator">&gt;</span> nginx:latest.tar</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ls</span><br><span class="line">nginx:latest.tar</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#file nginx\:latest.tar </span><br><span class="line">nginx:latest.tar: POSIX tar archive</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#du <span class="operator">-</span>sh</span><br><span class="line"><span class="number">140</span>M.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#导入存储镜像的tar包到docker</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker load <span class="operator">&lt;</span> <span class="operator">/</span>root<span class="operator">/</span>nginx\:latest.tar </span><br><span class="line"><span class="number">2</span>edcec3590a4: Loading layer [<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">&gt;</span>]  <span class="number">83.86</span>MB<span class="operator">/</span><span class="number">83.86</span>MB</span><br><span class="line">e379e8aedd4d: Loading layer [<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">&gt;</span>]     <span class="number">62</span>MB<span class="operator">/</span><span class="number">62</span>MB</span><br><span class="line">b8d6e692a25e: Loading layer [<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">&gt;</span>]  <span class="number">3.072</span>kB<span class="operator">/</span><span class="number">3.072</span>kB</span><br><span class="line">f1db227348d0: Loading layer [<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">&gt;</span>]  <span class="number">4.096</span>kB<span class="operator">/</span><span class="number">4.096</span>kB</span><br><span class="line"><span class="number">32</span>ce5f6a5106: Loading layer [<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">&gt;</span>]  <span class="number">3.584</span>kB<span class="operator">/</span><span class="number">3.584</span>kB</span><br><span class="line">d874fd2bc83b: Loading layer [<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">&gt;</span>]  <span class="number">7.168</span>kB<span class="operator">/</span><span class="number">7.168</span>kB</span><br><span class="line">Loaded image ID: sha256:<span class="number">605</span>c77e624ddb75e6110f997c58876baa13f8754486b461117934b24a9dc3a85</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line"><span class="operator">&lt;</span><span class="keyword">none</span><span class="operator">&gt;</span>       <span class="operator">&lt;</span><span class="keyword">none</span><span class="operator">&gt;</span>    <span class="number">605</span>c77e624dd   <span class="number">2</span> years ago   <span class="number">141</span>MB</span><br></pre></td></tr></table></figure><h2 id="6-查看镜像详细信息"><a href="#6-查看镜像详细信息" class="headerlink" title="6.查看镜像详细信息"></a>6.查看镜像详细信息</h2><blockquote><p>无论是查看镜像信息，还是容器的详细信息，都是维护容器的重要手段</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#查看镜像构建历史信息</span><br><span class="line">docker history redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看镜像的详细信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect 镜像名:tag版本<span class="operator">|</span>jq</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;Id&quot;: &quot;sha256:605c77e624ddb75e6110f997c58876baa13f8754486b461117934b24a9dc3a85&quot;,</span><br><span class="line">    &quot;RepoTags&quot;: [</span><br><span class="line">      &quot;nginx:latest&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;RepoDigests&quot;: [</span><br><span class="line">      &quot;nginx@sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31&quot;</span><br><span class="line">    ],</span><br><span class="line">..........后面有大量的关于镜像信息</span><br></pre></td></tr></table></figure><h1 id="docker命令实战练习"><a href="#docker命令实战练习" class="headerlink" title="docker命令实战练习"></a>docker命令实战练习</h1><h2 id="1-容器增删改查"><a href="#1-容器增删改查" class="headerlink" title="1.容器增删改查"></a>1.容器增删改查</h2><p><strong>增</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#启动运行容器</span><br><span class="line">#参数解释：</span><br><span class="line">#run：创建并与运行 </span><br><span class="line">#<span class="operator">-</span>i：开启对容器的标准输入stdin </span><br><span class="line">#<span class="operator">-</span>t：给容器分配一个终端页面  </span><br><span class="line">#<span class="operator">-</span>p：将容器进程端口指定具体端口映射到宿主机上</span><br><span class="line">#<span class="operator">-</span>P：将容器进程端口随机映射端口到宿主机上</span><br><span class="line">#<span class="comment">--name:指定名字创建容器 </span></span><br><span class="line">docker run <span class="operator">-</span>it <span class="operator">-</span>p <span class="number">80</span>:<span class="number">80</span>  <span class="operator">-</span>d <span class="comment">--name test_nginx  容器id</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动关闭未运行的容器</span><br><span class="line">docker <span class="keyword">start</span> 容器id</span><br></pre></td></tr></table></figure><p><strong>删</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#删除未运行的容器</span><br><span class="line">docker rm 容器id</span><br><span class="line"></span><br><span class="line">#删除全部未运行的容器</span><br><span class="line">docker rm `docker <span class="operator">-</span>qa` </span><br><span class="line"></span><br><span class="line">#删除运行的容器</span><br><span class="line">docker stop 容器id</span><br><span class="line">docker rm 容器id</span><br><span class="line"></span><br><span class="line">#删除全部容器包括运行中的</span><br><span class="line">docker rm <span class="operator">-</span>f  `docker <span class="operator">-</span>qa`</span><br></pre></td></tr></table></figure><p><strong>改</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#运行的容器内执行命令</span><br><span class="line">docker <span class="keyword">exec</span>  容器id  容器内执行的具体命令</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#进入容器内部交互执行命令</span><br><span class="line">docker <span class="keyword">exec</span> <span class="operator">-</span>it 容器id  <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#将运行中容器的状态生产新镜像</span><br><span class="line">docker <span class="keyword">commit</span> 容器id  新镜像名:TAG[不设置TAG默认latest标识]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#修改容器的名字</span><br><span class="line">docker rename 原容器名 新容器名</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#修改容器状态</span><br><span class="line">docker stop 容器id </span><br><span class="line">docker restart 容器id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#导出容器当前状态导出为镜像文件tar包</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker export <span class="number">2</span>db <span class="operator">&gt;</span> <span class="operator">/</span>opt<span class="operator">/</span>caibi_nginx.tar</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ls <span class="operator">/</span>opt</span><br><span class="line">caibi_nginx.tar</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#file <span class="operator">/</span>opt<span class="operator">/</span>caibi_nginx.tar</span><br><span class="line"><span class="operator">/</span>caibi_nginx.tar: POSIX tar archive</span><br><span class="line">#tar包导入docker镜像文件</span><br><span class="line">docker import  caibi_nginx.tar 镜像文件名:TAG</span><br></pre></td></tr></table></figure><p><strong>查</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#查看运行的容器</span><br><span class="line">docker ps</span><br><span class="line">#查看运行容器的id</span><br><span class="line">docker ps <span class="operator">-</span>q</span><br><span class="line">#查看所有容器，容器记录</span><br><span class="line">docker ps <span class="operator">-</span>a</span><br><span class="line">#查看所有容器的id</span><br><span class="line">docker ps <span class="operator">-</span>qa</span><br><span class="line">#查看运行的容器内部运行的服务进程</span><br><span class="line">docker top</span><br><span class="line">#查看运行容器的端口映射信息</span><br><span class="line">docker port</span><br><span class="line">#查看容器实例日志信息，正常运行日志与错误日志结合打印</span><br><span class="line">docker logs</span><br><span class="line">#查看容器实例的所有信息，已json格式输出</span><br><span class="line">docker inspect</span><br><span class="line">#查看docker引擎的信息</span><br><span class="line">docker info</span><br><span class="line">#监控docker实例对宿主机硬件资源消耗情况</span><br><span class="line">docker stats</span><br></pre></td></tr></table></figure><h2 id="2-镜像增删改查"><a href="#2-镜像增删改查" class="headerlink" title="2.镜像增删改查"></a>2.镜像增删改查</h2><p><strong>增</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#镜像仓库下载镜像</span><br><span class="line">docker pull 镜像名:TAG(不加TAG默认最新版latest)</span><br><span class="line"></span><br><span class="line">#容器内增加新内容提交生成新镜像</span><br><span class="line">docker <span class="keyword">commit</span> 容器id 镜像名:TAG</span><br><span class="line"></span><br><span class="line">#保存镜像文件导出为tar包</span><br><span class="line">docker save 镜像id</span><br><span class="line"></span><br><span class="line">#导入镜像tar包到镜像列表</span><br><span class="line">docker load 镜像id 镜像名:TAG</span><br><span class="line"></span><br><span class="line">#构建dockerfile镜像</span><br><span class="line">docker build dockerfile </span><br></pre></td></tr></table></figure><p><strong>删</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#删除单个镜像</span><br><span class="line">docker rm 镜像id</span><br><span class="line"></span><br><span class="line">#删除全部镜像</span><br><span class="line">docker rm `docker images <span class="operator">-</span>qa`</span><br></pre></td></tr></table></figure><p><strong>改</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#修改镜像文件的TAG标签</span><br><span class="line">docker tag 原镜像:TAG 原镜像:newTAG</span><br></pre></td></tr></table></figure><p><strong>查</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#查看镜像的构建历史层</span><br><span class="line">docker history 镜像id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看下载到本地的镜像文件</span><br><span class="line">docker images<span class="operator">=</span><span class="operator">=</span>image ls</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;docker安装部署&quot;&gt;&lt;a href=&quot;#docker安装部署&quot; class=&quot;headerlink&quot; title=&quot;docker安装部署&quot;&gt;&lt;/a&gt;docker安装部署&lt;/h1&gt;&lt;h2 id=&quot;1-开启流量转发&quot;&gt;&lt;a href=&quot;#1-开启流量转发&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>容器Docker-原理概述</title>
    <link href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0/"/>
    <id>http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0/</id>
    <published>2024-08-20T01:30:46.000Z</published>
    <updated>2024-08-20T01:45:47.037Z</updated>
    
    <content type="html"><![CDATA[<h1 id="服务部署技术的演变"><a href="#服务部署技术的演变" class="headerlink" title="服务部署技术的演变"></a>服务部署技术的演变</h1><h2 id="服务器部署应用"><a href="#服务器部署应用" class="headerlink" title="服务器部署应用"></a>服务器部署应用</h2><p>在没有虚拟化技术时，服务器部署服务的流程通常如下：</p><ol><li><strong>服务器选型和采购</strong>：首先需要根据业务需求选择合适的服务器硬件，并进行采购。</li><li><strong>操作系统安装</strong>：在服务器上安装合适的操作系统，通常是类UNIX或Windows Server等。</li><li><strong>依赖软件安装</strong>：根据服务的需求，安装必要的依赖软件，例如数据库服务、Web 服务器、应用程序运行环境等。</li><li><strong>服务软件安装</strong>：安装并配置需要部署的服务软件，例如应用程序、Web 服务、文件服务等。</li><li><strong>网络配置</strong>：配置服务器的网络，包括 IP 地址、子网掩码、网关、DNS 等。</li><li><strong>安全配置</strong>：进行安全性配置，比如设置防火墙规则、安装安全补丁、配置访问控制等。</li><li><strong>性能优化</strong>：优化服务器的性能，例如进行内存、磁盘等资源的调优、配置缓存等。</li><li><strong>备份与恢复</strong>：设置数据备份策略，确保数据的安全性和可恢复性。</li></ol><p>一旦服务部署完成，需要进行持续的监控和维护，以确保服务的稳定性和安全性。这种部署方式通常需要花费较多的时间和精力，并且在资源利用率和灵活性上会受到一定的限制。随着虚拟化和容器化技术的发展，部署服务的方式已经有了很大的变革。</p><blockquote><p>缺点，说白了就是太麻烦，太慢，费钱费精力费人力</p></blockquote><p>在没有虚拟化技术时，服务器部署服务的方式存在一些缺点，包括但不限于：</p><ol><li><strong>资源利用率低</strong>：在物理服务器上部署单一服务，无法充分利用服务器的资源，导致资源浪费。</li><li><strong>灵活性不足</strong>：无法灵活地调整服务的规模和配置，需要针对特定硬件和系统进行调整，部署和维护成本较高。</li><li><strong>难以扩展</strong>：在服务器资源不足时，需要购买新的物理服务器来扩展服务能力，部署和管理成本高昂。</li><li><strong>隔离性差</strong>：不同服务之间的隔离性差，可能会导致一个服务的故障影响其他服务的稳定性。</li><li><strong>故障恢复困难</strong>：在硬件故障或系统崩溃时，恢复数据和服务通常需要花费较多的时间和成本。</li><li><strong>软件堆叠冲突</strong>：不同服务所需的软件环境可能存在冲突，难以在同一台物理服务器上进行部署。</li><li><strong>管理繁琐</strong>：需要手动管理物理服务器上的各种软件和服务，包括安装、配置、监控和维护，工作量大且容易出错。</li></ol><p>这些缺点使得传统的物理服务器部署方式在当今快速变化的业务环境中变得越来越不合适。虚拟化技术和容器化技术的出现弥补了这些缺点，提供了更高效、灵活和可靠的服务部署和管理方式。</p><h2 id="虚拟机部署应用"><a href="#虚拟机部署应用" class="headerlink" title="虚拟机部署应用"></a>虚拟机部署应用</h2><ol><li><strong>虚拟化平台选择</strong>：选择合适的虚拟化平台，如VMware、Hyper-V、VirtualBox、KVM 等。</li><li><strong>服务器选型和虚拟化配置</strong>：根据业务需求选择合适的物理服务器，并在服务器上安装虚拟化平台。</li><li><strong>虚拟机创建</strong>：在虚拟化平台上创建虚拟机，并配置虚拟机的资源，包括 CPU、内存、存储等。</li><li><strong>操作系统安装</strong>：在虚拟机上安装操作系统，可以选择不同的操作系统版本和发行版。</li><li><strong>依赖软件安装</strong>：根据服务的需求，在虚拟机上安装必要的依赖软件，例如数据库服务、Web 服务器、应用程序运行环境等。</li><li><strong>服务软件安装</strong>：安装并配置需要部署的服务软件，例如应用程序、Web 服务、文件服务等。</li><li><strong>网络配置</strong>：配置虚拟机的网络，包括设置 IP 地址、子网掩码、网关、DNS 等。</li><li><strong>安全配置</strong>：进行虚拟机的安全性配置，如设置防火墙规则、安装安全补丁、配置访问控制等。</li><li><strong>性能优化</strong>：优化虚拟机的性能，包括调整资源分配、配置缓存、优化存储等。</li><li><strong>备份与恢复</strong>：设置虚拟机的备份策略，确保数据的安全性和可恢复性。</li></ol><p>虚拟机技术能够提供更高的资源利用率、灵活性和可靠性，使得服务部署和管理更加简便和高效。通过虚拟化技术，可以快速部署新的服务实例、动态调整资源配置、实现快速备份和恢复等功能，满足现代企业对服务部署的需求。</p><blockquote><p>对比服务器部署的好处</p></blockquote><p>传统的早期服务器部署服务方式存在一些缺点，而虚拟化技术能够弥补这些缺点，提供更高效、灵活和可靠的服务部署和管理方式。以下是传统早期服务器部署服务方式相对于虚拟化技术的一些好处：</p><ol><li><strong>资源利用率高</strong>：虚拟化技术可以更充分地利用物理服务器的资源，多个虚拟机可以共享物理资源，提高资源的利用效率。</li><li><strong>灵活性强</strong>：虚拟化技术可以实现动态调整虚拟机的资源配置，快速部署新的服务实例，提高了对业务需求的灵活响应能力。</li><li><strong>扩展性优秀</strong>：虚拟化技术可以快速创建新的虚拟机实例，实现服务的快速扩展，而传统方式需要购买新的物理服务器。</li><li><strong>隔离性强</strong>：虚拟化技术提供了更好的虚拟机隔离性，不同虚拟机之间的故障不会相互影响，提高了服务的稳定性。</li><li><strong>故障恢复快速</strong>：虚拟化技术支持快速备份和恢复虚拟机实例，使得故障恢复更加快速和可靠。</li><li><strong>软件堆叠冲突减少</strong>：虚拟化技术可以将不同服务的运行环境隔离开来，减少了不同服务之间的软件堆叠冲突。</li><li><strong>管理简化</strong>：虚拟化技术提供了更好的自动化管理功能，通过虚拟化管理平台可以更方便地管理和监控虚拟机。</li></ol><p>综上所述，相对于早期的服务器部署服务方式，虚拟化技术具有更高的资源利用率、灵活性、扩展性、隔离性和管理简化，能够更好地满足现代企业对服务部署和管理的需求。</p><h2 id="容器化部署应用"><a href="#容器化部署应用" class="headerlink" title="容器化部署应用"></a>容器化部署应用</h2><ol><li><strong>选择合适的容器化平台</strong>：选择合适的容器化平台，如Docker、Kubernetes、OpenShift等。</li><li><strong>编写Dockerfile</strong>：为要部署的应用程序编写Dockerfile，描述应用程序所需的环境、依赖和启动命令。</li><li><strong>构建Docker镜像</strong>：使用Dockerfile构建Docker镜像，包括应用程序及其运行环境和依赖。</li><li><strong>推送镜像到仓库</strong>：将构建好的Docker镜像推送到镜像仓库，如Docker Hub或私有镜像仓库。</li><li><strong>编写Kubernetes配置文件</strong>：如果使用Kubernetes作为容器编排平台，编写Kubernetes配置文件，描述要部署的容器、服务发现、负载均衡等配置。</li><li><strong>部署容器</strong>：使用容器编排平台（如Docker Swarm、Kubernetes等）部署容器，启动应用程序的容器实例。</li><li><strong>监控和管理</strong>：通过容器编排平台或监控工具对容器进行监控，确保应用程序正常运行，并进行必要的管理和维护。</li><li><strong>自动化扩展</strong>：根据需求配置自动化扩展策略，以确保根据负载情况自动扩展或缩减容器实例数量。</li><li><strong>日志和监控</strong>：配置日志收集和监控系统，收集容器应用程序的日志和指标，以便及时发现和解决问题。</li><li><strong>持续集成&#x2F;持续部署（CI&#x2F;CD）</strong>：结合CI&#x2F;CD工具，实现容器化部署的持续集成和持续部署流程。</li></ol><p>容器化部署服务的流程相比虚拟机部署更加轻量级、灵活，容器可以在任何环境中运行，并且相互隔离，使得应用程序的部署和管理更加简单高效。容器化部署服务也更适合微服务架构，能够更好地实现服务拆分和扩展。</p><blockquote><p>对比虚拟化的好处</p></blockquote><ol><li><strong>更轻量级</strong>：容器化相比虚拟化更轻量，容器共享操作系统内核，因此启动更快，占用更少的资源。</li><li><strong>更高的性能</strong>：由于容器共享操作系统内核，相比虚拟机，容器在相同硬件上可以实现更高的性能。</li><li><strong>更快速的部署和扩展</strong>：容器可以更快速地部署和扩展，启动时间更短，能够更快地响应业务需求。</li><li><strong>更好的可移植性</strong>：容器可以在任何环境中运行，具有很强的可移植性，开发环境和生产环境可以保持一致。</li><li><strong>更高的灵活性</strong>：容器化技术支持快速打包、部署和更新应用程序，提高了对业务需求的灵活响应能力。</li><li><strong>更好的资源利用</strong>：容器化可以更好地利用硬件资源，可以在同一主机上运行更多的应用实例，提高了资源的利用效率。</li><li><strong>更便于管理</strong>：容器化技术具有更简单的部署和管理方式，可以更快速地部署、更新和管理应用程序。</li><li><strong>更好的隔离性</strong>：容器之间相互隔离，相比虚拟机，容器在运行时更轻量，并且更好地隔离，不会相互影响。</li></ol><p>总的来说，容器化相较于虚拟化更加轻量级、灵活，并且更适合微服务架构，能够更好地实现服务拆分和扩展。容器化技术在现代应用部署和管理中得到了广泛应用，已成为云原生应用开发和部署的主流技术。</p><p><img src="/image-20240717182236029.png" alt="image-20240717182236029"></p><h1 id="docker容器化平台"><a href="#docker容器化平台" class="headerlink" title="docker容器化平台"></a>docker容器化平台</h1><p><img src="/image-20240717192000013.png" alt="image-20240717192000013"></p><h2 id="docker起源"><a href="#docker起源" class="headerlink" title="docker起源"></a>docker起源</h2><p>Docker的起源可以追溯到dotCloud公司，该公司成立于2011年，总部位于美国旧金山。dotCloud最初是一家云计算服务提供商，提供基于云的平台即服务（PaaS）解决方案。</p><p>在dotCloud的发展过程中，他们使用了Linux容器技术（LXC）来实现资源隔离与限制，以提供更高效的部署和扩展解决方案。为了方便创建和管理这些容器，dotCloud开发了一套内部工具，最初被命名为“dotCloud Container”，后来在2013年3月正式发布并更名为“Docker”。</p><p>Docker的发布开启了容器化技术的新纪元，它提供了一种轻量级、快速部署的容器解决方案，使得应用程序可以在不同的环境中进行快速、一致的部署。Docker的出现极大地简化了应用程序的开发、交付和运维过程，成为当今容器化领域的领先技术和行业标准。</p><p>因此，Docker的起源可以追溯到dotCloud公司在使用Linux容器技术的过程中开发的内部工具，后来演变成了一个独立的开源项目并成为容器化技术的领军者。</p><p><strong>lxc技术</strong></p><p>LXC（Linux  Containers)是一种操作系统级虚拟化技术，用于在Linux系统上实现轻量级的进程隔离和资源限制。LXC允许用户在单个Linux系统上运行多个独立的容器，每个容器都拥有自己的文件系统、网络、进程空间等资源，但是它们共享同一个Linux内核。</p><p>通过LXC，用户可以快速创建、启动、停止和删除容器，实现了类似虚拟机的隔离效果，但是相比传统虚拟化技术（如Hypervisor），LXC的开销更低，启动和运行速度更快。这是因为LXC容器直接运行在宿主系统的内核上，而不需要额外的操作系统内核和虚拟化层。</p><p>LXC技术提供了一种轻量级的虚拟化解决方案，适用于需要快速部署和隔离的场景，比如开发、测试、部署应用程序等。它在容器化技术的发展中起到了先驱作用，为后来的容器化平台（如Docker）奠定了技术基础。</p><h2 id="docker是什么"><a href="#docker是什么" class="headerlink" title="docker是什么"></a>docker是什么</h2><p>Docker是一种开源的容器化平台，它可以使开发、部署和运行应用程序更加简单。Docker利用容器化技术，将应用程序及其所需的依赖项打包到一个可移植的容器中，从而使应用程序在不同的环境中能够快速、一致地部署和运行。Docker可以在物理机、虚拟机、公有云和私有云上运行，并能够有效地管理应用程序的生命周期。</p><p>Docker的核心概念包括镜像（Image）、容器（Container）、仓库（Repository）和服务（Service）。镜像是一个只读的模板，它包含了运行应用程序所需的所有内容，例如代码、运行时、库和环境变量。容器是由镜像创建的运行实例，它包含了应用程序及其依赖的运行环境，可以被快速部署、复制和移动。仓库是用于存储和组织镜像的地方，可以是公共的或者私有的。服务是一组容器的集合，可以协同工作以实现一个应用程序的功能。</p><p>总的来说，Docker的出现极大地简化了应用程序的开发、部署和管理，提高了开发人员和运维人员的工作效率，同时也降低了应用程序在不同环境中部署和运行的成本。</p><p><strong>平台是什么意思</strong></p><p>“平台”一词可以被理解为一个聚集资源和服务的地方。在Docker容器化平台中，这个平台就像是一个集市或者市场，可以帮助我们汇集各种各样的应用程序、工具和服务。这个平台为开发者和用户提供了一个统一的场所，使他们能够方便地找到自己需要的东西，比如各种应用程序、库、工具等。而且在这个平台上，这些资源和服务都能够互相连接和交互，方便大家进行开发、测试和部署工作。因此，在中国人的思维中，Docker容器化平台中的”平台”就是一个方便大家汇聚资源和服务，进行交流和合作的聚集地。</p><h2 id="docker应用场景"><a href="#docker应用场景" class="headerlink" title="docker应用场景"></a>docker应用场景</h2><blockquote><p>简单理解</p><p>1.节省项目上线时间（拉取镜像更方便不用多次准备运行环境）</p><p>2.不浪费宿主机的硬件资源（虚拟机内核共用）</p></blockquote><p>&#x3D;&#x3D;为什么学docker&#x3D;&#x3D;</p><ol><li><strong>方便快捷的软件开发和部署</strong>：Docker 提供了一种轻量级、快速部署的容器化技术，可以让开发人员更加方便地构建、打包和部署应用程序，提高了开发效率。</li><li><strong>资源利用率高</strong>：Docker 可以在一个主机上运行多个容器，每个容器之间相互隔离，这样可以更有效地利用计算资源，降低成本。</li><li><strong>便于环境配置和迁移</strong>：通过 Docker 可以创建一次性的、可移植的开发环境，确保开发、测试和生产环境一致性，避免因环境不一致而引起的问题。</li><li><strong>持续集成和持续部署</strong>：Docker 技术可以与持续集成工具结合使用，帮助团队更好地实施持续集成、持续部署，提高软件交付的速度和质量。</li><li><strong>微服务架构</strong>：Docker 支持微服务架构，可以让应用程序被拆分成多个独立的服务，每个服务都可以打包成一个 Docker 镜像，实现更好的可维护性和扩展性。</li></ol><p>总的来说，学习 Docker 可以让软件开发和部署变得更加便捷、高效，提高开发团队的工作效率，降低成本，符合当前企业对于敏捷开发和持续交付的需求。</p><h2 id="docker平台作用"><a href="#docker平台作用" class="headerlink" title="docker平台作用"></a>docker平台作用</h2><p>Docker是一种容器化平台，它的作用主要有以下几个方面：</p><ol><li><strong>应用程序打包和交付</strong>：Docker可以帮助开发人员将应用程序及其所有依赖项打包到一个标准化的容器中，这使得应用程序在不同的环境中可以一致地运行，简化了应用程序的交付过程。</li><li><strong>提供一致的运行环境</strong>：Docker容器可以在任何支持Docker的平台上运行，并提供了一致的运行环境，消除了因为不同环境而导致的兼容性和配置问题。</li><li><strong>简化部署流程</strong>：Docker容器可以快速部署，而且可以在同一台物理机上运行多个容器，这样可以更加高效地利用服务器资源，简化了部署流程。</li><li><strong>提高开发效率</strong>：Docker可以帮助开发人员快速搭建开发环境，同时提供了轻量级的虚拟化解决方案，提高了开发效率。</li></ol><p>总的来说，Docker的作用是通过容器化技术，提供了一种轻量、灵活、可移植的解决方案，帮助开发人员更加高效地进行应用程序的开发、交付和部署。</p><h1 id="docker容器架构"><a href="#docker容器架构" class="headerlink" title="docker容器架构"></a>docker容器架构</h1><h2 id="docker平台架构"><a href="#docker平台架构" class="headerlink" title="docker平台架构"></a>docker平台架构</h2><ol><li><p>Docker平台的架构包括Docker引擎、Docker Registry、Docker Compose和Docker Swarm等核心组件，以及底层的操作系统和基础设施。下面将逐一介绍这些组件的架构。</p><ol><li>Docker引擎：Docker引擎由Docker守护进程（Docker Daemon）、Docker客户端（Docker  Client）和Docker镜像（Docker  Image）组成。Docker守护进程负责管理Docker对象，如镜像、容器、网络和数据卷，监听Docker  API请求并处理它们。Docker客户端允许用户与Docker交互，发送命令和请求给Docker守护进程。Docker镜像是用于创建容器的模板，包含了运行容器所需的文件系统和应用程序。</li><li>Docker Registry：Docker Registry是用于存储Docker镜像的中央服务，允许用户上传和下载镜像。用户可以使用公共的Docker Hub Registry，也可以搭建私有的Registry来存储自己的镜像。</li><li>Docker Compose：Docker Compose是用于定义和运行多个容器化应用的工具。它允许用户通过一个单独的YAML文件来定义多个容器的配置，然后通过一条命令启动、停止或重建整个应用。</li><li>Docker Swarm：Docker Swarm是Docker的集群管理工具，允许用户将多台Docker主机组成一个集群，以实现高可用性、负载均衡和容器的自动部署和伸缩。Swarm使用标准的Docker API，因此与Docker引擎兼容。</li></ol><p>在底层，Docker平台的架构还涉及到操作系统和基础设施的支持。Docker引擎可以在各种操作系统上运行，包括Linux、Windows和macOS，并且可以利用各种云平台和基础设施来部署和管理容器化应用程序。整个Docker平台的架构是为了提供高效、可靠和可扩展的容器化解决方案而设计的。</p></li></ol><p><img src="/image-20240717183335001.png" alt="image-20240717183335001"></p><h2 id="docker引擎架构"><a href="#docker引擎架构" class="headerlink" title="docker引擎架构"></a>docker引擎架构</h2><p>Docker引擎架构由三个主要组件组成：Docker守护进程（Docker Daemon）、Docker客户端（Docker Client）和Docker镜像。</p><p>Docker守护进程是Docker引擎的主要组件，负责管理Docker对象，如镜像、容器、网络和数据卷。它接收来自Docker客户端的命令，并根据这些命令执行相应的操作，如创建、运行、停止和删除容器等。</p><p>Docker客户端是用户与Docker守护进程交互的接口，用户可以使用Docker客户端发送命令给Docker守护进程来管理Docker对象。</p><p>Docker镜像是用于创建Docker容器的模板，它包含了应用程序的代码、运行时环境、系统工具和库等。Docker镜像可以通过Docker守护进程来创建、删除、推送和拉取。</p><p>这三个组件共同工作，构成了Docker引擎的架构，用户通过Docker客户端与Docker守护进程进行交互，使用Docker镜像来创建和管理Docker容器。</p><p><strong>引擎啥意思</strong></p><p>“引擎”通常指的是一个设备或系统中产生动力或驱动力的部分。在技术领域，”引擎”常常被用来指代一个系统的核心部分，负责执行特定的功能或任务。</p><p>在软件和计算机领域，”引擎”通常表示执行特定任务的核心组件。例如，搜索引擎是指用于在互联网上搜索信息的软件系统，游戏引擎是指用于游戏开发和运行的软件平台，数据库引擎是指用于管理数据库的核心软件组件等。</p><p>在Docker中，”引擎”指的是Docker引擎（Docker  Engine），是Docker容器平台的核心组件，负责管理和运行容器化应用程序。Docker引擎包括Docker守护进程（Docker  Daemon）和Docker客户端（Docker Client），是整个Docker平台的核心部分。</p><p>因此，”引擎”在技术领域通常指代一个系统或软件中的核心组件，负责执行主要的功能或任务。</p><p><img src="/image-20240717184416637.png" alt="image-20240717184416637"></p><h1 id="docker平台组件"><a href="#docker平台组件" class="headerlink" title="docker平台组件"></a>docker平台组件</h1><h2 id="docker守护进程"><a href="#docker守护进程" class="headerlink" title="docker守护进程"></a>docker守护进程</h2><p>Docker守护进程（Docker Daemon）是Docker平台的核心组件之一，它是一个后台进程，负责管理Docker对象，如镜像、容器、网络和数据卷。Docker守护进程监听Docker API请求并处理它们，管理Docker对象的生命周期。</p><p>Docker守护进程还负责与容器运行时（container runtime）进行通信，以创建和管理容器。它还管理容器的运行时环境，包括文件系统、网络和进程隔离。守护进程还负责监控容器的状态，并在需要时重新启动或停止它们。</p><p>除此之外，Docker守护进程还处理与Docker客户端的通信，接受来自用户或其他程序的命令和请求，并执行相应的操作。例如，通过Docker客户端可以向守护进程发送命令来创建、启动、停止、删除容器，以及构建、上传和下载镜像等操作。</p><p>总之，Docker守护进程是Docker平台的核心引擎，负责管理和执行Docker的各种操作，并提供运行时环境以支持容器化应用程序的部署和管理。</p><h2 id="docker-rest接口"><a href="#docker-rest接口" class="headerlink" title="docker_rest接口"></a>docker_rest接口</h2><p>Docker守护进程提供了REST API，允许用户与Docker进行交互，执行各种操作，如创建、启动、停止和删除容器，构建和管理镜像，以及管理网络和数据卷等。通过REST API，用户可以使用HTTP请求来与Docker守护进程通信，执行各种操作。</p><p>以下是一些常见的Docker REST API端点示例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 获取Docker版本信息：</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>version</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 列出Docker中的镜像：</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>images<span class="operator">/</span>json</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 创建一个新的容器：</span><br><span class="line">POST <span class="operator">/</span>containers<span class="operator">/</span><span class="keyword">create</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 启动一个已有的容器：</span><br><span class="line">POST <span class="operator">/</span>containers<span class="operator">/</span>&#123;id&#125;<span class="operator">/</span><span class="keyword">start</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> 列出当前正在运行的容器：</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>containers<span class="operator">/</span>json</span><br></pre></td></tr></table></figure><p>通过发送HTTP请求到相应的端点，可以执行各种Docker操作，并管理Docker中的镜像和容器。Docker REST API还提供了对网络、数据卷、日志和事件等方面的管理能力。</p><p>需要注意的是，为了使用Docker REST  API，用户需要对Docker守护进程有相应的访问权限，并且需要使用适当的认证和授权机制来保护和限制对Docker  API的访问。此外，可以使用各种客户端工具或库来方便地与Docker REST API进行交互，例如Docker CLI、Docker  SDK和第三方HTTP客户端等。</p><p><strong>rest接口是什么</strong></p><p>REST（Representational State  Transfer&#x2F;代表性状态转移）是一种基于网络的软件架构风格，用于设计分布式系统和网络应用程序。RESTful接口是遵循REST原则设计的应用程序接口，它使用标准的HTTP方法（如GET、POST、PUT、DELETE）和状态码来实现资源的增删改查操作。</p><p>RESTful接口的特点包括：</p><ol><li>资源：通过URL来代表资源，每个资源通过唯一的URL来标识。</li><li>HTTP方法：使用标准的HTTP方法来实现对资源的操作，例如GET用于获取资源，POST用于创建资源，PUT用于更新资源，DELETE用于删除资源。</li><li>状态码：使用标准的HTTP状态码来表示操作的结果，例如200表示成功，404表示资源不存在，400表示请求错误等。</li><li>无状态性：每个请求包含了足够的信息来处理该请求，服务端不会保存客户端的状态信息。</li></ol><p>RESTful接口通常以JSON或XML格式返回数据，使得客户端和服务端可以使用统一的格式进行数据交换。</p><p>总之，RESTful接口是一种基于REST原则设计的应用程序接口，它使用标准的HTTP方法和状态码来实现对资源的操作，提供了一种简洁、灵活和可扩展的方式来进行网络通信和数据交换。</p><h2 id="docker客户端"><a href="#docker客户端" class="headerlink" title="docker客户端"></a>docker客户端</h2><p>Docker Client是一个命令行工具，用于与Docker守护进程进行交互，执行各种Docker操作，如创建、启动、停止和删除容器，构建和管理镜像，以及管理网络和数据卷等。</p><p>通过Docker Client，用户可以使用命令行来与Docker守护进程进行通信，并执行各种操作。Docker Client提供了一组命令，用于管理Docker中的镜像、容器、网络、数据卷以及其他资源。</p><p>一些常用的Docker Client命令包括：</p><ul><li><code>docker run</code>：创建并启动一个新的容器</li><li><code>docker build</code>：构建一个新的镜像</li><li><code>docker pull</code>：从远程仓库拉取镜像</li><li><code>docker ps</code>：列出当前正在运行的容器</li><li><code>docker images</code>：列出Docker中的镜像</li><li><code>docker network</code>：管理Docker中的网络</li><li><code>docker volume</code>：管理Docker中的数据卷</li></ul><p>用户可以通过在命令行中输入相应的<code>docker</code>命令来使用Docker Client进行各种操作。此外，Docker Client也可以与Docker REST API进行交互，通过发送HTTP请求来执行各种操作。</p><p>除了命令行工具，还可以使用Docker Client的API来与Docker守护进程进行编程式的交互，以便在自动化脚本或应用程序中进行Docker操作。</p><p>总之，Docker Client是一个命令行工具，提供了一种方便的方式来与Docker守护进程进行交互，并执行各种Docker操作。</p><h2 id="docker镜像"><a href="#docker镜像" class="headerlink" title="docker镜像"></a>docker镜像</h2><p><strong>镜像</strong></p><p>‌<a href="https://www.baidu.com/s?wd=Docker%E9%95%9C%E5%83%8F&usm=3&ie=utf-8&rsv_pq=a922fa4300080eef&oq=docker%E9%95%9C%E5%83%8F%E6%98%AF%E4%BB%80%E4%B9%88&rsv_t=8f2aK40rLRjyZ1mG2Af3J+05hA7lbOycru7dE3YJtbIikkFO+sEg89lziVo&sa=re_dqa_zy">Docker镜像</a>是一个特殊的文件系统，它包含了运行一个应用程序所需的所有文件、库、资源、配置等，以及一些为运行时准备的其他配置参数，如环境变量、用户等。镜像不包含任何动态数据，其内容在构建之后不会改变。镜像和‌<a href="https://www.baidu.com/s?wd=%E5%AE%B9%E5%99%A8&usm=3&ie=utf-8&rsv_pq=a922fa4300080eef&oq=docker%E9%95%9C%E5%83%8F%E6%98%AF%E4%BB%80%E4%B9%88&rsv_t=8f2aK40rLRjyZ1mG2Af3J+05hA7lbOycru7dE3YJtbIikkFO+sEg89lziVo&sa=re_dqa_zy">容器</a>之间的关系可以比喻为面向对象程序设计中的类和实例关系，其中镜像是静态的定义，而容器是镜像运行时的实体。Docker利用容器来运行应用，容器是从镜像创建的运行实例，它可以被启动、停止、删除，每个容器都是互相隔离的，保证安全的平台。Docker镜像可以是基于某个基础镜像构建的，这样可以实现资源的共享，例如多个镜像都从相同的‌<a href="https://www.baidu.com/s?wd=base%E9%95%9C%E5%83%8F&usm=3&ie=utf-8&rsv_pq=a922fa4300080eef&oq=docker%E9%95%9C%E5%83%8F%E6%98%AF%E4%BB%80%E4%B9%88&rsv_t=8f2aK40rLRjyZ1mG2Af3J+05hA7lbOycru7dE3YJtbIikkFO+sEg89lziVo&sa=re_dqa_zy">base镜像</a>构建而来时，宿主机只需在磁盘上保存一份base镜像，同时内存中也只需加载一份base镜像，就可以为所有容器服务。‌</p><p>‌[Docker Hub](<a href="https://www.baidu.com/s?wd=Docker">https://www.baidu.com/s?wd=Docker</a> Hub&amp;usm&#x3D;3&amp;ie&#x3D;utf-8&amp;rsv_pq&#x3D;a922fa4300080eef&amp;oq&#x3D;docker镜像是什么&amp;rsv_t&#x3D;8f2aK40rLRjyZ1mG2Af3J%2B05hA7lbOycru7dE3YJtbIikkFO%2BsEg89lziVo&amp;sa&#x3D;re_dqa_zy)是最大的公开Docker镜像仓库，存放了数量庞大的镜像供用户下载。用户可以在Docker Hub上找到并下载各种预定义的镜像，也可以上传自己创建的镜像。此外，Docker Hub还支持私有仓库，允许用户创建和管理自己的镜像仓库。‌4</p><p>关于Docker Hub（dockerhub）的详细解释，可以参考相关官方文档或教程，以获取更全面的信息。</p><h2 id="docker分层存储"><a href="#docker分层存储" class="headerlink" title="docker分层存储"></a>docker分层存储</h2><p>分层存储是一种将文件系统以层叠方式组织的技术。在Docker中，镜像和容器都是使用分层存储来管理文件系统的。</p><p>当您构建一个Docker镜像时，每个指令（比如COPY、RUN等）都会产生一个新的只读层。这些只读层会以一种类似于增量的方式堆叠在一起，每一层都包含了文件系统的某个部分或变更。当您启动一个容器时，Docker会在镜像的顶部再添加一个可写层，用于存储容器内的文件变更。</p><p>这种分层存储的方式有很多好处，包括：</p><ol><li>节省存储空间：由于每一层都是只读的，并且可以被多个镜像共享，所以可以节省存储空间。</li><li>加速镜像构建和传输：只有在发生变更时才需要下载或传输某一层，而不需要整个镜像的重新下载。</li><li>提高镜像的可复用性：不同镜像可以共享相同的层，减少了冗余的数据。</li></ol><p>总的来说，分层存储使得Docker镜像更加高效、可复用，并减少了存储和传输成本</p><h2 id="docker镜像仓库"><a href="#docker镜像仓库" class="headerlink" title="docker镜像仓库"></a>docker镜像仓库</h2><p>Docker镜像仓库是用于存储和管理Docker镜像的中心化平台。镜像仓库可以分为公共仓库和私有仓库。</p><ol><li>公共仓库：公共仓库是供广大用户共享和获取Docker镜像的平台。其中最知名的是Docker  Hub，是Docker官方提供的公共镜像仓库，用户可以在其中上传、下载和管理镜像，也可以通过Docker  Hub搜索并获取其他用户共享的镜像。公共仓库还包括其他一些第三方提供的公共镜像仓库，如Google Container  Registry和Quay.io等。</li><li>私有仓库：私有仓库是用户自己搭建或者使用第三方提供的用于存储和管理私有镜像的平台。私有仓库可以提供更高的安全性和隐私性，用户可以在其中存储和管理自己的镜像，并且控制访问权限。Docker官方提供了一个开源的私有仓库解决方案，称为Docker Registry，用户可以将其部署在自己的服务器上。此外，还有其他一些第三方提供的私有镜像仓库解决方案，如Harbor等。</li></ol><p>总之，Docker镜像仓库是用于存储和管理Docker镜像的平台，用户可以选择使用公共仓库来共享和获取镜像，也可以搭建私有仓库来管理自己的私有镜像。</p><p><strong>docker_registry</strong></p><p>registry是Docker镜像的存储和分发系统，它允许用户存储和管理Docker镜像，并提供了简单的命令行接口来上传和下载镜像。Registry可以是公共的，也可以是私有的，用户可以选择在公共Registry上分享他们的镜像，或者在私有Registry上存储和管理他们的镜像。</p><p>Docker  Hub是最常用的公共Registry之一，它包含了大量的公共Docker镜像，并提供了一个中心化的平台来分享和发现镜像。除了Docker  Hub之外，还有其他一些公共Registry，如Google Container Registry，Quay.io等。</p><p>此外，用户也可以搭建自己的私有Registry，以便于存储和管理自己的镜像，同时也可以提高镜像的安全性和隐私性。Docker官方提供了一个开源的Registry实现，称为Docker Registry，用户可以将其部署在自己的服务器上，或者也可以使用其他第三方提供的私有Registry解决方案。</p><p>总之，Registry是Docker镜像的中心化存储和分发平台，为用户提供了方便的方式来管理和分享Docker镜像。</p><h2 id="docker容器实例"><a href="#docker容器实例" class="headerlink" title="docker容器实例"></a>docker容器实例</h2><p>Docker容器实例是Docker容器的一个具体运行实体。在Docker中，容器实例是由Docker引擎根据Docker镜像创建的、可运行的容器。每个容器实例都是一个独立、隔离的环境，包含了应用程序及其依赖项，可以在宿主系统上独立运行。</p><p>容器实例是由Docker镜像实例化而来的，每个镜像可以被实例化为一个或多个容器实例。容器实例可以被启动、停止、删除等操作，而且可以通过网络进行通信，共享宿主系统的资源，提供了一种轻量级、可移植的应用程序部署和管理方式。</p><p>在使用Docker时，用户可以通过Docker命令或Docker API创建、管理和运行容器实例，实现了应用程序的快速部署和运维。容器实例的隔离性、轻量级和可移植性使得它成为一种流行的应用程序打包和部署技术。</p><p><strong>容器实例与镜像</strong></p><p>镜像是一个可执行的软件包，其中包含了运行应用程序所需的一切，包括代码、运行时环境、系统工具、库和设置。镜像是只读的，可以共享和重用，并且可以通过层叠的方式构建。镜像是用来创建容器的基础，它相当于容器的模板。</p><p>容器是基于镜像创建的运行实例，可以被启动、停止、删除和移动。容器实际上是镜像的一个运行时实例，它包含了镜像的内容以及额外的可写层，从而使得应用程序可以在其中运行。容器提供了一个隔离的执行环境，使得应用程序可以在其中独立地运行，而不受外部环境的影响。</p><p>因此，镜像和容器是密切相关的，镜像提供了容器运行所需的环墋，而容器是实际运行应用程序的实例。镜像可以用来创建多个相同或类似的容器实例，从而实现应用程序的扩展和部署。</p><h1 id="docker引擎工作流程"><a href="#docker引擎工作流程" class="headerlink" title="docker引擎工作流程"></a>docker引擎工作流程</h1><p>Docker主要由三个核心组件组成，它们之间的工作流程通常如下：</p><ol><li>Docker客户端（Docker Client）：用户通过Docker客户端与Docker守护进程通信，发送命令和请求，例如构建、运行、停止和删除容器，管理镜像等操作。</li><li>Docker守护进程（Docker Daemon）：Docker守护进程是一个长期运行的后台进程，负责管理Docker对象，如镜像、容器、网络和数据卷等。它监听来自Docker客户端的API请求，并根据这些请求来执行各种操作。</li><li>Docker镜像（Docker  Image）：Docker镜像是用于创建Docker容器的模板，它包含了一个应用程序运行所需的所有文件和依赖。当用户通过Docker客户端发送构建镜像的命令时，Docker守护进程会根据Dockerfile文件中的指令来构建镜像。</li></ol><p>工作流通常包括以下步骤：</p><ul><li>用户使用Docker客户端发送命令和请求，例如构建镜像、运行容器等操作。</li><li>Docker客户端将命令和请求通过API发送给Docker守护进程。</li><li>Docker守护进程根据接收到的命令和请求，执行相应的操作，例如构建镜像、创建容器、管理网络等。</li><li>Docker守护进程将执行结果返回给Docker客户端，用户可以通过客户端查看操作的状态和结果。</li></ul><p>这些组件之间的工作流程是相互协作的，用户通过Docker客户端与Docker守护进程进行交互，Docker守护进程负责管理Docker对象，执行各种操作以及提供服务，如网络通信、存储、日志等。</p><p><img src="/image-20240717185736530.png" alt="image-20240717185736530"></p><h1 id="docker创建容器工作流程"><a href="#docker创建容器工作流程" class="headerlink" title="docker创建容器工作流程"></a>docker创建容器工作流程</h1><ol><li>拉取镜像：首先，Docker引擎会检查本地是否已经存在所需的Docker镜像。如果本地不存在，它会从配置的镜像仓库（如Docker Hub）拉取所需的镜像。</li><li>创建容器：一旦镜像被拉取到本地，Docker引擎会使用该镜像创建一个新的容器实例。在创建容器时，可以指定一系列配置选项，例如端口映射、环境变量、数据卷挂载等。</li><li>启动容器：一旦容器被创建，Docker引擎会启动该容器。这意味着容器中的进程将会开始运行，并可以开始提供所需的服务。</li><li>执行应用程序：一旦容器启动，其中的应用程序或服务将会开始执行。这可能包括运行Web服务器、数据库、应用程序代码等。</li><li>与容器交互：运行中的容器可以通过Docker引擎提供的命令行工具或API进行交互。这包括查看容器日志、执行命令、停止容器等操作。</li></ol><p>总的来说，Docker工作流程的关键步骤包括拉取镜像、创建容器、启动容器以及与容器进行交互。这些步骤使得Docker容器在不同的环境中能够快速部署和运行应用程</p><h1 id="docker容器隔离功能"><a href="#docker容器隔离功能" class="headerlink" title="docker容器隔离功能"></a>docker容器隔离功能</h1><blockquote><p><strong>容器本质上是把系统中为同一个业务目标服务的相关进程合成一组，放在一个叫做namespace的空间中，同一个namespace中的进程能够互相通信，但看不见其他namespace中的进程。</strong></p><p><strong>一个独立的名称空间，可以简单理解为好比是一个虚拟机的概念。</strong></p><p>Linux 内核上支持的功能namespace用于资源隔离，实现我们的本质需求，实现多个程序的隔离部署，不会相互影响。</p><p>Linux内核实现namespace的主要目的就是为了实现轻量级虚拟化（容器）服务。</p></blockquote><p>Docker中的namespace主要是用来实现容器的隔离。通过隔离容器的进程、网络、文件系统挂载点和用户等资源，namespace确保了容器之间的相互隔离，避免了相互干扰，提供了更加安全和可靠的容器化环境。这种隔离性使得Docker可以更好地支持多个应用程序的并发运行，同时确保了应用程序之间的安全隔离。</p><p>具体来说，namespace的作用包括：</p><ol><li>进程隔离：每个容器有自己独立的进程ID命名空间，确保容器内的进程无法看到主机系统上的其他进程，也无法看到其他容器内的进程，从而实现了进程级别的隔离。</li><li>网络隔离：每个容器有自己独立的网络命名空间，使得容器可以拥有自己的网络接口、IP地址、路由表等网络资源，避免了网络资源的冲突，并确保容器之间可以相互通信。</li><li>文件系统挂载点隔离：每个容器有自己独立的挂载点命名空间，确保了容器可以拥有自己的文件系统挂载点，而不会影响到其他容器或主机系统上的挂载点。</li><li>用户隔离：每个容器有自己独立的用户命名空间，确保了容器内的用户和组与主机系统上的用户和组隔离开来，增强了容器的安全性。</li></ol><p>总之，通过namespace的隔离机制，Docker可以提供一个更加安全、稳定和可靠的容器化环境，支持多个应用程序的并发运行，并确保了应用程序之间的安全隔离。</p><h1 id="docker控制分配系统资源"><a href="#docker控制分配系统资源" class="headerlink" title="docker控制分配系统资源"></a>docker控制分配系统资源</h1><blockquote><p>此外，为了限制namespace对物理资源的使用，对进程能使用的CPU、内存等资源需要做一定的限制。</p><p>这就是Cgroup技术，Cgroup是Control group的意思。</p><p>比如我们常说的4c4g的容器，实际上是限制这个容器namespace中所用的进程，最多能够使用4核的计算资源和4GB的内存。</p><p><strong>简而言之，Linux内核提供namespace完成隔离，Cgroup完成资源限制。namespace+Cgroup构成了容器的底层技术（rootfs是容器文件系统层技术）。</strong></p><blockquote><p>docker容器进程的本质：</p><ol><li>开辟namespace独立的空间</li><li>基于cgroup控制容器进程占用的计算资源</li><li>基于rootfs提供文件系统</li></ol></blockquote></blockquote><p>Docker中的cgroups（Control  Groups）是Linux内核提供的一种机制，用于限制、控制和分配系统资源，包括CPU、内存、磁盘I&#x2F;O等，以便在容器环境中实现资源的隔离和管理。cgroups使得Docker能够对容器内的资源使用进行限制和分配，从而实现对容器的资源隔离和管理。</p><p>具体来说，Docker中的cgroups可以实现以下功能：</p><ol><li>CPU资源限制：可以限制容器所能使用的CPU资源，包括CPU的时间片和核心数等，防止容器占用过多的CPU资源而影响其他容器或主机系统。</li><li>内存资源限制：可以限制容器所能使用的内存资源，包括内存的总量、使用的最大限制等，避免容器使用过多内存而导致系统性能下降或者其他容器受影响。</li><li>磁盘I&#x2F;O资源控制：可以限制容器对磁盘的I&#x2F;O操作，包括读取和写入速率的控制，避免容器对磁盘I&#x2F;O的过度使用而影响其他容器或主机系统。</li><li>网络资源限制：可以限制容器的网络带宽使用，包括上传和下载速率的控制，防止容器对网络资源的过度占用。</li></ol><p>通过使用cgroups，Docker可以对容器的资源使用进行有效控制和管理，实现资源的隔离和分配，从而确保容器之间可以相互独立运行，避免了资源的竞争和冲突，提高了容器化环境的安全性和稳定性。</p><h1 id="docker总结"><a href="#docker总结" class="headerlink" title="docker总结"></a>docker总结</h1><ul><li>为了提供一种更加轻量的虚拟化技术，docker出现了</li><li>借助于docker容器的轻、快等特性，解决了软件交付过程中的环境依赖问题，使得docker得以快速发展</li><li>Docker是一种CS架构的软件产品，可以把代码及依赖打包成镜像，作为交付介质，并且把镜像启动成为容器，提供容器生命周期的管理</li><li>docker-ce，每季度发布stable版本。18.06，18.09，19.03</li><li>发展至今，docker已经通过制定OCI标准对最初的项目做了拆分，其中runC和containerd是docker的核心项目，理解docker整个请求的流程，对我们深入理解docker有很大的帮助</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;服务部署技术的演变&quot;&gt;&lt;a href=&quot;#服务部署技术的演变&quot; class=&quot;headerlink&quot; title=&quot;服务部署技术的演变&quot;&gt;&lt;/a&gt;服务部署技术的演变&lt;/h1&gt;&lt;h2 id=&quot;服务器部署应用&quot;&gt;&lt;a href=&quot;#服务器部署应用&quot; class=&quot;he</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-授权管理</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86/</id>
    <published>2024-08-20T01:23:55.000Z</published>
    <updated>2024-08-20T01:24:08.995Z</updated>
    
    <content type="html"><![CDATA[<h1 id="systemctl管理数据库"><a href="#systemctl管理数据库" class="headerlink" title="systemctl管理数据库"></a>systemctl管理数据库</h1><blockquote><p>:warning:若有&#x2F;etc&#x2F;init.d&#x2F;中有mysql管理的脚本，再配置systemctl管理，会导致冲突</p></blockquote><h2 id="1-书写管理配置文件"><a href="#1-书写管理配置文件" class="headerlink" title="1.书写管理配置文件"></a>1.书写管理配置文件</h2><blockquote><p>进入&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;下，书写配置文件</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /usr/lib/systemd/system/mysqld</span><br><span class="line"><span class="comment">#服务注释及优先启动应用</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=mysql server by www.yuchaoit.cn</span><br><span class="line">Documentation=man:mysqld(8)</span><br><span class="line">Documentation=https://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">After=network.target</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line"><span class="comment">#linux运行模式，多用户文本模式</span></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务启动配置</span></span><br><span class="line">[Service]</span><br><span class="line"><span class="comment">#启动时进程所属主组</span></span><br><span class="line">User=mysql</span><br><span class="line">Group=mysql</span><br><span class="line"><span class="comment">#启动命令，调用mysqld指定mysql配置进行启动</span></span><br><span class="line">ExecStart=/app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">LimitNOFILE=5000</span><br></pre></td></tr></table></figure><h2 id="2-修改数据库配置文件"><a href="#2-修改数据库配置文件" class="headerlink" title="2.修改数据库配置文件"></a>2.修改数据库配置文件</h2><blockquote><p>mysql程序启动时会根据配置文件中参数信息进行运行</p><p>所有变量名都是mysql内置的，需要遵寻mysql变量名格式，不能自己胡乱定义</p><p>变量定义的文件路径注意是否有权限</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/my.cnf</span><br><span class="line"><span class="comment">#服务端</span></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#运行端口</span></span><br><span class="line">port=3306</span><br><span class="line"><span class="comment">#运行用户</span></span><br><span class="line">user=mysql</span><br><span class="line"><span class="comment">#应用安装目录</span></span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line"><span class="comment">#数据存放目录</span></span><br><span class="line">datadir=/app/data/3306</span><br><span class="line"><span class="comment">#进程套接字输出文件</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"><span class="comment">#错误日志输出文件</span></span><br><span class="line">log-error=/app/tools/mysql/3306_error.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端</span></span><br><span class="line">[mysql]</span><br><span class="line"><span class="comment">#自动调用服务端socket文件连接，无需命令-S指定</span></span><br><span class="line">socket=/tmp/mysql.sock  </span><br></pre></td></tr></table></figure><h2 id="3-systemctl进行管理"><a href="#3-systemctl进行管理" class="headerlink" title="3.systemctl进行管理"></a>3.systemctl进行管理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重新加载systemctl管理的配置文件</span></span><br><span class="line">[root@db-51 ~]#systemctl daemon-reload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#systemctl管理mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl start mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@db-51 ~]#ss -tunlp|grep mysql</span><br><span class="line">tcp    LISTEN     0      80     [::]:3306               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">124952</span>,fd=<span class="number">28</span>))</span><br><span class="line">[root@db-51 ~]#ps -ef|grep mysql</span><br><span class="line">mysql    124952      1  0 16:43 ?        00:00:01 /app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">root     125449 122725  0 16:51 pts/1    00:00:00 grep --color=auto mysql</span><br></pre></td></tr></table></figure><h2 id="4-数据库配置文件详解"><a href="#4-数据库配置文件详解" class="headerlink" title="4.数据库配置文件详解"></a>4.数据库配置文件详解</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]                    <span class="comment"># 服务端标签</span></span><br><span class="line">port=3306                   <span class="comment"># 端口</span></span><br><span class="line">server_id                   <span class="comment"># 主机编号，用于主从复制</span></span><br><span class="line">user=mysql                  <span class="comment"># 内置运行用户</span></span><br><span class="line">basedir=/opt/mysql          <span class="comment"># 软件目录</span></span><br><span class="line">datadir=/www.yuchaoit.cn/mysql_3306    <span class="comment"># 数据目录</span></span><br><span class="line">socket=/tmp/mysql.sock      <span class="comment"># 套接字文件路径</span></span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock      <span class="comment"># mysql客户端连接数据库，默认读取的socket文件路径</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置语法</span></span><br><span class="line">[server]                <span class="comment">#服务端读取的配置</span></span><br><span class="line">[mysqld]                <span class="comment">#mysqld进程读取的配置</span></span><br><span class="line">[mysqld_safe]       <span class="comment"># mysqld_safe脚本会加载的配置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端配置参数</span></span><br><span class="line">[mysql]        <span class="comment">#客户端命令读取的设置</span></span><br><span class="line">[client]    <span class="comment">#所有本地客户端读取的设置</span></span><br><span class="line">[mysqldump]    <span class="comment">#备份命令读取的设置</span></span><br></pre></td></tr></table></figure><h1 id="数据库远程管理"><a href="#数据库远程管理" class="headerlink" title="数据库远程管理"></a>数据库远程管理</h1><blockquote><p>授权登录mysql语法</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grant 授予什么权限 privileges on  授权库.授权表 to 授权用户@&#x27;授权网段限制&#x27; identified by &#x27;用户密码&#x27;;</span><br></pre></td></tr></table></figure><h2 id="1-本地连接"><a href="#1-本地连接" class="headerlink" title="1.本地连接"></a>1.本地连接</h2><h3 id="1-1-创建用户授权本地连接"><a href="#1-1-创建用户授权本地连接" class="headerlink" title="1.1 创建用户授权本地连接"></a>1.1 创建用户授权本地连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#登录root用户进入数据库</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户zhao，授予所有库表所有权限，密码1</span></span><br><span class="line">mysql&gt; grant all privileges on *.* to zhao@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看mysql用户表</span></span><br><span class="line"><span class="comment">#创建的用户都被保存到了，mysql库中的user表中，</span></span><br><span class="line"><span class="comment">#查看mysql库中user表中，user用户与host网段限制，字段信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host mysql.user;</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| zhao          | localhost |</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">+---------------+-----------+</span><br></pre></td></tr></table></figure><h3 id="1-2-查看某库中所有表"><a href="#1-2-查看某库中所有表" class="headerlink" title="1.2 查看某库中所有表"></a>1.2 查看某库中所有表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.直接查看mysql库中所有表</span></span><br><span class="line">mysql&gt; show tables from mysql;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.先进入mysql库，再查看所有表</span></span><br><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.查看当前在哪个库中</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> database();</span><br><span class="line">+------------+</span><br><span class="line">| database() |</span><br><span class="line">+------------+</span><br><span class="line">| mysql      |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure><h3 id="1-3-本地网络套接字登录"><a href="#1-3-本地网络套接字登录" class="headerlink" title="1.3 本地网络套接字登录"></a>1.3 本地网络套接字登录</h3><blockquote><p>使用创建的zhao用户基于网络套接字ip:port登录</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#密码交互式</span></span><br><span class="line">[root@db-51 ~]#mysql -uzhao -p -h127.0.0.1 -P3306 -e <span class="string">&quot;show databases;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#密码不交互</span></span><br><span class="line">[root@db-51 ~]#mysql -uzhao -p1 -h127.0.0.1 -P3306 -e <span class="string">&quot;show databases;&quot;</span></span><br></pre></td></tr></table></figure><h3 id="1-4-本地进程套接字登录"><a href="#1-4-本地进程套接字登录" class="headerlink" title="1.4 本地进程套接字登录"></a>1.4 本地进程套接字登录</h3><blockquote><p>:warning:注意使用本地套接字连接mysql服务端，权限限制的网段必须是localhost</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#mysql -uzhao -p1 -S/tmp/mysql.sock -e <span class="string">&quot;select user,host from mysql.user&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">| zhao          | localhost |</span><br><span class="line">+---------------+-----------+</span><br></pre></td></tr></table></figure><h2 id="2-远程连接"><a href="#2-远程连接" class="headerlink" title="2.远程连接"></a>2.远程连接</h2><h3 id="2-1-创建用户授权远程连接"><a href="#2-1-创建用户授权远程连接" class="headerlink" title="2.1 创建用户授权远程连接"></a>2.1 创建用户授权远程连接</h3><blockquote><p>只允许yuchao用户在 10.0.0.x 网段登录，有最大的权限</p><p>:warning:授权语句只能用root去操作</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用root创建zhao用户并授权，%代表0~255整个网段</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -e <span class="string">&quot;grant all privileges on *.* to zhao@&#x27;10.0.0.%&#x27; identified by &#x27;1&#x27;&quot;</span></span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure><h3 id="2-2-远程登录查看登录用户信息"><a href="#2-2-远程登录查看登录用户信息" class="headerlink" title="2.2 远程登录查看登录用户信息"></a>2.2 远程登录查看登录用户信息</h3><blockquote><p>使用10.0.0.1~10.0.0.254网段内机器进行远程连接db-51服务端</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用web-7机器</span></span><br><span class="line">[root@web-7 ~]#hostname -I</span><br><span class="line">10.0.0.7 172.16.1.7 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#远程登录，查看当前登录用户信息</span></span><br><span class="line">[root@web-7 ~]#mysql -uzhao -p1 -h10.0.0.51 -P3306 -e <span class="string">&quot;select user();&quot;</span></span><br><span class="line">+---------------+</span><br><span class="line">| user()        |</span><br><span class="line">+---------------+</span><br><span class="line">| zhao@10.0.0.7 |</span><br><span class="line">+---------------+</span><br></pre></td></tr></table></figure><h3 id="2-3-远程工具图形化连接"><a href="#2-3-远程工具图形化连接" class="headerlink" title="2.3 远程工具图形化连接"></a>2.3 远程工具图形化连接</h3><blockquote><p>可以图形化连接服务端数据库，鼠标点点点进行数据库表管理</p><p>sqlyog，navicat，收费</p><p>workbench（官方出品），dbeaver，免费</p></blockquote><p>workench</p><p>下载：<a href="https://dev.mysql.com/downloads/file/?id=525959">https://dev.mysql.com/downloads/file/?id=525959</a></p><p><img src="/image-20240529185845776.png" alt="image-20240529185845776"></p><h3 id="2-4-服务端查看tcp连接"><a href="#2-4-服务端查看tcp连接" class="headerlink" title="2.4 服务端查看tcp连接"></a>2.4 服务端查看tcp连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#web-7远程连接mysql服务端后，在服务端db-51查看tcp连接进程</span></span><br><span class="line"><span class="comment">#可以看到web-7与db-51建立了tcp连接，因为web-7基于ip:prot远程进行连接</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db-51 ~]#netstat -an|grep 10.0.0.7</span><br><span class="line">tcp6       0      0 10.0.0.51:3306          10.0.0.7:41058          ESTABLISHED</span><br></pre></td></tr></table></figure><h1 id="数据库用户管理"><a href="#数据库用户管理" class="headerlink" title="数据库用户管理"></a>数据库用户管理</h1><blockquote><p>mysql用户</p><ul><li>登录mysql服务端</li><li>基于用户权限管理mysql中库表数据</li></ul></blockquote><h2 id="1-用户白名单语法"><a href="#1-用户白名单语法" class="headerlink" title="1.用户白名单语法"></a>1.用户白名单语法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法</span></span><br><span class="line">grant all privileges on *.* to 用户@<span class="string">&#x27;白名单限制&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@&#x27;localhost&#x27;  可以在本地登录，并且可以通过socket登录</span></span><br><span class="line"><span class="string">@&#x27;10.0.0.10&#x27;  只能在10.0.0.10这个客户端登录</span></span><br><span class="line"><span class="string">@&#x27;10.0.0.%&#x27;   只能在10.0.0.xx/24网段登录</span></span><br><span class="line"><span class="string">@&#x27;10.0.0.5%&#x27;  只能在10.0.0.50~59 登录</span></span><br><span class="line"><span class="string">@&#x27;%&#x27;          可以在任意地址登录该mysql服务端（常用）</span></span><br><span class="line"><span class="string">@&#x27;db-51&#x27;      基于主机名的登录限制（了解）</span></span><br></pre></td></tr></table></figure><h2 id="2-查看数据库用户表数据"><a href="#2-查看数据库用户表数据" class="headerlink" title="2.查看数据库用户表数据"></a>2.查看数据库用户表数据</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select 查看表</span></span><br><span class="line"><span class="comment">#user,host,authentication_string 用户名,白名单,密码加密后密文</span></span><br><span class="line"><span class="comment">#from mysql.user 查看mysql库的user表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost |                                           |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| zhao          | 127.0.0.1 | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| zhao          | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| zhao          | 10.0.0.%  | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-创建用户密码"><a href="#3-创建用户密码" class="headerlink" title="3.创建用户密码"></a>3.创建用户密码</h2><blockquote><p>只创建用户不设置密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户，不创建密码</span></span><br><span class="line">mysql&gt; create user chaoge@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看user表字段信息，无密码加密后的密文</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| chaoge        | localhost |                                           |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br></pre></td></tr></table></figure><blockquote><p>创建用户并设置密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户设置密码</span></span><br><span class="line">mysql&gt; create user chaoge01@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看用户表中用户、白名单、密码加密字段信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span>  user,host,authentication_string  from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| chaoge        | localhost |                                           |</span><br><span class="line">| chaoge01      | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="4-root修改其他用户密码"><a href="#4-root修改其他用户密码" class="headerlink" title="4.root修改其他用户密码"></a>4.root修改其他用户密码</h2><blockquote><p>修改密码语法：</p><p>alter      user      用户@’白名单’     identified        by       ‘密码’；</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#字符串2加密后密文</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> password(<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;2&#x27;</span>)                             |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#给chaoge用户修改密码</span></span><br><span class="line">mysql&gt; alter user chaoge@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看用户修改后信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| chaoge        | localhost | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">| chaoge01      | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#set语句修改</span></span><br><span class="line"><span class="built_in">set</span> password <span class="keyword">for</span> chaoge@<span class="string">&#x27;localhost&#x27;</span>=password(<span class="string">&#x27;2&#x27;</span>);</span><br></pre></td></tr></table></figure><h2 id="5-普通用户修改自己密码"><a href="#5-普通用户修改自己密码" class="headerlink" title="5.普通用户修改自己密码"></a>5.普通用户修改自己密码</h2><blockquote><p>用户给自己修改密码，使用chaoge01用户登录密码修改为 2</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看字符串加密后密文</span></span><br><span class="line">[root@db-51 ~]#mysql -uchaoge01  -p2 -S /tmp/mysql.sock  -e <span class="string">&quot;select password(&#x27;2&#x27;)&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;2&#x27;</span>)                             |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改密码</span></span><br><span class="line">[root@db-51 ~]#mysql -uchaoge01  -p1 -S /tmp/mysql.sock  </span><br><span class="line">mysql&gt; <span class="built_in">set</span> password=password(<span class="string">&#x27;2&#x27;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>普通用户授予最大权限也无法查看用户表信息，只有root用户可以</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#root用户查看用户表信息</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;select user,host,authentication_string from mysql.user;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| chaoge        | localhost | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">| chaoge01      | localhost | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="6-查看密码加密对应的密文"><a href="#6-查看密码加密对应的密文" class="headerlink" title="6.查看密码加密对应的密文"></a>6.查看密码加密对应的密文</h2><blockquote><p>可以基于如下sql语句，查看某个字符串通过加密后，会生成什么密文</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#字符串1加密</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> password(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;1&#x27;</span>)                             |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#字符串123加密</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> password(<span class="string">&#x27;123&#x27;</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;123&#x27;</span>)                           |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *23AE809DDACAF96AF0FD78ED04B6A265E05AA257 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="7-root删除普通用户"><a href="#7-root删除普通用户" class="headerlink" title="7.root删除普通用户"></a>7.root删除普通用户</h2><blockquote><p>语法：</p><p>drop   user    用户名@’白名单’；</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前用户信息</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;select user,host from mysql.user;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| zhao          | 10.0.0.%  |</span><br><span class="line">| zhao          | 127.0.0.1 |</span><br><span class="line">| chaoge        | localhost |</span><br><span class="line">| chaoge01      | localhost |</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">| zhao          | localhost |</span><br><span class="line">+---------------+-----------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;dorp user zhao@&#x27;10.0.0.%&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;drop user zhao@&#x27;10.0.0.%&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;drop user zhao@&#x27;127.0.0.1&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;drop user chaoge@&#x27;localhost&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;drop user zhao@&#x27;localhost&#x27;;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot  -p -S /tmp/mysql.sock  -e <span class="string">&quot;select user,host from mysql.user;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-----------+</span><br><span class="line">| user          | host      |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| mysql.session | localhost |</span><br><span class="line">| mysql.sys     | localhost |</span><br><span class="line">| root          | localhost |</span><br><span class="line">+---------------+-----------+</span><br></pre></td></tr></table></figure><h2 id="8-root用户修改密码"><a href="#8-root用户修改密码" class="headerlink" title="8.root用户修改密码"></a>8.root用户修改密码</h2><ul><li>mysqladmin改密码</li></ul><blockquote><p>mysqladmin：主要用于修改root用户密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#交互</span></span><br><span class="line">[root@db-51 ~]#mysqladmin -uroot -p password </span><br><span class="line">password：旧密码</span><br><span class="line">newpassword：新密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#无交互</span></span><br><span class="line">[root@db-51 ~]#mysqladmin -uroot -p旧密码  password 新密码</span><br></pre></td></tr></table></figure><ul><li>set语句修改</li></ul><blockquote><p>root给其他人修改密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> password <span class="keyword">for</span> chaoge@localhost=password(<span class="string">&#x27;chaoge666&#x27;</span>);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure><ul><li>update语句修改</li></ul><blockquote><p>update：指定表中某个字段某行修改数据</p><p>:warning:注意使用update修改时，加上<strong>where</strong>匹配某行进行修改，若不加直接修改字段下所有信息了</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法： update  库.表（修改哪张表） set   字段（修改哪个字段下的数据）=修改后的数据  where  通过关键信息匹配某行</span></span><br><span class="line"></span><br><span class="line">mysql&gt; update mysql.user <span class="built_in">set</span> authentication_string=password(<span class="string">&quot;www.yuchaoit.cn&quot;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span> and host=<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">刷新后，权限表会更新</span><br></pre></td></tr></table></figure><ul><li>用户修改自己密码</li></ul><blockquote><p>不指定用户与白名单，set语句默认修改当前登录用户的密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> password=password(<span class="string">&#x27;yuchao666&#x27;</span>);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><h1 id="数据库授权管理"><a href="#数据库授权管理" class="headerlink" title="数据库授权管理"></a>数据库授权管理</h1><blockquote><p>授权，可限制mysql的用户，可以执行哪些SQL语句，可以在mysql中做哪些事</p></blockquote><h2 id="1-mysql支持的授权sql"><a href="#1-mysql支持的授权sql" class="headerlink" title="1.mysql支持的授权sql"></a>1.mysql支持的授权sql</h2><blockquote><p>查看权限表支持的授权规则sql语句</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock  -e <span class="string">&quot;show privileges;&quot;</span></span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure><p><img src="/image-20240521201930666.png" alt="image-20240521201930666"></p><h2 id="2-权限表规则sql语句详解"><a href="#2-权限表规则sql语句详解" class="headerlink" title="2.权限表规则sql语句详解"></a>2.权限表规则sql语句详解</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">privileges权限表</span><br><span class="line"></span><br><span class="line">All/All Privileges权限代表全局或者全数据库对象级别的所有权限</span><br><span class="line"></span><br><span class="line">Alter权限代表允许修改表结构的权限，但必须要求有create和insert权限配合。如果是rename表名，则要求有alter和drop原表， create和insert新表的权限</span><br><span class="line"></span><br><span class="line">Alter routine权限代表允许修改或者删除存储过程、函数的权限</span><br><span class="line"></span><br><span class="line">Create权限代表允许创建新的数据库和表的权限</span><br><span class="line"></span><br><span class="line">Create routine权限代表允许创建存储过程、函数的权限</span><br><span class="line"></span><br><span class="line">Create tablespace权限代表允许创建、修改、删除表空间和日志组的权限</span><br><span class="line"></span><br><span class="line">Create temporary tables权限代表允许创建临时表的权限</span><br><span class="line"></span><br><span class="line">Create user权限代表允许创建、修改、删除、重命名user的权限</span><br><span class="line"></span><br><span class="line">Create view权限代表允许创建视图的权限</span><br><span class="line"></span><br><span class="line">Delete权限代表允许删除行数据的权限</span><br><span class="line"></span><br><span class="line">Drop权限代表允许删除数据库、表、视图的权限，包括<span class="built_in">truncate</span> table命令</span><br><span class="line"></span><br><span class="line">Event权限代表允许查询，创建，修改，删除MySQL事件</span><br><span class="line"></span><br><span class="line">Execute权限代表允许执行存储过程和函数的权限</span><br><span class="line"></span><br><span class="line">File权限代表允许在MySQL可以访问的目录进行读写磁盘文件操作，可使用的命令包括load data infile,<span class="keyword">select</span> … into outfile,load file()函数</span><br><span class="line"></span><br><span class="line">Grant option权限代表是否允许此用户授权或者收回给其他用户你给予的权限,重新付给管理员的时候需要加上这个权限</span><br><span class="line"></span><br><span class="line">Index权限代表是否允许创建和删除索引</span><br><span class="line"></span><br><span class="line">Insert权限代表是否允许在表里插入数据，同时在执行analyze table,optimize table,repair table语句的时候也需要insert权限</span><br><span class="line"></span><br><span class="line">Lock权限代表允许对拥有<span class="keyword">select</span>权限的表进行锁定，以防止其他链接对此表的读或写</span><br><span class="line"></span><br><span class="line">Process权限代表允许查看MySQL中的进程信息，比如执行show processlist, mysqladmin processlist, show engine等命令</span><br><span class="line"></span><br><span class="line">Reference权限是在5.7.6版本之后引入，代表是否允许创建外键</span><br><span class="line"></span><br><span class="line">Reload权限代表允许执行flush命令，指明重新加载权限表到系统内存中，refresh命令代表关闭和重新开启日志文件并刷新所有的表</span><br><span class="line"></span><br><span class="line">Replication client权限代表允许执行show master status,show slave status,show binary logs命令</span><br><span class="line"></span><br><span class="line">Replication slave权限代表允许slave主机通过此用户连接master以便建立主从复制关系</span><br><span class="line"></span><br><span class="line">Select权限代表允许从表中查看数据，某些不查询表数据的<span class="keyword">select</span>执行则不需要此权限，如Select 1+1， Select PI()+2；而且<span class="keyword">select</span>权限在执行update/delete语句中含有<span class="built_in">where</span>条件的情况下也是需要的</span><br><span class="line"></span><br><span class="line">Show databases权限代表通过执行show databases命令查看所有的数据库名</span><br><span class="line"></span><br><span class="line">Show view权限代表通过执行show create view命令查看视图创建的语句</span><br><span class="line"></span><br><span class="line">Shutdown权限代表允许关闭数据库实例，执行语句包括mysqladmin shutdown</span><br><span class="line"></span><br><span class="line">Super权限代表允许执行一系列数据库管理命令，包括<span class="built_in">kill</span>强制关闭某个连接命令， change master to创建复制关系命令，以及create/alter/drop server等命令</span><br><span class="line"></span><br><span class="line">Trigger权限代表允许创建，删除，执行，显示触发器的权限</span><br><span class="line"></span><br><span class="line">Update权限代表允许修改表中的数据的权限</span><br><span class="line"></span><br><span class="line">Usage权限是创建一个用户之后的默认权限，其本身代表连接登录权限</span><br></pre></td></tr></table></figure><h2 id="3-grant授权命令语法"><a href="#3-grant授权命令语法" class="headerlink" title="3.grant授权命令语法"></a>3.grant授权命令语法</h2><blockquote><p>grant语句对于未创建的用户，授权的同时可以直接创建用户设置密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助文档</span></span><br><span class="line">mysql&gt; <span class="built_in">help</span> grant;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#语法</span></span><br><span class="line">grant all privileges on *.* to <span class="string">&#x27;yuchaoit&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span> identified by <span class="string">&#x27;chaoge666&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="4-grant语句实践"><a href="#4-grant语句实践" class="headerlink" title="4.grant语句实践"></a>4.grant语句实践</h2><blockquote><p>创建chaoge用户，授予只对 linux库 增删改查权限，允许远程连接登录、</p></blockquote><ul><li><strong>root创建授权</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#root用户创建linux库</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock -e <span class="string">&quot;create database linux;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">[root@db-51 ~]#mysql -uroot -p -S /tmp/mysql.sock -e <span class="string">&quot;show databases;&quot;</span></span><br><span class="line">Enter password: </span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| linux              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#root用户创建并授权chaoge用户，对于linux库可以增删改查，并且可以远程连接</span></span><br><span class="line">grant <span class="keyword">select</span>,update,delete,insert on linux.* to chaoge@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#查看创建的chaoge用户权限</span></span><br><span class="line"><span class="string">mysql&gt; show grants for chaoge@&#x27;%&#x27;;</span></span><br><span class="line"><span class="string">+-------------------------------------------------------------------+</span></span><br><span class="line"><span class="string">| Grants for chaoge@%                                               |</span></span><br><span class="line"><span class="string">+-------------------------------------------------------------------+</span></span><br><span class="line"><span class="string">| GRANT USAGE ON *.* TO &#x27;chaoge&#x27;@&#x27;%&#x27;                                |</span></span><br><span class="line"><span class="string">| GRANT SELECT, INSERT, UPDATE, DELETE ON `linux`.* TO &#x27;chaoge&#x27;@&#x27;%&#x27; |</span></span><br><span class="line"><span class="string">+-------------------------------------------------------------------+</span></span><br><span class="line"><span class="string">2 rows in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><ul><li><strong>chaoge登录测试</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#只能查看到linux库和一个默认库，其他库并无显示</span></span><br><span class="line">[root@web-7 ~]#mysql -uchaoge -p1 -h10.0.0.51 -P3306</span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| linux              |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5-查看用户权限"><a href="#5-查看用户权限" class="headerlink" title="5.查看用户权限"></a>5.查看用户权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#远程连接，查看当前登录用户权限</span></span><br><span class="line">[root@web-7 ~]#mysql -uchaoge -p1 -h10.0.0.51 -P3306</span><br><span class="line">MySQL [(none)]&gt; show grants <span class="keyword">for</span> chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> chaoge@%                                               |</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                                |</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE, DELETE ON `linux`.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前登录的用户信息</span></span><br><span class="line">MySQL [(none)]&gt; <span class="keyword">select</span> user();</span><br><span class="line">+-----------------+</span><br><span class="line">| user()          |</span><br><span class="line">+-----------------+</span><br><span class="line">| chaoge@10.0.0.7 |</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure><h2 id="6-移除用户权限"><a href="#6-移除用户权限" class="headerlink" title="6.移除用户权限"></a>6.移除用户权限</h2><blockquote><p>使用root用户移除刚才创建的chaoge用户权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前用户权限</span></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> chaoge@%                                               |</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                                |</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE, DELETE ON `linux`.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+-------------------------------------------------------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></blockquote><ul><li>移除chaoge对linux库的删除权限</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#移除</span></span><br><span class="line">mysql&gt; revoke delete on linux.* from chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+-----------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> chaoge@%                                       |</span><br><span class="line">+-----------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                        |</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE ON `linux`.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+-----------------------------------------------------------+</span><br></pre></td></tr></table></figure><ul><li>移除chaoge用户对linux库所有权限</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#移除</span></span><br><span class="line">mysql&gt; revoke all on linux.* from chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> chaoge@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> chaoge@%                |</span><br><span class="line">+------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;chaoge&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#chaoge用户登录检查，看不到任何库</span></span><br><span class="line">[root@web-7 ~]#mysql -uchaoge -p1 -h10.0.0.51 -P3306 -e <span class="string">&quot;show databases;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure><h2 id="7-忘记root密码重置方法"><a href="#7-忘记root密码重置方法" class="headerlink" title="7.忘记root密码重置方法"></a>7.忘记root密码重置方法</h2><blockquote><p>:warning:注意该参数很危险，使用后需要立即关闭，开启后，任何人都可以免密登录到数据库</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">通过skip-grant-tables参数添加，运行mysql，即可跳过权限限制，免密登录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">两种方法：</span><br><span class="line">1.配置文件加入skip-grant-table参数，重启后免密登录进入数据库修改root密码。</span><br><span class="line">2.直接mysqld命令启动mysql，skip-grant-table参数加入到最后，免密登录进入数据库修改root密码。</span><br></pre></td></tr></table></figure><h3 id="1）配置文件添加参数"><a href="#1）配置文件添加参数" class="headerlink" title="1）配置文件添加参数"></a>1）配置文件添加参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#模拟root密码忘记</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p1</span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">ERROR 1045 (28000): Access denied <span class="keyword">for</span> user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (using password: YES)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件添加skip-grant-tables参数</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">######添加到mysqld标签下方</span></span><br><span class="line">skip-grant-tables</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log-error=/app/tools/mysql/3306_error.<span class="built_in">log</span></span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl restart mysqld</span><br><span class="line">[root@db-51 ~]#ss -tunlp|grep 3306</span><br><span class="line">tcp    LISTEN     0      80     [::]:3306               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">21322</span>,fd=<span class="number">28</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#免密登录mysql</span></span><br><span class="line">[root@db-51 ~]#mysql -S /tmp/mysql.sock </span><br><span class="line">mysql&gt; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改root密码，修改为1</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> password(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;1&#x27;</span>)                             |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#set语句不支持修改</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span> password=password(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">ERROR 1290 (HY000): The MySQL server is running with the --skip-grant-tables option so it cannot execute this statement</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#只能使用update语句修改密码，注意使用where语句定义修改行信息</span></span><br><span class="line">mysql&gt; update mysql.user <span class="built_in">set</span> authentication_string=password(<span class="string">&#x27;1&#x27;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span> and host=<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 1</span><br><span class="line">mysql&gt; mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| chaoge        | %         | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#必须删除配置文件跳过权限限制参数</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log-error=/app/tools/mysql/3306_error.<span class="built_in">log</span></span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line"><span class="comment">#并且必须重启</span></span><br><span class="line">[root@db-51 ~]#systemctl restart mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#新密码1，检查登录</span></span><br><span class="line"><span class="comment">##重置成功</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p1 -e <span class="string">&quot;select user,host,authentication_string from mysql.user;&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| chaoge        | %         | *12033B78389744F3F39AC4CE4CCFCAD6960D8EA0 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2）命令启动添加参数"><a href="#2）命令启动添加参数" class="headerlink" title="2）命令启动添加参数"></a>2）命令启动添加参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先关闭当前mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl stop mysqld</span><br><span class="line">[root@db-51 ~]#ss -tunlp|grep mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysqld命令直接启动，最后方加上--skip-grant-tables</span></span><br><span class="line">[root@db-51 ~]#/app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf  --skip-grant-tables &amp;</span><br><span class="line">[1] 22477</span><br><span class="line">[root@db-51 ~]#ps -ef|grep mysql</span><br><span class="line">mysql     22477  16087  3 13:49 pts/0    00:00:00 /app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf --skip-grant-tables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#免密登录mysql，重置root密码为666</span></span><br><span class="line">[root@db-51 ~]#mysql -S /tmp/mysql.sock </span><br><span class="line">mysql&gt; update mysql.user <span class="built_in">set</span> authentication_string=password(<span class="string">&#x27;666&#x27;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span> and host=<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭mysql，重新启动</span></span><br><span class="line">mysql&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">exit</span>;</span><br><span class="line">Bye</span><br><span class="line">[1]+  Done                    /app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf --skip-grant-tables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新启动mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl start mysqld</span><br><span class="line">[root@db-51 ~]#ps -ef|grep mysql</span><br><span class="line">mysql     22845      1  3 13:55 ?        00:00:00 /app/tools/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">root      22887  16087  0 13:55 pts/0    00:00:00 grep --color=auto mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查，重置密码666登录</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p666 -e <span class="string">&quot;select password(&#x27;666&#x27;);&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">&#x27;666&#x27;</span>)                           |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *007D50CA06F69776D307B1BEC71CD73D0EA0999C |</span><br><span class="line">+-------------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="8-授权小结练习"><a href="#8-授权小结练习" class="headerlink" title="8.授权小结练习"></a>8.授权小结练习</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#3306实例创建三个普通账号，授权练习</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. 运维账号给与最大权限，允许远程连接</span><br><span class="line">grant all priveleges on *.*  to zhao@<span class="string">&#x27;%&#x27;</span>  identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">show grants <span class="keyword">for</span> zhao@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.开发账号，只能对开发库有增删改查权限，只允许在10，172两个网段连接</span><br><span class="line">show database dev;</span><br><span class="line">grant  <span class="keyword">select</span>,update,delete,insert  on *dev* to zhao@<span class="string">&#x27;10.0.0.%&#x27;</span> identified  by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">grant  <span class="keyword">select</span>,update,delete,insert  on *dev* to zhao@<span class="string">&#x27;172.1.0.%&#x27;</span> identified  by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">show grants <span class="keyword">for</span> zhao@<span class="string">&#x27;172.1.0.%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.测试账号，只能对测试库增，改，查的权限，且只允许在172内网连接。</span><br><span class="line">grant <span class="keyword">select</span>,update,insert, on <span class="built_in">test</span>.* to zhao@<span class="string">&#x27;172.1.0.%&#x27;</span>  identified by <span class="string">&#x27;1&#x27;</span></span><br><span class="line">show grants <span class="keyword">for</span> zhao@<span class="string">&#x27;172.1.0.%&#x27;</span>;</span><br></pre></td></tr></table></figure><h1 id="阿里云部署数据库授权实战"><a href="#阿里云部署数据库授权实战" class="headerlink" title="阿里云部署数据库授权实战"></a>阿里云部署数据库授权实战</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.阿里云服务器上部署jpreee博客、mysql软件</span><br><span class="line">2.mysql创建jpress使用的库</span><br><span class="line">3.mysql创建授权jpress连接数据库用户密码及对jrepss库的所有权限</span><br><span class="line">4.mysql创建授权navicat工具远程连接用户及密码对jpress库所有权限</span><br><span class="line">5.mysql修改服务端口为23306</span><br><span class="line">5.阿里云防火墙开放jprees应用访问端口8080，开放远程连接端口23306</span><br><span class="line">6.本地windows访问web页面连接数据库初始化安装jpress</span><br><span class="line">7.使用nvicat工具远程连接管理数据库。</span><br></pre></td></tr></table></figure><h2 id="1-部署jpress博客"><a href="#1-部署jpress博客" class="headerlink" title="1. 部署jpress博客"></a>1. 部署jpress博客</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#环境准备</span><br><span class="line">#都选用旧版本，新版本会出现无法编译的bug</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.jpress源码使用5.0</span><br><span class="line">2.jdk环境使用java8版本</span><br><span class="line">3.maven工具使用3.6.x版本</span><br></pre></td></tr></table></figure><h3 id="1-1-云服务器实例准备"><a href="#1-1-云服务器实例准备" class="headerlink" title="1.1 云服务器实例准备"></a>1.1 云服务器实例准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@aliyun ~]# curl ifconfig.me</span><br><span class="line">39.104.200.160</span><br></pre></td></tr></table></figure><h3 id="1-2-jpress源码准备"><a href="#1-2-jpress源码准备" class="headerlink" title="1.2 jpress源码准备"></a>1.2 jpress源码准备</h3><p>官网地址:<a href="https://www.jpress.cn/download">https://www.jpress.cn/download</a></p><p>帮助文档:<a href="http://doc.jpress.cn/manual/linux-tomcat-deploy.html">http://doc.jpress.cn/manual/linux-tomcat-deploy.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装git工具</span></span><br><span class="line">[root@aliyun ~]# yum install git -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#通过gitee代码仓库下载jpress源码</span></span><br><span class="line">[root@aliyun ~]# git <span class="built_in">clone</span> https://gitee.com/JPressProjects/jpress.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#放入源码存放目录</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">mv</span> jpress /app/code</span><br><span class="line">[root@aliyun ~]# <span class="built_in">ls</span> /app/code/jpress/</span><br></pre></td></tr></table></figure><h3 id="1-3-jdk环境准备"><a href="#1-3-jdk环境准备" class="headerlink" title="1.3 jdk环境准备"></a>1.3 jdk环境准备</h3><blockquote><p>开源jdk： yum install java -y 直接安装</p><p>oracle企业jdk： <a href="https://www.oracle.com/cn/java/technologies/downloads/archive/%E5%AE%98%E7%BD%91%E6%89%BE%E5%AF%B9%E5%BA%94%E5%8C%85%E4%B8%8B%E8%BD%BD">https://www.oracle.com/cn/java/technologies/downloads/archive/官网找对应包下载</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这里选用的Java8二进制安装</span></span><br><span class="line"><span class="comment">#下载后，解压放入指定目录，软链接</span></span><br><span class="line">[root@aliyun /app/code/jpress]#ll /app/tools/</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 6 root root 4096 May 23 10:30 apache-maven-3.6.3</span><br><span class="line">drwxr-xr-x 8 root root 4096 May 23 10:13 jdk1.8.0_351</span><br><span class="line">lrwxrwxrwx 1 root root   24 May 23 10:14 jdk8 -&gt; /app/tools/jdk1.8.0_351/</span><br><span class="line">lrwxrwxrwx 1 root root   30 May 23 10:31 maven -&gt; /app/tools/apache-maven-3.6.3/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#加入path环境变量</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/app/tools/jdk8 </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/jre/bin:/app/tools/maven/bin/:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.<span class="variable">$CLASSPATH</span>:<span class="variable">$JAVA_HOME</span>/lib:<span class="variable">$JAVA_HOME</span>/jre/lib:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@aliyun /app/code/jpress]#java -version</span><br><span class="line">java version <span class="string">&quot;1.8.0_351&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_351-b10)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.351-b10, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="1-4-maven工具准备"><a href="#1-4-maven工具准备" class="headerlink" title="1.4 maven工具准备"></a>1.4 maven工具准备</h3><blockquote><p>maven官网下载：</p><p><a href="https://archive.apache.org/dist/maven/maven-3/">https://archive.apache.org/dist/maven/maven-3/</a> </p><p><a href="https://archive.apache.org/dist/maven/maven-4/">https://archive.apache.org/dist/maven/maven-4/</a></p><p>maven清华源下载:</p><p><a href="https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.8.8/binaries/">https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.8.8/binaries/</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这里选用的maven旧版本3.6.3</span></span><br><span class="line"><span class="comment">#下载解压软链接</span></span><br><span class="line">[root@aliyun /app/code/jpress]#ll /app/tools/</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 6 root root 4096 May 23 10:30 apache-maven-3.6.3</span><br><span class="line">drwxr-xr-x 8 root root 4096 May 23 10:13 jdk1.8.0_351</span><br><span class="line">lrwxrwxrwx 1 root root   24 May 23 10:14 jdk8 -&gt; /app/tools/jdk1.8.0_351/</span><br><span class="line">lrwxrwxrwx 1 root root   30 May 23 10:31 maven -&gt; /app/tools/apache-maven-3.6.3/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#maven二进制命令添加到PATH环境变量</span></span><br><span class="line">[root@aliyun /app/code/jpress]#<span class="built_in">tail</span> /etc/profile</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/jre/bin:/app/tools/maven/bin/:<span class="variable">$PATH</span></span><br><span class="line"><span class="comment">##刷新加载</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改maven下载源，默认国外下载，改为阿里云下载源</span></span><br><span class="line">[root@aliyun ~]# vim /app/tools/maven/conf/settings.xml</span><br><span class="line">146   &lt;mirrors&gt;</span><br><span class="line">159     &lt;mirror&gt;</span><br><span class="line">160       &lt;<span class="built_in">id</span>&gt;aliyunmaven&lt;/id&gt;</span><br><span class="line">161       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">162       &lt;name&gt;阿里云公共仓库&lt;/name&gt;</span><br><span class="line">163       &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;</span><br><span class="line">164     &lt;/mirror&gt;</span><br><span class="line">165   &lt;/mirrors&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查mvn命令与jdk环境是否正常</span></span><br><span class="line">[root@aliyun /app/code/jpress]#mvn -v</span><br><span class="line">Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)</span><br><span class="line">Maven home: /app/tools/maven</span><br><span class="line">Java version: 1.8.0_351, vendor: Oracle Corporation, runtime: /app/tools/jdk1.8.0_351/jre</span><br><span class="line">Default locale: en_US, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">&quot;linux&quot;</span>, version: <span class="string">&quot;3.10.0-1160.114.2.el7.x86_64&quot;</span>, <span class="built_in">arch</span>: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;unix&quot;</span></span><br></pre></td></tr></table></figure><h3 id="1-5-mvn编译源码"><a href="#1-5-mvn编译源码" class="headerlink" title="1.5 mvn编译源码"></a>1.5 mvn编译源码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编译并安装依赖，无报错即可</span></span><br><span class="line">mvn clean package</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#找到编译后用于程序启动的jar包</span></span><br><span class="line">[root@aliyun /app/code/jpress]#find ./  -<span class="built_in">type</span> f -name star*jar</span><br><span class="line">./starter-tomcat/target/starter-tomcat-5.0-classes.jar</span><br><span class="line">./starter/target/starter-5.0/lib/starter-5.0.jar</span><br><span class="line">./starter/target/starter-5.0.jar</span><br><span class="line">[root@aliyun /app/code/jpress]#<span class="built_in">ls</span> starter/target/starter-5.0.jar -dl</span><br><span class="line">-rw-r--r-- 1 root root 9170 May 23 10:39 starter/target/starter-5.0.jar</span><br></pre></td></tr></table></figure><p><img src="/image-20240523104819374.png" alt="image-20240523104819374"></p><h3 id="1-6-内置脚本配置启动"><a href="#1-6-内置脚本配置启动" class="headerlink" title="1.6 内置脚本配置启动"></a>1.6 内置脚本配置启动</h3><blockquote><p>该应用内置了管理启停脚本，直接启动，默认前台运行在127.0.0.1地址上，只能本地访问</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#./jpress.sh start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@aliyun ~]# ss -tunlp|grep 8080</span><br><span class="line">tcp    LISTEN     0      128      [::ffff:127.0.0.1]:8080               [::]:*                   <span class="built_in">users</span>:((&quot;java&quot;,pid=<span class="number">2304</span>,fd=<span class="number">245</span>))</span><br><span class="line">[root@aliyun ~]# </span><br><span class="line">[root@aliyun ~]# </span><br><span class="line">[root@aliyun ~]# </span><br><span class="line">[root@aliyun ~]# </span><br><span class="line">[root@aliyun ~]# ps -ef|grep java</span><br><span class="line">root      2304     1  0 11:23 pts/0    00:00:15 java -Djava.awt.headless=<span class="literal">true</span> -Xverify:none -<span class="built_in">cp</span> /app/code/jpress/starter/target/starter-5.0/config:/app/code/jpress/starter/target/starter-5.0/lib/* io.jpress.Starter</span><br></pre></td></tr></table></figure><blockquote><p>修改脚本配置，改为后台运行，并且运行在所有网卡上，可以外网访问</p><p>开启23行和39行配置</p></blockquote><p><img src="/image-20240523120327023.png" alt="image-20240523120327023"></p><blockquote><p>修改后重新启动</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动</span></span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#./jpress.sh start</span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#<span class="built_in">nohup</span>: redirecting stderr to stdout</span><br><span class="line">回车</span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#<span class="built_in">ls</span></span><br><span class="line">config  jpress.bat  jpress.sh  jpress-start.bat  jpress-stop.bat  lib  output.log  webapp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#netstat -tunlp|grep 8080</span><br><span class="line">tcp6       0      0 :::8080                 :::*                    LISTEN      13307/java          </span><br><span class="line">[root@aliyun /app/code/jpress/starter/target/starter-5.0]#ps -ef|grep jav[a]</span><br><span class="line">root     13307     1 20 12:06 pts/1    00:00:04 java -Djava.awt.headless=<span class="literal">true</span> -Xverify:none -Dundertow.port=8080 -Dundertow.host=0.0.0.0 -Dundertow.devMode=<span class="literal">false</span> -<span class="built_in">cp</span> /app/code/jpress/starter/target/starter-5.0/config:/app/code/jpress/starter/target/starter-5.0/lib/* io.jpress.Starte</span><br></pre></td></tr></table></figure><blockquote><p>目前还不能访问，下方配置好阿里云安全组开放端口，配置好数据库，进行web初始化安装jpress</p></blockquote><h2 id="2-部署数据库"><a href="#2-部署数据库" class="headerlink" title="2. 部署数据库"></a>2. 部署数据库</h2><p>mysql官网-二进制包安装地址</p><p><a href="https://downloads.mysql.com/archives/community/">https://downloads.mysql.com/archives/community/</a></p><h3 id="2-1-mysql数据库准备"><a href="#2-1-mysql数据库准备" class="headerlink" title="2.1 mysql数据库准备"></a>2.1 mysql数据库准备</h3><ul><li>版本选择：5.7版二进制安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.下载</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">ls</span></span><br><span class="line">mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.解压</span></span><br><span class="line">[root@aliyun ~]# tar -xf mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz  -C /app/tools/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.软链接</span></span><br><span class="line">[root@aliyun tools]# <span class="built_in">ln</span> -s /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/ /app/tools/mysql</span><br><span class="line">[root@aliyun tools]# ll -d mysql*</span><br><span class="line">lrwxrwxrwx 1 root root   47 May 22 17:46 mysql -&gt; /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x 9 root root 4096 May 22 17:45 mysql-5.7.20-linux-glibc2.12-x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#4.加入path环境变量</span></span><br><span class="line">[root@aliyun tools]# vim /etc/profile</span><br><span class="line">[root@aliyun tools]# <span class="built_in">tail</span> -1 /etc/profile </span><br><span class="line">PATH=<span class="variable">$PATH</span>:/app/tools/maven/bin:/app/tools/mysql/bin</span><br><span class="line"><span class="comment">##刷新加载</span></span><br><span class="line">[root@aliyun tools]# <span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment">##检查</span></span><br><span class="line">[root@aliyun tools]# mysql -V</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.20, <span class="keyword">for</span> linux-glibc2.12 (x86_64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#5.拷贝mysql启停管理脚本到/usr/init.d/,可以使用systemctl与service通过脚本启停管理mysql</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">cp</span> /app/tools/mysql/support-files/mysql.server  /etc/init.d/mysqld.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#6.卸载mariadb依赖，安装mysql运行依赖，否则无法运行启动</span></span><br><span class="line">[root@aliyun ~]# rpm -qa|grep mariadb</span><br><span class="line">mariadb-libs-5.5.68-1.el7.x86_64</span><br><span class="line">[root@aliyun ~]# yum remove mariadb* -y</span><br><span class="line">[root@aliyun ~]#yum install libaio-devel -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#7.创建mysql运行用户，降低权限</span></span><br><span class="line">[root@db-51 ~]#useradd -s /sbin/nologin -M mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#8.创建mysql3306实例数据目录</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">mkdir</span> -p /app/data/3306</span><br><span class="line"><span class="comment">##数据目录授权</span></span><br><span class="line">[root@aliyun ~]# <span class="built_in">chown</span> -R mysql.mysql /app/data/</span><br><span class="line">[root@aliyun ~]# ll -d /app/data/3306 /app/data</span><br><span class="line">drwxr-xr-x 3 mysql mysql 4096 May 22 17:55 /app/data</span><br><span class="line">drwxr-xr-x 2 mysql mysql 4096 May 22 17:55 /app/data/3306</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#9.初始化mysql</span></span><br><span class="line">[root@aliyun ~]# mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3306</span><br><span class="line">[root@aliyun ~]# <span class="built_in">ls</span> /app/data/3306/ -l</span><br><span class="line">total 110620</span><br><span class="line">-rw-r----- 1 mysql mysql       56 May 22 18:00 auto.cnf</span><br><span class="line">-rw-r----- 1 mysql mysql      419 May 22 18:00 ib_buffer_pool</span><br><span class="line">-rw-r----- 1 mysql mysql 12582912 May 22 18:00 ibdata1</span><br><span class="line">-rw-r----- 1 mysql mysql 50331648 May 22 18:00 ib_logfile0</span><br><span class="line">-rw-r----- 1 mysql mysql 50331648 May 22 18:00 ib_logfile1</span><br><span class="line">drwxr-x--- 2 mysql mysql     4096 May 22 18:00 mysql</span><br><span class="line">drwxr-x--- 2 mysql mysql     4096 May 22 18:00 performance_schema</span><br><span class="line">drwxr-x--- 2 mysql mysql    12288 May 22 18:00 sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#10.修改mysql配置文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/my.cnf &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#11.启动mysql，先enable让系统识别程序脚本，才可以使用systemctl命令调用脚本管理mysql</span></span><br><span class="line">[root@db-51 ~]#systemctl <span class="built_in">enable</span> mysql</span><br><span class="line">[root@db-51 ~]#systemctl start mysql</span><br><span class="line">[root@aliyun /app/tools/mysql]#ss -tunlp|grep 3306</span><br><span class="line">tcp    LISTEN     0      80     [::]:3306               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">19087</span>,fd=<span class="number">20</span>))</span><br></pre></td></tr></table></figure><h3 id="2-2-创建授权jpress库连接用户"><a href="#2-2-创建授权jpress库连接用户" class="headerlink" title="2.2 创建授权jpress库连接用户"></a>2.2 创建授权jpress库连接用户</h3><blockquote><p>1.创建jpress数据库</p><p>2.创建授权jpress远程连接数据库的用户与密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建库</span></span><br><span class="line">mysql&gt; create database jpress;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户授权，这里jpress与mysql都在一台机器，所以限制登录的白名单，为云服务器本地ip回环地址就可以</span></span><br><span class="line">mysql&gt; grant all on jpress.* to jpress@<span class="string">&#x27;127.0.0.1&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| jpress             |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> jpress@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> jpress@127.0.0.1                                |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;jpress&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span>                 |</span><br><span class="line">| GRANT ALL PRIVILEGES ON `jpress`.* TO <span class="string">&#x27;jpress&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span> |</span><br><span class="line">+------------------------------------------------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="2-3-创建授权navicat远程连接用户"><a href="#2-3-创建授权navicat远程连接用户" class="headerlink" title="2.3 创建授权navicat远程连接用户"></a>2.3 创建授权navicat远程连接用户</h3><blockquote><p>创建一个允许远程连接的用户，授予对jpress库所有权限，密码为1</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户授权</span></span><br><span class="line">mysql&gt; grant all on jpress.* to navicat@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看user表字段</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> user,host,authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost |                                           |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| jpress        | 127.0.0.1 | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">| navicat       | %         | *E6CC90B878B948C35E92B003C792C46C58C4AF40 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看权限</span></span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> navicat@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> navicat@%                                |</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO <span class="string">&#x27;navicat&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                 |</span><br><span class="line">| GRANT ALL PRIVILEGES ON `jpress`.* TO <span class="string">&#x27;navicat&#x27;</span>@<span class="string">&#x27;%&#x27;</span> |</span><br><span class="line">+----------------------------</span><br></pre></td></tr></table></figure><h3 id="2-4-修改默认端口3306为23306"><a href="#2-4-修改默认端口3306为23306" class="headerlink" title="2.4 修改默认端口3306为23306"></a>2.4 修改默认端口3306为23306</h3><blockquote><p>加固服务安全，修改对外端口改为23306，防止黑客恶意扫描攻击</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改mysql配置文件</span></span><br><span class="line">[root@aliyun ~]#vim /etc/my.cnf </span><br><span class="line">[root@aliyun ~]#<span class="built_in">cat</span> /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">port=23306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重载服务管理脚本，重启mysql</span></span><br><span class="line">[root@aliyun ~]#systemctl daemon-reload</span><br><span class="line">[root@aliyun ~]#systemctl restart mysqld</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-初始化安装jpress"><a href="#3-初始化安装jpress" class="headerlink" title="3. 初始化安装jpress"></a>3. 初始化安装jpress</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jpress运行在了阿里云服务器上，端口为8000</span><br><span class="line">阿里云默认防火墙规则未开放8000端口</span><br><span class="line">需要在阿里云控制台中开启8000端口</span><br><span class="line">本地windows机器才可以访问web页面</span><br></pre></td></tr></table></figure><h3 id="3-1-阿里云开放8080端口"><a href="#3-1-阿里云开放8080端口" class="headerlink" title="3.1 阿里云开放8080端口"></a>3.1 阿里云开放8080端口</h3><blockquote><p>目前客户端还无法访问，阿里云默认8080端口未开放，控制台手动开放即可</p></blockquote><p><img src="/image-20240523121224268.png" alt="image-20240523121224268"></p><h3 id="3-2-初始化安装jpress"><a href="#3-2-初始化安装jpress" class="headerlink" title="3.2 初始化安装jpress"></a>3.2 初始化安装jpress</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">访问阿里云服务器公网ip+程序运行端口，自动跳转安装页面</span><br><span class="line">手动</span><br></pre></td></tr></table></figure><p><img src="/image-20240523122109298.png" alt="image-20240523122109298"></p><hr><p><img src="/image-20240523163723613.png" alt="image-20240523163723613"></p><hr><p><img src="/image-20240523163829039.png" alt="image-20240523163829039"></p><hr><p><img src="/image-20240523164150884.png" alt="image-20240523164150884"></p><h2 id="4-navicat远程连接数据库"><a href="#4-navicat远程连接数据库" class="headerlink" title="4.navicat远程连接数据库"></a>4.navicat远程连接数据库</h2><h3 id="4-1-阿里云开放23306端口"><a href="#4-1-阿里云开放23306端口" class="headerlink" title="4.1 阿里云开放23306端口"></a>4.1 阿里云开放23306端口</h3><blockquote><p>此时还无法连接云服务器上的mysql，安全组规则未打开数据库连接端口，手动开放即可</p></blockquote><p><img src="/image-20240523165405653.png" alt="image-20240523165405653"></p><h3 id="4-2-navicat工具远程连接"><a href="#4-2-navicat工具远程连接" class="headerlink" title="4.2 navicat工具远程连接"></a>4.2 navicat工具远程连接</h3><blockquote><p>使用navicat远程连接云服务器上的mysql数据库</p><p>IP:  阿里云服务器ip地址</p><p>端口：23306</p><p>用户：navicat</p><p>密码：1</p></blockquote><p><img src="/image-20240523165635337.png" alt="image-20240523165635337"></p><hr><blockquote><p>连接成功</p></blockquote><p><img src="/image-20240523165759129.png" alt="image-20240523165759129"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;systemctl管理数据库&quot;&gt;&lt;a href=&quot;#systemctl管理数据库&quot; class=&quot;headerlink&quot; title=&quot;systemctl管理数据库&quot;&gt;&lt;/a&gt;systemctl管理数据库&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;:warning:</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-SQL语句</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-SQL%E8%AF%AD%E5%8F%A5/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-SQL%E8%AF%AD%E5%8F%A5/</id>
    <published>2024-08-20T01:22:32.000Z</published>
    <updated>2024-08-20T01:25:25.572Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-数据库服务SQL语句分类"><a href="#1-数据库服务SQL语句分类" class="headerlink" title="1.数据库服务SQL语句分类"></a>1.数据库服务SQL语句分类</h1><h2 id="1-1-SQL语句是什么"><a href="#1-1-SQL语句是什么" class="headerlink" title="1.1 SQL语句是什么"></a>1.1 SQL语句是什么</h2><ul><li><p>SQL语句就是用于管理操作数据库的一种语言，可以对数据库的数据进行管理</p></li><li><p>对关系型数据库进行操作控制，<em>MySQL、Oracle、SQL Server、PostgreSQL、IBM DB2、Sybase、Microsoft Access、SQLite</em></p></li><li><p>不同的数据库，SQL语句写法会有一些小区别</p></li></ul><h2 id="1-2-SQL语句分类"><a href="#1-2-SQL语句分类" class="headerlink" title="1.2 SQL语句分类"></a>1.2 SQL语句分类</h2><p><strong>DLL数据定义语言</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">-</span> DDL Data Definition <span class="keyword">Language</span>（数据定义语言）</span><br><span class="line"></span><br><span class="line">#概念介绍</span><br><span class="line">负责管理数据库的基础数据（不会对表的内容修改），比如增删库、增删表、增删索引、增删用户等；</span><br><span class="line"></span><br><span class="line">#涉及语句</span><br><span class="line"><span class="keyword">CREATE</span>（创建）、<span class="keyword">ALTER</span>（修改）、<span class="keyword">DROP</span>（删除）等；</span><br><span class="line"></span><br><span class="line">#关注人群</span><br><span class="line">运维人员和开发人员都要熟悉。</span><br><span class="line"></span><br><span class="line">#相关具体的DDL负责的操作行为，可以执行以下命令进行查看：</span><br><span class="line">mysql<span class="operator">&gt;</span> ? Data Definition;</span><br><span class="line"><span class="comment">-- 查看获取DDL语言的操作行为</span></span><br></pre></td></tr></table></figure><p><strong>DCL数据控制语言</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="operator">-</span> DCL Data Control <span class="keyword">Language</span>（数据控制语言）</span><br><span class="line"></span><br><span class="line">#概念介绍</span><br><span class="line">主要用来定义访问权限和安全级别</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#涉及语句</span><br><span class="line"><span class="keyword">GRANT</span>（用户授权）、<span class="keyword">REVOKE</span>（权限回收）、<span class="keyword">COMMIT</span>（提交）、<span class="keyword">ROLLBACK</span>（回滚）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#关注人群</span><br><span class="line">运维人员需要熟练</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#相关具体的DCL负责的操作行为，可以执行以下命令进行查看：</span><br><span class="line">mysql<span class="operator">&gt;</span> ? Account Management</span><br><span class="line"><span class="comment">-- 查看获取DCL语言的操作行为</span></span><br></pre></td></tr></table></figure><p><strong>DML数据操作语言</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- DML Data Manipulation Language（数据操作语言）</span><br><span class="line"></span><br><span class="line"><span class="comment">#概念介绍</span></span><br><span class="line">主要针对数据库里的表里的数据进行操作，用来定义数据库记录（数据）；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#涉及语句</span></span><br><span class="line">SELECT（查）、INSERT（增）、DELETE（删）、UPDATE（改）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关注人群</span></span><br><span class="line">开发人员要熟练，运维人员熟悉即可</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#相关具体的DML负责的操作行为，可以执行以下命令进行查看：</span></span><br><span class="line">mysql&gt; ? Data Manipulation</span><br><span class="line">-- 查看获取DML语言的操作行为</span><br></pre></td></tr></table></figure><p> <strong>DQL数据查询语言</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-DQL Data Query Language（数据查询语言）</span><br><span class="line"></span><br><span class="line"><span class="comment">#概念介绍</span></span><br><span class="line">主要用来查询记录（数据）</span><br><span class="line"></span><br><span class="line"><span class="comment">#涉及语句</span></span><br><span class="line">SELECT（查）</span><br><span class="line">基本结构是由SELECT子句，FROM子句，WHERE子句组成的查询块</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关注人群</span></span><br><span class="line">运维人员和开发人员都要熟练</span><br></pre></td></tr></table></figure><h2 id="1-3-SQL文件导入方式"><a href="#1-3-SQL文件导入方式" class="headerlink" title="1.3 SQL文件导入方式"></a>1.3 SQL文件导入方式</h2><ul><li>SQL文件准备: <a href="https://github.com/datacharmer/test_db.git">https://github.com/datacharmer/test_db.git</a></li></ul><blockquote><p>SQL数据文件导入的本质,就是在这个sql文件中定义了大量sql语句，导入mysq中创建大量的库表数据等</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备sql文件用于测试</span></span><br><span class="line">[root@db-51 ~/test_db]#<span class="built_in">ls</span> /root</span><br><span class="line">employees.sql </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前库</span></span><br><span class="line">[root@db-51 ~]#mysql -uroot -p1 -e <span class="string">&quot;show databases;&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| linux              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#sql文件导入，两种方式，一种是命令行直接导入，一种是登录mysql后在内部进行导入</span></span><br><span class="line">[root@db-51 ~/test_db]#mysql -uroot -p1 &lt;   /root/test_db/employees.sql </span><br><span class="line">[root@db-51 ~/test_db]#mysql -uroot -p1 -e <span class="string">&quot;source  /root/test_db/employees.sql;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看创建的employees库</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| employees          |</span><br><span class="line">| linux              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看导入sql文件，默认创建库时的sql语句</span></span><br><span class="line">mysql&gt; show create database employees;</span><br><span class="line">+-----------+----------------------------------------------------------------------+</span><br><span class="line">| Database  | Create Database                                                      |</span><br><span class="line">+-----------+----------------------------------------------------------------------+</span><br><span class="line">| employees | CREATE DATABASE `employees` /*!40100 DEFAULT CHARACTER SET latin1 */ |</span><br><span class="line">+-----------+----------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#字段解释</span></span><br><span class="line">/*!40100  <span class="comment">#自动生成的注释符，为了让各个版本更加兼容sql语句</span></span><br><span class="line">DEFAULT CHARACTER SET latin1  <span class="comment">#创建该库时，指定的编码表为latin1</span></span><br><span class="line">latin1    <span class="comment">#字符集的一种字符格式叫做latin，指定该字符为编码表的话有中文数据时mysql会无法识别，无法显示</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建某个库指定编码表为utf8支持中文读写，理解mysql内查询显示创建库的sql含义</span></span><br><span class="line">mysql&gt; create database chaoge default character <span class="built_in">set</span> utf8;</span><br><span class="line">mysql&gt; show create database chaoge;</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                 |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| chaoge   | CREATE DATABASE `chaoge` /*!40100 DEFAULT CHARACTER SET utf8 */ |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h1 id="2-数据库服务字符编码设置"><a href="#2-数据库服务字符编码设置" class="headerlink" title="2.数据库服务字符编码设置"></a>2.数据库服务字符编码设置</h1><h2 id="2-1-字符编码作用"><a href="#2-1-字符编码作用" class="headerlink" title="2.1 字符编码作用"></a>2.1 字符编码作用</h2><p>计算机只识别二进制语言0&#x2F;1，真正与计算机交互的也只能是二进制语言，</p><p>为了更方便与计算机实现交互，使用人类语言的字符与之交互最为合适，于是就有了字符编码表</p><p>通过字符编码表做一个转换，将字符通过编码表的形式转换为二进制语言存储在计算机上，</p><p>计算机展示时也可以通过编码表将二进制转换成字符形式，展现给人类</p><p><strong>（避免中文乱码）–为什么中文会乱码</strong></p><ul><li>服务端使用的不是支持中文字符转换二进制的编码表（utf8）</li></ul><p>当使用不支持的中文编码表在计算机上存储中文字符数据时，计算机无法通过编码表正确存储对应的二进制数据</p><p>而读取中文字符时，二进制数据无法通过编码表正确转换为中文字符，所以就会显示中文乱码</p><ul><li>客户端使用非utf8编码表时，也会导致中文乱码，如xshell终端设置一个不支持中文编码表时</li></ul><p>即使服务端正确转换了中文字符，而客户端不是中文编码表，显示的字符也无法转换，就会导致乱码</p><ul><li>服务端与客户端需要编码表统一</li></ul><h2 id="2-2-常用字符编码与区别"><a href="#2-2-常用字符编码与区别" class="headerlink" title="2.2 常用字符编码与区别"></a>2.2 常用字符编码与区别</h2><blockquote><p>下方两种编码表都是可以支持中文识别的编码表</p></blockquote><ul><li>utf8:    最多存储3字节的字符，不支持表情符号</li><li>utf8mb4: 最多存储4字节的的字符，支持表情符号</li></ul><p>计算机存储最小单位是bit位，bit位代表一个二进制0&#x2F;1，</p><p>1字节&#x3D;8bit，8个二进制，最大组合为11111111，转换为人类更好识别的十进制计算，2^8次方，就是0-255种存储的二进制组合方式</p><p>3字节&#x3D;24bit，24个二进制，最大组合为24个1，转换成十进制就是16777216种组合，可以存放0-1亿多字符</p><h2 id="2-3-如何设置字符编码"><a href="#2-3-如何设置字符编码" class="headerlink" title="2.3 如何设置字符编码"></a>2.3 如何设置字符编码</h2><ul><li><p>查看数据库系统种可以设置的字符编码有什么</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show charset;</span><br></pre></td></tr></table></figure></li><li><p>查看目前mysql系统字符编码设置</p><blockquote><p>下方配置参数，server参数编码为latin1，不支持中文字符，会导致中文乱码</p><blockquote><p>正确设置: 除了filesystem，全部统一为utf8或utf8mb4</p></blockquote></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                          |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                           |</span><br><span class="line">| character_set_connection | utf8                                                           |</span><br><span class="line">| character_set_database   | latin1                                                         |</span><br><span class="line">| character_set_filesystem | binary                                                         |</span><br><span class="line">| character_set_results    | utf8                                                           |</span><br><span class="line">| character_set_server     | latin1                                                         |</span><br><span class="line">| character_set_system     | utf8                                                           |</span><br><span class="line">| character_sets_dir       | /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>字符编码参数解释</p><table><thead><tr><th>序号</th><th>参数信息</th><th>解释说明</th></tr></thead><tbody><tr><td>01</td><td><code>character_set_client</code></td><td>用来设置客户端使用的字符集</td></tr><tr><td>02</td><td><code>character_set_connection</code></td><td>用来设置连接数据库时的字符集 如果程序中没有指明连接数据库使用的字符集类型则按照这个字符集设置。</td></tr><tr><td>03</td><td><code>character_set_database</code></td><td>用来设置默认创建数据库的编码格式 如果在创建数据库时没有设置编码格式，就按照这个格式设置。</td></tr><tr><td>04</td><td>character_set_filesystem</td><td>文件系统的编码格式，把操作系统上的文件名转化成此字符集 即把 character_set_client转换character_set_filesystem， 默认binary是不做任何转换</td></tr><tr><td>05</td><td><code>character_set_results</code></td><td>数据库给客户端返回时使用的编码格式，如果没有指明，使用服务器默认的编码格式。</td></tr><tr><td>06</td><td><code>character_set_server</code></td><td>服务器安装时指定的默认编码格式，这个变量建议由系统自己管理，不要人为定义。</td></tr><tr><td>07</td><td>character_set_system</td><td>数据库系统使用的编码格式，这个值一直是utf8 不需要设置，它是为存储系统元数据的编码格式。</td></tr><tr><td>08</td><td>character_sets_dir</td><td>这个变量是字符集安装的目录。</td></tr></tbody></table></li></ul><p><strong>1）全局调整字符编码</strong></p><ul><li>修改配置文件，添加指定服务端编码参数为utf8即可，database参数无需指定，server编码参数会关联到database</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#vim /etc/my.cnf</span><br><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">character-set-server=utf8  <span class="comment">#添加服务端指定编码表</span></span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log-error=/app/tools/mysql/3306_error.<span class="built_in">log</span></span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line"></span><br><span class="line">[root@db-51 ~]#systemctl restart mysqld</span><br></pre></td></tr></table></figure><ul><li>修改后，重启服务端，再次查看数据库编码配置，server参数与databse编码变成了utf8</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%char%&#x27;;</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                          |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                           |</span><br><span class="line">| character_set_connection | utf8                                                           |</span><br><span class="line">| character_set_database   | utf8                                                           |</span><br><span class="line">| character_set_filesystem | binary                                                         |</span><br><span class="line">| character_set_results    | utf8                                                           |</span><br><span class="line">| character_set_server     | utf8                                                           |</span><br><span class="line">| character_set_system     | utf8                                                           |</span><br><span class="line">| character_sets_dir       | /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p><strong>2）局部调整字符编码</strong></p><blockquote><p>局部调整就是，创建库与表时后面指定编码表，便不会受全局编码参数影响。</p></blockquote><ul><li>当前server与database编码参数为latin</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&quot;%char%&quot;</span>;</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                          |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                           |</span><br><span class="line">| character_set_connection | utf8                                                           |</span><br><span class="line">| character_set_database   | latin1                                                         |</span><br><span class="line">| character_set_filesystem | binary                                                         |</span><br><span class="line">| character_set_results    | utf8                                                           |</span><br><span class="line">| character_set_server     | latin1                                                         |</span><br><span class="line">| character_set_system     | utf8                                                           |</span><br><span class="line">| character_sets_dir       | /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br></pre></td></tr></table></figure><ul><li>创建数据库与数据表表时默认编码表都为latin</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建库</span></span><br><span class="line">mysql&gt; create database yuchao;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看创建库生成的sql语句，编码表为latin1</span></span><br><span class="line">mysql&gt; show create database yuchao;</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                   |</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">| yuchao   | CREATE DATABASE `yuchao` /*!40100 DEFAULT CHARACTER SET latin1 */ |</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建表，查看sql语句，编码表为latin1</span></span><br><span class="line">mysql&gt; create table t1(<span class="built_in">id</span> int);</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                           |</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>创建数据库库与数据表，局部设置字符编码</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建数据库和表，指定字符编码为utf8</span></span><br><span class="line">mysql&gt; create database yuchao1 charset utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use yuchao1</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table t2(<span class="built_in">id</span> int) charset utf8;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看创建的库与表，局部设置成功</span></span><br><span class="line">mysql&gt; show create database yuchao1;</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                  |</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">| yuchao1  | CREATE DATABASE `yuchao1` /*!40100 DEFAULT CHARACTER SET utf8 */ |</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t2;</span><br><span class="line">+-------+--------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                         |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------+</span><br><span class="line">| t2    | CREATE TABLE `t2` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="2-4-字符编码校验码-排序规则"><a href="#2-4-字符编码校验码-排序规则" class="headerlink" title="2.4 字符编码校验码(排序规则)"></a>2.4 字符编码校验码(排序规则)</h2><p>字符编码校对规则（排序规则）：</p><p>在进行字符编码设置时，还需要设置校对规则信息，校对规则是什么？      </p><p>排序规则，就是指字符比较时按照字符编码还是直接用二进制数据比较，以及是否区分大小写。</p><p><code>主要可以根据校对规则定义或设置的不同：在查询数据信息时，影响数据信息的查询输出和排序效果；</code></p><p>其中utf8mb4字符集中，常用的排序规则有utf8mb4_unicode_ci、utf8mb4_general_ci、utf8mb4_bin：</p><p>排序规则前缀是字符集编码，中间是排序规则名称，后缀有特殊意义如下（常用的）：</p><table><thead><tr><th>排序规则后缀</th><th>解释说明</th></tr></thead><tbody><tr><td>_ci</td><td>不区分大小写，Case-insensitive的缩写</td></tr><tr><td>_cs</td><td>区分大小写，Case-sensitive的缩写</td></tr><tr><td>_ai</td><td>不区分重音，Accent-insensitive的缩写</td></tr><tr><td>_as</td><td>区分重音，Accent-sensitive的缩写</td></tr><tr><td>_bin</td><td>采用二进制方式存储数据信息</td></tr></tbody></table><p>utf8mb4_unicode_ci是基于标准Unicode来排序和比较，能够在各种语言之间精确排序。且在特殊情况下，Unicode排序规则为了能够处理特殊字符的情况，实现了略微复杂的排序算法。但是在绝大多数情况下不会发生此类复杂比较。</p><p>utf8mb4_general_ci没有实现Unicode排序规则，在遇到某些特殊字符情况下，排序结果可能不一致。但是，在绝大多数情况下，这些特殊字符的顺序并不需要那么精确。</p><p>utf8mb4_bin将字符串的每个字符用二进制数据编译存储，区分大小写，而且可以存二进制的内容。</p><p>综合来说，utf8mb4_unicode_ci比较准确，utf8mb4_general_ci速度较快。utf8mb4_unicode_ci对于特殊字符的处理，在中文、英文应用中不会使用到，除非你的应用有德语、法语、俄语等，则需要使用utf8mb4_unicode_ci，否则一般选用utf8mb4_general_ci就可以了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据库服务中可用的校对规则信息</span></span><br><span class="line">mysql&gt; show collation;</span><br><span class="line">+----------------------------+------------+------+----------+-------------+-----------+------------------+</span><br><span class="line">| Collation                        | Charset   | Id    | Default | Compiled | Sortlen   | Pad_attribute |</span><br><span class="line">+----------------------------+------------+------+----------+-------------+-----------+------------------+</span><br><span class="line">| utf8mb4_0900_ai_ci     | utf8mb4  | 255 | Yes        | Yes            |            0   | NO PAD            |</span><br><span class="line">| utf8mb4_0900_bin        | utf8mb4  | 309 |              | Yes            |            1   | NO PAD            |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置数据库服务中可用的校对规则信息</span></span><br><span class="line">mysql&gt; create database xiaoA charset utf8 collate utf8_general_mysql500_ci;</span><br><span class="line">mysql&gt; show create database xiaoA;</span><br><span class="line">+----------+------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                                                                                    |</span><br><span class="line">+----------+------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| xiaoA    | CREATE DATABASE `xiaoA` /*!40100 DEFAULT CHARACTER SET utf8 COLLATE utf8_general_mysql500_ci */ /*!80016 DEFAULT ENCRYPTION=<span class="string">&#x27;N&#x27;</span> */ |</span><br><span class="line">+----------+------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">--- 数据库设置字符编码校对规则</span><br><span class="line"></span><br><span class="line">mysql&gt; use xiaoA;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table t1 (<span class="built_in">id</span> int) charset utf8 collate utf8_german2_ci;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_german2_ci |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">--- 数据表设置字符编码校对规则</span><br></pre></td></tr></table></figure><p>数据库校对规则设置应用实践：</p><p>创建三个数据表，并设置相同的字符集，以及不同的字符校对规则；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table t1(info char(3)) charset utf8mb4 collate utf8mb4_0900_ai_ci;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create table t2(info char(3)) charset utf8mb4 collate utf8mb4_0900_as_cs;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create table t3(info char(3)) charset utf8mb4 collate utf8mb4_bin;</span><br><span class="line">Query OK, 0 rows affected (0.12 sec)</span><br></pre></td></tr></table></figure><p>向两个表中插入相同的数据，并进行数据查询操作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"># 插入数据信息</span><br><span class="line">mysql&gt; insert into t1 values(&#x27;a&#x27;),(&#x27;A&#x27;),(&#x27;b&#x27;),(&#x27;B&#x27;),(&#x27;c&#x27;),(&#x27;C&#x27;);</span><br><span class="line">mysql&gt; insert into t2 values(&#x27;a&#x27;),(&#x27;A&#x27;),(&#x27;b&#x27;),(&#x27;B&#x27;),(&#x27;c&#x27;),(&#x27;C&#x27;);</span><br><span class="line">mysql&gt; insert into t3 values(&#x27;a&#x27;),(&#x27;A&#x27;),(&#x27;b&#x27;),(&#x27;B&#x27;),(&#x27;c&#x27;),(&#x27;C&#x27;);</span><br><span class="line"></span><br><span class="line"># 查询数据信息</span><br><span class="line">mysql&gt; select * from t1 where info=&#x27;a&#x27;;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">| A    |</span><br><span class="line">+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t2 where info=&#x27;a&#x27;;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t3 where info=&#x27;a&#x27;;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">-- 校对规则不同，查询的数据结果会区分大小写显示</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t1 order by info;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">| A    |</span><br><span class="line">| b    |</span><br><span class="line">| B    |</span><br><span class="line">| c    |</span><br><span class="line">| C    |</span><br><span class="line">+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t2 order by info;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| a    |</span><br><span class="line">| A    |</span><br><span class="line">| b    |</span><br><span class="line">| B    |</span><br><span class="line">| c    |</span><br><span class="line">| C    |</span><br><span class="line">+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t3 order by info;</span><br><span class="line">+------+</span><br><span class="line">| info |</span><br><span class="line">+------+</span><br><span class="line">| A    |</span><br><span class="line">| B    |</span><br><span class="line">| C    |</span><br><span class="line">| a    |</span><br><span class="line">| b    |</span><br><span class="line">| c    |</span><br><span class="line">+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line">-- 校对规则不同，查询的数据结果会有不同的排序效果</span><br></pre></td></tr></table></figure><h1 id="3-数据库数据类型介绍"><a href="#3-数据库数据类型介绍" class="headerlink" title="3.数据库数据类型介绍"></a>3.数据库数据类型介绍</h1><h2 id="3-1-数据类型概述"><a href="#3-1-数据类型概述" class="headerlink" title="3.1 数据类型概述"></a>3.1 数据类型概述</h2><blockquote><p>主要用于限制用户输入的信息，必须是合理的，如电话输入数值，姓名输入字符串，不可胡乱写入</p></blockquote><p>数据类型从数据存储底层机制来看，主要和内存中如何存储数据信息有关；</p><p>在数据库服务中，每一个常量、变量和参数都有数据类型，数据类型用来指定数据的存储格式、约束和有效范围</p><p>详细数据类型说明地址:<a href="https://m.php.cn/article/460317.html">https://m.php.cn/article/460317.html</a></p><h2 id="3-2-常用数据类型"><a href="#3-2-常用数据类型" class="headerlink" title="3.2 常用数据类型"></a>3.2 常用数据类型</h2><p><strong>整数类型</strong></p><table><thead><tr><th>类别</th><th>数据类型细分</th><th>差异区别</th></tr></thead><tbody><tr><td>整数类型</td><td>tinyint</td><td>占用1字节 有符号取值 -128~127 无符号取值 0 ~ 255（最大3位数）</td></tr><tr><td></td><td>int</td><td>占用4字节 有符号取值 -2147483648 ~ 2147483647 无符号取值 0 ~ 4294967295（最大10位数）</td></tr><tr><td></td><td>BIGINT</td><td>占用8字节 …  0~2^64-1（最大20位数）</td></tr></tbody></table><p><strong>字符串类型</strong></p><table><thead><tr><th>类别</th><th>数据类型细分</th><th>差异区别</th></tr></thead><tbody><tr><td>字符类型</td><td>char(n)</td><td>表示定长的字符串类型，n表示可以存储字符的字节上限（n取值 0~255）</td></tr><tr><td></td><td>varchar(n)</td><td>表示变长的字符串类型，n表示可以存储字符的字节上限（n取值 0~65535）</td></tr></tbody></table><p><strong>浮点数类型</strong></p><table><thead><tr><th>类型</th><th>类型细化</th><th>说明</th></tr></thead><tbody><tr><td>浮点（数字&#x2F;小数）</td><td>float</td><td>单精度浮点数<br>一般使用方法为，float （4,1），4代表数字长度，1代表小数</td></tr><tr><td></td><td>double</td><td>双精度浮点数</td></tr><tr><td></td><td>decimal</td><td>定点数</td></tr></tbody></table><p><strong>时间类型</strong></p><table><thead><tr><th>类别</th><th>数据类型细分</th><th>差异区别</th></tr></thead><tbody><tr><td>时间类型</td><td>date</td><td>日期类型</td></tr><tr><td></td><td>time</td><td>时间类型</td></tr><tr><td></td><td>datetime</td><td>日期时间类型（1000~9999）占8字节</td></tr><tr><td></td><td>timestamp</td><td>时间戳类型（1970~2038）格林威治时间 占4字节</td></tr></tbody></table><p><strong>特殊数据类型</strong></p><table><thead><tr><th>名称</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>enum</td><td>枚举类型</td><td>类似于case语句判断。字段类型设置枚举类型后（初中，高中，小学），用户输入数据后类型判断是否是枚举中的某一个数据。如输入小学，判断是枚举中类型之一，允许写入。输入幼儿园，判断不是枚举中类型之一，不允许写入。</td></tr></tbody></table><h1 id="4-数据库属性约束设置"><a href="#4-数据库属性约束设置" class="headerlink" title="4.数据库属性约束设置"></a>4.数据库属性约束设置</h1><blockquote><p>约束用户输入的信息，做一个更大的限制，例如信息不可重复，信息必须写入等</p></blockquote><p>在数据库服务中进行数据存储时，类似于在一个execl表中存储数据一样，如果没有对表的字段进行约束和限制，是可以随意存储数据的；</p><p>但是，在数据表的某些字段上，是有特殊含义的，如果随意进行存储数据，会造成存储信息的混乱，因此引入了约束与属性概念；</p><p>通过数据类型设置的约束与属性，可以让数据库服务限制人类录入的数据信息，从而避免录入数据信息混乱的局面；</p><p>并且，通过数据类型的约束与属性设置，还可以避免数据信息输入的重复与输入数据信息不能为空；</p><h2 id="4-1-常用的约束定义"><a href="#4-1-常用的约束定义" class="headerlink" title="4.1 常用的约束定义"></a>4.1 常用的约束定义</h2><table><thead><tr><th>序号</th><th>约束方法</th><th>解释说明</th></tr></thead><tbody><tr><td>01</td><td>PK（primary key）</td><td>表示主键约束，非空且唯一（表中只能有一个主键），唯一标识</td></tr><tr><td>02</td><td>UK（unique key）</td><td>表示唯一约束，输入信息可以不写，写入的话不可重复，如电话号码，学号</td></tr><tr><td>03</td><td>NN（not null）</td><td>表示非空约束，输入信息可以重复，但不可以不写入，如名字</td></tr><tr><td>04</td><td>FK（foreign key）</td><td>表示外键约束，多表之间关联使用，约束能力可以通过程序代码逻辑替换</td></tr></tbody></table><h2 id="4-2-常用的属性定义"><a href="#4-2-常用的属性定义" class="headerlink" title="4.2 常用的属性定义"></a>4.2 常用的属性定义</h2><blockquote><p>辅助数据表信息的录入</p></blockquote><table><thead><tr><th>序号</th><th>属性信息</th><th>解释说明</th></tr></thead><tbody><tr><td>01</td><td>default</td><td>设定默认数据信息，可以实现自动填充<br />用户输入时某信息没有写入，但该字段下必须有信息写入，可通过默认属性可给予默认值，完善表内容</td></tr><tr><td>02</td><td>auto_increment</td><td>设定数值信息自增，可以实现数值编号自增填充（一般配合主键使用）<br />用于配合主键使用，主键字段下方信息都是非空且唯一，为了防止多用户输入信息时经常导致冲突，所有就根据用户在注册信息时，请求到达数据库时，根据请求对该字段进行一个自动填充，保证了添加主键的字段属性非空且唯一。</td></tr><tr><td>02</td><td>comment</td><td>设定数据注释信息<br />用于对表中字段注释说明，当数据表字段较多，无法识别某字段下方信息具体的含义，如name字段信息，是个人姓名还是网络昵称或是亲属名称。</td></tr><tr><td>03</td><td>unsigned</td><td>设定数值信息非负，可以实现数值信息列不能出现负数信息<br />用于做数值统计，例如做人口统计统计人数时，写入的信息不能非负数。</td></tr></tbody></table><h1 id="5-数据库DDL定义语句"><a href="#5-数据库DDL定义语句" class="headerlink" title="5.数据库DDL定义语句"></a>5.数据库DDL定义语句</h1><p>DDL数据库定义语句主要针对数据库内部对象，对库表，创建，修改，删除等操作</p><h2 id="5-1-定义数据库语句"><a href="#5-1-定义数据库语句" class="headerlink" title="5.1 定义数据库语句"></a>5.1 定义数据库语句</h2><blockquote><p>对库的创建，属性，增改查</p><p>库的属性： 库名，排序规则，字符编码</p></blockquote><h3 id="1）定义库规范"><a href="#1）定义库规范" class="headerlink" title="1）定义库规范"></a>1）定义库规范</h3><ol><li><p>库名不得以数字开头</p></li><li><p>库名和业务有关，见名知意</p></li><li><p>库名不得有大写字母，都是为了多系统平台的兼容性</p></li><li><p>创建数据库需要有指定的字符集，建议设定默认规则就是utf8mb4</p></li><li><p>生产环境下，禁用普通用户的drop database权限</p></li></ol><h3 id="2）查看数据库"><a href="#2）查看数据库" class="headerlink" title="2）查看数据库"></a>2）查看数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看所有数据库</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |    <span class="comment"># 系统自带库，存储数据库内置信息</span></span><br><span class="line">| mysql              |    <span class="comment"># 自带库，存储用户信息，授权等</span></span><br><span class="line">| performance_schema |    <span class="comment"># 存储和性能相关的数据</span></span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看show create帮助信息</span></span><br><span class="line"><span class="built_in">help</span> show create database</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看建库sql语句</span></span><br><span class="line">show create database 库名;</span><br><span class="line">show create database 库名;</span><br></pre></td></tr></table></figure><h3 id="4）创建数据库"><a href="#4）创建数据库" class="headerlink" title="4）创建数据库"></a>4）创建数据库</h3><ul><li><strong>直接创建数据库</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create database yu charset utf8;</span><br><span class="line">create database yu charset utf8mb4;</span><br></pre></td></tr></table></figure><ul><li><strong>判断同名数据库是否存在，不存在则创建</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database  <span class="keyword">if</span> not exists kings default charset utf8mb4 ;</span><br></pre></td></tr></table></figure><ul><li><strong>查询字符编码与排序规则相关信息</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0.查看当前数据库全局字符编码配置</span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.查看数据库所支持的字符编码有哪些</span><br><span class="line">mysql&gt; show character <span class="built_in">set</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.查看字符编码支持的排序规则</span><br><span class="line">mysql&gt; show collation;</span><br><span class="line">  排序规则名称              哪个字符编码支持     默认值跟随字符编码        所占字节</span><br><span class="line">+--------------------------+----------+-----+---------+----------+---------+</span><br><span class="line">| Collation                | Charset  | Id  | Default | Compiled | Sortlen |</span><br><span class="line">| utf8_general_ci          | utf8     |  33 | Yes     | Yes      |       1 |</span><br><span class="line">| utf8mb4_general_ci       | utf8mb4  |  45 | Yes     | Yes      |       1 |</span><br></pre></td></tr></table></figure><ul><li><strong>不指定具体字符编码与校验规则创建数据库</strong></li></ul><blockquote><p>不指定字符编码，会跟随全局字符编码设置</p><p>不指定校验规则，会根据字符编码的默认值设置</p><p>5.7版创建数据库后，查看创建库sql语句，不显示校验规则信息</p><p>5.8版创建数据库后，查看创建库sql语句，会显示校验规则信息</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0.当前系统全局字符编码配置</span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                          |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                           |</span><br><span class="line">| character_set_connection | utf8                                                           |</span><br><span class="line">| character_set_database   | utf8mb4                                                        |</span><br><span class="line">| character_set_filesystem | binary                                                         |</span><br><span class="line">| character_set_results    | utf8                                                           |</span><br><span class="line">| character_set_server     | utf8mb4                                                        |</span><br><span class="line">| character_set_system     | utf8                                                           |</span><br><span class="line">| character_sets_dir       | /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+----------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.创建数据库，不指定字符编码与校验码</span><br><span class="line">mysql&gt; create database yu;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.当前使用的时5.7版本，无法通过命令行查询排序规则，只能通过图形化查询排序规则</span><br></pre></td></tr></table></figure><p>不指定排序规则与字符集，会跟随数据库全局字符配置与默认排序规则设置</p><p><img src="/image-20240601180342632.png" alt="image-20240601180342632"></p><ul><li><strong>指定字符集与排序规则创建数据库</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0.指定字符编码与排序规则创建数据库</span><br><span class="line">mysql&gt; create database yu2 charset utf8mb4 collate utf8mb4_bin;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.查询库的新字符编码与排序规则</span><br></pre></td></tr></table></figure><p><img src="/image-20240601181257930.png" alt="image-20240601181257930"></p><h3 id="5）修改数据库"><a href="#5）修改数据库" class="headerlink" title="5）修改数据库"></a>5）修改数据库</h3><ul><li><strong>修改数据库字符编码与排序规则</strong></li></ul><blockquote><p>语法：<br>ALTER  DATABASE 库名  CHARSET 新的字符集</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前库字符集为utf8mb4</span></span><br><span class="line">show create database yu;</span><br><span class="line">mysql&gt; show create database yu;</span><br><span class="line">+----------+----------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                |</span><br><span class="line">+----------+----------------------------------------------------------------+</span><br><span class="line">| yu       | CREATE DATABASE `yu` /*!40100 DEFAULT CHARACTER SET utf8mb4 */ |</span><br><span class="line">+----------+----------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改字符集为utf8</span></span><br><span class="line">mysql&gt; alter database yu charset utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create database yu;</span><br><span class="line">+----------+-------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                             |</span><br><span class="line">+----------+-------------------------------------------------------------+</span><br><span class="line">| yu       | CREATE DATABASE `yu` /*!40100 DEFAULT CHARACTER SET utf8 */ |</span><br><span class="line">+----------+-------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li><strong>修改数据库名字</strong></li></ul><p>&#x3D;&#x3D;不支持直接修改，会影响数据库内数据，必须修改可以创建新库名，再将库中数据备份，导入新库即可&#x3D;&#x3D;</p><h2 id="5-2-定义数据表语句"><a href="#5-2-定义数据表语句" class="headerlink" title="5.2 定义数据表语句"></a>5.2 定义数据表语句</h2><blockquote><p>主要对数据表结构的增删改查</p><blockquote><p>数据表结构：数据表名，字段列属性(字段名，数据类型，约束属性设置), 数据表属性(引擎，字符编码，排序规则)</p></blockquote></blockquote><h3 id="1）定义表规范"><a href="#1）定义表规范" class="headerlink" title="1）定义表规范"></a>1）定义表规范</h3><ul><li>1.表名的规范<ul><li>不得数字开</li><li>见名知意，表和业务有关，参考wordpress等数据库命名规范</li><li>不得大写字母</li><li>别超过18个字符</li><li>别是mysql默认关键字</li></ul></li><li><ol start="2"><li>默认存储引擎是innodb</li></ol></li><li><ol start="3"><li>5.7之后，数据表字符集，默认utf8mb4</li></ol></li><li><ol start="4"><li>数据表的字段（列）也和业务有关，字符别超过18个</li></ol></li><li><ol start="5"><li>数据表的字段（列）要选择合适的、足够容量、省磁盘空间的数据类型</li></ol></li><li><ol start="6"><li>数据表的字段（列）建议都not null</li></ol></li><li><ol start="7"><li>数据表的字段（列）建议都要有注释</li></ol></li><li><ol start="8"><li>数据表的字段（列） 每张数据表都建议加主键</li></ol></li><li><ol start="9"><li>针对not null的列，一般给与默认值</li></ol></li><li><ol start="10"><li>给每张表添加注释</li></ol></li></ul><h3 id="2）修改表规范"><a href="#2）修改表规范" class="headerlink" title="2）修改表规范"></a>2）修改表规范</h3><ol><li>添加数据表的字段（列），建议用追加方式</li><li>修改列的属性，建议用modify语句</li><li>修改表的属性，建议在业务不繁忙的时候修改</li></ol><h3 id="3）创建数据表"><a href="#3）创建数据表" class="headerlink" title="3）创建数据表"></a>3）创建数据表</h3><blockquote><ul><li>图形化工具创建表</li><li>根据下方sql信息使用图形化创建表</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `students` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">  `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">  `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">  `address` enum(<span class="string">&#x27;北京&#x27;</span>,<span class="string">&#x27;深圳&#x27;</span>,<span class="string">&#x27;云南&#x27;</span>,<span class="string">&#x27;江苏&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;省份&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure><ul><li>图形化创建如下</li><li>创建之后，可以在图形化中，写入数据测试，验证字段的类型限制，约束限制，属性信息设置</li></ul><p><img src="/image-20240601200415554.png" alt="image-20240601200415554"></p><blockquote><p>手写sql语句创建数据表，并且插入数据查看</p><p>第一种语法：</p><p>create table  库.表(字段1  字段约束属性，字段2 字段约束属性);</p><p>第二种语法：</p><p>use  库;</p><p>create table  表(字段1  字段约束属性，字段2 字段约束属性);</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE `stu2` (</span><br><span class="line">    -&gt;   `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">    -&gt;   `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">    -&gt;   `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">    -&gt;   `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">    -&gt;   `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">    -&gt;   `intime` datetime NOT NULL DEFAULT now()   COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">    -&gt;   `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">    -&gt;   PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">    -&gt; ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据表结构信息</span></span><br><span class="line">mysql&gt; desc stu2;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#根据数据表结构插入数据</span></span><br><span class="line"><span class="comment">#完整的定义每个字段插入数据</span></span><br><span class="line">mysql&gt; insert into stu2(<span class="built_in">id</span>,name,age,gender,address,intime,phone) values(1,<span class="string">&#x27;赵东兴&#x27;</span>,23,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内蒙古包头市&#x27;</span>,now(),15598001352);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"><span class="comment">#查看数据表信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu2;</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address            | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古包头市       | 2024-06-01 20:20:26 | 15598001352 |</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#不定义id与intime字段写入数据，id不输入可通过主键实现自增，intime不输入可通过默认值时间变量实现自动添加</span></span><br><span class="line">mysql&gt; insert into stu2(name,age,gender,address,phone) values(<span class="string">&#x27;黄牛&#x27;</span>,21,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内蒙古包头市&#x27;</span>,16666666666);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"><span class="comment">#查看数据表信息</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu2;</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address            | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古包头市       | 2024-06-01 20:20:26 | 15598001352 |</span><br><span class="line">|  2 | 黄牛      |  21 | 男     | 内蒙古包头市       | 2024-06-01 20:28:47 | 16666666666 |</span><br><span class="line">+----+-----------+-----+--------+--------------------+---------------------+-------------+</span><br></pre></td></tr></table></figure><h3 id="4）复制数据表"><a href="#4）复制数据表" class="headerlink" title="4）复制数据表"></a>4）复制数据表</h3><blockquote><p>复制某数据表结构，生成另一张新数据表</p><blockquote><p>需求：复制上面的stu2表，生成stu3表，要求数据表结构相同</p></blockquote></blockquote><ul><li>方法一，拿到该表的建表sql语句，将数据表名修改即可</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1.查询stu2表的建表语句</span><br><span class="line">mysql&gt; show create table stu2;</span><br><span class="line">-----------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                 </span><br><span class="line">| stu2  | CREATE TABLE `stu2` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">  `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">  `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">  `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4                            |</span><br><span class="line"></span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.修改sql语句表名，直接创建即可</span><br><span class="line">mysql&gt; CREATE TABLE `stu3` (</span><br><span class="line">    -&gt;   `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">    -&gt;   `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">    -&gt;   `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">    -&gt;   `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">    -&gt;   `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">    -&gt;   `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">    -&gt;   `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">    -&gt;   PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">    -&gt; ) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4</span><br><span class="line">    -&gt; ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.查看stu3表结构</span><br><span class="line">mysql&gt; desc stu3;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br></pre></td></tr></table></figure><ul><li>方法二，使用特有的复制表sql语句生成新数据表，保留原表结构</li></ul><blockquote><p>语法： create table  要生成的数据表（新的）   like   要复制的数据表（旧的）</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1.特有的复制生成新表的sql语句</span><br><span class="line">mysql&gt; create table stu4 like stu2;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">2.查看表结构</span><br><span class="line">mysql&gt; desc stu4;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><h2 id="5-3-修改表结构语句"><a href="#5-3-修改表结构语句" class="headerlink" title="5.3 修改表结构语句"></a>5.3 修改表结构语句</h2><h3 id="1）语法概述"><a href="#1）语法概述" class="headerlink" title="1）语法概述"></a>1）语法概述</h3><ul><li><strong>语法</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表名  具体的动作 </span><br></pre></td></tr></table></figure><ul><li><strong>添加新字段</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表名  ADD</span><br></pre></td></tr></table></figure><ul><li><strong>指定在第一个列添加新字段</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER  TABLE  表  ADD COLUMN  字段名  数据类型  约束条件 注释  first;</span><br></pre></td></tr></table></figure><ul><li><strong>指定在某个字段后添加新字段</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表  ADD  COLUMN  字段 数据类型 约束 注释   AFTER  哪个字段后添加；</span><br></pre></td></tr></table></figure><ul><li><strong>修改字段结构</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表名  change</span><br><span class="line"></span><br><span class="line">ALTER TABLE  表名  modify</span><br></pre></td></tr></table></figure><ul><li><strong>删除字段</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE  表名  drop  字段名</span><br></pre></td></tr></table></figure><h3 id="2）添加字段属性"><a href="#2）添加字段属性" class="headerlink" title="2）添加字段属性"></a>2）添加字段属性</h3><blockquote><p>使用入如下stu1数据表结构练习</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;   show create table stu1;</span><br><span class="line">| Table | Create Table                                                                                 </span><br><span class="line">| stu1  | CREATE TABLE `stu1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">  `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">  `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">  `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><p><strong>指定第一列最前面添加字段</strong></p><blockquote><p>语法:</p><p>alter table 表名 add column 新字段名 字段类型  约束条件  字段属性默认值注释    first</p></blockquote><ul><li>添加身高字段，字段类型–不超过3位数只有一位小数</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############语法说明##################</span></span><br><span class="line"><span class="comment">#alter table stu1  #修改stu1表</span></span><br><span class="line"><span class="comment">#add column height #添加height字段</span></span><br><span class="line"><span class="comment">#float(4,1)        #字段类型，限制用户写入，浮点数float(4,1)，代表整数长度为4，小数长度为1</span></span><br><span class="line"><span class="comment">#default null      #字段属性，辅助信息写入，不写身高信息，默认就为空字符串</span></span><br><span class="line"><span class="comment">#comment           #字段属性，辅助信息写入，添加注释信息</span></span><br><span class="line"><span class="comment">#first             #指定第一列添加字段</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改添加height字段</span></span><br><span class="line">mysql&gt; alter table stu1 add column height <span class="built_in">float</span>(4,1) default null comment <span class="string">&#x27;学生身高&#x27;</span> first;</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看表结构字段信息</span></span><br><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| height  | <span class="built_in">float</span>(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################插入数据验证####################</span></span><br><span class="line"><span class="comment">#id与intime字段无需写入数据，默认会添加相关信息。指定height,name,age,gender,address,phone字段，插入数据。</span></span><br><span class="line">mysql&gt; insert into stu1(height,name,age,gender,address,phone) values(175,<span class="string">&#x27;赵&#x27;</span>,23,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内蒙古&#x27;</span>,15598001352);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据表数据</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| height | <span class="built_in">id</span> | name | age | gender | address   | intime              | phone       |</span><br><span class="line">+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  175.0 |  1  | 赵   |  23 | 男     | 内蒙古    | 2024-06-02 11:15:32 | 15598001352 |</span><br></pre></td></tr></table></figure><ul><li>添加–学校字段，字段约束条件–不能为空,字段属性添加默认值–猿来教育，字段属性添加注释–学校</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####################添加字段查看#####################</span></span><br><span class="line">mysql&gt; alter table stu1 add column school char(20) not null default <span class="string">&#x27;猿来教育&#x27;</span> comment <span class="string">&#x27;学校&#x27;</span> first; </span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu1;                                                                                       </span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| school  | char(20)       | NO   |     | 猿来教育          |                |</span><br><span class="line">| height  | <span class="built_in">float</span>(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">9 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">########################插入数据查看###################</span></span><br><span class="line"><span class="comment">#只插入，限制不能为空的字段数据，可以为空的都跟随默认值</span></span><br><span class="line">mysql&gt; insert into stu1(name,gender,address,phone) value(<span class="string">&#x27;王&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内蒙古&#x27;</span>,11011011011);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#school默认值猿来教育，height默认值空，id值自增，age默认值0，initinme值now()</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+--------------+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| school       | height | <span class="built_in">id</span> | name | age | gender | address   | intime              | phone       |</span><br><span class="line">+--------------+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| 猿来教育     |   NULL |  1 | 王   |   0 | 男     | 内蒙古    | 2024-06-02 11:33:22 | 11011011011 |</span><br><span class="line">+--------------+--------+----+------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>指定某字段后添加字段</strong></p><blockquote><p>语法:</p><p>alter table 表名 add column 新字段名 字段类型  约束条件  字段属性默认值注释    after  目标字段名（插入目标后）      </p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| school  | varchar(20)       | NO   |     | 猿来教育          |                |</span><br><span class="line">| height  | float(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| id      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(&#x27;男&#x27;,&#x27;女&#x27;)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br></pre></td></tr></table></figure><ul><li>address字段前添加爱好字段，字段类型–字符串限制20长度,字段约束–不能为空，字段属性–注释爱好</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###################添加字段查看#######################</span></span><br><span class="line">mysql&gt; alter table stu1 add column hobby char(20) not null comment <span class="string">&#x27;爱好&#x27;</span> after gender;</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| school  | varchar(20)       | NO   |     | 猿来教育          |                |</span><br><span class="line">| height  | <span class="built_in">float</span>(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| hobby   | char(20)          | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">10 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">####################插入数据查看#####################</span></span><br><span class="line">mysql&gt; insert into stu1(name,gender,hobby,address,phone) value(<span class="string">&#x27;黄牛&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;打游戏&#x27;</span>,<span class="string">&#x27;澳门&#x27;</span>,10010010011);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>这里id自增有个bug，和删除数据表有关系，没有清空id记录</p><p><img src="/image-20240602115703778.png" alt="image-20240602115703778"></p><h3 id="3）删除字段"><a href="#3）删除字段" class="headerlink" title="3）删除字段"></a>3）删除字段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| school  | varchar(20)       | NO   |     | 猿来教育          |                |</span><br><span class="line">| height  | <span class="built_in">float</span>(4,1)        | YES  |     | NULL              |                |</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| hobby   | char(20)          | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">10 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><ul><li>删除字段school，height，hobby</li></ul><blockquote><p>语法:</p><p>alter table 表名 drop 字段名;</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############删除查看#################</span></span><br><span class="line">mysql&gt; alter table stu1 drop school;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table stu1 drop hobby;</span><br><span class="line">Query OK, 0 rows affected (0.08 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table stu1 drop height;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4）修改字段属性"><a href="#4）修改字段属性" class="headerlink" title="4）修改字段属性"></a>4）修改字段属性</h3><blockquote><p>:warning:注意：由于不同类型的数据在机器中的存储方式及长度并不相同，修改数据类型可能会影响数据表中已有的数据记录，因此，当数据表中已经有数据时，不要轻易修改数据类型</p></blockquote><ul><li><p>两种语法</p><ul><li>change: 对某个字段重新定义，字段名，和数据类型约束条件及属性</li><li>modity: 对某个字段重新定义，数据类型约束条件及属性</li></ul></li><li><p>两者区别：change比modity多一个功能，可以重新定义字段名</p></li></ul><p><strong>change关键字使用</strong></p><blockquote><p>语法：</p><p>alter table 表名 change 原字段名 新字段名 新数据类型 （更改字段名并设置新数据类型与属性）</p><p>alter table 表名 change 原字段名 原字段名 新数据类型 （对原字段设置新数据类型与属性）</p><p>alter table 表名 change 原字段名 新字段名 原数据类型 （只对字段名做修改）</p></blockquote><ul><li><strong>使用如下stu数据表进行练习</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################字段属性####################</span></span><br><span class="line">mysql&gt; desc stu;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##################建表sql###################</span></span><br><span class="line">mysql&gt; show create table stu;</span><br><span class="line">| Table | Create Table                                                                                 </span><br><span class="line">| stu   | CREATE TABLE `stu` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name` varchar(64) NOT NULL COMMENT <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">  `age` tinyint(3) NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">  `gender` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL COMMENT <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">  `address` varchar(255) NOT NULL COMMENT <span class="string">&#x27;居住地址&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone` char(11) NOT NULL COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4                            |</span><br><span class="line"></span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p>:one:<strong>更改字段名并对如下字段属性进行修改</strong></p><ul><li>name：字段名—name0，默认值—佚名 ， 数据类型—char（10），注释—不添加</li><li>age     ：字段名—age0， 约束—允许为空， 注释—不添加</li><li>gender  ：字段名—gender0,  默认值—男， 注释—不添加</li><li>新字段名后添加新字段属性即可</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########更改字段名及修改字段属性###########</span></span><br><span class="line">mysql&gt; alter table stu change name name0 char(15) not null default <span class="string">&#x27;佚名&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; alter table stu change age age0 tinyint(3) not null;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; alter table stu change gender gender0 enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) not null default <span class="string">&#x27;男&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><p>:two:<strong>对原字段属性进行修改</strong></p><ul><li>address ：约束—允许为空</li><li>保持字段名不变即可，后方添加新的字段属性</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########只修改字段属性###########</span></span><br><span class="line">mysql&gt; alter table stu change address address varchar(255) null default <span class="string">&#x27;内蒙古&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><p><strong>:three:只修改字段名</strong></p><ul><li>phone：字段名—phone0</li><li>只修改字段名，在新字段名后方，添加原字段的全部属性即可。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########只修改字段名###########</span></span><br><span class="line">mysql&gt; alter table stu change phone phone0 char(11) not null;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><p>:four:<strong>查看新数据表结构插入数据验证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新数据表字段及属性</span></span><br><span class="line">mysql&gt; desc stu;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name0   | char(15)          | NO   |     | 佚名              |                |</span><br><span class="line">| age0    | tinyint(3)        | NO   |     | NULL              |                |</span><br><span class="line">| gender0 | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | 男                |                |</span><br><span class="line">| address | varchar(255)      | YES  |     | 内蒙古           |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone0  | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#插入数据</span></span><br><span class="line">mysql&gt; insert into  student.stu(age0,phone0) value(18,15598001352);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu;</span><br><span class="line">+----+--------+------+---------+---------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name0  | age0 | gender0 | address | intime              | phone0      |</span><br><span class="line">+----+--------+------+---------+---------+---------------------+-------------+</span><br><span class="line">|  1 | 佚名   |   18 | 男      | 内蒙古   | 2024-06-02 16:09:18 | 15598001352 |</span><br><span class="line">+----+--------+------+---------+---------+---------------------+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>modify关键字使用</strong></p><blockquote><p>语法：</p><p>alter table 表名 modify 原字段名 新数据类型</p><p>motify只对字段修改属性，并不修改字段名</p></blockquote><ul><li>对如下stu数据表中address字段，约束条件yes null&#x3D;&#x3D;&#x3D;改为no null ， 并设置注释信息&#x3D;&#x3D;&#x3D;地址</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table stu;</span><br><span class="line">CREATE TABLE `stu` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">  `name0` char(15) NOT NULL DEFAULT <span class="string">&#x27;佚名&#x27;</span>,</span><br><span class="line">  `age0` tinyint(3) NOT NULL,</span><br><span class="line">  `gender0` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) NOT NULL DEFAULT <span class="string">&#x27;男&#x27;</span>,</span><br><span class="line">  `address` varchar(255) DEFAULT <span class="string">&#x27;内蒙古&#x27;</span>,</span><br><span class="line">  `intime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">  `phone0` char(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4            |</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; desc stu;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name0   | char(15)          | NO   |     | 佚名              |                |</span><br><span class="line">| age0    | tinyint(3)        | NO   |     | NULL              |                |</span><br><span class="line">| gender0 | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | 男                |                |</span><br><span class="line">| address | varchar(255)      | YES  |     | 内蒙古              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone0  | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><ul><li>进行修改adress字段属性，注意modify也是重新定义新属性，不仅是单独修改某个属性，所以在修改时添加上原有属性</li><li>下面有个测试的bug，一个字段为允许为空时，且下方有数据时，无法修改为不允许为空。解决方法，给该字段下添加数据，方可设置。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改address，允许为空约束，修改为不允许为空</span></span><br><span class="line">mysql&gt; alter table student.stu modify address varchar(255) not null default <span class="string">&#x27;内蒙古&#x27;</span> comment <span class="string">&#x27;地址&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据表结构</span></span><br><span class="line">mysql&gt; desc stu;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name0   | char(15)          | NO   |     | 佚名              |                |</span><br><span class="line">| age0    | tinyint(3)        | NO   |     | NULL              |                |</span><br><span class="line">| gender0 | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | 男                |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | 内蒙古            |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone0  | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5）修改表其它属性"><a href="#5）修改表其它属性" class="headerlink" title="5）修改表其它属性"></a>5）修改表其它属性</h3><p><strong>修改表名</strong></p><blockquote><p>语法：</p><p>alter table 旧表名 rename to 新表名</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改表名</span></span><br><span class="line">mysql&gt; alter table stu1 rename stu;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#数据还存在</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu;</span><br><span class="line">+----+--------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name   | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+--------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  3 | 王     |   0 | 男     | 内蒙古    | 2024-06-02 11:33:22 | 11011011011 |</span><br><span class="line">|  4 | 黄牛   |   0 | 女     | 澳门      | 2024-06-02 11:56:03 | 10010010011 |</span><br><span class="line">+----+--------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>修改数据库引擎</strong></p><blockquote><p>语法:</p><p>alter table 表名 engine&#x3D;新引擎</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############创建数据表############</span></span><br><span class="line">create table t1(<span class="built_in">id</span> int) engine=MYISAM;</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                            |</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############修改查看###############</span></span><br><span class="line">mysql&gt; alter table t1 engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                            |</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+-----------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>修改字符编码</strong></p><blockquote><p>语法：</p><p>alter table 表名 charset&#x3D;新字符编码</p></blockquote><ul><li><p>如下修改有缺点，对一个已有数据的数据表来说，修改了字符编码后，只能对以后的新数据按照新字符编码存储数据</p><p>以前的数据还是之前的字符编码数据</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table t1 charset=utf8;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                           |</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">| t1    | CREATE TABLE `t1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8|</span><br><span class="line">+-------+----------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>还有一种方法可以执行之前的数据表数据也修改为新字符编码的格式</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">·锁表逻辑导出数据（例如：mysqldump）</span><br><span class="line">·重新创建数据空表（设置目标字符集）</span><br><span class="line">·导入备份数据信息</span><br><span class="line">-- 严谨的方法，可以影响之后存储的数据，也会修改之前存储的数据</span><br><span class="line">-- 字符集转换是可以的，但是必须保证修改后的字符集是修改前的严格超集（包含）</span><br></pre></td></tr></table></figure><h1 id="6-数据库DML操作语言"><a href="#6-数据库DML操作语言" class="headerlink" title="6.数据库DML操作语言"></a>6.数据库DML操作语言</h1><ul><li><p>开发熟练，运维熟悉即可</p></li><li><p>主要对数据表内数据进行操作，增删改查</p></li></ul><h2 id="6-1-数据表增加数据"><a href="#6-1-数据表增加数据" class="headerlink" title="6.1 数据表增加数据"></a>6.1 数据表增加数据</h2><blockquote><p>insert语句语法：</p><p>insert into 数据表名(指定字段) value(字段所对应的数据); #按照指定字段对应位置插入数据</p><blockquote><p>:warning:注意中文数据需要用引号嵌套，否则无法识别</p></blockquote></blockquote><ul><li>对如下数据表进行操作</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc stu1;</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field   | Type              | Null | Key | Default           | Extra          |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">| <span class="built_in">id</span>      | int(11)           | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name    | varchar(64)       | NO   |     | NULL              |                |</span><br><span class="line">| age     | tinyint(3)        | NO   |     | 0                 |                |</span><br><span class="line">| gender  | enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>)   | NO   |     | NULL              |                |</span><br><span class="line">| address | varchar(255)      | NO   |     | NULL              |                |</span><br><span class="line">| intime  | datetime          | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone   | char(11)          | NO   |     | NULL              |                |</span><br><span class="line">+---------+-------------------+------+-----+-------------------+----------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><h3 id="1）完整字段插入"><a href="#1）完整字段插入" class="headerlink" title="1）完整字段插入"></a>1）完整字段插入</h3><ul><li>指定完整字段名，插入每个字段对应的数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into  student.stu1(<span class="built_in">id</span>,name,age,gender,address,intime,phone) value(1,<span class="string">&#x27;赵东兴&#x27;</span>,23,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;内 蒙古&#x27;</span>,now(),15598001352);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="2）部分字段插入"><a href="#2）部分字段插入" class="headerlink" title="2）部分字段插入"></a>2）部分字段插入</h3><ul><li>指定部分字段名，插入对应字段的数据</li><li>某些字段，可通过属性设置辅助用户输入信息，不写入数据会跟随字段属性，写入设置好的默认值</li><li>如上方测试的stu1数据表中，id字段为主键自增，age设置了默认值属性，intime也设置了默认值时间变量，不对其字段插入数据也可以</li><li>但是某些不允许为空，无默认值属性的字段，必须在字段下写入对应数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into stu1(name,gender,address,phone) value(<span class="string">&#x27;王雨萌&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;未知&#x27;</span>,<span class="string">&#x27;未知&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 未知      | 2024-06-02 18:34:23 | 未知        |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3）不指定字段插入"><a href="#3）不指定字段插入" class="headerlink" title="3）不指定字段插入"></a>3）不指定字段插入</h3><ul><li>不指定字段名，也可以插入数据</li><li>但是必须得按照每个字段的顺序，写入完整的对应每个字段的数据。即使某字段有默认值也不行，必须写入全部字段对应的数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into stu1 value(3,<span class="string">&#x27;张岩&#x27;</span>,23,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;未知&#x27;</span>,now(),<span class="string">&#x27;未知&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 未知      | 2024-06-02 18:34:23 | 未知        |</span><br><span class="line">|  3 | 张岩      |  23 | 女     | 未知      | 2024-06-02 18:42:13 | 未知        |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4）插入多条数据"><a href="#4）插入多条数据" class="headerlink" title="4）插入多条数据"></a>4）插入多条数据</h3><ul><li>可以根据指定字段，value定义多个值，通过逗号分割，插入多条数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into stu1(name,gender,address,phone) value(<span class="string">&#x27;王彤&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;内蒙古&#x27;</span>,<span class="string">&#x27;未知&#x27;</span>),(<span class="string">&#x27;师璐&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;. Query OK, 3 rows affected (0.01 sec).&#x27;</span>);</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 未知      | 2024-06-02 18:34:23 | 未知        |</span><br><span class="line">|  3 | 张岩      |  23 | 女     | 未知      | 2024-06-02 18:42:13 | 未知        |</span><br><span class="line">|  4 | 王彤      |   0 | 女     | 内蒙古    | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">|  5 | 师璐      |   0 | 女     | 经纬      | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">|  6 | 曹可文    |   0 | 女     | 四中      | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="5）shell插入多条数据"><a href="#5）shell插入多条数据" class="headerlink" title="5）shell插入多条数据"></a>5）<em>shell</em>插入多条数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1.以班级学员信息，继续添加，试试SQL语句的insert</span><br><span class="line"></span><br><span class="line">2. 有没有快捷的办法，批量插入数据？（提示，基于学生名字插入数据即可）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提示修改phone设置默认值</span></span><br><span class="line">mysql -uroot -pwww.yuchaoit.cn -e <span class="string">&quot;alter table yuchao_linux.new_students modify phone char(11) not null default &#x27;0&#x27; &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试代码</span></span><br><span class="line"><span class="keyword">for</span> stu <span class="keyword">in</span> 叶金阳 杨松麟 陈亮亮 李文杰 郑佳强 罗兴林  冯靖涵 张少辉 程志伟 代杰豪 高若恒 张天鼎 张鑫 刘永飞 黄彦 王仁刚 赵阳阳 王秉诚 于超</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    mysql -uroot -p1 -e <span class="string">&quot;insert into student.stu1(name) values(&#x27;<span class="variable">$stu</span>&#x27;);&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql -uroot -p1 -e <span class="string">&quot;select * from yuchao_linux.new_students &quot;</span></span><br><span class="line">mysql -uroot -p1 -e <span class="string">&quot;desc yuchao_linux.new_students&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空表数据</span></span><br><span class="line">mysql -uroot -p1 -e <span class="string">&quot;truncate table yuchao_linux.new_students  &quot;</span></span><br></pre></td></tr></table></figure><ul><li>导入多个文件，提取信息，数据表插入数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">name_arr=(`<span class="built_in">cat</span> /root/stu_name.txt`)</span><br><span class="line">add_arr=(`<span class="built_in">cat</span> /root/address.txt`)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印俩数组变量看看</span></span><br><span class="line"><span class="comment"># 提取数组所有的值</span></span><br><span class="line"><span class="comment">#echo $&#123;name_arr[@]&#125;</span></span><br><span class="line"><span class="comment">#echo $&#123;add_arr[@]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取数组所有的索引</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#echo $&#123;!name_arr[@]&#125;</span></span><br><span class="line"><span class="comment">#echo $&#123;!add_arr[@]&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环处理数组，基于同一个索引，对应上每一行的数据，拼接出了具体的SQL</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;!stu_name[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> <span class="comment"># mysql -uroot -p1 -e &quot;insert into student.stu(name,address) values(&#x27;$&#123;stu_name[$i]&#125;&#x27;,&#x27;$&#123;add_name[$i]&#125;&#x27;)&quot;</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment"># 打印你想拼接的SQL，看看，对不对，然后再插入表</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># stu_name=([0]=&quot;松林&quot; [1]=&quot;超哥&quot; [2]=&quot;亮亮&quot; [3]=&quot;文杰&quot; [4]=&quot;加强&quot; [5]=&quot;新林&quot;)</span></span><br><span class="line"><span class="comment"># add_name=([0]=&quot;山西老板&quot; [1]=&quot;江苏小弟&quot; [2]=&quot;湖南大佬&quot; [3]=&quot;云南昆明&quot; [4]=&quot;山西大同&quot; [5]=&quot;贵州老板&quot;)</span></span><br></pre></td></tr></table></figure><h2 id="6-2-数据表修改数据"><a href="#6-2-数据表修改数据" class="headerlink" title="6.2 数据表修改数据"></a>6.2 数据表修改数据</h2><h3 id="1）帮助信息查看"><a href="#1）帮助信息查看" class="headerlink" title="1）帮助信息查看"></a>1）帮助信息查看</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ? Data Manipulation</span><br><span class="line">You asked for help about help category: &quot;Data Manipulation&quot;</span><br><span class="line">For more information, type &#x27;help &lt;item&gt;&#x27;, where &lt;item&gt; is one of the following</span><br><span class="line">topics:</span><br><span class="line">   CALL</span><br><span class="line">   DELETE</span><br><span class="line">   DO</span><br><span class="line">   DUAL</span><br><span class="line">   HANDLER</span><br><span class="line">   INSERT</span><br><span class="line">   INSERT DELAYED</span><br><span class="line">   INSERT SELECT</span><br><span class="line">   JOIN</span><br><span class="line">   LOAD DATA</span><br><span class="line">   LOAD XML</span><br><span class="line">   REPLACE</span><br><span class="line">   SELECT</span><br><span class="line">   UNION</span><br><span class="line">   UPDATE</span><br></pre></td></tr></table></figure><h3 id="2）语法说明"><a href="#2）语法说明" class="headerlink" title="2）语法说明"></a>2）语法说明</h3><p>update语句语法:</p><p>update table 表名  字段名&#x3D;新数据数据   where(指定条件对哪行修改)  id&#x3D;？ name&#x3D;？；</p><blockquote><blockquote><p>:warning:重要的事说三遍，切记update修改数据时，一定要加where匹配修改哪行， 否则会修改字段下的全部数据，误修改就凉凉了</p></blockquote></blockquote><h3 id="3）修改更新数据"><a href="#3）修改更新数据" class="headerlink" title="3）修改更新数据"></a>3）修改更新数据</h3><ul><li>针对如下数据表进行操作</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone       |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352 |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 未知      | 2024-06-02 18:34:23 | 未知        |</span><br><span class="line">|  3 | 张岩      |  23 | 女     | 未知      | 2024-06-02 18:42:13 | 未知        |</span><br><span class="line">|  4 | 王彤      |   0 | 女     | 内蒙古    | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">|  5 | 师璐      |   0 | 女     | 经纬      | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">|  6 | 曹可文    |   0 | 女     | 四中      | 2024-06-02 18:51:24 | 未知        |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+-------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>修改234记录的address字段数据，修改2-6记录的phone字段数据全部改为&#x3D;&#x3D;&#x3D;喜欢过</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#####################修改adress字段########################</span></span><br><span class="line">mysql&gt; update stu1 <span class="built_in">set</span> address=<span class="string">&#x27;大专&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=2 and  name=<span class="string">&#x27;王雨萌&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; update stu1 <span class="built_in">set</span> address=<span class="string">&#x27;经纬&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=3 and name=<span class="string">&#x27;张岩&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; update stu1 <span class="built_in">set</span> address=<span class="string">&#x27;一小&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=4;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">###################修改phone字段######################</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 2 3 4 5 6</span><br><span class="line"><span class="keyword">do</span>  mysql -uroot -p1 -e <span class="string">&quot;update student.stu1 set phone=&#x27;喜欢过祝你们幸福安康&#x27; where id=<span class="variable">$i</span>;&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###################查看数据表数据###############</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+--------------------------------+</span><br><span class="line">| <span class="built_in">id</span> | name      | age | gender | address   | intime              | phone                          |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+--------------------------------+</span><br><span class="line">|  1 | 赵东兴    |  23 | 男     | 内蒙古    | 2024-06-02 18:26:12 | 15598001352                    |</span><br><span class="line">|  2 | 王雨萌    |   0 | 女     | 大专      | 2024-06-02 18:34:23 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  3 | 张岩      |  23 | 女     | 经纬      | 2024-06-02 18:42:13 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  4 | 王彤      |   0 | 女     | 一小      | 2024-06-02 18:51:24 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  5 | 师璐      |   0 | 女     | 经纬      | 2024-06-02 18:51:24 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  6 | 曹可文    |   0 | 女     | 四中      | 2024-06-02 18:51:24 | 喜欢过祝你们幸福安康           |</span><br><span class="line">+----+-----------+-----+--------+-----------+---------------------+--------------------------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>修改1号记录的name，age，gender，address多个字段数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update stu1 <span class="built_in">set</span> name=<span class="string">&#x27;三年之后成功的男人&#x27;</span>,age=26,address=<span class="string">&#x27;北京&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br><span class="line">| <span class="built_in">id</span> | name                        | age | gender | address | intime              | phone                          |</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br><span class="line">|  1 | 三年之后成功的男人          |  26 | 男     | 北京    | 2024-06-02 18:26:12 | 15598001352    </span><br></pre></td></tr></table></figure><h2 id="6-3-数据表删除数据"><a href="#6-3-数据表删除数据" class="headerlink" title="6.3 数据表删除数据"></a>6.3 数据表删除数据</h2><h3 id="1）按行删除"><a href="#1）按行删除" class="headerlink" title="1）按行删除"></a>1）按行删除</h3><ul><li><p>delete语句，删除数据时会按行删除</p></li><li><p>只删除某行使用where匹配具体的行进行删除</p></li><li><p>删除全部数据，不指定where关键字即可，代表删除全部行数据，删除全部数据，也是基于一行一行进行删除</p></li><li><p>并且delete语句知识删除数据，不会删除主键自增记录，这里是个坑</p></li></ul><blockquote><p>delete语句语法：</p><p>delete  from  表名  where 匹配某行</p></blockquote><ul><li><strong>删除某行数</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#####################按行删除且查看检查####################</span></span><br><span class="line">mysql&gt; delete from stu1 <span class="built_in">where</span> <span class="built_in">id</span>=6;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from stu1 <span class="built_in">where</span> <span class="built_in">id</span>=5;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from stu1 <span class="built_in">where</span> <span class="built_in">id</span>=4;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br><span class="line">| <span class="built_in">id</span> | name                        | age | gender | address | intime              | phone                          |</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br><span class="line">|  1 | 三年之后成功的男人          |  26 | 男     | 北京    | 2024-06-02 18:26:12 | 15598001352                    |</span><br><span class="line">|  2 | 王雨萌                      |   0 | 女     | 大专    | 2024-06-02 18:34:23 | 喜欢过祝你们幸福安康           |</span><br><span class="line">|  3 | 张岩                        |  23 | 女     | 经纬    | 2024-06-02 18:42:13 | 喜欢过祝你们幸福安康           |</span><br><span class="line">+----+-----------------------------+-----+--------+---------+---------------------+--------------------------------+</span><br></pre></td></tr></table></figure><ul><li><strong>删除所有行数据</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from stu1;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="2）全面删除"><a href="#2）全面删除" class="headerlink" title="2）全面删除"></a>2）全面删除</h3><ul><li>truncate删除原理是，直接删除数据表，在基于该数据表创建一个新的数据表</li></ul><blockquote><p>语法：</p><p>truncate  表名</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######对该表删除#######</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">+----+------+-----+--------+---------+---------------------+-------+</span><br><span class="line">| <span class="built_in">id</span> | name | age | gender | address | intime              | phone |</span><br><span class="line">+----+------+-----+--------+---------+---------------------+-------+</span><br><span class="line">|  1 | 赵   |  23 | 男     | 包头    | 2024-06-02 20:10:04 | 888   |</span><br><span class="line">+----+------+-----+--------+---------+---------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######删除检查######</span></span><br><span class="line">mysql&gt;<span class="built_in">truncate</span> stu1;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from stu1;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3）伪删除"><a href="#3）伪删除" class="headerlink" title="3）伪删除"></a>3）伪删除</h3><p>为了有效防止delete误删除数据，可以人为限定SQL的删除逻辑</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">添加表字段，删除状态字段，0 表示被删除，1表示数据存在</span><br><span class="line"></span><br><span class="line">可以用tinyint类型，省磁盘，从 0 到 255 的整型数据。存储大小为 1 字节</span><br></pre></td></tr></table></figure><p>增加状态列</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">alter table new_students add column field_status TINYINT not null default 1 comment &#x27;字段删除状态，0 表示被删除，1表示数据存在&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; desc new_students;</span><br><span class="line">+--------------+-------------------------------------------+------+-----+-------------------+----------------+</span><br><span class="line">| Field        | Type                                      | Null | Key | Default           | Extra          |</span><br><span class="line">+--------------+-------------------------------------------+------+-----+-------------------+----------------+</span><br><span class="line">| id           | int(11)                                   | NO   | PRI | NULL              | auto_increment |</span><br><span class="line">| name         | varchar(64)                               | NO   |     | NULL              |                |</span><br><span class="line">| age          | tinyint(3)                                | NO   |     | 0                 |                |</span><br><span class="line">| gender       | enum(&#x27;男&#x27;,&#x27;女&#x27;)                           | NO   |     | NULL              |                |</span><br><span class="line">| height       | float(4,1)                                | YES  |     | NULL              |                |</span><br><span class="line">| address      | enum(&#x27;北京&#x27;,&#x27;深圳&#x27;,&#x27;云南&#x27;,&#x27;江苏&#x27;)         | NO   |     | NULL              |                |</span><br><span class="line">| intime       | datetime                                  | NO   |     | CURRENT_TIMESTAMP |                |</span><br><span class="line">| phone        | char(11)                                  | NO   |     | 0                 |                |</span><br><span class="line">| hobby        | char(20)                                  | NO   |     | 学习              |                |</span><br><span class="line">| field_status | tinyint(4)                                | NO   |     | 1                 |                |</span><br><span class="line">+--------------+-------------------------------------------+------+-----+-------------------+----------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>想删除数据用update，代替delete，取消delete的执行权限即可</p><p>兄弟，再次啰嗦，用update，务必小心，加上where条件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">删除于超数据</span><br><span class="line">mysql&gt; update new_students set field_status=0 where name=&#x27;于超&#x27;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure><p>后续的查询语句，修改为如下即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查询所有有效用户的数据</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from new_students where field_status=1;</span><br></pre></td></tr></table></figure><h1 id="7-数据库DQL查询语言"><a href="#7-数据库DQL查询语言" class="headerlink" title="7.数据库DQL查询语言"></a>7.数据库DQL查询语言</h1><h2 id="测试数据准备"><a href="#测试数据准备" class="headerlink" title="测试数据准备"></a>测试数据准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#mysql -uroot -p1 &lt; all_world.sql </span><br><span class="line"></span><br><span class="line">mysql&gt; show tables from world;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_world |</span><br><span class="line">+-----------------+</span><br><span class="line">| city            |</span><br><span class="line">| country         |</span><br><span class="line">| countrylanguage |</span><br><span class="line">+-----------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>内有大量的世界人口数据信息，基于city表进行练习</li><li>city表中，name字段：城市名，countrycode字段：国家代号，district字段：省份名，population字段：人口数量</li></ul><p><img src="/image-20240602204120564.png" alt="image-20240602204120564"></p><h2 id="7-2-内置变量查询"><a href="#7-2-内置变量查询" class="headerlink" title="7.2 内置变量查询"></a>7.2 内置变量查询</h2><h3 id="1）查询内置变量信息"><a href="#1）查询内置变量信息" class="headerlink" title="1）查询内置变量信息"></a>1）查询内置变量信息</h3><blockquote><p>语法：</p><p>show variables like %变量名%     #模糊查找，百分号匹配任意字符</p><p>用途：可根据关键字进行模糊查找，查看数据库内置变量名，与对应的变量值</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看全部变量</span></span><br><span class="line">mysql&gt; show variables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#模糊查找有关变量名及对应的变量值</span></span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%port%&#x27;</span>;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| innodb_support_xa        | ON    |</span><br><span class="line">| large_files_support      | ON    |</span><br><span class="line">| port                     | 3306  |</span><br><span class="line">| report_host              |       |</span><br><span class="line">| report_password          |       |</span><br><span class="line">| report_port              | 3306  |</span><br><span class="line">| report_user              |       |</span><br><span class="line">| require_secure_transport | OFF   |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><h3 id="2）精确查询变量值"><a href="#2）精确查询变量值" class="headerlink" title="2）精确查询变量值"></a>2）精确查询变量值</h3><blockquote><p>语法:</p><p>show variables like ‘%变量名%’   <code>#如果不知道变量名叫什么，可通过show模糊查找变量</code></p><p>select @@内置变量名               <code>#show查找确认后，再通过select精确提取变量值</code></p><blockquote><p>用途：查出数据库精确查找内置变量的值，运维通过变量观察数据库中各种数据</p></blockquote></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">1.查看数据库端口</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@port;</span><br><span class="line">+--------+</span><br><span class="line">| @@port |</span><br><span class="line">+--------+</span><br><span class="line">|   3306 |</span><br><span class="line">+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.查看数据库实例<span class="built_in">id</span>，主从复制使用</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@server_id;</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           0 |</span><br><span class="line">+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.查看数据库实例数据目录</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@datadir;</span><br><span class="line">+-----------------+</span><br><span class="line">| @@datadir       |</span><br><span class="line">+-----------------+</span><br><span class="line">| /app/data/3306/ |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.查看数据库程序安装目录</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@basedir;</span><br><span class="line">+-------------------------------------------------+</span><br><span class="line">| @@basedir                                       |</span><br><span class="line">+-------------------------------------------------+</span><br><span class="line">| /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/ |</span><br><span class="line">+-------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.查看数据库实例soket文件位置</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@socket;</span><br><span class="line">+-----------------+</span><br><span class="line">| @@socket        |</span><br><span class="line">+-----------------+</span><br><span class="line">| /tmp/mysql.sock |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6.查看数据库主键自增步长</span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;auto%&#x27;</span>;</span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@auto_increment_increment;</span><br><span class="line">+----------------------------+</span><br><span class="line">| @@auto_increment_increment |</span><br><span class="line">+----------------------------+</span><br><span class="line">|                          1 |</span><br><span class="line">+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3）修改内置变量值"><a href="#3）修改内置变量值" class="headerlink" title="3）修改内置变量值"></a>3）修改内置变量值</h3><blockquote><p>语法： set  变量名&#x3D;变量值  </p><p>set @@变量名&#x3D;变量值</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############修改自增变量############</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span>  auto_increment_increment=2;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@auto_increment_increment;</span><br><span class="line">+----------------------------+</span><br><span class="line">| @@auto_increment_increment |</span><br><span class="line">+----------------------------+</span><br><span class="line">|                          2 |</span><br><span class="line">+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############再修改回来################</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span>  @@auto_increment_increment=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@auto_increment_increment;</span><br><span class="line">+----------------------------+</span><br><span class="line">| @@auto_increment_increment |</span><br><span class="line">+----------------------------+</span><br><span class="line">|                          1 |</span><br><span class="line">+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="7-3-内置函数查询"><a href="#7-3-内置函数查询" class="headerlink" title="7.3 内置函数查询"></a>7.3 内置函数查询</h2><p>函数举例：将查询的字母全部转变成小写和大写：select lower(username), upper(username) from 表名;</p><p>函数的功能：封装了特定的一些功能，我们直接拿过来使用，可以实现对应的功能。</p><p>函数的作用：为了实现select查询的效率和能力。</p><p>类似于shell脚本的函数，将某些代码封装到函数中，当调用函数时，就会执行这些代码，可以拿到代码执行的结果。</p><h3 id="1）函数使用帮助"><a href="#1）函数使用帮助" class="headerlink" title="1）函数使用帮助"></a>1）函数使用帮助</h3><blockquote><p>语法：</p><p>？   函数名   （精确查找某函数使用帮助信息）</p></blockquote><ul><li><strong>查看函数分类</strong></li></ul><p>可查看数据库支持哪些分类的函数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> ? functions;</span><br><span class="line">You asked <span class="keyword">for</span> help about help category: &quot;Functions&quot;</span><br><span class="line"><span class="keyword">For</span> more information, type <span class="string">&#x27;help &lt;item&gt;&#x27;</span>, <span class="keyword">where</span> <span class="operator">&lt;</span>item<span class="operator">&gt;</span> <span class="keyword">is</span> <span class="keyword">one</span> <span class="keyword">of</span> the following</span><br><span class="line">categories:</span><br><span class="line">   Bit Functions位函数</span><br><span class="line">   Comparison operators比较运算符</span><br><span class="line">   Control flow functions控制流函数</span><br><span class="line">   <span class="type">Date</span> <span class="keyword">and</span> <span class="type">Time</span> Functions日期和时间函数</span><br><span class="line">   Encryption Functions加密函数</span><br><span class="line">   Information Functions信息函数</span><br><span class="line">   Logical operators逻辑运算符</span><br><span class="line">   Miscellaneous Functions 其他函数</span><br><span class="line">   <span class="type">Numeric</span> Functions数字函数</span><br><span class="line">   String Functions字符串函数</span><br></pre></td></tr></table></figure><ul><li><strong>查看时间分类函数</strong></li></ul><p>查看具体分类函数内，支持内些相关函数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> ? <span class="type">Date</span> <span class="keyword">and</span> <span class="type">Time</span> Functions</span><br><span class="line">You asked <span class="keyword">for</span> help about help category: &quot;Date and Time Functions&quot;</span><br><span class="line"><span class="keyword">For</span> more information, type <span class="string">&#x27;help &lt;item&gt;&#x27;</span>, <span class="keyword">where</span> <span class="operator">&lt;</span>item<span class="operator">&gt;</span> <span class="keyword">is</span> <span class="keyword">one</span> <span class="keyword">of</span> the following</span><br><span class="line">topics:</span><br></pre></td></tr></table></figure><p><img src="/image-20240603164817674.png" alt="image-20240603164817674"></p><ul><li><strong>查看某函数帮助信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> ? now</span><br></pre></td></tr></table></figure><p><img src="/image-20240603165322643.png" alt="image-20240603165322643"></p><h3 id="2）常用函数使用"><a href="#2）常用函数使用" class="headerlink" title="2）常用函数使用"></a>2）常用函数使用</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#查看当前连接数据库的用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>();</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>()         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> root<span class="variable">@localhost</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前所在的库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> database();</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> database() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前的时间</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> now();</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> now()               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">06</span>:<span class="number">38</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="7-4-show查询"><a href="#7-4-show查询" class="headerlink" title="7.4 show查询"></a>7.4 <em>show</em>查询</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span>语句有许多形式，提供关于服务器的数据库、表、列或状态信息的信息。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span>语法格式：</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> 关键字 <span class="keyword">LIKE</span> <span class="string">&#x27;pattern&#x27;</span></span><br><span class="line"></span><br><span class="line">如果对于一个给定的说明语句的语法包括像<span class="string">&#x27;模式&#x27;</span>，<span class="string">&#x27;模式&#x27;</span>是一个字符串，可以包含“<span class="operator">%</span>”和“_“通配符。该模式是有用的限制语句输出匹配的值。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES – 显示当前所有数据库的名称</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> TABLES <span class="keyword">FROM</span> db_name – 显示数据库中的所有表</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> ENGINES – 显示MySQL当前支持哪些存储引擎和默认存储引擎</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> – 显示MySQL当前支持哪些字符集</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">COLLATION</span> – 显示MySQL支持字符集的排序规则</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> <span class="operator">|</span> MASTER – 显示二进制文件以及文件大小（需要开启二进制日志记录功能</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> BINLOG EVENTS – 显示二进制文件的执行过程</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> COLUMNS – 显示表的列信息（等同于<span class="keyword">DESC</span>，需要先创建表）</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> DATABASES – 显示已经创建的库，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> – 显示已经创建的表，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> FUNTCION  – 显示已经创建的函数，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> – 显示已经创建的存储过程，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> <span class="operator">-</span> 显示已经创建的触发器，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> – 显示已经创建的视图，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> EVENTS – 显示已经创建的事件，创建时的语句</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> ENGINE – 显示存储引擎的详细信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> WARNINGS – 显示最后一个执行语句所产生的警告信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> ERRORS – 显示最后一个执行语句所产生的错误信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> EVENTS – 显示事件信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS – 显示一个用户所拥有的权限</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST – 显示系统中正在运行的所有进程，普通用户只能查看自己的进行信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> PRIVILEGES – 显示MySQL所支持的所有权限，及权限可操作的对象</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> PLUGINS – 显示MySQL插件信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS – 显示Master当前正在使用的二进制信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS – 显示表属性信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> INDEX – 显示表索引信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> STATUS – 显示存储过程信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FUNCTION</span> STATUS – 显示存储函数信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> TRIGGERS – 显示触发器信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> PROFILE <span class="keyword">and</span> <span class="keyword">SHOW</span> PROFILES – 显示执行语句的资源使用情况</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE HOSTS – 显示Master主机上已注册的复制主机列表</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS – 显示Slave主机状态信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="operator">|</span> SESSION STATUS – 显示MySQL状态变量信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="operator">|</span> SESSION VARIABLES – 显示MySQL系统变量信息</span><br></pre></td></tr></table></figure><ul><li>查看数据库所有库</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| employees          |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| stu                |</span><br><span class="line">| sys                |</span><br><span class="line">| world              |</span><br><span class="line">+--------------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>查看数据库创建库与数据表的sql语句</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database stu;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Create</span> Database                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> stu      <span class="operator">|</span> <span class="keyword">CREATE</span> DATABASE `stu` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 */</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">  `name` <span class="type">char</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>查看数据库内置变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;%port%&#x27;</span>;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| innodb_support_xa        | ON    |</span><br><span class="line">| large_files_support      | ON    |</span><br><span class="line">| port                     | 3306  |</span><br><span class="line">| report_host              |       |</span><br><span class="line">| report_password          |       |</span><br><span class="line">| report_port              | 3306  |</span><br><span class="line">| report_user              |       |</span><br><span class="line">| require_secure_transport | OFF   |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><ul><li>查看当前数据库实例使用的引擎</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%storage%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> default_storage_engine           <span class="operator">|</span> InnoDB <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> default_tmp_storage_engine       <span class="operator">|</span> InnoDB <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> disabled_storage_engines         <span class="operator">|</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> internal_tmp_disk_storage_engine <span class="operator">|</span> InnoDB <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+--------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="子查询语句顺序"><a href="#子查询语句顺序" class="headerlink" title="子查询语句顺序"></a>子查询语句顺序</h2><p><img src="/1659601941650.png" alt="1659601941650"></p><h2 id="7-4-select查询"><a href="#7-4-select查询" class="headerlink" title="7.4 select查询"></a>7.4 <em>select</em>查询</h2><ul><li>查看数据表数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>  stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> 赵   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>查看数据库内置函数值</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#查看当前所在的库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> database();</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> database() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#查看当前的时间</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> now();</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> now()               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-03</span> <span class="number">17</span>:<span class="number">06</span>:<span class="number">38</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>查看数据库内置变量值</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> @@port;</span><br><span class="line">+--------+</span><br><span class="line">| @@port |</span><br><span class="line">+--------+</span><br><span class="line">|   3306 |</span><br><span class="line">+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="7-6-where子查询"><a href="#7-6-where子查询" class="headerlink" title="7.6 where子查询"></a>7.6 <em>where</em>子查询</h2><p>where子句可以限定一些条件，根据用户需求，在数据表中查找对应的数据</p><blockquote><p>语法：</p><p>select     字段名     from    表   where  字段&#x3D;关键字</p><p>select     字段名     from    表   where  字段  like  %关键字%</p><p>select     字段名     from    表   where  字段&#x3D;关键字 or 字段&#x3D;关键字</p><p>select     字段名     from    表   where  字段&#x3D;关键字 and 字段&#x3D;关键字</p></blockquote><blockquote><p>对world库中city数据表进行查询练习</p></blockquote><ul><li><strong>查询所有城市名，以及人口数</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select name,Population from world.city;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603183119185.png" alt="image-20240603183119185"></p><ul><li><strong>查询city表里，所有中国的城市信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240603183749556.png" alt="image-20240603183749556"></p><ul><li><strong>查询人口数小于500人城市信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> Population<span class="operator">&lt;</span><span class="number">500</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240603183903216.png" alt="image-20240603183903216"></p><ul><li><strong>查询中国,人口数超过500w的所有城市信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> Population <span class="operator">&gt;</span><span class="number">5000000</span> <span class="keyword">and</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240603184203794.png" alt="image-20240603184203794"></p><ul><li><strong>查询中国或者美国的城市信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#语法<span class="number">1</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span> <span class="keyword">or</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span></span><br><span class="line"></span><br><span class="line">#语法<span class="number">2</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode <span class="keyword">in</span> (<span class="string">&#x27;chn&#x27;</span>,<span class="string">&#x27;usa&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="/image-20240603184820655.png" alt="image-20240603184820655"></p><ul><li><strong>查询人口在200万到500万之间的城市所有信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#语法一</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> Population <span class="operator">&gt;</span><span class="number">2000000</span> <span class="keyword">and</span> Population <span class="operator">&lt;</span><span class="number">5000000</span></span><br><span class="line"></span><br><span class="line">#语法二</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> Population <span class="keyword">BETWEEN</span> <span class="number">2000000</span> <span class="keyword">and</span> <span class="number">5000000</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240603185046476.png" alt="image-20240603185046476"></p><ul><li><strong>查询中国或者美国，人口数大于500万的城市</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode <span class="keyword">IN</span> (<span class="string">&#x27;CHN&#x27;</span>,<span class="string">&#x27;USA&#x27;</span>) <span class="keyword">and</span> Population <span class="operator">&gt;</span> <span class="number">5000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> (CountryCode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span> <span class="keyword">or</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>) <span class="keyword">and</span> Population <span class="operator">&gt;</span><span class="number">5000000</span>;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603185949966.png" alt="image-20240603185949966"></p><ul><li><strong>查询城市名以qing开头的城市</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>  city  <span class="keyword">where</span>  name <span class="keyword">like</span>  <span class="string">&#x27;qing%&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603185709223.png" alt="image-20240603185709223"></p><ul><li><strong>查询淮安市的人口数量</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span>  name <span class="keyword">like</span> <span class="string">&#x27;huai%&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603191339550.png" alt="image-20240603191339550"></p><h2 id="7-7-Group-by聚合函数"><a href="#7-7-Group-by聚合函数" class="headerlink" title="7.7 Group_by聚合函数"></a>7.7 <em>Group_by</em>聚合函数</h2><p>聚合函数,是一类在数据库中用于对多个行进行计算并返回单个结果的函数。</p><p>它们能够对数据进行汇总、统计和计算，常用于提取有关数据集的摘要信息。</p><p>聚合函数在SQL查询中广泛应用，包括统计总数、平均值、最大值、最小V值等。</p><p>这些函数通常与 GROUP BY 子句一起使用，以便根据一个或多个列对数据进行分组，并将聚合函数应用于每个分组。</p><p><strong>常用聚合函</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">count() 统计数量 </span><br><span class="line">sum() 求和</span><br><span class="line">avg() 平均数</span><br><span class="line">max() 最大值</span><br><span class="line">min() 最小值</span><br><span class="line">group_concat() GROUP_CONCAT函数返回一个字符串结果，该结果由分组中的值连接组合而成。</span><br></pre></td></tr></table></figure><p><strong>group by 分组功能原理</strong></p><p>1.按分组条件进行排序，</p><p>2.进行分组列的去重，</p><p>3.聚合函数将其他列的结果聚合</p><p><strong>group by聚合函数练习题</strong></p><ul><li>统计city表有多少行数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">4079</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>统计中国城市的个数</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(name) <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">363</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>统计中国总人口数</li><li>where子句，先匹配countrycode字段为CHN的所有数据，再使用sum函数对population人口字段进行计算</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">sum</span>(Population) <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">sum</span>(Population) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">175953614</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>统计每个国家的城市个数</li><li>使用croup by分组子句，进行对countrycode字段国家分组，相同字段为一组，count最后对每组的name字段统计数量</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> CountryCode,<span class="built_in">count</span>(name) <span class="keyword">from</span> city <span class="keyword">GROUP</span> <span class="keyword">BY</span> CountryCode;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> CountryCode <span class="operator">|</span> <span class="built_in">count</span>(name) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> ABW         <span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AFG         <span class="operator">|</span>           <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AGO         <span class="operator">|</span>           <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AIA         <span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ALB         <span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">AND</span>         <span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ANT         <span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">ARE</span>         <span class="operator">|</span>           <span class="number">5</span> <span class="operator">|</span></span><br></pre></td></tr></table></figure><ul><li>统计USA美国的城市总数</li><li>指定字段匹配数据时，也可以不区分大小写，和排序规则有关，当前排序规则不区分大小写，都可以显示出来</li><li>as关键字，可以在数据输出显示时，上方字段名可临时通过as定义的字符显示</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> count(name) as <span class="string">&#x27;城市总数&#x27;</span>  from city <span class="built_in">where</span> countrycode=<span class="string">&#x27;usa&#x27;</span>;</span><br><span class="line">+--------------+</span><br><span class="line">| 城市总数     |</span><br><span class="line">+--------------+</span><br><span class="line">|          274 |</span><br><span class="line">+--------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li>统计每个国家的总人口数</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span>  countrycode <span class="keyword">as</span> <span class="string">&#x27;国家&#x27;</span>,<span class="built_in">sum</span>(Population) <span class="keyword">as</span> <span class="string">&#x27;人口数量&#x27;</span> <span class="keyword">from</span> city <span class="keyword">group</span> <span class="keyword">by</span> countrycode;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 国家   <span class="operator">|</span> 人口数量     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="operator">|</span> ABW    <span class="operator">|</span>        <span class="number">29034</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AFG    <span class="operator">|</span>      <span class="number">2332100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AGO    <span class="operator">|</span>      <span class="number">2561600</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> AIA    <span class="operator">|</span>         <span class="number">1556</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ALB    <span class="operator">|</span>       <span class="number">270000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">AND</span>    <span class="operator">|</span>        <span class="number">21189</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ANT    <span class="operator">|</span>         <span class="number">2345</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">ARE</span>    <span class="operator">|</span>      <span class="number">1728336</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ARG    <span class="operator">|</span>     <span class="number">19996563</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ARM    <span class="operator">|</span>      <span class="number">1633100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ASM    <span class="operator">|</span>         <span class="number">7523</span> <span class="operator">|</span></span><br><span class="line">#######太长省略##########</span><br></pre></td></tr></table></figure><ul><li>统计中国每个省的城市个数和城市名</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> district as <span class="string">&#x27;省&#x27;</span>,count(name) as <span class="string">&#x27;城市数&#x27;</span>,group_concat(name) as <span class="string">&#x27;城市名&#x27;</span> from city <span class="built_in">where</span> countrycode=<span class="string">&#x27;chn&#x27;</span> group by district;</span><br></pre></td></tr></table></figure><p><img src="/image-20240603210948095.png" alt="image-20240603210948095">                                                      </p><h2 id="7-8-having聚合判断"><a href="#7-8-having聚合判断" class="headerlink" title="7.8 having聚合判断"></a>7.8 <em>having</em>聚合判断</h2><p>当group by 排序分组后，如果还要做条件判断提取数据，使用having子句用于对分组的过滤</p><p><strong>Having 练习题</strong></p><ul><li>统计每个国家的总人口数，只显示人口超过1亿的国家信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> countrycode as <span class="string">&#x27;国家&#x27;</span>,<span class="built_in">sum</span>(population) as <span class="string">&#x27;人口数&#x27;</span> from city group by countrycode having  <span class="built_in">sum</span>(population) &gt;100000000;</span><br><span class="line">+--------+-----------+</span><br><span class="line">| 国家   | 人口数    |</span><br><span class="line">+--------+-----------+</span><br><span class="line">| CHN    | 175953614 |</span><br><span class="line">| IND    | 123298526 |</span><br><span class="line">+--------+-----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure><h2 id="7-9-Order-by聚合排序"><a href="#7-9-Order-by聚合排序" class="headerlink" title="7.9 Order_by聚合排序"></a>7.9 <em>Order_by</em>聚合排序</h2><ul><li>查询所有城市信息，按人口数字段排序输出，按数字顺序正序从小到大输出</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人口顺序&#x27;</span> <span class="keyword">from</span> city <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 城市                  <span class="operator">|</span> 人口顺序     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> Adamstown             <span class="operator">|</span>           <span class="number">42</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> West Island           <span class="operator">|</span>          <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Fakaofo               <span class="operator">|</span>          <span class="number">300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CittÃ  del Vaticano   <span class="operator">|</span>          <span class="number">455</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Bantam                <span class="operator">|</span>          <span class="number">503</span> <span class="operator">|</span></span><br><span class="line">########太长后面省略###########</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#逆序输出</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人口顺序&#x27;</span> <span class="keyword">from</span> city <span class="keyword">order</span> <span class="keyword">by</span> population <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><ul><li>查询中国所有城市信息，且按照人口数从大到小排序输出</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人口逆序&#x27;</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;chn&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> population <span class="keyword">desc</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 城市      <span class="operator">|</span> 人口逆序     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+--------------+</span></span><br><span class="line"><span class="operator">|</span> Shanghai  <span class="operator">|</span>      <span class="number">9696300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Peking    <span class="operator">|</span>      <span class="number">7472000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Chongqing <span class="operator">|</span>      <span class="number">6351600</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Tianjin   <span class="operator">|</span>      <span class="number">5286800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Wuhan     <span class="operator">|</span>      <span class="number">4344600</span> <span class="operator">|</span></span><br><span class="line">########太长后面省略###########</span><br></pre></td></tr></table></figure><ul><li>查看每个国家的总人口数，总人口超过5000w的信息,并按总人口数从大到小排序输出</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> countrycode <span class="keyword">as</span> <span class="string">&#x27;国家&#x27;</span>,<span class="built_in">sum</span>(population) <span class="keyword">as</span> <span class="string">&#x27;人口逆序&#x27;</span><span class="keyword">from</span> city <span class="keyword">group</span> <span class="keyword">by</span> countrycode <span class="keyword">having</span> <span class="built_in">sum</span>(population) <span class="operator">&gt;</span><span class="number">50000000</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">sum</span>(population) <span class="keyword">desc</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 国家   <span class="operator">|</span> 人口逆序     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="operator">|</span> CHN    <span class="operator">|</span>    <span class="number">175953614</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> IND    <span class="operator">|</span>    <span class="number">123298526</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BRA    <span class="operator">|</span>     <span class="number">85876862</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> USA    <span class="operator">|</span>     <span class="number">78625774</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> JPN    <span class="operator">|</span>     <span class="number">77965107</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> RUS    <span class="operator">|</span>     <span class="number">69150700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MEX    <span class="operator">|</span>     <span class="number">59752521</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="8-0-limit分页查询"><a href="#8-0-limit分页查询" class="headerlink" title="8.0 limit分页查询"></a>8.0 <em>limit</em>分页查询</h2><ul><li>查询中国所有城市信息，以人口数从大到小排序，只显示前十名。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人口前十&#x27;</span> <span class="keyword">from</span> city  <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;chn&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span>  population <span class="keyword">desc</span>  limit <span class="number">10</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> 城市               <span class="operator">|</span> 人口前十     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> Shanghai           <span class="operator">|</span>      <span class="number">9696300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Peking             <span class="operator">|</span>      <span class="number">7472000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Chongqing          <span class="operator">|</span>      <span class="number">6351600</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Tianjin            <span class="operator">|</span>      <span class="number">5286800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Wuhan              <span class="operator">|</span>      <span class="number">4344600</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Harbin             <span class="operator">|</span>      <span class="number">4289800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Shenyang           <span class="operator">|</span>      <span class="number">4265200</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Kanton [Guangzhou] <span class="operator">|</span>      <span class="number">4256300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Chengdu            <span class="operator">|</span>      <span class="number">3361500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Nanking [Nanjing]  <span class="operator">|</span>      <span class="number">2870300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><ul><li>查询中国所有的城市信息，并按照人口数从大到小排序输出，只显示6-10名</li></ul><blockquote><p>语法</p><p>limit  起点,条数</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;城市&#x27;</span>,population <span class="keyword">as</span> <span class="string">&#x27;人数&#x27;</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;chn&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> population <span class="keyword">desc</span> limit <span class="number">5</span>,<span class="number">5</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> 城市               <span class="operator">|</span> 人数    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> Harbin             <span class="operator">|</span> <span class="number">4289800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Shenyang           <span class="operator">|</span> <span class="number">4265200</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Kanton [Guangzhou] <span class="operator">|</span> <span class="number">4256300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Chengdu            <span class="operator">|</span> <span class="number">3361500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Nanking [Nanjing]  <span class="operator">|</span> <span class="number">2870300</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#写法<span class="number">2</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> Population <span class="keyword">desc</span> limit <span class="number">5</span> <span class="keyword">offset</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-数据库服务SQL语句分类&quot;&gt;&lt;a href=&quot;#1-数据库服务SQL语句分类&quot; class=&quot;headerlink&quot; title=&quot;1.数据库服务SQL语句分类&quot;&gt;&lt;/a&gt;1.数据库服务SQL语句分类&lt;/h1&gt;&lt;h2 id=&quot;1-1-SQL语句是什么&quot;&gt;&lt;a </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-安装部署</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</id>
    <published>2024-08-20T01:22:05.000Z</published>
    <updated>2024-08-20T01:26:20.067Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-数据库二进制安装"><a href="#1-数据库二进制安装" class="headerlink" title="1.数据库二进制安装"></a>1.数据库二进制安装</h1><ul><li><p>官网-二进制包安装地址</p><p> <a href="https://downloads.mysql.com/archives/community/">https://downloads.mysql.com/archives/community/</a></p></li></ul><h2 id="1-1-基础概念"><a href="#1-1-基础概念" class="headerlink" title="1.1 基础概念"></a>1.1 基础概念</h2><p><strong>什么是数据库初始化</strong></p><p>数据库初始化是指在使用MySQL数据库之前，对数据库系统进行的一系列准备工作，包括创建数据库实例、设置必要的参数和配置，以及准备数据库环境等操作。</p><p><strong>初始化的作用和意义</strong></p><p>数据库初始化的主要作用是确保数据库系统的正常运行，提供一个可用的数据库环境给用户进行数据存储、管理和操作。通过初始化，可以设定数据库系统的基本配置，保证数据安全性和完整性，提高系统性能，以及方便后续的数据库管理和维护工作。</p><p><strong>为什么需要初始化MySQL数据库</strong></p><p>在使用MySQL数据库之前，进行数据库初始化是非常重要的。通过初始化可以确保数据库系统的稳定性和安全性，防范数据丢失和系统故障的风险；同时，初始化还可以根据实际需求定制数据库配置，优化数据库性能，提升数据处理效率，确保数据库系统能够满足业务需求。</p><h2 id="1-2-安装部署"><a href="#1-2-安装部署" class="headerlink" title="1.2 安装部署"></a>1.2 安装部署</h2><ul><li>安装方式: mysql5.7二进制包安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">ls</span></span><br><span class="line">mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建mysql软件存放目录和mysql数据存放目录</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">mkdir</span> -p /app/&#123;tools,data&#125;</span><br><span class="line">[root@db-51 ~]#tree /app</span><br><span class="line">/app</span><br><span class="line">├── data</span><br><span class="line">└── tools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#解压放入指定目录</span></span><br><span class="line">[root@db-51 ~]#tar -xf mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz -C /app/tools/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建软链接，用于方便升级版本</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">ln</span> -s /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/ /app/tools/mysql</span><br><span class="line">[root@db-51 ~]#ll /app/tools/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx. 1 root root  47 May 20 11:26 mysql -&gt; /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x. 9 root root 129 May 20 11:25 mysql-5.7.20-linux-glibc2.12-x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql管理命令加入PATH环境变量，可绝对路径执行命令</span></span><br><span class="line"><span class="comment">##查看管理命令</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">ls</span> /app/tools/mysql/bin/</span><br><span class="line"><span class="comment">##加入全局环境变量</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">tail</span> -1 /etc/profile</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/app/tools/mysql/bin</span><br><span class="line"><span class="comment">##加载</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment">##检查</span></span><br><span class="line">[root@db-51 ~]#mysql -V</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.20, <span class="keyword">for</span> linux-glibc2.12 (x86_64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查是否有mariadb依赖，如果有删除，否则安装mysql时会报错</span></span><br><span class="line">[root@db-51 ~]#rpm -qa|grep mariadb</span><br><span class="line">mariadb-libs-5.5.68-1.el7.x86_64</span><br><span class="line">[root@db-51 ~]#yum remove mariadb-libs-5.5.68-1.el7.x86_64 -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装mysql特有依赖</span></span><br><span class="line">yum install libaio-devel -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建mysql运行用户，降低权限</span></span><br><span class="line">[root@db-51 ~]#useradd -s /sbin/nologin -M mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建mysql数据存放目录，并且授予权限</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">mkdir</span> /app/data/3306</span><br><span class="line">[root@db-51 ~]#<span class="built_in">chown</span> -R mysql.mysql /app/data</span><br><span class="line">[root@db-51 ~]#<span class="built_in">chown</span> -R mysql.mysql /app/tools/mysql*</span><br><span class="line"><span class="comment">##检查</span></span><br><span class="line">[root@db-51 ~]#ll -d /app/data/3306/ /app/tools/mysql*</span><br><span class="line">drwxr-xr-x. 2 mysql mysql   6 May 20 11:49 /app/data/3306/</span><br><span class="line">lrwxrwxrwx. 1 mysql mysql  47 May 20 11:26 /app/tools/mysql -&gt; /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x. 9 mysql mysql 129 May 20 11:25 /app/tools/mysql-5.7.20-linux-glibc2.12-x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化mysql，多次初始化同样配置信息会报错</span></span><br><span class="line">[root@db-51 ~]#mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3306/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件修改</span></span><br><span class="line"><span class="comment">##mysql基于如下配置进行启动</span></span><br><span class="line"><span class="comment">##[mysqld]：mysql服务端配置  soket: 本地进程套接字文件，可基于该socket文件进行连接服务端</span></span><br><span class="line"><span class="comment">##[mysql ]：mysql客户端配置  soket: 客户端指定服务端的soket文件位置，可连接到服务端</span></span><br><span class="line"><span class="comment">##basedir：mysql安装目录  datadir: mysql初始化后的数据存放目录</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/my.cnf &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/app/tools/mysql</span><br><span class="line">datadir=/app/data/3306</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock  </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#拷贝mysql管理脚本到/etc/init.d/下</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cp</span> /app/tools/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">[root@db-51 ~]#ll /etc/init.d/mysqld -d</span><br><span class="line">-rwxr-xr-x. 1 root root 10576 May 20 12:13 /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#systemctl启动mysql,记得加上enable这一步</span></span><br><span class="line"><span class="comment">#否则系统无法识别外部程序脚本，systemctl命令无法使用</span></span><br><span class="line">[root@db-51 ~]#systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line">[root@db-51 ~]#systemctl start mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">[root@db-51 ~]#ss -tunlp|grep 3306</span><br><span class="line">tcp    LISTEN     0      70     [::]:33060              [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">30117</span>,fd=<span class="number">20</span>))</span><br><span class="line">tcp    LISTEN     0      128    [::]:3306               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">30117</span>,fd=<span class="number">22</span>))</span><br><span class="line">[root@db-51 ~]#ps -ef|grep mysql</span><br><span class="line">root      78817      1  1 12:26 ?        00:00:00 /bin/sh /app/tools/mysql/bin/mysqld_safe --datadir=/app/data/3306 --pid-file=/app/data/3306/db-51.pid</span><br><span class="line">mysql     78973  78817  4 12:26 ?        00:00:00 /app/tools/mysql/bin/mysqld --basedir=/app/tools/mysql --datadir=/app/data/3306 --plugin-dir=/app/tools/mysql/lib/plugin --user=mysql --log-error=db-51.err --pid-file=/app/data/3306/db-51.pid --socket=/tmp/mysql.sock --port=3306</span><br><span class="line">root      79019  72950  0 12:26 pts/0    00:00:00 grep --color=auto mysql</span><br></pre></td></tr></table></figure><h1 id="3-数据库多实例部署"><a href="#3-数据库多实例部署" class="headerlink" title="3.数据库多实例部署"></a>3.数据库多实例部署</h1><h2 id="3-1-基础概念"><a href="#3-1-基础概念" class="headerlink" title="3.1 基础概念"></a>3.1 基础概念</h2><p><strong>什么是多实例及多实例的优缺点</strong></p><p>就是在一台服务器上开启多个不同的服务端口，比如3306、3307、3308…，运行多个不同的MySQL服务。</p><p>这些MySQL多实例共用一套安装程序（<code>命令</code>），使用不同的配置文件、启动程序、数据文件；多实例对硬件资源的获取通过配置文件来指定。</p><p><strong>优点</strong></p><p>可以有效利用服务器资源。当单个服务器资源充足时，可以充分利用剩余资源；节约资源。需要独立的数据库服务，并且需要主从同步的情况下。</p><p><strong>缺点</strong></p><p>当某一个实例消耗大量的CPU、内存时会影响其它实例提供的服务质量。</p><p><strong>多实例应用场景</strong></p><p>需要数据库单独提供服务，并且需要进行主从同步，服务并发量不大，服务器的资源很充足。</p><h2 id="3-2-多实例部署"><a href="#3-2-多实例部署" class="headerlink" title="3.2 多实例部署"></a>3.2 多实例部署</h2><p><strong>目标:</strong> </p><p>基于本地mysql应用，生成3306.3307.3308三个实例</p><p>并且通过shell脚本启停管理3307与3308实例</p><h3 id="1）生成3307与3308实例"><a href="#1）生成3307与3308实例" class="headerlink" title="1）生成3307与3308实例"></a>1）生成3307与3308实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建多实例3307与3308数据目录</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">mkdir</span> /app/data/&#123;3307,3308&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#授予数据目录权限</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">chown</span> -R mysql.mysql /app/data/</span><br><span class="line">[root@db-51 ~]#ll -d /app/data/3307 /app/data/3308</span><br><span class="line">drwxr-xr-x. 2 mysql mysql 6 May 20 13:32 /app/data/3307</span><br><span class="line">drwxr-xr-x. 2 mysql mysql 6 May 20 13:32 /app/data/3308</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化3307与3308多实例</span></span><br><span class="line"><span class="comment">##--user:  指定初始时生成的数据文件所属权限</span></span><br><span class="line"><span class="comment">##--basedir：mysql应用程序安装目录</span></span><br><span class="line"><span class="comment">##--daradir：mysql管理的数据库目录</span></span><br><span class="line">[root@db-51 ~]#mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3307</span><br><span class="line">[root@db-51 ~]#mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3308</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建多实例3307与3308配置文件,修改socket与数据目录即可</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cat</span> /etc/mysql_3307.cnf  /etc/mysql_3308.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">port=3307</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/opt/mysql/</span><br><span class="line">datadir=/app/data/3307/</span><br><span class="line">socket=/app/data/3307/mysql.sock</span><br><span class="line">log_error=/app/data/3307/mysql.log</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">port=3308</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/opt/mysql/</span><br><span class="line">datadir=/app/data/3308/</span><br><span class="line">socket=/app/data/3308/mysql.sock</span><br><span class="line">log_error=/app/data/3308/mysql.log</span><br></pre></td></tr></table></figure><h3 id="2）多实例管理脚本"><a href="#2）多实例管理脚本" class="headerlink" title="2）多实例管理脚本"></a>2）多实例管理脚本</h3><blockquote><p>通过shell脚本管理多实例mysql的启动停止</p><p>每个实例修改脚本中定义变量端口即可使用</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[root@db-51 ~]#cat /app/data/3307/3307.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#实例端口</span></span><br><span class="line">port=<span class="string">&quot;3307&quot;</span></span><br><span class="line"><span class="comment">#实例运行用户</span></span><br><span class="line">mysql_user=<span class="string">&quot;mysql&quot;</span></span><br><span class="line"><span class="comment">#mysql应用目录</span></span><br><span class="line">Cmdpath=<span class="string">&quot;/app/tools/mysql/bin&quot;</span></span><br><span class="line"><span class="comment">#实例生成的sock存放文件</span></span><br><span class="line">mysql_sock=<span class="string">&quot;/app/data/<span class="variable">$&#123;port&#125;</span>/mysql_<span class="variable">$&#123;port&#125;</span>.sock&quot;</span></span><br><span class="line"><span class="comment">#实例生成的进程pid存放文件</span></span><br><span class="line">mysqld_pid_file_path=<span class="string">&quot;/app/data/<span class="variable">$&#123;port&#125;</span>/mysql_<span class="variable">$&#123;port&#125;</span>.pid&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动函数</span></span><br><span class="line"><span class="function"><span class="title">start</span></span>()&#123;</span><br><span class="line"><span class="comment">#判断实例的sock文件是否存在，不存在说明未启动，则进行启动</span></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$mysql_sock</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;Starting MySQL...\n&quot;</span></span><br><span class="line">    <span class="comment">#调用mysql自带脚本参数，调用上方变量，进行启动实例</span></span><br><span class="line">    /bin/sh <span class="variable">$&#123;Cmdpath&#125;</span>/mysqld_safe --defaults-file=/etc/mysql_<span class="variable">$&#123;port&#125;</span>.cnf --pid-file=<span class="variable">$mysqld_pid_file_path</span> 2&gt;&amp;1 &gt; /dev/null &amp;</span><br><span class="line">    <span class="built_in">sleep</span> 3</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">#如果存在就显示正在运行中</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;MySQL is running...\n&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭函数</span></span><br><span class="line"><span class="function"><span class="title">stop</span></span>()&#123;</span><br><span class="line"><span class="comment">#判断实例socket文件是否存在，不存在，显示关闭</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$mysql_sock</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;MySQL is stopped...\n&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="comment">#存在则查看实例的进程pid，kill结束进程</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;Stoping MySQL...\n&quot;</span></span><br><span class="line">        mysqld_pid=`<span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$mysqld_pid_file_path</span>&quot;</span>`</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">kill</span> -0 <span class="variable">$mysqld_pid</span> 2&gt;/dev/null)</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">kill</span> <span class="variable">$mysqld_pid</span></span><br><span class="line">        <span class="built_in">sleep</span> 2</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启函数</span></span><br><span class="line"><span class="comment">#调用关闭函数，再调用重启函数</span></span><br><span class="line"><span class="function"><span class="title">restart</span></span>()&#123;</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;Restarting MySQL...\n&quot;</span></span><br><span class="line">    stop</span><br><span class="line">    <span class="built_in">sleep</span> 2</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#位置变量传递参数判断，传递数字，进行调用函数</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    start</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">    stop</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">    restart</span><br><span class="line">;;</span><br><span class="line"><span class="comment">#都没匹配到打印错误提示</span></span><br><span class="line">*)</span><br><span class="line">   <span class="built_in">printf</span> <span class="string">&quot;Usage: /data/<span class="variable">$&#123;port&#125;</span>/mysql&#123;start|stop|restart&#125;\n&quot;</span></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><h3 id="3）启动多实例"><a href="#3）启动多实例" class="headerlink" title="3）启动多实例"></a>3）启动多实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 ~]#bash /app/data/3307/3307.sh start</span><br><span class="line">Starting MySQL...</span><br><span class="line">[root@db-51 ~]#bash /app/data/3308/3308.sh start</span><br><span class="line">Starting MySQL...</span><br></pre></td></tr></table></figure><h3 id="4）检查多实例"><a href="#4）检查多实例" class="headerlink" title="4）检查多实例"></a>4）检查多实例</h3><ul><li>检查端口进程</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#端口</span></span><br><span class="line">[root@db-51 ~]#ss -tunlp|egrep <span class="string">&#x27;3308|3307&#x27;</span></span><br><span class="line">tcp    LISTEN     0      80     [::]:3307               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">84469</span>,fd=<span class="number">28</span>))</span><br><span class="line">tcp    LISTEN     0      80     [::]:3308               [::]:*                   <span class="built_in">users</span>:((&quot;mysqld&quot;,pid=<span class="number">84658</span>,fd=<span class="number">28</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#进程</span></span><br><span class="line">ps -ef|grep mysql</span><br></pre></td></tr></table></figure><ul><li>检查多实例pid文件与socket文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#两个实例的pid文件</span></span><br><span class="line">[root@db-51 ~]#find /app/data/ -<span class="built_in">type</span> f -name *.pid</span><br><span class="line">/app/data/3307/mysql_3307.pid</span><br><span class="line">/app/data/3308/mysql_3308.pid</span><br><span class="line">[root@db-51 ~]#find /app/data/ -<span class="built_in">type</span> f -name *.pid|xargs <span class="built_in">cat</span></span><br><span class="line">84469</span><br><span class="line">84658</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#两个实例的socket文件</span></span><br><span class="line"><span class="comment">##socket文件无法查看内容，是基于进程启动后生成的虚拟内容文件，只用于连接</span></span><br><span class="line">[root@db-51 ~]#find /app/data/  -name  mysql.sock</span><br><span class="line">/app/data/3307/mysql.sock</span><br><span class="line">/app/data/3308/mysql.sock</span><br><span class="line">[root@db-51 ~]#find /app/data/  -name  mysql.sock|xargs <span class="built_in">ls</span>  -dl</span><br><span class="line">srwxrwxrwx. 1 mysql mysql 0 May 20 14:25 /app/data/3307/mysql.sock</span><br><span class="line">srwxrwxrwx. 1 mysql mysql 0 May 20 14:25 /app/data/3308/mysql.sock</span><br></pre></td></tr></table></figure><h3 id="5）修改多实例密码"><a href="#5）修改多实例密码" class="headerlink" title="5）修改多实例密码"></a>5）修改多实例密码</h3><ul><li>基于socket文件修改</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改两个实例连接密码，明文修改密码会出现警告信息</span></span><br><span class="line">[root@db-51 ~]#mysqladmin -S /app/data/3307/mysql.sock password 1</span><br><span class="line">mysqladmin: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server <span class="keyword">in</span> plain text, use ssl connection to ensure password safety.</span><br><span class="line"></span><br><span class="line">[root@db-51 ~]#mysqladmin -S /app/data/3308/mysql.sock password 1</span><br><span class="line">mysqladmin: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server <span class="keyword">in</span> plain text, use ssl connection to ensure password safety.</span><br></pre></td></tr></table></figure><ul><li>检查登录，sql语句查看，连接服务端的端口</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#3307实例</span></span><br><span class="line">[root@db-51 ~]#mysql -S /app/data/3307/mysql.sock  -uroot -p1 -e <span class="string">&quot;show global variables like &#x27;port&#x27;&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| port          | 3307  |</span><br><span class="line">+---------------+-------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#3308实例</span></span><br><span class="line">[root@db-51 ~]#mysql -S /app/data/3308/mysql.sock  -uroot -p1 -e <span class="string">&quot;show global variables like &#x27;port&#x27;&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| port          | 3308  |</span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure><h1 id="4-脚本启动关闭方式"><a href="#4-脚本启动关闭方式" class="headerlink" title="4.脚本启动关闭方式"></a>4.脚本启动关闭方式</h1><h2 id="4-1-启动"><a href="#4-1-启动" class="headerlink" title="4.1 启动"></a>4.1 启动</h2><ul><li>mysql管理脚本放入&#x2F;etc&#x2F;init.d，启动形式，本质上都是调用mysql自带管理脚本</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#systemctl启动</span></span><br><span class="line">systemctl  start/stop/restart   mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment">#service启动</span></span><br><span class="line">service mysqld start</span><br><span class="line"></span><br><span class="line"><span class="comment">#mysql自带管理脚本启动</span></span><br><span class="line">/etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db-51 /www.yuchaoit.cn]#<span class="built_in">ls</span> /opt/mysql/bin/mysqld* -l</span><br><span class="line">-rwxr-xr-x 1 mysql mysql 260613605 Sep 27  2019 /opt/mysql/bin/mysqld</span><br><span class="line">-rwxr-xr-x 1 mysql mysql 213374233 Sep 27  2019 /opt/mysql/bin/mysqld-debug</span><br><span class="line">-rwxr-xr-x 1 mysql mysql     27139 Sep 27  2019 /opt/mysql/bin/mysqld_multi</span><br><span class="line">-rwxr-xr-x 1 mysql mysql     28494 Sep 27  2019 /opt/mysql/bin/mysqld_safe</span><br><span class="line">-rwxr-xr-x 1 mysql mysql  15712383 Sep 27  2019 /opt/mysql/bin/mysqldump</span><br><span class="line">-rwxr-xr-x 1 mysql mysql      7865 Sep 27  2019 /opt/mysql/bin/mysqldumpslow</span><br></pre></td></tr></table></figure><h2 id="4-2-关闭"><a href="#4-2-关闭" class="headerlink" title="4.2 关闭"></a>4.2 关闭</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#脚本关闭</span></span><br><span class="line">systemctl stop mysqld</span><br><span class="line">service mysqld stop</span><br><span class="line">/etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#命令关闭</span></span><br><span class="line">mysql -uroot -pwww.yuchaoit.cn -e <span class="string">&#x27;shutdown;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#不建议用这个操作，除非特殊情况</span></span><br><span class="line"><span class="built_in">kill</span> pid</span><br><span class="line">pkill mysqld</span><br><span class="line">killall mysqld</span><br><span class="line"><span class="built_in">kill</span> -9 pid <span class="comment"># 极端情况下，才能用这个</span></span><br></pre></td></tr></table></figure><h1 id="5-程序进程运行原理"><a href="#5-程序进程运行原理" class="headerlink" title="5.程序进程运行原理"></a>5.程序进程运行原理</h1><ul><li><p><strong>mysqld_safe作用</strong></p><ul><li>mysql官方启动脚本，是以执行mysqld_safe为入口，其实mysqld_safe也是个shell脚本，调用了myqsld命令启动服务</li><li>mysqld_safe脚本设置运行环境，如以守护进程运行</li><li>mysqld_safe检测mysqld运行状态</li><li>mysqld_safe检测mysqld进程运行信息，写入 mysql实例目录下的hostname.err文件</li><li>以及mysqld_safe会读取my.cnf配置文件的[mysqld],[mysqld_safe]等配置</li></ul></li><li><p><strong>mysqld作用</strong></p><ul><li>mysqld是mysql的核心程序，用于管理mysql的数据库文件，以及用户执行的SQL请求</li><li>mysqld读取my.cnf中 [mysqld]配置</li></ul></li></ul><blockquote><p>不建议使用mysqld启动，以官方用法为主，用mysqld_safe调用mysqld启动mysql</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-数据库二进制安装&quot;&gt;&lt;a href=&quot;#1-数据库二进制安装&quot; class=&quot;headerlink&quot; title=&quot;1.数据库二进制安装&quot;&gt;&lt;/a&gt;1.数据库二进制安装&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;官网-二进制包安装地址&lt;/p&gt;
&lt;p&gt; &lt;a href=&quot;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>hexo博客搭建</title>
    <link href="http://example.com/2024/08/20/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/"/>
    <id>http://example.com/2024/08/20/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/</id>
    <published>2024-08-20T01:17:16.000Z</published>
    <updated>2024-08-20T01:18:39.917Z</updated>
    
    <content type="html"><![CDATA[<h1 id="hexo博客搭建"><a href="#hexo博客搭建" class="headerlink" title="hexo博客搭建"></a>hexo博客搭建</h1><h2 id="1-本地搭建博客"><a href="#1-本地搭建博客" class="headerlink" title="1.本地搭建博客"></a>1.本地搭建博客</h2><ul><li>先安装好nodejs运行环境与git工具</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1.检查安装</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ node -v</span><br><span class="line">v20.16.0</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ npm -v</span><br><span class="line">10.8.1</span><br><span class="line"></span><br><span class="line">2.安装hexo框架</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ npm install -g hexo-cli </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.初始化系统生成文件夹</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo init blog</span><br><span class="line">INFO  Cloning hexo-starter https://github.com/hexojs/hexo-starter.git</span><br><span class="line">INFO  Install dependencies</span><br><span class="line">INFO  Start blogging with Hexo!</span><br><span class="line"></span><br><span class="line">4.启动博客系统</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo s</span><br><span class="line">INFO  Validating config</span><br><span class="line">INFO  Start processing</span><br><span class="line">INFO  Hexo is running at http://localhost:4000/ . Press Ctrl+C to stop.</span><br><span class="line">INFO  Good <span class="built_in">bye</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240819220046162.png" alt="image-20240819220046162"></p><h2 id="2-修改博客主题"><a href="#2-修改博客主题" class="headerlink" title="2.修改博客主题"></a>2.修改博客主题</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1.主题地址</span><br><span class="line">https://hexo.io/themes/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.下载到本地</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ git <span class="built_in">clone</span> -b master https://github.com/jerryc127/hexo-theme-butterfly.git themes/butterfly</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">ls</span> themes/</span><br><span class="line">butterfly/</span><br><span class="line"></span><br><span class="line">3.修改配置文件改theme为新主题名</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ vim _config.yml</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ grep butt _config.yml</span><br><span class="line">theme: butterfly</span><br><span class="line"></span><br><span class="line">4.清除旧资源</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo cl</span><br><span class="line"></span><br><span class="line">5.加载新资源</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo g</span><br><span class="line"></span><br><span class="line">6.安装插件及渲染器否则无法使用主题打开博客页面</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$  npm install --save hexo-renderer-jade hexo-generator-feed hexo-generator-sitemap hexo-browsersync hexo-generator-archive</span><br><span class="line"></span><br><span class="line">7.启动博客系统</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ hexo s</span><br></pre></td></tr></table></figure><p><img src="/image-20240819221832813.png" alt="image-20240819221832813"></p><h2 id="3-优化博客主题"><a href="#3-优化博客主题" class="headerlink" title="3.优化博客主题"></a>3.优化博客主题</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">1.拷贝主题目录配置文件到主目录中</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog/themes/butterfly (master)</span><br><span class="line">$ <span class="built_in">cp</span> _config.yml ../../</span><br><span class="line">.github/               _config.yml            package-lock.json      scaffolds/</span><br><span class="line">.gitignore             db.json                package.json           <span class="built_in">source</span>/</span><br><span class="line">_config.landscape.yml  node_modules/          public/                themes/</span><br><span class="line"></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog/themes/butterfly (master)</span><br><span class="line">$ <span class="built_in">cp</span> _config.yml ../../_config.butterfly.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.修改主题背景</span><br><span class="line"><span class="comment">#下载图片</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">ls</span> ~/Desktop/</span><br><span class="line">18092716058766.jpg </span><br><span class="line"><span class="comment">#传入主题目录中</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">mv</span> ~/Desktop/18092716058766.jpg themes/butterfly/source/img/linux.jpg</span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">ls</span> themes/butterfly/source/img/</span><br><span class="line">404.jpg  favicon.png  friend_404.gif  linux.jpg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.修改主题配置文件改背景图片路径</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ vim _config.butterfly.yml</span><br><span class="line"></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ grep <span class="string">&#x27;linux&#x27;</span> _config.butterfly.yml</span><br><span class="line">index_img: ./img/linux.jpg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.修改主题相关文字标题</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ vim _config.yml</span><br><span class="line"></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">head</span> _config.yml</span><br><span class="line"><span class="comment"># Hexo Configuration</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/configuration.html</span></span><br><span class="line"><span class="comment">## Source: https://github.com/hexojs/hexo/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Site</span></span><br><span class="line">title: linux笔记博客</span><br><span class="line">subtitle: <span class="string">&#x27;hexo博客&#x27;</span></span><br><span class="line">description: <span class="string">&#x27;个人技术笔记博客&#x27;</span></span><br><span class="line">keywords:</span><br><span class="line">author: 赵东兴</span><br></pre></td></tr></table></figure><p><img src="/image-20240819225316424.png" alt="image-20240819225316424"></p><h2 id="4-上传代码仓库"><a href="#4-上传代码仓库" class="headerlink" title="4.上传代码仓库"></a>4.上传代码仓库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1.修改主配置文件加上传输github仓库配置参数</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ vim _config.yml</span><br><span class="line"><span class="comment">#检查</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ <span class="built_in">tail</span> _config.yml</span><br><span class="line">deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repo: https://github.com/zhao-1025/blog</span><br><span class="line">  branch: main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.安装连接github插件，否则无法通过上传数据到仓库</span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog</span><br><span class="line">$ npm install hexo-deployer-git --save</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.上传博客系统到代码仓库github中</span><br><span class="line"><span class="comment">#上传时有很多坑，导致无法上传，注意梯子尽量关闭，走国内网络连接</span></span><br><span class="line">86155@chad MINGW64 ~/Desktop/blog (master)</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure><h2 id="6-一键部署公网"><a href="#6-一键部署公网" class="headerlink" title="6.一键部署公网"></a>6.一键部署公网</h2><ul><li>使用zeabur平台【<a href="https://dash.zeabur.com/%E3%80%91%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E4%BB%A3%E7%A0%81">https://dash.zeabur.com/】一键部署代码</a><ul><li>注册登录</li><li>连接github代码仓库进行授权</li><li>最终选择仓库代码一键部署服务，内部有免费域名提供使用</li></ul></li></ul><h2 id="7-公网访问验证"><a href="#7-公网访问验证" class="headerlink" title="7.公网访问验证"></a>7.公网访问验证</h2><p><a href="https://zhaodongxing.zeabur.app/">https://zhaodongxing.zeabur.app/</a></p><p>接下来就可以将typora笔记上传到hexo博客中了</p><p><img src="/image-20240820002553645.png" alt="image-20240820002553645"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;hexo博客搭建&quot;&gt;&lt;a href=&quot;#hexo博客搭建&quot; class=&quot;headerlink&quot; title=&quot;hexo博客搭建&quot;&gt;&lt;/a&gt;hexo博客搭建&lt;/h1&gt;&lt;h2 id=&quot;1-本地搭建博客&quot;&gt;&lt;a href=&quot;#1-本地搭建博客&quot; class=&quot;head</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-报错解决</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3/</id>
    <published>2024-08-20T00:56:06.000Z</published>
    <updated>2024-08-20T00:56:06.434Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-高可用性</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7/</id>
    <published>2024-08-20T00:55:47.000Z</published>
    <updated>2024-08-20T01:00:12.234Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、MHA高可用概述"><a href="#一、MHA高可用概述" class="headerlink" title="一、MHA高可用概述"></a>一、MHA高可用概述</h1><h2 id="1-什么是MHA"><a href="#1-什么是MHA" class="headerlink" title="1.什么是MHA"></a>1.什么是MHA</h2><p>MHA (Master High Availability Manager and tools for MySQL) 是一个用于MySQL数据库的高可用性解决方案。</p><p>它提供了自动故障检测、故障切换和故障恢复功能，以确保MySQL数据库集群的高可用性和可靠性。</p><p>MHA还可以监控主从复制状态、执行自动故障切换，并通知相关的应用程序或负载均衡器，以便数据库集群能够持续稳定地运行。</p><p>总的来说，MHA是一个强大的工具集，可帮助数据库管理员简化数据库集群的管理、提高业务连续性和可用性。</p><h2 id="2-MHA架构原理"><a href="#2-MHA架构原理" class="headerlink" title="2.MHA架构原理"></a>2.MHA架构原理</h2><ol><li>MHA由几个组件组成，包括mha4mysql-manager、mha4mysql-node和mha4mysql-kill等工具。其中，mha4mysql-manager是主要的管理器组件，负责监控数据库集群的状态、执行故障切换和恢复操作；mha4mysql-node用于监控数据库节点的状态，并发送状态更新给mha4mysql-manager；mha4mysql-kill用于终止问题节点上的MySQL进程。</li><li>MHA采用主从复制的架构，在数据库集群中主服务器负责处理写操作，从服务器则用于读取操作。MHA通过监控主从复制状态来确保数据库高可用性。</li><li>当主服务器出现故障或不可用时，mha4mysql-manager会自动检测到这种变化，并选择一个合适的从服务器升级为新的主服务器。它会确保新的主服务器能够接收写操作，并更新应用程序连接信息，以便应用程序能够正确地连接到新的主服务器。</li><li>一旦故障切换完成，mha4mysql-manager会持续监控新的主服务器和数据库集群的健康状态，以确保数据库集群能够恢复正常运行。</li></ol><blockquote><p>总的来说，MHA的架构原理是基于监控、自动故障切换和恢复的流程，以确保MySQL数据库集群的高可用性和可靠性。它提供了一个自动化的解决方案，使数据库管理员能够更轻松地管理和维护数据库集群，并确保业务连续性。</p></blockquote><h2 id="3-MHA工作原理"><a href="#3-MHA工作原理" class="headerlink" title="3.MHA工作原理"></a>3.MHA工作原理</h2><ol><li>监控主从复制状态：MHA通过定期检查MySQL数据库的主从复制状态，包括主服务器的健康状态、从服务器的延迟等情况。</li><li>发现主服务器故障：当MHA检测到主服务器出现故障或不可用时，它会自动触发故障切换过程。</li><li>执行故障切换：MHA会选择一个合适的从服务器作为新的主服务器，并修改数据库配置完成切换，同时通知应用程序更新连接信息。</li><li>进行故障恢复：一旦故障切换完成，MHA会监控新的主服务器的健康状态，确保数据库集群恢复正常运行。</li><li>避免脑裂问题：MHA能够避免脑裂问题（split-brain），即在多主复制环境下只有一个主服务器在提供服务。</li></ol><blockquote><p>总的来说，MHA通过监控主从复制状态，自动执行故障切换，并确保数据库高可用性，从而提供了一种简单而又可靠的MySQL高可用性解决方案。</p></blockquote><h2 id="4-MHA组件作用"><a href="#4-MHA组件作用" class="headerlink" title="4.MHA组件作用"></a>4.MHA组件作用</h2><p>MHA（MySQL高可用性）中的manager组件和node组件在功能和作用上有以下区别：</p><ol><li>Manager组件：</li></ol><ul><li>管理配置信息：负责管理MHA的配置信息，包括MySQL的主从关系、故障转移的参数设置、监控参数等。</li><li>故障检测和切换决策：监控MySQL的主从复制状态，一旦检测到Master节点故障，会触发故障转移流程，并根据事先设定的切换策略进行Master节点切换。</li><li>日志记录和报警：记录故障转移的过程和结果，并可以配合报警系统进行故障通知。</li></ul><ol><li>Node组件：</li></ol><ul><li>监视MySQL Master的状态：负责监视MySQL Master节点的运行状态，一旦Master节点发生故障，node组件会发现并触发故障转移过程。</li><li>自动故障转移：一旦Master节点发生故障，node组件会自动将Slave节点提升为新的Master节点，以确保数据库系统的高可用性。</li><li>管理复制拓扑：管理MySQL的复制拓扑，包括添加和删除从节点，监控复制延迟等。</li></ul><blockquote><p>总的来说，Manager组件主要负责配置管理、故障检测和切换决策，以及记录和报警，而Node组件则主要负责监视Master节点状态，自动故障转移和管理复制拓扑。两个组件共同协作，确保MySQL的高可用性。</p></blockquote><p><strong>Manager组件</strong></p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>masterha_check_ssh</td><td>检查MHA的SSH配置状况</td></tr><tr><td>masterha_check_repl</td><td>检查MySQL复制状况，配置信息</td></tr><tr><td>masterha_master_monitor</td><td>检测master是否宕机</td></tr><tr><td>masterha_manger</td><td>启动MHA</td></tr><tr><td>masterha_check_status</td><td>检测当前MHA运行状态</td></tr><tr><td>masterha_master_switch</td><td>控制故障转移(自动或者手动)</td></tr><tr><td>masterha_conf_host</td><td>添加或删除配置的server信息</td></tr></tbody></table><p><strong>node组件</strong></p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>save_binary_logs</td><td>保存和复制master的二进制日志</td></tr><tr><td>apply_diff_relay_logs</td><td>识别差异的中继日志事件，并将其差异的事件应用于其他的节点</td></tr><tr><td>purge_relay_logs</td><td>清除中继日志(不会阻塞SQL线程)</td></tr></tbody></table><h1 id="二、主从复制环境部署"><a href="#二、主从复制环境部署" class="headerlink" title="二、主从复制环境部署"></a>二、主从复制环境部署</h1><p><strong>机器环境准备：</strong></p><p>部署MHA高可用性，先得有主从复制集群环境，下方db-51、db-52、db-53三台机器做主从复制</p><p><strong>要求：</strong></p><blockquote><p>1.所有机器binlog全部开启，高可用主从切换时会以新master的binlog为基础，对slave数据进行同步</p><p>2.所有机器gtid全部开启，binlog中所有事务可根据gtid记录，主从复制根据gtid复制数据更加可靠与方便</p><p>3.所有机器设置server_id，不设置binlog无法开启</p><p>4.所有机器server_id不能设置相同值，防止数据无法完整复制到每个节点中</p></blockquote><h2 id="1-主库环境部署"><a href="#1-主库环境部署" class="headerlink" title="1.主库环境部署"></a>1.主库环境部署</h2><p><strong>db-51</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>下载安装mysql基础环境部署</span><br><span class="line">...........省略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>修改配置文件如下</span><br><span class="line">cat  <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">[mysqld]</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">-</span>server<span class="operator">=</span>utf8</span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>启动检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">ss <span class="operator">-</span>tunlp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>查看GTID是否开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-从库环境部署"><a href="#2-从库环境部署" class="headerlink" title="2.从库环境部署"></a>2.从库环境部署</h2><p><strong>db-52</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>mysql下载及基础环境部署</span><br><span class="line">..........省略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>初始化安装mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>配置文件修改</span><br><span class="line">cat  <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">[mysqld]</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">-</span>server<span class="operator">=</span>utf8</span><br><span class="line">server_id<span class="operator">=</span><span class="number">52</span></span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>启动检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">ss <span class="operator">-</span>tunlp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>查看GTID是否开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><p><strong>db-53</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>mysql下载及基础环境部署</span><br><span class="line">..........省略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>初始化安装mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/tools/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>配置文件修改</span><br><span class="line">cat  <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">[mysqld]</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">-</span>server<span class="operator">=</span>utf8</span><br><span class="line">server_id<span class="operator">=</span><span class="number">53</span></span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>启动检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">ss <span class="operator">-</span>tunlp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>查看GTID是否开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="3-主从复制关系建立"><a href="#3-主从复制关系建立" class="headerlink" title="3.主从复制关系建立"></a>3.主从复制关系建立</h2><h3 id="3-1主库修改root密码"><a href="#3-1主库修改root密码" class="headerlink" title="3.1主库修改root密码"></a>3.1主库修改root密码</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#修改密码</span><br><span class="line">mysqladmin password <span class="number">1</span></span><br><span class="line"></span><br><span class="line">#登录检查</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1</span><br></pre></td></tr></table></figure><h3 id="3-2主库创建从库复制账号"><a href="#3-2主库创建从库复制账号" class="headerlink" title="3.2主库创建从库复制账号"></a>3.2主库创建从库复制账号</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#创建用户设置登录白名单并授予从库复制权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查用户权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> repl@<span class="string">&#x27;172.16.1.%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> repl<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.<span class="operator">%</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查登录白名单</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span> host       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="operator">|</span> repl          <span class="operator">|</span> <span class="number">172.16</span><span class="number">.1</span>.<span class="operator">%</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.session <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.sys     <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> root          <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="3-3从库配置连接开启复制"><a href="#3-3从库配置连接开启复制" class="headerlink" title="3.3从库配置连接开启复制"></a>3.3从库配置连接开启复制</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">参数说明</span><br><span class="line">change master <span class="keyword">to</span>   #主从复制连接主库参数修改 </span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,  #主库ip</span><br><span class="line">master_port<span class="operator">=</span><span class="number">3306</span>, #主库端口</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,#连接用户</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,#连接密码</span><br><span class="line">MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>,     #自动通过GTID值获取主库binlog事务信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#参数配置</span><br><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,master_port<span class="operator">=</span><span class="number">3306</span>,master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动从库复制功能</span><br><span class="line"><span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure><h3 id="3-4检查从库复制状态"><a href="#3-4检查从库复制状态" class="headerlink" title="3.4检查从库复制状态"></a>3.4检查从库复制状态</h3><p><strong>1）检查从库线程状态</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>检查从库复制状态</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G;</span><br><span class="line">#保证线程状态为yes</span><br><span class="line">Slave_IO_Running:  Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查从库线程详细状态信息</span><br><span class="line">mysql<span class="operator">&gt;</span><span class="keyword">show</span> processlist;</span><br><span class="line">#state状态信息</span><br><span class="line">IO线程：等待主库发送事件</span><br><span class="line"><span class="keyword">SQL</span>线程：读取中继日志等待日志更新</span><br></pre></td></tr></table></figure><p><img src="/image-20240621204751663.png" alt="image-20240621204751663"></p><p><strong>2）检查binlog同步情况</strong></p><ul><li>从库复制状态binlog同步截止点检查</li><li>检查从库复制的binlog截止点是否与主库的binlog一致</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#查看复制状态</span><br><span class="line"><span class="keyword">show</span> slave status\G;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查读取的主库binlog截止点</span><br><span class="line">Read_Master_Log_Pos: <span class="number">706</span></span><br><span class="line">Relay_Log_File: db<span class="number">-52</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查从库同步的binlog截止点</span><br><span class="line">Exec_Master_Log_Pos: <span class="number">706</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查读取与同步的binlog的GTID事务截止点</span><br><span class="line">Retrieved_Gtid_Set: <span class="number">44300</span>b99<span class="number">-2</span>ef4<span class="number">-11</span>ef<span class="number">-8541</span><span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-2</span></span><br><span class="line">Executed_Gtid_Set: <span class="number">44300</span>b99<span class="number">-2</span>ef4<span class="number">-11</span>ef<span class="number">-8541</span><span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-2</span></span><br></pre></td></tr></table></figure><ul><li>主库从库binlog信息检查</li></ul><p>&#x3D;&#x3D;检查从库的binlog信息是否与主库的binlog信息一致&#x3D;&#x3D;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#主库检查</span><br><span class="line"><span class="keyword">show</span> master status;</span><br><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000004&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#从库检查</span><br><span class="line"><span class="keyword">show</span> master status;</span><br><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000004&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#最终保持一致即可</span><br></pre></td></tr></table></figure><ul><li>从库数据同步检查</li></ul><p>&#x3D;&#x3D;主库创建了复制账号，修改了实例数据，检查从库是否同步了修改的数据&#x3D;&#x3D;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#检查同步无误</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host  <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span> host       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="operator">|</span> repl          <span class="operator">|</span> <span class="number">172.16</span><span class="number">.1</span>.<span class="operator">%</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.session <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.sys     <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> root          <span class="operator">|</span> localhost  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="4-检查主从复制效果"><a href="#4-检查主从复制效果" class="headerlink" title="4.检查主从复制效果"></a>4.检查主从复制效果</h2><blockquote><p>主库写入数据，从库检查复制效果即可</p></blockquote><p><strong>主库写入数据</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database checktest;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> checktest.t1(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.06</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> checktest.t1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.11</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> checktest.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p><strong>从库检查同步</strong></p><ul><li>db-51检查</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from checktest.t1;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>db-52检查</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from checktest.t1;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p><strong>binlog事务信息同步检查</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status;</span><br></pre></td></tr></table></figure><h2 id="5-从库节点设置全局读锁（未学）"><a href="#5-从库节点设置全局读锁（未学）" class="headerlink" title="5.从库节点设置全局读锁（未学）"></a>5.从库节点设置全局读锁（未学）</h2><p>确保了从库同步数据的一致性，防止从库节点有数据写入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;read_only%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> read_only     <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用root设置全局读锁</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> read_only<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;read_only%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> read_only     <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="三、MHA高可用搭建部署"><a href="#三、MHA高可用搭建部署" class="headerlink" title="三、MHA高可用搭建部署"></a>三、MHA高可用搭建部署</h1><h2 id="1-所有节点软链接设置"><a href="#1-所有节点软链接设置" class="headerlink" title="1.所有节点软链接设置"></a>1.所有节点软链接设置</h2><ul><li>所有节点设置mysql与mysqlbinlog命令软链接<ul><li>MHA应用会调用这两个命令实现主从切换故障转移数据同步等操作</li><li>命令在其他目录MHA无法识别调用，需要将这两个命令配置软链接放入&#x2F;usr&#x2F;bin&#x2F;下</li></ul></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>主库配置</span><br><span class="line">#db<span class="number">-51</span></span><br><span class="line">#检查当前命令所在路径</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#which mysql</span><br><span class="line"><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#which mysqlbinlog</span><br><span class="line"><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line"></span><br><span class="line">#配置软链接</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog  <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line"></span><br><span class="line">#检查软链接后路径</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#which mysql</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#which mysqlbinlog</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>从库配置</span><br><span class="line">#db<span class="number">-52</span></span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog  <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line">which mysql</span><br><span class="line">which mysqlbinlog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#db<span class="number">-53</span></span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog  <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line">which mysql</span><br><span class="line">which mysqlbinlog</span><br></pre></td></tr></table></figure><h2 id="2-所有节点免密连接设置"><a href="#2-所有节点免密连接设置" class="headerlink" title="2.所有节点免密连接设置"></a>2.所有节点免密连接设置</h2><blockquote><p>主从复制所有节点互相配置ssh免密登录</p></blockquote><p>配置互相免密主要是为了简化节点之间的通信和协作</p><p>在MHA集群中，各个节点需要频繁地进行状态同步，故障切换和数据同步等操作</p><p>如果每次都需要输入密码或者进行密钥验证，将会增加管理和操作的复杂度</p><p><strong>db-51</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>安装sshpass工具</span><br><span class="line">yum install sshpass <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>本地生成公私钥对</span><br><span class="line">#无交互操作，指定文件存放路径指定无密码</span><br><span class="line">ssh<span class="operator">-</span>keygen <span class="operator">-</span>f <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_rsa <span class="operator">-</span>N <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>通过sshpass工具实现无交互发送公钥到目标机器，包括自己本地机器也需要发送</span><br><span class="line">#sshpass <span class="operator">-</span>p 指定登录密码无需命令行交互输入</span><br><span class="line">#ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id 发送公钥指定目标机器ip</span><br><span class="line">#StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span> 不做指纹认证</span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 免密登录验证</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#<span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span>;do ssh root<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.$i &quot;hostname;echo &#x27;免密登录验证&#x27;&quot;;done</span><br><span class="line">db<span class="number">-51</span></span><br><span class="line">免密登录验证</span><br><span class="line">db<span class="number">-52</span></span><br><span class="line">免密登录验证</span><br><span class="line">db<span class="number">-53</span></span><br><span class="line">免密登录验证</span><br></pre></td></tr></table></figure><p><strong>db-52</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install sshpass <span class="operator">-</span>y</span><br><span class="line">ssh<span class="operator">-</span>keygen <span class="operator">-</span>f <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_rsa <span class="operator">-</span>N <span class="string">&#x27;&#x27;</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span>;do ssh root<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.$i &quot;hostname;echo &#x27;免密登录验证&#x27;&quot;;done</span><br></pre></td></tr></table></figure><p><strong>db-53</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install sshpass <span class="operator">-</span>y</span><br><span class="line">ssh<span class="operator">-</span>keygen <span class="operator">-</span>f <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_rsa <span class="operator">-</span>N <span class="string">&#x27;&#x27;</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line">sshpass <span class="operator">-</span>p <span class="string">&#x27;123456&#x27;</span> ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span> <span class="operator">-</span>o StrictHostKeyChecking<span class="operator">=</span><span class="keyword">no</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span>;do ssh root<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.$i &quot;hostname;echo &#x27;免密登录验证&#x27;&quot;;done</span><br></pre></td></tr></table></figure><h2 id="3-所有节点mha用户创建"><a href="#3-所有节点mha用户创建" class="headerlink" title="3.所有节点mha用户创建"></a>3.所有节点mha用户创建</h2><p><strong>mha调用mha用户做什么：</strong></p><ol><li>进行管理和监控：MHA使用mha用户进行管理和监控MySQL主从复制集群的状态，包括监视主节点的健康状况、从节点是否与主节点同步等。这可以帮助MHA及时发现数据库集群中的故障和问题，并采取相应的措施进行处理。</li><li>进行故障转移和切换：当主节点出现故障或不可用时，MHA可以使用mha用户进行故障转移操作，自动将从节点提升为新的主节点，同时重新配置其他从节点以确保数据库集群的高可用性。</li><li>执行配置更改：MHA使用mha用户来执行配置更改，例如添加或删除从节点、更改复制拓扑、切换到不同的主节点等操作。</li></ol><p>通过使用专门的mha用户，MHA可以在MySQL主从复制环境中安全地进行故障检测、故障处理和配置更改，同时确保数据库集群的安全和稳定性。</p><p><strong>mha用户权限分配：</strong></p><p>在MHA环境中，通常会为mha用户授予<code>&#39;mha&#39;@&#39;%&#39;</code>的权限，即允许该用户从任何主机连接到MySQL数据库。这是因为MHA需要在主从复制环境中的各个节点之间进行管理和监控操作，而这些节点可能存在于不同的主机或服务器上。因此，为了确保mha用户能够在所有节点上执行必要的操作，通常会将其权限设置为可以从任何主机连接。</p><p>当然，在实际生产环境中，为了安全起见，可以根据具体需求和安全策略，限制mha用户的连接范围，例如只允许特定IP地址或主机名连接。这样可以提高数据库的安全性，防止未授权的访问。</p><p>总之，为了确保MHA能够有效地管理和监控MySQL主从复制环境，需要为mha用户分配适当的权限，确保其能够在必要的情况下连接到所有相关节点。</p><blockquote><p>&#x3D;&#x3D;所有节点创建mha用户&#x3D;&#x3D;，mha工具会调用指定用户登录连接数据库，进行一系列操作</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#主库db<span class="number">-51</span>创建即可，从库会自动同步</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> mha@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> mha@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#从库db<span class="number">-52</span>与db<span class="number">-53</span>检查同步情况</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> mha@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="4-所有节点node组件安装"><a href="#4-所有节点node组件安装" class="headerlink" title="4.所有节点node组件安装"></a>4.所有节点node组件安装</h2><blockquote><p>node组件需要在主从复制集群&#x3D;&#x3D;所有节点都安装&#x3D;&#x3D;，主要作用接收manager组件来的请求，执行相应的操作</p></blockquote><p><strong>db51、db52、db53</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#安装node组件连接数据库驱动</span><br><span class="line">yum install  <span class="operator">-</span>y perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下载好node组件上传到linux安装即可，暂未找到mha组件下载官网</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>opt]#ls</span><br><span class="line">mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">/</span>opt]#ls</span><br><span class="line">mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">/</span>opt]#ls</span><br><span class="line">mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#所有机器节点安装</span><br><span class="line">yum localinstall mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm  <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看node软件包安装后生成的脚本管理命令</span><br><span class="line">rpm <span class="operator">-</span>qa<span class="operator">|</span>grep <span class="string">&#x27;mha*&#x27;</span></span><br><span class="line">rpm <span class="operator">-</span>ql mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#node组件管理命令</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>apply_diff_relay_logs</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>filter_mysqlbinlog</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>purge_relay_logs</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>save_binary_logs</span><br></pre></td></tr></table></figure><h2 id="5-管理节点manager组件安装"><a href="#5-管理节点manager组件安装" class="headerlink" title="5.管理节点manager组件安装"></a>5.管理节点manager组件安装</h2><blockquote><p>manager组件在&#x3D;&#x3D;单个的节点安装&#x3D;&#x3D;，或者在&#x3D;&#x3D;从库节点安装&#x3D;&#x3D;，&#x3D;&#x3D;不能在主库节点安装&#x3D;&#x3D;防止主库宕机影响高可用的实现</p><p>主要作用相当于包工头，吩咐node组件工作的领导管理者</p></blockquote><ul><li><strong>下方选择在从库节点db-52安装manager管理组件</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#安装epel额外源，用于安装manager软件依赖</span><br><span class="line">yum install epel<span class="operator">-</span><span class="keyword">release</span> <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#安装manager组件运行环境及依赖</span><br><span class="line">yum install  <span class="operator">-</span>y perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL perl<span class="operator">-</span>Config<span class="operator">-</span>Tiny perl<span class="operator">-</span>Log<span class="operator">-</span>Dispatch perl<span class="operator">-</span>Parallel<span class="operator">-</span>ForkManager perl<span class="operator">-</span>ExtUtils<span class="operator">-</span>CBuilder perl<span class="operator">-</span>ExtUtils<span class="operator">-</span>MakeMaker perl<span class="operator">-</span>CPAN perl<span class="operator">-</span><span class="type">Time</span><span class="operator">-</span>HiRes </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下载manager组件到linux</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">/</span>opt]#ls</span><br><span class="line">mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#安装manager组件</span><br><span class="line">yum localinstall mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm  <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查manager包安装的管理命令</span><br><span class="line">rpm <span class="operator">-</span>qa<span class="operator">|</span>grep <span class="string">&#x27;mha*&#x27;</span></span><br><span class="line">rpm <span class="operator">-</span>ql mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#manager管理命令如下</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_check_repl</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_check_ssh</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_check_status</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_conf_host</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_manager</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_master_monitor</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_master_switch</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_secondary_check</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>masterha_stop</span><br></pre></td></tr></table></figure><h2 id="6-管理节点透明自愈脚本添加"><a href="#6-管理节点透明自愈脚本添加" class="headerlink" title="6.管理节点透明自愈脚本添加"></a>6.管理节点透明自愈脚本添加</h2><blockquote><p>manager所在机器添加，运行mha应用发生故障时，mha可以调用该脚本，实现vip漂移，保证数据库持续运行</p></blockquote><ol><li>实现自动故障转移：透明自愈脚本可以监控MySQL主从复制的状态和健康情况，当主服务器发生故障或不可用时，脚本可以自动触发主从切换，将VIP（虚拟IP）从原主服务器切换到备用从服务器上，从而确保数据库服务的高可用性。</li><li>减少手动干预：透明自愈脚本减少了管理员手动介入的需要，可以自动识别和处理主从复制故障情况，从而减少了故障处理时间和人工成本。</li><li>简化故障处理：脚本能够快速检测和诊断主从复制的问题，并采取必要的措施来恢复服务，如切换VIP、重新连接到备用服务器等，从而简化了故障处理的流程。</li><li>提高可靠性和可用性：通过透明自愈脚本的自动化处理，可以提高数据库服务的可靠性和可用性，减少了因为主从复制故障而导致的服务中断时间，同时提高了整个系统的稳定性。</li></ol><p>总的来说，透明自愈脚本是MHA工具的一个重要组成部分，它能够自动监控、诊断和处理MySQL主从复制的故障情况，从而确保数据库服务能够持续、稳定地运行。</p><p><strong>脚本内容：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover<span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">#<span class="operator">!</span><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>env perl</span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;all&#x27;</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#修改如下<span class="number">5</span>条信息即可</span><br><span class="line">#vip地址设置，根据下方网卡位置配置，定义vip运行在公网还是内网</span><br><span class="line">my $vip <span class="operator">=</span> <span class="string">&#x27;10.0.0.55/24&#x27;</span>;</span><br><span class="line">my $key <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">#vip绑定的网卡位置，修改网卡名即可更改vip运行网卡位置</span><br><span class="line">#ifconfig查看机器网卡名，注意网卡名要与机器上网卡名对应</span><br><span class="line">my $ssh_start_vip <span class="operator">=</span> &quot;/sbin/ifconfig eth0:$key $vip&quot;;</span><br><span class="line">my $ssh_stop_vip <span class="operator">=</span> &quot;/sbin/ifconfig eth0:$key down&quot;;</span><br><span class="line">my $ssh_Bcast_arp<span class="operator">=</span>&quot;/sbin/arping -I eth0 -c 3 -A 10.0.0.55&quot;;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">&#x27;command=s&#x27;</span>          <span class="operator">=</span><span class="operator">&gt;</span> \$command,</span><br><span class="line">    <span class="string">&#x27;ssh_user=s&#x27;</span>         <span class="operator">=</span><span class="operator">&gt;</span> \$ssh_user,</span><br><span class="line">    <span class="string">&#x27;orig_master_host=s&#x27;</span> <span class="operator">=</span><span class="operator">&gt;</span> \$orig_master_host,</span><br><span class="line">    <span class="string">&#x27;orig_master_ip=s&#x27;</span>   <span class="operator">=</span><span class="operator">&gt;</span> \$orig_master_ip,</span><br><span class="line">    <span class="string">&#x27;orig_master_port=i&#x27;</span> <span class="operator">=</span><span class="operator">&gt;</span> \$orig_master_port,</span><br><span class="line">    <span class="string">&#x27;new_master_host=s&#x27;</span>  <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_host,</span><br><span class="line">    <span class="string">&#x27;new_master_ip=s&#x27;</span>    <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_ip,</span><br><span class="line">    <span class="string">&#x27;new_master_port=i&#x27;</span>  <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">exit <span class="operator">&amp;</span>main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line"></span><br><span class="line">    print &quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;;</span><br><span class="line"></span><br><span class="line">    if ( $command eq &quot;stop&quot; <span class="operator">||</span> $command eq &quot;stopssh&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">        my $exit_code <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        eval &#123;</span><br><span class="line">            print &quot;Disabling the VIP on old master: $orig_master_host \n&quot;;</span><br><span class="line">            <span class="operator">&amp;</span>stop_vip();</span><br><span class="line">            $exit_code <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        if ($@) &#123;</span><br><span class="line">            warn &quot;Got Error: $@\n&quot;;</span><br><span class="line">            exit $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( $command eq &quot;start&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">        my $exit_code <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        eval &#123;</span><br><span class="line">            print &quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;;</span><br><span class="line">            <span class="operator">&amp;</span>start_vip();</span><br><span class="line">            $exit_code <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        if ($@) &#123;</span><br><span class="line">            warn $@;</span><br><span class="line">            exit $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( $command eq &quot;status&quot; ) &#123;</span><br><span class="line">        print &quot;Checking the Status of the script.. OK \n&quot;;</span><br><span class="line">        exit <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="operator">&amp;</span>usage();</span><br><span class="line">        exit <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sub start_vip() &#123;</span><br><span class="line">    `ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line">sub stop_vip() &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>  unless  ($ssh_user);</span><br><span class="line">    `ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">    print</span><br><span class="line">    &quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>脚本添加执行权限</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#chmod <span class="operator">+</span>x  <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover_script </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ll <span class="operator">-</span>d <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover_script </span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> root root <span class="number">2229</span> Jun <span class="number">22</span> <span class="number">18</span>:<span class="number">41</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover_script</span><br></pre></td></tr></table></figure><h2 id="7-管理节点mha配置文件创建"><a href="#7-管理节点mha配置文件创建" class="headerlink" title="7.管理节点mha配置文件创建"></a>7.管理节点mha配置文件创建</h2><blockquote><p>manager组件所在机器创建配置文件</p></blockquote><p><strong>创建mha配置文件与日志目录存放目录：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#创建配置文件存放目录</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>etc<span class="operator">/</span>mha </span><br><span class="line"></span><br><span class="line">#创建日志文件存放目录，可以针对多个业务创建命名日志目录</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1 </span><br><span class="line"></span><br><span class="line">#创建配置文件，mha可管理多个主从集群，可以针对多个业务命名配置文件</span><br><span class="line">vim  <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf         </span><br></pre></td></tr></table></figure><p><strong>mha-manager配置文件创建：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf <span class="operator">&lt;&lt;</span> &quot;EOF&quot;</span><br><span class="line">[server <span class="keyword">default</span>]</span><br><span class="line">manager_log<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1<span class="operator">/</span>manager.log</span><br><span class="line">manager_workdir<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1.log</span><br><span class="line">master_binlog_dir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span></span><br><span class="line">master_ip_failover_script<span class="operator">=</span><span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover</span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mha</span><br><span class="line">password<span class="operator">=</span><span class="number">1</span></span><br><span class="line">ping_interval<span class="operator">=</span><span class="number">2</span></span><br><span class="line">repl_user<span class="operator">=</span>repl</span><br><span class="line">repl_password<span class="operator">=</span><span class="number">1</span></span><br><span class="line">ssh_user<span class="operator">=</span>root</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line">[server3]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.53</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>参数解释：</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>[server default]</td><td>服务默认模块标签</td></tr><tr><td>manager_log&#x3D;</td><td>mha应用日志存放路径</td></tr><tr><td>manager_workdir&#x3D;</td><td>mha工作目录存放路径<br />存放运行时产生的临时文件，锁文件以及其他需要的临时数据</td></tr><tr><td>master_binlog_dir&#x3D;</td><td>主库binlog存放路径<br />发生故障时会对故障master保存其binlog</td></tr><tr><td>user&#x3D;</td><td>mha连接主从集群实例的用户</td></tr><tr><td>password&#x3D;</td><td>mha连接主从集群实例的密码</td></tr><tr><td>ping_interval&#x3D;2</td><td>mha监控主从集群实例的间隔时间</td></tr><tr><td>repl_user&#x3D;</td><td>slave连接master复制数据账号</td></tr><tr><td>repl_password</td><td>slave连接master复制账号密码</td></tr><tr><td>ssh_user=&#x3D;&#x3D;root&#x3D;&#x3D;</td><td>mha免密连接主从集群机器的用户</td></tr><tr><td>master_ip_failover_script&#x3D;</td><td>vip漂移脚本心跳检测实现vip漂移<br />时刻提供数据库服务对客户端无影响</td></tr><tr><td>[server1]</td><td>主从复制集群节点地址信息</td></tr><tr><td>[server2]</td><td>主从复制集群节点地址信息</td></tr><tr><td>[server3]</td><td>主从复制集群节点地址信息</td></tr></tbody></table><h2 id="8-master节点主库添加设置vip"><a href="#8-master节点主库添加设置vip" class="headerlink" title="8.master节点主库添加设置vip"></a>8.master节点主库添加设置vip</h2><blockquote><p>主库节点给网卡添加新ip地址，该地址需要与自愈脚本中设置的vip对应</p><p>当主库节点故障时，mha会根据自愈脚本实现主从切换，并且会将故障主库的vip地址删除，给新主库重新设置同一vip地址</p></blockquote><p><strong>db-51主库节点设置</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#添加vip</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ifconfig eth1:<span class="number">1</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span><span class="operator">/</span><span class="number">24</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查vip添加</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ifconfig eth1:<span class="number">1</span></span><br><span class="line">eth1:<span class="number">1</span>: flags<span class="operator">=</span><span class="number">4163</span><span class="operator">&lt;</span>UP,BROADCAST,<span class="keyword">RUNNING</span>,MULTICAST<span class="operator">&gt;</span>  mtu <span class="number">1500</span></span><br><span class="line">        inet <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span>  netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>  broadcast <span class="number">172.16</span><span class="number">.1</span><span class="number">.255</span></span><br><span class="line">        ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">39</span>:ad:b4  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 删除vip命令</span><br><span class="line">ifconfig eth1:<span class="number">1</span> del <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span></span><br><span class="line"># 停止vip命令</span><br><span class="line">ifconfig eth1:<span class="number">1</span> down</span><br></pre></td></tr></table></figure><h2 id="9-管理节点检查mha运行前状态"><a href="#9-管理节点检查mha运行前状态" class="headerlink" title="9.管理节点检查mha运行前状态"></a>9.管理节点检查mha运行前状态</h2><blockquote><p>&#x3D;&#x3D;manager组件所在机器检查&#x3D;&#x3D;</p><p>检查mha运行前环境状态是否正常，检查ssh免密连接是否正常，检查主从复制数据同步是否正常</p></blockquote><p><strong>db-52-manager管理节点</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#检查ssh免密登录是否正常</span><br><span class="line">masterha_check_ssh <span class="comment">--conf=/etc/mha/app1.cnf </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查主从复制同步是否正常</span><br><span class="line">masterha_check_repl <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-------------------------------------------------</span></span><br><span class="line">！最后保证两个检查日志都没有报错即可运行mha应用了</span><br></pre></td></tr></table></figure><h2 id="10-管理节点启动mha服务"><a href="#10-管理节点启动mha服务" class="headerlink" title="10.管理节点启动mha服务"></a>10.管理节点启动mha服务</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>启动mha服务</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf  --remove_dead_master_conf  --ignore_last_failover /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查进程状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#jobs <span class="operator">-</span>l</span><br><span class="line">[<span class="number">1</span>]<span class="operator">+</span> <span class="number">39313</span> <span class="keyword">Running</span>                 nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>检查mha服务运行状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">39313</span>) <span class="keyword">is</span> <span class="keyword">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------------</span></span><br><span class="line">#启动参数说明</span><br><span class="line"><span class="comment">--remove_dead_master_conf       该参数代表当发生主从切换后，老的主库的ip将会从配置文件中移除。</span></span><br><span class="line"><span class="comment">--manger_log                    日志存放位置</span></span><br><span class="line"><span class="comment">--ignore_last_failover          默认连续故障不会进行故障转移，忽略这个条件，只要有故障就进行故障转移</span></span><br><span class="line">#停止命令</span><br><span class="line">masterha_stop <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br></pre></td></tr></table></figure><h1 id="四、故障演练实现高可用"><a href="#四、故障演练实现高可用" class="headerlink" title="四、故障演练实现高可用"></a>四、故障演练实现高可用</h1><blockquote><ul><li>模拟主库节点故障，检查mha服务实现高可用效果，故障切换，主从关系重新建立，vip漂移，数据同步情况等</li></ul><ol><li>停止master主库</li><li>查看VIP是否漂移</li><li>查看是否有slave成为new_master</li><li>查看从库是否切换master —slave关系</li></ol></blockquote><h2 id="1-模拟故障关闭主库节点"><a href="#1-模拟故障关闭主库节点" class="headerlink" title="1.模拟故障关闭主库节点"></a>1.模拟故障关闭主库节点</h2><ul><li>主动模拟故障，停掉db-51机器运行的主库节点MySQL实例</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#查看线程信息，当前的db<span class="number">-51</span>机器为master主库</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show processlist&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#关闭mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl stop mysqld</span><br></pre></td></tr></table></figure><h2 id="2-检查故障后的新主库选举"><a href="#2-检查故障后的新主库选举" class="headerlink" title="2.检查故障后的新主库选举"></a>2.检查故障后的新主库选举</h2><ul><li>mha监控到master节点故障后，会进行的一个故障切换，选举主从集群中的日志最新的slave成为新的maste节点，并且将集群中的其他slave节点复制关系指向新的master节点上。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>manager节点，查看当前mha状态，master身份被切换到了<span class="number">52</span>机器</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">52878</span>) <span class="keyword">is</span> <span class="keyword">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>集群中的从库节点查看复制状态，db<span class="number">-52</span>与db<span class="number">-53</span>节点查看</span><br><span class="line"><span class="keyword">show</span> slave status\G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>db<span class="number">-52</span>查不到说明当前被切换成为了master身份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show slave status\G&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>db<span class="number">-53</span>查看复制状态，发现db<span class="number">-52</span>成为了新的master节点主库</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show slave status\G&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</span><br><span class="line">                  Master_Host: <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">1575</span></span><br><span class="line">               Relay_Log_File: db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">414</span></span><br><span class="line">        Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><h2 id="3-检查vip自动漂移"><a href="#3-检查vip自动漂移" class="headerlink" title="3.检查vip自动漂移"></a>3.检查vip自动漂移</h2><ul><li>mha监控到master节点挂掉后，会将挂掉的master上的vip地址删除，并将vip添加到新选举的master节点上，实现了数据库在与外部通信的过程中，一直是处于持续稳定的运行状态。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#检查之前的master节点db<span class="number">-51</span>，宕机挂掉后，vip便不存在了</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ifconfig<span class="operator">|</span>grep <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查新的master节点db<span class="number">-52</span>，切换成为了新主库节点，自动添加了vip</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ifconfig<span class="operator">|</span>grep <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span></span><br><span class="line">        inet <span class="number">172.16</span><span class="number">.1</span><span class="number">.55</span>  netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>  broadcast <span class="number">172.16</span><span class="number">.1</span><span class="number">.255</span></span><br></pre></td></tr></table></figure><h2 id="4-检查新主库与旧主库的数据一致性"><a href="#4-检查新主库与旧主库的数据一致性" class="headerlink" title="4.检查新主库与旧主库的数据一致性"></a>4.检查新主库与旧主库的数据一致性</h2><ul><li>mha监控到master节点故障后，会将故障的master节点上的数据第一时间保存，同步给选举的新master节点，保证数据的一致性</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#检查旧master节点的binlog最新位置</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog]#ll</span><br><span class="line">total <span class="number">20</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 18:51 mysql-bin.000001</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 18:57 mysql-bin.000002</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 19:00 mysql-bin.000003</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 1619 Jun 23 13:12 mysql-bin.000004</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  160 Jun 20 19:09 mysql-bin.index</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog]#mysqlbinlog <span class="operator">-</span>vv mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查新master节点的binlog位置</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog]#ll</span><br><span class="line">total <span class="number">20</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 18:51 mysql-bin.000001</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 18:57 mysql-bin.000002</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  177 Jun 20 19:00 mysql-bin.000003</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 1619 Jun 23 13:12 mysql-bin.000004</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  160 Jun 20 19:09 mysql-bin.index</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog]#mysqlbinlog <span class="operator">-</span>vv mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br></pre></td></tr></table></figure><ul><li>最后保证新master与故障master的binlog最新数据一致即可</li></ul><p><img src="/image-20240623141035216.png" alt="image-20240623141035216"></p><h2 id="5-检查新主从关系的复制效果"><a href="#5-检查新主从关系的复制效果" class="headerlink" title="5.检查新主从关系的复制效果"></a>5.检查新主从关系的复制效果</h2><ul><li>故障切换后，新的主从关系建立，slave节点复制数据指向了新的master节点，还要保证新主从复制效果是否正常</li><li>当前新master节点为db-52，slave节点为db-53，master写入数据，检查slave同步即可</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>先检查一下slave与新master建立复制关系后，之前的数据同步情况，确保数据的一致性</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show slave status\G&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>新master节点db<span class="number">-52</span>写入数据</span><br><span class="line">#增加数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from  checktest.t1&quot;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;insert into checktest.t1 values(333),(333),(333)&quot;</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from  checktest.t1&quot;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">#检查binlog，查看binlog最新事务GTID截止点</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show master status&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>检查slave节点db<span class="number">-53</span>复制数据</span><br><span class="line">#数据同步无误</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from checktest.t1&quot;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">#检查binlog，确保事务GTID一致即可</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show master status&quot;</span><br></pre></td></tr></table></figure><h2 id="6-mha故障切换后自动停止服务"><a href="#6-mha故障切换后自动停止服务" class="headerlink" title="6.mha故障切换后自动停止服务"></a>6.mha故障切换后自动停止服务</h2><p>当master节点挂掉，mha进行故障切换完成后，会自动停止服务，并且配置文件中移除故障master地址信息</p><p>需要手动进行故障节点恢复，以slave身份重新加入主从集群中，再将故障节点加入mha配置文件中</p><p>最后重新检查免密状态与复制状态，重启启动mha即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#处理故障结束后自动关闭服务</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 <span class="keyword">is</span> stopped(<span class="number">2</span>:NOT_RUNNING).</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置文件自动剔除故障节点地址信息</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#grep <span class="string">&#x27;server&#x27;</span> <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf </span><br><span class="line">[server <span class="keyword">default</span>]</span><br><span class="line">[server2]</span><br><span class="line">[server3]</span><br></pre></td></tr></table></figure><h1 id="五、故障恢复重新加入高可用"><a href="#五、故障恢复重新加入高可用" class="headerlink" title="五、故障恢复重新加入高可用"></a>五、故障恢复重新加入高可用</h1><p><strong>当前环境：</strong></p><p>db-51机器旧master节点故障宕机，db-52机器的slave节点被选举新master节点，db-53机器的slave节点与新master建立了新主从关系，并且新master节点内写入了新数据，db-53机器的slave节点已经同步新master的数据</p><p><strong>故障节点恢复流程：</strong></p><table><thead><tr><th>db-51机器故障master节点恢复步骤</th><th>说明</th></tr></thead><tbody><tr><td>1.恢复节点上的挂掉的mysl实例</td><td></td></tr><tr><td>2.重新加入主从集群中</td><td>故障切换时，故障节点已被剔除出主从集群</td></tr><tr><td>3.配置连接新master参数开启复制功能</td><td>故障切换时，重新选举了新master，只能以slave身份加入</td></tr><tr><td>4.检查数据增量同步情况</td><td>故障切换后，新master已有增量数据写入，加入集群后，会自动同步新master数据</td></tr><tr><td>5.地址信息重新加入mha高可用环境中</td><td>故障切换后，manager节点mha配置中自动剔除了故障节点的地址信息.</td></tr></tbody></table><h2 id="1-恢复故障节点"><a href="#1-恢复故障节点" class="headerlink" title="1.恢复故障节点"></a>1.恢复故障节点</h2><p>故障是自己模拟的重新启动即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">80</span>     [::]:<span class="number">3306</span>               [::]:<span class="operator">*</span>                   users:((&quot;mysqld&quot;,pid<span class="operator">=</span><span class="number">35181</span>,fd<span class="operator">=</span><span class="number">33</span>))</span><br></pre></td></tr></table></figure><h2 id="2-以slave身份重新加入主从集群"><a href="#2-以slave身份重新加入主从集群" class="headerlink" title="2.以slave身份重新加入主从集群"></a>2.以slave身份重新加入主从集群</h2><p>只能以slave身份加入，故障切换时，mha在集群中重新定义了主从关系已有新master节点了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#登录实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前binlog信息</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+----------------------------</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+----------------------------</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>      <span class="number">194</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span> <span class="number">44300</span>b99<span class="number">-2</span>ef4<span class="number">-11</span>ef<span class="number">-8541</span><span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+----------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置连接主库参数</span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.52&#x27;</span>,master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>, MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">2</span> warnings (<span class="number">0.09</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动复制功能</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="3-新slave节点检查复制状态与数据同步"><a href="#3-新slave节点检查复制状态与数据同步" class="headerlink" title="3.新slave节点检查复制状态与数据同步"></a>3.新slave节点检查复制状态与数据同步</h2><p>检查db-51恢复的slave节点复制状态是否正常，检查与新master数据同步是否正常</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>检查复制状态的线程信息</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G;</span><br><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> processlist;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查与master的binlog同步情况</span><br><span class="line">#检查读取到master的binlog截止点与同步的binlog截止点是否一致</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G;</span><br><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">Read_Master_Log_Pos: <span class="number">1839</span></span><br><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">Exec_Master_Log_Pos: <span class="number">1839</span></span><br><span class="line">Retrieved_Gtid_Set: <span class="number">3</span>b0e9ff9<span class="number">-2</span>ef5<span class="number">-11</span>ef<span class="operator">-</span>bb71<span class="number">-000</span>c29b82832:<span class="number">1</span></span><br><span class="line">Executed_Gtid_Set: <span class="number">3</span>b0e9ff9<span class="number">-2</span>ef5<span class="number">-11</span>ef<span class="operator">-</span>bb71<span class="number">-000</span>c29b82832:<span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">#检查master与本地slave的binlog状态，事务GTID为一致即可</span><br><span class="line"><span class="keyword">show</span> master status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>最后检查同步的数据，保证主从复制功能正常</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;select * from checktest.t1&quot;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">333</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240623154949471.png" alt="image-20240623154949471"></p><h2 id="4-恢复的节点地址重新加入mha中"><a href="#4-恢复的节点地址重新加入mha中" class="headerlink" title="4.恢复的节点地址重新加入mha中"></a>4.恢复的节点地址重新加入mha中</h2><p>&#x3D;&#x3D;manager管理节点上操作&#x3D;&#x3D;</p><p>故障切换时，mha自动将配置文件中的故障节点地址剔除，如今恢复了故障节点，并且以slave身份重新加入到了主从集群中</p><p>再将恢复的db-51节点，重新加入manager管理节点的mha配置文件中，加入mha高可用服务，重新运行mha即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>执行如下命令，或者修改配置文件</span><br><span class="line">#这条命令就是在配置文件中加入新节点的地址信息</span><br><span class="line">masterha_conf_host <span class="comment">--command=add --conf=/etc/mha/app1.cnf --hostname=172.16.1.51 --block=server1 --params=&quot;port=3306&quot;</span></span><br><span class="line">#或者修改配置文件写入新节点地址</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf </span><br><span class="line">[server1]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>重启mha</span><br><span class="line">#关闭mha</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_stop <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">#检查免密登录状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_ssh <span class="comment">--conf=/etc/mha/app1.cnf </span></span><br><span class="line">#检查主从复制状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_repl <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>确保mha运行前状态无误后，重新启动mha</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf  --remove_dead_master_conf  --ignore_last_failover /var/log/mha/app1/manager.log &amp;&gt;/var/log/mha/app1/manager.log  &amp;</span></span><br><span class="line">[<span class="number">1</span>] <span class="number">68119</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#jobs <span class="operator">-</span>l</span><br><span class="line">[<span class="number">1</span>]<span class="operator">+</span> <span class="number">68119</span> <span class="keyword">Running</span>                 nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover /var/log/mha/app1/manager.log &amp;&gt;/var/log/mha/app1/manager.log &amp;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>检查mha运行状态</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">68119</span>) <span class="keyword">is</span> <span class="keyword">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br></pre></td></tr></table></figure><blockquote><p>至此，故障节点成功恢复，重新加入到了mha高可用集群中</p></blockquote><h1 id="六、故障再次演练mha日志监测进行原理分析"><a href="#六、故障再次演练mha日志监测进行原理分析" class="headerlink" title="六、故障再次演练mha日志监测进行原理分析"></a>六、故障再次演练mha日志监测进行原理分析</h1><blockquote><p>再次模拟故障，在manager管理节点上监测日志，基于mha的日志，分析mha实现高可用的原理</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#监测日志</span><br><span class="line">tail <span class="operator">-</span>f <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1<span class="operator">/</span>manager.log </span><br></pre></td></tr></table></figure></blockquote><h2 id="1-模拟故障"><a href="#1-模拟故障" class="headerlink" title="1.模拟故障"></a>1.模拟故障</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#当前master节点为<span class="number">52</span>机器</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">68119</span>) <span class="keyword">is</span> <span class="keyword">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br><span class="line"></span><br><span class="line">#模拟故障停掉<span class="number">52</span>机器mysql实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#systemctl stop mysqld</span><br></pre></td></tr></table></figure><h2 id="2-日志监测分析"><a href="#2-日志监测分析" class="headerlink" title="2.日志监测分析"></a>2.日志监测分析</h2><p>具体原理分析即可，需要必备英语水平，使用翻译软件也可以</p><p><img src="/image-20240623165740278.png" alt="image-20240623165740278"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;一、MHA高可用概述&quot;&gt;&lt;a href=&quot;#一、MHA高可用概述&quot; class=&quot;headerlink&quot; title=&quot;一、MHA高可用概述&quot;&gt;&lt;/a&gt;一、MHA高可用概述&lt;/h1&gt;&lt;h2 id=&quot;1-什么是MHA&quot;&gt;&lt;a href=&quot;#1-什么是MHA&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-主从复制</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</id>
    <published>2024-08-20T00:55:34.000Z</published>
    <updated>2024-08-20T01:03:15.786Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、主从复制架构概述"><a href="#一、主从复制架构概述" class="headerlink" title="一、主从复制架构概述"></a>一、主从复制架构概述</h1><ul><li><p>主从复制，以1台master主库机器，多台slave从库机器，通过服务自带功能，实现主从复制效果</p></li><li><p>搭建主从复制集群的基础，可以通过mha工具实现高可用，防止单节点数据库故障，影响正常业务</p></li><li><p>并且主库的数据同步在从库上，再次实现了备份对数据提供了一个保障</p></li></ul><h1 id="二、主从复制搭建部署pos值"><a href="#二、主从复制搭建部署pos值" class="headerlink" title="二、主从复制搭建部署pos值"></a>二、主从复制搭建部署pos值</h1><h2 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1.环境准备"></a>1.环境准备</h2><ul><li>目标：主库db-51更新数据，db-52与db-53两台从库机器自动同步新增数据</li><li>机器准备：db-51为master主库，内部有原本数据。db-52、db-53为slave从库，内部无数据。</li></ul><blockquote><p>注意事项:</p><p>1.主从复制时，从库需保证库中无其他数据，确保内部空间只留给主从复制同步数据</p><p>2.并且每个实例server_id需不同，否则会影响备份数据</p><p>3.binlog日志目录，需要与数据目录区分开，不能放到一起，否则也会影响备份数据</p><p>4.主库需开binlog日志，从库不可开启binlog记录</p></blockquote><h3 id="1-1-从库配置"><a href="#1-1-从库配置" class="headerlink" title="1.1 从库配置"></a>1.1 从库配置</h3><ul><li>从库配置一样，除了server_id不同</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.</span>检查selinux</span><br><span class="line">getenforce</span><br><span class="line">setenforce <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>创建数据存放目录并授权</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>&#123;tools,data&#125;</span><br><span class="line">mkdir <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>下载安装mysql</span><br><span class="line">tar <span class="operator">-</span>xf mysql5<span class="number">.7</span>.tgz  <span class="operator">-</span>C <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>创建软链接加入PATH变量</span><br><span class="line">#软链接</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql5<span class="number">.7</span><span class="number">.20</span> <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">#环境变量添加</span><br><span class="line">cat <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>profile <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">export PATH<span class="operator">=</span>$PATH:<span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin</span><br><span class="line">EOF</span><br><span class="line">source <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">#检查</span><br><span class="line">mysql <span class="comment">--version</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>卸载mariadb依赖安装mysql专用依赖</span><br><span class="line">yum remove mariadb<span class="operator">-</span>libs<span class="number">-5.5</span><span class="number">.68</span><span class="number">-1.</span>el7.x86_64 <span class="operator">-</span>y</span><br><span class="line">yum install libaio<span class="operator">-</span>devel <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>修改配置文件</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">53</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">[mysql] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">[client] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>创建mysql进程运行用户，初始化数据库</span><br><span class="line">useradd <span class="operator">-</span>M <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/data/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>拷贝mysql自带启停脚本，到系统管理服务脚本路径下</span><br><span class="line">cp <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">systemctl enable mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>启动mysql检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>检查从库环境，binlog不能开启</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show master status&quot;</span><br></pre></td></tr></table></figure><h3 id="1-2-主库配置"><a href="#1-2-主库配置" class="headerlink" title="1.2 主库配置"></a>1.2 主库配置</h3><ul><li>主库最好初始化环境，重新进行配置，否则部署主从复制时，会出现一些问题</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建数据存放目录与binlog存放目录,并且授权</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>&#123;tools,data,mysql_binlog&#125;</span><br><span class="line">mkdir <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>mysql_binlog</span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>下载安装mysql</span><br><span class="line">tar <span class="operator">-</span>xf mysql5<span class="number">.7</span>.tgz  <span class="operator">-</span>C <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>创建软链接加入PATH变量</span><br><span class="line">#软链接</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql5<span class="number">.7</span><span class="number">.20</span> <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">#环境变量添加</span><br><span class="line">cat <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>profile <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">export PATH<span class="operator">=</span>$PATH:<span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin</span><br><span class="line">EOF</span><br><span class="line">source <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">#检查</span><br><span class="line">mysql <span class="comment">--version</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>卸载mariadb依赖安装mysql专用依赖</span><br><span class="line">yum remove mariadb<span class="operator">-</span>libs<span class="number">-5.5</span><span class="number">.68</span><span class="number">-1.</span>el7.x86_64 <span class="operator">-</span>y</span><br><span class="line">yum install libaio<span class="operator">-</span>devel <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>修改配置文件</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">53</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">[mysql] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">[client] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>创建mysql进程运行用户，初始化数据库</span><br><span class="line">useradd <span class="operator">-</span>M <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/data/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>拷贝mysql自带启停脚本，到系统管理服务脚本路径下</span><br><span class="line">cp <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">systemctl enable mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>启动mysql检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span> </span><br></pre></td></tr></table></figure><h2 id="2-主库操作"><a href="#2-主库操作" class="headerlink" title="2.主库操作"></a>2.主库操作</h2><h3 id="2-1-创建从库连接账号"><a href="#2-1-创建从库连接账号" class="headerlink" title="2.1 创建从库连接账号"></a>2.1 创建从库连接账号</h3><ul><li>在主库中创建一个，用于从库连接主库同步数据的账号，同步数据前会需要该账号与主库建立连接关系</li></ul><blockquote><p>&#x3D;&#x3D;授予权限&#x3D;&#x3D;：</p><p>Replication slave       | Server Admin       | To read binary log events from the master  </p><p>复制  从库服务器             服务器管理              从主库服务器读取二进制日志事件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看可授予的权限</span><br><span class="line">mysql&gt; show privileges; </span><br></pre></td></tr></table></figure></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>主库root用户先需有一个密码</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,authentication_string  <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span> <span class="operator">|</span> authentication_string                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> root <span class="operator">|</span> <span class="operator">*</span>E6CC90B878B948C35E92B003C792C46C58C4AF40 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>创建repl用户(主从复制中的通用用户名)，授予权限，设置密码</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>查看授予的权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> repl@<span class="string">&#x27;172.16.1.%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> repl<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.<span class="operator">%</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>查看用户连接白名单</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host,plugin <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span> host       <span class="operator">|</span> plugin                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> root          <span class="operator">|</span> localhost  <span class="operator">|</span> mysql_native_password <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.session <span class="operator">|</span> localhost  <span class="operator">|</span> mysql_native_password <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql.sys     <span class="operator">|</span> localhost  <span class="operator">|</span> mysql_native_password <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> repl          <span class="operator">|</span> <span class="number">172.16</span><span class="number">.1</span>.<span class="operator">%</span> <span class="operator">|</span> mysql_native_password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------+-----------------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="2-2-备份主库原有数据"><a href="#2-2-备份主库原有数据" class="headerlink" title="2.2 备份主库原有数据"></a>2.2 备份主库原有数据</h3><blockquote><p>当前主库已变更新数据，修改了root密码与创建了repl用户，导致主库数据变化</p><p>所以需要先同步原有数据到从库</p></blockquote><p><strong>备份参数</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>–single-transaction</td><td>类似于锁表，但是不影响业务新数据写入,可以保证备份数据的一致性<br />只适用于事务存储引擎仅InnoDB</td></tr><tr><td>–master-data</td><td>该选项将binlog日志的事务截止点追加到输出文件中；<br />如果为1，将会输出CHANGE MASTER命令； <br />如果为2，输出的CHANGE MASTER命令前添加注释信息</td></tr><tr><td>–triggers</td><td>导出表关联的触发器,该选项默认启用，–skip-triggers禁用功能</td></tr><tr><td>–routines, -R</td><td>导出存储过程以及自定义函数</td></tr><tr><td>–flush-logs，-F</td><td>备份的同时进行切割binlog日志，生成新的binlog记录新增量事务</td></tr><tr><td>–events, -E</td><td>导出所有事务</td></tr><tr><td>–max_allowed_packet</td><td>数据包传输大小设置，优化功能</td></tr><tr><td>–set-gtid-purged&#x3D;OFF</td><td>导出事务时，每个事务的GTID不跟随导出；GTID在每个实例中是唯一的，<br />若sql文件需要导入 其它实例中，就需要加上该参数，否则会报错无法导入</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>备份所有数据转为<span class="keyword">sql</span>语句导入文件中</span><br><span class="line">mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p  <span class="operator">-</span>A <span class="comment">--master-data=2 --single-transaction -R -E --triggers --max_allowed_packet=64M &gt; /app/data/mysql_all_bak.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>将<span class="keyword">sql</span>文件发送给slave从库机器</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">52</span> <span class="number">53</span></span><br><span class="line">do</span><br><span class="line">scp <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span>mysql_all_bak.sql root<span class="variable">@172</span><span class="number">.16</span><span class="number">.1</span>.$&#123;i&#125;:<span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="3-从库操作"><a href="#3-从库操作" class="headerlink" title="3.从库操作"></a>3.从库操作</h2><h3 id="3-1-复制主库原有数据"><a href="#3-1-复制主库原有数据" class="headerlink" title="3.1 复制主库原有数据"></a>3.1 复制主库原有数据</h3><p><strong>db51、db52从库机器操作：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>导入主库备份的<span class="keyword">sql</span>文件</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">&lt;</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span>mysql_all_bak.sql </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查是否同步</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select user,host from mysql.user&quot;</span><br></pre></td></tr></table></figure><h3 id="3-2-配置连接主库参数"><a href="#3-2-配置连接主库参数" class="headerlink" title="3.2 配置连接主库参数"></a>3.2 配置连接主库参数</h3><blockquote><p>执行如下参数信息，配置与主库的连接信息，从而连接主库，方可进行复制数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>查看备份文件中注释信息，binlog截止点与文件名，用于复制主库时填入参数信息</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#grep  <span class="operator">-</span>i <span class="string">&#x27;\-- change master&#x27;</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span>mysql_all_bak.sql </span><br><span class="line"><span class="comment">-- CHANGE MASTER TO MASTER_LOG_FILE=&#x27;mysql-bin.000002&#x27;, MASTER_LOG_POS=600;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>数据库中执行如下参数</span><br><span class="line">change master <span class="keyword">to</span> </span><br><span class="line">#主库机器ip</span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">#主库实例端口</span><br><span class="line">master_port<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">#连接主库的账号</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">#连接主库的密码</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">#从主库binlog哪里开始复制数据，以<span class="keyword">sql</span>文件中binlog截止点为准</span><br><span class="line">master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000003&#x27;</span>,</span><br><span class="line">master_log_pos<span class="operator">=</span><span class="number">856</span>,</span><br><span class="line">#断开连接后<span class="number">10</span>s后自动连接</span><br><span class="line">master_connect_retry<span class="operator">=</span><span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>精简</span><br><span class="line">change master <span class="keyword">to</span> </span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_port<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">master_log_pos<span class="operator">=</span><span class="number">596</span>,</span><br><span class="line">master_connect_retry<span class="operator">=</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure><h3 id="3-3-从库开启复制功能"><a href="#3-3-从库开启复制功能" class="headerlink" title="3.3 从库开启复制功能"></a>3.3 从库开启复制功能</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="3-4-检查从库复制状态"><a href="#3-4-检查从库复制状态" class="headerlink" title="3.4 检查从库复制状态"></a>3.4 检查从库复制状态</h3><p>&#x3D;&#x3D;保证如下两线程状态为yes，复制功能才是正常开启&#x3D;&#x3D;</p><table><thead><tr><th>两个重要线程</th><th>线程解释</th></tr></thead><tbody><tr><td>Slave_IO_Running：</td><td>表示I&#x2F;O的线程状态，I&#x2F;O线程负责从主库中读取Binlog日志，并将Binlog日志写入从库的中继日志中，状态为Yes表示I&#x2F;O线程工作正常，否则异常。</td></tr><tr><td>Slave_SQL_Running：</td><td>表示SQL的线程状态，SQL线程负责读取中继日志（relay-log）中的数据并转换为SQL语句应用到从数据库中，状态为Yes表示I&#x2F;O线程工作正常，否则异常。</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show slave status\G&quot;<span class="operator">|</span>egrep <span class="operator">-</span>iw <span class="string">&#x27;(slave_io|slave_sql)_running&#x27;</span></span><br><span class="line">Enter password: </span><br><span class="line">            Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><h2 id="4-测试主从复制"><a href="#4-测试主从复制" class="headerlink" title="4.测试主从复制"></a>4.测试主从复制</h2><blockquote><p>当前已然配置好了主从复制功能，模拟主库写入新数据，从库数据是否会更新与主库同步</p></blockquote><h3 id="4-1-主库写入新的数据"><a href="#4-1-主库写入新的数据" class="headerlink" title="4.1 主库写入新的数据"></a>4.1 主库写入新的数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>主库实例id</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@server_id</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@server_id</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">51</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>写入测试数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test.t1(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> test.t1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h3 id="4-2-从库检查数据复制"><a href="#4-2-从库检查数据复制" class="headerlink" title="4.2 从库检查数据复制"></a>4.2 从库检查数据复制</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>从库实例id</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@server_id</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@server_id</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">53</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查复制情况，成功复制</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="三、主从复制涉及线程文件"><a href="#三、主从复制涉及线程文件" class="headerlink" title="三、主从复制涉及线程文件"></a>三、主从复制涉及线程文件</h1><h2 id="1-主库线程"><a href="#1-主库线程" class="headerlink" title="1.主库线程"></a>1.主库线程</h2><blockquote><p>&#x3D;&#x3D;Binglog Dump线程：&#x3D;&#x3D;接收从库的复制请求，当主库有新事件发生，将binlog新事件信息发送给从库线程</p></blockquote><p><img src="/image-20240619115107998.png" alt="image-20240619115107998"></p><h2 id="2-从库线程"><a href="#2-从库线程" class="headerlink" title="2.从库线程"></a>2.从库线程</h2><blockquote><p>&#x3D;&#x3D;Slave_IO线程:&#x3D;&#x3D;请求主库binlog新事件信息，接收后将信息保存到relay中继日志中</p><p>&#x3D;&#x3D;Slave_SQL线程:&#x3D;&#x3D;读取relay中继日志中事件信息，转为sql语句进行复制数据</p></blockquote><p><img src="/image-20240619120715179.png" alt="image-20240619120715179"></p><p><img src="/image-20240619120831592.png" alt="image-20240619120831592"></p><h2 id="3-主库文件"><a href="#3-主库文件" class="headerlink" title="3.主库文件"></a>3.主库文件</h2><blockquote><p>主从复制会涉及主库的binlog日志</p><p>搭建主从复制后，当主库有新数据写入后，新数据会成为新事务保存到binlog日志中，再将新binlog记录转发给从库</p></blockquote><p><strong>binlog日志文件</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#查看历史所有binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">1018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>     <span class="number">1018</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#变量查看binlog所在路径</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sql_log_bin                     <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.06</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog日志文件</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_binlog<span class="operator">/</span></span><br><span class="line">total <span class="number">8</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 1018 Jun 19 11:21 mysql-bin.000001</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql   37 Jun 18 19:15 mysql-bin.index</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#解密查看binlog日志</span><br><span class="line">mysqlbinlog  mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br></pre></td></tr></table></figure><h2 id="4-从库文件"><a href="#4-从库文件" class="headerlink" title="4.从库文件"></a>4.从库文件</h2><blockquote><p>主从复制涉及从库中的中继日志</p><p>从库io线程收到主库新生成的binlog信息，会将新的binlog记录，转储到从库中的中继日志当中</p><p>从库sql线程再通过relay日志中的sql语句，进行复制数据，实现主从复制的效果</p></blockquote><p><strong>中继日志文件</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#变量查看中继日志相关信息，relay日志所在地</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%relay%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name             <span class="operator">|</span> <span class="keyword">Value</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> max_relay_log_size        <span class="operator">|</span> <span class="number">0</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log                 <span class="operator">|</span>                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_basename        <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_index           <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_info_file       <span class="operator">|</span> relay<span class="operator">-</span>log.info                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_info_repository <span class="operator">|</span> FILE                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_purge           <span class="operator">|</span> <span class="keyword">ON</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_recovery        <span class="operator">|</span> OFF                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> relay_log_space_limit     <span class="operator">|</span> <span class="number">0</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sync_relay_log            <span class="operator">|</span> <span class="number">10000</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sync_relay_log_info       <span class="operator">|</span> <span class="number">10000</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看中继日志文件</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#ll  <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin.<span class="operator">*</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 207 Jun 18 19:21 db-53-relay-bin.000001</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 995 Jun 19 13:32 db-53-relay-bin.000002</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql  50 Jun 18 19:21 db-53-relay-bin.index</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#可解密查看中继日志记录的数据，其实就是一堆<span class="keyword">sql</span>语句，与主库的binlog记录相同</span><br><span class="line">mysqlbinlog   db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br></pre></td></tr></table></figure><p><strong>relay-log.info</strong></p><p>中继日志的最新截止点，以及对应的binlog最新截止点</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#cat relay<span class="operator">-</span>log.info </span><br><span class="line"><span class="number">7</span></span><br><span class="line">.<span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line"><span class="number">995</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line"><span class="number">1271</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong>master.info</strong></p><p>连接主库的相关信息，以及上次复制主库binlog的截止点，用于下次复制主库的binlog信息</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#cat master.info</span><br><span class="line"><span class="number">25</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line"><span class="number">1271</span></span><br><span class="line"><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">repl</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3306</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure><h1 id="四、主从复制监控"><a href="#四、主从复制监控" class="headerlink" title="四、主从复制监控"></a>四、主从复制监控</h1><blockquote><p>用于排查主从复制故障问题</p></blockquote><h2 id="1-主库监控"><a href="#1-主库监控" class="headerlink" title="1.主库监控"></a>1.主库监控</h2><ul><li>查看主库转储线程状态</li></ul><p><img src="/image-20240619143157278.png" alt="image-20240619143157278"></p><ul><li>查看从库连接信息</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave hosts;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------+------+-----------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Server_id <span class="operator">|</span> Host <span class="operator">|</span> Port <span class="operator">|</span> Master_id <span class="operator">|</span> Slave_UUID                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------+------+-----------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">53</span> <span class="operator">|</span>      <span class="operator">|</span> <span class="number">3306</span> <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span> <span class="number">8</span>fb6a834<span class="number">-2</span>d64<span class="number">-11</span>ef<span class="number">-879e-000</span>c29f56446 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------+------+-----------+--------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-从库监控"><a href="#2-从库监控" class="headerlink" title="2.从库监控"></a>2.从库监控</h2><ul><li><p>查看从库的复制状态详细信息</p><p>复制状态参数详解：<a href="https://www.cnblogs.com/paul8339/p/7615310.html">https://www.cnblogs.com/paul8339/p/7615310.html</a></p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure><h2 id="3-日志监控"><a href="#3-日志监控" class="headerlink" title="3.日志监控"></a>3.日志监控</h2><ul><li>查看IO线程已获取的主库binlog的位置点</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">Read_Master_Log_Pos: <span class="number">485</span></span><br></pre></td></tr></table></figure><ul><li>SQL线程回放的relaylog的位置点（中继日志自身的截止点）</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Relay_Log_File: db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000005</span></span><br><span class="line">Relay_Log_Pos: <span class="number">698</span></span><br></pre></td></tr></table></figure><ul><li>SQL线程回放relaylog的位置点，对应的主库的binlog位置点</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000004</span></span><br><span class="line">Exec_Master_Log_Pos: <span class="number">485</span></span><br></pre></td></tr></table></figure><h1 id="五-主从复制故障解决"><a href="#五-主从复制故障解决" class="headerlink" title="五.主从复制故障解决"></a>五.主从复制故障解决</h1><h2 id="1-从库复制状态值"><a href="#1-从库复制状态值" class="headerlink" title="1.从库复制状态值"></a>1.从库复制状态值</h2><blockquote><p>Slave_IO_Running:                     # IO线程工作状态，yes，no，connection三个状态<br>Slave_SQL_Running:                    # SQL工作状态，yes ，no<br>Last_IO_Error:                        # IO故障代码，2003，1045，1040,1593,1236<br>Last_SQL_Errno: 0                     # SQL线程故障代码，1008，1007</p></blockquote><h2 id="2-故障常见原因"><a href="#2-故障常见原因" class="headerlink" title="2.故障常见原因"></a>2.故障常见原因</h2><blockquote><p>1.网络波动<br>2.master 连接信息错误，如端口，用户，密码，授权规则错误，复制无权限<br>3.防火墙拒绝请求<br>4.主机连接数到达上限<br>5.master、slave版本不一，5.7 、8.0、 5.6</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#查看数据库连接限制数量</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@max_connections</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@max_connections</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span>               <span class="number">151</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br></pre></td></tr></table></figure><h2 id="3-解决思路"><a href="#3-解决思路" class="headerlink" title="3.解决思路"></a>3.解决思路</h2><blockquote><ol><li>网络是否通</li><li>确认复制的change master配置正确</li><li>主从的server_id是否正常</li><li>主从的server_uuid是否正常</li><li>一般情况下，最直接暴力的解决办法，重新搭建主从备份数据+重新构建主从关系，能最快解决问题。</li></ol></blockquote><h1 id="六、主从复制之过滤复制"><a href="#六、主从复制之过滤复制" class="headerlink" title="六、主从复制之过滤复制"></a>六、主从复制之过滤复制</h1><blockquote><p>过滤库表复制就是只针对某个库或者某个表，进行数据的同步复制</p></blockquote><h2 id="1-配置参数说明"><a href="#1-配置参数说明" class="headerlink" title="1.配置参数说明"></a>1.配置参数说明</h2><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>replicate_do_db：</td><td>数据库白名单列表，多个数据库用逗号分隔，该选项指定的数据库会执行主从复制操作</td></tr><tr><td>replicate_ignore_db：</td><td>数据库黑名单列表，该选项指定的数据库将不会被复制</td></tr><tr><td>replicate_do_table：</td><td>表级别的白名单</td></tr><tr><td>replicate_ignore_table：</td><td>表级别的黑名单</td></tr><tr><td>replicate_wild_do_table：</td><td>可以使用通配符进行指定表，如%代表所有</td></tr><tr><td>replicate_wild_ignore_table：</td><td>可以使用通配符进行指定表，如%代表所有</td></tr></tbody></table><h2 id="2-过滤复制实践"><a href="#2-过滤复制实践" class="headerlink" title="2.过滤复制实践"></a>2.过滤复制实践</h2><h3 id="2-1-需求环境准备"><a href="#2-1-需求环境准备" class="headerlink" title="2.1 需求环境准备"></a>2.1 需求环境准备</h3><blockquote><p>从库进行白名单配置，只对主库的test库进行数据复制。主库其他数据变动一律不进行同步复制。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#主库准备</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="2-2-从库修改配置"><a href="#2-2-从库修改配置" class="headerlink" title="2.2 从库修改配置"></a>2.2 从库修改配置</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#修改配置文件</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">replicate_do_db<span class="operator">=</span>test  #对test库设置了白名单</span><br><span class="line">server_id<span class="operator">=</span><span class="number">53</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">[mysql] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">[client] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重启检查端口</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#systemctl restart mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">80</span>     [::]:<span class="number">3306</span>               [::]:<span class="operator">*</span>                   users:((&quot;mysqld&quot;,pid<span class="operator">=</span><span class="number">25016</span>,fd<span class="operator">=</span><span class="number">26</span>))</span><br></pre></td></tr></table></figure><h3 id="2-3-过滤复制测试"><a href="#2-3-过滤复制测试" class="headerlink" title="2.3 过滤复制测试"></a>2.3 过滤复制测试</h3><ul><li><strong>主库白名单之外新增数据，查看从库复制情况</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#主库模拟写入数据，创建<span class="keyword">new</span>库</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;create database new&quot;</span><br><span class="line">Enter password: </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#从库检查复制情况，白名单之外的数据不会复制，没有复制<span class="keyword">new</span>库</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure><ul><li><strong>主库白名单之内新增数据，查看从库复制情况</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#主库模拟写入数据，在test库新加入数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;insert into test.t1 values(55)&quot;</span><br><span class="line">Enter password: </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from test.t1&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">55</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#从库检查复制情况，对白名单test库进行数据复制，复制了主库新加的数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select * from test.t1 &quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">55</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br></pre></td></tr></table></figure><h1 id="七、主从复制搭建部署GTID"><a href="#七、主从复制搭建部署GTID" class="headerlink" title="七、主从复制搭建部署GTID"></a>七、主从复制搭建部署GTID</h1><h2 id="1-环境准备-1"><a href="#1-环境准备-1" class="headerlink" title="1.环境准备"></a>1.环境准备</h2><blockquote><p>基于GTID实现主从复制，主库与从库需要都得开启GTID功能</p><p>并且不能有一方使用pos值，一方使用GTID，会导致无法建立连接关系</p><p>主库开gtid，从库就得用gtid配置连接。主库不开gtid能用pos值配置连接。</p></blockquote><p><strong>db-51主库</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建数据存放目录与binlog存放目录,并且授权</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>&#123;tools,data,mysql_binlog&#125;</span><br><span class="line">mkdir <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>mysql_binlog</span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>下载安装mysql</span><br><span class="line">tar <span class="operator">-</span>xf mysql5<span class="number">.7</span>.tgz  <span class="operator">-</span>C <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>创建软链接加入PATH变量</span><br><span class="line">#软链接</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql5<span class="number">.7</span><span class="number">.20</span> <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">#环境变量添加</span><br><span class="line">cat <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>profile <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">export PATH<span class="operator">=</span>$PATH:<span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin</span><br><span class="line">EOF</span><br><span class="line">source <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">#检查</span><br><span class="line">mysql <span class="comment">--version</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>卸载mariadb依赖安装mysql专用依赖</span><br><span class="line">yum remove mariadb<span class="operator">-</span>libs<span class="number">-5.5</span><span class="number">.68</span><span class="number">-1.</span>el7.x86_64 <span class="operator">-</span>y</span><br><span class="line">yum install libaio<span class="operator">-</span>devel <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>修改配置文件，加入开启GTID参数</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span> </span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">character_set_server<span class="operator">=</span>utf8mb4 </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">log<span class="operator">-</span>error<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>error_3306.log</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>创建mysql进程运行用户，初始化数据库</span><br><span class="line">useradd <span class="operator">-</span>M <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/data/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>拷贝mysql自带启停脚本，到系统管理服务脚本路径下</span><br><span class="line">cp <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">systemctl enable mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>启动mysql检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">9.</span>检查GTID是否开启</span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> master status;</span><br></pre></td></tr></table></figure><p><strong>db-52、db-53从库</strong></p><p>:warning:从库server_id参数不能一样</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建数据存放目录并授权</span><br><span class="line">mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>&#123;tools,data&#125;</span><br><span class="line">mkdir <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">chown <span class="operator">-</span>R mysql:mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>下载安装mysql</span><br><span class="line">tar <span class="operator">-</span>xf mysql5<span class="number">.7</span>.tgz  <span class="operator">-</span>C <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>创建软链接加入PATH变量</span><br><span class="line">#软链接</span><br><span class="line">ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql5<span class="number">.7</span><span class="number">.20</span> <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">#环境变量添加</span><br><span class="line">cat <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>profile <span class="operator">&lt;&lt;</span>&quot;EOF&quot;</span><br><span class="line">export PATH<span class="operator">=</span>$PATH:<span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin</span><br><span class="line">EOF</span><br><span class="line">source <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">#检查</span><br><span class="line">mysql <span class="comment">--version</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>卸载mariadb依赖安装mysql专用依赖</span><br><span class="line">yum remove mariadb<span class="operator">-</span>libs<span class="number">-5.5</span><span class="number">.68</span><span class="number">-1.</span>el7.x86_64 <span class="operator">-</span>y</span><br><span class="line">yum install libaio<span class="operator">-</span>devel <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>修改配置文件</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span> </span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="number">1</span></span><br><span class="line">server_id<span class="operator">=</span><span class="number">52</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line">[mysql] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">[client] </span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>创建mysql进程运行用户，初始化数据库</span><br><span class="line">useradd <span class="operator">-</span>M <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin mysql</span><br><span class="line">mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/data/mysql --datadir=/app/data/3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>拷贝mysql自带启停脚本，到系统管理服务脚本路径下</span><br><span class="line">cp <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">systemctl enable mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>启动mysql检查</span><br><span class="line">systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>检查GTID功能是否开启</span><br><span class="line">mysql <span class="operator">-</span>e &quot;show variables like &#x27;%gtid%&#x27;;&quot;</span><br></pre></td></tr></table></figure><h2 id="2-主库操作-1"><a href="#2-主库操作-1" class="headerlink" title="2.主库操作"></a>2.主库操作</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>修改root密码</span><br><span class="line">mysqladmin password <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>创建从库连接用户</span><br><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>,host  <span class="keyword">from</span>  mysql.user;</span><br></pre></td></tr></table></figure><h2 id="3-从库操作-1"><a href="#3-从库操作-1" class="headerlink" title="3.从库操作"></a>3.从库操作</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>配置主从复制参数</span><br><span class="line">#MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span> 该参数表示自动基于事务GTID进行复制，无需指定pos值与binlog文件名</span><br><span class="line">change master <span class="keyword">to</span> </span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">master_port<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>,</span><br><span class="line">master_connect_retry<span class="operator">=</span><span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>开启slave复制</span><br><span class="line"><span class="keyword">start</span> slave；</span><br></pre></td></tr></table></figure><h2 id="4-检查复制状态"><a href="#4-检查复制状态" class="headerlink" title="4.检查复制状态"></a>4.检查复制状态</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>检查slave复制状态</span><br><span class="line"><span class="keyword">show</span> slave status\G;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>检查slave线程</span><br><span class="line"><span class="keyword">show</span> processlist;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>检查master线程</span><br><span class="line"><span class="keyword">show</span> processlist;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>检查slave的relay截止点，与master的binlog截止点</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#cat <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>master.info </span><br><span class="line"><span class="number">25</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000003</span></span><br><span class="line"><span class="number">706</span></span><br><span class="line"><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">repl</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3306</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#cat <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span>relay<span class="operator">-</span>log.info </span><br><span class="line"><span class="number">7</span></span><br><span class="line">.<span class="operator">/</span>db<span class="number">-53</span><span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line"><span class="number">919</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000003</span></span><br><span class="line"><span class="number">706</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="5-检查主从复制"><a href="#5-检查主从复制" class="headerlink" title="5.检查主从复制"></a>5.检查主从复制</h2><blockquote><p>主库新增数据，从库检查复制结果</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>主库db<span class="number">-51</span>新增数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@server_id</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@server_id</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">51</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database <span class="keyword">new</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>从库db<span class="number">-52</span>，db<span class="number">-53</span>检查复制结果</span><br><span class="line">#db<span class="number">-51</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-53</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">#db<span class="number">-52</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure><blockquote><p>至此，基于GTID的一主两从的主从复制就搭建好了</p></blockquote><h1 id="八、主从复制原理及图解"><a href="#八、主从复制原理及图解" class="headerlink" title="八、主从复制原理及图解"></a>八、主从复制原理及图解</h1><p>MySQL的主从复制是一个异步的复制过程（虽然一般情况下感觉是实时的），数据将从一个MySQL数据库（我们称之为Master）复制到另一个MySQL数据库（我们称之为Slave），在Master与Slave之间实现整个主从复制的过程是由<code>三个线程</code>参与完成的。</p><p>其中有两个线程（SQL线程和IO线程）在Slave端，另外一个线程（binlog dump线程）在Master端（MySQL 5及以前是3个线程完成复制，从MySQL 6起SQL线程可以是多个）。</p><blockquote><p>要实现MySQL的主从复制功能，首先必须打开Master端的binlog日志功能。</p></blockquote><p>因为整个复制过程实际上就是Slave从Master端获取binlog日志，然后再在Slave上以相同的顺序执行获取的binlog日志中所记录的各种SQL操作，从而实现主从数据一致的功能。</p><p><a href="http://book.bikongge.com/sre/2024-linux/image-20220727202229527.png">http://book.bikongge.com/sre/2024-linux/image-20220727202229527.png</a></p><p><img src="/image-20240619180310136.png" alt="image-20240619180310136"></p><ul><li>slave机器<code>start slave</code>，开启主从复制</li><li>slave机器的I&#x2F;O线程会通过在master上已授权的复制用户，连接master服务器<ul><li>通过该用户再从指定的binlog日志文件的指定位置，发送binlog日志的内容</li><li>（binglog文件名，pos值，都通过change master命令指定了）</li></ul></li><li>Master服务器接收到slave的I&#x2F;O线程请求之后，负责复制的binlog dump线程会根据slave服务器的I&#x2F;O线程的请求信息，进行读取binlog，以及pos值之后的日志信息<ul><li>然后返回给slave的I&#x2F;O线程</li><li>返回的信息除了binlog日志内容以外，以及master服务端新的binlog文件，以及POS值</li></ul></li><li>slave此时的I&#x2F;O线程接收到master发来的日志信息后，将binlog日志内容，写入到slave本身的relay-log中继日志中，如mysql-relay-bin.xxxxxx的末端<ul><li>并且记录新的binlog文件信息，名字、pos值，写入master-info文件中，用于下一次读取binlog数据时，可以明确知道数据读取的起点</li></ul></li><li>slave服务器的SQL线程会实时监测本地的Relay Log新增的日志内容，然后将Reloy Log文件中的内容，解析为SQL语句，且在自身slave按顺序执行这些SQL。</li></ul><p>经过这些，就可以确保，master和slave执行了同样的SQL。</p><p>在<code>复制状态正常</code>的情况下，master和slave的数据是完全一样的。</p><h2 id="主从复制原理小结"><a href="#主从复制原理小结" class="headerlink" title="主从复制原理小结"></a>主从复制原理小结</h2><ul><li>主从复制是异步的进行SQL语句的复制</li><li>复制时，主库有一个<code>binlog dump 线程</code>，从库有2个线程<code>I/O线程</code>、<code>SQL线程</code></li><li>在MySQL5.6之后，slave的SQL线程有多个</li><li>实现主从复制的必要条件、主库开启binlog，基于binlog复制</li><li>用于复制的所有mysql节点，server-id不能相同</li><li>binlog文件只记录数据库有<code>更改</code>的SQL，（主数据库有变化），对<code>select、show</code>以及未修改数据库的语句不会记录</li></ul><h2 id="主从复制起到的作用"><a href="#主从复制起到的作用" class="headerlink" title="主从复制起到的作用"></a>主从复制起到的作用</h2><ul><li>数据二次备份，数据安全</li><li>降低主库压力，后端程序书写代码，进行请求的转发进行读写分离，主库读，从库写</li><li>可以基于主从复制架构，通过高可用技术MHA等，实现数据库高可用性，故障自动切换</li></ul><h2 id="从库不开binlog原因"><a href="#从库不开binlog原因" class="headerlink" title="从库不开binlog原因"></a>从库不开binlog原因</h2><p>主从同步时slave为啥不能开binlog            </p><p>在MySQL数据库的主从同步架构中，通常只在主服务器（master）上开启binlog（二进制日志），而在从服务器（slave）上则不开启binlog。这一设计选择背后有几个关键原因：</p><h3 id="1-性能和资源考虑"><a href="#1-性能和资源考虑" class="headerlink" title="1. 性能和资源考虑"></a>1. 性能和资源考虑</h3><ul><li><strong>减少资源消耗</strong>：开启binlog会消耗额外的CPU和磁盘I&#x2F;O资源，因为MySQL需要记录所有的数据变更操作到binlog文件中。在从服务器上，这些资源应该优先用于处理查询和复制主服务器上的数据变更，而不是记录自己的binlog。</li><li><strong>避免不必要的日志生成</strong>：从服务器的角色是接收并应用主服务器上的binlog变更，以保持数据的一致性。它不需要再生成自己的binlog，因为这会增加系统的复杂性和资源消耗。</li></ul><h3 id="2-数据一致性和复制流程"><a href="#2-数据一致性和复制流程" class="headerlink" title="2. 数据一致性和复制流程"></a>2. 数据一致性和复制流程</h3><ul><li><strong>保持数据一致性</strong>：主从同步的核心是确保从服务器上的数据与主服务器保持一致。这通过从服务器读取并应用主服务器上的binlog来实现。如果在从服务器上开启binlog，那么这些日志将包含从服务器应用主服务器binlog变更后的结果，而不是原始的数据变更。这可能会引入数据不一致的风险。</li><li><strong>简化复制流程</strong>：在主从同步的架构中，复制流程是单向的，即从主服务器到从服务器。开启从服务器的binlog会打破这一单向性，使得复制流程变得更加复杂和难以管理。</li></ul><h3 id="3-实际应用场景"><a href="#3-实际应用场景" class="headerlink" title="3. 实际应用场景"></a>3. 实际应用场景</h3><ul><li><strong>读写分离</strong>：在主从同步的架构中，通常会将读操作分散到多个从服务器上，以减轻主服务器的压力。这些从服务器只需要接收并应用主服务器上的数据变更，而不需要记录自己的binlog。</li><li><strong>数据备份和恢复</strong>：如果需要备份从服务器上的数据，可以通过定期的全量备份和从主服务器同步的binlog来实现增量备份。这样，即使从服务器上没有开启binlog，也可以保证数据的完整性和可恢复性。</li></ul><h3 id="4-结论"><a href="#4-结论" class="headerlink" title="4. 结论"></a>4. 结论</h3><p>综上所述，从服务器在MySQL的主从同步架构中通常不开启binlog，这是出于性能和资源考虑、数据一致性和复制流程简化的需要。在实际应用中，这种设计选择有助于确保主从同步的稳定性和可靠性。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;一、主从复制架构概述&quot;&gt;&lt;a href=&quot;#一、主从复制架构概述&quot; class=&quot;headerlink&quot; title=&quot;一、主从复制架构概述&quot;&gt;&lt;/a&gt;一、主从复制架构概述&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;主从复制，以1台master主库机器，多台slave从库机</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-恢复数据</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE/</id>
    <published>2024-08-20T00:55:22.000Z</published>
    <updated>2024-08-20T00:58:44.602Z</updated>
    
    <content type="html"><![CDATA[<h1 id="全量逻辑备份与增量恢复"><a href="#全量逻辑备份与增量恢复" class="headerlink" title="全量逻辑备份与增量恢复"></a>全量逻辑备份与增量恢复</h1><h2 id="1-数据准备"><a href="#1-数据准备" class="headerlink" title="1.数据准备"></a>1.数据准备</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#创建库表数据</span><br><span class="line"><span class="keyword">create</span> database stu charset utf8mb4;</span><br><span class="line">use stu;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog记录</span><br><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000001&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="/image-20240609150656146.png" alt="image-20240609150656146"></p><h2 id="2-全量备份"><a href="#2-全量备份" class="headerlink" title="2.全量备份"></a>2.全量备份</h2><h3 id="2-1备份参数详解"><a href="#2-1备份参数详解" class="headerlink" title="2.1备份参数详解"></a>2.1备份参数详解</h3><p><a href="https://blog.csdn.net/weixin_39974140/article/details/114286173">https://blog.csdn.net/weixin_39974140/article/details/114286173</a></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>–single-transaction</td><td>该选项在导出数据之前提交一个BEGIN SQL语句，BEGIN 不会阻塞任何应用程序且能保证导出时<br>数据库的一致性状态,它只适用于事务存储引擎仅InnoDB</td></tr><tr><td>–master-data</td><td>该选项将binlog的位置和文件名追加到输出文件中；如果为1，将会输出CHANGE MASTER命令；<br>如果为2，输出的CHANGE MASTER命令前添加注释信息。</td></tr><tr><td>–triggers</td><td>导出表关联的触发器,该选项默认启用，–skip-triggers禁用功能</td></tr><tr><td>–routines, -R</td><td>导出存储过程以及自定义函数</td></tr><tr><td>–flush-logs，-F</td><td>备份的同时进行切割binlog日志，生成新的binlog记录新增量事务</td></tr><tr><td>–events, -E</td><td>导出所有事务</td></tr><tr><td>–max_allowed_packet</td><td>数据包传输大小设置，优化功能</td></tr><tr><td>–set-gtid-purged&#x3D;OFF</td><td>导出事务时，每个事务的GTID不跟随导出；GTID在每个实例中是唯一的，若sql文件需要导入<br />其它实例中，就需要加上该参数，否则会报错无法导入</td></tr></tbody></table><h3 id="2-2定时任务写入"><a href="#2-2定时任务写入" class="headerlink" title="2.2定时任务写入"></a>2.2定时任务写入</h3><blockquote><p>每周一晚上00.00全量备份数据库数据，并且切割刷新binlog日志，用于记录增量数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建存放备份数据目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mkdir <span class="operator">/</span>mysql_data_backup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>编写全量备份脚本，绝对路径执行mysqldump命令，否则放入定时任务无法备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#vim <span class="operator">/</span>mysql_data_backup<span class="operator">/</span>full_backup_all_mysql.sh</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cat <span class="operator">/</span>mysql_data_backup<span class="operator">/</span>full_backup_all_mysql.sh </span><br><span class="line">#<span class="operator">!</span><span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line"><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>F <span class="operator">-</span>R <span class="operator">-</span>E <span class="operator">-</span>A  <span class="comment">--master-data=2 --single-transaction  --max_allowed_packet=64M |gzip &gt;/mysql_data_backup/full_backup_all_`date +%F`.sql.gz</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>检查脚本是否可以进行成功备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#bash full_backup_all_mysql.sh  <span class="operator">&amp;</span><span class="operator">&gt;</span> backup.log</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#ls</span><br><span class="line">backup.log  full_backup_all_2024<span class="number">-06</span><span class="number">-09.</span>sql.gz  full_backup_all_mysql.sh</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#zcat full_backup_all2024<span class="number">-06</span><span class="number">-09.</span>sql.gz </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>降低数据库备份目录权限</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#chmod <span class="operator">-</span>R <span class="number">600</span> <span class="operator">/</span>mysql_data_backup<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls  <span class="operator">/</span>mysql_data_backup  <span class="operator">/</span>mysql_data_backup<span class="comment">/* -ld</span></span><br><span class="line"><span class="comment">drw-------. 2 root root  38 Jun  9 17:13 /mysql_data_backup</span></span><br><span class="line"><span class="comment">-rw-------. 1 root root 160 Jun  9 17:07 /mysql_data_backup/full_backup_all_mysql.sh</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">5.编写定时任务</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#vim  /var/spool/cron/root </span></span><br><span class="line"><span class="comment">[root@db-51 ~]#cat  /var/spool/cron/root </span></span><br><span class="line"><span class="comment">#1.Time synchronization</span></span><br><span class="line"><span class="comment">* * * * *       /usr/sbin/ntpdate time1.aliyun.com &gt; /dev/null 2&gt;&amp;1</span></span><br><span class="line"><span class="comment">#2.Mysql all data full backup</span></span><br><span class="line"><span class="comment">00 00 * * 1     /usr/bin/bash  /mysql_data_backup/full_backup_all_mysql.sh &amp;&gt;/dev/null</span></span><br></pre></td></tr></table></figure><ul><li><strong>修改时间，模拟全量备份完成</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#修改时间</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#<span class="type">date</span> <span class="operator">-</span>s <span class="number">20240610</span></span><br><span class="line">Mon Jun <span class="number">10</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">2024</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#<span class="type">date</span></span><br><span class="line">Mon Jun <span class="number">10</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">11</span> CST <span class="number">2024</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#<span class="type">date</span> <span class="operator">+</span><span class="operator">%</span>w</span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line">#检查备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#ll</span><br><span class="line">total <span class="number">12</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  20 Jun 10 00:00 full_backup_all_2024-06-10.sql.gz</span></span><br><span class="line"><span class="operator">-</span>rw<span class="comment">-------. 1 root root 169 Jun  9 17:40 full_backup_all_mysql.sh</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#zcat full_backup_all_2024<span class="number">-06</span><span class="number">-10.</span>sql.gz </span><br></pre></td></tr></table></figure><h2 id="3-增量写入"><a href="#3-增量写入" class="headerlink" title="3.增量写入"></a>3.增量写入</h2><ul><li><strong>查看当前binlog日志，已经进行刷新</strong></li></ul><p><img src="/image-20240609185801391.png" alt="image-20240609185801391"></p><ul><li><strong>模拟第二天在新的binlog中记录增量写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#增量写入</span><br><span class="line">mysql<span class="operator">&gt;</span> use stu;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t2(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t2 <span class="keyword">values</span>(<span class="number">66</span>),(<span class="number">77</span>),(<span class="number">88</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240609190302473.png" alt="image-20240609190302473"></p><h2 id="4-模拟误删"><a href="#4-模拟误删" class="headerlink" title="4.模拟误删"></a>4.模拟误删</h2><ul><li><strong>模拟删除stu库</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database stu;</span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查不到数据了</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span>  stu;</span><br><span class="line">ERROR <span class="number">1049</span> (<span class="number">42000</span>): <span class="literal">Unknown</span> database <span class="string">&#x27;stu&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240609190417594.png" alt="image-20240609190417594"></p><h2 id="5-恢复数据"><a href="#5-恢复数据" class="headerlink" title="5.恢复数据"></a>5.恢复数据</h2><blockquote><blockquote><p>当前发现stu库被删除，但是目前binlog中只记录了，针对stu库写入的增量数据，只能恢复部分数据</p><p>可以与全量备份结合恢复，全量备份数据后，再次对事务的提交称之为增量备份，全量+增量即可恢复全部</p></blockquote><p>&#x3D;&#x3D;恢复思路：&#x3D;&#x3D;</p><p>&#x3D;&#x3D;1.&#x3D;&#x3D;关闭binlog记录</p><p>&#x3D;&#x3D;2.&#x3D;&#x3D;使用全量备份的数据进行恢复，可以恢复重置增量前的所有数据</p><p>&#x3D;&#x3D;3.&#x3D;&#x3D;再通过增量的事务GTID，截取删除事务相关的所有增量写入</p><p>&#x3D;&#x3D;4.&#x3D;&#x3D;开启binlog记录</p></blockquote><h3 id="5-1临时关闭binlog"><a href="#5-1临时关闭binlog" class="headerlink" title="5.1临时关闭binlog"></a>5.1临时关闭binlog</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set sql_log_bin=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select @@sql_log_bin;</span><br><span class="line">+---------------+</span><br><span class="line">| @@sql_log_bin |</span><br><span class="line">+---------------+</span><br><span class="line">|             0 |</span><br><span class="line">+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="5-2全量数据恢复"><a href="#5-2全量数据恢复" class="headerlink" title="5.2全量数据恢复"></a>5.2全量数据恢复</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>备份数据如下</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#ll</span><br><span class="line">total <span class="number">212</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 211310 Jun 10 00:00 full_backup_all_2024-06-10.sql.gz</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>解压缩</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#gzip <span class="operator">-</span>d full_backup_all_2024<span class="number">-06</span><span class="number">-10.</span>sql.gz </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#ll</span><br><span class="line">total <span class="number">772</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 782412 Jun 10 00:00 full_backup_all_2024-06-10.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>导入数据库恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>mysql_data_backup<span class="operator">/</span>full_backup_all_2024<span class="number">-06</span><span class="number">-10.</span><span class="keyword">sql</span></span><br></pre></td></tr></table></figure><h3 id="5-3增量日志截取恢复"><a href="#5-3增量日志截取恢复" class="headerlink" title="5.3增量日志截取恢复"></a>5.3增量日志截取恢复</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#截取增量binlog日志</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>mysql_data_backup]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;f695ab86-2303-11ef-bf61-000c2939adaa:4-5&#x27; mysql-bin.000002 &gt; /root/increase.sql</span></span><br><span class="line"></span><br><span class="line">#导出的日志检查是否是要恢复的数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#cat <span class="operator">/</span>root<span class="operator">/</span>increase.sql </span><br></pre></td></tr></table></figure><p><img src="/image-20240609193724194.png" alt="image-20240609193724194"></p><ul><li><strong>导出的增量数据日志文件，导入到数据库中进行恢复</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll</span><br><span class="line">total <span class="number">4</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 2061 Jun 10 01:02 increase.sql</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>increase.sql</span><br></pre></td></tr></table></figure><h3 id="5-4检查数据恢复"><a href="#5-4检查数据恢复" class="headerlink" title="5.4检查数据恢复"></a>5.4检查数据恢复</h3><blockquote><p>恢复数据成功</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">66</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">88</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="5-5开启binlog记录"><a href="#5-5开启binlog记录" class="headerlink" title="5.5开启binlog记录"></a>5.5开启binlog记录</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@sql_log_bin</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@sql_log_bin</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span>             <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="xtra全量物理备份与恢复"><a href="#xtra全量物理备份与恢复" class="headerlink" title="xtra全量物理备份与恢复"></a>xtra全量物理备份与恢复</h1><blockquote><p>逻辑备份在数据较大的情况下备份速度较慢，而物理备份主要用于数据较大的场景进行备份</p><p>原理上就是对实例数据目录下方的数据文件进行备份；拷贝文件压缩，恢复时将数据文件导入实例数据目录下即可</p><p>通过xtrabackup这个备份工具实现全量物理备份</p></blockquote><h2 id="1-xtrabackup概述"><a href="#1-xtrabackup概述" class="headerlink" title="1.xtrabackup概述"></a>1.xtrabackup概述</h2><p>Percona-xtrabackup是 Percona公司开发的一个用于MySQL数据库物理热备的备份工具，支持MySQL、Percona server和MariaDB，开源免费，是目前较为受欢迎的主流备份工具。</p><p>&#x3D;&#x3D;xtrabackup只能备份innoDB和xtraDB两种数据引擎的表，而不能备份MyISAM数据表。&#x3D;&#x3D;</p><ul><li><strong>xtrabackup特点：</strong><ul><li>物理备份工具，拷贝数据文件</li><li>备份和恢复数据的速度非常快，安全可靠</li><li>在备份期间执行的事务不会间断，备份<code>innodb</code>数据不影响业务</li><li>备份期间不增加太多数据库的性能压力</li><li>支持对备份的数据自动校验</li><li>运行全量，增量，压缩备份及流备份</li><li>支持在线迁移表以及快速创建新的从库</li><li>运行几乎所有版本的<code>mysql</code>和<code>maridb</code></li></ul></li></ul><h3 id="1-1安装工具"><a href="#1-1安装工具" class="headerlink" title="1.1安装工具"></a>1.1安装工具</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#安装程序运行环境（perl语言解释器，连接mysql的驱动等）</span><br><span class="line">yum install perl perl<span class="operator">-</span>devel libaio libaio<span class="operator">-</span>devel perl<span class="operator">-</span><span class="type">Time</span><span class="operator">-</span>HiRes perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL <span class="operator">-</span>y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下载xtrabackup<span class="operator">-</span>rpm包</span><br><span class="line">wget https:<span class="operator">/</span><span class="operator">/</span>www.percona.com<span class="operator">/</span>downloads<span class="operator">/</span>XtraBackup<span class="operator">/</span>Percona<span class="operator">-</span>XtraBackup<span class="number">-2.4</span><span class="number">.9</span><span class="operator">/</span><span class="type">binary</span><span class="operator">/</span>redhat<span class="operator">/</span><span class="number">7</span><span class="operator">/</span>x86_64<span class="operator">/</span>percona<span class="operator">-</span>xtrabackup<span class="number">-24</span><span class="number">-2.4</span><span class="number">.9</span><span class="number">-1.</span>el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#安装xtrabackup</span><br><span class="line">yum localinstall percona<span class="operator">-</span>xtrabackup<span class="number">-24</span><span class="number">-2.4</span><span class="number">.9</span><span class="number">-1.</span>el7.x86_64.rpm <span class="operator">-</span>y</span><br></pre></td></tr></table></figure><h3 id="1-2命令参数"><a href="#1-2命令参数" class="headerlink" title="1.2命令参数"></a>1.2命令参数</h3><p><strong>Xtrabackup中主要包含两个命令工具：</strong></p><p> &#x3D;&#x3D;1.xtrabackup：&#x3D;&#x3D;</p><p> Xtrabackup命令是专门用于对InnoDB和XtraDB等事务引擎的数据库热备份的工具，不能用于备份MyISAM等其他类型的引擎数据，</p><p> 其主要特点是备份数据时完全不用锁表。</p><p> &#x3D;&#x3D;2.innobackupex（DBA用的最多的是Innobackupex命令备份恢复）：&#x3D;&#x3D;</p><p> Innobackupex命令是将上述Xtrabackup命令使用perl脚本进行二次封装的工具，除了可以用于InnoDB和XtraDB等引擎之外，</p><p> 还可以备份MyISAM及多种引擎混合使用的场景，主要特点是备份事务引擎数据而不用锁表，可以备份非事务引擎数据，但要锁表。</p><p>&#x3D;&#x3D;常用参数：&#x3D;&#x3D;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>备份所用参数</span><br><span class="line"><span class="comment">--host     指定主机</span></span><br><span class="line"><span class="comment">--user     指定用户名</span></span><br><span class="line"><span class="comment">--password    指定密码</span></span><br><span class="line"><span class="comment">--port     指定端口</span></span><br><span class="line"><span class="comment">--databases     指定数据库</span></span><br><span class="line"><span class="comment">--incremental    创建增量备份</span></span><br><span class="line"><span class="comment">--incremental-basedir   指定包含完全备份的目录</span></span><br><span class="line"><span class="comment">--incremental-dir      指定包含增量备份的目录   </span></span><br><span class="line"><span class="comment">--apply-log        对备份进行预处理操作   </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="number">2.</span>恢复所用参数</span><br><span class="line"><span class="comment">--redo-only      回滚未提交事务</span></span><br><span class="line">#参数详解</span><br><span class="line">#https:<span class="operator">/</span><span class="operator">/</span>blog<span class="number">.51</span>cto.com<span class="operator">/</span>u_15080021<span class="operator">/</span><span class="number">2642159</span></span><br><span class="line">#<span class="operator">-</span> 备份完成后数据尚且不能用于恢复操作</span><br><span class="line">#<span class="operator">-</span> 因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务</span><br><span class="line">#<span class="operator">-</span> 因此此时数据文件仍处理不一致状态</span><br><span class="line">#<span class="operator">-</span> 该参数作用是通过回滚未提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--copy-back      恢复备份目录</span></span><br><span class="line"><span class="comment">--use-memory=32M        使用32M内存进行恢复，对内存限制，防止占用过多机器资源</span></span><br></pre></td></tr></table></figure><p>- </p><p><img src="/image-20240609202957221.png" alt="image-20240609202957221"></p><h2 id="2-全量备份与恢复"><a href="#2-全量备份与恢复" class="headerlink" title="2.全量备份与恢复"></a>2.全量备份与恢复</h2><h3 id="2-1全量备份数据"><a href="#2-1全量备份数据" class="headerlink" title="2.1全量备份数据"></a>2.1全量备份数据</h3><blockquote><p>语法：<br>innobackupex  连接实例参数    备份数据存放目录（若不存在自动创建，并创建时间戳子目录）</p></blockquote><ul><li>1.保证GTID模式开启</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span>  <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%GTID%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>备份数据库实例所有数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#备份数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--user=root  --password=1  -S /tmp/mysql.sock  /xtrabackup_data/ </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#自动以时间戳创建存放数据的目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>xtrabackup_data<span class="operator">/</span></span><br><span class="line"><span class="number">2024</span><span class="number">-06</span><span class="number">-10</span>_02<span class="number">-33</span><span class="number">-45</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#除了备份的数据外还生成了许多备份相关文件</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>xtrabackup_data<span class="operator">/</span><span class="number">2024</span><span class="number">-06</span><span class="number">-10</span>_02<span class="number">-33</span><span class="number">-45</span><span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">13644</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      425 Jun 10 02:33 backup-my.cnf</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      474 Jun 10 02:33 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 12582912 Jun 10 02:33 ibdata1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     4096 Jun 10 02:33 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 02:33 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root       76 Jun 10 02:33 stu</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 02:33 sys</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root       62 Jun 10 02:33 xtrabackup_binlog_info</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      113 Jun 10 02:33 xtrabackup_checkpoints</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      560 Jun 10 02:33 xtrabackup_info</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root  1338880 Jun 10 02:33 xtrabackup_logfile</span></span><br></pre></td></tr></table></figure><h3 id="2-2备份生成的文件"><a href="#2-2备份生成的文件" class="headerlink" title="2.2备份生成的文件"></a>2.2备份生成的文件</h3><table><thead><tr><th>生成的文件</th><th>说明</th></tr></thead><tbody><tr><td>xtrabackup_checkpoints文件</td><td>备份的类型全量备份还是增量备份，lns号记录数据不一致时分析</td></tr><tr><td>xtrabackup_info文件</td><td>备份的具体详细信息，时间、版本、命令、binlog截止点等</td></tr><tr><td>xtrabackup_binlog_info文件</td><td>备份的最后一个事务的binlog信息与位置</td></tr><tr><td>backup-my.cnf文件</td><td>备份时根据该配置文件进行相应的备份动作</td></tr><tr><td>xtrabackup_logfile</td><td>备份数据过程的日志信息，加密的二进制文件</td></tr></tbody></table><h3 id="2-3自定义备份数据存放目录"><a href="#2-3自定义备份数据存放目录" class="headerlink" title="2.3自定义备份数据存放目录"></a>2.3自定义备份数据存放目录</h3><p>&#x3D;&#x3D;备份数据后，默认会生成一个时间戳目录存放备份的数据&#x3D;&#x3D;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db-51 /xtrabackup_data/2024-06-10_02-33-45]#ls /xtrabackup_data/</span><br><span class="line">2024-06-10_02-33-45</span><br></pre></td></tr></table></figure><p>&#x3D;&#x3D;指定备份数据存放的目录，不生成时间戳命名的目录&#x3D;&#x3D;</p><blockquote><p>语法：</p><p>innobackupex  –no-timestamp（关闭时间戳）   连接实例参数     自定义备份路径</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#备份参数</span><br><span class="line">innobackupex <span class="comment">--no-timestamp --user=root --password=1 -S /tmp/mysql.sock /xtrabackup_data/full_backup_`date +%F_%T`/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看备份数据存放目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 234 Jun 10 10:45 full_backup_2024-06-10_10:45:36</span></span><br></pre></td></tr></table></figure><h3 id="2-4全量恢复数据"><a href="#2-4全量恢复数据" class="headerlink" title="2.4全量恢复数据"></a>2.4全量恢复数据</h3><p><strong>模拟删除数据</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span></span><br><span class="line">auto.cnf   ib_buffer_pool  ib_logfile0  ibtmp1  mysql               stu</span><br><span class="line">db<span class="number">-51.</span>pid  ibdata1         ib_logfile1  logs    performance_schema  sys</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mkdir <span class="operator">/</span>tmp<span class="operator">/</span><span class="number">3306</span>_data</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mv <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="comment">/*  /tmp/3306_data/</span></span><br></pre></td></tr></table></figure><p><strong>全量恢复数据</strong></p><ul><li>确保备份数据一致性，回滚未提交事务的一条命令</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innobackupex <span class="comment">--apply-log  /xtrabackup_data/full_backup_2024-06-10_10\:45\:36/</span></span><br></pre></td></tr></table></figure><ul><li>进行恢复</li></ul><blockquote><p>语法：</p><p>&#x3D;&#x3D;innobackupex&#x3D;&#x3D; &#x3D;&#x3D;–defaults-file&#x3D;&#x2F;etc&#x2F;my.conf&#x3D;&#x3D;(会调用配置文件中数据目录路径进行恢复)  &#x3D;&#x3D;–copy-back&#x3D;&#x3D;</p><p>&#x3D;&#x3D;–rsync&#x3D;&#x3D;（内置了rsync工具，进行拷贝数据）       &#x3D;&#x3D;备份数据的路径&#x3D;&#x3D;</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#恢复数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--defaults-file=/etc/my.cnf --copy-back --rsync /xtrabackup_data/full_backup_2024-06-10_10\:45\:36/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#恢复后数据授权mysql用户，否则无法调用某些数据进行启动</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span></span><br><span class="line">total <span class="number">122920</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      474 Jun 10 11:32 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 Jun 10 11:32 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun 10 11:32 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun 10 11:32 ib_logfile1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 Jun 10 11:32 ibtmp1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 Jun 10 11:32 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun 10 11:32 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql       76 Jun 10 11:32 stu</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun 10 11:32 sys</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql       21 Jun 10 11:32 xtrabackup_binlog_pos_innodb</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      607 Jun 10 11:32 xtrabackup_info</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重启检查端口</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl restart  mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">80</span>     [::]:<span class="number">3306</span>               [::]:<span class="operator">*</span>                   users:((&quot;mysqld&quot;,pid<span class="operator">=</span><span class="number">9329</span>,fd<span class="operator">=</span><span class="number">32</span>))</span><br></pre></td></tr></table></figure><h3 id="2-5检查数据恢复"><a href="#2-5检查数据恢复" class="headerlink" title="2.5检查数据恢复"></a>2.5检查数据恢复</h3><blockquote><p>数据恢复成功</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">66</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">88</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="xtra全量增量备份与恢复"><a href="#xtra全量增量备份与恢复" class="headerlink" title="xtra全量增量备份与恢复"></a>xtra全量增量备份与恢复</h1><blockquote><p>全量备份是对全部的数据进行备份，如果放入定时任务每天使用全量备份，会导致占用大量服务器资源磁盘空间</p><p>增量备份是对全量备份后，新生成的数据进行一个备份，最后可以将增量备份的数据合并到全量备份中，就是一个完整的数据</p></blockquote><h2 id="1-全量与增量备份数据"><a href="#1-全量与增量备份数据" class="headerlink" title="1.全量与增量备份数据"></a>1.全量与增量备份数据</h2><h3 id="1-1备份前数据准备"><a href="#1-1备份前数据准备" class="headerlink" title="1.1备份前数据准备"></a>1.1备份前数据准备</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stu                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">66</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">88</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="1-2第一天全量备份"><a href="#1-2第一天全量备份" class="headerlink" title="1.2第一天全量备份"></a>1.2第一天全量备份</h3><blockquote><p>增量备份前，必须得有一个全量备份的数据，才可以进行增量备份</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#全量备份命令</span><br><span class="line">innobackupex <span class="comment">--no-timestamp  --user=root -S /tmp/mysql.sock --password=1 /xtrabackup_data/full_1_`date +%F</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#存放全量数据的目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span></span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 234 Jun 10 15:57 full_1_2024-06-10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#备份的数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>full_1_2024<span class="number">-06</span><span class="number">-10</span><span class="operator">/</span></span><br><span class="line">total <span class="number">12340</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      425 Jun 10 15:57 backup-my.cnf</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      834 Jun 10 15:57 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 12582912 Jun 10 15:57 ibdata1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     4096 Jun 10 15:57 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 15:57 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root       76 Jun 10 15:57 stu</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 15:57 sys</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root       62 Jun 10 15:57 xtrabackup_binlog_info</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      113 Jun 10 15:57 xtrabackup_checkpoints</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      592 Jun 10 15:57 xtrabackup_info</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root     2560 Jun 10 15:57 xtrabackup_logfile</span></span><br></pre></td></tr></table></figure><h3 id="1-3第二天增量备份"><a href="#1-3第二天增量备份" class="headerlink" title="1.3第二天增量备份"></a>1.3第二天增量备份</h3><ul><li><strong>模拟全量备份后第二天新数据写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> stu.t1 <span class="keyword">values</span>(<span class="number">4</span>),(<span class="number">5</span>),(<span class="number">6</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240610160237672.png" alt="image-20240610160237672"></p><ul><li><strong>增量备份新数据</strong></li></ul><blockquote><p>语法：</p><p>&#x3D;&#x3D;innobackupex&#x3D;&#x3D; &#x3D;&#x3D;–defaults-file&#x3D;&#x3D;&#x3D;（实例配置文件）  &#x3D;&#x3D;连接实例参数&#x3D;&#x3D; &#x3D;&#x3D;–no-timestamp&#x3D;&#x3D;（取消生成时间戳目录）</p><p>&#x3D;&#x3D;–increamental-basedor&#x3D;&#x3D;&#x3D;（指定上一次备份的数据） &#x3D;&#x3D;–incaremental&#x3D;&#x3D;（增量备份功能）&#x3D;&#x3D;备份存放的路径&#x3D;&#x3D;</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#增量数据备份命令</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--defaults-file=/etc/my.cnf --user=root --password=1 --socket=/tmp/mysql.sock --no-timestamp --incremental-basedir=/xtrabackup_data/full_1_2024-06-10/   --incremental  /xtrabackup_data/inc1_`date +%F`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数据存放目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>inc1_2024<span class="number">-06</span><span class="number">-10</span><span class="operator">/</span> <span class="operator">-</span>d</span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:16 /xtrabackup_data/inc1_2024-06-11</span></span><br></pre></td></tr></table></figure><h3 id="1-4第三天增量备份"><a href="#1-4第三天增量备份" class="headerlink" title="1.4第三天增量备份"></a>1.4第三天增量备份</h3><ul><li><strong>模拟第二天增量备份后，第三天新数据写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t3(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t3 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t3;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p><img src="/image-20240610162155986.png" alt="image-20240610162155986"></p><ul><li><strong>增量数据备份</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注意<span class="comment">--incremental-basedir=上一次的备份数据目录，也就是第一次增量备份数据目录</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--defaults-file=/etc/my.cnf --user=root --password=1 --socket=/tmp/mysql.sock --no-timestamp --incremental-basedir=/xtrabackup_data/inc1_2024-06-10/   --incremental  /xtrabackup_data/inc2_`date +%F`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第二次备份的数据存放目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll  <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>inc2_2024<span class="number">-06</span><span class="number">-10</span><span class="operator">/</span> <span class="operator">-</span>d</span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:23 /xtrabackup_data/inc2_2024-06-12/</span></span><br></pre></td></tr></table></figure><h3 id="1-5第四天增量备份"><a href="#1-5第四天增量备份" class="headerlink" title="1.5第四天增量备份"></a>1.5第四天增量备份</h3><ul><li><strong>模拟上次增量备份后，第四天写入的新数据</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t4(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t4 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu.t4;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>第四天0.00再次增量备份</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--defaults-file=/etc/my.cnf --user=root --password=1 --socket=/tmp/mysql.sock --no-timestamp --incremental-basedir=/xtrabackup_data/inc2_2024-06-10/   --incremental  /xtrabackup_data/inc3_`date +%F`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>inc3_2024<span class="number">-06</span><span class="number">-10</span> <span class="operator">-</span>d</span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:29 /xtrabackup_data/inc3_2024-06-13</span></span><br></pre></td></tr></table></figure><h3 id="1-6第五天还未备份误删除数据"><a href="#1-6第五天还未备份误删除数据" class="headerlink" title="1.6第五天还未备份误删除数据"></a>1.6第五天还未备份误删除数据</h3><ul><li><strong>模拟第四天00.00增量备份后，第五天新数据写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#创建的新库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database no_backup;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> no_backup          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stu                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#新表</span><br><span class="line">mysql<span class="operator">&gt;</span> use no_backup;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> no_backup_of_delete(id <span class="type">int</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">#新数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> no_backup_of_delete <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">#数据查看</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> no_backup_of_delete;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>模拟还未开始第五日00.00的增量备份，数据被误删除了</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl stop mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mkdir <span class="operator">/</span>tmp<span class="operator">/</span><span class="number">3306</span>_data</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mv <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="comment">/* /tmp/3306_data/</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#ll /app/data/3306/</span></span><br><span class="line"><span class="comment">total 0</span></span><br></pre></td></tr></table></figure><h2 id="2-全量增量备份结合binlog恢复"><a href="#2-全量增量备份结合binlog恢复" class="headerlink" title="2.全量增量备份结合binlog恢复"></a>2.全量增量备份结合binlog恢复</h2><blockquote><p>查看当前已备份的数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>xtrabackup_data<span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 234 Jun 10 15:57 full_1_2024-06-10</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:16 inc1_2024-06-11</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:23 inc2_2024-06-12</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 260 Jun 10 16:29 inc3_2024-06-13</span></span><br></pre></td></tr></table></figure><h3 id="1-全量数据一致性处理"><a href="#1-全量数据一致性处理" class="headerlink" title="1.全量数据一致性处理"></a>1.全量数据一致性处理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innobackupex <span class="comment">--apply-log   --redo-only /xtrabackup_data/full_1_2024-06-10/</span></span><br></pre></td></tr></table></figure><h3 id="2-合并inc-1到full"><a href="#2-合并inc-1到full" class="headerlink" title="2.合并inc_1到full"></a>2.合并inc_1到full</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>xtrabackup_data<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--apply-log   --redo-only --incremental-dir=inc1_2024-06-11  full_1_2024-06-10/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">合并完毕后，检查结果</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#grep <span class="string">&#x27;to_lsn&#x27;&#x27;full_1_2024-06-10/xtrabackup_checkpoints&#x27;</span></span><br><span class="line">to_lsn <span class="operator">=</span> <span class="number">5466750</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#grep <span class="string">&#x27;to_lsn&#x27;</span> <span class="string">&#x27;inc1_2024-06-11/xtrabackup_checkpoints&#x27;</span></span><br><span class="line">to_lsn <span class="operator">=</span> <span class="number">5466750</span></span><br></pre></td></tr></table></figure><h3 id="3-合并inc-2到full"><a href="#3-合并inc-2到full" class="headerlink" title="3.合并inc_2到full"></a>3.合并inc_2到full</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--apply-log   --redo-only --incremental-dir=inc2_2024-06-12  full_1_2024-06-10/</span></span><br></pre></td></tr></table></figure><h3 id="4-合并inc-3到full"><a href="#4-合并inc-3到full" class="headerlink" title="4.合并inc_3到full"></a>4.合并inc_3到full</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--apply-log   --redo-only --incremental-dir=inc3_2024-06-13  full_1_2024-06-10/</span></span><br></pre></td></tr></table></figure><h3 id="5-最终数据一致性校验检查"><a href="#5-最终数据一致性校验检查" class="headerlink" title="5.最终数据一致性校验检查"></a>5.最终数据一致性校验检查</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--apply-log    full_1_2024-06-10/</span></span><br></pre></td></tr></table></figure><p>整个流程，都得看到结尾的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InnoDB: Starting shutdown...</span><br><span class="line">InnoDB: Shutdown completed; log sequence number <span class="number">5479479</span></span><br><span class="line"><span class="number">240610</span> <span class="number">17</span>:<span class="number">41</span>:<span class="number">13</span> completed OK<span class="operator">!</span></span><br></pre></td></tr></table></figure><h3 id="6-全量增量备份数据恢复"><a href="#6-全量增量备份数据恢复" class="headerlink" title="6.全量增量备份数据恢复"></a>6.全量增量备份数据恢复</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#恢复数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#innobackupex <span class="comment">--copy-back full_1_2024-06-10/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data]#ls <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">122920</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      834 Jun 10 17:43 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 12582912 Jun 10 17:43 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 50331648 Jun 10 17:43 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 50331648 Jun 10 17:43 ib_logfile1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root 12582912 Jun 10 17:43 ibtmp1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     4096 Jun 10 17:43 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 17:43 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root      132 Jun 10 17:43 stu</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 root root     8192 Jun 10 17:43 sys</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root       22 Jun 10 17:43 xtrabackup_binlog_pos_innodb</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 root root      743 Jun 10 17:43 xtrabackup_info</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数据目录授权</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="comment">/*</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#ll /app/data/3306/</span></span><br><span class="line"><span class="comment">total 122920</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql      834 Jun 10 17:43 ib_buffer_pool</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql 12582912 Jun 10 17:43 ibdata1</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql 50331648 Jun 10 17:43 ib_logfile0</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql 50331648 Jun 10 17:43 ib_logfile1</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql 12582912 Jun 10 17:43 ibtmp1</span></span><br><span class="line"><span class="comment">drwxr-x---. 2 mysql mysql     4096 Jun 10 17:43 mysql</span></span><br><span class="line"><span class="comment">drwxr-x---. 2 mysql mysql     8192 Jun 10 17:43 performance_schema</span></span><br><span class="line"><span class="comment">drwxr-x---. 2 mysql mysql      132 Jun 10 17:43 stu</span></span><br><span class="line"><span class="comment">drwxr-x---. 2 mysql mysql     8192 Jun 10 17:43 sys</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql       22 Jun 10 17:43 xtrabackup_binlog_pos_innodb</span></span><br><span class="line"><span class="comment">-rw-r-----. 1 mysql mysql      743 Jun 10 17:43 xtrabackup_info</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line"><span class="comment">[[root@db-51 ~]#systemctl restart mysqld</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#ss -tunlp|grep 3306</span></span><br><span class="line"><span class="comment">tcp    LISTEN     0      80     [::]:3306               [::]:*                   users:((&quot;mysqld&quot;,pid=10353,fd=31))</span></span><br></pre></td></tr></table></figure><h3 id="7-检查备份数据的恢复"><a href="#7-检查备份数据的恢复" class="headerlink" title="7.检查备份数据的恢复"></a>7.检查备份数据的恢复</h3><blockquote><p>目前只还原了全量+inc_1 + inc_2 + inc_3 的数据，第五天新增的no_backup库与数据并没有恢复</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> stu                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="8-binlog恢复未备份数据"><a href="#8-binlog恢复未备份数据" class="headerlink" title="8.binlog恢复未备份数据"></a>8.binlog恢复未备份数据</h3><blockquote><p>前提是，你在删库前的binlog还存在，如果说binlog和数据目录在一起，都被删除的话，binlog丢失了，也无法恢复数据了！！！</p></blockquote><ul><li>查找最后增量备份数据的binlog截止点</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>xtrabackup_data<span class="operator">/</span>inc3_2024<span class="number">-06</span><span class="number">-10</span>]#cat xtrabackup_binlog_info </span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000003</span><span class="number">1294</span><span class="number">253</span>b757e<span class="number">-26</span>db<span class="number">-11</span>ef<span class="operator">-</span>a5a9<span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-5</span>,</span><br><span class="line">f695ab86<span class="number">-2303</span><span class="number">-11</span>ef<span class="operator">-</span>bf61<span class="number">-000</span>c2939adaa:<span class="number">1</span><span class="number">-6</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240610180336201.png" alt="image-20240610180336201"></p><ul><li>提取binlog中未备份的事务gtid，通过gitd区间截取事务日志</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#进入binlog日志存放目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#截取未备份的所有事务日志</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;253b757e-26db-11ef-a5a9-000c2939adaa:6-8&#x27; mysql-bin.000004 &gt; /root/increase.sql</span></span><br></pre></td></tr></table></figure><ul><li>sql文件导入数据库进行恢复</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; source /root/increase.sql</span><br></pre></td></tr></table></figure><ul><li>检查数据恢复情况，成功恢复</li></ul><p><img src="/image-20240610182130770.png" alt="image-20240610182130770"></p><h3 id="9-清空binlog再次全量备份"><a href="#9-清空binlog再次全量备份" class="headerlink" title="9.清空binlog再次全量备份"></a>9.清空binlog再次全量备份</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 清空所有日志</span><br><span class="line">mysql<span class="operator">&gt;</span> reset master;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>立即全量备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#innobackupex <span class="comment">--no-timestamp  --user=root -S /tmp/mysql.sock  --password=1  /xtrabackup_data/full_all_bak_`date +%F`</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>xtrabackup_data<span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">4</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root 4096 Jun 10 17:41 full_1_2024-06-10</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 7 root root  251 Jun 10 18:25 full_all_bak_2024-06-14</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root  260 Jun 10 17:36 inc1_2024-06-11</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root  260 Jun 10 17:39 inc2_2024-06-12</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 6 root root  260 Jun 10 17:39 inc3_2024-06-13</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;全量逻辑备份与增量恢复&quot;&gt;&lt;a href=&quot;#全量逻辑备份与增量恢复&quot; class=&quot;headerlink&quot; title=&quot;全量逻辑备份与增量恢复&quot;&gt;&lt;/a&gt;全量逻辑备份与增量恢复&lt;/h1&gt;&lt;h2 id=&quot;1-数据准备&quot;&gt;&lt;a href=&quot;#1-数据准备&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数据库MYSQL-备份数据</title>
    <link href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE/"/>
    <id>http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE/</id>
    <published>2024-08-20T00:51:40.000Z</published>
    <updated>2024-08-20T00:54:23.080Z</updated>
    
    <content type="html"><![CDATA[<h1 id="数据库数据备份恢复概述"><a href="#数据库数据备份恢复概述" class="headerlink" title="数据库数据备份恢复概述"></a>数据库数据备份恢复概述</h1><p>一个互联网业务，最核心的就是数据。数据库中更是存放着用户相关的数据，更加重要。</p><p>数据丢失后会造成极大的损失，所以为了避免数据丢失，就需要对数据库中数据进行备份。</p><h2 id="1-运维职责"><a href="#1-运维职责" class="headerlink" title="1.运维职责"></a>1.运维职责</h2><ul><li>备份恢复策略   （备份周期，备份工具，备份方式，数据恢复方式）</li><li>备份检查       （事务binglog日志备份，数据备份，是否备份成功）</li><li>定期恢复数据演练 （备份数据是否有问题）</li><li>数据丢失恢复     （利用现有资源，快速恢复数据）</li><li>数据迁移数据库升级</li></ul><h2 id="2-备份方案"><a href="#2-备份方案" class="headerlink" title="2.备份方案"></a>2.备份方案</h2><p><img src="/image-20240604164320125.png" alt="image-20240604164320125"></p><p><strong>逻辑备份</strong></p><p>用于备份小量数据，备份原理是将数据库中所有东西，转化为sql语句导入文件，进行备份。恢复数据时可通过sql语句进行，建库建表插入数据等动作达到恢复数据的效果。</p><p>常用工具：<em>mysqldump</em> （<em>mysql</em>内置的一个程序）</p><p><strong>物理备份</strong></p><p><a href="https://www.percona.com/software/mysql-database/percona-xtrabackup">https://www.percona.com/software/mysql-database/percona-xtrabackup</a></p><p><strong>如何选择</strong></p><p>100G数据以下，逻辑备份没问题，服务器配置要求高</p><p>100G数据以上，建议物理备份</p><h1 id="mysqldump备份恢复"><a href="#mysqldump备份恢复" class="headerlink" title="mysqldump备份恢复"></a><em>mysqldump</em>备份恢复</h1><h2 id="0-连接参数"><a href="#0-连接参数" class="headerlink" title="0.连接参数"></a>0.连接参数</h2><blockquote><p>-u 用户名<br>-p 用户密码<br>-S 本地socket文件<br>-h 指定主机地址<br>-P 指定端口</p></blockquote><h2 id="1-全量与恢复"><a href="#1-全量与恢复" class="headerlink" title="1.全量与恢复"></a>1.全量与恢复</h2><blockquote><p>语法： </p><p><em>mysqldump</em>  连接数据库参数  -all–databases&#x2F;A       &gt;    数据导入文件</p></blockquote><ul><li>备份数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>A <span class="operator">&gt;</span> all_mysql.sql</span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure><ul><li>清空数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#先关闭数据库程序否则直接清空会导致一些报错</span><br><span class="line">systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#清空数据库<span class="number">3306</span>实例的所有数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#rm <span class="operator">-</span>rf <span class="operator">*</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#ll</span><br><span class="line">total <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重新初始化<span class="number">3306</span>实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/tools/mysql  --datadir=/app/data/3306</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">total <span class="number">110628</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql       56 Jun  4 17:28 auto.cnf</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      419 Jun  4 17:28 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 Jun  4 17:28 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun  4 17:28 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun  4 17:28 ib_logfile1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 Jun  4 17:28 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun  4 17:28 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun  4 17:28 sys</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动检查端口</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br></pre></td></tr></table></figure><ul><li>恢复数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">sql</span>文件导入</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">&lt;</span> all_3306_bak.sql </span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student.stu limit <span class="number">5</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+--------+---------+---------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> age <span class="operator">|</span> gender <span class="operator">|</span> address <span class="operator">|</span> intime              <span class="operator">|</span> phone <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+--------+---------+---------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 赵东兴    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">12</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 黄牛      <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">43</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 叶金阳    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">27</span>:<span class="number">21</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> 杨松麟    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">27</span>:<span class="number">22</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> 陈亮亮    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">27</span>:<span class="number">23</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+--------+---------+---------------------+-------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-备份指定库"><a href="#2-备份指定库" class="headerlink" title="2.备份指定库"></a>2.备份指定库</h2><blockquote><p>语法：</p><p>mysqldump   连接数据库参数   –database&#x2F;-B   库名1 库名2 库名3 ….    &gt; 输出文件</p></blockquote><ul><li>备份zhao1.zhao2.zhao3，三个库</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>B zhao1 zhao2 zhao3 <span class="operator">&gt;</span>all_zhao.sql</span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure><ul><li>模拟删除</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zhao1;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zhao2;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zhao3;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><ul><li>恢复检查</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">&lt;</span> all_zhao.sql </span><br><span class="line">Enter password: </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure><h2 id="3-备份指定表"><a href="#3-备份指定表" class="headerlink" title="3.备份指定表"></a>3.备份指定表</h2><blockquote><p>备份单个表：mysqldump   连接数据库参数    库名   指定表   表    &gt; 输出文件</p><p>备份多个表：mysqldump   连接数据库参数    库名   指定表   表1  表2 表3 ….    &gt; 输出文件</p></blockquote><ul><li>环境准备</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> zhao1.t1(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> zhao1.t2(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> zhao1.t3(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> zhao1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_zhao1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> t1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>备份zhao1库下的t1.t2.t3表，模拟删除并恢复检查</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 zhao1 t1 t2 t3 <span class="operator">&gt;</span> all_t123.sql</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll all_t123.sql </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 2720 Jun  4 20:23 all_t123.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模拟删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> zhao1.t1;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> zhao1.t2;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> zhao1.t3;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> zhao1;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> use zhao1;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>all_t123.sql</span><br><span class="line"></span><br><span class="line">#查看</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show tables from zhao1&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_zhao1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> t1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br></pre></td></tr></table></figure><h2 id="4-备份表结构"><a href="#4-备份表结构" class="headerlink" title="4.备份表结构"></a>4.备份表结构</h2><blockquote><p>语法： mysqldump  连接数据库    –no-data&#x2F;-d   库    &gt; 输出文件  （备份某库下所有表结构）</p><p>   mysqldump  连接数据库    –no-data&#x2F;-d   库  表1 表2   &gt; 输出文件  （备份某库下指定的表结构）</p></blockquote><ul><li>环境准备</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看wrold库下city表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> world.city</span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                 </span><br><span class="line"><span class="operator">|</span> city  <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `city` (</span><br><span class="line">  `ID` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `Name` <span class="type">char</span>(<span class="number">35</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `CountryCode` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `District` <span class="type">char</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Population` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`),</span><br><span class="line">  KEY `CountryCode` (`CountryCode`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `city_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`CountryCode`) <span class="keyword">REFERENCES</span> `country` (`Code`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4080</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>latin1 <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>备份world库下city表结构，并且进行恢复重新创建表</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>d  world city <span class="operator">&gt;</span> city.sql </span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建新库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database zhao1;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> use zhao1;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#恢复</span><br><span class="line">#写法<span class="number">2</span>：mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 zhao1 <span class="operator">&lt;</span> city.sql </span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>city.sql</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type     <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> ID          <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Name        <span class="operator">|</span> <span class="type">char</span>(<span class="number">35</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CountryCode <span class="operator">|</span> <span class="type">char</span>(<span class="number">3</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> District    <span class="operator">|</span> <span class="type">char</span>(<span class="number">20</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Population  <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>备份world库下所有表结构，模拟创建新库进行恢复重新创建表</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>d world  <span class="operator">&gt;</span> all_world_table.sql</span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模拟创建新库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> database();</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> database() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> zhao1      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#恢复备份的表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>all_world_table.sql;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">-------后面太长省略</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查恢复的表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_zhao1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type     <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> ID          <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Name        <span class="operator">|</span> <span class="type">char</span>(<span class="number">35</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CountryCode <span class="operator">|</span> <span class="type">char</span>(<span class="number">3</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> District    <span class="operator">|</span> <span class="type">char</span>(<span class="number">20</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Population  <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="4-备份表数据"><a href="#4-备份表数据" class="headerlink" title="4.备份表数据"></a>4.备份表数据</h2><blockquote><p>语法：</p><p>mysqldump  连接数据库参数  –no-create-info&#x2F;-t  库   表名（只备份数据）     &gt;输出文件</p><p>恢复：需要提前准备好数据对应的表结构（结构约束属性等），方可进行恢复导入数据</p></blockquote><ul><li>数据准备</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> zhao2.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> 赵    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 黄    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhang <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>备份zhao2库下的t1表数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>t zhao2 t1 <span class="operator">&gt;</span> t1_data.sql</span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure</span><br></pre></td></tr></table></figure><ul><li>提前准备t1表数据对应的表结构，进行数据恢复</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#查看t1表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">  `name` <span class="type">char</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建备份数据对应的表结构，用于数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `name` <span class="type">char</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span>  t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field <span class="operator">|</span> Type     <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> <span class="type">char</span>(<span class="number">11</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数据恢复导入，检查恢复结果</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 zhao3 <span class="operator">&lt;</span> t1_data.sql </span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;select * from zhao3.t1&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> 赵    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 黄    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhang <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5-备份且压缩"><a href="#5-备份且压缩" class="headerlink" title="5.备份且压缩"></a>5.备份且压缩</h2><p>备份数据库大量数据时，防止数据过大占用磁盘空间，备份压缩为压缩文件</p><blockquote><p>语法： mysqldump  连接参数   备份对象(全量或是某库表)   |  gzip &gt;数据文件</p></blockquote><ul><li>备份压缩数据库全部数据，模拟删除数据，并恢复数据检查</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#备份且压缩数据库数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>A <span class="operator">|</span>gzip <span class="operator">&gt;</span> all_mysql.sql.gz</span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls</span><br><span class="line">all_mysql.sql.gz</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#file all_mysql.sql.gz </span><br><span class="line">all_mysql.sql.gz: gzip compressed data, <span class="keyword">from</span> Unix, <span class="keyword">last</span> modified: Wed Jun  <span class="number">5</span> <span class="number">14</span>:<span class="number">19</span>:<span class="number">42</span> <span class="number">2024</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除数据，初始化实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl stop mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#rm <span class="operator">-</span>rf <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="comment">/*</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql  --datadir=/app/data/3306</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#恢复数据</span></span><br><span class="line"><span class="comment">##方法一，先解压缩后，用普通sql文件进行导入恢复</span></span><br><span class="line"><span class="comment">gzip all_mysql.sql.gz</span></span><br><span class="line"><span class="comment">mysql -uroot -p &lt; all_mysql.sql</span></span><br><span class="line"><span class="comment">##方法二，使用zcat命令输出zip压缩包内容，导入恢复</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#zcat all_mysql.sql.gz |mysql -uroot -p</span></span><br><span class="line"><span class="comment">Enter password: </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#检查数据恢复</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#mysql -uroot -p -e &quot;show databases&quot;</span></span><br><span class="line"><span class="comment">Enter password: </span></span><br><span class="line"><span class="comment">+--------------------+</span></span><br><span class="line"><span class="comment">| Database           |</span></span><br><span class="line"><span class="comment">+--------------------+</span></span><br><span class="line"><span class="comment">| information_schema |</span></span><br><span class="line"><span class="comment">| mysql              |</span></span><br><span class="line"><span class="comment">| performance_schema |</span></span><br><span class="line"><span class="comment">| student            |</span></span><br><span class="line"><span class="comment">| sys                |</span></span><br><span class="line"><span class="comment">+--------------------+</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#mysql -uroot -p -e &quot;select * from student.stu1&quot;</span></span><br><span class="line"><span class="comment">Enter password: </span></span><br><span class="line"><span class="comment">+----+-----------+-----+--------------+-------+</span></span><br><span class="line"><span class="comment">| id | name      | age | address      | phone |</span></span><br><span class="line"><span class="comment">+----+-----------+-----+--------------+-------+</span></span><br><span class="line"><span class="comment">|  1 | 赵东兴    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  2 | 叶金阳    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  3 | 杨松麟    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  4 | 陈亮亮    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  5 | 李文杰    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  6 | 郑佳强    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  7 | 罗兴林    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  8 | 冯靖涵    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure><h1 id="binlog二进制日志"><a href="#binlog二进制日志" class="headerlink" title="binlog二进制日志"></a><em>binlog</em>二进制日志</h1><p><strong><em>binling</em>日志是什么</strong></p><ul><li>数据库程序中的一种日志，日志中对信息保存的方式是二进制数据类型，所以叫做二进制日志</li></ul><p><strong><em>binlog</em>日志记录着什么?</strong> </p><ul><li><p>记录着对数据库数据，每一条修改的操作语句动作，也叫对事务的记录</p></li><li><p>如DML语句对数据表数据插入修改删除，DDL语句对表库创建删除修改，DCL语句通过user表授权移除权限，都会造成数据库中数据变动</p></li></ul><p><strong><em>binlong</em>日志作用？</strong> </p><ul><li>可以通过日志记录，针对每一个事务进行恢复数据，可以通过<em>postion</em>开始与结束值恢复，也可以通过<em>GTID</em>号进行恢复 </li><li>对数据库数据维护一种手段，弥补数据备份的缺陷，数据备份通常为每日定时任务，而在定时任务没执行时，当日的数据就处在一个危险的状态，此时若数据丢失，就无法通过手段进行恢复了，而有了<em>binglog</em>日志可以对数据更加安全的维护。</li></ul><h2 id="1-开启日志功能"><a href="#1-开启日志功能" class="headerlink" title="1.开启日志功能"></a>1.开启日志功能</h2><ul><li>通过内置变量可查看<em>binlog</em>日志是否开启，默认是关闭状态</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%log_bin%&#x27;;</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| log_bin                         | OFF   |</span><br><span class="line">| log_bin_basename                |       |</span><br><span class="line">| log_bin_index                   |       |</span><br><span class="line">| log_bin_trust_function_creators | OFF   |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF   |</span><br><span class="line">| sql_log_bin                     | ON    |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><ul><li><em>mysql</em>配置文件添加日志参数</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>参数解释</span><br><span class="line">server_id  #主机id，必须要区别于其他机器</span><br><span class="line">log_bin    #参数指定binglog日志输出路径，日志文件最终生成格式如 mysql<span class="operator">-</span>bin<span class="number">.000001</span>   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>创建日志目录并授予程序权限，日志目录与实例数据目录分开</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>配置文件如下</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">character_set_server<span class="operator">=</span>utf8mb4 </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">log<span class="operator">-</span>error<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span><span class="number">3306</span>_error.log</span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>重启检查日志功能开启</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl restart mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep mysqld</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">80</span>     [::]:<span class="number">3306</span>               [::]:<span class="operator">*</span>                   users:((&quot;mysqld&quot;,pid<span class="operator">=</span><span class="number">17483</span> </span><br></pre></td></tr></table></figure><ul><li>登录进入检查变量binlog日志功能是否开启</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sql_log_bin                     <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-日志记录格式"><a href="#2-日志记录格式" class="headerlink" title="2.日志记录格式"></a>2.日志记录格式</h2><p><em>binlog</em>日志文件内记录了什么，是以什么格式进行记录</p><p>日志记录的形式是以每个事件进行记录，每条sql语句导致数据的变化，就为一个事件，会对每一个事件进行详细的记录到日志中</p><p><strong>日志中某个事件记录格式如下</strong></p><blockquote><p>主要关注，start_pos，end_pos，事件内容</p></blockquote><p>1.事件描述</p><ul><li><p>时间戳</p></li><li><p>程序标识 （server_id，用于主从复制）</p></li><li><p>加密方式 （日志会对inserter语句，进行base-64算法加密）</p></li><li><p>事件开始位置 （start_pos，事件开始的一个随机数）</p></li><li><p>事件结束位置 （end_pos，事件结束后的一个随机数）</p></li></ul><p>2.事件内容</p><ul><li>修改类语句操作，会多记录事件内容信息（插入了什么数据并且是加密的）</li></ul><p><img src="/image-20240605180028560.png" alt="image-20240605180028560"></p><h2 id="3-查看日志文件"><a href="#3-查看日志文件" class="headerlink" title="3.查看日志文件"></a>3.查看日志文件</h2><ul><li><strong>查看所有binlog日志文件，当前都有多少二进制日志</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">154</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#方法二</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000001</span>  mysql<span class="operator">-</span>bin.index</span><br></pre></td></tr></table></figure><ul><li><strong>查看当前日志记录的binglog日志文件，当前使用的日志会记录在哪个二进制文件</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="4-刷新日志文件"><a href="#4-刷新日志文件" class="headerlink" title="4.刷新日志文件"></a>4.刷新日志文件</h2><ul><li>执行刷新日志动作时，会再次创建一个新的日志文件，之后的事务会记录到新日志文件中</li><li>使用场景：做好全量备份数据后，每日的新增事务单独保存为日志文件中，方便对事务的查找</li></ul><ul><li>了解即可，不能随便执行该操作</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#刷新日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#新增了三个新的binglog文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>       <span class="number">154</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前使用的日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="5-主动生成事务"><a href="#5-主动生成事务" class="headerlink" title="5.主动生成事务"></a>5.主动生成事务</h2><ul><li><p>执行对数据影响的sql语句，就为一个事务，当执行每一个事务时，日志会记录事务的信息</p></li><li><p>日志中postion值，记录了每个事务的开始位置，这个位置会被显示为一个随机数，当下个事务发生，随机数会增加成为下个事务开始位置</p></li><li><p>主动执行sql语句，生成事务，查看日志文件pos值变化</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#最初的日志事务pos值记录，<span class="number">154</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第一次增加事务，查看pos值，pos154<span class="operator">-</span> 创建库事务 <span class="number">-313</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">313</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第二次增加事务，pos154<span class="comment">----创建库----313----创建表----482 </span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test.t1(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">482</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第三次增加事务查看，pos154（创建库）pos313（创建表）pos482（插入数据）pos761 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test.t1 <span class="keyword">value</span>(<span class="string">&#x27;赵东兴&#x27;</span>),(<span class="string">&#x27;乐佳杰&#x27;</span>),(<span class="string">&#x27;好一名&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">761</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="6-查看事件记录"><a href="#6-查看事件记录" class="headerlink" title="6.查看事件记录"></a>6.查看事件记录</h2><blockquote><p>语法：show binlog events in  ‘日志文件名’;</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#先查看当前使用的哪个日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>     <span class="number">1012</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#指定日志文件查看事件的一个信息</span><br></pre></td></tr></table></figure><p><img src="/image-20240605174125575.png" alt="image-20240605174125575"></p><h2 id="7-日志解密查看"><a href="#7-日志解密查看" class="headerlink" title="7.日志解密查看"></a>7.日志解密查看</h2><p>查看<em>binlog</em>日志文件内存储了什么信息，<em>binlog</em>日志文件记录事务后都是以二进制的数据类型存储</p><p>通过<em>mysqlbinlog</em>命令对二进制数据进行转化为人类可识别的字符，查看日志内容是如何记录事务信息</p><blockquote><p>语法： <em>mysqlbinlog</em>   日志文件路径</p></blockquote><ul><li><strong>查看使用的日志文件</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>     <span class="number">1012</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>转换可读格式，数据导入文件，编辑器查看</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">&gt;</span> bin.log</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#sz bin.log </span><br></pre></td></tr></table></figure><ul><li><strong>编辑器查看日志内容</strong></li></ul><p><img src="/image-20240605180021552.png" alt="image-20240605180021552"></p><ul><li><strong>解密查看日志内加密的内容</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--base64-output=decode-rows -vv /app/logs/mysql_log/mysql-bin.000004 &gt; bin.log</span></span><br></pre></td></tr></table></figure><p><img src="/image-20240605181339331.png" alt="image-20240605181339331"></p><h1 id="binlog日志截取恢复（数据表数据误删）"><a href="#binlog日志截取恢复（数据表数据误删）" class="headerlink" title="binlog日志截取恢复（数据表数据误删）"></a><em>binlog</em>日志截取恢复（数据表数据误删）</h1><ul><li>当数据库数据，还没有进行对数据备份时，数据丢失，就得需要binlog日志进行恢复数据。</li><li>binglog日志中记录了每个事务的信息，postion值记录了每个事务的起点与终点的随机数。</li><li>通过事务开始的postion值与结束的pos值可以实现对数据的恢复</li></ul><blockquote><p>语法：</p></blockquote><h2 id="1-开启binlog"><a href="#1-开启binlog" class="headerlink" title="1.开启binlog"></a>1.开启binlog</h2><ul><li>保证binlog日志开启，记录事务的信息，方可根据pos值进行恢复数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sql_log_bin                     <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-模拟删除数据"><a href="#2-模拟删除数据" class="headerlink" title="2.模拟删除数据"></a>2.模拟删除数据</h2><ul><li>环境准备，test库下t1表，内有4行数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 赵东兴    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 乐佳杰    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 好一名    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>模拟误删除，运维老大东子的手下，不小心删除了t1表的一条数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> test.t1 <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;王&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 赵东兴    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 乐佳杰    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 好一名    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="3-binlog日志分析"><a href="#3-binlog日志分析" class="headerlink" title="3.binlog日志分析"></a>3.binlog日志分析</h2><h3 id="3-1-binlog记录查找删除事件pos值"><a href="#3-1-binlog记录查找删除事件pos值" class="headerlink" title="3.1 binlog记录查找删除事件pos值"></a>3.1 binlog记录查找删除事件pos值</h3><blockquote><p>查看binlog日志的事件记录，查找删除事件的记录，查找事件开始与结束的pos值</p><p>修改类事件信息格式： set修改标识—-begin开始—–修改数据动作—-commit提交事件</p></blockquote><p>1.事件类型查找delete类型事件</p><p>2.通过修改类事件的记录格式，分析查找整个事件开始的pos值与结束的pos值</p><p>3.最后查找到删除事件，<code>开始的pos值-----1012，  结束pos值------1267</code></p><p><img src="/image-20240605191520961.png" alt="image-20240605191520961"></p><h3 id="3-2-解密binlog定位丢失的具体数据"><a href="#3-2-解密binlog定位丢失的具体数据" class="headerlink" title="3.2 解密binlog定位丢失的具体数据"></a>3.2 解密binlog定位丢失的具体数据</h3><blockquote><p>语法： mysqlbinlog –base64-output&#x3D;decode-rows -vv   binlog日志文件  &gt; 导入文件</p><p>导出binglog日志文件，根据删除事件的pos值，查看具体删除了什么数据</p></blockquote><ul><li><strong>解密日志导入文件，转发桌面编辑器查看</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--base64-output=decode-rows -vv /app/logs/mysql_log/mysql-bin.000004 &gt; bin.log</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#sz bin.log </span><br></pre></td></tr></table></figure><ul><li><strong>日志分析得知，删除了t1表的，name&#x3D;王，这条数据</strong></li></ul><p><img src="/image-20240605194758148.png" alt="image-20240605194758148"></p><h3 id="3-3-查找丢失数据创建时的事件pos值"><a href="#3-3-查找丢失数据创建时的事件pos值" class="headerlink" title="3.3 查找丢失数据创建时的事件pos值"></a>3.3 查找丢失数据创建时的事件pos值</h3><blockquote><p>现在已经找到了，删除的内容为t1表下的<code>（name=王）</code>这条数据，创建的pos值761–1012</p><p>下一步根据创建事件的pos值，从binlog日志截取出，创建事件的日志，通过日志中sql语句进行恢复数据</p></blockquote><ul><li><strong>解密日志文件中查看，查找丢失数据在创建时，事务开时pos值与结束pos值</strong></li></ul><p><img src="/image-20240605200945330.png" alt="image-20240605200945330"></p><h2 id="4-截取日志恢复数据"><a href="#4-截取日志恢复数据" class="headerlink" title="4.截取日志恢复数据"></a>4.截取日志恢复数据</h2><h3 id="4-1-日志恢复原理"><a href="#4-1-日志恢复原理" class="headerlink" title="4.1 日志恢复原理"></a>4.1 日志恢复原理</h3><p>原理就是这个数据被删除，会在binlog生成事件，找到这个事件的pos值，日志解密后查找具体删除了什么数据</p><p>找到这个被删除的数据，那么这个数据在创建时也会生成一个创建事件，查找创建事件的开始pos值与结束pos值</p><p>通过创建事件的pos值，将创建事件的sql语句导出来，再通过这些创建数据sql语句进行导入数据库，实现数据恢复</p><h3 id="4-2-事件日志截取"><a href="#4-2-事件日志截取" class="headerlink" title="4.2 事件日志截取"></a>4.2 事件日志截取</h3><blockquote><p>截取某个事件日志语法： </p><p>mysqlbinlog   –start-position&#x3D;（事件开始pos值） –stop-position&#x3D;（结束pos值）  binlog日志   &gt;  导出文件</p></blockquote><ul><li><strong>导出要恢复的事件日志，开始pos值为761，结束pos值为1012</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--start-position=761 --stop-position=1012 /app/logs/mysql_log/mysql-bin.000004 &gt; recover.sql</span></span><br></pre></td></tr></table></figure><h3 id="4-3-关闭日志记录"><a href="#4-3-关闭日志记录" class="headerlink" title="4.3 关闭日志记录"></a>4.3 关闭日志记录</h3><blockquote><p>临时关闭binlog日志的记录，否则恢复数据时会添加新的事件记录，恢复数据后再打开日志记录</p></blockquote><ul><li>修改内置变量，临时关闭日志记录</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br></pre></td></tr></table></figure><h3 id="4-3-丢失数据恢复"><a href="#4-3-丢失数据恢复" class="headerlink" title="4.3 丢失数据恢复"></a>4.3 丢失数据恢复</h3><ul><li>导入恢复数据的sql语句</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.sql;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>取消临时关闭日志</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><ul><li>检查（name&#x3D;王数据）是否恢复</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#########数据恢复成功##########</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 赵东兴    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 乐佳杰    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 好一名    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="binlog多个日志截取恢复（数据库误删）"><a href="#binlog多个日志截取恢复（数据库误删）" class="headerlink" title="binlog多个日志截取恢复（数据库误删）"></a><em>binlog</em>多个日志截取恢复（数据库误删）</h1><blockquote><p>进行全量备份时，每日会会binlog进行刷新创建，将每日事务分别记录到不同的binlog中</p><p>当事件分散存储在不同的binlog日志文件，发生数据丢失如何进行恢复数据 ？</p></blockquote><h2 id="1-场景模拟"><a href="#1-场景模拟" class="headerlink" title="1.场景模拟"></a>1.场景模拟</h2><blockquote><p>创建测试数据生成多个事务，主动flush.logs刷新binlog日志，将事务保存到不同的binlog</p><p>最后基于binlog日志分析截取丢失数据pos值，实现数据恢复。</p></blockquote><h3 id="1-1-日志1，mysql-bin-000001"><a href="#1-1-日志1，mysql-bin-000001" class="headerlink" title="1.1 日志1，mysql-bin.000001"></a>1.1 日志1，mysql-bin.000001</h3><ul><li>当前使用mysql-bin.000001日志，进行创建数据事务提交</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#创建数据库数据表生成事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database lol;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.tanke(name <span class="type">char</span>(<span class="number">10</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> lol;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_lol <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> tanke         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前使用的binlog与事务记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">481</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line">##生成的事件记录</span><br><span class="line">mysql<span class="operator">&gt;</span> mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000001&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">310</span> <span class="operator">|</span> <span class="keyword">create</span> database lol                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">310</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">375</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">375</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">481</span> <span class="operator">|</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.tanke(name <span class="type">char</span>(<span class="number">10</span>)) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#主动刷新生成新的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="1-2-日志2，mysql-bin-000002"><a href="#1-2-日志2，mysql-bin-000002" class="headerlink" title="1.2 日志2，mysql-bin.000002"></a>1.2 日志2，mysql-bin.000002</h3><ul><li>已刷新生成新的mysql-bin.000002日志，之后新增事务保存到binlog-02日志中</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#当前使用的新日志<span class="number">02</span>binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#写入数据，再次生成新事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lol.tanke <span class="keyword">value</span>(<span class="string">&#x27;盖伦&#x27;</span>),(<span class="string">&#x27;慎&#x27;</span>),(<span class="string">&#x27;石头人&#x27;</span>),(<span class="string">&#x27;日女&#x27;</span>),(<span class="string">&#x27;龙龟&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lol.tanke;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 盖伦      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 慎        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 石头人    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 日女      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 龙龟      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看<span class="number">02</span>日志事务提交记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000002&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">287</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">287</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">336</span> <span class="operator">|</span> table_id: <span class="number">223</span> (lol.tanke)             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">336</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">411</span> <span class="operator">|</span> table_id: <span class="number">223</span> flags: STMT_END_F       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">411</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">442</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=169 */</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#再次主动刷新创建新binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="1-3-日志3，mysql-bin-000003"><a href="#1-3-日志3，mysql-bin-000003" class="headerlink" title="1.3 日志3，mysql-bin.000003"></a>1.3 日志3，mysql-bin.000003</h3><ul><li>已刷新生成新的mysql-bin.000003日志，之后新增事务保存到binlog-03日志中</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">#当前使用的binlog日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#主动生成新事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.fashi(name <span class="type">char</span>(<span class="number">10</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lol.fashi <span class="keyword">value</span>(<span class="string">&#x27;光辉&#x27;</span>),(<span class="string">&#x27;阿卡丽&#x27;</span>),(<span class="string">&#x27;火男&#x27;</span>),(<span class="string">&#x27;小鱼人&#x27;</span>),(<span class="string">&#x27;卡牌&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前binlog日志pos值变化</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">619</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog新增事务记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000003&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">325</span> <span class="operator">|</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.fashi(name <span class="type">char</span>(<span class="number">10</span>)) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">325</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">390</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">390</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">458</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">458</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">507</span> <span class="operator">|</span> table_id: <span class="number">224</span> (lol.fashi)             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">507</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">588</span> <span class="operator">|</span> table_id: <span class="number">224</span> flags: STMT_END_F       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">588</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">619</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=178 */</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#再次刷新binlog，生成新日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="1-4-日志4，模拟误删除数据库lol"><a href="#1-4-日志4，模拟误删除数据库lol" class="headerlink" title="1.4 日志4，模拟误删除数据库lol"></a>1.4 日志4，模拟误删除数据库lol</h3><ul><li>已刷新生成了新mysql-bin.000004日志文件，再次写数据事务提交新日志中，并且模拟删除数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#写数据生成事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lol.fashi <span class="keyword">values</span>(<span class="string">&#x27;发条&#x27;</span>),(<span class="string">&#x27;吸血鬼&#x27;</span>),(<span class="string">&#x27;莫甘娜&#x27;</span>),(<span class="string">&#x27;大发明家&#x27;</span>),(<span class="string">&#x27;火女&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line">#查看事务新增</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">454</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog事务记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000004&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">287</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">287</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">336</span> <span class="operator">|</span> table_id: <span class="number">224</span> (lol.fashi)             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">336</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">423</span> <span class="operator">|</span> table_id: <span class="number">224</span> flags: STMT_END_F       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">423</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">454</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=183 */</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>模拟一不小心把lol库删除了</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#误删lol库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database lol;</span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除事务被记录到了binlog04日志中</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">608</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="2-恢复实战"><a href="#2-恢复实战" class="headerlink" title="2.恢复实战"></a>2.恢复实战</h2><p>方案1：分段截取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--start-position</span><br><span class="line"></span><br><span class="line">--stop-position</span><br></pre></td></tr></table></figure><p>方案2：时间戳截取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1. 找创建lol库的时间戳</span><br></pre></td></tr></table></figure><h3 id="2-1-恢复思路图解"><a href="#2-1-恢复思路图解" class="headerlink" title="2.1 恢复思路图解"></a>2.1 恢复思路图解</h3><p><img src="/image-20240605210920147.png" alt="image-20240605210920147"></p><h3 id="2-2-恢复数据步骤"><a href="#2-2-恢复数据步骤" class="headerlink" title="2.2 恢复数据步骤"></a>2.2 恢复数据步骤</h3><p>思路：找到关于你要恢复的这个lol数据库，从创建该库，到删除lol之间的记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 基于开始的日志，找pos起点位置</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000003&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">1860</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>        <span class="number">1951</span> <span class="operator">|</span> <span class="keyword">create</span> database lol                                                                                                                                                                                                             <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>基于事件，寻找删库的事件pos位置</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000006&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000006</span> <span class="operator">|</span> <span class="number">499</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">588</span> <span class="operator">|</span> <span class="keyword">drop</span> database lol  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 或者基于mysqlbinlog命令，分析二进制日志的 建库lol的时间，到删库之间所有的日志</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>]#mysqlbinlog <span class="comment">--start-position=1860 --stop-position=499 mysql-bin.000003 mysql-bin.000004 mysql-bin.000005 mysql-bin.000006 &gt; /tmp/restore-lol.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>可以解密查看如上截取的日志，能找到最后的插入数据结果即可</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>]#mysqlbinlog <span class="comment">--base64-output=decode-rows -vv   --start-position=1860 --stop-position=499 mysql-bin.000003 mysql-bin.000004 mysql-bin.000005 mysql-bin.000006 &gt; restore-lol.log</span></span><br></pre></td></tr></table></figure><h3 id="2-3-查找删除事件"><a href="#2-3-查找删除事件" class="headerlink" title="2.3 查找删除事件"></a>2.3 查找删除事件</h3><ul><li>先判断误删操作到底删除了什么，再基于被删数据的创建事件，进行恢复</li><li>图中得出，删除了lol这个库的数据</li></ul><p><img src="/image-20240607105145555.png" alt="image-20240607105145555"></p><h3 id="2-4-解密导出所有binlog"><a href="#2-4-解密导出所有binlog" class="headerlink" title="2.4 解密导出所有binlog"></a>2.4 解密导出所有binlog</h3><p>因为被删的这个库，在创建时到被删前，中间提交的事务被分散保存到了多个binlog日志，所以需要导出全部binlog</p><p>导出后解密binlog，进行事务分析，被删数据在创建后，到被删之前，提交了哪些事务</p><p>最后根据lol库在创建时的开始pos值，与删除lol库的开始pos值，截取创建到删除前的日志，导出sql语句进行恢复数据</p><blockquote><p>解密导出所有binlog，编辑器分析查看</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前所有的binlog日志</span></span><br><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |       528 |</span><br><span class="line">| mysql-bin.000002 |       489 |</span><br><span class="line">| mysql-bin.000003 |       666 |</span><br><span class="line">| mysql-bin.000004 |       608 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入binlog存放目录，解密导出所有binlog</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cd</span> /app/logs/mysql_log/</span><br><span class="line">[root@db-51 /app/logs/mysql_log]#mysqlbinlog --base64-output=decode-rows -vv  mysql-bin.000001 mysql-bin.000002 mysql-bin.000003 mysql-bin.000004 &gt; recover.log</span><br></pre></td></tr></table></figure><ul><li>lol库删除的开始pos值，也是上次事件结束pos值</li></ul><p><img src="/image-20240607113426280.png" alt="image-20240607113426280"></p><ul><li>lol库创建时的开始pos值</li></ul><p><img src="/image-20240607113800342.png" alt="image-20240607113800342"></p><h3 id="2-5-截取恢复数据binglog"><a href="#2-5-截取恢复数据binglog" class="headerlink" title="2.5 截取恢复数据binglog"></a>2.5 截取恢复数据binglog</h3><blockquote><p>语法：</p><p>mysqlbinlog  –start-position&#x3D;（事件开始pos值）  –stop-position&#x3D;（事件结束pos值）  binlog文件（如果截取多个binlog就写多个binlog文件即可）    &gt;  导出文件</p></blockquote><ul><li>截取（lol库创建开始pos值，到lol库删除开始pos值）之间的所有binlog日志，导出日志内容到文件</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--start-position=219 --stop-position=454 mysql-bin.000001 mysql-bin.000002 mysql-bin.000003 mysql-bin.000004 &gt; /root/recover.sql</span></span><br></pre></td></tr></table></figure><h3 id="2-5-恢复数据并检查"><a href="#2-5-恢复数据并检查" class="headerlink" title="2.5 恢复数据并检查"></a>2.5 恢复数据并检查</h3><ul><li>导入sql文件，并且检查数据是否恢复</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#将刚才截取的日志文件导入数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.sql</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">##########后面省略#######</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> lol;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_lol <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> fashi         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tanke         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lol.fashi;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="operator">|</span> name         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="operator">|</span> 光辉         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 阿卡丽       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 火男         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 小鱼人       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 卡牌         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 发条         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 吸血鬼       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 莫甘娜       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 大发明家     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 火女         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lol.tanke;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 盖伦      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 慎        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 石头人    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 日女      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 龙龟      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="GTID与binglog应用"><a href="#GTID与binglog应用" class="headerlink" title="GTID与binglog应用"></a><em>GTID</em>与<em>binglog</em>应用</h1><blockquote><p>gitd是什么？ <em>全局事务标示符</em></p><p>就是给每个事务添加了一个实例唯一标识与事务的id值，可以根据事务对应的gtid恢复数据，无需再用肉眼判断事务的pos值去进行恢复。</p><p>可以用在主从复制架构中，主库数据基于binglog每个事务gtid，复制数据到从库上，减少了使用pos值复制时的容错率。</p></blockquote><p><strong>概述</strong></p><ul><li><p>从 MySQL 5.6.5 开始新增了一种基于 GTID 的复制方式</p></li><li><p>通过 GTID 保证了每个在主库上提交的事务在集群中有一个唯一的ID</p></li><li><p>这种方式强化了数据库的主备一致性，故障恢复以及容错能力</p></li><li><p>在原来基于二进制日志的复制中，从库需要告知主库要从哪个偏移量pos值进行增量同步，</p><p>如果指定<code>错误会造成数据的遗漏，从而造成数据的不一致。</code></p></li><li><p>借助GTID，在发生主备切换的情况下，MySQL的其它从库可以自动在新主库上找到正确的复制位置，</p><p><code>这大大简化了复杂复制拓扑下集群的维护</code>，也减少了人为设置复制位置发生误操作的风险。</p></li><li><p>另外，基于GTID的复制可以忽略已经执行过的事务，减少了数据发生不一致的风险。</p><p>​</p></li></ul><h2 id="1-GTID开启与使用"><a href="#1-GTID开启与使用" class="headerlink" title="1. GTID开启与使用"></a>1. GTID开启与使用</h2><blockquote><p>GTID默认是未开启状态，查询binlog事件记录，都是GTID_NEXT&#x3D; ‘ANONYMOUS（无名）’</p><p>当开启后，每个事件记录都会有，GTID的标识&#x3D;uuid+事件id（事件数量）</p></blockquote><p><img src="/image-20240607145137038.png" alt="image-20240607145137038"></p><ul><li><strong>开启GTID，配置文件添加如下参数</strong></li></ul><p><img src="/image-20240607145638708.png" alt="image-20240607145638708"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#具体配置如下</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line"></span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">character_set_server<span class="operator">=</span>utf8mb4 </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">log<span class="operator">-</span>error<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>error_3306.log</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"></span><br><span class="line">#重启mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl restart mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep mysql</span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">3306</span>                 :::<span class="operator">*</span>                    LISTEN      <span class="number">51134</span><span class="operator">/</span>mysqld   </span><br></pre></td></tr></table></figure><ul><li><strong>检查GTID是否开启</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%GTID%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span> #开启gtid</span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span> #生成的事务都自动加上GTID</span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#开启后自动刷新binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>新增数据生成新的事务</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">##################新增的事务#####################</span><br><span class="line">#当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">#创建数据库‘未来’</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database future;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#‘未来’库中创建数据表‘预知’添加字段‘发生的事’</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> future.foresee(发生的事 <span class="type">char</span>(<span class="number">15</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line">#‘未来’库中‘预知’数据表‘发生的事’字段下，插入未来在你身上发生的<span class="number">6</span>件事情</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> future.foresee <span class="keyword">value</span>(<span class="string">&#x27;未来你的父母身体健康后半辈子会一直享福&#x27;</span>),(<span class="string">&#x27;你的母亲在你30岁之前病好了不再吃药&#x27;</span>),(<span class="string">&#x27;你在30岁实现了自己的目标工资月入3w+&#x27;</span>),(<span class="string">&#x27;你会交到一个很爱你很完美的女朋 友在你30岁结婚了&#x27;</span>),(<span class="string">&#x27;你的未来会很幸福你的家庭父母爱人孩子&#x27;</span>),(<span class="string">&#x27;孩子也快乐平安长大&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">6</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">6</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">#查看未来预知在你身上发生的事</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋友在你<span class="number">30</span>岁结婚了                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福你的家庭父母爱人孩子                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>查看binlog事件记录查看事务提交的gtid</strong></li></ul><p><img src="/image-20240607161221091.png" alt="image-20240607161221091"></p><p><img src="/image-20240607161440264.png" alt="image-20240607161440264"></p><h2 id="2-GTID截取binlog与恢复"><a href="#2-GTID截取binlog与恢复" class="headerlink" title="2. GTID截取binlog与恢复"></a>2. GTID截取binlog与恢复</h2><blockquote><p>语法：</p><p>mysqlbinlog –skip-gtids  –include-gtids&#x3D;’uuid:事务id’   binlog文件   &gt; 输出文件</p><p>–skip-gtids：</p><p>导出日志信息时，事件生成新的GTID，不加该参数导出的事件会保留原gtid，到时候恢复数据时会和binlog中原有的gtid导致冲突</p></blockquote><h3 id="2-1-模拟删除恢复数据（单事件）"><a href="#2-1-模拟删除恢复数据（单事件）" class="headerlink" title="2.1 模拟删除恢复数据（单事件）"></a>2.1 模拟删除恢复数据（单事件）</h3><ul><li><strong>模拟删除数据，删除foresee表内所有信息</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#原数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋 友在你<span class="number">30</span>岁结婚了                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福你的家庭父母爱人孩子                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模拟误删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">truncate</span> future.foresee;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line">#数据没了</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>查找被删数据在创建时的事件gtid，通过gtid截取binlog</strong></li></ul><p><img src="/image-20240607165258107.png" alt="image-20240607165258107"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#进入binlog日志目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#指定丢失数据的事件gtid，与binlog日志文件，进行日志截取导出</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;f695ab86-2303-11ef-bf61-000c2939adaa:3&#x27; mysql-bin.000001 &gt; /root/recover.sql</span></span><br></pre></td></tr></table></figure><ul><li><strong>临时关闭binlog记录，防止恢复记录写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>通过截取出的日志，导入数据库恢复数据</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#恢复数据</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.log;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">############恢复过程省略############</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋 友在你<span class="number">30</span>岁结婚了                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福你的家庭父母爱人孩子                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>恢复数据后开启binlog记录写入</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="2-2-模拟删除恢复数据（多个事件）"><a href="#2-2-模拟删除恢复数据（多个事件）" class="headerlink" title="2.2 模拟删除恢复数据（多个事件）"></a>2.2 模拟删除恢复数据（多个事件）</h3><blockquote><p>删除整个库，通过gtid截取多条日志，恢复数据</p></blockquote><ul><li><strong>模拟删除数据库</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database future;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line">ERROR <span class="number">1146</span> (<span class="number">42</span>S02): <span class="keyword">Table</span> <span class="string">&#x27;future.foresee&#x27;</span> doesn<span class="string">&#x27;t exist</span></span><br></pre></td></tr></table></figure><ul><li><strong>binlog日志查找，被删的数据库，在创建时到删除前的所有事件</strong></li></ul><p><img src="/image-20240607171514159.png" alt="image-20240607171514159"></p><ul><li><strong>临时关闭binlog</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>通过库在删除前所有事件gtid，进行截取binlog</strong></li></ul><blockquote><p>695ab86-2303-11ef-bf61-000c2939adaa:1-3（事件id范围指定即可）</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;f695ab86-2303-11ef-bf61-000c2939adaa:1-3&#x27; mysql-bin.000001 &gt; /root/recover.log</span></span><br></pre></td></tr></table></figure><ul><li><strong>截取的binlog，导入数据库恢复数据</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.log;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><strong>检查恢复数据</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋友在你<span class="number">30</span>岁时候，你们结婚了                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福，你的父母爱人孩子也都很幸福                                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;数据库数据备份恢复概述&quot;&gt;&lt;a href=&quot;#数据库数据备份恢复概述&quot; class=&quot;headerlink&quot; title=&quot;数据库数据备份恢复概述&quot;&gt;&lt;/a&gt;数据库数据备份恢复概述&lt;/h1&gt;&lt;p&gt;一个互联网业务，最核心的就是数据。数据库中更是存放着用户相关的数据，</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://example.com/2024/08/19/hello-world/"/>
    <id>http://example.com/2024/08/19/hello-world/</id>
    <published>2024-08-19T13:52:23.813Z</published>
    <updated>2024-08-19T13:52:23.813Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot;&gt;documentation&lt;/a&gt; for</summary>
      
    
    
    
    
  </entry>
  
</feed>
