<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>数据库MYSQL-备份数据 | 一往无前虎山行,拨开云雾见光明</title><meta name="author" content="赵东兴"><meta name="copyright" content="赵东兴"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="数据库数据备份恢复概述一个互联网业务，最核心的就是数据。数据库中更是存放着用户相关的数据，更加重要。 数据丢失后会造成极大的损失，所以为了避免数据丢失，就需要对数据库中数据进行备份。 1.运维职责 备份恢复策略   （备份周期，备份工具，备份方式，数据恢复方式） 备份检查       （事务binglog日志备份，数据备份，是否备份成功） 定期恢复数据演练 （备份数据是否有问题） 数据丢失恢复">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库MYSQL-备份数据">
<meta property="og:url" content="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE/index.html">
<meta property="og:site_name" content="一往无前虎山行,拨开云雾见光明">
<meta property="og:description" content="数据库数据备份恢复概述一个互联网业务，最核心的就是数据。数据库中更是存放着用户相关的数据，更加重要。 数据丢失后会造成极大的损失，所以为了避免数据丢失，就需要对数据库中数据进行备份。 1.运维职责 备份恢复策略   （备份周期，备份工具，备份方式，数据恢复方式） 备份检查       （事务binglog日志备份，数据备份，是否备份成功） 定期恢复数据演练 （备份数据是否有问题） 数据丢失恢复">
<meta property="og:locale">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-08-20T00:51:40.000Z">
<meta property="article:modified_time" content="2024-08-20T00:54:23.080Z">
<meta property="article:author" content="赵东兴">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '数据库MYSQL-备份数据',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-20 08:54:23'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="一往无前虎山行,拨开云雾见光明" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="一往无前虎山行,拨开云雾见光明"><span class="site-name">一往无前虎山行,拨开云雾见光明</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">数据库MYSQL-备份数据</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-08-20T00:51:40.000Z" title="Created 2024-08-20 08:51:40">2024-08-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-08-20T00:54:23.080Z" title="Updated 2024-08-20 08:54:23">2024-08-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="数据库MYSQL-备份数据"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="数据库数据备份恢复概述"><a href="#数据库数据备份恢复概述" class="headerlink" title="数据库数据备份恢复概述"></a>数据库数据备份恢复概述</h1><p>一个互联网业务，最核心的就是数据。数据库中更是存放着用户相关的数据，更加重要。</p>
<p>数据丢失后会造成极大的损失，所以为了避免数据丢失，就需要对数据库中数据进行备份。</p>
<h2 id="1-运维职责"><a href="#1-运维职责" class="headerlink" title="1.运维职责"></a>1.运维职责</h2><ul>
<li>备份恢复策略   （备份周期，备份工具，备份方式，数据恢复方式）</li>
<li>备份检查       （事务binglog日志备份，数据备份，是否备份成功）</li>
<li>定期恢复数据演练 （备份数据是否有问题）</li>
<li>数据丢失恢复     （利用现有资源，快速恢复数据）</li>
<li>数据迁移数据库升级</li>
</ul>
<h2 id="2-备份方案"><a href="#2-备份方案" class="headerlink" title="2.备份方案"></a>2.备份方案</h2><p><img src="/image-20240604164320125.png" alt="image-20240604164320125"></p>
<p><strong>逻辑备份</strong></p>
<p>用于备份小量数据，备份原理是将数据库中所有东西，转化为sql语句导入文件，进行备份。恢复数据时可通过sql语句进行，建库建表插入数据等动作达到恢复数据的效果。</p>
<p>常用工具：<em>mysqldump</em> （<em>mysql</em>内置的一个程序）</p>
<p><strong>物理备份</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.percona.com/software/mysql-database/percona-xtrabackup">https://www.percona.com/software/mysql-database/percona-xtrabackup</a></p>
<p><strong>如何选择</strong></p>
<p>100G数据以下，逻辑备份没问题，服务器配置要求高</p>
<p>100G数据以上，建议物理备份</p>
<h1 id="mysqldump备份恢复"><a href="#mysqldump备份恢复" class="headerlink" title="mysqldump备份恢复"></a><em>mysqldump</em>备份恢复</h1><h2 id="0-连接参数"><a href="#0-连接参数" class="headerlink" title="0.连接参数"></a>0.连接参数</h2><blockquote>
<p>-u 用户名<br>-p 用户密码<br>-S 本地socket文件<br>-h 指定主机地址<br>-P 指定端口</p>
</blockquote>
<h2 id="1-全量与恢复"><a href="#1-全量与恢复" class="headerlink" title="1.全量与恢复"></a>1.全量与恢复</h2><blockquote>
<p>语法： </p>
<p><em>mysqldump</em>  连接数据库参数  -all–databases&#x2F;A       &gt;    数据导入文件</p>
</blockquote>
<ul>
<li>备份数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>A <span class="operator">&gt;</span> all_mysql.sql</span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure>

<ul>
<li>清空数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#先关闭数据库程序否则直接清空会导致一些报错</span><br><span class="line">systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#清空数据库<span class="number">3306</span>实例的所有数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#rm <span class="operator">-</span>rf <span class="operator">*</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span>]#ll</span><br><span class="line">total <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重新初始化<span class="number">3306</span>实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqld <span class="comment">--initialize-insecure --user=mysql --basedir=/app/tools/mysql  --datadir=/app/data/3306</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">total <span class="number">110628</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql       56 Jun  4 17:28 auto.cnf</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      419 Jun  4 17:28 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 Jun  4 17:28 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun  4 17:28 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 Jun  4 17:28 ib_logfile1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 Jun  4 17:28 mysql</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun  4 17:28 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 Jun  4 17:28 sys</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动检查端口</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl <span class="keyword">start</span> mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">3306</span></span><br></pre></td></tr></table></figure>

<ul>
<li>恢复数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">sql</span>文件导入</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">&lt;</span> all_3306_bak.sql </span><br><span class="line">Enter password: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student.stu limit <span class="number">5</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+--------+---------+---------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> age <span class="operator">|</span> gender <span class="operator">|</span> address <span class="operator">|</span> intime              <span class="operator">|</span> phone <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+--------+---------+---------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 赵东兴    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">12</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 黄牛      <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">43</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 叶金阳    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">27</span>:<span class="number">21</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> 杨松麟    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">27</span>:<span class="number">22</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> 陈亮亮    <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> 男     <span class="operator">|</span> 北京    <span class="operator">|</span> <span class="number">2024</span><span class="number">-06</span><span class="number">-05</span> <span class="number">11</span>:<span class="number">27</span>:<span class="number">23</span> <span class="operator">|</span> <span class="number">110</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+--------+---------+---------------------+-------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="2-备份指定库"><a href="#2-备份指定库" class="headerlink" title="2.备份指定库"></a>2.备份指定库</h2><blockquote>
<p>语法：</p>
<p>mysqldump   连接数据库参数   –database&#x2F;-B   库名1 库名2 库名3 ….    &gt; 输出文件</p>
</blockquote>
<ul>
<li>备份zhao1.zhao2.zhao3，三个库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>B zhao1 zhao2 zhao3 <span class="operator">&gt;</span>all_zhao.sql</span><br><span class="line">Enter password: </span><br></pre></td></tr></table></figure>

<ul>
<li>模拟删除</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zhao1;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zhao2;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database zhao3;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>恢复检查</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">&lt;</span> all_zhao.sql </span><br><span class="line">Enter password: </span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;show databases;&quot;</span><br><span class="line">Enter password: </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure>

<h2 id="3-备份指定表"><a href="#3-备份指定表" class="headerlink" title="3.备份指定表"></a>3.备份指定表</h2><blockquote>
<p>备份单个表：mysqldump   连接数据库参数    库名   指定表   表    &gt; 输出文件</p>
<p>备份多个表：mysqldump   连接数据库参数    库名   指定表   表1  表2 表3 ….    &gt; 输出文件</p>
</blockquote>
<ul>
<li>环境准备</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> zhao1.t1(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> zhao1.t2(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> zhao1.t3(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> zhao1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_zhao1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> t1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>备份zhao1库下的t1.t2.t3表，模拟删除并恢复检查</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 zhao1 t1 t2 t3 <span class="operator">&gt;</span> all_t123.sql</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ll all_t123.sql </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 2720 Jun  4 20:23 all_t123.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模拟删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> zhao1.t1;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> zhao1.t2;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> zhao1.t3;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> zhao1;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> use zhao1;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>all_t123.sql</span><br><span class="line"></span><br><span class="line">#查看</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;show tables from zhao1&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_zhao1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> t1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br></pre></td></tr></table></figure>

<h2 id="4-备份表结构"><a href="#4-备份表结构" class="headerlink" title="4.备份表结构"></a>4.备份表结构</h2><blockquote>
<p>语法： mysqldump  连接数据库    –no-data&#x2F;-d   库    &gt; 输出文件  （备份某库下所有表结构）</p>
<p>   mysqldump  连接数据库    –no-data&#x2F;-d   库  表1 表2   &gt; 输出文件  （备份某库下指定的表结构）</p>
</blockquote>
<ul>
<li>环境准备</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao1              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao2              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhao3              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看wrold库下city表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> world.city</span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                 </span><br><span class="line"><span class="operator">|</span> city  <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `city` (</span><br><span class="line">  `ID` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `Name` <span class="type">char</span>(<span class="number">35</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `CountryCode` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `District` <span class="type">char</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Population` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`),</span><br><span class="line">  KEY `CountryCode` (`CountryCode`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `city_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`CountryCode`) <span class="keyword">REFERENCES</span> `country` (`Code`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4080</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>latin1 <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>备份world库下city表结构，并且进行恢复重新创建表</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#备份</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>d  world city <span class="operator">&gt;</span> city.sql </span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建新库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database zhao1;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> use zhao1;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#恢复</span><br><span class="line">#写法<span class="number">2</span>：mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 zhao1 <span class="operator">&lt;</span> city.sql </span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>city.sql</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type     <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> ID          <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Name        <span class="operator">|</span> <span class="type">char</span>(<span class="number">35</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CountryCode <span class="operator">|</span> <span class="type">char</span>(<span class="number">3</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> District    <span class="operator">|</span> <span class="type">char</span>(<span class="number">20</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Population  <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>备份world库下所有表结构，模拟创建新库进行恢复重新创建表</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>d world  <span class="operator">&gt;</span> all_world_table.sql</span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模拟创建新库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> database();</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> database() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> zhao1      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#恢复备份的表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>all_world_table.sql;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">-------后面太长省略</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查恢复的表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_zhao1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type     <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> ID          <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Name        <span class="operator">|</span> <span class="type">char</span>(<span class="number">35</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CountryCode <span class="operator">|</span> <span class="type">char</span>(<span class="number">3</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> District    <span class="operator">|</span> <span class="type">char</span>(<span class="number">20</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span>         <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Population  <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="4-备份表数据"><a href="#4-备份表数据" class="headerlink" title="4.备份表数据"></a>4.备份表数据</h2><blockquote>
<p>语法：</p>
<p>mysqldump  连接数据库参数  –no-create-info&#x2F;-t  库   表名（只备份数据）     &gt;输出文件</p>
<p>恢复：需要提前准备好数据对应的表结构（结构约束属性等），方可进行恢复导入数据</p>
</blockquote>
<ul>
<li>数据准备</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> zhao2.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> 赵    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 黄    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhang <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>备份zhao2库下的t1表数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>t zhao2 t1 <span class="operator">&gt;</span> t1_data.sql</span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure</span><br></pre></td></tr></table></figure>

<ul>
<li>提前准备t1表数据对应的表结构，进行数据恢复</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#查看t1表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">  `name` <span class="type">char</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建备份数据对应的表结构，用于数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `name` <span class="type">char</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span>  t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field <span class="operator">|</span> Type     <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> <span class="type">char</span>(<span class="number">11</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+------+-----+---------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数据恢复导入，检查恢复结果</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 zhao3 <span class="operator">&lt;</span> t1_data.sql </span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>e &quot;select * from zhao3.t1&quot;</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> 赵    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 黄    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> zhang <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-备份且压缩"><a href="#5-备份且压缩" class="headerlink" title="5.备份且压缩"></a>5.备份且压缩</h2><p>备份数据库大量数据时，防止数据过大占用磁盘空间，备份压缩为压缩文件</p>
<blockquote>
<p>语法： mysqldump  连接参数   备份对象(全量或是某库表)   |  gzip &gt;数据文件</p>
</blockquote>
<ul>
<li>备份压缩数据库全部数据，模拟删除数据，并恢复数据检查</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#备份且压缩数据库数据</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p1 <span class="operator">-</span>A <span class="operator">|</span>gzip <span class="operator">&gt;</span> all_mysql.sql.gz</span><br><span class="line">mysqldump: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls</span><br><span class="line">all_mysql.sql.gz</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#file all_mysql.sql.gz </span><br><span class="line">all_mysql.sql.gz: gzip compressed data, <span class="keyword">from</span> Unix, <span class="keyword">last</span> modified: Wed Jun  <span class="number">5</span> <span class="number">14</span>:<span class="number">19</span>:<span class="number">42</span> <span class="number">2024</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除数据，初始化实例</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl stop mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#rm <span class="operator">-</span>rf <span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span><span class="comment">/*</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql  --datadir=/app/data/3306</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#恢复数据</span></span><br><span class="line"><span class="comment">##方法一，先解压缩后，用普通sql文件进行导入恢复</span></span><br><span class="line"><span class="comment">gzip all_mysql.sql.gz</span></span><br><span class="line"><span class="comment">mysql -uroot -p &lt; all_mysql.sql</span></span><br><span class="line"><span class="comment">##方法二，使用zcat命令输出zip压缩包内容，导入恢复</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#zcat all_mysql.sql.gz |mysql -uroot -p</span></span><br><span class="line"><span class="comment">Enter password: </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#检查数据恢复</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#mysql -uroot -p -e &quot;show databases&quot;</span></span><br><span class="line"><span class="comment">Enter password: </span></span><br><span class="line"><span class="comment">+--------------------+</span></span><br><span class="line"><span class="comment">| Database           |</span></span><br><span class="line"><span class="comment">+--------------------+</span></span><br><span class="line"><span class="comment">| information_schema |</span></span><br><span class="line"><span class="comment">| mysql              |</span></span><br><span class="line"><span class="comment">| performance_schema |</span></span><br><span class="line"><span class="comment">| student            |</span></span><br><span class="line"><span class="comment">| sys                |</span></span><br><span class="line"><span class="comment">+--------------------+</span></span><br><span class="line"><span class="comment">[root@db-51 ~]#mysql -uroot -p -e &quot;select * from student.stu1&quot;</span></span><br><span class="line"><span class="comment">Enter password: </span></span><br><span class="line"><span class="comment">+----+-----------+-----+--------------+-------+</span></span><br><span class="line"><span class="comment">| id | name      | age | address      | phone |</span></span><br><span class="line"><span class="comment">+----+-----------+-----+--------------+-------+</span></span><br><span class="line"><span class="comment">|  1 | 赵东兴    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  2 | 叶金阳    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  3 | 杨松麟    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  4 | 陈亮亮    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  5 | 李文杰    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  6 | 郑佳强    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  7 | 罗兴林    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment">|  8 | 冯靖涵    |   0 | 猿来教育     | 0     |</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure>



<h1 id="binlog二进制日志"><a href="#binlog二进制日志" class="headerlink" title="binlog二进制日志"></a><em>binlog</em>二进制日志</h1><p><strong><em>binling</em>日志是什么</strong></p>
<ul>
<li>数据库程序中的一种日志，日志中对信息保存的方式是二进制数据类型，所以叫做二进制日志</li>
</ul>
<p><strong><em>binlog</em>日志记录着什么?</strong> </p>
<ul>
<li><p>记录着对数据库数据，每一条修改的操作语句动作，也叫对事务的记录</p>
</li>
<li><p>如DML语句对数据表数据插入修改删除，DDL语句对表库创建删除修改，DCL语句通过user表授权移除权限，都会造成数据库中数据变动</p>
</li>
</ul>
<p><strong><em>binlong</em>日志作用？</strong> </p>
<ul>
<li>可以通过日志记录，针对每一个事务进行恢复数据，可以通过<em>postion</em>开始与结束值恢复，也可以通过<em>GTID</em>号进行恢复 </li>
<li>对数据库数据维护一种手段，弥补数据备份的缺陷，数据备份通常为每日定时任务，而在定时任务没执行时，当日的数据就处在一个危险的状态，此时若数据丢失，就无法通过手段进行恢复了，而有了<em>binglog</em>日志可以对数据更加安全的维护。</li>
</ul>
<h2 id="1-开启日志功能"><a href="#1-开启日志功能" class="headerlink" title="1.开启日志功能"></a>1.开启日志功能</h2><ul>
<li>通过内置变量可查看<em>binlog</em>日志是否开启，默认是关闭状态</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%log_bin%&#x27;;</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| log_bin                         | OFF   |</span><br><span class="line">| log_bin_basename                |       |</span><br><span class="line">| log_bin_index                   |       |</span><br><span class="line">| log_bin_trust_function_creators | OFF   |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF   |</span><br><span class="line">| sql_log_bin                     | ON    |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><em>mysql</em>配置文件添加日志参数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>参数解释</span><br><span class="line">server_id  #主机id，必须要区别于其他机器</span><br><span class="line">log_bin    #参数指定binglog日志输出路径，日志文件最终生成格式如 mysql<span class="operator">-</span>bin<span class="number">.000001</span>   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>创建日志目录并授予程序权限，日志目录与实例数据目录分开</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mkdir <span class="operator">-</span>p <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>配置文件如下</span><br><span class="line">cat <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>my.cnf <span class="operator">&lt;&lt;</span>EOF</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">character_set_server<span class="operator">=</span>utf8mb4 </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">log<span class="operator">-</span>error<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span><span class="number">3306</span>_error.log</span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>重启检查日志功能开启</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl restart mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep mysqld</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">80</span>     [::]:<span class="number">3306</span>               [::]:<span class="operator">*</span>                   users:((&quot;mysqld&quot;,pid<span class="operator">=</span><span class="number">17483</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>登录进入检查变量binlog日志功能是否开启</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sql_log_bin                     <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="2-日志记录格式"><a href="#2-日志记录格式" class="headerlink" title="2.日志记录格式"></a>2.日志记录格式</h2><p><em>binlog</em>日志文件内记录了什么，是以什么格式进行记录</p>
<p>日志记录的形式是以每个事件进行记录，每条sql语句导致数据的变化，就为一个事件，会对每一个事件进行详细的记录到日志中</p>
<p><strong>日志中某个事件记录格式如下</strong></p>
<blockquote>
<p>主要关注，start_pos，end_pos，事件内容</p>
</blockquote>
<p>1.事件描述</p>
<ul>
<li><p>时间戳</p>
</li>
<li><p>程序标识 （server_id，用于主从复制）</p>
</li>
<li><p>加密方式 （日志会对inserter语句，进行base-64算法加密）</p>
</li>
<li><p>事件开始位置 （start_pos，事件开始的一个随机数）</p>
</li>
<li><p>事件结束位置 （end_pos，事件结束后的一个随机数）</p>
</li>
</ul>
<p>2.事件内容</p>
<ul>
<li>修改类语句操作，会多记录事件内容信息（插入了什么数据并且是加密的）</li>
</ul>
<p><img src="/image-20240605180028560.png" alt="image-20240605180028560"></p>
<h2 id="3-查看日志文件"><a href="#3-查看日志文件" class="headerlink" title="3.查看日志文件"></a>3.查看日志文件</h2><ul>
<li><strong>查看所有binlog日志文件，当前都有多少二进制日志</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">154</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#方法二</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ls <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000001</span>  mysql<span class="operator">-</span>bin.index</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>查看当前日志记录的binglog日志文件，当前使用的日志会记录在哪个二进制文件</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="4-刷新日志文件"><a href="#4-刷新日志文件" class="headerlink" title="4.刷新日志文件"></a>4.刷新日志文件</h2><ul>
<li>执行刷新日志动作时，会再次创建一个新的日志文件，之后的事务会记录到新日志文件中</li>
<li>使用场景：做好全量备份数据后，每日的新增事务单独保存为日志文件中，方便对事务的查找</li>
</ul>
<ul>
<li>了解即可，不能随便执行该操作</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#刷新日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#新增了三个新的binglog文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>       <span class="number">201</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>       <span class="number">154</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前使用的日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="5-主动生成事务"><a href="#5-主动生成事务" class="headerlink" title="5.主动生成事务"></a>5.主动生成事务</h2><ul>
<li><p>执行对数据影响的sql语句，就为一个事务，当执行每一个事务时，日志会记录事务的信息</p>
</li>
<li><p>日志中postion值，记录了每个事务的开始位置，这个位置会被显示为一个随机数，当下个事务发生，随机数会增加成为下个事务开始位置</p>
</li>
<li><p>主动执行sql语句，生成事务，查看日志文件pos值变化</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#最初的日志事务pos值记录，<span class="number">154</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第一次增加事务，查看pos值，pos154<span class="operator">-</span> 创建库事务 <span class="number">-313</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">313</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第二次增加事务，pos154<span class="comment">----创建库----313----创建表----482 </span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test.t1(name <span class="type">char</span>(<span class="number">5</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">482</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第三次增加事务查看，pos154（创建库）pos313（创建表）pos482（插入数据）pos761 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test.t1 <span class="keyword">value</span>(<span class="string">&#x27;赵东兴&#x27;</span>),(<span class="string">&#x27;乐佳杰&#x27;</span>),(<span class="string">&#x27;好一名&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">761</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="6-查看事件记录"><a href="#6-查看事件记录" class="headerlink" title="6.查看事件记录"></a>6.查看事件记录</h2><blockquote>
<p>语法：show binlog events in  ‘日志文件名’;</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#先查看当前使用的哪个日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>     <span class="number">1012</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#指定日志文件查看事件的一个信息</span><br></pre></td></tr></table></figure>

<p><img src="/image-20240605174125575.png" alt="image-20240605174125575"></p>
<h2 id="7-日志解密查看"><a href="#7-日志解密查看" class="headerlink" title="7.日志解密查看"></a>7.日志解密查看</h2><p>查看<em>binlog</em>日志文件内存储了什么信息，<em>binlog</em>日志文件记录事务后都是以二进制的数据类型存储</p>
<p>通过<em>mysqlbinlog</em>命令对二进制数据进行转化为人类可识别的字符，查看日志内容是如何记录事务信息</p>
<blockquote>
<p>语法： <em>mysqlbinlog</em>   日志文件路径</p>
</blockquote>
<ul>
<li><strong>查看使用的日志文件</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>     <span class="number">1012</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>转换可读格式，数据导入文件，编辑器查看</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">&gt;</span> bin.log</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#sz bin.log </span><br></pre></td></tr></table></figure>

<ul>
<li><strong>编辑器查看日志内容</strong></li>
</ul>
<p><img src="/image-20240605180021552.png" alt="image-20240605180021552"></p>
<ul>
<li><strong>解密查看日志内加密的内容</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--base64-output=decode-rows -vv /app/logs/mysql_log/mysql-bin.000004 &gt; bin.log</span></span><br></pre></td></tr></table></figure>

<p><img src="/image-20240605181339331.png" alt="image-20240605181339331"></p>
<h1 id="binlog日志截取恢复（数据表数据误删）"><a href="#binlog日志截取恢复（数据表数据误删）" class="headerlink" title="binlog日志截取恢复（数据表数据误删）"></a><em>binlog</em>日志截取恢复（数据表数据误删）</h1><ul>
<li>当数据库数据，还没有进行对数据备份时，数据丢失，就得需要binlog日志进行恢复数据。</li>
<li>binglog日志中记录了每个事务的信息，postion值记录了每个事务的起点与终点的随机数。</li>
<li>通过事务开始的postion值与结束的pos值可以实现对数据的恢复</li>
</ul>
<blockquote>
<p>语法：</p>
</blockquote>
<h2 id="1-开启binlog"><a href="#1-开启binlog" class="headerlink" title="1.开启binlog"></a>1.开启binlog</h2><ul>
<li>保证binlog日志开启，记录事务的信息，方可根据pos值进行恢复数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_bin                         <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_basename                <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_index                   <span class="operator">|</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin.index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_trust_function_creators <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_bin_use_v1_row_events       <span class="operator">|</span> OFF                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sql_log_bin                     <span class="operator">|</span> <span class="keyword">ON</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="2-模拟删除数据"><a href="#2-模拟删除数据" class="headerlink" title="2.模拟删除数据"></a>2.模拟删除数据</h2><ul>
<li>环境准备，test库下t1表，内有4行数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 赵东兴    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 乐佳杰    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 好一名    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>模拟误删除，运维老大东子的手下，不小心删除了t1表的一条数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> test.t1 <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;王&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 赵东兴    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 乐佳杰    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 好一名    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="3-binlog日志分析"><a href="#3-binlog日志分析" class="headerlink" title="3.binlog日志分析"></a>3.binlog日志分析</h2><h3 id="3-1-binlog记录查找删除事件pos值"><a href="#3-1-binlog记录查找删除事件pos值" class="headerlink" title="3.1 binlog记录查找删除事件pos值"></a>3.1 binlog记录查找删除事件pos值</h3><blockquote>
<p>查看binlog日志的事件记录，查找删除事件的记录，查找事件开始与结束的pos值</p>
<p>修改类事件信息格式： set修改标识—-begin开始—–修改数据动作—-commit提交事件</p>
</blockquote>
<p>1.事件类型查找delete类型事件</p>
<p>2.通过修改类事件的记录格式，分析查找整个事件开始的pos值与结束的pos值</p>
<p>3.最后查找到删除事件，<code>开始的pos值-----1012，  结束pos值------1267</code></p>
<p><img src="/image-20240605191520961.png" alt="image-20240605191520961"></p>
<h3 id="3-2-解密binlog定位丢失的具体数据"><a href="#3-2-解密binlog定位丢失的具体数据" class="headerlink" title="3.2 解密binlog定位丢失的具体数据"></a>3.2 解密binlog定位丢失的具体数据</h3><blockquote>
<p>语法： mysqlbinlog –base64-output&#x3D;decode-rows -vv   binlog日志文件  &gt; 导入文件</p>
<p>导出binglog日志文件，根据删除事件的pos值，查看具体删除了什么数据</p>
</blockquote>
<ul>
<li><strong>解密日志导入文件，转发桌面编辑器查看</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--base64-output=decode-rows -vv /app/logs/mysql_log/mysql-bin.000004 &gt; bin.log</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#sz bin.log </span><br></pre></td></tr></table></figure>

<ul>
<li><strong>日志分析得知，删除了t1表的，name&#x3D;王，这条数据</strong></li>
</ul>
<p><img src="/image-20240605194758148.png" alt="image-20240605194758148"></p>
<h3 id="3-3-查找丢失数据创建时的事件pos值"><a href="#3-3-查找丢失数据创建时的事件pos值" class="headerlink" title="3.3 查找丢失数据创建时的事件pos值"></a>3.3 查找丢失数据创建时的事件pos值</h3><blockquote>
<p>现在已经找到了，删除的内容为t1表下的<code>（name=王）</code>这条数据，创建的pos值761–1012</p>
<p>下一步根据创建事件的pos值，从binlog日志截取出，创建事件的日志，通过日志中sql语句进行恢复数据</p>
</blockquote>
<ul>
<li><strong>解密日志文件中查看，查找丢失数据在创建时，事务开时pos值与结束pos值</strong></li>
</ul>
<p><img src="/image-20240605200945330.png" alt="image-20240605200945330"></p>
<h2 id="4-截取日志恢复数据"><a href="#4-截取日志恢复数据" class="headerlink" title="4.截取日志恢复数据"></a>4.截取日志恢复数据</h2><h3 id="4-1-日志恢复原理"><a href="#4-1-日志恢复原理" class="headerlink" title="4.1 日志恢复原理"></a>4.1 日志恢复原理</h3><p>原理就是这个数据被删除，会在binlog生成事件，找到这个事件的pos值，日志解密后查找具体删除了什么数据</p>
<p>找到这个被删除的数据，那么这个数据在创建时也会生成一个创建事件，查找创建事件的开始pos值与结束pos值</p>
<p>通过创建事件的pos值，将创建事件的sql语句导出来，再通过这些创建数据sql语句进行导入数据库，实现数据恢复</p>
<h3 id="4-2-事件日志截取"><a href="#4-2-事件日志截取" class="headerlink" title="4.2 事件日志截取"></a>4.2 事件日志截取</h3><blockquote>
<p>截取某个事件日志语法： </p>
<p>mysqlbinlog   –start-position&#x3D;（事件开始pos值） –stop-position&#x3D;（结束pos值）  binlog日志   &gt;  导出文件</p>
</blockquote>
<ul>
<li><strong>导出要恢复的事件日志，开始pos值为761，结束pos值为1012</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--start-position=761 --stop-position=1012 /app/logs/mysql_log/mysql-bin.000004 &gt; recover.sql</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-关闭日志记录"><a href="#4-3-关闭日志记录" class="headerlink" title="4.3 关闭日志记录"></a>4.3 关闭日志记录</h3><blockquote>
<p>临时关闭binlog日志的记录，否则恢复数据时会添加新的事件记录，恢复数据后再打开日志记录</p>
</blockquote>
<ul>
<li>修改内置变量，临时关闭日志记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-丢失数据恢复"><a href="#4-3-丢失数据恢复" class="headerlink" title="4.3 丢失数据恢复"></a>4.3 丢失数据恢复</h3><ul>
<li>导入恢复数据的sql语句</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.sql;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>取消临时关闭日志</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>检查（name&#x3D;王数据）是否恢复</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#########数据恢复成功##########</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 赵东兴    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 乐佳杰    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 好一名    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 王        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<h1 id="binlog多个日志截取恢复（数据库误删）"><a href="#binlog多个日志截取恢复（数据库误删）" class="headerlink" title="binlog多个日志截取恢复（数据库误删）"></a><em>binlog</em>多个日志截取恢复（数据库误删）</h1><blockquote>
<p>进行全量备份时，每日会会binlog进行刷新创建，将每日事务分别记录到不同的binlog中</p>
<p>当事件分散存储在不同的binlog日志文件，发生数据丢失如何进行恢复数据 ？</p>
</blockquote>
<h2 id="1-场景模拟"><a href="#1-场景模拟" class="headerlink" title="1.场景模拟"></a>1.场景模拟</h2><blockquote>
<p>创建测试数据生成多个事务，主动flush.logs刷新binlog日志，将事务保存到不同的binlog</p>
<p>最后基于binlog日志分析截取丢失数据pos值，实现数据恢复。</p>
</blockquote>
<h3 id="1-1-日志1，mysql-bin-000001"><a href="#1-1-日志1，mysql-bin-000001" class="headerlink" title="1.1 日志1，mysql-bin.000001"></a>1.1 日志1，mysql-bin.000001</h3><ul>
<li>当前使用mysql-bin.000001日志，进行创建数据事务提交</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#创建数据库数据表生成事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database lol;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.tanke(name <span class="type">char</span>(<span class="number">10</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> lol;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_lol <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> tanke         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前使用的binlog与事务记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">481</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line">##生成的事件记录</span><br><span class="line">mysql<span class="operator">&gt;</span> mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000001&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">310</span> <span class="operator">|</span> <span class="keyword">create</span> database lol                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">310</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">375</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">375</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">481</span> <span class="operator">|</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.tanke(name <span class="type">char</span>(<span class="number">10</span>)) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#主动刷新生成新的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="1-2-日志2，mysql-bin-000002"><a href="#1-2-日志2，mysql-bin-000002" class="headerlink" title="1.2 日志2，mysql-bin.000002"></a>1.2 日志2，mysql-bin.000002</h3><ul>
<li>已刷新生成新的mysql-bin.000002日志，之后新增事务保存到binlog-02日志中</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#当前使用的新日志<span class="number">02</span>binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#写入数据，再次生成新事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lol.tanke <span class="keyword">value</span>(<span class="string">&#x27;盖伦&#x27;</span>),(<span class="string">&#x27;慎&#x27;</span>),(<span class="string">&#x27;石头人&#x27;</span>),(<span class="string">&#x27;日女&#x27;</span>),(<span class="string">&#x27;龙龟&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lol.tanke;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 盖伦      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 慎        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 石头人    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 日女      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 龙龟      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看<span class="number">02</span>日志事务提交记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000002&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">287</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">287</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">336</span> <span class="operator">|</span> table_id: <span class="number">223</span> (lol.tanke)             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">336</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">411</span> <span class="operator">|</span> table_id: <span class="number">223</span> flags: STMT_END_F       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">411</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">442</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=169 */</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#再次主动刷新创建新binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="1-3-日志3，mysql-bin-000003"><a href="#1-3-日志3，mysql-bin-000003" class="headerlink" title="1.3 日志3，mysql-bin.000003"></a>1.3 日志3，mysql-bin.000003</h3><ul>
<li>已刷新生成新的mysql-bin.000003日志，之后新增事务保存到binlog-03日志中</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">#当前使用的binlog日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#主动生成新事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.fashi(name <span class="type">char</span>(<span class="number">10</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lol.fashi <span class="keyword">value</span>(<span class="string">&#x27;光辉&#x27;</span>),(<span class="string">&#x27;阿卡丽&#x27;</span>),(<span class="string">&#x27;火男&#x27;</span>),(<span class="string">&#x27;小鱼人&#x27;</span>),(<span class="string">&#x27;卡牌&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前binlog日志pos值变化</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>      <span class="number">619</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog新增事务记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000003&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">325</span> <span class="operator">|</span> <span class="keyword">create</span> <span class="keyword">table</span> lol.fashi(name <span class="type">char</span>(<span class="number">10</span>)) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">325</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">390</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">390</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">458</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">458</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">507</span> <span class="operator">|</span> table_id: <span class="number">224</span> (lol.fashi)             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">507</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">588</span> <span class="operator">|</span> table_id: <span class="number">224</span> flags: STMT_END_F       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">588</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">619</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=178 */</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#再次刷新binlog，生成新日志文件</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="1-4-日志4，模拟误删除数据库lol"><a href="#1-4-日志4，模拟误删除数据库lol" class="headerlink" title="1.4 日志4，模拟误删除数据库lol"></a>1.4 日志4，模拟误删除数据库lol</h3><ul>
<li>已刷新生成了新mysql-bin.000004日志文件，再次写数据事务提交新日志中，并且模拟删除数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#写数据生成事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lol.fashi <span class="keyword">values</span>(<span class="string">&#x27;发条&#x27;</span>),(<span class="string">&#x27;吸血鬼&#x27;</span>),(<span class="string">&#x27;莫甘娜&#x27;</span>),(<span class="string">&#x27;大发明家&#x27;</span>),(<span class="string">&#x27;火女&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">5</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">5</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line">#查看事务新增</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">454</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看binlog事务记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000004&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">123</span> <span class="operator">|</span> Server ver: <span class="number">5.7</span><span class="number">.20</span><span class="operator">-</span>log, Binlog ver: <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">123</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">154</span> <span class="operator">|</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">154</span> <span class="operator">|</span> Anonymous_Gtid <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">219</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;ANONYMOUS&#x27;</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">219</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">287</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">287</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">336</span> <span class="operator">|</span> table_id: <span class="number">224</span> (lol.fashi)             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">336</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">423</span> <span class="operator">|</span> table_id: <span class="number">224</span> flags: STMT_END_F       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span> <span class="number">423</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">454</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=183 */</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----+----------------+-----------+-------------+---------------------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>模拟一不小心把lol库删除了</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#误删lol库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database lol;</span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除事务被记录到了binlog04日志中</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>      <span class="number">608</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="2-恢复实战"><a href="#2-恢复实战" class="headerlink" title="2.恢复实战"></a>2.恢复实战</h2><p>方案1：分段截取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--start-position</span><br><span class="line"></span><br><span class="line">--stop-position</span><br></pre></td></tr></table></figure>

<p>方案2：时间戳截取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1. 找创建lol库的时间戳</span><br></pre></td></tr></table></figure>

<h3 id="2-1-恢复思路图解"><a href="#2-1-恢复思路图解" class="headerlink" title="2.1 恢复思路图解"></a>2.1 恢复思路图解</h3><p><img src="/image-20240605210920147.png" alt="image-20240605210920147"></p>
<h3 id="2-2-恢复数据步骤"><a href="#2-2-恢复数据步骤" class="headerlink" title="2.2 恢复数据步骤"></a>2.2 恢复数据步骤</h3><p>思路：找到关于你要恢复的这个lol数据库，从创建该库，到删除lol之间的记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 基于开始的日志，找pos起点位置</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000003&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span> <span class="number">1860</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>        <span class="number">1951</span> <span class="operator">|</span> <span class="keyword">create</span> database lol                                                                                                                                                                                                             <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>基于事件，寻找删库的事件pos位置</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000006&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000006</span> <span class="operator">|</span> <span class="number">499</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">51</span> <span class="operator">|</span>         <span class="number">588</span> <span class="operator">|</span> <span class="keyword">drop</span> database lol  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 或者基于mysqlbinlog命令，分析二进制日志的 建库lol的时间，到删库之间所有的日志</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>]#mysqlbinlog <span class="comment">--start-position=1860 --stop-position=499 mysql-bin.000003 mysql-bin.000004 mysql-bin.000005 mysql-bin.000006 &gt; /tmp/restore-lol.sql</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>可以解密查看如上截取的日志，能找到最后的插入数据结果即可</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>]#mysqlbinlog <span class="comment">--base64-output=decode-rows -vv   --start-position=1860 --stop-position=499 mysql-bin.000003 mysql-bin.000004 mysql-bin.000005 mysql-bin.000006 &gt; restore-lol.log</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-查找删除事件"><a href="#2-3-查找删除事件" class="headerlink" title="2.3 查找删除事件"></a>2.3 查找删除事件</h3><ul>
<li>先判断误删操作到底删除了什么，再基于被删数据的创建事件，进行恢复</li>
<li>图中得出，删除了lol这个库的数据</li>
</ul>
<p><img src="/image-20240607105145555.png" alt="image-20240607105145555"></p>
<h3 id="2-4-解密导出所有binlog"><a href="#2-4-解密导出所有binlog" class="headerlink" title="2.4 解密导出所有binlog"></a>2.4 解密导出所有binlog</h3><p>因为被删的这个库，在创建时到被删前，中间提交的事务被分散保存到了多个binlog日志，所以需要导出全部binlog</p>
<p>导出后解密binlog，进行事务分析，被删数据在创建后，到被删之前，提交了哪些事务</p>
<p>最后根据lol库在创建时的开始pos值，与删除lol库的开始pos值，截取创建到删除前的日志，导出sql语句进行恢复数据</p>
<blockquote>
<p>解密导出所有binlog，编辑器分析查看</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前所有的binlog日志</span></span><br><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |       528 |</span><br><span class="line">| mysql-bin.000002 |       489 |</span><br><span class="line">| mysql-bin.000003 |       666 |</span><br><span class="line">| mysql-bin.000004 |       608 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入binlog存放目录，解密导出所有binlog</span></span><br><span class="line">[root@db-51 ~]#<span class="built_in">cd</span> /app/logs/mysql_log/</span><br><span class="line">[root@db-51 /app/logs/mysql_log]#mysqlbinlog --base64-output=decode-rows -vv  mysql-bin.000001 mysql-bin.000002 mysql-bin.000003 mysql-bin.000004 &gt; recover.log</span><br></pre></td></tr></table></figure>

<ul>
<li>lol库删除的开始pos值，也是上次事件结束pos值</li>
</ul>
<p><img src="/image-20240607113426280.png" alt="image-20240607113426280"></p>
<ul>
<li>lol库创建时的开始pos值</li>
</ul>
<p><img src="/image-20240607113800342.png" alt="image-20240607113800342"></p>
<h3 id="2-5-截取恢复数据binglog"><a href="#2-5-截取恢复数据binglog" class="headerlink" title="2.5 截取恢复数据binglog"></a>2.5 截取恢复数据binglog</h3><blockquote>
<p>语法：</p>
<p>mysqlbinlog  –start-position&#x3D;（事件开始pos值）  –stop-position&#x3D;（事件结束pos值）  binlog文件（如果截取多个binlog就写多个binlog文件即可）    &gt;  导出文件</p>
</blockquote>
<ul>
<li>截取（lol库创建开始pos值，到lol库删除开始pos值）之间的所有binlog日志，导出日志内容到文件</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--start-position=219 --stop-position=454 mysql-bin.000001 mysql-bin.000002 mysql-bin.000003 mysql-bin.000004 &gt; /root/recover.sql</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-恢复数据并检查"><a href="#2-5-恢复数据并检查" class="headerlink" title="2.5 恢复数据并检查"></a>2.5 恢复数据并检查</h3><ul>
<li>导入sql文件，并且检查数据是否恢复</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#将刚才截取的日志文件导入数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.sql</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">##########后面省略#######</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">from</span> lol;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_lol <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> fashi         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tanke         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lol.fashi;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="operator">|</span> name         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="operator">|</span> 光辉         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 阿卡丽       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 火男         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 小鱼人       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 卡牌         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 发条         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 吸血鬼       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 莫甘娜       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 大发明家     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 火女         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lol.tanke;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> 盖伦      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 慎        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 石头人    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 日女      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 龙龟      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h1 id="GTID与binglog应用"><a href="#GTID与binglog应用" class="headerlink" title="GTID与binglog应用"></a><em>GTID</em>与<em>binglog</em>应用</h1><blockquote>
<p>gitd是什么？ <em>全局事务标示符</em></p>
<p>就是给每个事务添加了一个实例唯一标识与事务的id值，可以根据事务对应的gtid恢复数据，无需再用肉眼判断事务的pos值去进行恢复。</p>
<p>可以用在主从复制架构中，主库数据基于binglog每个事务gtid，复制数据到从库上，减少了使用pos值复制时的容错率。</p>
</blockquote>
<p><strong>概述</strong></p>
<ul>
<li><p>从 MySQL 5.6.5 开始新增了一种基于 GTID 的复制方式</p>
</li>
<li><p>通过 GTID 保证了每个在主库上提交的事务在集群中有一个唯一的ID</p>
</li>
<li><p>这种方式强化了数据库的主备一致性，故障恢复以及容错能力</p>
</li>
<li><p>在原来基于二进制日志的复制中，从库需要告知主库要从哪个偏移量pos值进行增量同步，</p>
<p>如果指定<code>错误会造成数据的遗漏，从而造成数据的不一致。</code></p>
</li>
<li><p>借助GTID，在发生主备切换的情况下，MySQL的其它从库可以自动在新主库上找到正确的复制位置，</p>
<p><code>这大大简化了复杂复制拓扑下集群的维护</code>，也减少了人为设置复制位置发生误操作的风险。</p>
</li>
<li><p>另外，基于GTID的复制可以忽略已经执行过的事务，减少了数据发生不一致的风险。</p>
<p>​</p>
</li>
</ul>
<h2 id="1-GTID开启与使用"><a href="#1-GTID开启与使用" class="headerlink" title="1. GTID开启与使用"></a>1. GTID开启与使用</h2><blockquote>
<p>GTID默认是未开启状态，查询binlog事件记录，都是GTID_NEXT&#x3D; ‘ANONYMOUS（无名）’</p>
<p>当开启后，每个事件记录都会有，GTID的标识&#x3D;uuid+事件id（事件数量）</p>
</blockquote>
<p><img src="/image-20240607145137038.png" alt="image-20240607145137038"></p>
<ul>
<li><strong>开启GTID，配置文件添加如下参数</strong></li>
</ul>
<p><img src="/image-20240607145638708.png" alt="image-20240607145638708"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#具体配置如下</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">gtid<span class="operator">-</span>mode<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">enforce<span class="operator">-</span>gtid<span class="operator">-</span>consistency<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line"></span><br><span class="line">server_id<span class="operator">=</span><span class="number">51</span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">character_set_server<span class="operator">=</span>utf8mb4 </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mysql</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>data<span class="operator">/</span><span class="number">3306</span></span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">log<span class="operator">-</span>error<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>mysql<span class="operator">/</span>error_3306.log</span><br><span class="line">[mysql]</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line"></span><br><span class="line">#重启mysql</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#systemctl restart mysqld</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#netstat <span class="operator">-</span>tunlp<span class="operator">|</span>grep mysql</span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">3306</span>                 :::<span class="operator">*</span>                    LISTEN      <span class="number">51134</span><span class="operator">/</span>mysqld   </span><br></pre></td></tr></table></figure>

<ul>
<li><strong>检查GTID是否开启</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%GTID%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery      <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency         <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed_compression_period <span class="operator">|</span> <span class="number">1000</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span> #开启gtid</span><br><span class="line"><span class="operator">|</span> gtid_next                        <span class="operator">|</span> AUTOMATIC <span class="operator">|</span> #生成的事务都自动加上GTID</span><br><span class="line"><span class="operator">|</span> gtid_owned                       <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> session_track_gtids              <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+-----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#开启后自动刷新binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>新增数据生成新的事务</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">##################新增的事务#####################</span><br><span class="line">#当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">#创建数据库‘未来’</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database future;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#‘未来’库中创建数据表‘预知’添加字段‘发生的事’</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> future.foresee(发生的事 <span class="type">char</span>(<span class="number">15</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line">#‘未来’库中‘预知’数据表‘发生的事’字段下，插入未来在你身上发生的<span class="number">6</span>件事情</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> future.foresee <span class="keyword">value</span>(<span class="string">&#x27;未来你的父母身体健康后半辈子会一直享福&#x27;</span>),(<span class="string">&#x27;你的母亲在你30岁之前病好了不再吃药&#x27;</span>),(<span class="string">&#x27;你在30岁实现了自己的目标工资月入3w+&#x27;</span>),(<span class="string">&#x27;你会交到一个很爱你很完美的女朋 友在你30岁结婚了&#x27;</span>),(<span class="string">&#x27;你的未来会很幸福你的家庭父母爱人孩子&#x27;</span>),(<span class="string">&#x27;孩子也快乐平安长大&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">6</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">6</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">#查看未来预知在你身上发生的事</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋友在你<span class="number">30</span>岁结婚了                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福你的家庭父母爱人孩子                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>查看binlog事件记录查看事务提交的gtid</strong></li>
</ul>
<p><img src="/image-20240607161221091.png" alt="image-20240607161221091"></p>
<p><img src="/image-20240607161440264.png" alt="image-20240607161440264"></p>
<h2 id="2-GTID截取binlog与恢复"><a href="#2-GTID截取binlog与恢复" class="headerlink" title="2. GTID截取binlog与恢复"></a>2. GTID截取binlog与恢复</h2><blockquote>
<p>语法：</p>
<p>mysqlbinlog –skip-gtids  –include-gtids&#x3D;’uuid:事务id’   binlog文件   &gt; 输出文件</p>
<p>–skip-gtids：</p>
<p>导出日志信息时，事件生成新的GTID，不加该参数导出的事件会保留原gtid，到时候恢复数据时会和binlog中原有的gtid导致冲突</p>
</blockquote>
<h3 id="2-1-模拟删除恢复数据（单事件）"><a href="#2-1-模拟删除恢复数据（单事件）" class="headerlink" title="2.1 模拟删除恢复数据（单事件）"></a>2.1 模拟删除恢复数据（单事件）</h3><ul>
<li><strong>模拟删除数据，删除foresee表内所有信息</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#原数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋 友在你<span class="number">30</span>岁结婚了                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福你的家庭父母爱人孩子                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模拟误删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">truncate</span> future.foresee;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line">#数据没了</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>查找被删数据在创建时的事件gtid，通过gtid截取binlog</strong></li>
</ul>
<p><img src="/image-20240607165258107.png" alt="image-20240607165258107"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#进入binlog日志目录</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#指定丢失数据的事件gtid，与binlog日志文件，进行日志截取导出</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;f695ab86-2303-11ef-bf61-000c2939adaa:3&#x27; mysql-bin.000001 &gt; /root/recover.sql</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>临时关闭binlog记录，防止恢复记录写入</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>通过截取出的日志，导入数据库恢复数据</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#恢复数据</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.log;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">############恢复过程省略############</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋 友在你<span class="number">30</span>岁结婚了                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福你的家庭父母爱人孩子                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>恢复数据后开启binlog记录写入</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="2-2-模拟删除恢复数据（多个事件）"><a href="#2-2-模拟删除恢复数据（多个事件）" class="headerlink" title="2.2 模拟删除恢复数据（多个事件）"></a>2.2 模拟删除恢复数据（多个事件）</h3><blockquote>
<p>删除整个库，通过gtid截取多条日志，恢复数据</p>
</blockquote>
<ul>
<li><strong>模拟删除数据库</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database future;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line">ERROR <span class="number">1146</span> (<span class="number">42</span>S02): <span class="keyword">Table</span> <span class="string">&#x27;future.foresee&#x27;</span> doesn<span class="string">&#x27;t exist</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>binlog日志查找，被删的数据库，在创建时到删除前的所有事件</strong></li>
</ul>
<p><img src="/image-20240607171514159.png" alt="image-20240607171514159"></p>
<ul>
<li><strong>临时关闭binlog</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>通过库在删除前所有事件gtid，进行截取binlog</strong></li>
</ul>
<blockquote>
<p>695ab86-2303-11ef-bf61-000c2939adaa:1-3（事件id范围指定即可）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>app<span class="operator">/</span>logs<span class="operator">/</span>mysql_log]#mysqlbinlog <span class="comment">--skip-gtids --include-gtids=&#x27;f695ab86-2303-11ef-bf61-000c2939adaa:1-3&#x27; mysql-bin.000001 &gt; /root/recover.log</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>截取的binlog，导入数据库恢复数据</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>root<span class="operator">/</span>recover.log;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>检查恢复数据</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> future.foresee;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 发生的事                                                                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> 未来你的父母身体健康后半辈子会一直享福                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的母亲在你<span class="number">30</span>岁之前病好了不再吃药                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你在<span class="number">30</span>岁实现了自己的目标工资月入<span class="number">3</span>w<span class="operator">+</span>                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你会交到一个很爱你很完美的女朋友在你<span class="number">30</span>岁时候，你们结婚了                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 你的未来会很幸福，你的父母爱人孩子也都很幸福                                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孩子也快乐平安长大                                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">赵东兴</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE/">http://example.com/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93MYSQL-%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE/" title="数据库MYSQL-恢复数据"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">数据库MYSQL-恢复数据</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/19/hello-world/" title="Hello World"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">Hello World</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">赵东兴</div><div class="author-info__description">个人技术笔记博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">数据库数据备份恢复概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%BF%90%E7%BB%B4%E8%81%8C%E8%B4%A3"><span class="toc-number">1.1.</span> <span class="toc-text">1.运维职责</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%A4%87%E4%BB%BD%E6%96%B9%E6%A1%88"><span class="toc-number">1.2.</span> <span class="toc-text">2.备份方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mysqldump%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D"><span class="toc-number">2.</span> <span class="toc-text">mysqldump备份恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E8%BF%9E%E6%8E%A5%E5%8F%82%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">0.连接参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%85%A8%E9%87%8F%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="toc-number">2.2.</span> <span class="toc-text">1.全量与恢复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%A4%87%E4%BB%BD%E6%8C%87%E5%AE%9A%E5%BA%93"><span class="toc-number">2.3.</span> <span class="toc-text">2.备份指定库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%A4%87%E4%BB%BD%E6%8C%87%E5%AE%9A%E8%A1%A8"><span class="toc-number">2.4.</span> <span class="toc-text">3.备份指定表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%A4%87%E4%BB%BD%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">2.5.</span> <span class="toc-text">4.备份表结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%A4%87%E4%BB%BD%E8%A1%A8%E6%95%B0%E6%8D%AE"><span class="toc-number">2.6.</span> <span class="toc-text">4.备份表数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%A4%87%E4%BB%BD%E4%B8%94%E5%8E%8B%E7%BC%A9"><span class="toc-number">2.7.</span> <span class="toc-text">5.备份且压缩</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binlog%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97"><span class="toc-number">3.</span> <span class="toc-text">binlog二进制日志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BC%80%E5%90%AF%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD"><span class="toc-number">3.1.</span> <span class="toc-text">1.开启日志功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.2.</span> <span class="toc-text">2.日志记录格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">3.查看日志文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%88%B7%E6%96%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.</span> <span class="toc-text">4.刷新日志文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%B8%BB%E5%8A%A8%E7%94%9F%E6%88%90%E4%BA%8B%E5%8A%A1"><span class="toc-number">3.5.</span> <span class="toc-text">5.主动生成事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%9F%A5%E7%9C%8B%E4%BA%8B%E4%BB%B6%E8%AE%B0%E5%BD%95"><span class="toc-number">3.6.</span> <span class="toc-text">6.查看事件记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%97%A5%E5%BF%97%E8%A7%A3%E5%AF%86%E6%9F%A5%E7%9C%8B"><span class="toc-number">3.7.</span> <span class="toc-text">7.日志解密查看</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binlog%E6%97%A5%E5%BF%97%E6%88%AA%E5%8F%96%E6%81%A2%E5%A4%8D%EF%BC%88%E6%95%B0%E6%8D%AE%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%AF%AF%E5%88%A0%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">binlog日志截取恢复（数据表数据误删）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BC%80%E5%90%AFbinlog"><span class="toc-number">4.1.</span> <span class="toc-text">1.开启binlog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%A8%A1%E6%8B%9F%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="toc-number">4.2.</span> <span class="toc-text">2.模拟删除数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-binlog%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">4.3.</span> <span class="toc-text">3.binlog日志分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-binlog%E8%AE%B0%E5%BD%95%E6%9F%A5%E6%89%BE%E5%88%A0%E9%99%A4%E4%BA%8B%E4%BB%B6pos%E5%80%BC"><span class="toc-number">4.3.1.</span> <span class="toc-text">3.1 binlog记录查找删除事件pos值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E8%A7%A3%E5%AF%86binlog%E5%AE%9A%E4%BD%8D%E4%B8%A2%E5%A4%B1%E7%9A%84%E5%85%B7%E4%BD%93%E6%95%B0%E6%8D%AE"><span class="toc-number">4.3.2.</span> <span class="toc-text">3.2 解密binlog定位丢失的具体数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%9F%A5%E6%89%BE%E4%B8%A2%E5%A4%B1%E6%95%B0%E6%8D%AE%E5%88%9B%E5%BB%BA%E6%97%B6%E7%9A%84%E4%BA%8B%E4%BB%B6pos%E5%80%BC"><span class="toc-number">4.3.3.</span> <span class="toc-text">3.3 查找丢失数据创建时的事件pos值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%88%AA%E5%8F%96%E6%97%A5%E5%BF%97%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE"><span class="toc-number">4.4.</span> <span class="toc-text">4.截取日志恢复数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E6%97%A5%E5%BF%97%E6%81%A2%E5%A4%8D%E5%8E%9F%E7%90%86"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.1 日志恢复原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97%E6%88%AA%E5%8F%96"><span class="toc-number">4.4.2.</span> <span class="toc-text">4.2 事件日志截取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%85%B3%E9%97%AD%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="toc-number">4.4.3.</span> <span class="toc-text">4.3 关闭日志记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E4%B8%A2%E5%A4%B1%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="toc-number">4.4.4.</span> <span class="toc-text">4.3 丢失数据恢复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binlog%E5%A4%9A%E4%B8%AA%E6%97%A5%E5%BF%97%E6%88%AA%E5%8F%96%E6%81%A2%E5%A4%8D%EF%BC%88%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%AF%E5%88%A0%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">binlog多个日志截取恢复（数据库误删）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9C%BA%E6%99%AF%E6%A8%A1%E6%8B%9F"><span class="toc-number">5.1.</span> <span class="toc-text">1.场景模拟</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%97%A5%E5%BF%971%EF%BC%8Cmysql-bin-000001"><span class="toc-number">5.1.1.</span> <span class="toc-text">1.1 日志1，mysql-bin.000001</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%97%A5%E5%BF%972%EF%BC%8Cmysql-bin-000002"><span class="toc-number">5.1.2.</span> <span class="toc-text">1.2 日志2，mysql-bin.000002</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E6%97%A5%E5%BF%973%EF%BC%8Cmysql-bin-000003"><span class="toc-number">5.1.3.</span> <span class="toc-text">1.3 日志3，mysql-bin.000003</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%97%A5%E5%BF%974%EF%BC%8C%E6%A8%A1%E6%8B%9F%E8%AF%AF%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93lol"><span class="toc-number">5.1.4.</span> <span class="toc-text">1.4 日志4，模拟误删除数据库lol</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%81%A2%E5%A4%8D%E5%AE%9E%E6%88%98"><span class="toc-number">5.2.</span> <span class="toc-text">2.恢复实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%81%A2%E5%A4%8D%E6%80%9D%E8%B7%AF%E5%9B%BE%E8%A7%A3"><span class="toc-number">5.2.1.</span> <span class="toc-text">2.1 恢复思路图解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.2.2.</span> <span class="toc-text">2.2 恢复数据步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%9F%A5%E6%89%BE%E5%88%A0%E9%99%A4%E4%BA%8B%E4%BB%B6"><span class="toc-number">5.2.3.</span> <span class="toc-text">2.3 查找删除事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E8%A7%A3%E5%AF%86%E5%AF%BC%E5%87%BA%E6%89%80%E6%9C%89binlog"><span class="toc-number">5.2.4.</span> <span class="toc-text">2.4 解密导出所有binlog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E6%88%AA%E5%8F%96%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AEbinglog"><span class="toc-number">5.2.5.</span> <span class="toc-text">2.5 截取恢复数据binglog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE%E5%B9%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">5.2.6.</span> <span class="toc-text">2.5 恢复数据并检查</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GTID%E4%B8%8Ebinglog%E5%BA%94%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">GTID与binglog应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-GTID%E5%BC%80%E5%90%AF%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">6.1.</span> <span class="toc-text">1. GTID开启与使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-GTID%E6%88%AA%E5%8F%96binlog%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="toc-number">6.2.</span> <span class="toc-text">2. GTID截取binlog与恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%A8%A1%E6%8B%9F%E5%88%A0%E9%99%A4%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE%EF%BC%88%E5%8D%95%E4%BA%8B%E4%BB%B6%EF%BC%89"><span class="toc-number">6.2.1.</span> <span class="toc-text">2.1 模拟删除恢复数据（单事件）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%A8%A1%E6%8B%9F%E5%88%A0%E9%99%A4%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE%EF%BC%88%E5%A4%9A%E4%B8%AA%E4%BA%8B%E4%BB%B6%EF%BC%89"><span class="toc-number">6.2.2.</span> <span class="toc-text">2.2 模拟删除恢复数据（多个事件）</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92/" title="容器Docker-单机编排">容器Docker-单机编排</a><time datetime="2024-08-20T01:32:01.000Z" title="Created 2024-08-20 09:32:01">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/" title="容器Docker-部署应用">容器Docker-部署应用</a><time datetime="2024-08-20T01:31:48.000Z" title="Created 2024-08-20 09:31:48">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/" title="容器Docker-镜像构建">容器Docker-镜像构建</a><time datetime="2024-08-20T01:31:29.000Z" title="Created 2024-08-20 09:31:29">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8/" title="容器Docker-网络存储">容器Docker-网络存储</a><time datetime="2024-08-20T01:31:14.000Z" title="Created 2024-08-20 09:31:14">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/" title="容器Docker-安装部署">容器Docker-安装部署</a><time datetime="2024-08-20T01:31:00.000Z" title="Created 2024-08-20 09:31:00">2024-08-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 赵东兴</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>