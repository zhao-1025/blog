<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>容器Docker-镜像构建 | 一往无前虎山行,拨开云雾见光明</title><meta name="author" content="赵东兴"><meta name="copyright" content="赵东兴"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、dockerfile原理1.镜像构建与提交的区别 dockerfile和commit区别  1.1 可重复性 场景：假设您有一个Web应用程序，它依赖于特定的软件版本和配置。如果您使用Dockerfile来构建镜像，那么每次运行docker build时，都会根据Dockerfile中的指令精确地安装这些依赖项和配置，确保每次构建的镜像都是相同的。  对比：如果您直接操作一个运行中的容器并安装">
<meta property="og:type" content="article">
<meta property="og:title" content="容器Docker-镜像构建">
<meta property="og:url" content="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/index.html">
<meta property="og:site_name" content="一往无前虎山行,拨开云雾见光明">
<meta property="og:description" content="一、dockerfile原理1.镜像构建与提交的区别 dockerfile和commit区别  1.1 可重复性 场景：假设您有一个Web应用程序，它依赖于特定的软件版本和配置。如果您使用Dockerfile来构建镜像，那么每次运行docker build时，都会根据Dockerfile中的指令精确地安装这些依赖项和配置，确保每次构建的镜像都是相同的。  对比：如果您直接操作一个运行中的容器并安装">
<meta property="og:locale">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-08-20T01:31:29.000Z">
<meta property="article:modified_time" content="2024-08-20T03:05:20.574Z">
<meta property="article:author" content="赵东兴">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '容器Docker-镜像构建',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-20 11:05:20'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="一往无前虎山行,拨开云雾见光明" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="一往无前虎山行,拨开云雾见光明"><span class="site-name">一往无前虎山行,拨开云雾见光明</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">容器Docker-镜像构建</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-08-20T01:31:29.000Z" title="Created 2024-08-20 09:31:29">2024-08-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-08-20T03:05:20.574Z" title="Updated 2024-08-20 11:05:20">2024-08-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="容器Docker-镜像构建"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、dockerfile原理"><a href="#一、dockerfile原理" class="headerlink" title="一、dockerfile原理"></a>一、dockerfile原理</h1><h2 id="1-镜像构建与提交的区别"><a href="#1-镜像构建与提交的区别" class="headerlink" title="1.镜像构建与提交的区别"></a>1.镜像构建与提交的区别</h2><blockquote>
<p>dockerfile和commit区别</p>
</blockquote>
<h3 id="1-1-可重复性"><a href="#1-1-可重复性" class="headerlink" title="1.1 可重复性"></a>1.1 可重复性</h3><ul>
<li><p><strong>场景：</strong>假设您有一个Web应用程序，它依赖于特定的软件版本和配置。如果您使用Dockerfile来构建镜像，那么每次运行<code>docker build</code>时，都会根据Dockerfile中的指令精确地安装这些依赖项和配置，确保每次构建的镜像都是相同的。</p>
</li>
<li><p><strong>对比：</strong>如果您直接操作一个运行中的容器并安装所需的软件，然后提交为镜像，那么下一次在不同的环境或时间点上重复这个过程时，可能会因为环境差异（如不同的包管理器版本、网络状态等）导致安装的软件版本或配置有所不同。</p>
</li>
</ul>
<h3 id="1-2-版本控制"><a href="#1-2-版本控制" class="headerlink" title="1.2 版本控制"></a>1.2 版本控制</h3><ul>
<li><strong>场景</strong>：在开发过程中，您可能需要频繁地更改镜像的构建步骤或依赖项。使用Dockerfile，您可以轻松地将其提交到Git等版本控制系统，这样团队成员就可以查看每次更改的历史，并理解为什么进行这些更改。</li>
<li><strong>对比</strong>：如果您直接提交容器为镜像，并且没有记录这些更改的文档或日志，那么追踪和理解这些更改将变得非常困难。</li>
</ul>
<h3 id="1-3-可透明性"><a href="#1-3-可透明性" class="headerlink" title="1.3 可透明性"></a>1.3 可透明性</h3><ul>
<li><strong>场景</strong>：当您需要将镜像部署到生产环境时，运维团队需要了解镜像中包含了哪些软件和配置。通过查看Dockerfile，他们可以清楚地看到所有构建步骤和依赖项。</li>
<li><strong>对比</strong>：直接提交的镜像则像是一个“黑盒”，除非通过容器内部查看或使用特定工具进行分析，否则很难了解镜像的具体内容。</li>
</ul>
<h3 id="1-4-利于理解与维护"><a href="#1-4-利于理解与维护" class="headerlink" title="1.4 利于理解与维护"></a>1.4 利于理解与维护</h3><ul>
<li><strong>场景</strong>：随着时间的推移，您的应用程序可能需要更新或修复依赖项。使用Dockerfile，您可以轻松地更新构建步骤，并重新构建镜像。</li>
<li><strong>对比</strong>：对于直接提交的镜像，更新或修复可能需要重新执行一系列复杂的操作，而这些操作可能不容易被团队成员理解和记忆。</li>
</ul>
<h3 id="1-5-自动化"><a href="#1-5-自动化" class="headerlink" title="1.5 自动化"></a>1.5 自动化</h3><ul>
<li><strong>场景</strong>：在CI&#x2F;CD流程中，您可能希望在每次代码提交时自动构建和测试Docker镜像。使用Dockerfile，您可以轻松地将构建步骤集成到自动化工具中。</li>
<li><strong>对比</strong>：直接提交的镜像可能难以与自动化工具集成，因为它们的构建过程通常更加复杂和不可预测。</li>
</ul>
<h3 id="1-6-总结"><a href="#1-6-总结" class="headerlink" title="1.6 总结"></a>1.6 总结</h3><p><strong>Dockerfile</strong>更适合用于生产环境和长期开发，因为它提供了更高的透明度、可维护性和一致性。通过Dockerfile构建的镜像具有可重复性、可追溯性和资源优化的特点。</p>
<p><strong>Docker commit</strong>更适合临时性地捕获容器状态作为新的镜像。然而，在需要长期维护和更新的场景下，使用Dockerfile是更推荐的做法。</p>
<p>在实际应用中，建议优先考虑使用Dockerfile来构建和管理Docker镜像，以充分利用其提供的自动化、可重复性和可追溯性等优势。</p>
<p>Dockerfile提供了一种结构化和可预测的方式来构建Docker镜像，从而提高了构建过程的可重复性、透明性、易于理解和维护性。它还支持 <code>版本控制</code> 和 <code>自动化流程</code> ，这些特性对于在开发、测试和生产环境中管理Docker镜像至关重要。相比之下，直接提交Docker镜像虽然可能在某些情况下更快捷，但长期来看会带来一系列的问题和限制。</p>
<h2 id="2-docker镜像构建缓存机制"><a href="#2-docker镜像构建缓存机制" class="headerlink" title="2.docker镜像构建缓存机制"></a>2.docker镜像构建缓存机制</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune #清理缓存</span><br></pre></td></tr></table></figure>

<p>在Docker镜像构建的上下文中，缓存机制的工作原理如下：</p>
<ol>
<li><strong>依赖检查</strong>：当Docker开始构建一个镜像时，它会首先读取Dockerfile中的指令。Dockerfile是一个文本文件，包含了一系列用于定义如何构建Docker镜像的命令。Docker会按顺序执行这些指令。</li>
<li><strong>缓存查找</strong>：对于Dockerfile中的每一条指令，Docker都会检查是否已经有一个之前的构建步骤（使用相同的指令和参数）生成的缓存层。这是通过比较当前指令及其依赖（如之前的指令的输出）与缓存中的层来实现的。</li>
<li><strong>使用缓存</strong>：如果Docker找到匹配的缓存层，它将直接使用这个缓存层，而不是执行当前指令并生成一个新的层。这意味着如果Dockerfile中的大部分指令都没有变化，只有少数几个指令被修改或添加，那么Docker将能够重用大部分缓存层，从而显著减少构建时间。</li>
<li><strong>缓存失效</strong>：如果Dockerfile中的任何指令或其依赖（如一个被COPY或ADD指令引入的文件）发生了变化，那么Docker将认为之前的缓存层不再有效，并会从头开始执行该指令及其后续指令，同时生成新的缓存层。</li>
</ol>
<p>缓存机制在Docker镜像构建中非常有用，因为它可以大幅减少构建时间，特别是在基础镜像较大或Dockerfile包含多个复杂步骤时。然而，它也引入了潜在的复杂性，因为开发者需要了解如何有效地利用缓存来优化他们的构建过程。</p>
<p>总结来说，缓存是Docker镜像构建过程中的一个重要特性，它通过存储和重用之前构建步骤的结果来加速构建过程。</p>
<h2 id="3-dockerfile二次指定jdk变量"><a href="#3-dockerfile二次指定jdk变量" class="headerlink" title="3.dockerfile二次指定jdk变量"></a>3.dockerfile二次指定jdk变量</h2><p><strong>dockerfile中拷贝的profile已经定义了java环境变量为啥构建时还要用ENV指令再指定一次环境变量</strong></p>
<p>在你的Dockerfile中，你确实已经通过<code>COPY</code>指令将包含Java环境变量配置的<code>profile</code>文件复制到了容器的<code>/etc/profile</code>位置。这个文件通常会在容器启动时由shell（如bash）读取，并设置相应的环境变量。然而，这种做法有几个潜在的问题和考虑点，这解释了为什么Dockerfile中还会使用<code>ENV</code>指令来定义环境变量：</p>
<ol>
<li><strong>环境变量加载时机</strong>：<ul>
<li><code>COPY profile /etc/profile</code>：这个操作是将文件复制到容器内，但并不意味着这些环境变量会立即被设置。它们会在用户登录或启动一个新的shell进程时（通常是bash或sh），通过读取<code>/etc/profile</code>（或其他如<code>.bashrc</code>、<code>.bash_profile</code>等文件）来设置。</li>
<li><code>ENV</code>指令：在Dockerfile中使用<code>ENV</code>指令设置的环境变量，会在构建镜像的每一步中都可用，并且这些变量会被直接注入到运行容器时创建的环境变量中，不需要通过shell启动脚本来加载。</li>
</ul>
</li>
<li><strong>容器运行时的环境</strong>：<ul>
<li>当容器以非交互式模式运行时（如直接运行Java应用程序），可能不会启动shell来读取<code>/etc/profile</code>，因此通过<code>profile</code>设置的环境变量可能不会被应用。</li>
<li>使用<code>ENV</code>指令定义的环境变量，无论容器如何启动，都会生效。</li>
</ul>
</li>
<li><strong>Docker镜像的最佳实践</strong>：<ul>
<li>使用<code>ENV</code>指令来设置环境变量是Docker镜像构建中的常见做法，因为它清晰、直接，且确保了环境变量在所有情况下都能被正确设置。</li>
</ul>
</li>
<li><strong>避免重复和混淆</strong>：<ul>
<li>虽然你的<code>profile</code>文件中也定义了环境变量，但使用<code>ENV</code>指令再次定义可以确保这些变量在任何情况下都被正确设置，减少了因配置不一致或遗漏导致的潜在问题。</li>
</ul>
</li>
</ol>
<p>综上所述，虽然你在<code>profile</code>中定义了Java环境变量，但在Dockerfile中使用<code>ENV</code>指令再次定义这些变量并不是多余的，而是为了确保这些变量在容器中以最可靠和一致的方式被设置。这有助于提高Docker镜像的健壮性和可移植性。</p>
<h1 id="二、dockerfile指令"><a href="#二、dockerfile指令" class="headerlink" title="二、dockerfile指令"></a>二、dockerfile指令</h1><h2 id="1-run指令"><a href="#1-run指令" class="headerlink" title="1.run指令"></a>1.run指令</h2><p>在Dockerfile中，<code>RUN</code> 指令用于在镜像构建过程中执行命令。理解为什么有时在<code>RUN</code>指令中使用<code>&amp;&amp;</code>以及何时不使用它，有助于更有效地编写Dockerfiles并优化镜像构建过程。</p>
<h3 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h3><p><code>RUN</code> 指令后面跟随的是要在镜像中执行的命令。每次<code>RUN</code>执行后，Docker都会创建一个新的镜像层，并将结果提交为镜像的一部分。这意味着，如果多个<code>RUN</code>指令修改了同一个文件或目录，那么每个修改都会作为单独的一层存储在镜像中。</p>
<h3 id="1-2-为什么使用"><a href="#1-2-为什么使用" class="headerlink" title="1.2 为什么使用 &amp;&amp;"></a>1.2 为什么使用 &amp;&amp;</h3><blockquote>
<p>在<code>RUN</code>指令中使用<code>&amp;&amp;</code>主要是为了链式执行多个命令，并在单个<code>RUN</code>步骤中完成。这样做的优点包括：</p>
</blockquote>
<p><strong>1.减少镜像层数：</strong></p>
<p>通过将多个命令合并为一个<code>RUN</code>指令，可以减少镜像中的层数。因为每个<code>RUN</code>指令都会创建一个新的层，减少层数有助于减小镜像大   小，并可能提高构建速度。</p>
<p><strong>2.依赖关系：</strong></p>
<p>当命令之间存在依赖关系时（即后一个命令需要前一个命令的输出或状态），使用<code>&amp;&amp;</code>可以确保这些命令按顺序正确执行。</p>
<p><strong>3.简化Dockerfile：</strong></p>
<p>通过减少<code>RUN</code>指令的数量，可以使Dockerfile更加简洁易读。</p>
<p><strong>示例</strong></p>
<p>不使用<code>&amp;&amp;</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DockerfileRUN apt-get updateRUN apt-get install -y nginx </span><br></pre></td></tr></table></figure>

<p>在这个例子中，有两个<code>RUN</code>指令，分别更新了apt包索引并安装了nginx。这会导致镜像中有两个层，每个层都包含了上一步的输出。</p>
<p>使用<code>&amp;&amp;</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DockerfileRUN apt-get update &amp;&amp; apt-get install -y nginx </span><br></pre></td></tr></table></figure>

<p>这里，<code>apt-get update</code>和<code>apt-get install -y nginx</code>被合并为一个<code>RUN</code>指令，使用<code>&amp;&amp;</code>确保<code>apt-get update</code>成功执行后才执行<code>apt-get install -y nginx</code>。这样，所有的更改都被包含在同一个层中。</p>
<h3 id="1-3-何时不使用"><a href="#1-3-何时不使用" class="headerlink" title="1.3 何时不使用 &amp;&amp;"></a>1.3 何时不使用 &amp;&amp;</h3><p>虽然使用<code>&amp;&amp;</code>通常是一个好习惯，但在某些情况下，你可能希望将命令分开到不同的<code>RUN</code>指令中：</p>
<ul>
<li><strong>提高可读性</strong>：如果命令链非常长或复杂，将其拆分为多个<code>RUN</code>指令可以提高Dockerfile的可读性。</li>
<li><strong>缓存优化</strong>：Docker会缓存<code>RUN</code>指令的输出。如果某个<code>RUN</code>指令中的命令很多，但其中只有一小部分经常变化，将它们分开到不同的<code>RUN</code>指令中可能有助于更有效地利用缓存。</li>
</ul>
<p>总的来说，是否使用<code>&amp;&amp;</code>取决于你的具体需求，包括你对镜像大小的关注、对构建时间的考虑，以及你希望如何组织Dockerfile中的命令。</p>
<h2 id="2-cmd指令"><a href="#2-cmd指令" class="headerlink" title="2.cmd指令"></a>2.cmd指令</h2><h2 id="3-volume指令"><a href="#3-volume指令" class="headerlink" title="3.volume指令"></a>3.volume指令</h2><p>在Docker的上下文中，<code>Dockerfile</code>中的<code>VOLUME</code>指令和<code>docker run -v</code>命令虽然都用于处理卷（volumes），但它们的使用场景和目的有所不同。理解这些差异有助于你更好地决定在何时使用哪种方法。</p>
<h3 id="3-1-Dockerfile的VOLUME指令"><a href="#3-1-Dockerfile的VOLUME指令" class="headerlink" title="3.1 Dockerfile的VOLUME指令"></a>3.1 Dockerfile的VOLUME指令</h3><p>在<code>Dockerfile</code>中使用<code>VOLUME</code>指令时，你实际上是在声明容器运行时应该有哪些挂载点（mount points）被保留为卷。这意味着，当你基于这个<code>Dockerfile</code>构建并运行容器时，Docker会自动为这些指定的目录创建卷（如果它们还不存在的话），并且这些卷独立于容器的生命周期。即使容器被删除，卷中的数据也会保留下来，除非显式地删除卷。</p>
<p>使用<code>VOLUME</code>指令的主要好处包括：</p>
<p><strong>数据持久化</strong>：确保即使容器被删除，重要数据也能被保留。</p>
<p><strong>数据共享</strong>：允许多个容器之间共享数据。</p>
<p><strong>分离容器与数据</strong>：增强容器的可移植性和重用性，因为你可以轻松地将数据卷挂载到不同的容器上。</p>
<p>然而，<code>VOLUME</code>指令也有其局限性：</p>
<ul>
<li>它不能指定宿主机上的具体路径，只能指定容器内的路径。实际的挂载点（宿主机上的路径）是在容器运行时由Docker自动管理的。</li>
<li>灵活性较低，因为所有基于该<code>Dockerfile</code>构建的容器都将具有相同的卷配置。</li>
</ul>
<h3 id="3-2-docker-run-v命令"><a href="#3-2-docker-run-v命令" class="headerlink" title="3.2 docker run -v命令"></a>3.2 docker run -v命令</h3><p>相比之下，<code>docker run -v</code>（或其等价命令<code>docker run --mount type=volume,...</code>）在容器运行时动态地挂载卷。这使得你能够指定宿主机上的具体路径以及容器内的挂载点。这种方法提供了更高的灵活性，允许你为每个容器定制不同的卷配置。</p>
<p>使用<code>docker run -v</code>的主要好处包括：</p>
<ol>
<li><strong>灵活性</strong>：能够针对每个容器单独指定卷配置。</li>
<li><strong>明确性</strong>：可以清楚地知道宿主机和容器之间的映射关系。</li>
</ol>
<p>然而，它也有其缺点，比如：</p>
<ul>
<li>每次运行容器时都需要手动指定卷配置，这可能会增加管理的复杂性。</li>
<li>如果不在<code>docker run</code>命令中指定卷，则不会自动创建和挂载卷（除非在<code>Dockerfile</code>中定义了<code>VOLUME</code>）。</li>
</ul>
<h3 id="3-3-结论"><a href="#3-3-结论" class="headerlink" title="3.3 结论"></a>3.3 结论</h3><p>因此，是否在<code>Dockerfile</code>中定义<code>VOLUME</code>或在<code>docker run</code>时指定<code>-v</code>，取决于你的具体需求。如果你希望所有基于该<code>Dockerfile</code>构建的容器都具有相同的卷配置，那么在<code>Dockerfile</code>中定义<code>VOLUME</code>是一个不错的选择。如果你需要为不同的容器定制不同的卷配置，或者想要在运行时动态地挂载卷，那么使用<code>docker run -v</code>会更合适。在实际应用中，通常会根据具体情况灵活选择使用这两种方法.</p>
<h2 id="4-workdir指令"><a href="#4-workdir指令" class="headerlink" title="4.workdir指令"></a>4.workdir指令</h2><p><code>Dockerfile</code> 中的 <code>WORKDIR</code> 指令用于为后续的 <code>RUN</code>、<code>CMD</code>、<code>ENTRYPOINT</code>、<code>COPY</code> 和 <code>ADD</code> 指令设置工作目录（working directory）。这一指令的工作原理以及为什么选择使用相对路径而非绝对路径，可以从以下几个方面来理解：</p>
<p><strong>1.灵活性和可移植性</strong></p>
<p>使用 <code>WORKDIR</code> 指令时，你设置的是一个相对当前镜像层或基础镜像的目录作为工作目录。这种方式提供了更高的灵活性和可移植性。因为当你基于不同的基础镜像构建时，这些基础镜像的根目录结构可能有所不同。通过使用 <code>WORKDIR</code> 设定一个相对路径，你的 <code>Dockerfile</code> 就能更容易地适应不同的基础镜像，而无需修改硬编码的绝对路径。</p>
<p><strong>2. 镜像层优化</strong></p>
<p>Docker 镜像的构建是通过在基础镜像上叠加新的层来实现的。<code>WORKDIR</code> 指令确保了后续的指令（如 <code>RUN</code>、<code>CMD</code> 等）都在这个工作目录下执行。如果 <code>WORKDIR</code> 指向的目录在镜像中不存在，Docker 会自动创建它。这有助于减少镜像层的数量，因为所有在该工作目录下执行的命令都将共享同一个镜像层，而不是每个命令都创建一个新的层。</p>
<p><strong>3. 简化构建过程</strong></p>
<p>在 <code>Dockerfile</code> 中使用 <code>WORKDIR</code> 可以减少在每个需要执行命令的地方都指定完整路径的需要。这不仅可以使 <code>Dockerfile</code> 看起来更简洁，而且减少了出错的可能性，因为你不需要记住每个命令的完整路径。</p>
<p><strong>4. 为什么不直接使用绝对路径？</strong></p>
<p>尽管技术上你可以在 <code>Dockerfile</code> 中使用绝对路径（例如 <code>/usr/src/app</code>），但这通常不是最佳实践。使用绝对路径可能会使你的 <code>Dockerfile</code> 依赖于特定的基础镜像结构，这可能会降低其可移植性和灵活性。此外，如果基础镜像的目录结构发生变化，使用绝对路径的 <code>Dockerfile</code> 可能会突然无法工作，因为它们无法找到预期的目录。</p>
<p><strong>结论</strong></p>
<p>综上所述，<code>WORKDIR</code> 指令通过提供灵活性和可移植性，以及优化镜像层的构建，是 <code>Dockerfile</code> 中一个非常重要的指令。通过使用相对路径而不是绝对路径，你可以编写出更加健壮、易于维护和可移植的 <code>Dockerfile</code>。</p>
<h2 id="5-entrypoint指令"><a href="#5-entrypoint指令" class="headerlink" title="5.entrypoint指令"></a>5.entrypoint指令</h2><h1 id="三、dockerfile镜像构建"><a href="#三、dockerfile镜像构建" class="headerlink" title="三、dockerfile镜像构建"></a>三、dockerfile镜像构建</h1><blockquote>
<p>构建镜像时，物料需在与Dockerfile文件同层目录，构建书写文件名时必须是vim &#x3D;&#x3D;D(大写)&#x3D;&#x3D;ockerfile</p>
</blockquote>
<h2 id="1-centos-nginx镜像构建-run-v创建卷"><a href="#1-centos-nginx镜像构建-run-v创建卷" class="headerlink" title="1.centos+nginx镜像构建(run-v创建卷)"></a>1.centos+nginx镜像构建(run-v创建卷)</h2><h3 id="书写dockerfile构建镜像"><a href="#书写dockerfile构建镜像" class="headerlink" title="书写dockerfile构建镜像"></a>书写dockerfile构建镜像</h3><p><strong>dockerfile存放目录与所需物料准备</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#存放dockerfile目录</span></span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#<span class="built_in">pwd</span></span><br><span class="line">/dockerfile/centos-nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备了一个163的yum源给镜像提供</span></span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#curl -o  ./CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 root root 2523 Jul 28 11:25 CentOS-Base.repo</span><br></pre></td></tr></table></figure>

<p><strong>dockerfile书写</strong></p>
<blockquote>
<p>注意cmd指令后方加上 <code>分号</code>，否则无法启动容器</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/dockerfile/centos-nginx/Dockerfile &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#基于 CentOS 7.9.2009 镜像</span></span><br><span class="line">FROM centos:7.9.2009</span><br><span class="line"></span><br><span class="line"><span class="comment">#清理原有的 yum 仓库配置</span></span><br><span class="line">RUN <span class="built_in">rm</span> -f /etc/yum.repos.d/*</span><br><span class="line"></span><br><span class="line"><span class="comment">#复制自定义的 yum 仓库配置</span></span><br><span class="line">COPY *.repo /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装 EPEL 仓库和 Nginx</span></span><br><span class="line">RUN yum install epel-release -y \</span><br><span class="line">    &amp;&amp; yum install nginx -y \</span><br><span class="line">    &amp;&amp; yum clean all</span><br><span class="line"></span><br><span class="line"><span class="comment">#暴露 80 端口</span></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置容器启动时运行 Nginx</span></span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>构建镜像并且查看构建结果</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#命令构建</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx]#docker build <span class="operator">-</span>t centos<span class="operator">-</span>nginx<span class="operator">-</span>v1 .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">centos<span class="operator">-</span>nginx<span class="operator">-</span>v1   latest    c8d1b7edda3d   About a <span class="keyword">minute</span> ago   <span class="number">262</span>MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看构建步骤</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history c8d</span><br><span class="line">IMAGE          CREATED              CREATED <span class="keyword">BY</span>                                      SIZE      COMMENT</span><br><span class="line">c8d1b7edda3d   About a <span class="keyword">minute</span> ago   CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon off&quot;]                 <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      About a <span class="keyword">minute</span> ago   EXPOSE map[<span class="number">80</span><span class="operator">/</span>tcp:&#123;&#125;]                           <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      About a <span class="keyword">minute</span> ago   RUN <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c yum install epel<span class="operator">-</span><span class="keyword">release</span> <span class="operator">-</span>y <span class="operator">&amp;</span>…   <span class="number">57.9</span>MB    buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">4</span> minutes ago        <span class="keyword">COPY</span> <span class="operator">*</span>.repo <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="operator">/</span> # buildkit        <span class="number">2.52</span>kB    buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">12</span> minutes ago       RUN <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c rm <span class="operator">-</span>f <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="comment">/* # bu…   0B        buildkit.dockerfile.v0</span></span><br><span class="line"><span class="comment">&lt;missing&gt;      2 years ago          /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span></span><br><span class="line"><span class="comment">&lt;missing&gt;      2 years ago          /bin/sh -c #(nop)  LABEL org.label-schema.sc…   0B        </span></span><br><span class="line"><span class="comment">&lt;missing&gt;      2 years ago          /bin/sh -c #(nop) ADD file:b3ebbe8bd304723d4…   204MB   </span></span><br></pre></td></tr></table></figure>

<h3 id="运行容器不-v挂载查看卷信息"><a href="#运行容器不-v挂载查看卷信息" class="headerlink" title="运行容器不-v挂载查看卷信息"></a>运行容器不-v挂载查看卷信息</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#基于镜像运行容器</span><br><span class="line">docker run <span class="operator">-</span>d <span class="comment">--name test-nginx --rm -P e37d636bffd4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看容器的详细信息中的卷mounts信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect <span class="number">1637</span><span class="operator">|</span>jq</span><br><span class="line">    &quot;Mounts&quot;: [],</span><br><span class="line">    &quot;Config&quot;: &#123;</span><br><span class="line">      &quot;Hostname&quot;: &quot;1637a689a2ea&quot;,</span><br><span class="line">      &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">      &quot;User&quot;: &quot;&quot;,</span><br><span class="line">      &quot;AttachStdin&quot;: <span class="literal">false</span>,</span><br><span class="line">      &quot;AttachStdout&quot;: <span class="literal">false</span>,</span><br><span class="line">      &quot;AttachStderr&quot;: <span class="literal">false</span>,</span><br><span class="line">      &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">        &quot;80/tcp&quot;: &#123;&#125;</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="运行容器-v挂载查看卷信息"><a href="#运行容器-v挂载查看卷信息" class="headerlink" title="运行容器-v挂载查看卷信息"></a>运行容器-v挂载查看卷信息</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#手动运行容器时进行<span class="operator">-</span>v卷的挂载</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d <span class="comment">--name test-ngin-v1  --rm -P  -v /containel-volume/centos-nginx/logs:/var/log/nginx/ e37d636bffd4</span></span><br><span class="line"><span class="number">4</span>f0ab520970cf0a206f5d92857e642baafc4fcf14e460558b958556fe601bf5b</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ls <span class="operator">/</span>containel<span class="operator">-</span>volume<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">/</span>logs<span class="operator">/</span></span><br><span class="line">access.log  error.log</span><br><span class="line"></span><br><span class="line">#查看容器进程信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                     NAMES</span><br><span class="line"><span class="number">4</span>f0ab520970c   e37d636bffd4   &quot;nginx -g &#x27;daemon of…&quot;   <span class="number">6</span> minutes ago    Up <span class="number">6</span> minutes    <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">32773</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">32773</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp   test<span class="operator">-</span>ngin<span class="operator">-</span>v1</span><br><span class="line"><span class="number">1637</span>a689a2ea   e37d636bffd4   &quot;nginx -g &#x27;daemon of…&quot;   <span class="number">13</span> minutes ago   Up <span class="number">13</span> minutes   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">32771</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">32771</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp   test<span class="operator">-</span>nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看容器详细信息，卷挂载后可以在inspect信息中查看到挂载的信息</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect <span class="number">4</span>f0<span class="operator">|</span>jq</span><br><span class="line">   &quot;Mounts&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;bind&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/containel-volume/centos-nginx/logs&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;/var/log/nginx&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: <span class="literal">true</span>,</span><br><span class="line">        &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure>

<h2 id="2-centos-nginx镜像构建-volume指令创建卷"><a href="#2-centos-nginx镜像构建-volume指令创建卷" class="headerlink" title="2.centos+nginx镜像构建(volume指令创建卷)"></a>2.centos+nginx镜像构建(volume指令创建卷)</h2><h3 id="书写dockerfile构建镜像–使用volume指令"><a href="#书写dockerfile构建镜像–使用volume指令" class="headerlink" title="书写dockerfile构建镜像–使用volume指令"></a>书写dockerfile构建镜像–使用volume指令</h3><p><strong>物料yum源</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 /dockerfile]#<span class="built_in">cd</span> centos-nginx/</span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#<span class="built_in">ls</span></span><br><span class="line">CentOS-Base.repo </span><br></pre></td></tr></table></figure>

<p><strong>书写dockerfile</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 /dockerfile/centos-nginx]#vim Dockerfile </span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#<span class="built_in">cat</span> Dockerfile </span><br><span class="line">From centos:7.9.2009</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">rm</span> -f /etc/yum.repos.d/*</span><br><span class="line"></span><br><span class="line">COPY *.repo /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">RUN yum install epel-release -y \</span><br><span class="line">&amp;&amp;  yum install nginx -y \</span><br><span class="line">&amp;&amp;  yum clean all</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用volume指令指定卷挂载点</span></span><br><span class="line">VOLUME /var/log/nginx/ </span><br><span class="line">VOLUME /etc/nginx/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>,<span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>dokcerfile构建运行容器</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#构建镜像</span></span><br><span class="line">[root@docker-01 /dockerfile/centos-nginx]#docker build -t centos-nginx-v1 .</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看镜像</span></span><br><span class="line">[root@docker-01 ~]#docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">centos-nginx-v1   latest    de9b64cc3b5d   39 minutes ago   262MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看构建步骤</span></span><br><span class="line">[root@docker-01 ~]#docker <span class="built_in">history</span> de9</span><br><span class="line">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span><br><span class="line">de9b64cc3b5d   40 minutes ago   CMD [<span class="string">&quot;nginx&quot;</span> <span class="string">&quot;-g&quot;</span> <span class="string">&quot;daemon off;&quot;</span>]                0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      40 minutes ago   EXPOSE map[80/tcp:&#123;&#125;]                           0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      40 minutes ago   VOLUME [/etc/nginx/]                            0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      40 minutes ago   VOLUME [/var/log/nginx/]                        0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      40 minutes ago   RUN /bin/sh -c yum install epel-release -y &amp;…   57.9MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      42 minutes ago   COPY *.repo /etc/yum.repos.d/ <span class="comment"># buildkit        2.52kB    buildkit.dockerfile.v0</span></span><br><span class="line">&lt;missing&gt;      50 minutes ago   RUN /bin/sh -c <span class="built_in">rm</span> -f /etc/yum.repos.d/* <span class="comment"># bu…   0B        buildkit.dockerfile.v0</span></span><br><span class="line">&lt;missing&gt;      2 years ago      /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span></span><br><span class="line">&lt;missing&gt;      2 years ago      /bin/sh -c <span class="comment">#(nop)  LABEL org.label-schema.sc…   0B        </span></span><br><span class="line">&lt;missing&gt;      2 years ago      /bin/sh -c <span class="comment">#(nop) ADD file:b3ebbe8bd304723d4…   204MB  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于镜像运行容器</span></span><br><span class="line">[root@docker-01 ~]#docker run --name test-nginx-v2 -P -d de9b64cc3b5d</span><br><span class="line">bcb7e9899fa4466d9268bb575531593c3c571dc753bc483d4287fc5bee048ff0</span><br><span class="line">[root@docker-01 ~]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                     NAMES</span><br><span class="line">bcb7e9899fa4   de9b64cc3b5d   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   4 seconds ago    Up 3 seconds    0.0.0.0:32774-&gt;80/tcp, :::32774-&gt;80/tcp   test-nginx-v2</span><br></pre></td></tr></table></figure>

<h3 id="检查运行容器自动挂载数据卷"><a href="#检查运行容器自动挂载数据卷" class="headerlink" title="检查运行容器自动挂载数据卷"></a>检查运行容器自动挂载数据卷</h3><p><strong>查看容器详细信息找mounts挂载部分信息</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect bcb7e9899fa4<span class="operator">|</span>jq</span><br><span class="line"> </span><br><span class="line"> &quot;Mounts&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;6a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/6a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;/etc/nginx&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: <span class="literal">true</span>,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;/var/log/nginx&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: <span class="literal">true</span>,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>查看当前机器上的卷信息</strong></p>
<blockquote>
<p>使用volume指令构建的镜像运行容器后，会在本地自建一个卷信息挂载，并且可以基于volume ls查看列出卷</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="keyword">local</span>     <span class="number">6</span>a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5</span><br><span class="line"><span class="keyword">local</span>     d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8</span><br></pre></td></tr></table></figure>

<p><strong>查看具体被保存到了何处</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#默认都会保存放入<span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volume<span class="operator">/</span>目录下方</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ls <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span></span><br><span class="line"><span class="number">6</span>a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5  d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8</span><br><span class="line">backingFsBlockDev                                                 metadata.db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#树形查看结构，成功映射保存了容器内的挂载点数据</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#tree <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span></span><br><span class="line"><span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span></span><br><span class="line">├── <span class="number">6</span>a82cbea9b01deb8c7feec63320e756dad97645970992d6c6b3a2bd357339df5</span><br><span class="line">│   └── _data</span><br><span class="line">│       ├── conf.d</span><br><span class="line">│       ├── default.d</span><br><span class="line">│       ├── fastcgi.conf</span><br><span class="line">│       ├── fastcgi.conf.default</span><br><span class="line">│       ├── fastcgi_params</span><br><span class="line">│       ├── fastcgi_params.default</span><br><span class="line">│       ├── koi<span class="operator">-</span>utf</span><br><span class="line">│       ├── koi<span class="operator">-</span>win</span><br><span class="line">│       ├── mime.types</span><br><span class="line">│       ├── mime.types.default</span><br><span class="line">│       ├── nginx.conf</span><br><span class="line">│       ├── nginx.conf.default</span><br><span class="line">│       ├── scgi_params</span><br><span class="line">│       ├── scgi_params.default</span><br><span class="line">│       ├── uwsgi_params</span><br><span class="line">│       ├── uwsgi_params.default</span><br><span class="line">│       └── win<span class="operator">-</span>utf</span><br><span class="line">├── backingFsBlockDev</span><br><span class="line">├── d382374a69be3009581fa66fccc166875dffbe6bfcbeb89d11404d86cfe756c8</span><br><span class="line">│   └── _data</span><br><span class="line">│       ├── access.log</span><br><span class="line">│       └── error.log</span><br><span class="line">└── metadata.db</span><br><span class="line"></span><br><span class="line"><span class="number">6</span> directories, <span class="number">19</span> files</span><br></pre></td></tr></table></figure>

<h2 id="3-centos-python3-flask镜像构建-代码连接redis"><a href="#3-centos-python3-flask镜像构建-代码连接redis" class="headerlink" title="3.centos+python3+flask镜像构建(代码连接redis)"></a>3.centos+python3+flask镜像构建(代码连接redis)</h2><h3 id="redis容器准备"><a href="#redis容器准备" class="headerlink" title="redis容器准备"></a>redis容器准备</h3><blockquote>
<p>准备redis容器提供服务端，让python3环境的容器中flask代码可以连接redis</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#仓库搜索</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">search</span> redis</span><br><span class="line">NAME                                    DESCRIPTION                                     STARS     OFFICIAL</span><br><span class="line">redis                                   Redis <span class="keyword">is</span> the world’s fastest data platform f…   <span class="number">12924</span>     [OK]</span><br><span class="line"></span><br><span class="line">#下载官网出品redis</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker pull redis</span><br><span class="line"></span><br><span class="line">#查看镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY     TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">centos<span class="operator">-</span>nginx   latest    de9b64cc3b5d   <span class="number">2</span> hours ago   <span class="number">262</span>MB</span><br><span class="line">redis          latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago   <span class="number">113</span>MB</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history redis</span><br><span class="line"></span><br><span class="line">#运行redis容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="comment">--name test-redis -d  7614ae9453d1</span></span><br><span class="line">ba80130fdc92bede50f96edfcba94b11956f47edb8dbe08b656212b041b76e7d</span><br><span class="line"></span><br><span class="line">#检查容器进程</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps </span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS      NAMES</span><br><span class="line">ba80130fdc92   <span class="number">7614</span>ae9453d1   &quot;docker-entrypoint.s…&quot;   <span class="number">6</span> seconds ago   Up <span class="number">5</span> seconds   <span class="number">6379</span><span class="operator">/</span>tcp   test<span class="operator">-</span>redis</span><br></pre></td></tr></table></figure>

<h3 id="flask代码准备"><a href="#flask代码准备" class="headerlink" title="flask代码准备"></a>flask代码准备</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf<span class="number">-8</span></span><br><span class="line"><span class="keyword">from</span> flask import Flask</span><br><span class="line"><span class="keyword">from</span> redis import Redis</span><br><span class="line"></span><br><span class="line">app <span class="operator">=</span> Flask(__name__)</span><br><span class="line">redis <span class="operator">=</span> Redis(host<span class="operator">=</span><span class="string">&#x27;test-redis&#x27;</span>, port<span class="operator">=</span><span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def hello():</span><br><span class="line">    count <span class="operator">=</span> redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;A day of study dockerfile , this page has been visited &#123;&#125; times\n&#x27;</span>.format(count)</span><br><span class="line"></span><br><span class="line">if __name__ <span class="operator">=</span><span class="operator">=</span> &quot;__main__&quot;:</span><br><span class="line">    app.run(host<span class="operator">=</span>&quot;0.0.0.0&quot;,port<span class="operator">=</span><span class="number">8000</span>, debug<span class="operator">=</span><span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><strong>flask代码解释</strong></p>
<p>上方Flask应用程序中，已经展示了如何连接到Redis数据库。这是通过<code>redis = Redis(host=&#39;redis&#39;, port=6379)</code>这行代码实现的。这里，<code>Redis</code>类是从<code>redis</code>模块导入的，用于创建一个Redis客户端实例，该实例可以与Redis服务器进行通信。</p>
<p>以下是一些关于如何连接Redis的详细步骤和注意事项：</p>
<ol>
<li><strong>确保Redis服务器正在运行</strong>： 在尝试从Flask应用程序连接到Redis之前，请确保Redis服务器已经启动并正在运行。您可以使用Redis的命令行工具（<code>redis-cli</code>）来测试Redis服务器是否正在响应。</li>
<li><strong>配置Redis连接</strong>： 在Flask应用程序中，您通过<code>Redis(host=&#39;redis&#39;, port=6379)</code>来配置Redis连接。这里的<code>host</code>和<code>port</code>参数分别指定了Redis服务器的地址和端口。在这个例子中，假设Redis服务器位于名为<code>redis</code>的主机上，并且运行在默认的Redis端口6379上。<ul>
<li>如果Redis服务器和Flask应用程序部署在同一台机器上，并且您使用的是Redis的默认配置（即，Redis监听在<code>localhost</code>的6379端口上），则您可以将<code>host</code>参数更改为<code>&#39;localhost&#39;</code>。</li>
<li>如果Redis服务器需要密码才能访问，您还可以添加<code>password=&#39;yourpassword&#39;</code>参数到<code>Redis</code>构造函数中。</li>
</ul>
</li>
<li><strong>测试连接</strong>： 在Flask应用程序中，您可以通过尝试执行一个Redis命令（如<code>redis.ping()</code>）来测试Redis连接是否成功。如果Redis服务器可用且连接成功，<code>redis.ping()</code>将返回<code>True</code>。</li>
<li><strong>处理连接问题</strong>： 如果连接失败，可能是由于多种原因造成的，包括Redis服务器未运行、网络问题、错误的配置（如错误的<code>host</code>、<code>port</code>或<code>password</code>）等。检查Redis服务器的状态、网络连接和Flask应用程序中的配置设置，以帮助诊断和解决连接问题。</li>
<li><strong>部署注意事项</strong>： 当您将Flask应用程序和Redis部署到生产环境时，请确保它们之间的网络连接是安全的，并且Redis服务器的配置（如密码保护、防火墙规则等）符合您的安全要求。</li>
<li><strong>使用连接池</strong>： 对于生产环境中的高负载应用，您可能希望使用Redis连接池来管理Redis连接。Flask-Redis（一个Flask扩展，用于简化Redis的集成）提供了这样的功能，但您也可以使用<code>redis-py</code>库的连接池功能。</li>
<li><strong>异常处理</strong>： 在您的Flask应用程序中，添加适当的异常处理逻辑，以便在Redis连接失败或Redis命令执行失败时能够优雅地处理这些情况。这可以通过try-except块来实现。</li>
</ol>
<h3 id="dockerfile物料准备"><a href="#dockerfile物料准备" class="headerlink" title="dockerfile物料准备"></a>dockerfile物料准备</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#flask代码</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#cat <span class="operator">&gt;</span>web<span class="operator">-</span>flask.py <span class="operator">&lt;&lt;</span><span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> #coding:utf<span class="number">-8</span></span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">from</span> flask import Flask</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">from</span> redis import Redis</span><br><span class="line"><span class="operator">&gt;</span> </span><br><span class="line"><span class="operator">&gt;</span> app <span class="operator">=</span> Flask(__name__)</span><br><span class="line"><span class="operator">&gt;</span> redis <span class="operator">=</span> Redis(host<span class="operator">=</span><span class="string">&#x27;test-redis&#x27;</span>, port<span class="operator">=</span><span class="number">6379</span>)</span><br><span class="line"><span class="operator">&gt;</span> </span><br><span class="line"><span class="operator">&gt;</span> <span class="variable">@app</span>.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"><span class="operator">&gt;</span> def hello():</span><br><span class="line"><span class="operator">&gt;</span>     count <span class="operator">=</span> redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line"><span class="operator">&gt;</span>     <span class="keyword">return</span> <span class="string">&#x27;A day of study dockerfile , this page has been visited &#123;&#125; times\n&#x27;</span>.format(count)</span><br><span class="line"><span class="operator">&gt;</span> </span><br><span class="line"><span class="operator">&gt;</span> if __name__ <span class="operator">=</span><span class="operator">=</span> &quot;__main__&quot;:</span><br><span class="line"><span class="operator">&gt;</span>     app.run(host<span class="operator">=</span>&quot;0.0.0.0&quot;,port<span class="operator">=</span><span class="number">8000</span>, debug<span class="operator">=</span><span class="literal">True</span>)</span><br><span class="line"><span class="operator">&gt;</span> EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#镜像yum源</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#wget <span class="operator">-</span>O .<span class="operator">/</span>epel.repo https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>repo<span class="operator">/</span>epel<span class="number">-7.</span>repo</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#curl <span class="operator">-</span>so .<span class="operator">/</span>CentOS<span class="operator">-</span>Base.repo https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>repo<span class="operator">/</span>Centos<span class="number">-7.</span>repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#python代码依赖文件准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#cat requirements.txt </span><br><span class="line">flask</span><br><span class="line">redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#最终所有物料</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#ls</span><br><span class="line">CentOS<span class="operator">-</span>Base.repo  epel.repo  requirements.txt  web<span class="operator">-</span>flask.py</span><br></pre></td></tr></table></figure>

<h3 id="dockerfile构建镜像"><a href="#dockerfile构建镜像" class="headerlink" title="dockerfile构建镜像"></a>dockerfile构建镜像</h3><p><strong>书写dockerfile</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#vim Dockerfile</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#cat Dockerfile </span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span><span class="number">.2009</span></span><br><span class="line"></span><br><span class="line">#复制仓库配置和应用程序文件</span><br><span class="line"><span class="keyword">COPY</span> CentOS<span class="operator">-</span>Base.repo epel.repo <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="operator">/</span></span><br><span class="line"><span class="keyword">COPY</span> requirements.txt web<span class="operator">-</span>flask.py <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span></span><br><span class="line"></span><br><span class="line">#设置工作目录</span><br><span class="line">WORKDIR <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span></span><br><span class="line"></span><br><span class="line">#安装依赖</span><br><span class="line">RUN yum makecache fast \</span><br><span class="line"><span class="operator">&amp;&amp;</span>  yum install python3 python3<span class="operator">-</span>devel python3<span class="operator">-</span>pip <span class="operator">-</span>y \</span><br><span class="line"><span class="operator">&amp;&amp;</span>  python3 <span class="operator">-</span>m pip install <span class="operator">-</span>i https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>pypi<span class="operator">/</span>simple <span class="comment">--upgrade pip \</span></span><br><span class="line"><span class="operator">&amp;&amp;</span>  pip3 install <span class="operator">-</span>i https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>pypi<span class="operator">/</span>simple <span class="operator">-</span>r  .<span class="operator">/</span>requirements.txt \</span><br><span class="line"><span class="operator">&amp;&amp;</span>  yum clean <span class="keyword">all</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#暴露端口</span><br><span class="line">EXPOSE <span class="number">8000</span></span><br><span class="line"></span><br><span class="line">#启动应用程序</span><br><span class="line">CMD [&quot;python3&quot;, &quot;web-flask.py&quot;]</span><br></pre></td></tr></table></figure>

<p><strong>构建image</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#构建</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>python<span class="operator">-</span>flask]#docker build <span class="operator">-</span>t flask<span class="operator">-</span>redis<span class="operator">-</span>v1 .</span><br><span class="line"></span><br><span class="line">#查看镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images                                                 </span><br><span class="line">REPOSITORY       TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">flask<span class="operator">-</span>redis<span class="operator">-</span>v1   latest    <span class="number">44</span>b643b97874   <span class="number">8</span> seconds ago   <span class="number">336</span>MB</span><br><span class="line">centos<span class="operator">-</span>nginx     latest    de9b64cc3b5d   <span class="number">4</span> hours ago     <span class="number">262</span>MB</span><br><span class="line">redis            latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago     <span class="number">113</span>MB</span><br><span class="line"></span><br><span class="line">#查看构建步骤</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history  flask<span class="operator">-</span>redis<span class="operator">-</span>v1:latest </span><br><span class="line">IMAGE          CREATED          CREATED <span class="keyword">BY</span>                                      SIZE      COMMENT</span><br><span class="line"><span class="number">44</span>b643b97874   <span class="number">25</span> seconds ago   CMD [&quot;python3&quot; &quot;web-flask.py&quot;]                  <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">25</span> seconds ago   EXPOSE map[<span class="number">8000</span><span class="operator">/</span>tcp:&#123;&#125;]                         <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">25</span> seconds ago   RUN <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c yum makecache fast <span class="operator">&amp;&amp;</span>  yum <span class="keyword">in</span>…   <span class="number">132</span>MB     buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">3</span> minutes ago    WORKDIR <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>                         <span class="number">0</span>B        buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">3</span> minutes ago    <span class="keyword">COPY</span> web<span class="operator">-</span>flask.py requirements.txt <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>…   <span class="number">373</span>B      buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">3</span> minutes ago    <span class="keyword">COPY</span> <span class="operator">*</span>.repo <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="operator">/</span> # buildkit        <span class="number">3.19</span>kB    buildkit.dockerfile.v0</span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago      <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  CMD [&quot;/bin/bash&quot;]            <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago      <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop)  LABEL org.label<span class="operator">-</span>schema.sc…   <span class="number">0</span>B        </span><br><span class="line"><span class="operator">&lt;</span>missing<span class="operator">&gt;</span>      <span class="number">2</span> years ago      <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c #(nop) <span class="keyword">ADD</span> file:b3ebbe8bd304723d4…   <span class="number">204</span>MB   </span><br></pre></td></tr></table></figure>

<h3 id="flask容器连接redis运行"><a href="#flask容器连接redis运行" class="headerlink" title="flask容器连接redis运行"></a>flask容器连接redis运行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#运行flask容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>p <span class="number">8000</span>:<span class="number">8000</span> <span class="comment">--name test-flask-redis flask-redis-v1</span></span><br></pre></td></tr></table></figure>

<p><strong>windows访问发现报错，无法连接redis容器</strong></p>
<p><img src="/image-20240728151056718.png" alt="image-20240728151056718"></p>
<h3 id="flask无法连接redis解决报错"><a href="#flask无法连接redis解决报错" class="headerlink" title="flask无法连接redis解决报错"></a>flask无法连接redis解决报错</h3><p><strong>方法1，进入flask容器，修改flask代码，将host指定的主机名修改为redis容器的ip地址</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看redis容器运行的ip地址</span></span><br><span class="line">[root@docker-01 ~]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE            COMMAND                  CREATED             STATUS             PORTS                                       NAMES</span><br><span class="line">e73aca26a802   flask-redis-v1   <span class="string">&quot;python3 web-flask.py&quot;</span>   3 minutes ago       Up 3 minutes       0.0.0.0:8000-&gt;8000/tcp, :::8000-&gt;8000/tcp   test-flask-redis</span><br><span class="line">ba80130fdc92   7614ae9453d1     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   About an hour ago   Up About an hour   6379/tcp                                    test-redis</span><br><span class="line">[root@docker-01 ~]#docker inspect ba80130fdc92|grep -i <span class="string">&#x27;ipaddress&#x27;</span></span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.2&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入flask容器内部修改代码中host改为redis容器的ip地址</span></span><br><span class="line">[root@docker-01 ~]#docker <span class="built_in">exec</span> -it e73aca26a802  /bin/bash</span><br><span class="line">[root@e73aca26a802 web-flask]# <span class="built_in">ls</span></span><br><span class="line">requirements.txt  web-flask.py</span><br><span class="line">[root@e73aca26a802 web-flask]# vi web-flask.py </span><br><span class="line">[root@e73aca26a802 web-flask]# <span class="built_in">cat</span> web-flask.py </span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">from flask import Flask</span><br><span class="line">from redis import Redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=<span class="string">&#x27;172.17.0.2&#x27;</span>, port=6379)</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def hello():</span><br><span class="line">    count = redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="built_in">return</span> <span class="string">&#x27;A day of study dockerfile , this page has been visited &#123;&#125; times\n&#x27;</span>.format(count)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port=8000, debug=True)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#最后访问检查</span></span><br></pre></td></tr></table></figure>

<p><img src="/image-20240728151815866.png" alt="image-20240728151815866"></p>
<p><strong>方法二，启动时使用–link参数，连接容器，自然就可以根据代码中主机名，连接到对应得容器名了</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看镜像</span></span><br><span class="line">[root@docker-01 ~]#docker images</span><br><span class="line">REPOSITORY       TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">flask-redis-v1   latest    44b643b97874   18 minutes ago   336MB</span><br><span class="line">centos-nginx     latest    de9b64cc3b5d   4 hours ago      262MB</span><br><span class="line">redis            latest    7614ae9453d1   2 years ago      113MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看容器进程</span></span><br><span class="line">[root@docker-01 ~]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE            COMMAND                  CREATED          STATUS          PORTS                                       NAMES</span><br><span class="line">e73aca26a802   flask-redis-v1   <span class="string">&quot;python3 web-flask.py&quot;</span>   10 minutes ago   Up 10 minutes   0.0.0.0:8000-&gt;8000/tcp, :::8000-&gt;8000/tcp   test-flask-redis</span><br><span class="line">ba80130fdc92   7614ae9453d1     <span class="string">&quot;docker-entrypoint.s…&quot;</span>   2 hours ago      Up 2 hours      6379/tcp                                    test-redis</span><br><span class="line"></span><br><span class="line"><span class="comment">#链接redis容器名运行falsk容器</span></span><br><span class="line">[root@docker-01 ~]#docker run --name flask-redis-v2 -d -p 8001:8000 --<span class="built_in">link</span>=test-redis  44b643b97874</span><br><span class="line">ffcd5be4489f34f55f6ce9281feca3c9aa8657d08c063262b056f9cb66ad907b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#最后访问宿主机映射地址即可</span></span><br></pre></td></tr></table></figure>

<p><img src="/image-20240728152613708.png" alt="image-20240728152613708"></p>
<h1 id="四、supervisor容器内服务进程管理工具"><a href="#四、supervisor容器内服务进程管理工具" class="headerlink" title="四、supervisor容器内服务进程管理工具"></a>四、supervisor容器内服务进程管理工具</h1><blockquote>
<p>supervisor是一个容器内管理服务进程的一个工具</p>
<p>通过supervisor配置启动的容器，如果服务进程意外终端，此工具可以自动对容器内服务进行一个重新启动</p>
</blockquote>
<ul>
<li>注意：supervisor默认启动是后台运行，但是docker的特性要求容器内进程必须前台运行，需要修改supervisor配置文件</li>
</ul>
<h2 id="1-supervisor概述"><a href="#1-supervisor概述" class="headerlink" title="1.supervisor概述"></a>1.supervisor概述</h2><p>Supervisor 是一个在Linux系统上广泛使用的进程管理工具，它主要用于管理和监控在Linux系统上运行的进程。以下是Supervisor的概述以及它如何帮助解决用户在Linux操作系统中遇到的常见问题：</p>
<p><strong>Supervisor概述</strong></p>
<ol>
<li><strong>进程管理</strong>：<ul>
<li>Supervisor可以管理多个进程，包括应用程序、服务或其他需要在后台运行的进程。</li>
<li>它能启动、停止、重启和监控这些进程，并在它们异常退出时自动重新启动。</li>
</ul>
</li>
<li><strong>进程监控</strong>：<ul>
<li>Supervisor能监控进程的状态，包括是否正在运行、已经退出或者出现异常。</li>
<li>它可以定期检查进程的状态，并在进程异常退出时进行相应的处理。</li>
</ul>
</li>
<li><strong>自动重启</strong>：<ul>
<li>如果进程异常退出，Supervisor可以根据配置文件中的设置自动重启进程。</li>
</ul>
</li>
<li><strong>日志管理</strong>：<ul>
<li>Supervisor可以收集和管理进程的日志信息，将进程的输出重定向到指定的文件中，并支持日志的轮转和归档。</li>
</ul>
</li>
<li><strong>进程组管理</strong>：<ul>
<li>可以将多个相关联的进程组绑定在一起，方便同时管理和操作。</li>
</ul>
</li>
<li><strong>Web界面</strong>：<ul>
<li>Supervisor提供了一个简单的Web界面，用户可以通过浏览器进行监控和管理进程。</li>
</ul>
</li>
<li><strong>配置文件</strong>：<ul>
<li>Supervisor通过配置文件来定义要管理的进程，配置文件中包括进程名称、启动命令、日志输出等信息。</li>
</ul>
</li>
</ol>
<p><strong>解决Linux操作系统中的常见问题</strong></p>
<p>虽然Supervisor本身不直接解决所有Linux系统问题，但它通过优化进程管理，可以帮助解决或减轻以下常见问题：</p>
<ol>
<li><strong>系统启动失败</strong>：<ul>
<li>如果某些服务或应用程序在系统启动时无法自动启动，Supervisor可以确保这些进程在系统启动后自动启动。</li>
</ul>
</li>
<li><strong>文件权限问题</strong>：<ul>
<li>虽然Supervisor不直接解决文件权限问题，但它可以确保以正确的用户和组身份启动进程，从而避免权限相关的错误。</li>
</ul>
</li>
<li><strong>软件安装与卸载问题</strong>：<ul>
<li>Supervisor不直接涉及软件的安装与卸载，但它可以确保安装的服务或应用程序在系统更新或重启后能够正确运行。</li>
</ul>
</li>
<li><strong>网络连接问题</strong>：<ul>
<li>如果网络连接问题是由后台进程异常引起的，Supervisor通过自动重启这些进程，可以帮助恢复网络连接。</li>
</ul>
</li>
</ol>
<p><strong>安装与配置Supervisor</strong></p>
<p>Supervisor的安装通常通过Linux的包管理器（如apt、yum）进行，或者从源码编译安装。安装完成后，需要创建配置文件来定义要管理的进程。配置完成后，通过执行<code>supervisord</code>命令启动Supervisor，并使用<code>supervisorctl</code>命令来管理进程。</p>
<p>综上所述，Supervisor是一个强大的进程管理工具，通过优化进程管理和监控，它可以帮助解决Linux操作系统中的一些问题，提高系统的稳定性和可靠性。</p>
<h2 id="2-flask运行环境升级构建镜像"><a href="#2-flask运行环境升级构建镜像" class="headerlink" title="2.flask运行环境升级构建镜像"></a>2.flask运行环境升级构建镜像</h2><blockquote>
<p>上方flask运行环境升级创建dockerfile构建镜像</p>
<p>最终环境：centos+nginx+flask+supervisor+链接redis</p>
</blockquote>
<h3 id="redis容器运行"><a href="#redis容器运行" class="headerlink" title="redis容器运行"></a>redis容器运行</h3><p>后端链接数据库时，先要保证数据库运行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED       STATUS       PORTS      NAMES</span><br><span class="line">ba80130fdc92   <span class="number">7614</span>ae9453d1   &quot;docker-entrypoint.s…&quot;   <span class="number">3</span> hours ago   Up <span class="number">3</span> hours   <span class="number">6379</span><span class="operator">/</span>tcp   test<span class="operator">-</span>redis</span><br></pre></td></tr></table></figure>

<h3 id="dockrfile物料准备"><a href="#dockrfile物料准备" class="headerlink" title="dockrfile物料准备"></a>dockrfile物料准备</h3><p><strong>nginx配置文件物料准备</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#物料目录准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#pwd</span><br><span class="line"><span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#nginx配置文件物料准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#cat <span class="operator">&gt;</span>test<span class="operator">-</span>web<span class="operator">-</span>nginx.conf<span class="operator">&lt;&lt;</span><span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> cat <span class="operator">&gt;</span> nginx_flask.conf <span class="operator">&lt;&lt;</span><span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> server&#123;</span><br><span class="line"><span class="operator">&gt;</span>     listen <span class="number">80</span>;</span><br><span class="line"><span class="operator">&gt;</span>     server_name _;</span><br><span class="line"><span class="operator">&gt;</span>     location <span class="operator">/</span> &#123;</span><br><span class="line"><span class="operator">&gt;</span>         proxy_pass http:<span class="operator">/</span><span class="operator">/</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>;    </span><br><span class="line"><span class="operator">&gt;</span>     &#125;</span><br><span class="line"><span class="operator">&gt;</span> &#125;</span><br><span class="line"><span class="operator">&gt;</span> EOF</span><br></pre></td></tr></table></figure>

<p><strong>python代码物料</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#vim web<span class="operator">-</span>flask.py</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#cat web<span class="operator">-</span>flask.py </span><br><span class="line">#coding:utf<span class="number">-8</span></span><br><span class="line"><span class="keyword">from</span> flask import Flask</span><br><span class="line"><span class="keyword">from</span> redis import Redis</span><br><span class="line"></span><br><span class="line">app <span class="operator">=</span> Flask(__name__)</span><br><span class="line">redis <span class="operator">=</span> Redis(host<span class="operator">=</span><span class="string">&#x27;test-redis&#x27;</span>, port<span class="operator">=</span><span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def hello():</span><br><span class="line">    count <span class="operator">=</span> redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;A day of study dockerfile , this page has been visited &#123;&#125; times\n&#x27;</span>.format(count)</span><br><span class="line"></span><br><span class="line">if __name__ <span class="operator">=</span><span class="operator">=</span> &quot;__main__&quot;:</span><br><span class="line">    app.run(host<span class="operator">=</span>&quot;0.0.0.0&quot;,port<span class="operator">=</span><span class="number">8000</span>, debug<span class="operator">=</span><span class="literal">True</span>)</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>supervisor配置文件物料</strong></p>
<blockquote>
<p>该配置尾戳必须是 <code>.ini</code>结尾</p>
<p>核心原理就是通过配置中定义的服务启动命令，去启动你的服务进程</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 /dockerfile/centos-nginx-flask-supervison]#<span class="built_in">cat</span> &gt; nginx_flask.ini &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&gt; [program:my-nginx]</span><br><span class="line">&gt; <span class="built_in">command</span>=nginx -g <span class="string">&#x27;daemon off;&#x27;</span></span><br><span class="line">&gt; autostart=<span class="literal">true</span></span><br><span class="line">&gt; autorestart=<span class="literal">true</span></span><br><span class="line">&gt; startsecs=5</span><br><span class="line">&gt; redirect_stderr=<span class="literal">true</span></span><br><span class="line">&gt; stdout_logfile_maxbytes=20MB</span><br><span class="line">&gt; stdout_logfile_backups=20</span><br><span class="line">&gt; stdout_logfile=/var/log/supervisor/nginx.log</span><br><span class="line">&gt; </span><br><span class="line">&gt; [program:my-flask]</span><br><span class="line">&gt; <span class="built_in">command</span>=python3  /app/web-flask/web-flask.py</span><br><span class="line">&gt; autostart=<span class="literal">true</span></span><br><span class="line">&gt; autorestart=<span class="literal">true</span></span><br><span class="line">&gt; startsecs=5</span><br><span class="line">&gt; redirect_stderr=<span class="literal">true</span></span><br><span class="line">&gt; stdout_logfile_maxbytes=20MB</span><br><span class="line">&gt; stdout_logfile_backups=20</span><br><span class="line">&gt; stdout_logfile=/var/log/supervisor/flask.log</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>

<p><strong>python代码模块依赖文件</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#cat requirements.txt </span><br><span class="line">flask</span><br><span class="line">redis</span><br></pre></td></tr></table></figure>

<p><strong>yum仓库源配置文件</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#curl <span class="operator">-</span>o .<span class="operator">/</span>CentOS<span class="operator">-</span>Base.repo https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>repo<span class="operator">/</span>Centos<span class="number">-7.</span>repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#curl <span class="operator">-</span>o .<span class="operator">/</span>epel.repo http:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>repo<span class="operator">/</span>epel<span class="number">-7.</span>repo</span><br></pre></td></tr></table></figure>

<p><strong>所有物料检查</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#ll</span><br><span class="line">total <span class="number">24</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 2523 Jul 28 16:32 CentOS-Base.repo</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  664 Jul 28 16:32 epel.repo</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  445 Jul 28 16:25 nginx_flask.ini</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root   12 Jul 28 16:26 requirements.txt</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  144 Jul 28 16:14 test-web-nginx.conf</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  365 Jul 28 16:28 web-flask.py</span></span><br></pre></td></tr></table></figure>

<h3 id="dockerfile构建镜像-1"><a href="#dockerfile构建镜像-1" class="headerlink" title="dockerfile构建镜像"></a>dockerfile构建镜像</h3><p><strong>书写dockerfile</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; Dockerfile &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">FROM centos:7.9.2009</span><br><span class="line"></span><br><span class="line">RUN  <span class="built_in">rm</span> -f /etc/yum.repos.d/*</span><br><span class="line">COPY *.repo /etc/yum.repos.d/</span><br><span class="line">COPY requirements.txt web-flask.py /app/web-flask/</span><br><span class="line"></span><br><span class="line">WORKDIR /app/web-flask</span><br><span class="line">RUN yum makecache fast \</span><br><span class="line">&amp;&amp; yum install python3 python3-devel python3-pip -y \</span><br><span class="line">&amp;&amp; python3 -m pip install -i https://mirrors.aliyun.com/pypi/simple --upgrade pip \</span><br><span class="line">&amp;&amp; pip3 install -i https://mirrors.aliyun.com/pypi/simple -r requirements.txt \</span><br><span class="line">&amp;&amp; yum install supervisor nginx -y \</span><br><span class="line">&amp;&amp; yum clean all</span><br><span class="line"></span><br><span class="line">COPY test-web-nginx.conf /etc/nginx/conf.d/</span><br><span class="line">COPY nginx_flask.ini /etc/supervisord.d/</span><br><span class="line">RUN sed -i <span class="string">&#x27;s/nodaemon=false/nodaemon=true/g&#x27;</span> /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line">EXPOSE 8000</span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">VOLUME /var/log/supervisor/</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;/usr/bin/supervisord&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;/etc/supervisord.conf&quot;</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>构建镜像</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#构建</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervison]#docker build <span class="operator">-</span>t centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervisor .</span><br><span class="line"></span><br><span class="line">#检查镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervisor   latest    <span class="number">65441</span>eaf22f9   <span class="number">9</span> seconds ago   <span class="number">373</span>MB</span><br><span class="line">flask<span class="operator">-</span>redis<span class="operator">-</span>v1                  latest    <span class="number">44</span>b643b97874   <span class="number">2</span> hours ago     <span class="number">336</span>MB</span><br><span class="line">centos<span class="operator">-</span>nginx                    latest    de9b64cc3b5d   <span class="number">5</span> hours ago     <span class="number">262</span>MB</span><br><span class="line">redis                           latest    <span class="number">7614</span>ae9453d1   <span class="number">2</span> years ago     <span class="number">113</span>MB</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker history centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervisor:latest </span><br></pre></td></tr></table></figure>

<h3 id="flask链接redis容器运行并检查"><a href="#flask链接redis容器运行并检查" class="headerlink" title="flask链接redis容器运行并检查"></a>flask链接redis容器运行并检查</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#镜像</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">centos<span class="operator">-</span>nginx<span class="operator">-</span>flask<span class="operator">-</span>supervisor   latest    <span class="number">65441</span>eaf22f9   <span class="number">8</span> minutes ago   <span class="number">373</span>MB</span><br><span class="line"></span><br><span class="line">#redis容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED       STATUS       PORTS      NAMES</span><br><span class="line">ba80130fdc92   <span class="number">7614</span>ae9453d1   &quot;docker-entrypoint.s…&quot;   <span class="number">3</span> hours ago   Up <span class="number">3</span> hours   <span class="number">6379</span><span class="operator">/</span>tcp   test<span class="operator">-</span>redis</span><br><span class="line"></span><br><span class="line">#运行flask容器，映射内部代理转发nginx端口，连接redis</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>d <span class="operator">-</span>p <span class="number">80</span>:<span class="number">80</span> <span class="comment">--name nginx-flask_redis-supervisor --link=ba80130fdc92 65441eaf22f9</span></span><br><span class="line">d6206468fdc5e82e6099d400dd58695ecc3a961a57ac71b3e63d7be227fa75d4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#flask容器运行检查</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED              STATUS              PORTS                                         NAMES</span><br><span class="line">d6206468fdc5   <span class="number">65441</span>eaf22f9   &quot;/usr/bin/supervisor…&quot;   About a <span class="keyword">minute</span> ago   Up About a <span class="keyword">minute</span>   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, :::<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">80</span><span class="operator">/</span>tcp, <span class="number">8000</span><span class="operator">/</span>tcp   nginx<span class="operator">-</span>flask_redis<span class="operator">-</span>supervisor</span><br><span class="line">ba80130fdc92   <span class="number">7614</span>ae9453d1   &quot;docker-entrypoint.s…&quot;   <span class="number">3</span> hours ago          Up <span class="number">3</span> hours          <span class="number">6379</span><span class="operator">/</span>tcp                                      test<span class="operator">-</span>redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#flask容器内服务进程运行检查，supervisor、nginx、redis都正常启动了</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker top d62</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 <span class="type">TIME</span>                CMD</span><br><span class="line">root                <span class="number">26252</span>               <span class="number">26231</span>               <span class="number">0</span>                   <span class="number">16</span>:<span class="number">58</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>python <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>supervisord <span class="operator">-</span>c <span class="operator">/</span>etc<span class="operator">/</span>supervisord.conf</span><br><span class="line">root                <span class="number">26273</span>               <span class="number">26252</span>               <span class="number">0</span>                   <span class="number">16</span>:<span class="number">58</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            python3 <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>web<span class="operator">-</span>flask.py</span><br><span class="line">root                <span class="number">26278</span>               <span class="number">26273</span>               <span class="number">0</span>                   <span class="number">16</span>:<span class="number">58</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span>            <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>python3 <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>web<span class="operator">-</span>flask.py</span><br><span class="line">root                <span class="number">26400</span>               <span class="number">26231</span>               <span class="number">0</span>                   <span class="number">17</span>:<span class="number">03</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line">root                <span class="number">26441</span>               <span class="number">26252</span>               <span class="number">0</span>                   <span class="number">17</span>:<span class="number">05</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line">polkitd             <span class="number">26442</span>               <span class="number">26441</span>               <span class="number">0</span>                   <span class="number">17</span>:<span class="number">05</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            nginx: worker process</span><br><span class="line">polkitd             <span class="number">26443</span>               <span class="number">26441</span>               <span class="number">0</span>                   <span class="number">17</span>:<span class="number">05</span>               ?                   <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>            nginx: worker process</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="检查supervisor管理服务进程与日志"><a href="#检查supervisor管理服务进程与日志" class="headerlink" title="检查supervisor管理服务进程与日志"></a>检查supervisor管理服务进程与日志</h3><p><strong>检查进程，nginx与flask父进程都是supervisord服务，证明了是通过该工具进行运行</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@d6206468fdc5</span> conf.d]# ps <span class="operator">-</span>ef</span><br><span class="line">UID         PID   PPID  C STIME TTY          <span class="type">TIME</span> CMD</span><br><span class="line">root          <span class="number">1</span>      <span class="number">0</span>  <span class="number">0</span> <span class="number">08</span>:<span class="number">58</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>python <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>supervisord <span class="operator">-</span>c <span class="operator">/</span>etc<span class="operator">/</span>supervisord.conf</span><br><span class="line">root          <span class="number">9</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">08</span>:<span class="number">58</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> python3 <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>web<span class="operator">-</span>flask.py</span><br><span class="line">root         <span class="number">14</span>      <span class="number">9</span>  <span class="number">0</span> <span class="number">08</span>:<span class="number">58</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">04</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>python3 <span class="operator">/</span>app<span class="operator">/</span>web<span class="operator">-</span>flask<span class="operator">/</span>web<span class="operator">-</span>flask.py</span><br><span class="line">root         <span class="number">22</span>      <span class="number">0</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">03</span> pts<span class="operator">/</span><span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line">root         <span class="number">43</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">05</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line">nginx        <span class="number">44</span>     <span class="number">43</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">05</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">nginx        <span class="number">45</span>     <span class="number">43</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">05</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">root         <span class="number">47</span>     <span class="number">22</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">07</span> pts<span class="operator">/</span><span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> ps <span class="operator">-</span>ef</span><br></pre></td></tr></table></figure>

<p><strong>检查管理服务运行的日志目录</strong></p>
<p>管理的服务运行时的日志都存放到了配置文件中指定的存放路径下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@d6206468fdc5</span> conf.d]# ls <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>supervisor<span class="operator">/</span> <span class="operator">-</span>l</span><br><span class="line">total <span class="number">12</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  468 Jul 28 08:58 flask.log</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  393 Jul 28 09:05 nginx.log</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 1588 Jul 28 09:05 supervisord.log</span></span><br></pre></td></tr></table></figure>

<h2 id="3-supervisor管理进程命令用法"><a href="#3-supervisor管理进程命令用法" class="headerlink" title="3.supervisor管理进程命令用法"></a>3.supervisor管理进程命令用法</h2><blockquote>
<p>两种形式：1种是交互式，1种是非交互直接执行</p>
</blockquote>
<p><strong>进入容器</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">exec</span> <span class="operator">-</span>it d6206468fdc5 <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br></pre></td></tr></table></figure>

<p><strong>交互式管理</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker <span class="keyword">exec</span> <span class="operator">-</span>it d6206468fdc5 <span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line">[root<span class="variable">@d6206468fdc5</span> web<span class="operator">-</span>flask]# supervisorctl <span class="operator">-</span>c <span class="operator">/</span>etc<span class="operator">/</span>supervisord.conf   </span><br><span class="line">my<span class="operator">-</span>flask                         <span class="keyword">RUNNING</span>   pid <span class="number">9</span>, uptime <span class="number">0</span>:<span class="number">21</span>:<span class="number">34</span></span><br><span class="line">my<span class="operator">-</span>nginx                         <span class="keyword">RUNNING</span>   pid <span class="number">43</span>, uptime <span class="number">0</span>:<span class="number">14</span>:<span class="number">54</span></span><br><span class="line">supervisor<span class="operator">&gt;</span> status</span><br><span class="line">my<span class="operator">-</span>flask                         <span class="keyword">RUNNING</span>   pid <span class="number">9</span>, uptime <span class="number">0</span>:<span class="number">21</span>:<span class="number">39</span></span><br><span class="line">my<span class="operator">-</span>nginx                         <span class="keyword">RUNNING</span>   pid <span class="number">43</span>, uptime <span class="number">0</span>:<span class="number">14</span>:<span class="number">59</span></span><br></pre></td></tr></table></figure>

<p><strong>非交互式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看所有被管理的进程</span></span><br><span class="line">[root@d6206468fdc5 web-flask]# supervisorctl -c /etc/supervisord.conf   status</span><br><span class="line">my-flask                         RUNNING   pid 9, <span class="built_in">uptime</span> 0:22:57</span><br><span class="line">my-nginx                         RUNNING   pid 43, <span class="built_in">uptime</span> 0:16:17</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看某个被管理的进程</span></span><br><span class="line">[root@d6206468fdc5 web-flask]# supervisorctl -c /etc/supervisord.conf   status  my-flask</span><br><span class="line">my-flask                         RUNNING   pid 9, <span class="built_in">uptime</span> 0:23:06</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启所有被管理的进程</span></span><br><span class="line">[root@d6206468fdc5 web-flask]# supervisorctl -c /etc/supervisord.conf  restart all      </span><br><span class="line">my-flask: stopped</span><br><span class="line">my-nginx: stopped</span><br><span class="line">my-flask: started   关闭后自动开启了这就是这个工具的机制</span><br><span class="line">my-nginx: started</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启某个被管理的进程</span></span><br><span class="line">[root@d6206468fdc5 web-flask]# supervisorctl -c /etc/supervisord.conf  restart my-flask</span><br><span class="line">my-flask: stopped</span><br><span class="line">my-flask: started</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭所有被管理的进程</span></span><br><span class="line">supervisorctl -c /etc/supervisord.conf  stop all</span><br></pre></td></tr></table></figure>

<h2 id="4-最终验证容器内进程意外中断supervisor自动重启"><a href="#4-最终验证容器内进程意外中断supervisor自动重启" class="headerlink" title="4.最终验证容器内进程意外中断supervisor自动重启"></a>4.最终验证容器内进程意外中断supervisor自动重启</h2><p><strong>容器内运行的进程</strong></p>
<p><img src="/image-20240728172922783.png" alt="image-20240728172922783"></p>
<p><strong>模拟nginx服务运行意外中断,检查supervisor是否可以重启启动内部进程</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep nginx</span><br><span class="line">root      <span class="number">26606</span>  <span class="number">26252</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">21</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line">polkitd   <span class="number">26607</span>  <span class="number">26606</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">21</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">polkitd   <span class="number">26608</span>  <span class="number">26606</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">21</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">root      <span class="number">26667</span>  <span class="number">16187</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">25</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto nginx</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#pkill nginx</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#pkill nginx</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#pkill nginx</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep nginx</span><br><span class="line">root      <span class="number">26724</span>  <span class="number">16187</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto nginx</span></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#ps <span class="operator">-</span>ef<span class="operator">|</span>grep nginx</span><br><span class="line">root      <span class="number">26725</span>  <span class="number">26252</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master process nginx <span class="operator">-</span>g daemon off;</span><br><span class="line">polkitd   <span class="number">26726</span>  <span class="number">26725</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">polkitd   <span class="number">26727</span>  <span class="number">26725</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">root      <span class="number">26729</span>  <span class="number">16187</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">30</span> pts<span class="operator">/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="comment">--color=auto nginx</span></span><br></pre></td></tr></table></figure>

<p><strong>windos访问测试</strong></p>
<p>略过了</p>
<h1 id="五、dockerfile镜像多阶段构建"><a href="#五、dockerfile镜像多阶段构建" class="headerlink" title="五、dockerfile镜像多阶段构建"></a>五、dockerfile镜像多阶段构建</h1><blockquote>
<p>啥是多阶段镜像构建？</p>
<p>就是镜像构建时使用FROM指令调用其他镜像的运行环境，最终结合构建出的一个镜像</p>
<p>好处：省宿主机磁盘资源以及构建速度快</p>
</blockquote>
<h2 id="1-多阶段构建概述"><a href="#1-多阶段构建概述" class="headerlink" title="1.多阶段构建概述"></a>1.多阶段构建概述</h2><p>Dockerfile多阶段构建是Docker镜像构建中的一种高级技术，它允许在同一个Dockerfile文件中定义多个构建阶段，每个阶段都从一个基础镜像开始，并且可以包含一系列指令来构建和修改镜像。多阶段构建的主要目的是优化最终镜像的大小、构建速度和安全性，通过只在最终镜像中包含必要的文件和元数据，而排除所有不必要的工具和中间产物。</p>
<h3 id="1-1-多阶段构建的主要特点"><a href="#1-1-多阶段构建的主要特点" class="headerlink" title="1.1 多阶段构建的主要特点"></a>1.1 多阶段构建的主要特点</h3><ol>
<li><strong>优化镜像大小</strong>：通过只将每个阶段必需的最终产物复制到下一个阶段，可以显著减少最终镜像的大小。例如，在构建Java应用时，可能首先需要一个包含JDK的镜像来编译应用，但最终的运行时镜像只需要包含编译后的应用和其依赖，而不需要JDK。</li>
<li><strong>提高构建速度</strong>：由于每个阶段都可以独立构建，因此可以并行处理多个阶段的构建，从而加快整体构建速度。此外，通过减少最终镜像中不必要的层，也可以提高构建速度。</li>
<li><strong>增强安全性</strong>：通过分离构建和运行环境，可以减少潜在的安全风险。例如，构建阶段可能包含敏感信息（如源代码、构建脚本等），但在最终镜像中只包含编译后的二进制文件，从而减少了敏感信息的暴露。</li>
</ol>
<h3 id="1-2-多阶段构建的基本语法"><a href="#1-2-多阶段构建的基本语法" class="headerlink" title="1.2 多阶段构建的基本语法"></a>1.2 多阶段构建的基本语法</h3><p>在Dockerfile中，多阶段构建通过多个<code>FROM</code>指令来定义，每个<code>FROM</code>指令都标志着一个新阶段的开始。可以通过<code>AS</code>关键字为每个阶段指定一个别名，以便在后续阶段中引用。在复制文件时，可以使用<code>COPY --from=&lt;阶段别名&gt;</code>语法来从另一个阶段复制文件。</p>
<p><strong>示例：</strong></p>
<p>以下是一个Dockerfile多阶段构建的示例，该示例展示了如何构建一个包含静态网站的Nginx镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Dockerfile</span><br><span class="line"># 第一阶段：构建静态网站FROM node:14 AS buildWORKDIR /appCOPY ./src/ /app/RUN npm install &amp;&amp; npm run build</span><br><span class="line"># 第二阶段：构建Nginx镜像并复制静态网站文件FROM nginx:alpineCOPY --from=build /app/dist/ /usr/share/nginx/htmlEXPOSE 80CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;] </span><br></pre></td></tr></table></figure>

<p>在这个示例中，第一个阶段使用<code>node:14</code>镜像来构建静态网站，将源代码复制到<code>/app</code>目录，并运行npm命令来安装依赖和构建网站。构建完成后，将生成的静态文件（位于<code>/app/dist/</code>目录）复制到第二个阶段的Nginx镜像中，Nginx镜像用于提供静态文件的Web服务。最终，构建了一个只包含Nginx和静态文件的精简镜像。</p>
<h2 id="2-多阶段构建镜像tomcat"><a href="#2-多阶段构建镜像tomcat" class="headerlink" title="2.多阶段构建镜像tomcat"></a>2.多阶段构建镜像tomcat</h2><blockquote>
<p>1.先通过dockerfile构建centos镜像</p>
<p>2.再构建centos-jdk镜像，构建时直接调用上次构建的centos环境</p>
<p>3.最后构建tomacat镜像时，调用jdk+centos环境即可，无需再定义jdk与centos环境了</p>
</blockquote>
<h3 id="2-1-centos镜像"><a href="#2-1-centos镜像" class="headerlink" title="2.1  centos镜像"></a>2.1  centos镜像</h3><blockquote>
<p>作为基础镜像提供多阶段构建，在dockerfile构建时加上一些常用的软件包，以供其他镜像更好的使用</p>
</blockquote>
<h4 id="存放目录"><a href="#存放目录" class="headerlink" title="存放目录"></a>存放目录</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /dockerfile/centos7.9</span><br></pre></td></tr></table></figure>

<h4 id="dockerfile"><a href="#dockerfile" class="headerlink" title="dockerfile"></a>dockerfile</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 /dockerfile/centos7.9]#vim Dockerfile                                    </span><br><span class="line">[root@docker-01 /dockerfile/centos7.9]#<span class="built_in">cat</span> Dockerfile </span><br><span class="line"><span class="comment">#使用 CentOS 7.9.2009 镜像作为基础镜像</span></span><br><span class="line">FROM centos:7.9.2009</span><br><span class="line"></span><br><span class="line"><span class="comment">#替换默认的 CentOS 仓库为阿里云镜像，以加速 yum 安装过程</span></span><br><span class="line">RUN <span class="built_in">rm</span> -f /etc/yum.rpeos.d/* \</span><br><span class="line">&amp;&amp; curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo \</span><br><span class="line">&amp;&amp; curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装必要的软件包</span></span><br><span class="line">RUN yum install -y net-tools bash-completion supervisor vim \</span><br><span class="line">&amp;&amp; yum clean all \</span><br><span class="line">&amp;&amp; <span class="built_in">rm</span> -rf /var/cache/yum/*  </span><br><span class="line"></span><br><span class="line"><span class="comment">#设置时区为中国上海</span></span><br><span class="line">RUN <span class="built_in">rm</span> -rf /etc/localtime \</span><br><span class="line">&amp;&amp; <span class="built_in">ln</span> -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure>

<h4 id="构建镜像与检查"><a href="#构建镜像与检查" class="headerlink" title="构建镜像与检查"></a>构建镜像与检查</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#构建镜像</span></span><br><span class="line">[root@docker-01 /dockerfile/centos7.9]#docker build -t centos:7.9 .</span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像检查</span></span><br><span class="line">[root@docker-01 ~]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">centos       7.9       4e3332805815   3 minutes ago   289MB</span><br><span class="line">[root@docker-01 ~]#docker <span class="built_in">history</span> centos:7.9 </span><br></pre></td></tr></table></figure>

<h3 id="2-2-centos-jdk镜像"><a href="#2-2-centos-jdk镜像" class="headerlink" title="2.2 centos+jdk镜像"></a>2.2 centos+jdk镜像</h3><h4 id="存放目录-1"><a href="#存放目录-1" class="headerlink" title="存放目录"></a>存放目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-01 ~]#<span class="built_in">mkdir</span> /dockerfile/JDK-8u202</span><br><span class="line">[root@docker-01 ~]#<span class="built_in">cd</span> /dockerfile/JDK-8u202/</span><br></pre></td></tr></table></figure>

<h4 id="物料准备"><a href="#物料准备" class="headerlink" title="物料准备"></a>物料准备</h4><blockquote>
<p>这里配置Java环境变量是因为运行java程序时会通过变量调用jdk环境的一些依赖库与二进制命令</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>jdk编译好二进制压缩包</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#ls</span><br><span class="line">jdk<span class="number">-8</span>u202<span class="operator">-</span>linux<span class="operator">-</span>x64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>环境变量配置文件</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#cp <span class="operator">/</span>etc<span class="operator">/</span>profile .</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#vim profile </span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#tail profile </span><br><span class="line">#<span class="keyword">set</span> java enviroment</span><br><span class="line">JAVA_HOME<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>jdk  #注意这里的路径要与jdk压缩包解压后软链接的路径相同</span><br><span class="line">CLASSPATH<span class="operator">=</span>.:$JAVA_HOME<span class="operator">/</span>lib.tools.jar</span><br><span class="line">PATH<span class="operator">=</span>$JAVA_HOME<span class="operator">/</span>bin:$PATH</span><br><span class="line">export JAVA_HOME CLASSPATH PATH</span><br></pre></td></tr></table></figure>

<h4 id="dockerfile-1"><a href="#dockerfile-1" class="headerlink" title="dockerfile"></a>dockerfile</h4><blockquote>
<p>下方要注意的是：</p>
<p>1.FROM指定本地已有的centos镜像</p>
<p>2.ADD指令解压路径要与profile中定义的JAVA_HOAME路径相同</p>
<p>3.软链接的名要与JAVA_HOAME的目录名相同</p>
<p>4.ENV二次定义是为了直接运行java程序就可以调用jdk，profile中的变量需要开启bash环境</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#vim Dockerfile</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>JDK<span class="number">-8</span>u202]#cat Dockerfile </span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span> </span><br><span class="line"><span class="keyword">ADD</span> jdk<span class="number">-8</span>u221<span class="operator">-</span>linux<span class="operator">-</span>x64.tar.gz <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span> </span><br><span class="line"><span class="keyword">COPY</span> profile <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">RUN ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>jdk1<span class="number">.8</span><span class="number">.0</span>_202 <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>jdk</span><br><span class="line">ENV JAVA_HOME <span class="operator">/</span>app<span class="operator">/</span>tools<span class="operator">/</span>jdk</span><br><span class="line">ENV JRE_HOME $JAVA_HOME<span class="operator">/</span>jre</span><br><span class="line">ENV CLASSPATH $JAVA_HOME<span class="operator">/</span>lib:$JRE_HOME<span class="operator">/</span>lib</span><br><span class="line">ENV PATH $PATH:$JAVA_HOME<span class="operator">/</span>bin</span><br></pre></td></tr></table></figure>

<h4 id="构建jdk镜像与检查"><a href="#构建jdk镜像与检查" class="headerlink" title="构建jdk镜像与检查"></a>构建jdk镜像与检查</h4><blockquote>
<p>速度超快，调用了本地构建的centos镜像，无需去仓库中下载发行版了</p>
</blockquote>
<p><img src="/image-20240728191934650.png" alt="image-20240728191934650"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看镜像</span></span><br><span class="line">[root@docker-01 ~]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED             SIZE</span><br><span class="line">jdk          8u202     ffc46acfe2d5   2 minutes ago       691MB</span><br><span class="line">centos       7.9       4e3332805815   About an hour ago   289MB</span><br><span class="line">[root@docker-01 ~]#docker <span class="built_in">history</span> jdk</span><br></pre></td></tr></table></figure>

<p><strong>最终运行容器传入命令验证jdk环境</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#jdk环境镜像构建成功</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run <span class="operator">-</span>it <span class="comment">--rm ffc46acfe2d5 java -version</span></span><br><span class="line">java version &quot;1.8.0_202&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span><span class="number">.0</span>_202<span class="operator">-</span>b08)</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span><span class="operator">-</span>Bit Server VM (build <span class="number">25.202</span><span class="operator">-</span>b08, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="2-3-centos-jdk-tomcat-supervisor镜像"><a href="#2-3-centos-jdk-tomcat-supervisor镜像" class="headerlink" title="2.3 centos+jdk+tomcat+supervisor镜像"></a>2.3 centos+jdk+tomcat+supervisor镜像</h3><blockquote>
<p>tomcat官网下载：<a target="_blank" rel="noopener" href="https://archive.apache.org/dist/tomcat/">https://archive.apache.org/dist/tomcat/</a></p>
</blockquote>
<h4 id="物料准备-1"><a href="#物料准备-1" class="headerlink" title="物料准备"></a>物料准备</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>tomacat软件包</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#rz <span class="operator">-</span>E</span><br><span class="line">rz waiting <span class="keyword">to</span> receive.</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#ls</span><br><span class="line">apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>supervisor配置文件</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#vim tomcat.ini</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#cat tomcat.ini </span><br><span class="line">[program:tomcat]</span><br><span class="line">command<span class="operator">=</span><span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span>tomcat<span class="operator">/</span>bin<span class="operator">/</span>catalina.sh run #注意下这需要与tomcat解压路径一样</span><br><span class="line">autostart<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">autorestart<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">startsecs<span class="operator">=</span><span class="number">5</span></span><br><span class="line">redirect_stderr<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">stdout_logfile_maxbytes<span class="operator">=</span><span class="number">20</span>MB</span><br><span class="line">stdout_logfile_backups<span class="operator">=</span><span class="number">20</span></span><br><span class="line">stdout_logfile<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>supervisor<span class="operator">/</span>tomcat.log</span><br></pre></td></tr></table></figure>

<h4 id="dockerfile-2"><a href="#dockerfile-2" class="headerlink" title="dockerfile"></a>dockerfile</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#vim Dockerfile </span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#cat Dockerfile </span><br><span class="line"><span class="keyword">FROM</span> jdk:<span class="number">8</span>u202</span><br><span class="line">VOLUME <span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span></span><br><span class="line">VOLUME <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>supervisor<span class="operator">/</span></span><br><span class="line"><span class="keyword">ADD</span> apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>.tar.gz <span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span></span><br><span class="line">RUN ln <span class="operator">-</span>s <span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span>apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span> <span class="operator">/</span>app<span class="operator">/</span>software<span class="operator">/</span>tomcat </span><br><span class="line"><span class="keyword">COPY</span> tomcat.ini <span class="operator">/</span>etc<span class="operator">/</span>supervisord.d<span class="operator">/</span></span><br><span class="line">RUN sed <span class="operator">-</span>i <span class="string">&#x27;s/nodaemon=false/nodaemon=true/g&#x27;</span> <span class="operator">/</span>etc<span class="operator">/</span>supervisord.conf</span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line">CMD [&quot;supervisord&quot;, &quot;-c&quot;, &quot;/etc/supervisord.conf&quot;]</span><br></pre></td></tr></table></figure>

<h4 id="构建运行镜像"><a href="#构建运行镜像" class="headerlink" title="构建运行镜像"></a>构建运行镜像</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#构建</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#ls</span><br><span class="line">apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>.tar.gz  Dockerfile  tomcat.ini</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>dockerfile<span class="operator">/</span>tomcat<span class="number">-9.0</span><span class="number">.65</span>]#docker build <span class="operator">-</span>t tomcat:<span class="number">9.0</span><span class="number">.65</span> .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">tomcat       <span class="number">9.0</span><span class="number">.65</span>    <span class="number">135</span>c6db659a6   About a <span class="keyword">minute</span> ago   <span class="number">708</span>MB</span><br><span class="line">jdk          <span class="number">8</span>u202     ffc46acfe2d5   <span class="number">45</span> minutes ago       <span class="number">691</span>MB</span><br><span class="line">centos       <span class="number">7.9</span>       <span class="number">4e3332805815</span>   <span class="number">2</span> hours ago          <span class="number">289</span>MB</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker  history tomcat:<span class="number">9.0</span><span class="number">.65</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#运行tomcat容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run  <span class="operator">-</span>p <span class="number">80</span>:<span class="number">8080</span> <span class="comment">--rm --name tomcat-serve tomcat:9.0.65</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试构建速度超快</li>
</ul>
<p><img src="/image-20240728200301850.png" alt="image-20240728200301850"></p>
<h4 id="检查tomcat容器运行"><a href="#检查tomcat容器运行" class="headerlink" title="检查tomcat容器运行"></a>检查tomcat容器运行</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">docker top 容器id</span><br><span class="line">docker port 容器id</span><br></pre></td></tr></table></figure>

<p><img src="/image-20240728202451944.png" alt="image-20240728202451944"></p>
<h3 id="2-4-访问tomcat映射地址"><a href="#2-4-访问tomcat映射地址" class="headerlink" title="2.4 访问tomcat映射地址"></a>2.4 访问tomcat映射地址</h3><ul>
<li>至此，centos+jdk+tomcat+supervisor镜像构建完毕，基于镜像运行的容器检查运行环境也无误</li>
</ul>
<p><img src="/image-20240728202945053.png" alt="image-20240728202945053"></p>
<h1 id="六、容器化部署java项目-jpress博客"><a href="#六、容器化部署java项目-jpress博客" class="headerlink" title="六、容器化部署java项目-jpress博客"></a>六、容器化部署java项目-jpress博客</h1><blockquote>
<p>jpress这个web应用程序，需要数据库的支持方可部署上线</p>
</blockquote>
<h2 id="1-MSYQL数据库准备"><a href="#1-MSYQL数据库准备" class="headerlink" title="1.MSYQL数据库准备"></a>1.MSYQL数据库准备</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#镜像准备</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker images</span><br><span class="line">mysql        latest    <span class="number">3218</span>b38490ce   <span class="number">2</span> years ago      <span class="number">516</span>MB</span><br><span class="line"></span><br><span class="line">#运行mysql容器</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker run  <span class="comment">--name web-mysql --rm -e MYSQL_ROOT_PASSWORD=1 -d  mysql:latest </span></span><br><span class="line"><span class="number">76617</span>f5e89bbea548a901707b90efc7f214b34558fd7bd85a62067fe1b39e96b</span><br><span class="line"></span><br><span class="line">#检查容器运行</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps <span class="operator">-</span>a</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                 NAMES</span><br></pre></td></tr></table></figure>

<p><strong>检查容器内mysql服务运行</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#可以连接</span><br><span class="line">root<span class="variable">@76617f5e89bb</span>:<span class="operator">~</span># mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>h172<span class="number">.17</span><span class="number">.0</span><span class="number">.2</span> <span class="operator">-</span>P3306</span><br><span class="line">Enter password: #密码<span class="number">1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="2-启动tomcat容器"><a href="#2-启动tomcat容器" class="headerlink" title="2.启动tomcat容器"></a>2.启动tomcat容器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动tomcat容器，链接mysql容器，映射宿主机端口</span></span><br><span class="line">[root@docker-01 ~]#[root@docker-01 ~]#docker run -d --name web-tomcat --<span class="built_in">link</span>=web-mysql -p 80:8080  tomcat:9.0.65 </span><br><span class="line">969301c120bb64ffc6ab868078428bcabb235f0622d7216a826981f2ecb0b9dd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查容器进程</span></span><br><span class="line">[root@docker-01 ~]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS          PORTS                                   NAMES</span><br><span class="line">a8a998b4fd84   tomcat:9.0.65   <span class="string">&quot;supervisord -c /etc…&quot;</span>   5 seconds ago    Up 3 seconds    0.0.0.0:80-&gt;8080/tcp, :::80-&gt;8080/tcp   web-tomcat-mysql</span><br><span class="line">76617f5e89bb   mysql:latest    <span class="string">&quot;docker-entrypoint.s…&quot;</span>   26 minutes ago   Up 26 minutes   3306/tcp, 33060/tcp                     web-mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查数据卷挂载情况</span></span><br><span class="line">    <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/app/software&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;68fb26170825e1910f9c51c0a347bf7f508ec58a33c5472f76f2676ef30f4abe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/68fb26170825e1910f9c51c0a347bf7f508ec58a33c5472f76f2676ef30f4abe/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/var/log/supervisor&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p><strong>查看宿主机&#x2F;app&#x2F;software挂载的数据卷，进入解压的tomcat目录中</strong></p>
<blockquote>
<p>tomcat的运行环境自动挂载了宿主机的数据卷，是因为Dockerfile中定义了volume指令</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入docker数据卷存放目录中</span></span><br><span class="line">[root@docker-01 ~]#<span class="built_in">cd</span> /var/lib/docker/volumes/</span><br><span class="line">[root@docker-01 /var/lib/docker/volumes]#<span class="built_in">ls</span></span><br><span class="line">0bac6c68271101074d16f4a25a495df3d52965b22206858e9dc1958364741d34  backingFsBlockDev</span><br><span class="line">2cd4628653fa5fe699ee21c2ab94ed340e046a0ccc04505f95a6b0e7c07c7196  cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20</span><br><span class="line">5ae8c31da1cf8d5cd131a1087a4cffce81b502966ca22abd144b2797682b0aef  d1d3d1c4c7b29e2122496ee37bfb766c74d61ed112fada1f2f25e47306f775c4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入tomcat容器挂载的数据卷目录</span></span><br><span class="line">[root@docker-01 /var/lib/docker/volumes]#<span class="built_in">cd</span> cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20/_data</span><br><span class="line">[root@docker-01 /var/lib/docker/volumes/cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20/_data]#<span class="built_in">ls</span></span><br><span class="line">apache-tomcat-9.0.65  tomcat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#解压后的tomcat数据目录下的目录结构</span></span><br><span class="line">[root@docker-01 /var/lib/docker/volumes/cb6540f89710369d869f8d21a6a68c9b66537b2f9d28385540d10894fc752b20/_data/apache-tomcat-9.0.65]#<span class="built_in">ls</span></span><br><span class="line">bin  BUILDING.txt  conf  CONTRIBUTING.md  lib  LICENSE  logs  NOTICE  README.md  RELEASE-NOTES  RUNNING.txt  temp  webapps  work</span><br></pre></td></tr></table></figure>

<h2 id="3-Jpress应用部署"><a href="#3-Jpress应用部署" class="headerlink" title="3.Jpress应用部署"></a>3.Jpress应用部署</h2><blockquote>
<p>至此准备好了tomcat与mysql容器环境，可以部署jpress应用了</p>
<p>准备好jpress代码war包，放入宿主机的数据卷映射的&#x2F;app&#x2F;software&#x2F;tomcat&#x2F;webapps即可</p>
</blockquote>
<p><strong>数据卷所在目录</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker ps</span><br><span class="line">CONTAINER ID   IMAGE           COMMAND                  CREATED         STATUS         PORTS                                   NAMES</span><br><span class="line"><span class="number">969301</span>c120bb   tomcat:<span class="number">9.0</span><span class="number">.65</span>   &quot;supervisord -c /etc…&quot;   <span class="number">5</span> minutes ago   Up <span class="number">5</span> minutes   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">8080</span><span class="operator">/</span>tcp, :::<span class="number">80</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">8080</span><span class="operator">/</span>tcp   web<span class="operator">-</span>tomcat</span><br><span class="line"><span class="number">76617</span>f5e89bb   mysql:latest    &quot;docker-entrypoint.s…&quot;   <span class="number">2</span> days ago      Up <span class="number">2</span> days      <span class="number">3306</span><span class="operator">/</span>tcp, <span class="number">33060</span><span class="operator">/</span>tcp                     web<span class="operator">-</span>mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">~</span>]#docker inspect <span class="number">969</span></span><br><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">            &quot;Name&quot;: &quot;20b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b&quot;,</span><br><span class="line">            &quot;Source&quot;: &quot;/var/lib/docker/volumes/20b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b/_data&quot;,</span><br><span class="line">            &quot;Destination&quot;: &quot;/app/software&quot;,</span><br><span class="line">            &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">            &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;RW&quot;: <span class="literal">true</span>,</span><br><span class="line">            &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>

<p><strong>进入对应数据卷的tomcat数据目录中的子目录webapps，将代码放入该目录</strong></p>
<blockquote>
<p>这个代码得找个压缩好的war包，官网下载的只有源码无法maven编译成jar包或war包</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#进入webapps目录</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span><span class="number">20</span>b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b<span class="operator">/</span>_data<span class="operator">/</span>apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span><span class="operator">/</span>webapps]#ll</span><br><span class="line">total <span class="number">4</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 15 root root 4096 Jul 31 11:00 docs</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---.  7 root root   99 Jul 31 11:00 examples</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---.  6 root root   79 Jul 31 11:00 host-manager</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---.  6 root root  114 Jul 31 11:00 manager</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---.  3 root root  223 Jul 31 11:00 ROOT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#放入代码</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span><span class="number">20</span>b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b<span class="operator">/</span>_data<span class="operator">/</span>apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span><span class="operator">/</span>webapps]#rz <span class="operator">-</span>E</span><br><span class="line">rz waiting <span class="keyword">to</span> receive.</span><br><span class="line">#自动解压缩加载java程序运行</span><br><span class="line">[root<span class="variable">@docker</span><span class="number">-01</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>docker<span class="operator">/</span>volumes<span class="operator">/</span><span class="number">20</span>b01b096f4c2f8a128b99ae4f7c98d8fee437107d1e9ef56214d2b2ebfc987b<span class="operator">/</span>_data<span class="operator">/</span>apache<span class="operator">-</span>tomcat<span class="number">-9.0</span><span class="number">.65</span><span class="operator">/</span>webapps]#ls</span><br><span class="line">docs  examples  host<span class="operator">-</span>manager  jpress  jpress.war  manager  ROOT</span><br></pre></td></tr></table></figure>

<h2 id="4-访问web测试结果"><a href="#4-访问web测试结果" class="headerlink" title="4.访问web测试结果"></a>4.访问web测试结果</h2><p>访问10.0.0.107&#x2F;jpress初始化安装即可</p>
<p><img src="/image-20240731111224126.png" alt="image-20240731111224126"></p>
<p>初始化后发布一篇文章</p>
<p><img src="/image-20240731111852378.png" alt="image-20240731111852378"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">赵东兴</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/">http://example.com/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/" title="容器Docker-部署应用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">容器Docker-部署应用</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8/" title="容器Docker-网络存储"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">容器Docker-网络存储</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">赵东兴</div><div class="author-info__description">个人技术笔记博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81dockerfile%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">一、dockerfile原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8E%E6%8F%90%E4%BA%A4%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.</span> <span class="toc-text">1.镜像构建与提交的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8F%AF%E9%87%8D%E5%A4%8D%E6%80%A7"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 可重复性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 版本控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%8F%AF%E9%80%8F%E6%98%8E%E6%80%A7"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 可透明性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E5%88%A9%E4%BA%8E%E7%90%86%E8%A7%A3%E4%B8%8E%E7%BB%B4%E6%8A%A4"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 利于理解与维护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E8%87%AA%E5%8A%A8%E5%8C%96"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5 自动化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-%E6%80%BB%E7%BB%93"><span class="toc-number">1.1.6.</span> <span class="toc-text">1.6 总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-docker%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.</span> <span class="toc-text">2.docker镜像构建缓存机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-dockerfile%E4%BA%8C%E6%AC%A1%E6%8C%87%E5%AE%9Ajdk%E5%8F%98%E9%87%8F"><span class="toc-number">1.3.</span> <span class="toc-text">3.dockerfile二次指定jdk变量</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81dockerfile%E6%8C%87%E4%BB%A4"><span class="toc-number">2.</span> <span class="toc-text">二、dockerfile指令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-run%E6%8C%87%E4%BB%A4"><span class="toc-number">2.1.</span> <span class="toc-text">1.run指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2 为什么使用 &amp;&amp;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%BD%95%E6%97%B6%E4%B8%8D%E4%BD%BF%E7%94%A8"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3 何时不使用 &amp;&amp;</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-cmd%E6%8C%87%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text">2.cmd指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-volume%E6%8C%87%E4%BB%A4"><span class="toc-number">2.3.</span> <span class="toc-text">3.volume指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Dockerfile%E7%9A%84VOLUME%E6%8C%87%E4%BB%A4"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1 Dockerfile的VOLUME指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-docker-run-v%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2 docker run -v命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%BB%93%E8%AE%BA"><span class="toc-number">2.3.3.</span> <span class="toc-text">3.3 结论</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-workdir%E6%8C%87%E4%BB%A4"><span class="toc-number">2.4.</span> <span class="toc-text">4.workdir指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-entrypoint%E6%8C%87%E4%BB%A4"><span class="toc-number">2.5.</span> <span class="toc-text">5.entrypoint指令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81dockerfile%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">三、dockerfile镜像构建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-centos-nginx%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA-run-v%E5%88%9B%E5%BB%BA%E5%8D%B7"><span class="toc-number">3.1.</span> <span class="toc-text">1.centos+nginx镜像构建(run-v创建卷)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%A6%E5%86%99dockerfile%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-number">3.1.1.</span> <span class="toc-text">书写dockerfile构建镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8%E4%B8%8D-v%E6%8C%82%E8%BD%BD%E6%9F%A5%E7%9C%8B%E5%8D%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">3.1.2.</span> <span class="toc-text">运行容器不-v挂载查看卷信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8-v%E6%8C%82%E8%BD%BD%E6%9F%A5%E7%9C%8B%E5%8D%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">3.1.3.</span> <span class="toc-text">运行容器-v挂载查看卷信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-centos-nginx%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA-volume%E6%8C%87%E4%BB%A4%E5%88%9B%E5%BB%BA%E5%8D%B7"><span class="toc-number">3.2.</span> <span class="toc-text">2.centos+nginx镜像构建(volume指令创建卷)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%A6%E5%86%99dockerfile%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E2%80%93%E4%BD%BF%E7%94%A8volume%E6%8C%87%E4%BB%A4"><span class="toc-number">3.2.1.</span> <span class="toc-text">书写dockerfile构建镜像–使用volume指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8%E8%87%AA%E5%8A%A8%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.2.</span> <span class="toc-text">检查运行容器自动挂载数据卷</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-centos-python3-flask%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA-%E4%BB%A3%E7%A0%81%E8%BF%9E%E6%8E%A5redis"><span class="toc-number">3.3.</span> <span class="toc-text">3.centos+python3+flask镜像构建(代码连接redis)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%AE%B9%E5%99%A8%E5%87%86%E5%A4%87"><span class="toc-number">3.3.1.</span> <span class="toc-text">redis容器准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask%E4%BB%A3%E7%A0%81%E5%87%86%E5%A4%87"><span class="toc-number">3.3.2.</span> <span class="toc-text">flask代码准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dockerfile%E7%89%A9%E6%96%99%E5%87%86%E5%A4%87"><span class="toc-number">3.3.3.</span> <span class="toc-text">dockerfile物料准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dockerfile%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-number">3.3.4.</span> <span class="toc-text">dockerfile构建镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask%E5%AE%B9%E5%99%A8%E8%BF%9E%E6%8E%A5redis%E8%BF%90%E8%A1%8C"><span class="toc-number">3.3.5.</span> <span class="toc-text">flask容器连接redis运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask%E6%97%A0%E6%B3%95%E8%BF%9E%E6%8E%A5redis%E8%A7%A3%E5%86%B3%E6%8A%A5%E9%94%99"><span class="toc-number">3.3.6.</span> <span class="toc-text">flask无法连接redis解决报错</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81supervisor%E5%AE%B9%E5%99%A8%E5%86%85%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="toc-number">4.</span> <span class="toc-text">四、supervisor容器内服务进程管理工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-supervisor%E6%A6%82%E8%BF%B0"><span class="toc-number">4.1.</span> <span class="toc-text">1.supervisor概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-flask%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E5%8D%87%E7%BA%A7%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-number">4.2.</span> <span class="toc-text">2.flask运行环境升级构建镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C"><span class="toc-number">4.2.1.</span> <span class="toc-text">redis容器运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dockrfile%E7%89%A9%E6%96%99%E5%87%86%E5%A4%87"><span class="toc-number">4.2.2.</span> <span class="toc-text">dockrfile物料准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dockerfile%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F-1"><span class="toc-number">4.2.3.</span> <span class="toc-text">dockerfile构建镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask%E9%93%BE%E6%8E%A5redis%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E5%B9%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">4.2.4.</span> <span class="toc-text">flask链接redis容器运行并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5supervisor%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B%E4%B8%8E%E6%97%A5%E5%BF%97"><span class="toc-number">4.2.5.</span> <span class="toc-text">检查supervisor管理服务进程与日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-supervisor%E7%AE%A1%E7%90%86%E8%BF%9B%E7%A8%8B%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95"><span class="toc-number">4.3.</span> <span class="toc-text">3.supervisor管理进程命令用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9C%80%E7%BB%88%E9%AA%8C%E8%AF%81%E5%AE%B9%E5%99%A8%E5%86%85%E8%BF%9B%E7%A8%8B%E6%84%8F%E5%A4%96%E4%B8%AD%E6%96%ADsupervisor%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF"><span class="toc-number">4.4.</span> <span class="toc-text">4.最终验证容器内进程意外中断supervisor自动重启</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81dockerfile%E9%95%9C%E5%83%8F%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA"><span class="toc-number">5.</span> <span class="toc-text">五、dockerfile镜像多阶段构建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">1.多阶段构建概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA%E7%9A%84%E4%B8%BB%E8%A6%81%E7%89%B9%E7%82%B9"><span class="toc-number">5.1.1.</span> <span class="toc-text">1.1 多阶段构建的主要特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">5.1.2.</span> <span class="toc-text">1.2 多阶段构建的基本语法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8Ftomcat"><span class="toc-number">5.2.</span> <span class="toc-text">2.多阶段构建镜像tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-centos%E9%95%9C%E5%83%8F"><span class="toc-number">5.2.1.</span> <span class="toc-text">2.1  centos镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">存放目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dockerfile"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E4%B8%8E%E6%A3%80%E6%9F%A5"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">构建镜像与检查</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-centos-jdk%E9%95%9C%E5%83%8F"><span class="toc-number">5.2.2.</span> <span class="toc-text">2.2 centos+jdk镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95-1"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">存放目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%A9%E6%96%99%E5%87%86%E5%A4%87"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">物料准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dockerfile-1"><span class="toc-number">5.2.2.3.</span> <span class="toc-text">dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BAjdk%E9%95%9C%E5%83%8F%E4%B8%8E%E6%A3%80%E6%9F%A5"><span class="toc-number">5.2.2.4.</span> <span class="toc-text">构建jdk镜像与检查</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-centos-jdk-tomcat-supervisor%E9%95%9C%E5%83%8F"><span class="toc-number">5.2.3.</span> <span class="toc-text">2.3 centos+jdk+tomcat+supervisor镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%A9%E6%96%99%E5%87%86%E5%A4%87-1"><span class="toc-number">5.2.3.1.</span> <span class="toc-text">物料准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dockerfile-2"><span class="toc-number">5.2.3.2.</span> <span class="toc-text">dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E8%BF%90%E8%A1%8C%E9%95%9C%E5%83%8F"><span class="toc-number">5.2.3.3.</span> <span class="toc-text">构建运行镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5tomcat%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C"><span class="toc-number">5.2.3.4.</span> <span class="toc-text">检查tomcat容器运行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E8%AE%BF%E9%97%AEtomcat%E6%98%A0%E5%B0%84%E5%9C%B0%E5%9D%80"><span class="toc-number">5.2.4.</span> <span class="toc-text">2.4 访问tomcat映射地址</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2java%E9%A1%B9%E7%9B%AE-jpress%E5%8D%9A%E5%AE%A2"><span class="toc-number">6.</span> <span class="toc-text">六、容器化部署java项目-jpress博客</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MSYQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%86%E5%A4%87"><span class="toc-number">6.1.</span> <span class="toc-text">1.MSYQL数据库准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%90%AF%E5%8A%A8tomcat%E5%AE%B9%E5%99%A8"><span class="toc-number">6.2.</span> <span class="toc-text">2.启动tomcat容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Jpress%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">6.3.</span> <span class="toc-text">3.Jpress应用部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%AE%BF%E9%97%AEweb%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-number">6.4.</span> <span class="toc-text">4.访问web测试结果</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93Redis-%E6%9C%8D%E5%8A%A1%E4%BC%98%E5%8C%96/" title="数据库Redis-服务优化">数据库Redis-服务优化</a><time datetime="2024-08-20T03:44:08.000Z" title="Created 2024-08-20 11:44:08">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93Redis-%E5%88%86%E5%B8%83%E9%9B%86%E7%BE%A4/" title="数据库Redis-分布集群">数据库Redis-分布集群</a><time datetime="2024-08-20T03:43:56.000Z" title="Created 2024-08-20 11:43:56">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93Redis-%E5%93%A8%E5%85%B5%E5%8A%9F%E8%83%BD/" title="数据库Redis-哨兵功能">数据库Redis-哨兵功能</a><time datetime="2024-08-20T03:43:39.000Z" title="Created 2024-08-20 11:43:39">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93Redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" title="数据库Redis-主从复制">数据库Redis-主从复制</a><time datetime="2024-08-20T03:43:24.000Z" title="Created 2024-08-20 11:43:24">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E6%95%B0%E6%8D%AE%E5%BA%93Redis-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85/" title="数据库Redis-数据持久">数据库Redis-数据持久</a><time datetime="2024-08-20T03:43:10.000Z" title="Created 2024-08-20 11:43:10">2024-08-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 赵东兴</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>