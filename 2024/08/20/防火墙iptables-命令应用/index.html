<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>防火墙iptables-命令应用 | 一往无前虎山行,拨开云雾见光明</title><meta name="author" content="赵东兴"><meta name="copyright" content="赵东兴"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="iptables使用指南1.命令语法iptables会根据如下设定的条件对数据包信息进行过滤，如果匹配到和条件相符的信息对数据包进行动作处理 命令执行需按参数顺序进行定义，不指定参数默认表示所有  2.参数大全 -A, –append：向规则链中后方追加新规则 -D, –delete：从规则链中删除规则 -I, –insert：在规则链中头部插入新规则 -R, –replace：替换规则链中的规则">
<meta property="og:type" content="article">
<meta property="og:title" content="防火墙iptables-命令应用">
<meta property="og:url" content="http://example.com/2024/08/20/%E9%98%B2%E7%81%AB%E5%A2%99iptables-%E5%91%BD%E4%BB%A4%E5%BA%94%E7%94%A8/index.html">
<meta property="og:site_name" content="一往无前虎山行,拨开云雾见光明">
<meta property="og:description" content="iptables使用指南1.命令语法iptables会根据如下设定的条件对数据包信息进行过滤，如果匹配到和条件相符的信息对数据包进行动作处理 命令执行需按参数顺序进行定义，不指定参数默认表示所有  2.参数大全 -A, –append：向规则链中后方追加新规则 -D, –delete：从规则链中删除规则 -I, –insert：在规则链中头部插入新规则 -R, –replace：替换规则链中的规则">
<meta property="og:locale">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-08-20T03:25:18.000Z">
<meta property="article:modified_time" content="2024-08-20T03:33:48.164Z">
<meta property="article:author" content="赵东兴">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/08/20/%E9%98%B2%E7%81%AB%E5%A2%99iptables-%E5%91%BD%E4%BB%A4%E5%BA%94%E7%94%A8/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '防火墙iptables-命令应用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-20 11:33:48'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="一往无前虎山行,拨开云雾见光明" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="一往无前虎山行,拨开云雾见光明"><span class="site-name">一往无前虎山行,拨开云雾见光明</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">防火墙iptables-命令应用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-08-20T03:25:18.000Z" title="Created 2024-08-20 11:25:18">2024-08-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-08-20T03:33:48.164Z" title="Updated 2024-08-20 11:33:48">2024-08-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="防火墙iptables-命令应用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="iptables使用指南"><a href="#iptables使用指南" class="headerlink" title="iptables使用指南"></a>iptables使用指南</h1><h2 id="1-命令语法"><a href="#1-命令语法" class="headerlink" title="1.命令语法"></a>1.命令语法</h2><p>iptables会根据如下设定的条件对数据包信息进行过滤，如果匹配到和条件相符的信息对数据包进行动作处理</p>
<p>命令执行需按参数顺序进行定义，不指定参数默认表示所有</p>
<p><img src="/image-20240710135655835.png" alt="image-20240710135655835"></p>
<h2 id="2-参数大全"><a href="#2-参数大全" class="headerlink" title="2.参数大全"></a>2.参数大全</h2><ol>
<li>-A, –append：向规则链中后方追加新规则</li>
<li>-D, –delete：从规则链中删除规则</li>
<li>-I, –insert：在规则链中头部插入新规则</li>
<li>-R, –replace：替换规则链中的规则</li>
<li>-L, –list：列出规则链中的规则</li>
<li>-F, –flush：清空规则链中的所有规则</li>
<li>-N, –new-chain：创建新的用户自定义链</li>
<li>-X, –delete-chain：删除规则链</li>
<li>-P, –policy：设置规则链的默认策略</li>
<li>-s, –source：指定数据包的源IP地址</li>
<li>-d, –destination：指定数据包的目标IP地址</li>
<li>-p, –protocol：指定数据包所使用的协议</li>
<li>–sport：指定数据包的源端口</li>
<li>–dport：指定数据包的目标端口</li>
<li>-j, –jump：指定针对匹配规则的操作</li>
<li>-i, –in-interface：指定数据包的输入接口</li>
<li>-o, –out-interface：指定数据包的输出接口</li>
<li>-m, –match：指定要应用的匹配扩展模块</li>
<li>-c, –set-counters：设置规则的数据包和字节计数器</li>
<li>-t, –table：指定要操作的表（如filter、nat、mangle等）</li>
</ol>
<h2 id="3-安装扩展包"><a href="#3-安装扩展包" class="headerlink" title="3.安装扩展包"></a>3.安装扩展包</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install iptables<span class="operator">-</span>services <span class="operator">-</span>y</span><br></pre></td></tr></table></figure>

<p>安装iptables-services扩展包提供了一些额外的功能和工具，主要包括以下几个方面：</p>
<ol>
<li>管理服务：iptables-services包提供了一些管理iptables防火墙规则的服务，如iptables.service和ip6tables.service，这些服务可以帮助用户方便地启动、停止、重新加载和管理iptables防火墙。</li>
<li>配置文件：iptables-services还包含了一些额外的配置文件，如&#x2F;etc&#x2F;sysconfig&#x2F;iptables和&#x2F;etc&#x2F;sysconfig&#x2F;ip6tables，这些配置文件可以帮助用户更灵活地配置iptables规则。</li>
<li>脚本工具：iptables-services还提供了一些脚本工具，如iptables-save和iptables-restore，这些工具可以帮助用户保存和恢复iptables规则，简化规则管理的过程。</li>
</ol>
<p>总的来说，安装iptables-services扩展包可以增强iptables防火墙的功能和管理能力，使用户更方便地管理和配置iptables规则，同时提供一些额外的工具和服务，帮助用户更好地保护系统和网络安全。</p>
<h2 id="4-加载内核模块"><a href="#4-加载内核模块" class="headerlink" title="4.加载内核模块"></a>4.加载内核模块</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#加载</span><br><span class="line">modprobe ip_tables</span><br><span class="line">modprobe iptable_filter</span><br><span class="line">modprobe iptable_nat</span><br><span class="line">modprobe ip_conntrack</span><br><span class="line">modprobe ip_conntrack_ftp</span><br><span class="line">modprobe ip_nat_ftp</span><br><span class="line">modprobe ipt_state</span><br><span class="line"></span><br><span class="line">#查看</span><br><span class="line">lsmod<span class="operator">|</span>egrep <span class="string">&#x27;filter|nat|ipt&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看结果</span><br><span class="line">nf_nat_ftp             <span class="number">12809</span>  <span class="number">0</span> </span><br><span class="line">nf_conntrack_ftp       <span class="number">18478</span>  <span class="number">1</span> nf_nat_ftp</span><br><span class="line">iptable_nat            <span class="number">12875</span>  <span class="number">0</span> </span><br><span class="line">nf_nat_ipv4            <span class="number">14115</span>  <span class="number">1</span> iptable_nat</span><br><span class="line">nf_nat                 <span class="number">26583</span>  <span class="number">2</span> nf_nat_ftp,nf_nat_ipv4</span><br><span class="line">nf_conntrack          <span class="number">139264</span>  <span class="number">6</span> nf_nat_ftp,nf_nat,xt_state,nf_nat_ipv4,nf_conntrack_ftp,nf_conntrack_ipv4</span><br><span class="line">iptable_filter         <span class="number">12810</span>  <span class="number">0</span> </span><br><span class="line">ip_tables              <span class="number">27126</span>  <span class="number">2</span> iptable_filter,iptable_nat</span><br><span class="line">libcrc32c              <span class="number">12644</span>  <span class="number">3</span> xfs,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure>

<p><strong>为什么要加载这些模块</strong></p>
<blockquote>
<p>加载这些内核模块是为了启用Linux系统的防火墙和网络地址转换（NAT）功能</p>
</blockquote>
<ul>
<li><code>ip_tables</code>模块提供了iptables，这是Linux系统中用于配置防火墙规则的主要工具。</li>
<li><code>iptable_filter</code>模块是用于过滤的基本防火墙规则。</li>
<li><code>iptable_nat</code>模块用于对网络地址进行转换，实现NAT功能，允许在私有网络和公共网络之间进行地址转换。</li>
<li><code>ip_conntrack</code>模块用于连接跟踪，它可以跟踪网络连接的状态，以便对连接进行管理和策略控制。</li>
<li><code>ip_conntrack_ftp</code>和<code>ip_nat_ftp</code>模块提供了对FTP协议的特殊支持，允许在NAT环境下正确处理FTP数据连接。</li>
<li><code>ipt_state</code>模块提供了对连接状态的跟踪，用于防火墙规则中的状态匹配。</li>
</ul>
<p>如果不加载这些内核模块，防火墙和NAT功能将无法正常工作。因此，加载这些模块是确保系统能够进行网络安全和连接管理的关键步骤。</p>
<p><strong>加载后进行查看，输出信息解释</strong></p>
<ul>
<li>nf_nat_ftp 是一个模块，其大小为12809，目前没有被使用（使用计数为0）。</li>
<li>nf_conntrack_ftp 是另一个模块，其大小为18478，被一个nf_nat_ftp模块使用。</li>
<li>iptable_nat 是一个模块，其大小为12875，目前没有被使用。</li>
<li>nf_nat_ipv4 是一个模块，其大小为14115，被iptable_nat模块使用。</li>
<li>nf_nat 是一个模块，其大小为26583，被nf_nat_ftp和nf_nat_ipv4模块使用。</li>
<li>nf_conntrack 是一个模块，其大小为139264，被nf_nat_ftp、nf_nat、xt_state、nf_nat_ipv4、nf_conntrack_ftp和nf_conntrack_ipv4模块使用。</li>
<li>iptable_filter 是一个模块，其大小为12810，目前没有被使用。</li>
<li>ip_tables 是一个模块，其大小为27126，被iptable_filter和iptable_nat模块使用。</li>
<li>libcrc32c 是一个模块，其大小为12644，被xfs、nf_nat和nf_conntrack模块使用。</li>
</ul>
<p>这些模块是Linux内核的一部分，用于实现网络连接跟踪、网络地址转换（NAT）、数据包过滤等功能。每个模块都具有特定的功能，并以一种协同的方式工作。</p>
<p><strong>内核模块是什么</strong></p>
<blockquote>
<p>就是个程序可通过启动动态修改内核扩展一些功能</p>
</blockquote>
<p>Linux内核模块是一种动态加载到Linux内核中以扩展其功能的软件组件。它们允许在运行时向内核添加新功能或驱动程序，而无需重新编译或重新启动整个内核。</p>
<p>内核模块通常用于实现设备驱动程序、文件系统、网络协议栈、安全模块等功能。它们可以在系统启动时自动加载，也可以在需要时手动加载。</p>
<p>内核模块通常以 .ko 文件扩展名存储在系统中，并可以通过命令行工具（如 insmod、rmmod、modprobe）加载或卸载。内核模块的源代码通常以C语言编写，需要符合Linux内核的编程接口和模块规范。</p>
<p>总之，Linux内核模块是用于扩展Linux内核功能的动态加载的软件组件，它们为Linux系统提供了灵活性和可扩展性。</p>
<h2 id="5-启动iptables"><a href="#5-启动iptables" class="headerlink" title="5.启动iptables"></a>5.启动iptables</h2><blockquote>
<p>两者都是防火墙管理工具使用其一即可</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl <span class="keyword">start</span> iptables.service</span><br><span class="line">systemctl enable iptables.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动后会生成一些默认规则，删除清空即可</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">ACCEPT     <span class="keyword">all</span>  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED</span></span><br><span class="line">ACCEPT     icmp <span class="comment">--  0.0.0.0/0            0.0.0.0/0           </span></span><br><span class="line">ACCEPT     <span class="keyword">all</span>  <span class="comment">--  0.0.0.0/0            0.0.0.0/0           </span></span><br><span class="line">ACCEPT     tcp  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22</span></span><br><span class="line">REJECT     <span class="keyword">all</span>  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited</span></span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">REJECT     <span class="keyword">all</span>  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited</span></span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination   </span><br></pre></td></tr></table></figure>

<h1 id="iptables核心命令"><a href="#iptables核心命令" class="headerlink" title="iptables核心命令"></a>iptables核心命令</h1><h2 id="1-查看规则"><a href="#1-查看规则" class="headerlink" title="1.查看规则"></a>1.查看规则</h2><blockquote>
<p>组合使用时必须n在前L在后 <code>-nL</code></p>
</blockquote>
<p><code>-n</code> 或 <code>--numeric</code>：这个参数用于在输出规则时，以数字形式显示IP地址和端口号，而不会尝试将IP地址解析为域名。这对于加快输出速度，特别是在规则中存在大量IP地址或端口号的情况下有用。</p>
<p><code>-L</code>：这个参数用于列出所有链的规则，不指定表名默认查看的是filter表，查看其他表需要指定。</p>
<p><code>--line-num</code>：这个参数用于在输出规则时显示规则的行号。这对于在规则中进行修改或删除操作时非常有用，因为可以准确指定要操作的规则行号。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">ACCEPT     <span class="keyword">all</span>  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED</span></span><br><span class="line">ACCEPT     icmp <span class="comment">--  0.0.0.0/0            0.0.0.0/0           </span></span><br><span class="line">ACCEPT     <span class="keyword">all</span>  <span class="comment">--  0.0.0.0/0            0.0.0.0/0           </span></span><br><span class="line">ACCEPT     tcp  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22</span></span><br><span class="line">REJECT     <span class="keyword">all</span>  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited</span></span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">REJECT     <span class="keyword">all</span>  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited</span></span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="operator">-</span>n与不加<span class="operator">-</span>n区别</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">ACCEPT     <span class="keyword">all</span>  <span class="comment">--  anywhere             anywhere             state RELATED,ESTABLISHED</span></span><br><span class="line">ACCEPT     icmp <span class="comment">--  anywhere             anywhere            </span></span><br><span class="line">ACCEPT     <span class="keyword">all</span>  <span class="comment">--  anywhere             anywhere            </span></span><br><span class="line">ACCEPT     tcp  <span class="comment">--  anywhere             anywhere             state NEW tcp dpt:ssh</span></span><br><span class="line">REJECT     <span class="keyword">all</span>  <span class="comment">--  anywhere             anywhere             reject-with icmp-host</span></span><br></pre></td></tr></table></figure>

<h2 id="2-清空规则"><a href="#2-清空规则" class="headerlink" title="2.清空规则"></a>2.清空规则</h2><p><code>iptables -F</code>：这个命令用于清空所有的iptables规则，但不会处理默认的规则。即清除所有用户自定义的规则，但不会影响默认规则。</p>
<p><code>iptables -X</code>：这个命令用于删除用户自定义的链。当用户自定义了一些链，并且想要清除这些链时，可以使用该命令。</p>
<p><code>iptables -Z</code>：这个命令用于清零链的计数器，包括数据包计数器和数据包字节计数器。通过清零计数器，可以重新开始统计链上的数据包和字节数量，这对于监控和调试iptables规则非常有用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>F</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>X</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>Z</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br></pre></td></tr></table></figure>

<h2 id="3-添加规则"><a href="#3-添加规则" class="headerlink" title="3.添加规则"></a>3.添加规则</h2><blockquote>
<p>添加时要注意，规则是自上而下匹配</p>
</blockquote>
<p>iptables -t: 这个命令用于指定要操作的iptables表，默认是<code>filter</code>表。iptables有多个表用于不同的目的，比如<code>filter</code>表用于过滤功能，<code>nat</code>表用于网络地址转换，<code>mangle</code>表用于数据包修改等。</p>
<p>iptables -A: 这个命令用于将规则添加到指定的链上，默认添加到该链的最后一行。</p>
<p>iptables -I: 这个命令用于插入规则到指定的链中，默认插入到该链的第一行。这个命令通常用于立即生效的规则，比如封锁某个IP地址。</p>
<p>iptables -D: 这个命令用于删除指定链上的规则。可以提供规则的具体参数来删除特定的规则，或者使用行号来删除指定行的规则。</p>
<p><strong>添加一个规则，禁止所有流量访问6379端口</strong></p>
<p>指定–dport参数时必须加上-p参数指定协议否则会报错，注意参数大小写</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#添加规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>t <span class="keyword">filter</span> <span class="operator">-</span>A INPUT <span class="operator">-</span>p tcp <span class="comment">--dport 6379 -j DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"><span class="keyword">DROP</span>       tcp  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            tcp dpt:6379</span></span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#使用netcat一款网络工具创建端口提供连接</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#nc <span class="operator">-</span>l <span class="operator">-</span>p <span class="number">6379</span> <span class="operator">-</span>v</span><br><span class="line">Ncat: Version <span class="number">7.50</span> ( https:<span class="operator">/</span><span class="operator">/</span>nmap.org<span class="operator">/</span>ncat )</span><br><span class="line">Ncat: Listening <span class="keyword">on</span> :::<span class="number">6379</span></span><br><span class="line">Ncat: Listening <span class="keyword">on</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">6379</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ss <span class="operator">-</span>tunlp<span class="operator">|</span>grep <span class="number">6379</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">10</span>        <span class="operator">*</span>:<span class="number">6379</span>                  <span class="operator">*</span>:<span class="operator">*</span>                   users:((&quot;nc&quot;,pid<span class="operator">=</span><span class="number">2349</span>,fd<span class="operator">=</span><span class="number">4</span>))</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">10</span>     [::]:<span class="number">6379</span>               [::]:<span class="operator">*</span>                   users:((&quot;nc&quot;,pid<span class="operator">=</span><span class="number">2349</span>,fd<span class="operator">=</span><span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        </span><br><span class="line">#测试防火墙流量阻挡无法连接<span class="number">6379</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#telnet <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> <span class="number">6379</span></span><br><span class="line">Trying <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>...</span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                       </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#命令解释</span><br><span class="line">    <span class="operator">-</span>t <span class="keyword">filter</span>: 指定要操作的表（<span class="keyword">table</span>），这里是 <span class="keyword">filter</span> 表。<span class="keyword">filter</span> 表包含了用于包过滤的规则。</span><br><span class="line"></span><br><span class="line">    <span class="operator">-</span>A INPUT: 指定规则应该添加到 INPUT 链的末尾。INPUT 链用于处理传入的数据包。</span><br><span class="line"></span><br><span class="line">    <span class="operator">-</span>p tcp: 指定要匹配的协议类型，这里是 TCP 协议。</span><br><span class="line"></span><br><span class="line">    <span class="comment">--dport 6379: 指定要匹配的目标端口号，这里是 6379。这意味着这条规则将匹配所有目标端口号为6379的TCP数据包。</span></span><br><span class="line"></span><br><span class="line">    <span class="operator">-</span>j <span class="keyword">DROP</span>: 表示如果数据包符合前面的规则条件，那么将其丢弃（<span class="keyword">DROP</span>）。这意味着所有目标端口号为<span class="number">6379</span>的TCP数据包将被丢弃，不允许通过防火墙。</span><br></pre></td></tr></table></figure>

<h2 id="4-删除规则"><a href="#4-删除规则" class="headerlink" title="4.删除规则"></a>4.删除规则</h2><blockquote>
<p>iptables -nL –line-numbers 查看规则行号</p>
<p>iptables -t（表名&#x2F;默认不加就是filter表） INPUT（链名）  1（链下规则行号） </p>
</blockquote>
<ul>
<li>注意：删除规则后行号会变化，删除多条时记得再次查看规则行号</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#查看规则与行号</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-numbers</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            tcp dpt:6379</span></span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>D INPUT <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查删除规则后流量正常进入</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#telnet <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> <span class="number">6379</span></span><br><span class="line">Trying <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>...</span><br><span class="line">Connected <span class="keyword">to</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>.</span><br><span class="line"><span class="keyword">Escape</span> <span class="type">character</span> <span class="keyword">is</span> <span class="string">&#x27;^]&#x27;</span>.  </span><br></pre></td></tr></table></figure>

<h2 id="5-查看规则状态"><a href="#5-查看规则状态" class="headerlink" title="5.查看规则状态"></a>5.查看规则状态</h2><blockquote>
<p><code>iptables -nL</code>命令可以查看每条规则的状态</p>
<p>这些状态信息对于了解当前防火墙规则的生效情况和连接状态非常有用</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">NEW</span>：（已经或将启动新的连接）</span><br><span class="line"></span><br><span class="line">ESTABLISHED：（已建立的连接）</span><br><span class="line"></span><br><span class="line">RELATED：（正在启动的新连接）</span><br><span class="line"></span><br><span class="line">INVALID：（非法或无法识别的）</span><br></pre></td></tr></table></figure>

<h2 id="6-禁止动作的区别"><a href="#6-禁止动作的区别" class="headerlink" title="6.禁止动作的区别"></a>6.禁止动作的区别</h2><blockquote>
<p>DROP   丢弃（对方直接无响应）     你对某个女孩说：我喜欢你，鸟都没鸟你</p>
<p>REJECT 拒绝（对方给了回应不答应）  你对某个女孩说：我喜欢你，女孩回复你是个好人但是我们不合适</p>
</blockquote>
<p><strong>测试DROP规则动作</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#丢弃规则，所有ping流量从<span class="number">10</span>网段进入全部丢弃</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p icmp <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> <span class="operator">-</span>j <span class="keyword">DROP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    <span class="keyword">DROP</span>       icmp <span class="comment">--  0.0.0.0/0            10.0.0.51           </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ping10网段，测试结果卡死不动</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ping <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">PING <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> (<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>) <span class="number">56</span>(<span class="number">84</span>) bytes <span class="keyword">of</span> data.</span><br></pre></td></tr></table></figure>

<p><strong>测试REJCKT动作</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>D INPUT <span class="number">1</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p icmp <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> <span class="operator">-</span>j <span class="keyword">DROP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#会有一个错误响应</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ping <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">PING <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> (<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>) <span class="number">56</span>(<span class="number">84</span>) bytes <span class="keyword">of</span> data.</span><br><span class="line"><span class="keyword">From</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> icmp_seq<span class="operator">=</span><span class="number">1</span> Destination Port Unreachable</span><br><span class="line"><span class="keyword">From</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> icmp_seq<span class="operator">=</span><span class="number">2</span> Destination Port Unreachable</span><br><span class="line"><span class="keyword">From</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> icmp_seq<span class="operator">=</span><span class="number">3</span> Destination Port Unreachable</span><br><span class="line"><span class="keyword">From</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> icmp_seq<span class="operator">=</span><span class="number">4</span> Destination Port Unreachable</span><br></pre></td></tr></table></figure>



<h1 id="规则限制filter表实战"><a href="#规则限制filter表实战" class="headerlink" title="规则限制filter表实战"></a>规则限制filter表实战</h1><blockquote>
<p>关于防火墙规则，我们的3个链，防火墙规则有2个方案：</p>
<ul>
<li>默认规则是ACCEPT，然后添加部分限制的规则语句</li>
<li>默认规则拒绝，然后添加允许通过的策略</li>
</ul>
</blockquote>
<h2 id="1-禁止22端口流量进入（危险操作）"><a href="#1-禁止22端口流量进入（危险操作）" class="headerlink" title="1.禁止22端口流量进入（危险操作）"></a>1.禁止22端口流量进入（危险操作）</h2><p><strong>拒绝某个机器请求的ssh连接</strong></p>
<blockquote>
<p>当前环境db51与db52机器用来测试（两个机器都是双网卡10网段与172网段）</p>
<p>需求：拒绝db52机器ssh连接db51机器</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#db51机器规则添加，禁止<span class="number">51</span>机器ssh连接数据包进入，规则限制两个网段的数据包</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span> <span class="operator">-</span>p tcp <span class="comment">--dport 22 -j DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span> <span class="operator">-</span>p tcp <span class="comment">--dport 22 -j DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">--  172.16.1.52          0.0.0.0/0            tcp dpt:22</span></span><br><span class="line"><span class="number">2</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">--  10.0.0.52            0.0.0.0/0            tcp dpt:22</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试<span class="number">52</span>机器是否可以远程连接<span class="number">51</span>目标机器</span><br><span class="line">#无法连接，直接卡死</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br></pre></td></tr></table></figure>

<p><strong>拒绝某个网段请求的ssh连接</strong></p>
<blockquote>
<p>需求：拒绝172网段的机器ssh连接51机器</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#添加规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>p tcp <span class="comment">--dport 22 -j DROP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看规则，规则是自上而下进行匹配，当匹配到处理后，就不会向下规则匹配</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">--  172.16.1.0/24        0.0.0.0/0            tcp dpt:22</span></span><br><span class="line"><span class="number">2</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">--  172.16.1.52          0.0.0.0/0            tcp dpt:22</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第<span class="number">1</span>个规则与第<span class="number">2</span>个规则条件冲突，删除无用规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">--  172.16.1.0/24        0.0.0.0/0            tcp dpt:22</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试<span class="number">172</span>网段连接<span class="number">51</span>机器，防火墙生效直接卡死了</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试<span class="number">10</span>网段连接，<span class="number">10</span>网段没有设置规则，所以是可以连接的</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line"><span class="keyword">Last</span> login: Wed Jul <span class="number">10</span> <span class="number">16</span>:<span class="number">49</span>:<span class="number">44</span> <span class="number">2024</span> <span class="keyword">from</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure>

<p><strong>拒绝所有网段请求的22端口的ssh连接</strong></p>
<ul>
<li>应用场景：N个傻叉黑客，疯狂干你的22端口，总是有无用的流量访问你的服务器<ul>
<li>解决方案：对所有网段22端口的ssh请求进行封禁</li>
</ul>
</li>
<li>前提条件：<ul>
<li>1.sshd服务端口不是22，可直接对22端口封禁</li>
<li>2.sshd服务端口是22的话，最好修改端口，不修改的话必须有可以连接的地址放行规则，否则封禁全部流量，无设备可以远程连接服务器了</li>
</ul>
</li>
</ul>
<blockquote>
<p>需求：拒绝所有网段的22端口请求ssh连接db51机器，只允许当前环境下windows的10.0.0.1地址可通过22端口远程连接db51</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#先添加只允许win10<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>连接的规则（如果先设置禁止规则，当前会话会立刻断开）</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span> <span class="operator">-</span>p tcp <span class="comment">--dport 22 -j ACCEPT</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    ACCEPT     tcp  <span class="comment">--  10.0.0.1             0.0.0.0/0            tcp dpt:22</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#添加禁止所有网段ssh连接<span class="number">22</span>端口的请求（规则添加从后插入）</span><br><span class="line">#简写：iptables <span class="operator">-</span>A INPUT  <span class="operator">-</span>p tcp <span class="comment">--dport 22 -j DROP 【省略的参数代表全部】</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>s <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="operator">/</span><span class="number">0</span> <span class="operator">-</span>p tcp <span class="comment">--dport 22 -j DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    ACCEPT     tcp  <span class="comment">--  10.0.0.1             0.0.0.0/0            tcp dpt:22</span></span><br><span class="line"><span class="number">2</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">--  0.0.0.0/24           0.0.0.0/0            tcp dpt:22</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试其他网段连接db51机器，全部卡死，防火墙阻挡了</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试<span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>win进行连接db51，win放行了所以可以连接</span><br><span class="line">[C:\<span class="operator">~</span>]$ ssh <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">Connecting <span class="keyword">to</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">22.</span>..</span><br><span class="line">Connection established.</span><br><span class="line"><span class="keyword">To</span> <span class="keyword">escape</span> <span class="keyword">to</span> <span class="keyword">local</span> shell, press Ctrl<span class="operator">+</span>Alt<span class="operator">+</span>].</span><br><span class="line"></span><br><span class="line">WARNING<span class="operator">!</span> The remote SSH server rejected X11 forwarding request.</span><br><span class="line"><span class="keyword">Last</span> login: Wed Jul <span class="number">10</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">51</span> <span class="number">2024</span> <span class="keyword">from</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure>

<h2 id="2-禁止某ip流量进入某网卡"><a href="#2-禁止某ip流量进入某网卡" class="headerlink" title="2.禁止某ip流量进入某网卡"></a>2.禁止某ip流量进入某网卡</h2><blockquote>
<p>需求：禁止52机器tcp数据包请求访问51机器（eth0网卡）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#db51添加规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p  tcp  <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span> <span class="operator">-</span>i eth0 <span class="operator">-</span>j <span class="keyword">DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num </span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">--  10.0.0.52            0.0.0.0/0   </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试<span class="number">52</span>机器无法对<span class="number">51</span>机器的eth0网卡发送tcp的数据包</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh  <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">直接卡死</span><br></pre></td></tr></table></figure>

<h2 id="3-源地址取反规则定义玩法"><a href="#3-源地址取反规则定义玩法" class="headerlink" title="3.源地址取反规则定义玩法"></a>3.源地址取反规则定义玩法</h2><blockquote>
<p>禁止除了10.0.0.52以外，其他ip都无法访问本机的ens33</p>
</blockquote>
<ul>
<li>危险操作，注意</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">############db51添加规则</span><br><span class="line">#添加规则后，终端模拟器直接断开与服务器的连接，因为当前环境本地win只能通过<span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>使用远程工具连接的<span class="number">51</span>服务器，<span class="number">51</span>机器的eth0网卡是<span class="number">10</span>网段的地址，防火墙规则禁用了其他所有地址的对<span class="number">10</span>网段的所有请求，所以自动断开连接了</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT  <span class="operator">!</span> <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span>  <span class="operator">-</span>i eth0  <span class="operator">-</span>j <span class="keyword">DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#</span><br><span class="line">Socket error Event: <span class="number">32</span> Error: <span class="number">10053.</span></span><br><span class="line">Connection closing...Socket close.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">########测试向<span class="number">51</span>机器eth0网卡发送请求</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">被阻挡了</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#########测试向<span class="number">51</span>机器eth1网卡发送请求</span><br><span class="line">#当前环境db51是双网卡，规则又只是限制了eth0网卡的流量进入，使用<span class="number">172</span>网段的机器依然可以连接</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"><span class="keyword">Last</span> login: Wed Jul <span class="number">10</span> <span class="number">19</span>:<span class="number">10</span>:<span class="number">03</span> <span class="number">2024</span> <span class="keyword">from</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"><span class="keyword">DROP</span>       <span class="keyword">all</span>  <span class="comment">-- !10.0.0.53            0.0.0.0/0    </span></span><br></pre></td></tr></table></figure>

<h2 id="4-只允许某网段流量进入"><a href="#4-只允许某网段流量进入" class="headerlink" title="4.只允许某网段流量进入"></a>4.只允许某网段流量进入</h2><blockquote>
<p>只允许10.0.0.0网段的tcp协议数据包进入本机</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#添加规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p tcp <span class="operator">!</span> <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j <span class="keyword">DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">-- !10.0.0.0/24          0.0.0.0/0           </span></span><br><span class="line"><span class="number">2</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">--  10.0.0.52            0.0.0.0/0           </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除冲突的无用规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>D INPUT <span class="number">2</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">-- !10.0.0.0/24          0.0.0.0/0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试规则，除了<span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span><span class="number">-254</span>网段的流量，其他所有地址流量无法进入db51机器</span><br><span class="line">其他网段流量无法进入</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ssh <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line">只有<span class="number">10</span>网段流量可以放行</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ssh <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="string">&#x27;10.0.0.52 (10.0.0.52)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:mkalkbcDcxlWD5OIdMMxGt4PeBVR38i6MyTxs70RWfM.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is MD5:e1:d1:90:1f:3a:8f:da:27:00:82:5e:d9:10:f5:4a:5a.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? </span></span><br></pre></td></tr></table></figure>

<h2 id="5-实现堡垒机的唯一入口"><a href="#5-实现堡垒机的唯一入口" class="headerlink" title="5.实现堡垒机的唯一入口"></a>5.实现堡垒机的唯一入口</h2><blockquote>
<p>需求：所有地址的远程连接数据包不允许进入本机，只有52机器可以进入。堡垒机的本质，就是只能先登录堡垒机再去管理其他机器。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#设置规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p  tcp <span class="operator">!</span> <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span> <span class="comment">--dport 22 -j DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#刚设置就卡死了自动断开，因为当前是本地win使用<span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>连接的<span class="number">51</span>机器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试其他地址进行远程连接db51</span><br><span class="line">#<span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>地址无法连接</span><br><span class="line">[C:\<span class="operator">~</span>]$ ssh root<span class="variable">@10</span><span class="number">.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">Connecting <span class="keyword">to</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">22.</span>..</span><br><span class="line">Canceled.</span><br><span class="line">Type `help <span class="keyword">to</span> learn how <span class="keyword">to</span> use Xshell prompt</span><br><span class="line">#<span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span>地址也无法连接</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#当前只能通过<span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>地址通过<span class="number">10</span>网段的局域网远程连接<span class="number">51</span>机器</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line"><span class="keyword">Last</span> login: Wed Jul <span class="number">10</span> <span class="number">20</span>:<span class="number">00</span>:<span class="number">35</span> <span class="number">2024</span> <span class="keyword">from</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"><span class="keyword">DROP</span>       tcp  <span class="comment">-- !10.0.0.52            0.0.0.0/0            tcp dpt:22</span></span><br></pre></td></tr></table></figure>

<h2 id="6-目标多个端口范围定义玩法"><a href="#6-目标多个端口范围定义玩法" class="headerlink" title="6.目标多个端口范围定义玩法"></a>6.目标多个端口范围定义玩法</h2><blockquote>
<p>需求： 禁止多个目标端口被访问，只允许172.16.1.0&#x2F;24网段访问本机的22 ，6379，80端口</p>
<p>多个端口的限制使用逗号定义即可</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#添加规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p tcp <span class="operator">!</span> <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>m multiport <span class="comment">--dport 22,6379,80 -j DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#自动断开卡死了，因为当前环境是基于win10<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>进行连接</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试流量拒绝源地址不是<span class="number">172</span>网段且目的端口为<span class="number">22</span>的数据包</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">卡死了拒绝了流量</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">172</span>网段<span class="number">22</span>端口未被拒绝流量</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-52</span> <span class="operator">~</span>]#ssh <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"><span class="keyword">Last</span> login: Wed Jul <span class="number">10</span> <span class="number">20</span>:<span class="number">57</span>:<span class="number">06</span> <span class="number">2024</span> <span class="keyword">from</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>需求：禁止多个端口被所有地址访问，只允许172.16.1.0&#x2F;24网段访问本机的6000端口-7000端口</p>
<p>6000-7000一千个端口手动写是不可能的，使用冒号语法可定义端口范围</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#添加规则，直接插入规则即可，与上一规则并不冲突</span><br><span class="line">root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p tcp ！ <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="comment">--dport 6000:7000 -j DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">-- !172.16.1.0/24        0.0.0.0/0            tcp dpts:6000:7000</span></span><br><span class="line"><span class="number">2</span>    <span class="keyword">DROP</span>       tcp  <span class="comment">-- !172.16.1.0/24        0.0.0.0/0            multiport dports 22,6379,80</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试规则限制，省略了................</span><br></pre></td></tr></table></figure>

<h2 id="7-禁止服务器被ping的两种玩法"><a href="#7-禁止服务器被ping的两种玩法" class="headerlink" title="7.禁止服务器被ping的两种玩法"></a>7.禁止服务器被ping的两种玩法</h2><ul>
<li>但若是抵挡恶意流量，选择DROP，可以延缓黑客的攻击进度</li>
</ul>
<blockquote>
<p>需求：服务器拒绝接收icmp的ping数据包，给与错误响应</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#规则三种写法</span><br><span class="line">#<span class="comment">--incmp-type表示只对ping这个类型的icmp数据包进行判断处理，其他icmp数据包不是ping功能的不进行处理</span></span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p icmp <span class="comment">--icmp-type 8 -s 0.0.0.0/0 -j  REJECT</span></span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p icmp <span class="comment">--icmp-type 8 -s 0/0 -j REJECT</span></span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p icmp <span class="comment">--icmp-type 8 -j REJECT</span></span><br><span class="line"></span><br><span class="line">#执行添加规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p icmp <span class="comment">--icmp-type 8 -j REJECT</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">REJECT     icmp <span class="comment">--  0.0.0.0/0            0.0.0.0/0            icmptype 8 reject-with icmp-port-unreachable</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ping结果给错误回复</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ping <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">PING <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> (<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>) <span class="number">56</span>(<span class="number">84</span>) bytes <span class="keyword">of</span> data.</span><br><span class="line"><span class="keyword">From</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> icmp_seq<span class="operator">=</span><span class="number">1</span> Destination Port Unreachable</span><br><span class="line"><span class="keyword">From</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> icmp_seq<span class="operator">=</span><span class="number">2</span> Destination Port Unreachable</span><br><span class="line"><span class="keyword">From</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> icmp_seq<span class="operator">=</span><span class="number">3</span> Destination Port Unreachable</span><br><span class="line"><span class="keyword">From</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> icmp_seq<span class="operator">=</span><span class="number">4</span> Destination Port Unreachable</span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line"><span class="comment">--- 10.0.0.51 ping statistics ---</span></span><br><span class="line"><span class="number">4</span> packets transmitted, <span class="number">0</span> received, <span class="operator">+</span><span class="number">4</span> errors, <span class="number">100</span><span class="operator">%</span> packet loss, <span class="type">time</span> <span class="number">3000</span>ms</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需求：服务器直接丢弃icmp的ping流量的数据包，不给回应</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#执行添加规则</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p icmp <span class="comment">--icmp-type 8 -j DROP</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>nL</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"><span class="keyword">DROP</span>       icmp <span class="comment">--  0.0.0.0/0            0.0.0.0/0            icmptype 8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ping结果，无任何恢复直接卡死</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ping <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">PING <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> (<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>) <span class="number">56</span>(<span class="number">84</span>) bytes <span class="keyword">of</span> data.</span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line"><span class="comment">--- 10.0.0.51 ping statistics ---</span></span><br><span class="line"><span class="number">4</span> packets transmitted, <span class="number">0</span> received, <span class="number">100</span><span class="operator">%</span> packet loss, <span class="type">time</span> <span class="number">3000</span>ms</span><br></pre></td></tr></table></figure>

<h2 id="8-封禁恶意访问网站80口的IP"><a href="#8-封禁恶意访问网站80口的IP" class="headerlink" title="8.封禁恶意访问网站80口的IP"></a>8.封禁恶意访问网站80口的IP</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>对nginx日志进行健康检查</span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>nginx<span class="operator">/</span>access.log <span class="operator">|</span> sort <span class="operator">|</span> uniq <span class="operator">-</span>c <span class="operator">|</span> sort <span class="operator">-</span>nr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>对数据包进行规则限制</span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>s 恶意ip地址 <span class="operator">-</span>p tcp <span class="comment">--drpot 80 -j DROP</span></span><br></pre></td></tr></table></figure>

<h2 id="9-web服务器流量类略"><a href="#9-web服务器流量类略" class="headerlink" title="9.web服务器流量类略"></a>9.web服务器流量类略</h2><p>关于防火墙规则，我们的3个链，防火墙规则有2个方案：</p>
<ul>
<li>默认规则是ACCEPT，然后添加部分限制的规则语句</li>
<li>默认规则拒绝，然后添加允许通过的策略</li>
</ul>
<blockquote>
<p>针对web服务器工作环境，进行策略配置，只允许接收web请求处理的数据包与远程连接的数据包，其余的全部封禁</p>
</blockquote>
<p>下方对于规则定义，使用的是先设置允许的规则，再将链的默认策略改为拒绝</p>
<p>规则匹配是自上而下进行，如果没有匹配到的数据包，就会根据链的默认策略进行处理</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#清空规则</span><br><span class="line">iptables <span class="operator">-</span>F</span><br><span class="line">iptables <span class="operator">-</span>X</span><br><span class="line">iptables <span class="operator">-</span>Z</span><br><span class="line"></span><br><span class="line">#放行目标端口<span class="number">80</span>与<span class="number">443</span>tcp数据包</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p tcp <span class="operator">-</span>m multiport <span class="comment">--dport 80,443 -j ACCEPT</span></span><br><span class="line">#放行目标<span class="number">22</span>端口tcp数据包</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p tcp <span class="comment">--dport 22 -j ACCEPT</span></span><br><span class="line">#放行源地址<span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>网段数据包</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j ACCEPT</span><br><span class="line">#放行源地址<span class="number">172</span>网段数据包</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j ACCEPT</span><br><span class="line">#放行从本地回环地址<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>网卡进入的数据包</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>i lo <span class="operator">-</span>j ACCEPT</span><br><span class="line">#input链默认策略允许改为拒绝</span><br><span class="line">iptables <span class="operator">-</span>P INPUT <span class="keyword">DROP</span></span><br><span class="line">#porward链默认策略改为拒绝</span><br><span class="line">iptables <span class="operator">-</span>P FORWARD <span class="keyword">DROP</span></span><br><span class="line">#output链允许所有数据包进入</span><br><span class="line">iptables <span class="operator">-</span>P OUTPUT ACCEPT</span><br><span class="line">iptables <span class="operator">-</span>nL</span><br></pre></td></tr></table></figure>

<p><img src="/image-20240712121520704.png" alt="image-20240712121520704"></p>
<h2 id="10-规则定义练习"><a href="#10-规则定义练习" class="headerlink" title="10.规则定义练习"></a>10.规则定义练习</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#封禁<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>访问本机</span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> <span class="operator">-</span>j <span class="keyword">DROP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#限制只有<span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>可以ssh登录堡垒机</span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p tcp ！ <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment">--dport 22 -j DROP </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#封禁任何人访问本机<span class="number">6379</span></span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p tcp  <span class="comment">--dport 6379  -j DROP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#只允许走<span class="number">172</span>内网，访问<span class="number">51</span>机器的<span class="number">6379</span>(下方就是利用了规则顺序对数据包进行限制)</span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p tcp  <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span>  <span class="comment">--dport 6379 -jDROP</span></span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p tcp  <span class="comment">--dport 6379  -j DROP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#只允许走<span class="number">172</span>内网，访问<span class="number">51</span>机器的<span class="number">6379</span> ，简写（这个简单）</span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>p tcp  <span class="operator">!</span> <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span>  <span class="comment">--dport 6379 -j DROP</span></span><br></pre></td></tr></table></figure>

<h1 id="规则限制nat表实战"><a href="#规则限制nat表实战" class="headerlink" title="规则限制nat表实战"></a>规则限制nat表实战</h1><blockquote>
<p>关于防火墙规则，我们的3个链，防火墙规则有2个方案：</p>
<ul>
<li>默认规则是ACCEPT，然后添加部分限制的规则语句</li>
<li>默认规则拒绝，然后添加允许通过的策略</li>
</ul>
</blockquote>
<h2 id="1-局域网共享上网"><a href="#1-局域网共享上网" class="headerlink" title="1.局域网共享上网"></a>1.局域网共享上网</h2><p><strong>出口节点：</strong>通常指网络中具有出口功能的节点，负责将数据从内部网络转发到外部网络，以及将外部网络返回的数据包转发回内部网络。</p>
<h3 id="网关出口节点"><a href="#网关出口节点" class="headerlink" title="网关出口节点"></a>网关出口节点</h3><blockquote>
<p><strong>实现效果：</strong></p>
<p>m61机器作为所有局域网主机的网关出口节点，将局域网内主机db52的数据包转发到公网上</p>
<p>实现局域网主机通过防火墙的nat表snat功能与外网通信</p>
</blockquote>
<p><strong>NAT表规则</strong></p>
<ul>
<li>当前实现了该节点会对局域网主机发送的数据包的源地址修改，进行SNAT地址转换修改发送给公网</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#对NAT表的后路由链设置规则，匹配源地址是<span class="number">172</span>网段的数据包，进行源地址转换为本地可与公网通信的<span class="number">10</span>网卡地址</span><br><span class="line">[root<span class="variable">@m</span><span class="number">-61</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>t nat <span class="operator">-</span>A POSTROUTING <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j SNAT <span class="comment">--to-source 10.0.0.61</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#内核修改命令，开启数据包转发功能</span><br><span class="line">[root<span class="variable">@m</span><span class="number">-61</span> <span class="operator">~</span>]#echo <span class="string">&#x27;net.ipv4.ip_forward = 1&#x27;</span> <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>sysctl.conf</span><br><span class="line">#加载内核参数配置文件，生效内核功能，无需重启系统</span><br><span class="line">sysctl <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看NAT表规则</span><br><span class="line">[root<span class="variable">@m</span><span class="number">-61</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>t nat <span class="operator">-</span>nL <span class="comment">--line-num</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line"><span class="number">1</span>    SNAT       <span class="keyword">all</span>  <span class="comment">--  172.16.1.0/24        0.0.0.0/0            to:10.0.0.61</span></span><br></pre></td></tr></table></figure>

<p><strong>filter表规则</strong></p>
<blockquote>
<p>下方主要是针对机器的数据进入到本地的规则限制以及数据包进行转发的规则限制</p>
<p>什么流量能进入到本地，什么流量能进行转发功能</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#清空规则</span><br><span class="line">iptables <span class="operator">-</span>F</span><br><span class="line">iptables <span class="operator">-</span>X</span><br><span class="line">iptables <span class="operator">-</span>Z</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#对<span class="keyword">filter</span>表的input链进行规则设置，允许tcp协议目标端口是<span class="number">80</span>，<span class="number">443</span>的数据包进入本地</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p tcp <span class="operator">-</span>m multiport <span class="comment">--dport 80,443 -j ACCEPT</span></span><br><span class="line">#允许目标<span class="number">22</span>端口的数据包进入本地</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>p tcp <span class="comment">--dport 22 -j ACCEPT</span></span><br><span class="line">#允许源地址是<span class="number">10</span>网段的数据包进入本地（<span class="number">10</span>网段可与公网实现通信）</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>s <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j ACCEPT</span><br><span class="line">#允许源地址是<span class="number">172</span>网段数据包进入（<span class="number">172</span>网段就是局域网下的所有主机分配的ip地址）</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j ACCEPT</span><br><span class="line">#允许源地址是本地回环地址的数据包进入</span><br><span class="line">iptables <span class="operator">-</span>A INPUT <span class="operator">-</span>i lo <span class="operator">-</span>j ACCEPT</span><br><span class="line">#input链数据包进入关卡默认策略修改为拒绝，只有上方允许的规则流量可进入本地机器</span><br><span class="line">iptables <span class="operator">-</span>P INPUT <span class="keyword">DROP</span></span><br><span class="line">#数据包发出的关卡默认策略为允许所有流量出去</span><br><span class="line">iptables <span class="operator">-</span>P OUTPUT ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这里解释一下下方的规则作用</span><br><span class="line"><span class="number">1.</span>只允许<span class="number">172</span>网段局域网主机进入该网关出口节点实现数据包转发功能</span><br><span class="line"><span class="number">2.</span>只允许接收到的数据包目标地址是<span class="number">172</span>网段的才可以进行数据包转发</span><br><span class="line">#允许数据包源地址是<span class="number">172</span>网段从ens37<span class="operator">/</span>eth1（内网网卡）进入forward链</span><br><span class="line">iptables <span class="operator">-</span>A FORWARD <span class="operator">-</span>i ens37 <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j ACCEPT</span><br><span class="line">#允许数据包源地址是<span class="number">172</span>网段从ens33（公网网卡）进入到forward链</span><br><span class="line">iptables <span class="operator">-</span>A FORWARD <span class="operator">-</span>o ens33 <span class="operator">-</span>s <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j ACCEPT</span><br><span class="line">#允许数据包目标地址是<span class="number">172</span>网段从ens33（公网网卡）进入到forward链</span><br><span class="line">iptables <span class="operator">-</span>A FORWARD <span class="operator">-</span>i ens33 <span class="operator">-</span>d <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j ACCEPT</span><br><span class="line">#允许数据包目标地址是<span class="number">172</span>网段从ens37（内网网卡）进入到forward链</span><br><span class="line">iptables <span class="operator">-</span>A FORWARD <span class="operator">-</span>o ens37 <span class="operator">-</span>d <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> <span class="operator">-</span>j ACCEPT</span><br><span class="line">#forward链数据包转发关卡默认策略修改为拒绝，只运行上方匹配到的规则进入本地进行数据包转发，其他流量全部拒绝</span><br><span class="line">iptables <span class="operator">-</span>P FORWARD <span class="keyword">DROP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="operator">-</span>i 输入接口，数据包进入</span><br><span class="line">#<span class="operator">-</span>o 输出接口，数据包发出</span><br></pre></td></tr></table></figure>

<h3 id="局域网主机节点"><a href="#局域网主机节点" class="headerlink" title="局域网主机节点"></a>局域网主机节点</h3><blockquote>
<p>当前环境：</p>
<p>1.局域网内节点关闭原本的10网段网卡（当前环境是双网卡，10网段是配置通过本地win进行与公网通信）</p>
<p>2.修改网关地址指定61机器（修改网卡地址，通过内网局域网段，指向61机器）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>etc<span class="operator">/</span>sysconfig<span class="operator">/</span>network<span class="operator">-</span>scripts]#cat ifcfg<span class="operator">-</span>eth1</span><br><span class="line">TYPE<span class="operator">=</span>Ethernet</span><br><span class="line">BOOTPROTO<span class="operator">=</span><span class="keyword">none</span></span><br><span class="line">NAME<span class="operator">=</span>eth1</span><br><span class="line">DEVICE<span class="operator">=</span>eth1</span><br><span class="line">ONBOOT<span class="operator">=</span>yes</span><br><span class="line">IPADDR<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">PREFIX<span class="operator">=</span><span class="number">24</span></span><br><span class="line">GATEWAY<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>etc<span class="operator">/</span>sysconfig<span class="operator">/</span>network<span class="operator">-</span>scripts]#systemctl restart network</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#关闭<span class="number">10</span>网段网卡</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cd <span class="operator">/</span>etc<span class="operator">/</span>sysconfig<span class="operator">/</span>network<span class="operator">-</span>scripts<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>etc<span class="operator">/</span>sysconfig<span class="operator">/</span>network<span class="operator">-</span>scripts]#vim ifcfg<span class="operator">-</span>eth0</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">/</span>etc<span class="operator">/</span>sysconfig<span class="operator">/</span>network<span class="operator">-</span>scripts]#cat ifcfg<span class="operator">-</span>eth0</span><br><span class="line">TYPE<span class="operator">=</span>Ethernet</span><br><span class="line">BOOTPROTO<span class="operator">=</span><span class="keyword">none</span></span><br><span class="line">NAME<span class="operator">=</span>eth0</span><br><span class="line">DEVICE<span class="operator">=</span>eth0</span><br><span class="line">ONBOOT<span class="operator">=</span><span class="keyword">no</span>        #改这关闭网卡</span><br><span class="line">IPADDR<span class="operator">=</span><span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">PREFIX<span class="operator">=</span><span class="number">24</span></span><br><span class="line">GATEWAY<span class="operator">=</span><span class="number">10.0</span><span class="number">.0</span><span class="number">.254</span> </span><br><span class="line">DNS1<span class="operator">=</span><span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span></span><br><span class="line">#重启查看网卡</span><br><span class="line">systemctl restart network</span><br><span class="line">ifconfig   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前路由并测试是否可与外网通信</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#route <span class="operator">-</span>n</span><br><span class="line">Kernel IP routing <span class="keyword">table</span></span><br><span class="line">Destination     Gateway         Genmask         Flags Metric <span class="keyword">Ref</span>    Use Iface</span><br><span class="line"><span class="number">169.254</span><span class="number">.0</span><span class="number">.0</span>     <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span>     U     <span class="number">1003</span>   <span class="number">0</span>        <span class="number">0</span> eth1</span><br><span class="line"><span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eth1</span><br><span class="line">#无法通信因为连不到外网了</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ping www.baidu.com</span><br><span class="line">ping: www.baidu.com: Name <span class="keyword">or</span> service <span class="keyword">not</span> known</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#给内网卡配置文件添加网关出口节点m61的内网地址</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#cat <span class="operator">/</span>etc<span class="operator">/</span>sysconfig<span class="operator">/</span>network<span class="operator">-</span>scripts<span class="operator">/</span>ifcfg<span class="operator">-</span>eth1</span><br><span class="line">TYPE<span class="operator">=</span>Ethernet</span><br><span class="line">BOOTPROTO<span class="operator">=</span><span class="keyword">none</span></span><br><span class="line">NAME<span class="operator">=</span>eth1</span><br><span class="line">DEVICE<span class="operator">=</span>eth1</span><br><span class="line">ONBOOT<span class="operator">=</span>yes</span><br><span class="line">IPADDR<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line">PREFIX<span class="operator">=</span><span class="number">24</span></span><br><span class="line">GATEWAY<span class="operator">=</span><span class="number">172.16</span><span class="number">.1</span><span class="number">.61</span>   （添加这一行地址写入网关出口节点地址）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#再次重启网卡，检查是否可以基于防火墙设置的SNAT功能访问外网</span><br><span class="line">#可以访问外网</span><br><span class="line">[root<span class="variable">@db</span><span class="number">-51</span> <span class="operator">~</span>]#ping baidu.com</span><br><span class="line">PING baidu.com (<span class="number">39.156</span><span class="number">.66</span><span class="number">.10</span>) <span class="number">56</span>(<span class="number">84</span>) bytes <span class="keyword">of</span> data.</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">39.156</span><span class="number">.66</span><span class="number">.10</span> (<span class="number">39.156</span><span class="number">.66</span><span class="number">.10</span>): icmp_seq<span class="operator">=</span><span class="number">1</span> ttl<span class="operator">=</span><span class="number">127</span> <span class="type">time</span><span class="operator">=</span><span class="number">22.9</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">39.156</span><span class="number">.66</span><span class="number">.10</span> (<span class="number">39.156</span><span class="number">.66</span><span class="number">.10</span>): icmp_seq<span class="operator">=</span><span class="number">2</span> ttl<span class="operator">=</span><span class="number">127</span> <span class="type">time</span><span class="operator">=</span><span class="number">22.6</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">39.156</span><span class="number">.66</span><span class="number">.10</span> (<span class="number">39.156</span><span class="number">.66</span><span class="number">.10</span>): icmp_seq<span class="operator">=</span><span class="number">3</span> ttl<span class="operator">=</span><span class="number">127</span> <span class="type">time</span><span class="operator">=</span><span class="number">23.0</span> ms</span><br></pre></td></tr></table></figure>

<blockquote>
<p>核心原理就是</p>
<p>网关出口节点通过防火墙设置的nat表的规则，可以实现snat功能，地址转换与外网的通信</p>
<p>局域网节点网关地址改为出口节点地址</p>
</blockquote>
<p><img src="/image-20240713130449599.png" alt="image-20240713130449599"></p>
<h2 id="2-本地端口映射"><a href="#2-本地端口映射" class="headerlink" title="2.本地端口映射"></a>2.本地端口映射</h2><p>通过 NAT 表的 PREROUTING 链进行目标端口的修改，然后通过目标 IP 地址确定目的主机，并通过 INPUT 链规则控制流量，实际上描述了一个端口映射（Port Forwarding）的过程。</p>
<p>在这个过程中，流量首先经过 NAT 表的 PREROUTING  链，根据预先定义的规则对数据包目标端口进行修改，然后根据目标 IP 地址判断发送到哪个目的地主机。接着，数据包会经过 INPUT  链，根据预先定义的规则对流量进行控制，比如允许或拒绝特定端口或协议的流量。</p>
<p>一旦流量进入目的主机后，目的主机会寻找修改后的端口与目的主机对应的服务端口。例如，如果目的主机是一个 Web 服务器，那么修改后的端口可能是 80（HTTP）或 443（HTTPS）端口。目标主机会根据修改后的端口建立与客户端的通信，并提供相应的服务。</p>
<p>整个过程涉及了端口映射、流量控制和服务端口的通信过程，是网络中常见的一种配置方式，用于将外部访问内部网络上的服务，例如将外部请求转发到内网的 Web 服务器或邮件服务器等。通过合理配置 NAT 表和防火墙规则，可以实现网络流量的安全控制和服务的映射。</p>
<blockquote>
<p>核心：通过nat表的prerouting链将数据包目标端口进行修改，通过目标ip地址判断发送目的地主机，再通过input链规则控制流量，流量进入后寻找修改后的端口与主机对应的服务端口，最后建立通信</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#禁用<span class="number">22</span>端口直连流量</span><br><span class="line">iptables <span class="operator">-</span>t nat <span class="operator">-</span>A PREROUTING <span class="operator">-</span>d <span class="number">10.0</span><span class="number">.0</span><span class="number">.61</span> <span class="operator">-</span>p tcp <span class="comment">--dport 20022 -j DNAT --to-destination 172.16.1.61:22</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@m</span><span class="number">-61</span> <span class="operator">~</span>]#</span><br><span class="line">[root<span class="variable">@m</span><span class="number">-61</span> <span class="operator">~</span>]#iptables <span class="operator">-</span>t nat <span class="operator">-</span>nL</span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">DNAT       tcp  <span class="comment">--  0.0.0.0/0            10.0.1.61            tcp dpt:20022 to:172.16.1.7:22</span></span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br></pre></td></tr></table></figure>

<p><img src="/image-20240713143406954.png" alt="image-20240713143406954"></p>
<h1 id="保存规则记录玩法"><a href="#保存规则记录玩法" class="headerlink" title="保存规则记录玩法"></a>保存规则记录玩法</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables<span class="operator">-</span>save <span class="operator">&gt;</span> <span class="operator">/</span>opt<span class="operator">/</span>iptables.txt # 保存到指定文件</span><br><span class="line">iptables<span class="operator">-</span>save # 保存到配置文件，防止重启后丢失</span><br><span class="line">iptables<span class="operator">-</span>resotre <span class="operator">&lt;</span>  <span class="operator">/</span>opt<span class="operator">/</span>iptables.txt  # 恢复规则</span><br></pre></td></tr></table></figure>

<h1 id="防火墙规则添加注意点"><a href="#防火墙规则添加注意点" class="headerlink" title="防火墙规则添加注意点"></a>防火墙规则添加注意点</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.修改之前先导出备份一份</span><br><span class="line">2.修改的时候小心别把自己关在外面</span><br><span class="line">3.可以现在定时任务里添加一条定时清空的规则，等测试没问题再取消定时任务</span><br><span class="line">4.如果加错了规则，导致拒绝了所有请求，以及没有给与正确放行的规则，且iptables -F命令不会恢复规则ACCEPT，因此只能想办法去物理机上，调整iptables规则。</span><br><span class="line">- 要么是云控制台</span><br><span class="line">- 要么是找机房人员恢复规则</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">赵东兴</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/08/20/%E9%98%B2%E7%81%AB%E5%A2%99iptables-%E5%91%BD%E4%BB%A4%E5%BA%94%E7%94%A8/">http://example.com/2024/08/20/%E9%98%B2%E7%81%AB%E5%A2%99iptables-%E5%91%BD%E4%BB%A4%E5%BA%94%E7%94%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/08/20/%E9%98%B2%E7%81%AB%E5%A2%99iptables-%E5%8E%9F%E7%90%86%E9%83%A8%E7%BD%B2/" title="防火墙iptables-原理部署"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">防火墙iptables-原理部署</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">赵东兴</div><div class="author-info__description">个人技术笔记博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#iptables%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97"><span class="toc-number">1.</span> <span class="toc-text">iptables使用指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%91%BD%E4%BB%A4%E8%AF%AD%E6%B3%95"><span class="toc-number">1.1.</span> <span class="toc-text">1.命令语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0%E5%A4%A7%E5%85%A8"><span class="toc-number">1.2.</span> <span class="toc-text">2.参数大全</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85%E6%89%A9%E5%B1%95%E5%8C%85"><span class="toc-number">1.3.</span> <span class="toc-text">3.安装扩展包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%8A%A0%E8%BD%BD%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.</span> <span class="toc-text">4.加载内核模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%90%AF%E5%8A%A8iptables"><span class="toc-number">1.5.</span> <span class="toc-text">5.启动iptables</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#iptables%E6%A0%B8%E5%BF%83%E5%91%BD%E4%BB%A4"><span class="toc-number">2.</span> <span class="toc-text">iptables核心命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9F%A5%E7%9C%8B%E8%A7%84%E5%88%99"><span class="toc-number">2.1.</span> <span class="toc-text">1.查看规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B8%85%E7%A9%BA%E8%A7%84%E5%88%99"><span class="toc-number">2.2.</span> <span class="toc-text">2.清空规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%B7%BB%E5%8A%A0%E8%A7%84%E5%88%99"><span class="toc-number">2.3.</span> <span class="toc-text">3.添加规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%88%A0%E9%99%A4%E8%A7%84%E5%88%99"><span class="toc-number">2.4.</span> <span class="toc-text">4.删除规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%9F%A5%E7%9C%8B%E8%A7%84%E5%88%99%E7%8A%B6%E6%80%81"><span class="toc-number">2.5.</span> <span class="toc-text">5.查看规则状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%A6%81%E6%AD%A2%E5%8A%A8%E4%BD%9C%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">2.6.</span> <span class="toc-text">6.禁止动作的区别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E9%99%90%E5%88%B6filter%E8%A1%A8%E5%AE%9E%E6%88%98"><span class="toc-number">3.</span> <span class="toc-text">规则限制filter表实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%A6%81%E6%AD%A222%E7%AB%AF%E5%8F%A3%E6%B5%81%E9%87%8F%E8%BF%9B%E5%85%A5%EF%BC%88%E5%8D%B1%E9%99%A9%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">1.禁止22端口流量进入（危险操作）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%A6%81%E6%AD%A2%E6%9F%90ip%E6%B5%81%E9%87%8F%E8%BF%9B%E5%85%A5%E6%9F%90%E7%BD%91%E5%8D%A1"><span class="toc-number">3.2.</span> <span class="toc-text">2.禁止某ip流量进入某网卡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%BA%90%E5%9C%B0%E5%9D%80%E5%8F%96%E5%8F%8D%E8%A7%84%E5%88%99%E5%AE%9A%E4%B9%89%E7%8E%A9%E6%B3%95"><span class="toc-number">3.3.</span> <span class="toc-text">3.源地址取反规则定义玩法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%8F%AA%E5%85%81%E8%AE%B8%E6%9F%90%E7%BD%91%E6%AE%B5%E6%B5%81%E9%87%8F%E8%BF%9B%E5%85%A5"><span class="toc-number">3.4.</span> <span class="toc-text">4.只允许某网段流量进入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AE%9E%E7%8E%B0%E5%A0%A1%E5%9E%92%E6%9C%BA%E7%9A%84%E5%94%AF%E4%B8%80%E5%85%A5%E5%8F%A3"><span class="toc-number">3.5.</span> <span class="toc-text">5.实现堡垒机的唯一入口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%9B%AE%E6%A0%87%E5%A4%9A%E4%B8%AA%E7%AB%AF%E5%8F%A3%E8%8C%83%E5%9B%B4%E5%AE%9A%E4%B9%89%E7%8E%A9%E6%B3%95"><span class="toc-number">3.6.</span> <span class="toc-text">6.目标多个端口范围定义玩法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%A6%81%E6%AD%A2%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A2%ABping%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%8E%A9%E6%B3%95"><span class="toc-number">3.7.</span> <span class="toc-text">7.禁止服务器被ping的两种玩法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%B0%81%E7%A6%81%E6%81%B6%E6%84%8F%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%9980%E5%8F%A3%E7%9A%84IP"><span class="toc-number">3.8.</span> <span class="toc-text">8.封禁恶意访问网站80口的IP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-web%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%81%E9%87%8F%E7%B1%BB%E7%95%A5"><span class="toc-number">3.9.</span> <span class="toc-text">9.web服务器流量类略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E8%A7%84%E5%88%99%E5%AE%9A%E4%B9%89%E7%BB%83%E4%B9%A0"><span class="toc-number">3.10.</span> <span class="toc-text">10.规则定义练习</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E9%99%90%E5%88%B6nat%E8%A1%A8%E5%AE%9E%E6%88%98"><span class="toc-number">4.</span> <span class="toc-text">规则限制nat表实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%B1%80%E5%9F%9F%E7%BD%91%E5%85%B1%E4%BA%AB%E4%B8%8A%E7%BD%91"><span class="toc-number">4.1.</span> <span class="toc-text">1.局域网共享上网</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E5%87%BA%E5%8F%A3%E8%8A%82%E7%82%B9"><span class="toc-number">4.1.1.</span> <span class="toc-text">网关出口节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E5%9F%9F%E7%BD%91%E4%B8%BB%E6%9C%BA%E8%8A%82%E7%82%B9"><span class="toc-number">4.1.2.</span> <span class="toc-text">局域网主机节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="toc-number">4.2.</span> <span class="toc-text">2.本地端口映射</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E8%A7%84%E5%88%99%E8%AE%B0%E5%BD%95%E7%8E%A9%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">保存规则记录玩法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99%E6%B7%BB%E5%8A%A0%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-number">6.</span> <span class="toc-text">防火墙规则添加注意点</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E9%98%B2%E7%81%AB%E5%A2%99iptables-%E5%91%BD%E4%BB%A4%E5%BA%94%E7%94%A8/" title="防火墙iptables-命令应用">防火墙iptables-命令应用</a><time datetime="2024-08-20T03:25:18.000Z" title="Created 2024-08-20 11:25:18">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E9%98%B2%E7%81%AB%E5%A2%99iptables-%E5%8E%9F%E7%90%86%E9%83%A8%E7%BD%B2/" title="防火墙iptables-原理部署">防火墙iptables-原理部署</a><time datetime="2024-08-20T03:24:37.000Z" title="Created 2024-08-20 11:24:37">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E8%99%9A%E6%8B%9F%E5%8C%96KVM-%E5%8A%9F%E8%83%BD%E5%91%BD%E4%BB%A4/" title="虚拟化KVM-功能命令">虚拟化KVM-功能命令</a><time datetime="2024-08-20T03:23:42.000Z" title="Created 2024-08-20 11:23:42">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E8%99%9A%E6%8B%9F%E5%8C%96KVM-%E5%8E%9F%E7%90%86%E9%83%A8%E7%BD%B2/" title="虚拟化KVM-原理部署">虚拟化KVM-原理部署</a><time datetime="2024-08-20T03:23:29.000Z" title="Created 2024-08-20 11:23:29">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/%E5%AE%B9%E5%99%A8Docker-%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92/" title="容器Docker-单机编排">容器Docker-单机编排</a><time datetime="2024-08-20T01:32:01.000Z" title="Created 2024-08-20 09:32:01">2024-08-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 赵东兴</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>